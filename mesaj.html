<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Kampanya Y√∂neticisi</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <script>
        // Tailwind CDN uyarƒ±sƒ±nƒ± bastƒ±r
        const originalWarn = console.warn;
        console.warn = function(...args) {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) {
                return;
            }
            originalWarn.apply(console, args);
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --sidebar-width: 250px; }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .main-content { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); }
        .sidebar { width: var(--sidebar-width); transition: transform 0.3s ease-in-out; }
        .sidebar-link { transition: all 0.2s ease; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #374151; color: white; }
        #logout-btn:hover { background-color: #c81e1e; }
        .status-badge { padding: 2px 10px; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; white-space: nowrap; text-transform: capitalize; }
        .status-Taslak { background-color: #6b7280; color: #ffffff; }
        .status-planlandƒ± { background-color: #eab308; color: #ffffff; }
        .status-g√∂nderiliyor { background-color: #f59e0b; color: #ffffff; animation: pulse 2s ease-in-out infinite; }
        .status-Tamamlandƒ± { background-color: #22c55e; color: #ffffff; }
        .status-tamamlandƒ± { background-color: #22c55e; color: #ffffff; }
        .status-durduruldu { background-color: #ef4444; color: #ffffff; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .device-status { padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; }
        .device-connected { background-color: #dcfce7; color: #166534; border: 1px solid #86efac;}
        .device-disconnected { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5;}
        .device-connecting { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047;}

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Dropdown Menu Styles */
        .dropdown-menu { position: relative; }
        .dropdown-toggle { cursor: pointer; transition: all 0.3s; }
        .dropdown-content { 
            max-height: 0; 
            overflow-y: auto; 
            transition: max-height 0.3s ease-out;
            margin-left: 1.5rem;
        }
        .dropdown-menu.open .dropdown-content { max-height: 350px; }
        .dropdown-toggle i.fa-chevron-down {
            transition: transform 0.3s;
        }
        .dropdown-menu.open .dropdown-toggle i.fa-chevron-down {
            transform: rotate(180deg);
        }

        .modal { display: none; }
        .modal.active { display: flex; }
        
        .progress-bar {
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
            width: 100%;
            height: 8px;
        }
        .progress-bar-inner {
            background-color: #3b82f6;
            height: 100%;
            transition: width 0.3s ease;
        }
        
        /* WhatsApp Tab Styles */
        .whatsapp-tab {
            color: #6b7280;
            transition: all 0.2s ease;
        }
        .whatsapp-tab:hover {
            background-color: #e5e7eb;
        }
        .whatsapp-tab.active {
            background-color: #3b82f6;
            color: white;
        }
        .whatsapp-tab-content {
            display: none;
        }
        .whatsapp-tab-content.active {
            display: block;
        }

        /* WhatsApp Style Chat */
        .chat-container { display: grid; grid-template-columns: 350px 1fr; height: calc(100vh - 120px); background: #f0f2f5; }
        .chat-sidebar { background: white; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; }
        .chat-sidebar-header { padding: 16px; background: #f0f2f5; border-bottom: 1px solid #e5e7eb; }
        .chat-search { width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; background: white; }
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { padding: 12px 16px; border-bottom: 1px solid #f0f2f5; cursor: pointer; transition: background 0.15s; display: flex; align-items: center; gap: 12px; }
        .chat-item:hover { background: #f5f6f6; }
        .chat-item.active { background: #e7f3ff; }
        .chat-avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #25D366, #128C7E); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; flex-shrink: 0; }
        .chat-item-content { flex: 1; min-width: 0; }
        .chat-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .chat-item-name { font-weight: 600; color: #111; font-size: 16px; }
        .chat-item-time { font-size: 12px; color: #667781; }
        .chat-item-last-message { color: #667781; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-item-unread { background: #25D366; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; }
        
        .chat-main { display: flex; flex-direction: column; background: #efeae2; position: relative; }
        .chat-main::before { content: ''; position: absolute; inset: 0; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><path d="M0 0h100v100H0z" fill="%23efeae2"/><circle cx="25" cy="25" r="2" fill="%23d9d4c8" opacity="0.4"/><circle cx="75" cy="75" r="2" fill="%23d9d4c8" opacity="0.4"/></svg>'); opacity: 0.4; }
        .chat-header { padding: 12px 16px; background: #f0f2f5; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; gap: 12px; z-index: 1; }
        .chat-header-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #25D366, #128C7E); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; }
        .chat-header-info { flex: 1; }
        .chat-header-name { font-weight: 600; color: #111; font-size: 16px; }
        .chat-header-status { font-size: 13px; color: #667781; }
        
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; z-index: 1; display: flex; flex-direction: column; gap: 8px; }
        .chat-message { display: flex; margin-bottom: 8px; animation: messageSlide 0.2s ease-out; }
        @keyframes messageSlide { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .chat-message.received { justify-content: flex-start; }
        .chat-message.sent { justify-content: flex-end; }
        .chat-bubble { max-width: 65%; padding: 8px 12px; border-radius: 8px; position: relative; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .chat-message.received .chat-bubble { background: white; border-bottom-left-radius: 2px; }
        .chat-message.sent .chat-bubble { background: #d9fdd3; border-bottom-right-radius: 2px; }
        .chat-bubble-text { color: #111; font-size: 14px; line-height: 1.5; word-wrap: break-word; }
        .chat-bubble-time { font-size: 11px; color: #667781; margin-top: 4px; text-align: right; display: flex; align-items: center; justify-content: flex-end; gap: 4px; }
        .chat-tick { color: #53bdeb; font-size: 16px; }
        .chat-tick.read { color: #53bdeb; }
        
        .chat-input-container { padding: 12px 16px; background: #f0f2f5; display: flex; gap: 8px; align-items: center; z-index: 1; }
        .chat-input { flex: 1; padding: 10px 16px; border-radius: 24px; border: none; background: white; font-size: 15px; outline: none; }
        .chat-send-btn { background: #25D366; color: white; border: none; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.15s; }
        .chat-send-btn:hover { background: #20bd5b; }
        .chat-send-btn:disabled { background: #d1d7db; cursor: not-allowed; }
        
        .chat-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #667781; }
        .chat-empty-icon { font-size: 80px; color: #d1d7db; margin-bottom: 16px; }
        .chat-empty-text { font-size: 18px; font-weight: 500; margin-bottom: 8px; }
        .chat-empty-subtext { font-size: 14px; color: #8696a0; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-10 rounded-lg shadow-2xl max-w-sm w-full">
            <!-- Login Form (Initially visible) -->
            <div id="login-form">
                <h2 class="text-2xl font-bold text-gray-800 mb-2 text-center">Giri≈ü Yap</h2>
                <p class="text-gray-600 mb-6 text-center">Hesabƒ±nƒ±za eri≈ümek i√ßin giri≈ü yapƒ±n.</p>
                <form autocomplete="off">
                    <input type="email" id="login-email" name="email" placeholder="E-posta Adresi" autocomplete="off" class="w-full mb-4 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="password" id="login-password" name="password" placeholder="≈ûifre" autocomplete="current-password" class="w-full mb-2 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </form>
                <div class="text-right mb-4">
                    <a href="#" id="show-forgot-password" class="text-sm text-blue-600 hover:underline">≈ûifremi Unuttum</a>
                </div>
                <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg w-full">
                    Giri≈ü Yap
                </button>
                <p class="mt-4 text-sm text-center">Hesabƒ±nƒ±z yok mu? <a href="#" id="show-signup" class="text-blue-600 hover:underline">Hesap Olu≈ütur</a></p>
            </div>

            <!-- Signup Form (Initially hidden) -->
            <div id="signup-form" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-2 text-center">Hesap Olu≈ütur</h2>
                <p class="text-gray-600 mb-4 text-center text-sm">Yeni bir hesap olu≈üturun.</p>
                <form autocomplete="off">
                    <input type="text" id="signup-name" name="name" placeholder="ƒ∞sim" autocomplete="off" class="w-full mb-3 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="text" id="signup-surname" name="surname" placeholder="Soyisim" autocomplete="off" class="w-full mb-3 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="tel" id="signup-phone" name="phone" placeholder="Telefon (05XXXXXXXXX)" autocomplete="off" class="w-full mb-3 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="text" id="signup-company" name="company" placeholder="≈ûirket Adƒ±" autocomplete="off" class="w-full mb-3 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="email" id="signup-email" name="email" placeholder="E-posta Adresi" autocomplete="off" class="w-full mb-3 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="password" id="signup-password" name="password" placeholder="≈ûifre (En az 6 karakter)" autocomplete="new-password" class="w-full mb-4 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                </form>
                <button id="signup-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg w-full">
                    Kayƒ±t Ol
                </button>
                <p class="mt-4 text-sm text-center">Zaten bir hesabƒ±nƒ±z var mƒ±? <a href="#" id="show-login" class="text-blue-600 hover:underline">Giri≈ü Yap</a></p>
            </div>

            <!-- Forgot Password Form (Initially hidden) -->
            <div id="forgot-password-form" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-2 text-center">≈ûifremi Unuttum</h2>
                <p class="text-gray-600 mb-6 text-center">E-posta adresinize ≈üifre sƒ±fƒ±rlama baƒülantƒ±sƒ± g√∂ndereceƒüiz.</p>
                <form autocomplete="off">
                    <input type="email" id="reset-email" name="email" placeholder="E-posta Adresi" autocomplete="off" class="w-full mb-4 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                </form>
                <button id="reset-password-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg w-full mb-3">
                    ≈ûifre Sƒ±fƒ±rlama Baƒülantƒ±sƒ± G√∂nder
                </button>
                <p class="text-sm text-center">
                    <a href="#" id="back-to-login" class="text-blue-600 hover:underline">‚Üê Giri≈ü Sayfasƒ±na D√∂n</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar fixed top-0 left-0 h-full bg-gray-800 text-gray-300 flex flex-col z-30 hidden">
        <div class="px-6 py-4 border-b border-gray-700">
            <h1 class="text-2xl font-bold text-white flex items-center">
                <i class="fab fa-whatsapp text-green-500 mr-3"></i> Wao<span class="text-green-400">TR</span>
            </h1>
        </div>
        <nav class="flex-1 mt-6 space-y-2 px-4 overflow-y-auto">
            <a href="#dashboard" class="sidebar-link active flex items-center py-2.5 px-4 rounded-lg">
                <i class="fas fa-tachometer-alt w-6 text-center"></i><span class="ml-3">Anasayfa</span>
            </a>
            
            <!-- Kampanyalar Dropdown -->
            <div class="dropdown-menu" id="campaigns-dropdown">
                <div class="dropdown-toggle sidebar-link flex items-center justify-between py-2.5 px-4 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-paper-plane w-6 text-center"></i><span class="ml-3">Kampanyalar</span>
                    </div>
                    <i class="fas fa-chevron-down text-xs"></i>
                </div>
                <div class="dropdown-content space-y-1 mt-1">
                    <a href="#" id="new-campaign-menu-btn" class="sidebar-link flex items-center py-2 px-4 rounded-lg text-sm">
                        <i class="fas fa-plus-circle w-5 text-center"></i><span class="ml-3">Kampanya Olu≈ütur</span>
                    </a>
                    <a href="#devam-eden" class="sidebar-link flex items-center py-2 px-4 rounded-lg text-sm">
                        <i class="fas fa-play-circle w-5 text-center"></i><span class="ml-3">Devam Eden Kampanyalar</span>
                    </a>
                    <a href="#planlanmis" class="sidebar-link flex items-center py-2 px-4 rounded-lg text-sm">
                        <i class="fas fa-clock w-5 text-center"></i><span class="ml-3">Planlanan Kampanyalar</span>
                    </a>
                    <a href="#tamamlanan" class="sidebar-link flex items-center py-2 px-4 rounded-lg text-sm">
                        <i class="fas fa-check-circle w-5 text-center"></i><span class="ml-3">Tamamlanan Kampanyalar</span>
                    </a>
                </div>
            </div>
            
            <a href="#mesajlasma" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg">
                <i class="fas fa-comments w-6 text-center"></i><span class="ml-3">Mesajla≈üma</span>
            </a>
            
            <!-- ≈ûablonlar Dropdown -->
            <div class="dropdown-menu">
                <div class="dropdown-toggle sidebar-link flex items-center justify-between py-2.5 px-4 rounded-lg">
                    <div class="flex items-center">
                <i class="fas fa-file-alt w-6 text-center"></i><span class="ml-3">≈ûablonlar</span>
                    </div>
                    <i class="fas fa-chevron-down text-xs"></i>
                </div>
                <div class="dropdown-content space-y-1 mt-1">
                    <a href="#sablonlar" class="sidebar-link flex items-center py-2 px-4 rounded-lg text-sm">
                        <i class="fas fa-file w-5 text-center"></i><span class="ml-3">Tekil ≈ûablonlar</span>
                    </a>
                    <a href="#sablon-gruplari" class="sidebar-link flex items-center py-2 px-4 rounded-lg text-sm">
                        <i class="fas fa-layer-group w-5 text-center"></i><span class="ml-3">≈ûablon Gruplarƒ±</span>
                    </a>
                </div>
            </div>
            
            <a href="#gruplar" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg">
                <i class="fas fa-users w-6 text-center"></i><span class="ml-3">Ki≈üi Gruplarƒ±</span>
            </a>
            <a href="#bakiye" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg">
                <i class="fas fa-envelope w-6 text-center"></i><span class="ml-3">Mesaj Hakkƒ±</span>
            </a>
            <a href="#ayarlar" class="sidebar-link flex items-center py-2.5 px-4 rounded-lg">
                <i class="fas fa-cogs w-6 text-center"></i><span class="ml-3">Ayarlar</span>
            </a>
        </nav>
        <div class="px-4 py-2 border-t border-gray-700">
            <div id="credits-display" class="mb-2 p-2 bg-gray-700 rounded-lg text-center">
                <p class="text-xs text-gray-400">Mesaj Hakkƒ±</p>
                <p class="text-lg font-bold text-green-400"><i class="fas fa-envelope"></i> <span id="user-credits">0</span></p>
            </div>
            <p id="user-company-display" class="text-sm text-white font-semibold truncate text-center mb-1" title="≈ûirket Adƒ±">y√ºkleniyor...</p>
            <p id="user-id-display" class="text-xs text-gray-500 font-mono truncate text-center" title="Kullanƒ±cƒ± ID">ID: y√ºkleniyor...</p>
            <button id="logout-btn" class="w-full mt-2 bg-red-600 text-white text-sm py-2 rounded-lg transition-colors duration-200 flex items-center justify-center">
                 <i class="fas fa-sign-out-alt mr-2"></i> √áƒ±kƒ±≈ü Yap
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main id="main-content" class="main-content p-6 sm:p-8 hidden">
        <div id="app-content">
            <!-- RENDERED CONTENT WILL BE HERE -->
        </div>
    </main>

    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-5 rounded-lg shadow-xl text-sm transition-transform transform translate-y-20 opacity-0 z-50">
        <span id="toast-message"></span>
    </div>

<script type="module">
    // --- SUNUCU YAPILANDIRMASI (BURAYI KENDƒ∞ Bƒ∞LGƒ∞LERƒ∞Nƒ∞ZLE D√úZENLEYƒ∞N) ---
    const EVOLUTION_API_URL = "https://evo-2.edu-ai.online";
    const EVOLUTION_API_KEY = "iHAF8gWNA1axdRDY9e98UKpork00dBO2";
    // --- ///////////////////////////////////////////////////////////////// ---

    // Firebase SDK'larƒ± (S√ºr√ºm 12.3.0)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, getDocs, onSnapshot, setDoc, collection, query, orderBy, addDoc, updateDoc, deleteDoc, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

    // --- State Management ---
    const state = {
        db: null, auth: null, storage: null, userId: null,
        userCompany: null, // User's company name
        userName: null, // User's first name
        userSurname: null, // User's last name
        userPhone: null, // User's phone
        appId: 'default-app-id', currentPage: 'dashboard',
        collections: { campaigns: [], templates: [], templateGroups: [], groups: [], settings: { devices: [] } },
        listeners: {}, isSending: false, sendingCampaignId: null,
        // Per-device g√∂nderim takibi: aynƒ± anda cihaz sayƒ±sƒ± kadar kampanya
        sendingByDevice: {},
        campaignCheckInterval: null, // Interval for checking campaigns
        qrPollInterval: null,
        countdownInterval: null,
        currentQrBlobUrl: null,
        messageCredits: 0,
        systemSettings: null // System settings including IBAN
    };

    // --- Toast Notification ---
    const showToast = (message, isError = false) => {
        const toast = document.getElementById('toast'), toastMessage = document.getElementById('toast-message');
        toastMessage.textContent = message;
        toast.className = `fixed bottom-5 right-5 text-white py-2 px-5 rounded-lg shadow-xl text-sm transition-transform transform translate-y-0 opacity-100 z-50 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
        setTimeout(() => toast.className = toast.className.replace('translate-y-0 opacity-100', 'translate-y-20 opacity-0'), 3000);
    };

    // --- Modal Manager ---
    const ModalManager = {
        show(config) {
            const container = document.getElementById('modal-container');
            container.innerHTML = `
                <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4">
                    <div id="modal-content" class="bg-white rounded-lg shadow-2xl w-full ${config.width || 'max-w-3xl'} transform transition-all scale-95 opacity-0">
                        <div class="flex justify-between items-center p-5 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-800">${config.title}</h3>
                            <button id="modal-close-btn" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                        </div>
                        <div class="p-6 max-h-[70vh] overflow-y-auto">${config.body}</div>
                        ${config.footer ? `<div class="flex justify-end items-center p-4 bg-gray-50 rounded-b-lg space-x-3">${config.footer}</div>` : ''}
                    </div>
                </div>`;
            document.getElementById('modal-close-btn').onclick = this.hide;
            document.getElementById('modal-backdrop').onclick = (e) => { if (e.target.id === 'modal-backdrop') this.hide(); };
            setTimeout(() => {
                const content = document.getElementById('modal-content');
                if (content) { content.classList.replace('scale-95', 'scale-100'); content.classList.replace('opacity-0', 'opacity-100'); }
            }, 10);
            if (config.onReady) config.onReady();
        },
        hide() {
            if (state.qrPollInterval) { clearInterval(state.qrPollInterval); state.qrPollInterval = null; }
            if(state.countdownInterval) { clearInterval(state.countdownInterval); state.countdownInterval = null; }
            if (state.currentQrBlobUrl) {
                URL.revokeObjectURL(state.currentQrBlobUrl);
                state.currentQrBlobUrl = null;
            }
            const backdrop = document.getElementById('modal-backdrop');
            if (backdrop) {
                const content = document.getElementById('modal-content');
                if (content) { content.classList.replace('scale-100', 'scale-95'); content.classList.replace('opacity-100', 'opacity-0'); }
                setTimeout(() => { if (backdrop.parentElement) backdrop.parentElement.innerHTML = '' }, 200);
            }
        },
        confirm(title, message, onConfirm) {
            this.show({
                title: title, body: `<p class="text-gray-600">${message}</p>`,
                footer: `<button id="confirm-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">ƒ∞ptal</button>
                         <button id="confirm-ok-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Sil</button>`,
                onReady: () => {
                    document.getElementById('confirm-cancel-btn').onclick = this.hide;
                    document.getElementById('confirm-ok-btn').onclick = () => { onConfirm(); this.hide(); };
                }
            });
        }
    };
    // --- Campaign Sending Logic (REAL) ---
    async function checkAndSendCampaigns() {
        // ‚ö†Ô∏è Dƒ∞KKAT: Cloud Functions aktif - Tarayƒ±cƒ±dan g√∂nderim devre dƒ±≈üƒ±
        // Mesajlar artƒ±k sadece Cloud Functions tarafƒ±ndan g√∂nderilecek
        console.log('‚òÅÔ∏è Cloud Functions aktif - Tarayƒ±cƒ±dan g√∂nderim yapƒ±lmƒ±yor');
        return;
        
        // ESKI KOD (Cloud Functions kullanƒ±ldƒ±ƒüƒ±nda √ßalƒ±≈ümaz)
        if (!state.userId) return;
        const now = new Date();
        
        // Hem "planlandƒ±" hem "g√∂nderiliyor" kampanyalarƒ± kontrol et (par√ßalƒ± g√∂nderim i√ßin)
        const campaignsToCheck = state.collections.campaigns.filter(c => 
            (c.status === 'planlandƒ±' || c.status === 'g√∂nderiliyor') && c.schedule && c.schedule.length > 0
        );
        
        if (campaignsToCheck.length > 0) {
            console.log(`üîÑ Kampanya kontrol√º: ${campaignsToCheck.length} aktif kampanya kontrol ediliyor...`);
        }

        for (const c of campaignsToCheck) {
            const deviceId = c.deviceId;
            if (!deviceId) continue;
            if (!state.sendingByDevice[deviceId]) state.sendingByDevice[deviceId] = { running: false, currentId: null };

            // Hangi par√ßanƒ±n sƒ±rasƒ± geldi kontrol et
            const currentScheduleIndex = c.currentScheduleIndex || 0;
            
            // T√ºm par√ßalar g√∂nderildiyse atla
            if (currentScheduleIndex >= c.schedule.length) {
                if (c.status !== 'Tamamlandƒ±' && c.status !== 'tamamlandƒ±') {
                    await Firestore.update('campaigns', c.id, { status: 'Tamamlandƒ±' }, true);
                    showToast(`'${c.name}' kampanyasƒ± Tamamlandƒ±.`);
                }
                continue;
            }
            
            const currentSchedule = c.schedule[currentScheduleIndex];
            const scheduleTime = currentSchedule.sendTime.toDate();
            
            // Zamanƒ± gelmi≈üse ve cihaz uygunsa ba≈ülat
            if (scheduleTime <= now && !state.sendingByDevice[deviceId].running) {
                console.log(`‚è∞ Kampanya par√ßasƒ± zamanƒ± geldi: ${c.name}, Par√ßa ${currentScheduleIndex + 1}/${c.schedule.length}`);
                
                // Eƒüer status hala "planlandƒ±" ise "g√∂nderiliyor" yap
                if (c.status === 'planlandƒ±') {
                    await Firestore.update('campaigns', c.id, { status: 'g√∂nderiliyor' }, true);
                    console.log(`üì§ [${c.name}] Durum 'planlandƒ±' -> 'g√∂nderiliyor' olarak g√ºncellendi`);
                }
                
                state.sendingByDevice[deviceId].running = true;
                state.sendingByDevice[deviceId].currentId = c.id;
                sendCampaignBatch(c, currentScheduleIndex).finally(() => {
                    state.sendingByDevice[deviceId].running = false;
                    state.sendingByDevice[deviceId].currentId = null;
                });
            }
        }
    }
    
    async function pauseCampaign(campaignId) {
        try {
            await Firestore.update('campaigns', campaignId, { status: 'durduruldu' });
            showToast("Kampanya Durduruldu.");
        } catch (error) {
            console.error("Pause campaign error:", error);
            showToast("Kampanya durdurulamadƒ±: " + error.message, true);
        }
    }

    // Yanlƒ±≈ü "Tamamlandƒ±" durumundaki kampanyalarƒ± d√ºzelt ve sentCount/errorCount'u ger√ßek deƒüerlere senkronize et
    async function fixIncorrectlyCompletedCampaigns() {
        try {
            const now = new Date();
            
            // T√ºm kampanyalarda sentCount ve errorCount'u ger√ßek dizilere g√∂re g√ºncelle
            for (const campaign of state.collections.campaigns) {
                if (!campaign) continue;
                
                const sentNumbers = campaign.sentNumbers || [];
                const errorNumbers = campaign.errorNumbers || [];
                const realSentCount = sentNumbers.length;
                const realErrorCount = errorNumbers.length;
                
                // Eƒüer sentCount veya errorCount yanlƒ±≈üsa veya yoksa, d√ºzelt
                if (campaign.sentCount !== realSentCount || campaign.errorCount !== realErrorCount) {
                    await Firestore.update('campaigns', campaign.id, {
                        sentCount: realSentCount,
                        errorCount: realErrorCount
                    }, true);
                    console.log(`üîÑ [${campaign.name}] ƒ∞statistikler senkronize edildi: ${realSentCount} ba≈üarƒ±lƒ±, ${realErrorCount} ba≈üarƒ±sƒ±z`);
                }
            }
            
            // Tamamlandƒ± durumundaki kampanyalarƒ± kontrol et
            const completedCampaigns = state.collections.campaigns.filter(c => 
                c && (c.status === 'Tamamlandƒ±' || c.status === 'tamamlandƒ±') && c.schedule && c.schedule.length > 0
            );
            
            for (const campaign of completedCampaigns) {
                const currentScheduleIndex = campaign.currentScheduleIndex || 0;
                
                // Eƒüer hen√ºz tamamlanmamƒ±≈ü par√ßalar varsa
                if (currentScheduleIndex < campaign.schedule.length) {
                    // Kampanya yanlƒ±≈ülƒ±kla tamamlandƒ± olarak i≈üaretlenmi≈ü
                    console.log(`üîß [${campaign.name}] Yanlƒ±≈ü 'Tamamlandƒ±' durumu d√ºzeltiliyor - ${campaign.schedule.length - currentScheduleIndex} par√ßa bekliyor`);
                    
                    // Ge√ßmi≈ü bir zamanda mƒ± yoksa gelecekte mi kontrol et
                    const nextSchedule = campaign.schedule[currentScheduleIndex];
                    const nextTime = nextSchedule.sendTime.toDate();
                    const newStatus = nextTime <= now ? 'g√∂nderiliyor' : 'planlandƒ±';
                    
                    await Firestore.update('campaigns', campaign.id, { status: newStatus }, true);
                    showToast(`'${campaign.name}' kampanyasƒ± d√ºzeltildi - ${campaign.schedule.length - currentScheduleIndex} par√ßa bekliyor.`);
                    
                    // Not: Cloud Functions otomatik olarak i≈üleyecek
                    console.log('‚òÅÔ∏è Kampanya durumu g√ºncellendi. Cloud Functions otomatik olarak i≈üleyecek.');
                }
            }
            
            // Planlandƒ± durumundaki kampanyalarƒ± kontrol et - zamanƒ± ge√ßmi≈üse "g√∂nderiliyor" yap
            const plannedCampaigns = state.collections.campaigns.filter(c => 
                c && c.status === 'planlandƒ±' && c.schedule && c.schedule.length > 0
            );
            
            if (plannedCampaigns.length > 0) {
                console.log(`üìÖ ${plannedCampaigns.length} planlanmƒ±≈ü kampanya kontrol ediliyor...`);
            }
            
            for (const campaign of plannedCampaigns) {
                try {
                    const currentScheduleIndex = campaign.currentScheduleIndex || 0;
                    
                    console.log(`üìã [${campaign.name} - ID: ${campaign.id}] Status: ${campaign.status}, currentScheduleIndex: ${currentScheduleIndex}, toplam par√ßa: ${campaign.schedule.length}`);
                    
                    // ≈ûu anki par√ßanƒ±n zamanƒ±nƒ± kontrol et
                    if (currentScheduleIndex < campaign.schedule.length) {
                        const currentSchedule = campaign.schedule[currentScheduleIndex];
                        
                        // sendTime kontrol√º - bazen undefined olabiliyor
                        if (!currentSchedule || !currentSchedule.sendTime || !currentSchedule.sendTime.toDate) {
                            console.warn(`‚ö†Ô∏è [${campaign.name}] Par√ßa ${currentScheduleIndex + 1} i√ßin ge√ßersiz sendTime`, currentSchedule);
                            continue;
                        }
                        
                        const scheduleTime = currentSchedule.sendTime.toDate();
                        const timeUntil = Math.round((scheduleTime - now) / 1000 / 60);
                        
                        console.log(`üïê [${campaign.name}] Par√ßa ${currentScheduleIndex + 1} zamanƒ±: ${scheduleTime.toLocaleString('tr-TR')}, ${timeUntil > 0 ? timeUntil + ' dakika sonra' : 'GE√áMƒ∞≈û (' + Math.abs(timeUntil) + ' dakika √∂nce)'}`);
                        
                        // Eƒüer zaman ge√ßmi≈üse, kampanyayƒ± "g√∂nderiliyor" yap
                        if (scheduleTime <= now) {
                            console.log(`‚è∞‚è∞‚è∞ [${campaign.name}] KAMPANYA G√ñNDERƒ∞Lƒ∞YOR DURUMUNA ALINACAK`);
                            
                            const updateResult = await Firestore.update('campaigns', campaign.id, { 
                                status: 'g√∂nderiliyor',
                                lastUpdated: new Date()
                            }, true);
                            
                            console.log(`‚úÖ [${campaign.name}] Durum g√ºncellendi:`, updateResult);
                            showToast(`'${campaign.name}' kampanyasƒ± g√∂nderime ba≈ülƒ±yor... Cloud Functions i≈üleyecek.`);
                            
                            // Not: Cloud Functions otomatik olarak i≈üleyecek
                            console.log('‚òÅÔ∏è Kampanya durumu g√ºncellendi. Cloud Functions otomatik olarak i≈üleyecek.');
                        }
                    } else {
                        console.log(`‚úÖ [${campaign.name}] T√ºm par√ßalar tamamlanmƒ±≈ü (${currentScheduleIndex}/${campaign.schedule.length})`);
                    }
                } catch (err) {
                    console.error(`‚ùå [${campaign.name}] Durum g√ºncelleme hatasƒ±:`, err);
                }
            }
        } catch (error) {
            console.error('‚ùå fixIncorrectlyCompletedCampaigns hatasƒ±:', error);
        }
    }

    async function resumeCampaign(campaignId) {
        try {
            const campaign = state.collections.campaigns.find(c => c.id === campaignId);
            if (campaign) {
                // Durumu 'g√∂nderiliyor' yap - Cloud Functions otomatik i≈üleyecek
                await Firestore.update('campaigns', campaignId, { status: 'g√∂nderiliyor' }, true);
                showToast("‚úÖ Kampanya devam ettirilecek. Cloud Functions 1 dakika i√ßinde i≈üleme alacak.");
                console.log('‚òÅÔ∏è Kampanya durumu g√ºncellendi. Cloud Functions otomatik olarak i≈üleyecek.');
            }
        } catch (error) {
            console.error("Resume campaign error:", error);
            showToast("Kampanya devam ettirilemedi: " + error.message, true);
        }
    }

    // Kampanyayƒ± hemen g√∂nder (zamanƒ± ge√ßmemi≈ü par√ßalar i√ßin)
    window.sendCampaignNow = async function(campaignId) {
        const campaign = state.collections.campaigns.find(c => c.id === campaignId);
        if (!campaign) {
            showToast("Kampanya bulunamadƒ±!", true);
            return;
        }

        const confirmed = await new Promise((resolve) => {
            ModalManager.show({
                title: '‚ö° Kampanyayƒ± Hemen G√∂nder',
                body: `
                    <div class="space-y-4">
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                            <p class="text-yellow-700">
                                <strong>‚ö†Ô∏è Dikkat:</strong> Bu kampanyayƒ± hemen g√∂nderime ba≈ülatmak istediƒüinizden emin misiniz?
                            </p>
                            <p class="text-yellow-600 text-sm mt-2">
                                Kampanya: <strong>${campaign.name}</strong>
                            </p>
                        </div>
                        <p class="text-gray-700">
                            ≈ûu anki bekleyen par√ßa hemen g√∂nderilecek ve kampanya durumu "G√∂nderiliyor" olarak g√ºncellenecek.
                        </p>
                    </div>
                `,
                footer: `
                    <button id="cancel-send-now" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">ƒ∞ptal</button>
                    <button id="confirm-send-now" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">‚úÖ Evet, Hemen G√∂nder</button>
                `,
                onReady: () => {
                    document.getElementById('cancel-send-now').onclick = () => {
                        ModalManager.hide();
                        resolve(false);
                    };
                    document.getElementById('confirm-send-now').onclick = () => {
                        ModalManager.hide();
                        resolve(true);
                    };
                }
            });
        });

        if (!confirmed) return;

        try {
            // Kampanyayƒ± "g√∂nderiliyor" durumuna al
            await Firestore.update('campaigns', campaignId, { 
                status: 'g√∂nderiliyor',
                lastUpdated: new Date()
            }, true);
            
            showToast(`‚úÖ '${campaign.name}' kampanyasƒ± g√∂nderime ba≈ülatƒ±ldƒ±! Cloud Functions 1 dakika i√ßinde i≈üleme alacak.`);
            
            // Not: checkAndSendCampaigns artƒ±k devre dƒ±≈üƒ± - Cloud Functions g√∂nderiyor
            console.log('‚òÅÔ∏è Kampanya durumu g√ºncellendi. Cloud Functions otomatik olarak i≈üleyecek.');
            
        } catch (error) {
            console.error("Kampanya ba≈ülatma hatasƒ±:", error);
            showToast("Kampanya ba≈ülatƒ±lamadƒ±: " + error.message, true);
        }
    };

    // Par√ßa g√∂nderim zamanƒ±nƒ± d√ºzenle
    window.editSchedulePiece = async function(campaignId, pieceIndex) {
        const campaign = state.collections.campaigns.find(c => c.id === campaignId);
        if (!campaign || !campaign.schedule || !campaign.schedule[pieceIndex]) {
            showToast("Par√ßa bulunamadƒ±!", true);
            return;
        }

        const piece = campaign.schedule[pieceIndex];
        const currentDate = piece.sendTime.toDate();
        
        // Tarih ve saati input formatƒ±na √ßevir (YYYY-MM-DDTHH:MM)
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        const day = String(currentDate.getDate()).padStart(2, '0');
        const hours = String(currentDate.getHours()).padStart(2, '0');
        const minutes = String(currentDate.getMinutes()).padStart(2, '0');
        const dateTimeValue = `${year}-${month}-${day}T${hours}:${minutes}`;

        ModalManager.show({
            title: `‚úèÔ∏è Par√ßa ${pieceIndex + 1} - G√∂nderim Zamanƒ±nƒ± D√ºzenle`,
            body: `
                <div class="space-y-4">
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                        <p class="text-blue-700 text-sm">
                            <strong>üì¶ Par√ßa ${pieceIndex + 1}</strong> - ${piece.count} ki≈üiye g√∂nderilecek
                        </p>
                        <p class="text-blue-600 text-xs mt-1">
                            Mevcut Zaman: ${currentDate.toLocaleString('tr-TR')}
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üìÖ Yeni G√∂nderim Tarihi ve Saati
                        </label>
                        <input 
                            type="datetime-local" 
                            id="edit-piece-datetime" 
                            value="${dateTimeValue}"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        />
                        <p class="text-xs text-gray-500 mt-1">
                            ‚ö†Ô∏è Ge√ßmi≈ü bir zaman se√ßerseniz, kampanya hemen g√∂nderilecektir.
                        </p>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded p-3 text-sm text-yellow-700">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>√ñnemli:</strong> Par√ßa zamanƒ±nƒ± deƒüi≈ütirdiƒüinizde, kampanya durumu otomatik olarak g√ºncellenecektir.
                    </div>
                </div>
            `,
            footer: `
                <button id="cancel-edit-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg transition-colors">
                    ƒ∞ptal
                </button>
                <button id="save-edit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                    üíæ Kaydet
                </button>
            `,
            onReady: () => {
                document.getElementById('cancel-edit-btn').onclick = () => {
                    ModalManager.hide();
                };

                document.getElementById('save-edit-btn').onclick = async () => {
                    const newDateTimeStr = document.getElementById('edit-piece-datetime').value;
                    if (!newDateTimeStr) {
                        showToast("L√ºtfen bir tarih se√ßin!", true);
                        return;
                    }

                    const newDate = new Date(newDateTimeStr);
                    if (isNaN(newDate.getTime())) {
                        showToast("Ge√ßersiz tarih formatƒ±!", true);
                        return;
                    }

                    // Minimum 1 dakika sonrasƒ± kontrol√º (opsiyonel)
                    const now = new Date();
                    if (newDate < now) {
                        const confirm = await new Promise((resolve) => {
                            ModalManager.show({
                                title: '‚ö†Ô∏è Ge√ßmi≈ü Tarih Uyarƒ±sƒ±',
                                body: `
                                    <p class="text-gray-700">Se√ßtiƒüiniz zaman ge√ßmi≈üte. Bu par√ßa <strong>hemen g√∂nderilecektir</strong>.</p>
                                    <p class="text-blue-600 mt-2">Devam etmek istiyor musunuz?</p>
                                `,
                                footer: `
                                    <button id="confirm-no" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Hayƒ±r</button>
                                    <button id="confirm-yes" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Evet, Devam Et</button>
                                `,
                                onReady: () => {
                                    document.getElementById('confirm-no').onclick = () => {
                                        ModalManager.hide();
                                        resolve(false);
                                        // D√ºzenleme modalƒ±na geri d√∂n
                                        setTimeout(() => editSchedulePiece(campaignId, pieceIndex), 100);
                                    };
                                    document.getElementById('confirm-yes').onclick = () => {
                                        ModalManager.hide();
                                        resolve(true);
                                    };
                                }
                            });
                        });

                        if (!confirm) return;
                    }

                    try {
                        // Disable button
                        const saveBtn = document.getElementById('save-edit-btn');
                        saveBtn.disabled = true;
                        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';

                        // Schedule array'ini g√ºncelle
                        const updatedSchedule = [...campaign.schedule];
                        updatedSchedule[pieceIndex] = {
                            ...piece,
                            sendTime: Timestamp.fromDate(newDate)
                        };

                        // Kampanya durumunu g√ºncelle
                        const currentScheduleIndex = campaign.currentScheduleIndex || 0;
                        let newStatus = campaign.status;
                        
                        // Eƒüer bu par√ßa ≈üu anki par√ßa ise ve zamanƒ± gelmi≈üse
                        if (pieceIndex === currentScheduleIndex) {
                            if (newDate <= now) {
                                newStatus = 'g√∂nderiliyor';
                            } else {
                                newStatus = 'planlandƒ±';
                            }
                        }

                        await Firestore.update('campaigns', campaignId, {
                            schedule: updatedSchedule,
                            status: newStatus
                        }, true);

                        showToast(`‚úÖ Par√ßa ${pieceIndex + 1} zamanƒ± g√ºncellendi!`);
                        ModalManager.hide();

                        // Not: Cloud Functions otomatik olarak i≈üleyecek
                        if (newDate <= now && pieceIndex === currentScheduleIndex) {
                            console.log('‚òÅÔ∏è Par√ßa zamanƒ± g√ºncellendi. Cloud Functions otomatik olarak i≈üleyecek.');
                        }

                        // Detaylarƒ± yeniden g√∂ster
                        setTimeout(() => {
                            const updatedCampaign = state.collections.campaigns.find(c => c.id === campaignId);
                            if (updatedCampaign) {
                                showCampaignDetailsModal(updatedCampaign);
                            }
                        }, 500);

                    } catch (error) {
                        console.error("Par√ßa g√ºncelleme hatasƒ±:", error);
                        showToast("Par√ßa g√ºncellenemedi: " + error.message, true);
                    }
                };
            }
        });
    };
    function parseWhatsAppError(errorMsg, errorData) {
        const lowerMsg = (errorMsg || '').toLowerCase();
        const fullError = JSON.stringify(errorData).toLowerCase();
        
        // Check for specific error patterns
        
        // WhatsApp not registered / not using WhatsApp
        if (lowerMsg.includes('not registered') || lowerMsg.includes('not found on whatsapp') || 
            fullError.includes('not registered') || lowerMsg.includes('number not registered') ||
            lowerMsg.includes('is not on whatsapp')) {
            return '‚ùå Bu numaralar WhatsApp kullanmƒ±yor';
        }
        
        // Blocked by user
        if (lowerMsg.includes('blocked') || lowerMsg.includes('engellendi') || 
            fullError.includes('blocked') || lowerMsg.includes('you are blocked')) {
            return 'üö´ Kullanƒ±cƒ± sizi engellemi≈ü';
        }
        
        // Invalid number format
        if (lowerMsg.includes('invalid number') || lowerMsg.includes('ge√ßersiz numara') || 
            lowerMsg.includes('invalid phone') || lowerMsg.includes('malformed')) {
            return 'üìû Ge√ßersiz numara formatƒ±';
        }
        
        // WhatsApp connection issues - logged out
        if (lowerMsg.includes('logged out') || lowerMsg.includes('logout') || 
            lowerMsg.includes('√ßƒ±kƒ±≈ü yapƒ±ldƒ±') || lowerMsg.includes('not logged in')) {
            return 'üì± WhatsApp oturumu kapalƒ± (L√ºtfen QR ile giri≈ü yapƒ±n)';
        }
        
        // WhatsApp connection issues - disconnected
        if (lowerMsg.includes('not connected') || lowerMsg.includes('disconnected') || 
            lowerMsg.includes('session') || lowerMsg.includes('connection lost')) {
            return 'üì± WhatsApp baƒülantƒ±sƒ± kopuk (Cihaz √ßevrimdƒ±≈üƒ±)';
        }
        
        // Rate limiting
        if (lowerMsg.includes('rate limit') || lowerMsg.includes('too many requests') || 
            lowerMsg.includes('limit exceeded')) {
            return '‚è±Ô∏è √áok hƒ±zlƒ± g√∂nderim - WhatsApp limiti';
        }
        
        // Media/Image errors
        if (lowerMsg.includes('media') || lowerMsg.includes('image') || 
            lowerMsg.includes('file') || lowerMsg.includes('g√∂rsel')) {
            return 'üñºÔ∏è G√∂rsel/Medya g√∂nderilemedi';
        }
        
        // Authentication errors
        if (lowerMsg.includes('unauthorized') || lowerMsg.includes('401') || 
            lowerMsg.includes('authentication failed')) {
            return 'üîë API yetkisi ge√ßersiz (API Key kontrol edin)';
        }
        
        // Timeout errors
        if (lowerMsg.includes('timeout') || lowerMsg.includes('timed out') || 
            lowerMsg.includes('zaman a≈üƒ±mƒ±')) {
            return '‚è∞ Zaman a≈üƒ±mƒ± (Aƒü yava≈ü veya cihaz yanƒ±t vermiyor)';
        }
        
        // Network/Connection errors
        if (lowerMsg.includes('network') || lowerMsg.includes('failed to fetch') || 
            lowerMsg.includes('connection refused') || lowerMsg.includes('aƒü hatasƒ±')) {
            return 'üåê Baƒülantƒ± hatasƒ± (ƒ∞nternet veya sunucu sorunu)';
        }
        
        // Bad Request
        if (lowerMsg.includes('bad request') || lowerMsg.includes('400')) {
            return '‚ö†Ô∏è Mesaj formatƒ± veya kullanƒ±cƒ±lar WhatsApp kullanmƒ±yor';
        }
        
        // Server errors
        if (lowerMsg.includes('internal server error') || lowerMsg.includes('500') || 
            lowerMsg.includes('503') || lowerMsg.includes('server error')) {
            return 'üîß Sunucu hatasƒ± (WhatsApp API ge√ßici sorun ya≈üƒ±yor)';
        }
        
        // Message too long
        if (lowerMsg.includes('too long') || lowerMsg.includes('message length')) {
            return 'üìù Mesaj √ßok uzun';
        }
        
        // Spam detected
        if (lowerMsg.includes('spam') || lowerMsg.includes('suspicious')) {
            return 'üö® Spam olarak algƒ±landƒ±';
        }
        
        // If no specific pattern matched, return cleaned error
        if (errorMsg && errorMsg.length > 0) {
            // Truncate very long errors
            return errorMsg.length > 100 ? errorMsg.substring(0, 100) + '...' : errorMsg;
        }
        
        return '‚ùå Bilinmeyen hata';
    }
    
    // Par√ßalƒ± g√∂nderim i√ßin - sadece belirli bir par√ßayƒ± g√∂nderir
    async function sendCampaignBatch(campaign, scheduleIndex) {
        // ‚ö†Ô∏è Dƒ∞KKAT: Cloud Functions aktif - Tarayƒ±cƒ±dan g√∂nderim devre dƒ±≈üƒ±
        // Mesajlar artƒ±k sadece Cloud Functions tarafƒ±ndan g√∂nderilecek
        console.log('‚òÅÔ∏è Cloud Functions aktif - Tarayƒ±cƒ±dan mesaj g√∂nderimi yapƒ±lmƒ±yor');
        showToast('‚òÅÔ∏è Kampanyalar Cloud Functions tarafƒ±ndan otomatik g√∂nderilecek', false);
        return;
        
        // ESKI KOD (Cloud Functions kullanƒ±ldƒ±ƒüƒ±nda √ßalƒ±≈ümaz)
        if (!campaign) return;
        
        if (!isApiConfigured()) {
            showToast("L√ºtfen √∂nce API ayarlarƒ±nƒ±zƒ± yapƒ±n.", true);
            await Firestore.update('campaigns', campaign.id, { status: 'durduruldu' }, true);
            return;
        }

        state.isSending = true;
        state.sendingCampaignId = campaign.id;
        
        const scheduleItem = campaign.schedule[scheduleIndex];
        if (!scheduleItem) {
            console.error('Schedule item not found:', scheduleIndex);
            return;
        }
        
        console.log(`üì§ [${campaign.name}] Par√ßa ${scheduleIndex + 1}/${campaign.schedule.length} ba≈ülatƒ±lƒ±yor - Sayfa kapatƒ±lsa bile devam edecek`);
        showToast(`'${campaign.name}' kampanyasƒ± - Par√ßa ${scheduleIndex + 1}/${campaign.schedule.length} g√∂nderiliyor...`);
        
        try {
            await Firestore.update('campaigns', campaign.id, { status: 'g√∂nderiliyor' }, true);

            const group = state.collections.groups.find(g => g.id === campaign.groupId);
            const device = (state.collections.settings.devices || []).find(d => d.id === campaign.deviceId);
            const delays = state.collections.settings.delays || { min: 10, max: 30, longMin: 60, longMax: 120, trigger: 25 };

            if (!group) throw new Error("Hedef grup bulunamadƒ±.");
            if (!device) throw new Error("G√∂nderici cihaz bulunamadƒ±.");
            if (!device.instanceName) throw new Error("Cihaz instance adƒ± bulunamadƒ±. L√ºtfen cihazƒ± yeniden olu≈üturun.");
            if (!device.apiKey) throw new Error("Cihaz API anahtarƒ± bulunamadƒ±. L√ºtfen cihazƒ± yeniden baƒülayƒ±n.");
            
            // Cihaza √∂zel API URL varsa onu kullan, yoksa genel URL'i kullan
            const apiUrl = device.apiUrl || EVOLUTION_API_URL;
            
            const groupNumbers = getGroupNumbers(group);
            // sentNumbers ve errorNumbers artƒ±k ger√ßek kaynak - count deƒüi≈ükenleri artƒ±k kullanƒ±lmƒ±yor
            let sentNumbers = campaign.sentNumbers || [];
            let errorNumbers = campaign.errorNumbers || [];
            let errorReasons = campaign.errorReasons || {};
            let sentTimestamps = campaign.sentTimestamps || {};
            let skippedNumbers = campaign.skippedNumbers || [];
            let skippedReasons = campaign.skippedReasons || {};
            
            // Bu par√ßa i√ßin g√∂nderilecek numaralarƒ± hesapla
            const allNumbers = groupNumbers.filter(num => !sentNumbers.includes(num) && !errorNumbers.includes(num) && !skippedNumbers.includes(num));
            
            // √ñnceki par√ßalarda ka√ß numara g√∂nderildi hesapla
            let startIndex = 0;
            for (let i = 0; i < scheduleIndex; i++) {
                startIndex += campaign.schedule[i].count;
            }
            
            // Duplicate'larƒ± temizle (aynƒ± numaranƒ±n birden fazla kez g√∂nderilmesini engelle)
            const numbersForThisBatch = [...new Set(allNumbers.slice(startIndex, startIndex + scheduleItem.count))];
            console.log(`üì¶ Par√ßa ${scheduleIndex + 1}: ${numbersForThisBatch.length} numara g√∂nderilecek`);
            
            for (const number of numbersForThisBatch) {
                // Check if campaign still exists and not paused
                const campaignStillExists = state.collections.campaigns.find(c => c.id === campaign.id);
                if (!campaignStillExists || campaignStillExists.status === 'durduruldu') {
                    console.log('Kampanya durduruldu veya silindi, par√ßa g√∂nderimi durduruluyor.');
                    state.isSending = false;
                    state.sendingCampaignId = null;
                    return;
                }
                
                // Format phone number
                let formattedNumber = number.replace(/\D/g, '');
                if (formattedNumber.startsWith('0')) {
                    formattedNumber = formattedNumber.substring(1);
                }
                if (!formattedNumber.startsWith('90')) {
                    formattedNumber = '90' + formattedNumber;
                }
                const whatsappNumber = `${formattedNumber}@s.whatsapp.net`;
                
                // 24 saat kuralƒ± kontrol√º
                const enable24HourRule = state.collections.settings.enable24HourRule || false;
                if (enable24HourRule) {
                    try {
                        const messageHistoryRef = doc(state.db, "users", state.userId, "message_history", formattedNumber);
                        const historyDoc = await getDoc(messageHistoryRef);
                        
                        if (historyDoc.exists()) {
                            const lastSentAt = historyDoc.data().lastSentAt?.toDate();
                            if (lastSentAt) {
                                const hoursSinceLastMessage = (new Date() - lastSentAt) / (1000 * 60 * 60);
                                
                                if (hoursSinceLastMessage < 24) {
                                    const remainingHours = (24 - hoursSinceLastMessage).toFixed(1);
                                    console.log(`‚è∞ 24 saat kuralƒ±: ${number} atlandƒ± (${remainingHours} saat kaldƒ±)`);
                                    skippedNumbers.push(number);
                                    skippedReasons[number] = `‚è∞ 24 saat kuralƒ± (${remainingHours} saat sonra g√∂nderilebilir)`;
                                    
                                    await Firestore.update('campaigns', campaign.id, { 
                                        skippedNumbers: skippedNumbers,
                                        skippedReasons: skippedReasons
                                    }, true);
                                    continue;
                                }
                            }
                        }
                    } catch (error) {
                        console.error('24 saat kuralƒ± kontrol hatasƒ±:', error);
                    }
                }
                
                // Double-check: Skip if already sent (prevents duplicates)
                if (sentNumbers.includes(number)) {
                    console.log(`‚è≠Ô∏è Atlanƒ±yor (zaten g√∂nderildi): ${number}`);
                    continue;
                }
                
                const isLongDelay = (sentNumbers.length + 1) % delays.trigger === 0;
                const delay = isLongDelay ? (Math.random() * (delays.longMax - delays.longMin) + delays.longMin) * 1000 : (Math.random() * (delays.max - delays.min) + delays.min) * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
                
                try {
                    // Select message and image
                    let messageToSend = campaign.message;
                    let imageUrlToSend = campaign.imageUrl;
                    
                    if (campaign.templateType === 'group' && campaign.templateGroupId) {
                        const templateGroup = state.collections.templateGroups.find(tg => tg.id === campaign.templateGroupId);
                        if (templateGroup && templateGroup.templates && templateGroup.templates.length > 0) {
                            const randomIndex = Math.floor(Math.random() * templateGroup.templates.length);
                            const selectedTemplate = templateGroup.templates[randomIndex];
                            messageToSend = selectedTemplate.content;
                            imageUrlToSend = selectedTemplate.imageUrl || imageUrlToSend;
                            console.log(`üé≤ ≈ûablon grubu: "${templateGroup.name}" - ${randomIndex + 1}/${templateGroup.templates.length} se√ßildi`);
                        }
                    }
                    
                    // Replace variables
                    if (group.contacts && Array.isArray(group.contacts)) {
                        const contact = group.contacts.find(c => c.phone === number);
                        if (contact) {
                            messageToSend = messageToSend.replace(/\{Ad\}/gi, contact.name || '');
                            messageToSend = messageToSend.replace(/\{Soyad\}/gi, contact.surname || '');
                            messageToSend = messageToSend.replace(/\{AdSoyad\}/gi, `${contact.name || ''} ${contact.surname || ''}`.trim());
                        }
                    }
                    
                    let url, payload;
                    if (imageUrlToSend) {
                        url = `${apiUrl}/message/sendMedia/${device.instanceName}`;
                        let mediaData = imageUrlToSend;
                        if (mediaData.startsWith('data:image')) {
                            const base64Match = mediaData.match(/^data:image\/[a-z]+;base64,(.+)$/);
                            if (base64Match) {
                                mediaData = base64Match[1];
                            }
                        }
                        payload = {
                            number: whatsappNumber,
                            mediatype: 'image',
                            mimetype: 'image/png',
                            media: mediaData,
                            fileName: 'image.png',
                            caption: messageToSend
                        };
                    } else {
                        url = `${apiUrl}/message/sendText/${device.instanceName}`;
                        payload = {
                            number: whatsappNumber,
                            text: messageToSend
                        };
                    }
                    
                    console.log('üì§ Mesaj g√∂nderiliyor:', { url, deviceInstance: device.instanceName, to: whatsappNumber });
                    
                    const response = await fetch(url, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json', 'apikey': device.apiKey }, 
                        body: JSON.stringify(payload) 
                    });
                    
                    console.log('üì• API Yanƒ±t:', { status: response.status, statusText: response.statusText });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMsg = errorData.message || errorData.error || `HTTP ${response.status}`;
                        const userFriendlyError = parseWhatsAppError(errorMsg, errorData);
                        throw new Error(userFriendlyError);
                    }
                    
                    // Ba≈üarƒ±lƒ± g√∂nderim - diziye ekle
                    sentNumbers.push(number);
                    sentTimestamps[number] = new Date().toISOString();
                    console.log(`‚úÖ Mesaj g√∂nderildi: ${number} (${sentNumbers.length}/${groupNumbers.length})`);
                    
                    // 24 saat kuralƒ± i√ßin kayƒ±t
                    if (enable24HourRule) {
                        try {
                            const messageHistoryRef = doc(state.db, "users", state.userId, "message_history", formattedNumber);
                            await setDoc(messageHistoryRef, {
                                lastSentAt: serverTimestamp(),
                                phoneNumber: number,
                                campaignId: campaign.id,
                                campaignName: campaign.name
                            });
                        } catch (error) {
                            console.error('Mesaj ge√ßmi≈üi kayƒ±t hatasƒ±:', error);
                        }
                    }
                    
                    // Deduct credit
                    try {
                        const userDocRef = doc(state.db, "users", state.userId);
                        const userDoc = await getDoc(userDocRef);
                        if (userDoc.exists()) {
                            const currentCredits = userDoc.data().credits || 0;
                            await setDoc(userDocRef, {
                                credits: currentCredits - 1
                            }, { merge: true });
                            state.messageCredits = currentCredits - 1;
                            
                            await addDoc(collection(state.db, "credit_transactions"), {
                                userId: state.userId,
                                type: 'message_sent',
                                credits: -1,
                                note: `${campaign.name} kampanyasƒ± - ${number}`,
                                campaignId: campaign.id,
                                createdAt: serverTimestamp()
                            });
                        }
                    } catch (creditError) {
                        console.error("Credit deduction error:", creditError);
                    }
                } catch (e) {
                    // Ba≈üarƒ±sƒ±z g√∂nderim - diziye ekle
                    errorNumbers.push(number);
                    errorReasons[number] = e.message || 'Bilinmeyen hata';
                    console.error(`‚ùå Ba≈üarƒ±sƒ±z ${number}: ${e.message}`);
                }
                
                // Kampanyayƒ± g√ºncelle - hem diziler hem de count alanlarƒ±
                await Firestore.update('campaigns', campaign.id, { 
                    sentNumbers: sentNumbers,
                    errorNumbers: errorNumbers,
                    sentCount: sentNumbers.length,
                    errorCount: errorNumbers.length,
                    errorReasons: errorReasons,
                    sentTimestamps: sentTimestamps,
                    skippedNumbers: skippedNumbers,
                    skippedReasons: skippedReasons,
                    lastUpdated: new Date()
                }, true);
            }
            
            // Bu par√ßa bitti, index'i artƒ±r
            const nextScheduleIndex = scheduleIndex + 1;
            if (nextScheduleIndex >= campaign.schedule.length) {
                // Son par√ßa bitti, kampanya tamamlandƒ±
                console.log(`‚úÖ [${campaign.name}] T√úM PAR√áALAR TAMAMLANDI - Kampanya ba≈üarƒ±yla bitti`);
                await Firestore.update('campaigns', campaign.id, { 
                    status: 'Tamamlandƒ±',
                    currentScheduleIndex: nextScheduleIndex
                }, true);
                showToast(`'${campaign.name}' kampanyasƒ± Tamamlandƒ±.`);
            } else {
                // Daha par√ßalar var, index'i g√ºncelle
                const nextScheduleTime = campaign.schedule[nextScheduleIndex].sendTime.toDate();
                const timeUntilNext = Math.round((nextScheduleTime - new Date()) / (1000 * 60));
                console.log(`‚úÖ [${campaign.name}] Par√ßa ${scheduleIndex + 1}/${campaign.schedule.length} tamamlandƒ± - Sonraki par√ßa ${timeUntilNext} dakika sonra`);
                
                await Firestore.update('campaigns', campaign.id, { 
                    currentScheduleIndex: nextScheduleIndex
                }, true);
                showToast(`'${campaign.name}' - Par√ßa ${scheduleIndex + 1} tamamlandƒ±. Sonraki par√ßa: ${nextScheduleTime.toLocaleString('tr-TR')}`);
            }
        } catch (error) {
            console.error("Kampanya par√ßa g√∂nderim hatasƒ±:", error);
            showToast(`Kampanya hatasƒ±: ${error.message}`, true);
            await Firestore.update('campaigns', campaign.id, { status: 'durduruldu' }, true);
        } finally {
            state.isSending = false;
            state.sendingCampaignId = null;
        }
    }
    
    async function sendCampaign(campaign) {
        // Geriye d√∂n√ºk uyumluluk i√ßin - artƒ±k sendCampaignBatch kullanƒ±yoruz
        if (!campaign) return;
        const currentScheduleIndex = campaign.currentScheduleIndex || 0;
        await sendCampaignBatch(campaign, currentScheduleIndex);
    }
    
    // --- Firebase & Data ---
    async function initializeFirebase() {
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyB-qEdprf_5D_1abm3ASMi6ASgyRStrrhc",
                authDomain: "whatsapp-toplu-mesaj-16b42.firebaseapp.com",
                projectId: "whatsapp-toplu-mesaj-16b42",
                storageBucket: "whatsapp-toplu-mesaj-16b42.appspot.com",
                messagingSenderId: "144818282989",
                appId: "1:144818282989:web:5d6cc67376e9ad66af07e4",
                measurementId: "G-EP5CFW3R2L"
            };
            
            const app = initializeApp(firebaseConfig);
            state.db = getFirestore(app);
            state.auth = getAuth(app);
            state.storage = getStorage(app);

            onAuthStateChanged(state.auth, user => {
                if (user) {
                    // User is signed in.
                    
                    if (!state.userId) {
                        state.userId = user.uid;
                        document.getElementById('user-id-display').textContent = `ID: ${user.uid}`;
                        document.getElementById('user-id-display').title = `Kullanƒ±cƒ± ID: ${user.uid}`;
                        
                        // Fetch user company name and check if user exists
                        const userDocRef = doc(state.db, "users", user.uid);
                        getDoc(userDocRef).then(docSnap => {
                            if (docSnap.exists()) {
                                const userData = docSnap.data();
                                state.userCompany = userData.company || '≈ûirket Adƒ± Yok';
                                state.userName = userData.name || '';
                                state.userSurname = userData.surname || '';
                                state.userPhone = userData.phone || '';
                                document.getElementById('user-company-display').textContent = state.userCompany;
                                document.getElementById('user-company-display').title = `≈ûirket: ${state.userCompany}`;
                            } else {
                                // User document doesn't exist (deleted by superadmin)
                                signOut(state.auth);
                                showToast("‚ùå Hesabƒ±nƒ±z silinmi≈ü. L√ºtfen destek ile ileti≈üime ge√ßin.", true);
                                return;
                            }
                        }).catch(error => {
                            console.error("User company fetch error:", error);
                            document.getElementById('user-company-display').textContent = '≈ûirket Adƒ± Yok';
                        });
                        
                        // SuperAdmin link will NOT be shown for normal users
                        // Only accessible via separate login
                        
                        document.getElementById('login-overlay').classList.add('hidden');
                        document.getElementById('sidebar').classList.remove('hidden');
                        document.getElementById('main-content').classList.remove('hidden');
                        
                        setupRealtimeListeners();
                        
                        // Cloud Functions otomatik olarak kampanyalarƒ± kontrol ediyor
                        console.log('‚òÅÔ∏è Kampanya otomasyonu Cloud Functions ile √ßalƒ±≈üƒ±yor - Sayfa kapatƒ±lsa bile devam eder'); 

                        // Remove old listener if exists, then add new one
                        window.removeEventListener('hashchange', handleNavigation);
                        window.addEventListener('hashchange', handleNavigation);
                        handleNavigation(); 
                    }
                } else {
                    // User is signed out.
                    state.userId = null;
                    document.getElementById('login-overlay').classList.remove('hidden');
                    document.getElementById('sidebar').classList.add('hidden');
                    document.getElementById('main-content').classList.add('hidden');
                    
                    // Clear all listeners and intervals
                    Object.values(state.listeners).forEach(unsubscribe => unsubscribe());
                    state.listeners = {};
                    
                    if (state.campaignCheckInterval) {
                        clearInterval(state.campaignCheckInterval);
                        state.campaignCheckInterval = null;
                    }
                }
            });

        } catch (error) { 
            console.error("Firebase Hatasƒ±:", error); 
            showToast(`Firebase ba≈ülatƒ±lamadƒ±: ${error.message}`, true); 
        }
    }
    // Firebase hata mesajlarƒ±nƒ± T√ºrk√ße'ye √ßevir
    const getFirebaseErrorMessage = (errorCode) => {
        const errorMessages = {
            'auth/email-already-in-use': '‚ùå Bu e-posta adresi zaten kullanƒ±mda. L√ºtfen giri≈ü yapƒ±n veya farklƒ± bir e-posta deneyin.',
            'auth/invalid-email': '‚ùå Ge√ßersiz e-posta adresi. L√ºtfen doƒüru bir e-posta girin.',
            'auth/operation-not-allowed': '‚ùå E-posta/≈üifre ile kayƒ±t ≈üu an devre dƒ±≈üƒ±.',
            'auth/weak-password': '‚ùå ≈ûifre √ßok zayƒ±f. En az 6 karakter kullanƒ±n.',
            'auth/user-disabled': '‚ùå Bu hesap devre dƒ±≈üƒ± bƒ±rakƒ±lmƒ±≈ü.',
            'auth/user-not-found': '‚ùå Kullanƒ±cƒ± bulunamadƒ±. L√ºtfen kayƒ±t olun.',
            'auth/wrong-password': '‚ùå Yanlƒ±≈ü ≈üifre. L√ºtfen tekrar deneyin.',
            'auth/invalid-credential': '‚ùå Ge√ßersiz giri≈ü bilgileri. E-posta veya ≈üifre hatalƒ±.',
            'auth/too-many-requests': '‚ùå √áok fazla ba≈üarƒ±sƒ±z deneme. L√ºtfen daha sonra tekrar deneyin.',
            'auth/network-request-failed': '‚ùå ƒ∞nternet baƒülantƒ±sƒ± hatasƒ±. Baƒülantƒ±nƒ±zƒ± kontrol edin.',
            'auth/requires-recent-login': '‚ùå Bu i≈ülem i√ßin yeniden giri≈ü yapmanƒ±z gerekiyor.',
            'auth/invalid-login-credentials': '‚ùå Giri≈ü bilgileri hatalƒ±. E-posta veya ≈üifrenizi kontrol edin.'
        };
        return errorMessages[errorCode] || `‚ùå Bir hata olu≈ütu: ${errorCode}`;
    };
    
    const handleEmailLogin = async () => {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        if (!email || !password) {
            showToast("L√ºtfen e-posta ve ≈üifreyi girin.", true);
            return;
        }
        try {
            await signInWithEmailAndPassword(state.auth, email, password);
        } catch (error) {
            console.error("Giri≈ü hatasƒ±:", error);
            const errorMessage = getFirebaseErrorMessage(error.code);
            showToast(errorMessage, true);
        }
    };

    const handleEmailSignUp = async () => {
        const name = document.getElementById('signup-name').value.trim();
        const surname = document.getElementById('signup-surname').value.trim();
        const phone = document.getElementById('signup-phone').value.trim();
        const company = document.getElementById('signup-company').value.trim();
        const email = document.getElementById('signup-email').value.trim();
        const password = document.getElementById('signup-password').value;
        
        // Validasyonlar
        if (!name || !surname || !phone || !company || !email || !password) {
            showToast("‚ùå L√ºtfen t√ºm alanlarƒ± doldurun.", true);
            return;
        }
        
        // Telefon formatƒ± kontrol√º
        const phoneRegex = /^(05)[0-9]{9}$/;
        if (!phoneRegex.test(phone)) {
            showToast("‚ùå Ge√ßerli bir telefon numarasƒ± girin (05XXXXXXXXX)", true);
            return;
        }
        
        if (password.length < 6) {
            showToast("‚ùå ≈ûifre en az 6 karakter olmalƒ±dƒ±r.", true);
            return;
        }
        
        try {
            // Check if email is blocked
            const blockedEmailsRef = doc(state.db, "system_data", "blocked_emails");
            const blockedDoc = await getDoc(blockedEmailsRef);
            
            if (blockedDoc.exists()) {
                const blockedEmails = blockedDoc.data().emails || [];
                if (blockedEmails.includes(email)) {
                    showToast("‚ùå Bu e-posta adresi ile kayƒ±t olunamaz. L√ºtfen farklƒ± bir e-posta deneyin veya destek ile ileti≈üime ge√ßin.", true);
                    return;
                }
            }
            
            // Firebase'de kullanƒ±cƒ± olu≈ütur
            const userCredential = await createUserWithEmailAndPassword(state.auth, email, password);
            const user = userCredential.user;
            
            // Kullanƒ±cƒ± bilgilerini Firestore'a kaydet
            const userDocRef = doc(state.db, "users", user.uid);
            await setDoc(userDocRef, {
                name: name,
                surname: surname,
                phone: phone,
                company: company,
                email: email,
                credits: 25, // ƒ∞lk kayƒ±tta direkt 25 mesaj kredisi
                emailVerified: true, // E-posta doƒürulama kaldƒ±rƒ±ldƒ±
                createdAt: serverTimestamp(),
                verifiedAt: serverTimestamp(), // Otomatik doƒürulanmƒ±≈ü olarak i≈üaretle
                role: 'user'
            });
            
            showToast("üéâ Hesap ba≈üarƒ±yla olu≈üturuldu! 25 mesaj kredisi hediye edildi!", false);
        } catch (error) {
            console.error("Hesap olu≈üturma hatasƒ±:", error);
            const errorMessage = getFirebaseErrorMessage(error.code);
            showToast(errorMessage, true);
        }
    };

    const handleLogout = async () => {
        try {
            await signOut(state.auth);
            
            // T√ºm formlarƒ± gizle ve login formunu g√∂ster
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('forgot-password-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            
            // Formu temizle
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            
            showToast("‚úÖ Ba≈üarƒ±yla √ßƒ±kƒ±≈ü yapƒ±ldƒ±.");
        } catch (error) {
            console.error("√áƒ±kƒ±≈ü hatasƒ±:", error);
            showToast(`‚ùå √áƒ±kƒ±≈ü yapƒ±lamadƒ±: ${error.message}`, true);
        }
    };
    const handlePasswordReset = async () => {
        const email = document.getElementById('reset-email').value;
        if (!email) {
            showToast("L√ºtfen e-posta adresinizi girin.", true);
            return;
        }
        
        // E-posta formatƒ± kontrol√º
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showToast("Ge√ßerli bir e-posta adresi girin.", true);
            return;
        }
        
        try {
            await sendPasswordResetEmail(state.auth, email);
            showToast("‚úÖ ≈ûifre sƒ±fƒ±rlama baƒülantƒ±sƒ± e-posta adresinize g√∂nderildi. L√ºtfen gelen kutunuzu kontrol edin.", false);
            
            // 3 saniye sonra giri≈ü formuna d√∂n
            setTimeout(() => {
                document.getElementById('forgot-password-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('reset-email').value = '';
            }, 3000);
        } catch (error) {
            console.error("≈ûifre sƒ±fƒ±rlama hatasƒ±:", error);
            const errorMessage = getFirebaseErrorMessage(error.code);
            showToast(errorMessage, true);
        }
    };
    function setupRealtimeListeners() {
        const collectionsToListen = ['campaigns', 'templates', 'templateGroups', 'groups'];
        collectionsToListen.forEach(name => {
            try {
                if (state.listeners[name]) state.listeners[name]();
                const q = query(collection(state.db, "users", state.userId, name), orderBy('createdAt', 'desc'));
                state.listeners[name] = onSnapshot(q, (snapshot) => {
                    state.collections[name] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderCurrentPage();
                    
                    // Kampanyalar g√ºncellendiƒüinde kontrol et (sayfa kapalƒ±yken devam etmesi i√ßin)
                    if (name === 'campaigns') {
                        // Yanlƒ±≈ü "Tamamlandƒ±" durumundaki kampanyalarƒ± d√ºzelt
                        fixIncorrectlyCompletedCampaigns().catch(err => 
                            console.error('Kampanya d√ºzeltme hatasƒ±:', err)
                        );
                        
                        // Eƒüer ayarlar sayfasƒ±ndaysak, raporlarƒ± da g√ºncelle
                        if (state.currentPage === 'ayarlar' && document.getElementById('campaign-reports-table')) {
                            console.log('üìä Kampanya raporlarƒ± g√ºncelleniyor (realtime)...');
                            updateCampaignReportsTable(state.collections.campaigns);
                            updateCampaignReportsStats(state.collections.campaigns);
                        }
                    }
                }, (error) => console.error(`${name} dinlenirken hata:`, error));
            } catch (error) { console.error(`Listener setup error for ${name}:`, error); }
        });

        try {
            if (state.listeners.settings) state.listeners.settings();
            const settingsDocRef = doc(state.db, "users", state.userId, "app_settings/main");
            state.listeners.settings = onSnapshot(settingsDocRef, (docSnap) => {
                if(docSnap.exists()){
                    state.collections.settings = docSnap.data();
                } else {
                    const defaultSettings = {
                        devices: [],
                        delays: { min: 10, max: 30, longMin: 60, longMax: 120, trigger: 25 },
                        enable24HourRule: false
                    };
                    setDoc(settingsDocRef, defaultSettings);
                    state.collections.settings = defaultSettings;
                }
                renderCurrentPage();
            }, (error) => console.error('Ayarlar dinlenirken hata:', error));

        } catch (error) { console.error(`Settings listener setup error:`, error); }

        // Listen to user message credits
        try {
            if (state.listeners.messageCredits) state.listeners.messageCredits();
            const userDocRef = doc(state.db, "users", state.userId);
            state.listeners.messageCredits = onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    state.messageCredits = userData.credits || 0;
                    
                    // Update credits display in sidebar
                    const creditsEl = document.getElementById('user-credits');
                    if (creditsEl) {
                        creditsEl.textContent = state.messageCredits.toLocaleString('tr-TR');
                    }
                } else {
                    // Create user document with initial credits
                    setDoc(userDocRef, {
                        credits: 0,
                        email: state.auth.currentUser.email,
                        createdAt: serverTimestamp()
                    });
                    state.messageCredits = 0;
                }
            }, (error) => console.error('User credits dinlenirken hata:', error));
        } catch (error) { console.error(`User credits listener setup error:`, error); }

        // Listen to system settings (for packages, IBAN, etc)
        try {
            if (state.listeners.systemSettings) state.listeners.systemSettings();
            const settingsDocRef = doc(state.db, "system_settings", "main");
            state.listeners.systemSettings = onSnapshot(settingsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    state.systemSettings = docSnap.data();
                } else {
                    // Create default system settings
                    const defaultSettings = {
                        bankName: 'Ziraat Bankasƒ±',
                        accountHolder: 'WaoTR',
                        iban: 'TR33 0001 0000 0000 0000 0000 01',
                        packages: [
                            { id: 1, name: 'Ba≈ülangƒ±√ß Paketi', credits: 100, price: 50, popular: false },
                            { id: 2, name: 'Standart Paket', credits: 500, price: 200, popular: true },
                            { id: 3, name: 'Premium Paket', credits: 1000, price: 350, popular: false },
                            { id: 4, name: 'Enterprise Paket', credits: 5000, price: 1500, popular: false }
                        ]
                    };
                    setDoc(settingsDocRef, defaultSettings);
                    state.systemSettings = defaultSettings;
                }
                // Bakiye sayfasƒ±nda isek yeniden render et
                if (state.currentPage === 'bakiye') {
                    renderCurrentPage();
                }
            }, (error) => console.error('System settings dinlenirken hata:', error));
        } catch (error) { console.error(`System settings listener setup error:`, error); }
    }
    const Firestore = {
        async add(coll, data) {
            try {
                const docRef = await addDoc(collection(state.db, "users", state.userId, coll), { ...data, createdAt: serverTimestamp() });
                showToast(`${coll.slice(0, -1)} ba≈üarƒ±yla eklendi.`);
                return docRef.id;
            } catch (error) { console.error("Firestore Add Error:", error); showToast(`Ekleme hatasƒ±: ${error.message}`, true); return null; }
        },
        async update(coll, id, data, silent = false) {
            try {
                await updateDoc(doc(state.db, "users", state.userId, coll, id), data);
                if (!silent) {
                    showToast(`${coll.slice(0, -1)} ba≈üarƒ±yla g√ºncellendi.`);
                }
                return true;
            } catch (error) { console.error("Firestore Update Error:", error); showToast(`G√ºncelleme hatasƒ±: ${error.message}`, true); return false; }
        },
        async delete(coll, id) {
            try {
                await deleteDoc(doc(state.db, "users", state.userId, coll, id));
                showToast(`${coll.slice(0, -1)} ba≈üarƒ±yla silindi.`); return true;
            } catch (error) { console.error("Firestore Delete Error:", error); showToast(`Silme hatasƒ±: ${error.message}`, true); return false; }
        },
        async updateSettings(data) {
             try {
                await setDoc(doc(state.db, "users", state.userId, "app_settings/main"), data, { merge: true });
                return true;
            } catch (error) { console.error("Firestore Settings Update Error:", error); showToast(`Ayarlarƒ± g√ºncelleme hatasƒ±: ${error.message}`, true); return false; }
        }
    };
    
    // --- UI Rendering ---
    const appContent = document.getElementById('app-content');
    const pageRenderers = {
        dashboard: renderDashboard, 
        kampanyalar: renderCampaigns, 
        'devam-eden': renderDevamEden,
        mesajlasma: renderMesajlasma,
        planlanmis: renderPlanlanmis,
        tamamlanan: renderTamamlanan,
        raporlar: renderTamamlanan, // geriye d√∂n√ºk uyumluluk i√ßin
        chat: renderChat,
        sablonlar: renderTemplates, 
        'sablon-gruplari': renderTemplateGroups,
        gruplar: renderGroups, 
        ayarlar: renderSettings,
        bakiye: renderBalance
    };

    function renderPage(title, buttonHtml, contentHtml) { appContent.innerHTML = `<div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-gray-800">${title}</h2><div>${buttonHtml}</div></div><div class="bg-white rounded-lg shadow-md"><div class="overflow-x-auto">${contentHtml}</div></div>`; }
    function createStatCard(title, value, color) { return `<div class="bg-white p-6 rounded-lg shadow-md"><p class="text-sm text-gray-500">${title}</p><p class="text-3xl font-bold ${color}">${value}</p></div>`; }
    function renderDashboard() {
        const { campaigns } = state.collections;
        const stats = campaigns.reduce((acc, c) => ({ ...acc, [c.status]: (acc[c.status] || 0) + 1 }), { total: campaigns.length });
        
        // Tamamlanan kampanyalarƒ± hem 'Tamamlandƒ±' hem 'tamamlandƒ±' i√ßin say
        const completedCount = (stats['Tamamlandƒ±'] || 0) + (stats['tamamlandƒ±'] || 0);
        
        appContent.innerHTML = `
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Ana Sayfa</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                ${createStatCard('Toplam Kampanya', stats.total || 0, 'text-gray-800')}
                ${createStatCard('Planlanmƒ±≈ü', stats['planlandƒ±'] || 0, 'text-blue-600')}
                ${createStatCard('G√∂nderiliyor', stats['g√∂nderiliyor'] || 0, 'text-amber-600')}
                ${createStatCard('Tamamlananlar', completedCount, 'text-green-600')}
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md mt-8">
                <h3 class="font-semibold text-gray-800 mb-4">Son Kampanyalar</h3>
                <div class="space-y-4">
                    ${campaigns.slice(0, 5).map(c => {
                        const statusBadgeClass = c.status === 'Tamamlandƒ±' || c.status === 'tamamlandƒ±' ? 'bg-green-500 text-white border-green-600' : 
                                                 c.status === 'g√∂nderiliyor' ? 'bg-amber-100 text-amber-700 border-amber-300' : 
                                                 c.status === 'planlandƒ±' ? 'bg-blue-100 text-blue-700 border-blue-300' : 
                                                 c.status === 'durduruldu' ? 'bg-red-100 text-red-700 border-red-300' :
                                                 'bg-gray-100 text-gray-700 border-gray-300';
                        
                        let displayStatus = c.status || 'Taslak';
                        if (c.status === 'tamamlandƒ±') displayStatus = 'Tamamlandƒ±';
                        if (c.status === 'planlandƒ±') displayStatus = 'Planlandƒ±';
                        if (c.status === 'g√∂nderiliyor') displayStatus = 'G√∂nderiliyor';
                        if (c.status === 'durduruldu') displayStatus = 'Durduruldu';
                        return `
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-center">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800 mb-2">${c.name}</h4>
                                    <span class="inline-block px-3 py-1 rounded-full text-xs font-medium border ${statusBadgeClass}">${displayStatus}</span>
                                </div>
                                <div class="flex space-x-2">
                                    <button data-id="${c.id}" class="dashboard-details-btn text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-3 py-2 rounded transition-colors" title="Detaylar">
                                        <i class="fas fa-eye mr-1"></i>Detaylar
                                    </button>
                                    <button data-id="${c.id}" class="dashboard-delete-btn text-red-600 hover:text-red-800 hover:bg-red-50 px-3 py-2 rounded transition-colors" title="Sil">
                                        <i class="fas fa-trash mr-1"></i>Sil
                                    </button>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('') || '<p class="text-sm text-gray-500">Hen√ºz kampanya yok.</p>'}
                </div>
            </div>`;
        
        // Event listeners for dashboard buttons
        setTimeout(() => {
            appContent.querySelectorAll('.dashboard-details-btn').forEach(btn => {
                btn.onclick = () => showCampaignDetailsModal(state.collections.campaigns.find(c => c.id === btn.dataset.id));
            });
            appContent.querySelectorAll('.dashboard-delete-btn').forEach(btn => {
                btn.onclick = () => ModalManager.confirm('Kampanyayƒ± Sil', 'Emin misiniz?', () => Firestore.delete('campaigns', btn.dataset.id));
            });
        }, 100);
    }

    function renderDetailsButton(campaign) {
        return `<button data-id="${campaign.id}" class="details-btn text-blue-600 hover:text-blue-800" title="Detaylar"><i class="fas fa-eye"></i></button>`;
    }
    
    function renderCampaignRow(c) {
        const group = state.collections.groups.find(g => g.id === c.groupId);
        const device = (state.collections.settings.devices || []).find(d => d.id === c.deviceId);
        const totalNumbers = getGroupNumbers(group).length;
        // Ger√ßek sayƒ±larƒ± kullan - dizilerin uzunluƒüu ger√ßek durumu g√∂sterir
        const sentNumbers = c.sentNumbers || [];
        const errorNumbers = c.errorNumbers || [];
        const skippedNumbers = c.skippedNumbers || [];
        
        // √áakƒ±≈ümalarƒ± √∂nlemek i√ßin unique sayƒ±larƒ± al
        const allProcessedNumbers = new Set([...sentNumbers, ...errorNumbers, ...skippedNumbers]);
        const sentCount = sentNumbers.length;
        const errorCount = errorNumbers.length;
        const skippedCount = skippedNumbers.length;
        const processingCount = Math.max(0, totalNumbers - allProcessedNumbers.size);
        const progress = totalNumbers > 0 ? (allProcessedNumbers.size / totalNumbers) * 100 : 0;
        
        // Sender info display
        const senderDisplay = device ? `
            <div class="text-sm font-medium text-gray-900">${device.instanceName}</div>
            <div class="text-xs text-gray-500">üì± ${device.phoneNumber || device.phone || 'N/A'}</div>
        ` : '<span class="text-xs text-gray-400">Cihaz bulunamadƒ±</span>';
        
        // Status display with counts
        let statusText = c.status;
        if (c.status === 'g√∂nderiliyor') statusText = 'G√∂nderiliyor';
        if (c.status === 'tamamlandƒ±') statusText = 'Tamamlandƒ±';
        if (c.status === 'planlandƒ±') statusText = 'Planlandƒ±';
        if (c.status === 'durduruldu') statusText = 'Durduruldu';
        
        const statusClass = (c.status === 'Tamamlandƒ±' || c.status === 'tamamlandƒ±') ? 'status-Tamamlandƒ±' : `status-${c.status}`;
        let statusDisplay = `<span class="status-badge ${statusClass}">${statusText}</span>`;
        // Her zaman istatistikleri g√∂ster
        statusDisplay += `<div class="mt-1 text-xs text-gray-600">
            <span class="text-green-600">‚úÖ ${sentCount}</span> | 
            <span class="text-red-600">‚ùå ${errorCount}</span> | 
            ${skippedCount > 0 ? `<span class="text-yellow-600">‚è≠Ô∏è ${skippedCount}</span> | ` : ''}
            <span class="text-blue-600">‚è≥ ${processingCount > 0 ? processingCount : 0}</span> | 
            <span class="text-gray-500">üìä ${totalNumbers}</span>
        </div>`;
        
        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 font-medium text-gray-900">
                    <div>${c.name}</div>
                    ${c.status === 'g√∂nderiliyor' && totalNumbers > 0 ? `<div class="mt-1"><div class="progress-bar"><div class="progress-bar-inner" style="width: ${progress}%"></div></div></div>` : ''}
                </td>
                <td class="px-6 py-4">${senderDisplay}</td>
                <td class="px-6 py-4">${group?.name || 'Grup Yok'} (${totalNumbers} ki≈üi)</td>
                <td class="px-6 py-4">${statusDisplay}</td>
                <td class="px-6 py-4 text-right space-x-2">
                    ${c.status === 'g√∂nderiliyor' || c.status === 'planlandƒ±' ? `
                        <button data-id="${c.id}" class="pause-campaign-btn text-orange-600 hover:text-orange-800" title="Durdur"><i class="fas fa-pause"></i></button>
                    ` : ''}
                    ${c.status === 'durduruldu' ? `<button data-id="${c.id}" class="resume-campaign-btn text-green-600 hover:text-green-800" title="Devam Ettir"><i class="fas fa-play"></i></button>` : ''}
                    <button data-id="${c.id}" class="live-monitor-btn text-purple-600 hover:text-purple-800" title="ƒ∞statistikler"><i class="fas fa-chart-line"></i></button>
                    ${renderDetailsButton(c)}
                    <button data-id="${c.id}" class="edit-btn text-blue-600 hover:text-blue-800" title="D√ºzenle"><i class="fas fa-edit"></i></button>
                    <button data-id="${c.id}" class="delete-btn text-red-600 hover:text-red-800" title="Sil"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
    }

    function renderCampaigns() {
        // Aktif kampanyalarƒ± g√∂ster (planlandƒ±, g√∂nderiliyor ve durdurulmu≈ü - tamamlanmamƒ±≈ü olanlar)
        console.log('üöÄ Aktif Kampanyalar - T√ºm kampanyalar:', state.collections.campaigns.map(c => ({ name: c.name, status: c.status })));
        const activeCampaigns = state.collections.campaigns.filter(c => {
            return c.status !== 'Tamamlandƒ±' && c.status !== 'tamamlandƒ±';
        });
        console.log('üöÄ Aktif Kampanyalar - G√∂sterilecek olanlar:', activeCampaigns.length);
        
        const button = `<button id="new-campaign-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i> Yeni Kampanya</button>`;
        const table = `<table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Kampanya Adƒ±</th><th class="px-6 py-3">G√∂nderici</th><th class="px-6 py-3">Hedef Grup</th><th class="px-6 py-3">Durum</th><th class="px-6 py-3 text-right">ƒ∞≈ülemler</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${activeCampaigns.map(renderCampaignRow).join('') || '<tr><td colspan="5" class="text-center py-4 text-gray-500">Hen√ºz kampanya yok.</td></tr>'}</tbody></table>`;
        renderPage('Aktif Kampanyalar', button, table);
        document.getElementById('new-campaign-btn').onclick = () => showCampaignModal();
        appContent.querySelectorAll('.edit-btn').forEach(btn => btn.onclick = () => showCampaignModal(state.collections.campaigns.find(c => c.id === btn.dataset.id)));
        appContent.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = () => ModalManager.confirm('Kampanyayƒ± Sil', 'Emin misiniz?', () => Firestore.delete('campaigns', btn.dataset.id)));
        appContent.querySelectorAll('.details-btn').forEach(btn => btn.onclick = () => showCampaignDetailsModal(state.collections.campaigns.find(c => c.id === btn.dataset.id)));
        appContent.querySelectorAll('.live-monitor-btn').forEach(btn => btn.onclick = () => showLiveMonitorModal(state.collections.campaigns.find(c => c.id === btn.dataset.id)));
        appContent.querySelectorAll('.pause-campaign-btn').forEach(btn => btn.onclick = () => pauseCampaign(btn.dataset.id));
        appContent.querySelectorAll('.resume-campaign-btn').forEach(btn => btn.onclick = () => resumeCampaign(btn.dataset.id));
    }
    
    function renderDevamEden() {
        // Devam eden kampanyalarƒ± g√∂ster: En az 1 par√ßasƒ± ba≈ülamƒ±≈ü veya zamanƒ± gelmi≈ü kampanyalar
        console.log('‚ñ∂Ô∏è Devam Eden Kampanyalar - T√ºm kampanyalar:', state.collections.campaigns.map(c => ({ name: c.name, status: c.status, currentScheduleIndex: c.currentScheduleIndex })));
        
        const now = new Date();
        const ongoingCampaigns = state.collections.campaigns.filter(c => {
            // Tamamlanmƒ±≈ü kampanyalarƒ± g√∂sterme
            if (c.status === 'Tamamlandƒ±' || c.status === 'tamamlandƒ±') return false;
            
            // Schedule yoksa g√∂sterme
            if (!c.schedule || c.schedule.length === 0) return false;
            
            const currentScheduleIndex = c.currentScheduleIndex || 0;
            
            // En az bir par√ßa ba≈ülamƒ±≈üsa (currentScheduleIndex > 0) g√∂ster
            if (currentScheduleIndex > 0) return true;
            
            // ƒ∞lk par√ßa ama zamanƒ± gelmi≈üse g√∂ster
            if (currentScheduleIndex === 0 && c.schedule[0]) {
                const firstScheduleTime = c.schedule[0].sendTime.toDate();
                if (firstScheduleTime <= now) return true;
            }
            
            return false;
        });
        
        console.log('‚ñ∂Ô∏è Devam Eden Kampanyalar - G√∂sterilecek olanlar:', ongoingCampaigns.length, ongoingCampaigns.map(c => ({ name: c.name, currentScheduleIndex: c.currentScheduleIndex })));
        
        const button = `<button id="new-campaign-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i> Yeni Kampanya</button>`;
        const table = `<table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Kampanya Adƒ±</th><th class="px-6 py-3">G√∂nderici</th><th class="px-6 py-3">Hedef Grup</th><th class="px-6 py-3">Durum</th><th class="px-6 py-3 text-right">ƒ∞≈ülemler</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${ongoingCampaigns.map(renderCampaignRow).join('') || '<tr><td colspan="5" class="text-center py-4 text-gray-500">Devam eden kampanya yok.</td></tr>'}</tbody></table>`;
        renderPage('Devam Eden Kampanyalar', button, table);
        document.getElementById('new-campaign-btn').onclick = () => showCampaignModal();
        appContent.querySelectorAll('.edit-btn').forEach(btn => btn.onclick = () => showCampaignModal(state.collections.campaigns.find(c => c.id === btn.dataset.id)));
        appContent.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = () => ModalManager.confirm('Kampanyayƒ± Sil', 'Emin misiniz?', () => Firestore.delete('campaigns', btn.dataset.id)));
        appContent.querySelectorAll('.details-btn').forEach(btn => btn.onclick = () => showCampaignDetailsModal(state.collections.campaigns.find(c => c.id === btn.dataset.id)));
        appContent.querySelectorAll('.live-monitor-btn').forEach(btn => btn.onclick = () => showLiveMonitorModal(state.collections.campaigns.find(c => c.id === btn.dataset.id)));
        appContent.querySelectorAll('.pause-campaign-btn').forEach(btn => btn.onclick = () => pauseCampaign(btn.dataset.id));
        appContent.querySelectorAll('.resume-campaign-btn').forEach(btn => btn.onclick = () => resumeCampaign(btn.dataset.id));
    }
    
     function renderPlanlanmis() {
        // Planlanmƒ±≈ü kampanyalarƒ± g√∂ster: SADECE ilk par√ßasƒ± hen√ºz ba≈ülamamƒ±≈ü kampanyalar
        console.log('üìÖ Planlanmƒ±≈ü G√∂nderimler - T√ºm kampanyalar:', state.collections.campaigns.map(c => ({ name: c.name, status: c.status, currentScheduleIndex: c.currentScheduleIndex })));
        
        const now = new Date();
        const plannedCampaigns = state.collections.campaigns.filter(c => {
            // Tamamlanmƒ±≈ü kampanyalarƒ± g√∂sterme
            if (c.status === 'Tamamlandƒ±' || c.status === 'tamamlandƒ±') return false;
            
            // Schedule yoksa g√∂sterme
            if (!c.schedule || c.schedule.length === 0) return false;
            
            const currentScheduleIndex = c.currentScheduleIndex || 0;
            
            // SADECE ilk par√ßasƒ± ba≈ülamamƒ±≈üsa (currentScheduleIndex === 0) ve zamanƒ± gelmemi≈üse g√∂ster
            if (currentScheduleIndex === 0 && c.schedule[0]) {
                const firstScheduleTime = c.schedule[0].sendTime.toDate();
                // Zaman gelmemi≈üse planlanmƒ±≈ü kampanyalarda g√∂ster
                if (firstScheduleTime > now) return true;
            }
            
            return false;
        });
        
        console.log('üìÖ Planlanmƒ±≈ü G√∂nderimler - G√∂sterilecek olanlar:', plannedCampaigns.length, plannedCampaigns.map(c => ({ name: c.name, ilkPar√ßaZamanƒ±: c.schedule[0]?.sendTime.toDate() })));
        const getSendTypeLabel = (type) => {
            if (type === 'now') return 'Hemen G√∂nder';
            if (type === 'later') return 'ƒ∞leri Tarihli';
            if (type === 'split') return 'Par√ßalƒ± G√∂nderim';
            return type;
        };
        const table = `<table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Kampanya Adƒ±</th><th class="px-6 py-3">G√∂nderici</th><th class="px-6 py-3">G√∂nderim Tipi</th><th class="px-6 py-3">ƒ∞lk G√∂nderim</th><th class="px-6 py-3 text-right">ƒ∞≈ülemler</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${plannedCampaigns.map(c => {
            const firstSend = c.schedule?.[0]?.sendTime;
            const device = (state.collections.settings.devices || []).find(d => d.id === c.deviceId);
            const senderDisplay = device ? `
                <div class="text-sm font-medium text-gray-900">${device.instanceName}</div>
                <div class="text-xs text-gray-500">üì± ${device.phoneNumber || device.phone || 'N/A'}</div>
            ` : '<span class="text-xs text-gray-400">Cihaz bulunamadƒ±</span>';
            
            return `<tr class="hover:bg-gray-50"><td class="px-6 py-4 font-medium text-gray-900">${c.name}</td><td class="px-6 py-4">${senderDisplay}</td><td class="px-6 py-4">${getSendTypeLabel(c.sendType)}</td><td class="px-6 py-4">${firstSend ? new Date(firstSend.toDate()).toLocaleString('tr-TR') : 'Belirsiz'}</td><td class="px-6 py-4 text-right space-x-2">${renderDetailsButton(c)}<button data-id="${c.id}" class="send-now-btn text-purple-600 hover:text-purple-800 font-semibold" title="Hemen G√∂nder">‚ö° Hemen G√∂nder</button><button data-id="${c.id}" class="edit-btn text-green-600 hover:text-green-800" title="D√ºzenle"><i class="fas fa-edit"></i></button><button data-id="${c.id}" class="delete-btn text-red-600 hover:text-red-800" title="Sil"><i class="fas fa-trash"></i></button></td></tr>`;
        }).join('') || '<tr><td colspan="5" class="text-center py-4 text-gray-500">Planlanmƒ±≈ü kampanya yok.</td></tr>'}</tbody></table>`;
        const button = `<button id="new-campaign-btn-planned" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i> Yeni Kampanya</button>`;
        renderPage('Planlanmƒ±≈ü Kampanyalar', button, table);
        document.getElementById('new-campaign-btn-planned')?.addEventListener('click', () => showCampaignModal());
        appContent.querySelectorAll('.send-now-btn').forEach(btn => btn.onclick = () => sendCampaignNow(btn.dataset.id));
        appContent.querySelectorAll('.edit-btn').forEach(btn => btn.onclick = () => showCampaignModal(state.collections.campaigns.find(c => c.id === btn.dataset.id)));
        appContent.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = () => ModalManager.confirm('Kampanyayƒ± Sil', 'Emin misiniz?', () => Firestore.delete('campaigns', btn.dataset.id)));
        appContent.querySelectorAll('.details-btn').forEach(btn => btn.onclick = () => showCampaignDetailsModal(state.collections.campaigns.find(c => c.id === btn.dataset.id)));
    }
    function renderTamamlanan() {
        // Sadece tamamlanmƒ±≈ü kampanyalarƒ± g√∂ster
        console.log('‚úÖ Tamamlanan Kampanyalar - T√ºm kampanyalar:', state.collections.campaigns.map(c => ({ name: c.name, status: c.status })));
        const completedCampaigns = state.collections.campaigns.filter(c => {
            const status = c.status || '';
            return status === 'Tamamlandƒ±' || status === 'tamamlandƒ±';
        });
        console.log('‚úÖ Tamamlanan Kampanyalar - G√∂sterilecek olanlar:', completedCampaigns.length);
        
        const table = `<table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Kampanya Adƒ±</th><th class="px-6 py-3">G√∂nderilen / Hatalƒ±</th><th class="px-6 py-3 text-right">ƒ∞≈ülemler</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${completedCampaigns.map(c => {
            return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 font-medium text-gray-900">${c.name}</td>
                <td class="px-6 py-4">
                    <span class="text-green-600">‚úÖ ${(c.sentNumbers || []).length}</span> / 
                    <span class="text-red-600">‚ùå ${(c.errorNumbers || []).length}</span>
                </td>
                <td class="px-6 py-4 text-right space-x-2">
                    ${renderDetailsButton(c)}
                    <button data-id="${c.id}" class="delete-btn text-red-600 hover:text-red-800" title="Sil"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`
        }).join('') || '<tr><td colspan="3" class="text-center py-4 text-gray-500">Tamamlanan kampanya yok.</td></tr>'}</tbody></table>`;
        
        renderPage('Tamamlanan Kampanyalar', '', table);
        appContent.querySelectorAll('.details-btn').forEach(btn => btn.onclick = () => showCampaignDetailsModal(state.collections.campaigns.find(c => c.id === btn.dataset.id)));
        appContent.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = () => ModalManager.confirm('Kampanyayƒ± Sil', 'Emin misiniz?', () => Firestore.delete('campaigns', btn.dataset.id)));
    }
    function renderTemplates() {
        const button = `<button id="new-template-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i> Yeni ≈ûablon</button>`;
        const table = `<table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">≈ûablon Adƒ±</th><th class="px-6 py-3">ƒ∞√ßerik</th><th class="px-6 py-3 text-right">ƒ∞≈ülemler</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${state.collections.templates.map(t => `<tr class="hover:bg-gray-50"><td class="px-6 py-4 font-medium text-gray-900">${t.name}</td><td class="px-6 py-4 text-gray-500 truncate" style="max-width: 300px;">${t.content}</td><td class="px-6 py-4 text-right space-x-2"><button data-id="${t.id}" class="edit-btn text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button><button data-id="${t.id}" class="delete-btn text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button></td></tr>`).join('') || '<tr><td colspan="3" class="text-center py-4 text-gray-500">Hen√ºz ≈üablon yok.</td></tr>'}</tbody></table>`;
        renderPage('Mesaj ≈ûablonlarƒ±', button, table);
        document.getElementById('new-template-btn').onclick = () => showTemplateModal();
        appContent.querySelectorAll('.edit-btn').forEach(btn => btn.onclick = () => showTemplateModal(state.collections.templates.find(c => c.id === btn.dataset.id)));
        appContent.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = () => ModalManager.confirm('≈ûablonu Sil', 'Emin misiniz?', () => Firestore.delete('templates', btn.dataset.id)));
    }
    function renderTemplateGroups() {
        // Reset viewing group state
        state.currentViewingGroupId = null;
        
        const templateGroups = state.collections.templateGroups || [];
        const button = `<button id="new-template-group-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i> Yeni ≈ûablon Grubu</button>`;
        const cards = templateGroups.map(tg => {
            const templateCount = (tg.templates && Array.isArray(tg.templates)) ? tg.templates.length : 0;
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-gray-800 mb-1">${tg.name}</h3>
                            <p class="text-sm text-gray-500">${tg.description || 'A√ßƒ±klama yok'}</p>
                        </div>
                        <div class="flex gap-2">
                            <button data-id="${tg.id}" class="edit-group-btn text-blue-600 hover:text-blue-800 p-2"><i class="fas fa-edit"></i></button>
                            <button data-id="${tg.id}" class="delete-group-btn text-red-600 hover:text-red-800 p-2"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                        <span class="text-sm text-gray-600">
                            <i class="fas fa-file-alt mr-1"></i> ${templateCount} ≈üablon
                        </span>
                        <button data-id="${tg.id}" class="view-templates-btn bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-1 rounded text-sm font-medium">
                            <i class="fas fa-arrow-right mr-1"></i> ≈ûablonlarƒ± G√∂r√ºnt√ºle
                        </button>
                    </div>
                </div>
            `;
        }).join('') || '<div class="col-span-full text-center py-8 text-gray-500">Hen√ºz ≈üablon grubu yok.</div>';
        
        appContent.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">≈ûablon Gruplarƒ±</h2>
                <div>${button}</div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${cards}
            </div>
        `;
        
        document.getElementById('new-template-group-btn').onclick = () => showTemplateGroupModal();
        appContent.querySelectorAll('.edit-group-btn').forEach(btn => btn.onclick = () => showTemplateGroupModal(templateGroups.find(tg => tg.id === btn.dataset.id)));
        appContent.querySelectorAll('.delete-group-btn').forEach(btn => btn.onclick = () => ModalManager.confirm('≈ûablon Grubunu Sil', 'Bu grubu ve i√ßindeki t√ºm ≈üablonlarƒ± silmek istediƒüinize emin misiniz?', () => Firestore.delete('templateGroups', btn.dataset.id)));
        appContent.querySelectorAll('.view-templates-btn').forEach(btn => {
            btn.onclick = () => {
                state.currentViewingGroupId = btn.dataset.id;
                showGroupTemplates(btn.dataset.id);
            };
        });
    }
    
    function renderGroups() {
        const button = `<button id="new-group-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i> Yeni Grup</button>`;
        const table = `<table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Grup Adƒ±</th><th class="px-6 py-3">Ki≈üi Sayƒ±sƒ±</th><th class="px-6 py-3 text-right">ƒ∞≈ülemler</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${state.collections.groups.map(g => {
            const count = (g.contacts && Array.isArray(g.contacts)) ? g.contacts.length : ((g.numbers && Array.isArray(g.numbers)) ? g.numbers.length : 0);
            return `<tr class="hover:bg-gray-50">
                <td class="px-6 py-4 font-medium text-gray-900">${g.name}</td>
                <td class="px-6 py-4">
                    <button onclick="showGroupNumbers('${g.id}')" class="text-blue-600 hover:text-blue-800 hover:underline">
                        ${count} ki≈üi
                    </button>
                </td>
                <td class="px-6 py-4 text-right space-x-2">
                    <button data-id="${g.id}" class="edit-btn text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button>
                    <button data-id="${g.id}" class="delete-btn text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        }).join('') || '<tr><td colspan="3" class="text-center py-4 text-gray-500">Hen√ºz grup yok.</td></tr>'}</tbody></table>`;
        renderPage('Ki≈üi Gruplarƒ±', button, table);
        document.getElementById('new-group-btn').onclick = () => showGroupModal();
        appContent.querySelectorAll('.edit-btn').forEach(btn => btn.onclick = () => showGroupModal(state.collections.groups.find(c => c.id === btn.dataset.id)));
        appContent.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = () => ModalManager.confirm('Grubu Sil', 'Emin misiniz?', () => Firestore.delete('groups', btn.dataset.id)));
    }
    function renderSettings() {
        const { devices = [], delays = { min: 10, max: 30, longMin: 60, longMax: 120, trigger: 25 } } = state.collections.settings;
        const content = `
            <div class="p-6 space-y-8">
                <!-- WhatsApp Section -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                        <i class="fab fa-whatsapp text-green-500 mr-3"></i> WhatsApp Mesajla≈üma Merkezi
                    </h3>

                    <!-- Tabs for different sections -->
                    <div class="flex space-x-1 mb-6 bg-gray-100 p-1 rounded-lg">
                        <button class="whatsapp-tab active px-4 py-2 rounded-md text-sm font-medium transition-colors" onclick="switchWhatsAppTab('messages')">
                            <i class="fas fa-comments mr-2"></i> Mesajla≈üma
                        </button>
                        <button class="whatsapp-tab px-4 py-2 rounded-md text-sm font-medium transition-colors" onclick="switchWhatsAppTab('devices')">
                            <i class="fas fa-mobile-alt mr-2"></i> Cihazlar
                        </button>
                        <button class="whatsapp-tab px-4 py-2 rounded-md text-sm font-medium transition-colors" onclick="switchWhatsAppTab('reports')">
                            <i class="fas fa-chart-bar mr-2"></i> Mesaj Raporlarƒ±
                        </button>
                    </div>

                    <!-- Tab Content: Mesajla≈üma -->
                    <div id="whatsapp-tab-messages" class="whatsapp-tab-content active">
                        <!-- Step 1: Cihaz Se√ßimi -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <h4 class="font-semibold text-gray-800 mb-3">üì± 1. WhatsApp Cihazƒ± Se√ßin</h4>
                            <div class="flex gap-4 items-center">
                                <select id="whatsapp-active-device" class="flex-1 max-w-md border border-gray-300 rounded-md px-3 py-2" onchange="onDeviceSelectionChange()">
                                    <option value="">Bir cihaz se√ßin...</option>
                                    ${devices.map(d => `<option value="${d.id}">${d.cihazAdi} (${d.phone})</option>`).join('')}
                                </select>
                                <div id="whatsapp-device-info" class="flex-1 text-gray-600 text-sm"></div>
                            </div>
                        </div>

                        <!-- Step 2: Mesajla≈üma Alanƒ± -->
                        <div id="whatsapp-messaging-area" class="hidden">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-96">
                                <!-- Contacts List -->
                                <div class="border border-gray-200 rounded-lg p-4 overflow-y-auto">
                                    <h4 class="font-semibold text-gray-800 mb-3">üí¨ Konu≈ümalar</h4>
                                    <input type="text" id="contact-search" class="w-full border border-gray-300 rounded-md px-3 py-2 mb-3" placeholder="üîç Ki≈üi ara...">
                                    <div id="whatsapp-contacts-list">
                                        <p class="text-gray-500 text-sm">Y√ºkleniyor...</p>
                                    </div>
                                </div>

                                <!-- Messages Area -->
                                <div class="lg:col-span-2 flex flex-col border border-gray-200 rounded-lg">
                                    <div id="whatsapp-chat-header" class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                <div>
                                            <h4 id="whatsapp-selected-contact" class="font-semibold text-gray-800">Bir ki≈üi se√ßin</h4>
                                            <small id="whatsapp-selected-phone" class="text-gray-600"></small>
                    </div>
                                        <button id="refresh-messages-btn" class="hidden bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm" onclick="refreshCurrentMessages()">
                                            üîÑ Yenile
                                        </button>
                </div>
                                    
                                    <div id="whatsapp-messages-area" class="flex-1 overflow-y-auto p-4 bg-white">
                                        <div class="text-center text-gray-500">
                                            <p>üëà Soldan bir ki≈üi se√ßin ve mesajla≈ümaya ba≈ülayƒ±n</p>
                                        </div>
                                    </div>

                                    <div id="whatsapp-message-input" class="hidden p-4 bg-gray-50 border-t border-gray-200">
                                        <form id="whatsappSendMessageForm" class="flex gap-2">
                                            <input type="hidden" id="whatsapp-selected-number" />
                                            <textarea id="whatsapp-message-text" class="flex-1 border border-gray-300 rounded-md px-3 py-2 resize-none" rows="2" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." required></textarea>
                                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md whitespace-nowrap">
                                                üì§ G√∂nder
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Cihazlar -->
                    <div id="whatsapp-tab-devices" class="whatsapp-tab-content hidden">
                        <h4 class="font-semibold text-gray-800 mb-4">üì± WhatsApp Cihaz Y√∂netimi</h4>
                        
                        <!-- Add New Device -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <h4 class="font-semibold text-gray-800 mb-3">‚ûï Yeni Cihaz Ekle</h4>
                            <form id="whatsappInstanceForm-new">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Cihaz Adƒ± *</label>
                                        <input type="text" id="newInstanceName" name="instanceName" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="√ñrn: Kulup WhatsApp" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Telefon Numarasƒ± *</label>
                                        <input type="tel" id="newInstancePhone" name="phoneNumber" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="905xxxxxxxxx" required>
                                    </div>
                                </div>
                                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">
                                    üîó Cihaz Olu≈ütur ve QR Kod Al
                                </button>
                            </form>
                        </div>


                        <!-- Send Test Message -->
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-lg mb-4">
                            <h4 class="font-semibold text-gray-800 mb-2">üì® Test Mesajƒ± G√∂nder</h4>
                            <p class="text-blue-700 text-sm mb-3">
                                üí° Baƒülƒ± bir cihazƒ±nƒ±z varsa buradan test mesajƒ± g√∂nderebilirsiniz.
                            </p>
                            <form id="testMessageForm" onsubmit="window.sendTestWhatsAppMessage(event)">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Cihaz Se√ßin *</label>
                                        <select id="testMessageDevice" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                                            <option value="">√ñnce cihaz baƒülayƒ±n...</option>
                                            ${devices.filter(d => d.status === 'connected').map(d => `<option value="${d.id}">${d.cihazAdi} (${d.phone})</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Alƒ±cƒ± Telefon Numarasƒ± *</label>
                                        <input type="tel" id="testMessagePhone" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="905xxxxxxxxx" required>
                                        <small class="text-gray-600">√ñrnek: 905449367543 (90 ile ba≈ülamalƒ±)</small>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Mesaj Metni *</label>
                                    <textarea id="testMessageText" class="w-full border border-gray-300 rounded-md px-3 py-2" rows="3" placeholder="Merhaba, bu bir test mesajƒ±dƒ±r." required></textarea>
                                </div>
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                                    üì§ Mesaj G√∂nder
                                </button>
                            </form>
                        </div>

                        <!-- Connected Devices -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <h4 class="font-semibold text-gray-800 mb-3">üìã Baƒülƒ± Cihazlar</h4>
                            <div id="whatsappDevicesList-main">
                                ${devices.length > 0 ? devices.map(renderDeviceCard).join('') : '<p class="text-gray-500 text-sm">Hen√ºz baƒülƒ± cihaz yok.</p>'}
                            </div>
                        </div>

                        <!-- Genel G√∂nderim Ayarlarƒ± -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-800 mb-3">‚öôÔ∏è Genel G√∂nderim Ayarlarƒ±</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div><label class="block text-sm font-medium">Min Bekleme (sn)</label><input type="number" id="delay-min" class="mt-1 block w-full border border-gray-300 rounded-md p-2" value="${delays.min}"></div>
                                <div><label class="block text-sm font-medium">Max Bekleme (sn)</label><input type="number" id="delay-max" class="mt-1 block w-full border border-gray-300 rounded-md p-2" value="${delays.max}"></div>
                                <div><label class="block text-sm font-medium">Uzun Bekleme Tetikleyicisi</label><input type="number" id="delay-trigger" class="mt-1 block w-full border border-gray-300 rounded-md p-2" value="${delays.trigger}"></div>
                                <div><label class="block text-sm font-medium">Min Uzun Bekleme (sn)</label><input type="number" id="delay-long-min" class="mt-1 block w-full border border-gray-300 rounded-md p-2" value="${delays.longMin}"></div>
                                <div><label class="block text-sm font-medium">Max Uzun Bekleme (sn)</label><input type="number" id="delay-long-max" class="mt-1 block w-full border border-gray-300 rounded-md p-2" value="${delays.longMax}"></div>
                            </div>
                            
                            <!-- 24 Saat Kuralƒ± -->
                            <div class="mt-6 p-4 bg-blue-50 border-l-4 border-blue-500 rounded">
                                <div class="flex items-start">
                                    <input type="checkbox" id="enable-24h-rule" class="mt-1 mr-3" ${state.collections.settings.enable24HourRule ? 'checked' : ''}>
                                    <div class="flex-1">
                                        <label for="enable-24h-rule" class="block text-sm font-semibold text-gray-800 cursor-pointer">
                                            ‚è∞ 24 Saat Kuralƒ± Aktif
                                        </label>
                                        <p class="text-xs text-gray-600 mt-1">
                                            Etkinle≈ütirildiƒüinde, aynƒ± numaraya 24 saat i√ßinde tekrar mesaj g√∂nderilmez. 
                                            Bu √∂zellik t√ºm kampanyalarda ge√ßerlidir.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <button id="save-settings-btn" class="mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">G√∂nderim Ayarlarƒ±nƒ± Kaydet</button>
                        </div>

                    </div>


                    <!-- Tab Content: Mesaj Raporlarƒ± -->
                    <div id="whatsapp-tab-reports" class="whatsapp-tab-content hidden">
                        <h4 class="font-semibold text-gray-800 mb-4">üìä Kampanya Raporlarƒ±</h4>
                        
                        <!-- Filter Options -->
                        <div class="flex gap-4 mb-4 flex-wrap">
                            <select class="border border-gray-300 rounded-md px-3 py-2" id="report-filter-status" onchange="filterCampaignReports()">
                                <option value="all">T√ºm Durumlar</option>
                                <option value="tamamlandƒ±">‚úÖ Tamamlandƒ±</option>
                                <option value="g√∂nderiliyor">‚è≥ G√∂nderiliyor</option>
                                <option value="planlandƒ±">üìÖ Planlandƒ±</option>
                                <option value="durduruldu">‚ùå Durduruldu</option>
                            </select>
                            
                            <input type="date" class="border border-gray-300 rounded-md px-3 py-2" id="report-filter-date" onchange="filterCampaignReports()">
                            
                            <button class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-md" onclick="exportCampaignReports()">üì• Excel ƒ∞ndir</button>
                        </div>
                        
                        <!-- Statistics Cards -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-green-50 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-green-600" data-stat="total-sent">0</div>
                                <div class="text-sm text-gray-600">Toplam G√∂nderilen</div>
                            </div>
                            <div class="bg-red-50 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-red-600" data-stat="total-errors">0</div>
                                <div class="text-sm text-gray-600">Toplam Hatalƒ±</div>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-blue-600" data-stat="total-campaigns">0</div>
                                <div class="text-sm text-gray-600">Toplam Kampanya</div>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-yellow-600" data-stat="success-rate">0%</div>
                                <div class="text-sm text-gray-600">Ba≈üarƒ± Oranƒ±</div>
                            </div>
                        </div>
                        
                        <!-- Reports Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm border-collapse">
                                <thead class="bg-white">
                                    <tr class="border-b-2 border-gray-300">
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Kampanya Adƒ±</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Hedef Grup</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">G√∂nderilen</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Hatalƒ±</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Bakiye Durumu</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Durum</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Olu≈üturulma</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-700">ƒ∞≈ülem</th>
                                    </tr>
                                </thead>
                                <tbody id="campaign-reports-table">
                                    <tr><td colspan="8" class="text-center py-4 text-gray-500">Kampanya raporu y√ºkleniyor...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Company Information Settings -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                     <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-building text-blue-500 mr-3"></i> ≈ûirket Bilgilerim
                     </h3>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">≈ûirket Adƒ± *</label>
                            <input type="text" id="company-name" class="w-full border border-gray-300 rounded-md px-3 py-2" value="${state.userCompany || ''}" placeholder="≈ûirket adƒ±nƒ±zƒ± girin">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Telefon</label>
                            <input type="tel" id="company-phone" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="05XXXXXXXXX">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">E-posta</label>
                            <input type="email" id="company-email" class="w-full border border-gray-300 rounded-md px-3 py-2" value="${state.auth.currentUser?.email || ''}" disabled>
                            <small class="text-gray-500">E-posta adresi deƒüi≈ütirilemez</small>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ƒ∞sim Soyisim</label>
                            <input type="text" id="company-owner-name" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="ƒ∞sim ve soyisim">
                        </div>
                     </div>
                    <button id="save-company-info-btn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                        üíæ ≈ûirket Bilgilerini G√ºncelle
                    </button>
                </div>
            </div>`;
        renderPage('Ayarlar', '', content);
        // WhatsApp tab functionality
        window.switchWhatsAppTab = function(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.whatsapp-tab-content').forEach(tab => {
                tab.classList.add('hidden');
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.whatsapp-tab').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600', 'text-white');
                btn.classList.add('text-gray-600');
            });
            
            // Show selected tab content
            document.getElementById(`whatsapp-tab-${tabName}`).classList.remove('hidden');
            document.getElementById(`whatsapp-tab-${tabName}`).classList.add('active');
            
            // Add active class to selected tab
            const activeTab = document.querySelector(`[onclick="switchWhatsAppTab('${tabName}')"]`);
            activeTab.classList.add('active', 'bg-blue-600', 'text-white');
            activeTab.classList.remove('text-gray-600');
            
            // Eƒüer raporlar tab'ƒ±na ge√ßildiyse, raporlarƒ± g√ºncelle
            if (tabName === 'reports') {
                console.log('üìä Raporlar tab\'ƒ± a√ßƒ±ldƒ±, veriler y√ºkleniyor...');
                setTimeout(() => {
                    if (document.getElementById('campaign-reports-table')) {
                        updateCampaignReportsTable(state.collections.campaigns);
                        updateCampaignReportsStats(state.collections.campaigns);
                    }
                }, 100);
            }
        };

        // Device management functionality
        document.getElementById('add-device-btn')?.addEventListener('click', () => showAddDeviceModal());
        appContent.querySelectorAll('.edit-device-btn').forEach(btn => btn.onclick = () => editDevice(devices.find(d => d.id == btn.dataset.id)));
        appContent.querySelectorAll('.delete-device-btn').forEach(btn => btn.onclick = () => ModalManager.confirm('Cihazƒ± Sil', 'Bu cihazƒ± silmek istediƒüinizden emin misiniz?', () => saveDevices(devices.filter(d => d.id != btn.dataset.id))));
        appContent.querySelectorAll('.connect-device-btn').forEach(btn => btn.onclick = () => connectDevice(devices.find(d => d.id == btn.dataset.id)));
        appContent.querySelectorAll('.disconnect-device-btn').forEach(btn => btn.onclick = () => disconnectDevice(devices.find(d => d.id == btn.dataset.id)));

        // WhatsApp device form event listener
        const whatsappForm = document.getElementById('whatsappInstanceForm-new');
        if (whatsappForm) {
            whatsappForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const cihazAdi = document.getElementById('newInstanceName').value.trim();
                const phone = document.getElementById('newInstancePhone').value.trim();
                
                if (!cihazAdi || !phone) {
                    showToast("L√ºtfen t√ºm alanlarƒ± doldurun.", true);
                    return;
                }

                // Sanitize name - only remove spaces, keep numbers and letters
                const sanitizedName = cihazAdi.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, "").replace(/-+/g, '-').replace(/^-+|-+$/g, '').toLowerCase();
                if (!sanitizedName) {
                    showToast("Ge√ßerli bir cihaz adƒ± girin.", true);
                    return;
                }

                // Use the sanitized name directly (user's input without spaces)
                const instanceName = sanitizedName;
                
                // Otomatik API URL ve Key olu≈ütur
                const apiUrl = 'https://evo-2.edu-ai.online';
                const apiKey = 'B6D711FCDE4D4FD5936544120E713976';
                
                const newDevice = {
                    id: Date.now().toString(),
                    cihazAdi: cihazAdi,
                    phone: phone,
                    phoneNumber: phone,
                    instanceName: instanceName,
                    status: 'disconnected',
                    apiUrl: apiUrl,
                    apiKey: apiKey
                };
                
                connectDevice(newDevice, true);
            });
        }

        // Kullanƒ±cƒ± bilgilerini y√ºkle
        const loadUserCompanyInfo = async () => {
            try {
                const userDocRef = doc(state.db, "users", state.userId);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    if (data.phone) document.getElementById('company-phone').value = data.phone;
                    if (data.name && data.surname) document.getElementById('company-owner-name').value = `${data.name} ${data.surname}`;
                }
            } catch (error) {
                console.error("Kullanƒ±cƒ± bilgileri y√ºklenemedi:", error);
            }
        };
        loadUserCompanyInfo();

        // ≈ûirket bilgilerini kaydet
        document.getElementById('save-company-info-btn').onclick = async (e) => {
            const btn = e.currentTarget; 
            btn.disabled = true; 
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Kaydediliyor...';
            
            const companyName = document.getElementById('company-name').value.trim();
            const companyPhone = document.getElementById('company-phone').value.trim();
            const ownerName = document.getElementById('company-owner-name').value.trim();
            
            if (!companyName) {
                showToast("‚ùå ≈ûirket adƒ± bo≈ü bƒ±rakƒ±lamaz!", true);
                btn.disabled = false; 
                btn.innerHTML = 'üíæ ≈ûirket Bilgilerini G√ºncelle';
                return;
            }
            
            try {
                const userDocRef = doc(state.db, "users", state.userId);
                const updateData = {
                    company: companyName,
                    updatedAt: serverTimestamp()
                };
                
                if (companyPhone) updateData.phone = companyPhone;
                
                // ƒ∞sim-soyisim ayrƒ±≈ütƒ±r
                if (ownerName) {
                    const nameParts = ownerName.split(' ');
                    updateData.name = nameParts[0] || '';
                    updateData.surname = nameParts.slice(1).join(' ') || '';
                }
                
                await updateDoc(userDocRef, updateData);
                
                // State'i g√ºncelle
                state.userCompany = companyName;
                document.getElementById('user-company-display').textContent = companyName;
                
                showToast("‚úÖ ≈ûirket bilgileri ba≈üarƒ±yla g√ºncellendi!", false);
            } catch (error) {
                console.error("≈ûirket bilgileri g√ºncellenemedi:", error);
                showToast("‚ùå G√ºncelleme ba≈üarƒ±sƒ±z. L√ºtfen tekrar deneyin.", true);
            }
            
            btn.disabled = false; 
            btn.innerHTML = 'üíæ ≈ûirket Bilgilerini G√ºncelle';
        };

        document.getElementById('save-settings-btn').onclick = async (e) => {
            const btn = e.currentTarget; btn.disabled = true; btn.textContent = 'Kaydediliyor...';
            const newDelays = {
                min: parseInt(document.getElementById('delay-min').value), max: parseInt(document.getElementById('delay-max').value),
                trigger: parseInt(document.getElementById('delay-trigger').value), longMin: parseInt(document.getElementById('delay-long-min').value),
                longMax: parseInt(document.getElementById('delay-long-max').value),
            };
            const enable24HourRule = document.getElementById('enable-24h-rule').checked;
            if (await Firestore.updateSettings({ delays: newDelays, enable24HourRule: enable24HourRule })) {
                showToast("G√∂nderim ayarlarƒ± kaydedildi.");
            }
            btn.disabled = false; btn.textContent = 'G√∂nderim Ayarlarƒ±nƒ± Kaydet';
        };

        // Load sent messages log and campaign reports
        loadSentMessagesLog();
        
        // Initialize campaign reports
        if (document.getElementById('campaign-reports-table')) {
            updateCampaignReportsTable(state.collections.campaigns);
            updateCampaignReportsStats(state.collections.campaigns);
        }
    }

    function loadSentMessagesLog() {
        // Bu fonksiyon g√∂nderilen mesajlarƒ±n logunu y√ºkler
        // ≈ûu an i√ßin bo≈ü bƒ±rakƒ±yoruz, gelecekte implement edilebilir
        console.log('üìã G√∂nderilen mesajlar logu y√ºkleniyor...');
        
        // Eƒüer sent messages log tablosu varsa, g√ºncelle
        const logTable = document.getElementById('sent-messages-log-table');
        if (logTable) {
            // Log tablosunu g√ºncelle
            logTable.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-gray-500 py-4">
                        <i class="fas fa-info-circle mr-2"></i>
                        G√∂nderilen mesajlar logu hen√ºz implement edilmedi
                    </td>
                </tr>
            `;
        }
    }

    function updateCampaignReportsTable(campaigns) {
        // Kampanya raporlarƒ± tablosunu g√ºnceller
        console.log('üìä Kampanya raporlarƒ± tablosu g√ºncelleniyor...');
        
        const reportsTable = document.getElementById('campaign-reports-table');
        if (!reportsTable) return;
        
        if (!campaigns || campaigns.length === 0) {
            reportsTable.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-gray-500 py-4">
                        <i class="fas fa-info-circle mr-2"></i>
                        Hen√ºz kampanya raporu yok
                    </td>
                </tr>
            `;
            return;
        }
        
        const reportsHtml = campaigns.map(campaign => {
            // Ger√ßek sayƒ±larƒ± kullan - dizilerin uzunluƒüu ger√ßek durumu g√∂sterir
            const sentCount = (campaign.sentNumbers || []).length;
            const errorCount = (campaign.errorNumbers || []).length;
            let totalCount = campaign.totalCount || 0;
            
            // Eƒüer totalCount 0 ise, groupId'den hesapla
            if (totalCount === 0 && campaign.groupId) {
                const group = state.collections.groups.find(g => g.id === campaign.groupId);
                if (group) {
                    totalCount = getGroupNumbers(group).length;
                }
            }
            
            const usedMessages = sentCount + errorCount;
            const remainingBalance = state.messageCredits;
            
            // Grup bilgisi
            let groupInfo;
            if (campaign.hedefGrup) {
                groupInfo = `${campaign.hedefGrup.name || 'Grup'} (${totalCount})`;
            } else if (campaign.groupId) {
                const group = state.collections.groups.find(g => g.id === campaign.groupId);
                groupInfo = group ? `${group.name} (${totalCount})` : `Toplam (${totalCount})`;
            } else {
                groupInfo = `Toplam (${totalCount})`;
            }
            
            // Durum badge
            let statusBadge = '';
            let statusClass = '';
            if (campaign.status === 'tamamlandƒ±' || campaign.status === 'Tamamlandƒ±') {
                statusBadge = 'Tamamlandƒ±';
                statusClass = 'bg-green-100 text-green-700';
            } else if (campaign.status === 'g√∂nderiliyor') {
                statusBadge = 'G√∂nderiliyor';
                statusClass = 'bg-blue-100 text-blue-700';
            } else if (campaign.status === 'durduruldu') {
                statusBadge = 'Durduruldu';
                statusClass = 'bg-red-100 text-red-700';
            } else if (campaign.status === 'planlandƒ±') {
                statusBadge = 'Planlandƒ±';
                statusClass = 'bg-yellow-100 text-yellow-700';
            } else {
                statusBadge = campaign.status || 'Bilinmiyor';
                statusClass = 'bg-gray-100 text-gray-700';
            }
            
            // Tarih formatƒ±
            const createdDate = campaign.createdAt?.toDate ? 
                campaign.createdAt.toDate().toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 
                'Bilinmiyor';
            
            return `
                <tr class="border-b border-gray-200 hover:bg-gray-50">
                    <td class="py-3 px-4 text-sm font-medium text-gray-900">
                        ${campaign.name || 'ƒ∞simsiz Kampanya'}
                    </td>
                    <td class="py-3 px-4 text-sm text-blue-600">
                        ${groupInfo}
                    </td>
                    <td class="py-3 px-4 text-sm font-semibold text-green-600">
                        ${sentCount}
                    </td>
                    <td class="py-3 px-4 text-sm font-semibold text-red-600">
                        ${errorCount}
                    </td>
                    <td class="py-3 px-4 text-sm">
                        <div class="text-red-600 font-medium">-${usedMessages} mesaj</div>
                        <div class="text-green-600 text-xs">Kalan: ${remainingBalance.toLocaleString('tr-TR')}</div>
                    </td>
                    <td class="py-3 px-4">
                        <span class="px-3 py-1 text-xs font-medium rounded ${statusClass}">
                            ${statusBadge}
                        </span>
                    </td>
                    <td class="py-3 px-4 text-sm text-gray-600">
                        ${createdDate}
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex gap-2">
                            <button onclick="viewCampaignDetails('${campaign.id}')" class="text-blue-600 hover:text-blue-800" title="Detaylarƒ± G√∂r">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="deleteCampaignReport('${campaign.id}')" class="text-red-600 hover:text-red-800" title="Sil">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        reportsTable.innerHTML = reportsHtml;
    }

    function updateCampaignReportsStats(campaigns) {
        // Kampanya raporlarƒ± istatistiklerini g√ºnceller
        console.log('üìà Kampanya raporlarƒ± istatistikleri g√ºncelleniyor...');
        
        if (!campaigns || campaigns.length === 0) {
            // ƒ∞statistikleri sƒ±fƒ±rla
            const statsElements = document.querySelectorAll('[data-stat]');
            statsElements.forEach(el => {
                el.textContent = '0';
            });
            return;
        }
        
        const totalCampaigns = campaigns.length;
        // Ger√ßek sayƒ±larƒ± kullan - dizilerin uzunluƒüu ger√ßek durumu g√∂sterir
        const totalSent = campaigns.reduce((sum, c) => sum + ((c.sentNumbers || []).length), 0);
        const totalErrors = campaigns.reduce((sum, c) => sum + ((c.errorNumbers || []).length), 0);
        const totalMessages = campaigns.reduce((sum, c) => sum + (c.totalCount || 0), 0);
        const overallSuccessRate = totalMessages > 0 ? Math.round((totalSent / totalMessages) * 100) : 0;
        
        // ƒ∞statistikleri g√ºncelle
        const totalCampaignsEl = document.querySelector('[data-stat="total-campaigns"]');
        const totalSentEl = document.querySelector('[data-stat="total-sent"]');
        const totalErrorsEl = document.querySelector('[data-stat="total-errors"]');
        const successRateEl = document.querySelector('[data-stat="success-rate"]');
        
        if (totalCampaignsEl) totalCampaignsEl.textContent = totalCampaigns;
        if (totalSentEl) totalSentEl.textContent = totalSent;
        if (totalErrorsEl) totalErrorsEl.textContent = totalErrors;
        if (successRateEl) successRateEl.textContent = `%${overallSuccessRate}`;
    }

    // Kampanya raporlarƒ±nƒ± filtrele
    window.filterCampaignReports = function() {
        console.log('üîç Kampanya raporlarƒ± filtreleniyor...');
        
        const statusFilter = document.getElementById('report-filter-status')?.value || 'all';
        const dateFilter = document.getElementById('report-filter-date')?.value || '';
        
        let filteredCampaigns = [...state.collections.campaigns];
        
        // Durum filtreleme
        if (statusFilter !== 'all') {
            filteredCampaigns = filteredCampaigns.filter(c => c.status === statusFilter);
        }
        
        // Tarih filtreleme
        if (dateFilter) {
            const filterDate = new Date(dateFilter);
            filteredCampaigns = filteredCampaigns.filter(c => {
                const campaignDate = c.createdAt?.toDate ? c.createdAt.toDate() : new Date(c.createdAt);
                return campaignDate.toDateString() === filterDate.toDateString();
            });
        }
        
        // Tabloyu ve istatistikleri g√ºncelle
        updateCampaignReportsTable(filteredCampaigns);
        updateCampaignReportsStats(filteredCampaigns);
        
        console.log(`‚úÖ ${filteredCampaigns.length} kampanya g√∂steriliyor`);
    };

    // Kampanya raporlarƒ±nƒ± Excel'e aktar
    window.exportCampaignReports = function() {
        console.log('üì• Kampanya raporlarƒ± Excel\'e aktarƒ±lƒ±yor...');
        
        const campaigns = state.collections.campaigns;
        
        if (!campaigns || campaigns.length === 0) {
            showToast('Dƒ±≈üa aktarƒ±lacak kampanya bulunamadƒ±', true);
            return;
        }
        
        // CSV formatƒ±nda veri olu≈ütur
        let csv = 'Kampanya Adƒ±,Durum,Toplam,G√∂nderilen,Hatalƒ±,Ba≈üarƒ± Oranƒ±,Olu≈üturulma Tarihi\n';
        
        campaigns.forEach(campaign => {
            const name = campaign.name || 'ƒ∞simsiz';
            const status = campaign.status || 'Bilinmiyor';
            const total = campaign.totalCount || 0;
            // Ger√ßek sayƒ±larƒ± kullan - dizilerin uzunluƒüu ger√ßek durumu g√∂sterir
            const sent = (campaign.sentNumbers || []).length;
            const errors = (campaign.errorNumbers || []).length;
            const successRate = total > 0 ? Math.round((sent / total) * 100) : 0;
            const date = campaign.createdAt?.toDate ? campaign.createdAt.toDate().toLocaleDateString('tr-TR') : 'Bilinmiyor';
            
            csv += `"${name}","${status}",${total},${sent},${errors},%${successRate},"${date}"\n`;
        });
        
        // CSV dosyasƒ±nƒ± indir
        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `kampanya_raporlari_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('üì• Raporlar Excel dosyasƒ±na aktarƒ±ldƒ±');
        console.log('‚úÖ Excel aktarƒ±mƒ± tamamlandƒ±');
    };

    // Kampanya detaylarƒ±nƒ± g√∂r√ºnt√ºle
    window.viewCampaignDetails = function(campaignId) {
        console.log('üëÅÔ∏è Kampanya detaylarƒ± g√∂r√ºnt√ºleniyor:', campaignId);
        
        const campaign = state.collections.campaigns.find(c => c.id === campaignId);
        if (!campaign) {
            showToast('Kampanya bulunamadƒ±', true);
            return;
        }
        
        // Kampanya detaylarƒ±nƒ± modal ile g√∂ster
        showCampaignDetailsModal(campaign);
    };

    // Kampanya raporunu sil
    window.deleteCampaignReport = function(campaignId) {
        console.log('üóëÔ∏è Kampanya raporu siliniyor:', campaignId);
        
        const campaign = state.collections.campaigns.find(c => c.id === campaignId);
        if (!campaign) {
            showToast('Kampanya bulunamadƒ±', true);
            return;
        }
        
        ModalManager.confirm(
            'Kampanyayƒ± Sil',
            `"${campaign.name}" kampanyasƒ±nƒ± silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.`,
            async () => {
                try {
                    await Firestore.delete('campaigns', campaignId);
                    showToast('‚úÖ Kampanya silindi');
                    console.log('‚úÖ Kampanya ba≈üarƒ±yla silindi');
                } catch (error) {
                    console.error('‚ùå Kampanya silinirken hata:', error);
                    showToast('Kampanya silinemedi', true);
                }
            }
        );
    };

    function renderDeviceCard(device) {
        const statusMap = { connected: 'device-connected', disconnected: 'device-disconnected', connecting: 'device-connecting' };
        const statusTextMap = { connected: 'Baƒülandƒ±', disconnected: 'Baƒülƒ± Deƒüil', connecting: 'Baƒülanƒ±yor' };
        const statusClass = statusMap[device.status] || 'device-disconnected';
        const statusText = statusTextMap[device.status] || 'Bilinmiyor';

        return `
            <div class="bg-white p-4 rounded-lg border border-gray-200 flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <i class="fas fa-mobile-alt text-2xl text-gray-500"></i>
                    <div>
                        <p class="font-semibold text-gray-800">${device.cihazAdi}</p>
                        <p class="text-sm text-gray-600">üì± ${device.phone || 'Numara Yok'}</p>
                        <p class="text-xs text-gray-500">üîë API: ${device.apiKey ? 'Mevcut' : 'Yok'}</p>
                        <p class="text-xs text-gray-500">üåê URL: ${device.apiUrl ? device.apiUrl : 'Yok'}</p>
                        <p class="text-xs text-gray-500">üè∑Ô∏è Instance: ${device.instanceName || 'Yok'}</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <span class="device-status ${statusClass}">${statusText}</span>
                    <div class="flex gap-2">
                        <button data-id="${device.id}" class="edit-device-btn bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded-md">D√ºzenle</button>
                        ${device.status !== 'connected' ? `<button data-id="${device.id}" class="connect-device-btn bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-3 rounded-md">Baƒülan</button>` : ''}
                        ${device.status === 'connected' ? `<button data-id="${device.id}" class="disconnect-device-btn bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-md">Baƒülantƒ±yƒ± Kes</button>` : ''}
                        <button data-id="${device.id}" class="delete-device-btn text-gray-500 hover:text-red-600"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            </div>`;
    }
    // --- Balance Page (Message Credits) ---
    function renderBalance() {
        const iban = state.systemSettings?.iban || 'TR33 0001 0000 0000 0000 0000 01';
        const bankName = state.systemSettings?.bankName || 'Ziraat Bankasƒ±';
        const accountHolder = state.systemSettings?.accountHolder || 'WaoTR';
        const packages = state.systemSettings?.packages || [
            { id: 1, name: 'Ba≈ülangƒ±√ß Paketi', credits: 100, price: 50, popular: false },
            { id: 2, name: 'Standart Paket', credits: 500, price: 200, popular: true },
            { id: 3, name: 'Premium Paket', credits: 1000, price: 350, popular: false },
            { id: 4, name: 'Enterprise Paket', credits: 5000, price: 1500, popular: false }
        ];

        const content = `
            <div class="max-w-6xl mx-auto space-y-6">
                <!-- Credits Card -->
                <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg shadow-xl p-8 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-sm mb-2">Mevcut Mesaj Hakkƒ±</p>
                            <p class="text-5xl font-bold"><i class="fas fa-envelope mr-3"></i>${state.messageCredits.toLocaleString('tr-TR')}</p>
                            <p class="text-green-100 text-sm mt-2">mesaj g√∂nderebilirsiniz</p>
                        </div>
                        <div class="bg-white bg-opacity-20 p-4 rounded-full">
                            <i class="fas fa-paper-plane text-4xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Message Packages -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-box text-blue-500 mr-3"></i> Mesaj Paketleri
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        ${packages.map(pkg => `
                            <div class="border-2 ${pkg.popular ? 'border-blue-500 bg-blue-50' : 'border-gray-200'} rounded-lg p-6 relative hover:shadow-lg transition-shadow">
                                ${pkg.popular ? '<div class="absolute top-0 right-0 bg-blue-500 text-white text-xs px-3 py-1 rounded-bl-lg rounded-tr-lg">Pop√ºler</div>' : ''}
                                <h4 class="text-lg font-bold text-gray-800 mb-2">${pkg.name}</h4>
                                <div class="my-4">
                                    <p class="text-4xl font-bold text-blue-600">${pkg.credits.toLocaleString('tr-TR')}</p>
                                    <p class="text-sm text-gray-600">mesaj hakkƒ±</p>
                                </div>
                                <div class="mb-4">
                                    <p class="text-3xl font-bold text-gray-800">‚Ç∫${pkg.price.toLocaleString('tr-TR')} ${pkg.includeVAT ? '<span class="text-sm text-gray-500 font-normal">+KDV</span>' : ''}</p>
                                    <p class="text-xs text-gray-500">~‚Ç∫${(pkg.price / pkg.credits).toFixed(2)}/mesaj</p>
                                </div>
                                <button onclick="selectPackage(${pkg.id})" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                                    Satƒ±n Al
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Payment Info -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-credit-card text-green-500 mr-3"></i> √ñdeme Bilgileri
                    </h3>
                    
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                        <p class="text-blue-700 font-medium mb-2">üí≥ Banka Havalesi ile √ñdeme</p>
                        <p class="text-blue-600 text-sm">Paket se√ßtikten sonra a≈üaƒüƒ±daki IBAN'a √∂deme yapƒ±n ve talep olu≈üturun.</p>
                    </div>

                    <div class="space-y-4">
                        <div class="border border-gray-200 rounded-lg p-4">
                            <p class="text-sm text-gray-500 mb-1">Banka Adƒ±</p>
                            <p class="font-semibold text-gray-800">${bankName}</p>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-4">
                            <p class="text-sm text-gray-500 mb-2">Hesap Sahibi</p>
                            <div class="flex items-center justify-between">
                                <p class="font-semibold text-gray-800">${accountHolder}</p>
                                <button onclick="copyAccountHolder()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded text-sm">
                                    <i class="fas fa-copy mr-1"></i> Kopyala
                                </button>
                            </div>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-4">
                            <p class="text-sm text-gray-500 mb-2">IBAN Numarasƒ±</p>
                            <div class="flex items-center justify-between">
                                <p class="font-mono font-bold text-gray-800 text-lg">${iban.replace(/\s/g, '')}</p>
                                <button onclick="copyIBAN()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded text-sm">
                                    <i class="fas fa-copy mr-1"></i> Kopyala
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mt-6">
                        <p class="text-yellow-700 font-medium mb-2">‚ö†Ô∏è √ñnemli Bilgilendirme</p>
                        <ul class="text-yellow-600 text-sm space-y-1 list-disc list-inside">
                            <li>Havale a√ßƒ±klamasƒ±na <strong>mail adresinizi</strong> yazƒ±nƒ±z: <code class="bg-yellow-100 px-2 py-1 rounded">${state.auth.currentUser?.email || 'mail@example.com'}</code></li>
                            <li>√ñdeme onaylarƒ± 1-2 saat i√ßinde hesabƒ±nƒ±za yansƒ±yacaktƒ±r</li>
                            <li>Sorun ya≈üarsanƒ±z destek@owatech.com adresine mail atabilirsiniz</li>
                        </ul>
                    </div>
                </div>

                <!-- Transaction History -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-history text-gray-500 mr-3"></i> ƒ∞≈ülem Ge√ßmi≈üi
                    </h3>
                    <div id="transaction-history">
                        <p class="text-gray-500 text-center py-8">Y√ºkleniyor...</p>
                    </div>
                </div>
            </div>
        `;
        
        appContent.innerHTML = `
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Mesaj Hakkƒ± Y√∂netimi</h2>
            ${content}
        `;
        
        // Load transaction history
        loadTransactionHistory();
    }
    async function loadTransactionHistory() {
        try {
            const transactionsSnapshot = await getDocs(
                query(
                    collection(state.db, "credit_transactions"),
                    orderBy("createdAt", "desc")
                )
            );
            
            const transactions = [];
            transactionsSnapshot.forEach(doc => {
                const data = doc.data();
                if (data.userId === state.userId) {
                    transactions.push({ id: doc.id, ...data });
                }
            });
            
            const container = document.getElementById('transaction-history');
            if (!container) return;
            
            if (transactions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Hen√ºz i≈ülem ge√ßmi≈üiniz bulunmamaktadƒ±r.</p>';
                return;
            }
            
            // Group transactions by campaign
            const campaignGroups = {};
            transactions.forEach(t => {
                if (t.campaignId) {
                    if (!campaignGroups[t.campaignId]) {
                        campaignGroups[t.campaignId] = {
                            campaignId: t.campaignId,
                            transactions: [],
                            totalCredits: 0
                        };
                    }
                    campaignGroups[t.campaignId].transactions.push(t);
                    campaignGroups[t.campaignId].totalCredits += Math.abs(t.credits || 0);
                }
            });
            
            const otherTransactions = transactions.filter(t => !t.campaignId);
            
            container.innerHTML = `
                <div class="space-y-4">
                    ${Object.values(campaignGroups).map(group => {
                        const campaign = state.collections.campaigns.find(c => c.id === group.campaignId);
                        const campaignName = campaign ? campaign.name : 'Silinmi≈ü Kampanya';
                        
                        return `
                            <div class="border border-gray-200 rounded-lg overflow-hidden">
                                <div class="bg-blue-50 p-4 flex items-center justify-between cursor-pointer hover:bg-blue-100" onclick="toggleCampaignTransactions('${group.campaignId}')">
                                    <div class="flex items-center gap-3">
                                        <i class="fas fa-paper-plane text-blue-600"></i>
                                        <div>
                                            <p class="font-semibold text-gray-800">${campaignName}</p>
                                            <p class="text-sm text-gray-600">${group.transactions.length} mesaj g√∂nderildi</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold text-red-600">-${group.totalCredits.toLocaleString('tr-TR')} mesaj</p>
                                        ${campaign ? `<button onclick="event.stopPropagation(); showLiveMonitorModal(state.collections.campaigns.find(c => c.id === '${group.campaignId}'))" class="text-xs text-blue-600 hover:underline mt-1">ƒ∞statistikleri G√∂r</button>` : ''}
                                    </div>
                                </div>
                                <div id="campaign-trans-${group.campaignId}" class="hidden bg-white">
                                    <table class="w-full text-sm">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="text-left py-2 px-4">Tarih</th>
                                                <th class="text-left py-2 px-4">Numara</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${group.transactions.slice(0, 10).map(t => `
                                                <tr class="border-b hover:bg-gray-50">
                                                    <td class="py-2 px-4 text-xs">${t.createdAt ? new Date(t.createdAt.toDate()).toLocaleTimeString('tr-TR', {
                                                        hour: '2-digit',
                                                        minute: '2-digit',
                                                        second: '2-digit'
                                                    }) : 'N/A'}</td>
                                                    <td class="py-2 px-4 text-xs text-gray-600">${t.note ? t.note.split(' - ')[1] || t.note : '-'}</td>
                                                </tr>
                                            `).join('')}
                                            ${group.transactions.length > 10 ? `<tr><td colspan="2" class="py-2 px-4 text-center text-xs text-gray-500">... ve ${group.transactions.length - 10} mesaj daha</td></tr>` : ''}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `;
                    }).join('')}
                    
                    ${otherTransactions.length > 0 ? `
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            <div class="bg-gray-50 p-4">
                                <p class="font-semibold text-gray-800"><i class="fas fa-list mr-2"></i>Diƒüer ƒ∞≈ülemler</p>
                            </div>
                            <div class="bg-white">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="text-left py-3 px-4">Tarih</th>
                                            <th class="text-left py-3 px-4">ƒ∞≈ülem Tipi</th>
                                            <th class="text-left py-3 px-4">Miktar</th>
                                            <th class="text-left py-3 px-4">A√ßƒ±klama</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${otherTransactions.map(t => {
                                            const isCredit = t.type === 'package_purchase' || t.type === 'admin_add';
                                            const icon = isCredit ? '‚ûï' : '‚ûñ';
                                            const colorClass = isCredit ? 'text-green-600' : 'text-red-600';
                                            const typeText = t.type === 'package_purchase' ? 'Paket Satƒ±n Alma' :
                                                           t.type === 'admin_add' ? 'Admin Tarafƒ±ndan Eklendi' :
                                                           t.type === 'message_sent' ? 'Mesaj G√∂nderimi' : 'Diƒüer';
                                            
                                            return `
                                                <tr class="border-b hover:bg-gray-50">
                                                    <td class="py-3 px-4">${t.createdAt ? new Date(t.createdAt.toDate()).toLocaleString('tr-TR', {
                                                        day: '2-digit',
                                                        month: '2-digit',
                                                        year: 'numeric',
                                                        hour: '2-digit',
                                                        minute: '2-digit',
                                                        second: '2-digit'
                                                    }) : 'N/A'}</td>
                                                    <td class="py-3 px-4">${typeText}</td>
                                                    <td class="py-3 px-4 font-semibold ${colorClass}">${icon} ${Math.abs(t.credits || 0).toLocaleString('tr-TR')} mesaj</td>
                                                    <td class="py-3 px-4 text-gray-600">${t.note || '-'}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Add toggle function
            window.toggleCampaignTransactions = function(campaignId) {
                const element = document.getElementById(`campaign-trans-${campaignId}`);
                if (element) {
                    element.classList.toggle('hidden');
                }
            };
        } catch (error) {
            console.error("Load transaction history error:", error);
            const container = document.getElementById('transaction-history');
            if (container) {
                container.innerHTML = '<p class="text-red-500 text-center py-8">ƒ∞≈ülem ge√ßmi≈üi y√ºklenemedi.</p>';
            }
        }
    }
    // --- Modal Show Functions ---
     function showCampaignModal(campaign = null) {
        const isEdit = !!campaign;
        const groupsOptions = state.collections.groups.map(g => `<option value="${g.id}" ${isEdit && g.id === campaign.groupId ? 'selected' : ''}>${g.name}</option>`).join('');
        const accountsOptions = (state.collections.settings.devices || []).map(d => `<option value="${d.id}" ${isEdit && d.id === campaign.deviceId ? 'selected' : ''}>${d.cihazAdi} (${d.phone})</option>`).join('');
        const templatesOptions = state.collections.templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        const templateGroupsOptions = (state.collections.templateGroups || []).map(tg => {
            const count = (tg.templates && Array.isArray(tg.templates)) ? tg.templates.length : 0;
            return `<option value="${tg.id}">${tg.name} (${count} ≈üablon)</option>`;
        }).join('');
        
        ModalManager.show({
            title: isEdit ? 'Kampanyayƒ± D√ºzenle' : 'Yeni Kampanya Olu≈ütur',
            body: `<div class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700">Kampanya Adƒ±</label><input type="text" id="campaign-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${campaign?.name || ''}"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700">G√∂nderici Cihaz</label><select id="campaign-device" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">${accountsOptions}</select></div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Hedef Ki≈üi Grubu</label>
                        <select id="campaign-group" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            <option value="">-- Grup Se√ß --</option>
                            ${groupsOptions}
                        </select>
                        <span id="group-count" class="text-xs text-gray-500 mt-1 block"></span>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">≈ûablon Tipi</label>
                        <select id="template-type-select" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            <option value="single">Tek ≈ûablon</option>
                            <option value="group">≈ûablon Grubu (Random)</option>
                        </select>
                    </div>
                    <div id="single-template-container">
                        <label class="block text-sm font-medium text-gray-700">Mesaj ≈ûablonu</label>
                        <select id="campaign-template-select" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"><option value="">-- ≈ûablon Se√ß --</option>${templatesOptions}</select>
                    </div>
                    <div id="group-template-container" class="hidden">
                        <label class="block text-sm font-medium text-gray-700">≈ûablon Grubu</label>
                        <select id="campaign-template-group-select" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"><option value="">-- Grup Se√ß --</option>${templateGroupsOptions}</select>
                        <span id="template-group-count" class="text-xs text-gray-500 mt-1 block"></span>
                    </div>
                </div>
                <div><label class="block text-sm font-medium text-gray-700">Mesaj ƒ∞√ßeriƒüi</label><textarea id="campaign-message" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" rows="4" placeholder="Merhaba {Ad} {Soyad}, kampanyamƒ±z hakkƒ±nda...">${campaign?.message || ''}</textarea><p class="text-xs text-gray-500 mt-1">üìù Kullanƒ±labilir deƒüi≈ükenler: <code class="bg-gray-100 px-1 rounded">{Ad}</code> <code class="bg-gray-100 px-1 rounded">{Soyad}</code> <code class="bg-gray-100 px-1 rounded">{AdSoyad}</code> | ≈ûablon grubu se√ßildiƒüinde her alƒ±cƒ±ya random bir ≈üablon g√∂nderilir.</p></div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">G√∂rsel Ekle (Opsiyonel)</label>
                    <div class="mt-1">
                        <input type="file" id="campaign-image" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        <p class="text-xs text-gray-500 mt-1">Desteklenen formatlar: JPG, PNG, GIF (Max: 5MB)</p>
                    </div>
                    <div id="image-preview-container" class="mt-3">
                        ${campaign?.imageUrl ? `
                            <div class="relative inline-block">
                                <img src="${campaign.imageUrl}" class="max-h-32 rounded-md shadow-sm border border-gray-200">
                                <button type="button" id="remove-image-btn" class="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="border-t pt-4 space-y-3">
                    <label class="block text-sm font-medium text-gray-700">G√∂nderim Tipi</label>
                    <div class="flex space-x-4">
                        <div class="flex items-center"><input type="radio" id="send-now" name="sendType" value="now" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" ${(!isEdit || campaign?.sendType === 'now') ? 'checked' : ''}><label for="send-now" class="ml-2 block text-sm text-gray-900">Hemen G√∂nder</label></div>
                        <div class="flex items-center"><input type="radio" id="send-later" name="sendType" value="later" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" ${isEdit && campaign?.sendType === 'later' ? 'checked' : ''}><label for="send-later" class="ml-2 block text-sm text-gray-900">ƒ∞leri Tarihli G√∂nder</label></div>
                        <div class="flex items-center"><input type="radio" id="send-split" name="sendType" value="split" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" ${isEdit && campaign?.sendType === 'split' ? 'checked' : ''}><label for="send-split" class="ml-2 block text-sm text-gray-900">Par√ßalara B√∂lerek G√∂nder</label></div>
                    </div>
                    <div id="send-later-container" class="hidden"><input type="datetime-local" id="send-later-time" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></div>
                    <div id="send-split-container" class="hidden mt-4 space-y-3"></div>
                    <div id="split-summary" class="text-sm text-gray-600 mt-2"></div>
                </div>
            </div>`,
            footer: `<button id="modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">ƒ∞ptal</button><button id="modal-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">${isEdit ? 'G√ºncelle' : 'Olu≈ütur'}</button>`,
            onReady: () => {
                const groupSelect = document.getElementById('campaign-group');
                const groupCountSpan = document.getElementById('group-count');
                const splitContainer = document.getElementById('send-split-container');
                const laterContainer = document.getElementById('send-later-container');
                const splitSummary = document.getElementById('split-summary');
                let groupNumbersCount = 0;

                document.getElementById('campaign-image').onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        // Check file size (5MB limit)
                        if (file.size > 5 * 1024 * 1024) {
                            showToast("Dosya boyutu 5MB'dan b√ºy√ºk olamaz.", true);
                            e.target.value = '';
                            return;
                        }
                        
                        // Check file type
                        if (!file.type.startsWith('image/')) {
                            showToast("Sadece resim dosyalarƒ± y√ºklenebilir.", true);
                            e.target.value = '';
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            document.getElementById('image-preview-container').innerHTML = `
                                <div class="relative inline-block">
                                    <img src="${event.target.result}" class="max-h-32 rounded-md shadow-sm border border-gray-200">
                                    <button type="button" id="remove-image-btn" class="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            `;
                            
                            // Add remove button event listener
                            document.getElementById('remove-image-btn').onclick = () => {
                                document.getElementById('campaign-image').value = '';
                                document.getElementById('image-preview-container').innerHTML = '';
                            };
                        };
                        reader.readAsDataURL(file);
                    }
                };
                
                // Add remove button event listener for existing images
                const existingRemoveBtn = document.getElementById('remove-image-btn');
                if (existingRemoveBtn) {
                    existingRemoveBtn.onclick = () => {
                        document.getElementById('campaign-image').value = '';
                        document.getElementById('image-preview-container').innerHTML = '';
                    };
                }

                const updateSendTypeUI = () => {
                    const selectedType = document.querySelector('input[name="sendType"]:checked').value;
                    laterContainer.style.display = selectedType === 'later' ? 'block' : 'none';
                    splitContainer.style.display = selectedType === 'split' ? 'block' : 'none';
                    if (selectedType === 'split' && splitContainer.innerHTML.trim() === '') {
                        renderSplitter(campaign?.schedule);
                    }
                };
                
                const updateGroupCount = () => {
                    const selectedGroup = state.collections.groups.find(g => g.id === groupSelect.value);
                    groupNumbersCount = selectedGroup ? getGroupNumbers(selectedGroup).length : 0;
                    groupCountSpan.textContent = selectedGroup ? `${groupNumbersCount} ki≈üi` : '';
                    updateSplitSummary();
                };
                groupSelect.onchange = updateGroupCount;
                
                // Template type toggle
                const templateTypeSelect = document.getElementById('template-type-select');
                const singleTemplateContainer = document.getElementById('single-template-container');
                const groupTemplateContainer = document.getElementById('group-template-container');
                const templateGroupCountSpan = document.getElementById('template-group-count');
                
                templateTypeSelect.onchange = () => {
                    const isSingle = templateTypeSelect.value === 'single';
                    const messageTextarea = document.getElementById('campaign-message');
                    singleTemplateContainer.style.display = isSingle ? 'block' : 'none';
                    groupTemplateContainer.style.display = isSingle ? 'none' : 'block';
                    
                    // Enable textarea when single template mode
                    if (isSingle) {
                        messageTextarea.disabled = false;
                        messageTextarea.classList.remove('bg-gray-100', 'cursor-not-allowed');
                    }
                };

                document.getElementById('campaign-template-select').onchange = (e) => {
                    const selectedTemplate = state.collections.templates.find(t => t.id === e.target.value);
                    if(selectedTemplate) document.getElementById('campaign-message').value = selectedTemplate.content;
                };
                
                document.getElementById('campaign-template-group-select').onchange = (e) => {
                    const messageTextarea = document.getElementById('campaign-message');
                    const selectedGroup = state.collections.templateGroups.find(tg => tg.id === e.target.value);
                    if (selectedGroup) {
                        const count = (selectedGroup.templates && Array.isArray(selectedGroup.templates)) ? selectedGroup.templates.length : 0;
                        templateGroupCountSpan.textContent = `${count} farklƒ± ≈üablon (her alƒ±cƒ±ya random)`;
                        if (count > 0) {
                            // Show information message and disable editing
                            messageTextarea.value = `üìã "${selectedGroup.name}" grubu se√ßildi\n\n‚úÖ ${count} farklƒ± ≈üablon bu gruptan random g√∂nderilecek`;
                            messageTextarea.disabled = true;
                            messageTextarea.classList.add('bg-gray-100', 'cursor-not-allowed');
                        }
                    } else {
                        templateGroupCountSpan.textContent = '';
                        messageTextarea.value = '';
                        messageTextarea.disabled = false;
                        messageTextarea.classList.remove('bg-gray-100', 'cursor-not-allowed');
                    }
                };
                const renderSplitter = (schedule = []) => {
                    splitContainer.innerHTML = `<div id="split-rows"></div><button id="add-split-row" type="button" class="text-sm text-blue-600 hover:text-blue-800">+ Par√ßa Ekle</button>`;
                    const rowsContainer = document.getElementById('split-rows');
                    (schedule.length > 0 ? schedule : [{ count: 0, sendTime: null }]).forEach(item => {
                         const time = item.sendTime ? new Date(item.sendTime.toDate().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16) : '';
                         rowsContainer.insertAdjacentHTML('beforeend', createSplitRow(item.count, time));
                    });
                    document.getElementById('add-split-row').onclick = () => {
                         if (calculateTotalSplitCount() < groupNumbersCount) {
                            rowsContainer.insertAdjacentHTML('beforeend', createSplitRow());
                         } else {
                            showToast("Grup kapasitesine ula≈üƒ±ldƒ±, yeni par√ßa eklenemez.", true);
                         }
                    };
                    splitContainer.addEventListener('input', updateSplitSummary);
                };
                
                const createSplitRow = (count = 0, time = '') => `
                    <div class="split-row flex items-center gap-2">
                        <input type="datetime-local" class="split-time border border-gray-300 rounded-md p-1.5 w-1/2" value="${time}">
                        <input type="number" placeholder="Ki≈üi Sayƒ±sƒ±" class="split-count border border-gray-300 rounded-md p-1.5 w-1/2" value="${count}">
                        <button type="button" class="remove-split-row text-red-500 p-1"><i class="fas fa-times"></i></button>
                    </div>`;
                
                splitContainer.addEventListener('click', e => {
                    if(e.target.closest('.remove-split-row')) {
                        e.target.closest('.split-row').remove();
                        updateSplitSummary();
                    }
                });

                const calculateTotalSplitCount = () => Array.from(splitContainer.querySelectorAll('.split-count')).reduce((sum, el) => sum + (parseInt(el.value) || 0), 0);
                
                const updateSplitSummary = () => {
                    const total = calculateTotalSplitCount();
                    splitSummary.textContent = `Planlanan: ${total} / ${groupNumbersCount} ki≈üi`;
                    splitSummary.style.color = total > groupNumbersCount ? 'red' : 'inherit';
                    // √áakƒ±≈üma kontrol√º ve tahmini s√ºre
                    const deviceId = document.getElementById('campaign-device').value;
                    const scheduleRows = Array.from(splitContainer.querySelectorAll('.split-row'));
                    const plannedTimes = scheduleRows
                        .map(r => new Date(r.querySelector('.split-time').value))
                        .filter(d => !isNaN(d));

                    const conflicts = state.collections.campaigns.filter(c => c.deviceId === deviceId && (c.status === 'planlandƒ±' || c.status === 'g√∂nderiliyor'));
                    let hasConflict = false;
                    plannedTimes.forEach(t => {
                        conflicts.forEach(c => {
                            const s = c.schedule?.[0]?.sendTime?.toDate?.() || c.schedule?.[0]?.sendTime;
                            if (s && Math.abs(new Date(s) - t) < 5 * 60 * 1000) { // 5 dk penceresi
                                hasConflict = true;
                            }
                        });
                    });
                    if (hasConflict) {
                        splitSummary.innerHTML += ` <span class="text-red-600">(Uyarƒ±: Se√ßilen cihazda aynƒ± saate yakƒ±n ba≈üka g√∂nderimler var!)</span>`;
                    }
                };
                
                if(isEdit) {
                    updateGroupCount();
                    if (campaign.sendType === 'later' && campaign.schedule?.[0]?.sendTime) {
                        const d = campaign.schedule[0].sendTime.toDate();
                        document.getElementById('send-later-time').value = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0,16);
                    }
                }
                updateSendTypeUI();
                document.querySelectorAll('input[name="sendType"]').forEach(radio => radio.onchange = updateSendTypeUI);
                
                 document.getElementById('modal-save-btn').onclick = async (e) => {
                    const saveBtn = e.currentTarget;
                    saveBtn.disabled = true; saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';
                    
                    try {
                        let imageUrl = campaign?.imageUrl || '';
                        const imageFile = document.getElementById('campaign-image').files[0];
                        if (imageFile) {
                            // Convert to base64 instead of uploading to Firebase Storage
                            const reader = new FileReader();
                            reader.onload = async (event) => {
                                imageUrl = event.target.result; // Base64 data URL
                            };
                            reader.readAsDataURL(imageFile);
                            
                            // Wait for the reader to finish
                            await new Promise(resolve => {
                                const reader = new FileReader();
                                reader.onload = (event) => {
                                    imageUrl = event.target.result;
                                    resolve();
                                };
                                reader.readAsDataURL(imageFile);
                            });
                        }

                        const sendType = document.querySelector('input[name="sendType"]:checked').value;
                        const schedule = [];
                        let validationError = null;
                        const selectedGroup = state.collections.groups.find(g => g.id === groupSelect.value);
                        const groupSize = selectedGroup ? getGroupNumbers(selectedGroup).length : 0;

                        if(sendType === 'later'){
                            const laterTime = document.getElementById('send-later-time').value;
                            if(!laterTime) validationError = "L√ºtfen ileri tarihli g√∂nderim i√ßin bir zaman se√ßin.";
                            else schedule.push({ count: groupSize, sendTime: Timestamp.fromDate(new Date(laterTime)) });
                        } else if (sendType === 'now'){
                             schedule.push({ count: groupSize, sendTime: Timestamp.now() });
                        } else if (sendType === 'split'){
                            const totalSplit = calculateTotalSplitCount();
                            if(totalSplit > groupSize) validationError = "Planlanan ki≈üi sayƒ±sƒ± grup mevcudunu a≈üƒ±yor.";
                            if(totalSplit < groupSize) validationError = "L√ºtfen gruptaki t√ºm ki≈üileri planlayƒ±n.";
                            
                            document.querySelectorAll('.split-row').forEach(row => {
                                const time = row.querySelector('.split-time').value;
                                const count = parseInt(row.querySelector('.split-count').value);
                                if(!time || !count || count <= 0) validationError = "L√ºtfen t√ºm par√ßalar i√ßin zaman ve ge√ßerli ki≈üi sayƒ±sƒ± girin.";
                                schedule.push({ count: count, sendTime: Timestamp.fromDate(new Date(time)) });
                            });
                            if (schedule.length === 0) validationError = "L√ºtfen en az bir g√∂nderim par√ßasƒ± ekleyin.";
                        }

                        const templateType = document.getElementById('template-type-select').value;
                        
                        // ≈ûablon grubu se√ßiliyse mesajƒ± bo≈ü bƒ±rak (≈üablondan gelecek)
                        let messageContent = document.getElementById('campaign-message').value.trim();
                        if (templateType === 'group') {
                            messageContent = ''; // ≈ûablon grubundan random se√ßilecek
                        }
                        
                        const data = {
                            name: document.getElementById('campaign-name').value.trim(),
                            deviceId: document.getElementById('campaign-device').value,
                            groupId: document.getElementById('campaign-group').value,
                            hedefGrup: selectedGroup ? { name: selectedGroup.name, id: selectedGroup.id } : null,
                            totalCount: groupSize,
                            message: messageContent,
                            sendType: sendType,
                            schedule: schedule.sort((a,b) => a.sendTime - b.sendTime), 
                            status: 'planlandƒ±',
                            // ƒ∞statistikler - hem diziler hem de count alanlarƒ±
                            sentNumbers: campaign?.sentNumbers || [],
                            errorNumbers: campaign?.errorNumbers || [],
                            sentCount: campaign?.sentNumbers?.length || 0,
                            errorCount: campaign?.errorNumbers?.length || 0,
                            sentTimestamps: campaign?.sentTimestamps || {},
                            errorReasons: campaign?.errorReasons || {},
                            skippedNumbers: campaign?.skippedNumbers || [],
                            skippedReasons: campaign?.skippedReasons || {},
                            currentScheduleIndex: campaign?.currentScheduleIndex || 0,
                            imageUrl: imageUrl,
                            templateType: templateType,
                            templateId: templateType === 'single' ? document.getElementById('campaign-template-select').value : null,
                            templateGroupId: templateType === 'group' ? document.getElementById('campaign-template-group-select').value : null
                        };

                        // Validation: Tek ≈üablon modunda mesaj zorunlu, grup modunda template group ID zorunlu
                        if(!data.name || !data.deviceId || !data.groupId) validationError = "L√ºtfen t√ºm zorunlu alanlarƒ± doldurun.";
                        if(templateType === 'single' && !data.message) validationError = "L√ºtfen mesaj i√ßeriƒüi girin.";
                        if(templateType === 'group' && !data.templateGroupId) validationError = "L√ºtfen bir ≈üablon grubu se√ßin.";
                        if(validationError) throw new Error(validationError);

                        // Show confirmation before saving
                        const device = (state.collections.settings.devices || []).find(d => d.id === data.deviceId);
                        const group = state.collections.groups.find(g => g.id === data.groupId);
                        const groupNums = getGroupNumbers(group);
                        const numbersPreview = groupNums.slice(0, 10).join(', ') + (groupNums.length > 10 ? `... (+${groupNums.length - 10} daha)` : '');
                        
                        saveBtn.disabled = false;
                        saveBtn.textContent = isEdit ? 'G√ºncelle' : 'Olu≈ütur';
                        
                        const confirmed = await new Promise((resolve) => {
                            ModalManager.show({
                                title: 'Kampanya Onayƒ±',
                                body: `<div class="space-y-3">
                                    <p><strong>Kampanya:</strong> ${data.name}</p>
                                    <p><strong>Cihaz:</strong> ${device.cihazAdi} (${device.phone})</p>
                                    <p><strong>Grup:</strong> ${group.name}</p>
                                    <p><strong>Toplam Ki≈üi:</strong> ${groupNums.length}</p>
                                    <p><strong>G√∂nderim Tipi:</strong> ${sendType === 'now' ? 'Hemen G√∂nder' : sendType === 'later' ? 'ƒ∞leri Tarihli' : 'Par√ßalƒ± G√∂nderim'}</p>
                                    <p class="text-blue-600 text-sm mt-4">Kampanyayƒ± olu≈üturmak istiyor musunuz?</p>
                                </div>`,
                                footer: `
                                    <button id="confirm-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">ƒ∞ptal</button>
                                    <button id="confirm-ok-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Onayla</button>
                                `,
                                onReady: () => {
                                    document.getElementById('confirm-cancel-btn').onclick = () => {
                                        ModalManager.hide();
                                        resolve(false);
                                    };
                                    document.getElementById('confirm-ok-btn').onclick = () => {
                                        ModalManager.hide();
                                        resolve(true);
                                    };
                                }
                            });
                        });
                        
                        if (!confirmed) {
                            return;
                        }
                        
                        saveBtn.disabled = true;
                        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Kaydediliyor...';

                        const success = isEdit ? await Firestore.update('campaigns', campaign.id, data, true) : await Firestore.add('campaigns', data);
                        if (success) {
                            showToast(`${data.name} kampanyasƒ± ${isEdit ? 'ba≈üarƒ±yla g√ºncellendi' : 'ba≈üarƒ±yla olu≈üturuldu'}! Cloud Functions otomatik i≈üleyecek.`);
                            ModalManager.hide();
                            
                            // Not: Cloud Functions otomatik olarak i≈üleyecek
                            console.log('‚òÅÔ∏è Kampanya kaydedildi. Cloud Functions otomatik olarak i≈üleyecek.');
                        } else {
                            throw new Error("Firestore kaydetme i≈ülemi ba≈üarƒ±sƒ±z oldu.");
                        }

                    } catch (error) {
                         console.error("Save campaign error:", error);
                         showToast(`Kaydetme hatasƒ±: ${error.message}`, true);
                    } finally {
                        saveBtn.disabled = false; saveBtn.textContent = isEdit ? 'G√ºncelle' : 'Olu≈ütur';
                    }
                };
                document.getElementById('modal-cancel-btn').onclick = ModalManager.hide;
            }
        });
    }
    function showLiveMonitorModal(campaign) {
        // Real-time listener for campaign updates
        let liveListener = null;
        
        const updateModalContent = (updatedCampaign) => {
            const group = state.collections.groups.find(g => g.id === updatedCampaign.groupId);
            const totalNumbers = getGroupNumbers(group).length;
            // Ger√ßek sayƒ±larƒ± kullan - dizilerin uzunluƒüu ger√ßek durumu g√∂sterir
            const sentNumbers = updatedCampaign.sentNumbers || [];
            const errorNumbers = updatedCampaign.errorNumbers || [];
            const sentCount = sentNumbers.length;
            const errorCount = errorNumbers.length;
            const processingCount = totalNumbers - sentCount - errorCount;
            
            const errorReasons = updatedCampaign.errorReasons || {};
            const sentTimestamps = updatedCampaign.sentTimestamps || {};
            
            // Update stats
            const sentStat = document.getElementById('live-sent-count');
            const errorStat = document.getElementById('live-error-count');
            const processingStat = document.getElementById('live-processing-count');
            const progressBar = document.getElementById('live-progress-bar');
            const progressText = document.getElementById('live-progress-text');
            
            if (sentStat) sentStat.textContent = sentCount;
            if (errorStat) errorStat.textContent = errorCount;
            if (processingStat) processingStat.textContent = processingCount > 0 ? processingCount : 0;
            if (progressBar) {
                const progress = totalNumbers > 0 ? ((sentCount + errorCount) / totalNumbers) * 100 : 0;
                progressBar.style.width = `${progress}%`;
            }
            if (progressText) {
                const progress = totalNumbers > 0 ? Math.round(((sentCount + errorCount) / totalNumbers) * 100) : 0;
                progressText.textContent = `${progress}% Tamamlandƒ±`;
            }
            
            // Update tab counts
            const sentTab = document.getElementById('monitor-tab-sent');
            const errorTab = document.getElementById('monitor-tab-error');
            const processingTab = document.getElementById('monitor-tab-pending');
            
            if (sentTab) sentTab.innerHTML = `G√∂nderildi (${sentCount})`;
            if (errorTab) errorTab.innerHTML = `Ba≈üarƒ±sƒ±z (${errorCount})`;
            if (processingTab) processingTab.innerHTML = `G√∂nderiliyor (${processingCount > 0 ? processingCount : 0})`;
            
            // Store for tab switching
            window.currentLiveData = {
                sentNumbers,
                errorNumbers,
                errorReasons,
                sentTimestamps,
                pendingNumbers: group?.numbers.filter(num => !sentNumbers.includes(num) && !errorNumbers.includes(num)) || []
            };
        };
        const group = state.collections.groups.find(g => g.id === campaign.groupId);
        const totalNumbers = getGroupNumbers(group).length;
        // Ger√ßek sayƒ±larƒ± kullan - dizilerin uzunluƒüu ger√ßek durumu g√∂sterir
        const sentNumbers = campaign.sentNumbers || [];
        const errorNumbers = campaign.errorNumbers || [];
        const sentCount = sentNumbers.length;
        const errorCount = errorNumbers.length;
        const processingCount = totalNumbers - sentCount - errorCount;
        
        const errorReasons = campaign.errorReasons || {};
        const sentTimestamps = campaign.sentTimestamps || {};
        const pendingNumbers = group?.numbers.filter(num => !sentNumbers.includes(num) && !errorNumbers.includes(num)) || [];
        
        window.currentLiveData = { sentNumbers, errorNumbers, errorReasons, sentTimestamps, pendingNumbers };
        
        const modalTitle = campaign.status === 'Tamamlandƒ±' ? `üìä Kampanya ƒ∞statistikleri: ${campaign.name}` : `üìä Anlƒ±k ƒ∞zleme: ${campaign.name}`;
        
        ModalManager.show({
            title: modalTitle,
            body: `
                <div class="space-y-4">
                    <!-- Stats -->
                    <div class="grid grid-cols-3 gap-3">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                            <p id="live-sent-count" class="text-2xl font-bold text-green-600">${sentCount}</p>
                            <p class="text-xs text-green-700">‚úÖ G√∂nderildi</p>
                        </div>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-center">
                            <p id="live-error-count" class="text-2xl font-bold text-red-600">${errorCount}</p>
                            <p class="text-xs text-red-700">‚ùå Ba≈üarƒ±sƒ±z</p>
                        </div>
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 text-center">
                            <p id="live-processing-count" class="text-2xl font-bold text-orange-600">${processingCount > 0 ? processingCount : 0}</p>
                            <p class="text-xs text-orange-700">üì§ G√∂nderiliyor</p>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="bg-gray-200 rounded-full h-4 overflow-hidden">
                        <div id="live-progress-bar" class="bg-gradient-to-r from-green-500 to-green-600 h-full transition-all duration-500" style="width: ${totalNumbers > 0 ? ((sentCount + errorCount) / totalNumbers) * 100 : 0}%"></div>
                    </div>
                    <p id="live-progress-text" class="text-center text-sm text-gray-600">${totalNumbers > 0 ? Math.round(((sentCount + errorCount) / totalNumbers) * 100) : 0}% Tamamlandƒ±</p>
                    
                    ${campaign.status === 'Tamamlandƒ±' ? `
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                            <p class="text-blue-700 font-medium mb-2">‚úÖ Kampanya Tamamlandƒ±</p>
                            <div class="text-blue-600 text-sm space-y-1">
                                <p><strong>Toplam Mesaj:</strong> ${totalNumbers}</p>
                                <p><strong>Ba≈üarƒ±lƒ±:</strong> ${sentCount} (${totalNumbers > 0 ? Math.round((sentCount / totalNumbers) * 100) : 0}%)</p>
                                <p><strong>Ba≈üarƒ±sƒ±z:</strong> ${errorCount} (${totalNumbers > 0 ? Math.round((errorCount / totalNumbers) * 100) : 0}%)</p>
                                <p><strong>Ba≈üarƒ± Oranƒ±:</strong> ${totalNumbers > 0 ? Math.round((sentCount / totalNumbers) * 100) : 0}%</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Tabs -->
                    <div class="border-b border-gray-200">
                        <nav class="flex space-x-4">
                            <button onclick="switchMonitorTab('sent')" id="monitor-tab-sent" class="monitor-tab active py-2 px-4 text-sm font-medium border-b-2 border-green-500 text-green-600">
                                G√∂nderildi (${sentCount})
                            </button>
                            <button onclick="switchMonitorTab('error')" id="monitor-tab-error" class="monitor-tab py-2 px-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                                Ba≈üarƒ±sƒ±z (${errorCount})
                            </button>
                            ${campaign.status !== 'Tamamlandƒ±' ? `
                                <button onclick="switchMonitorTab('pending')" id="monitor-tab-pending" class="monitor-tab py-2 px-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                                    G√∂nderiliyor (${processingCount > 0 ? processingCount : 0})
                                </button>
                            ` : ''}
                        </nav>
                    </div>
                    <!-- Content -->
                    <div id="monitor-content" class="max-h-64 overflow-y-auto">
                        ${sentNumbers.length > 0 ? sentNumbers.map((num, idx) => {
                            const timestamp = sentTimestamps[num];
                            const timeStr = timestamp ? new Date(timestamp).toLocaleTimeString('tr-TR', {
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            }) : '';
                            return `
                            <div class="py-2 px-3 hover:bg-gray-50 border-b border-gray-100">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">${idx + 1}. ${num}</span>
                                    <span class="text-xs text-green-600">‚úÖ G√∂nderildi</span>
                                </div>
                                ${timeStr ? `<div class="text-xs text-gray-500 mt-1 pl-4">üïê ${timeStr}</div>` : ''}
                            </div>
                        `}).join('') : '<p class="text-gray-500 text-center py-4">Hen√ºz g√∂nderilmi≈ü mesaj yok.</p>'}
                    </div>
                </div>
            `,
            footer: `<button id="modal-close" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Kapat</button>`,
            onReady: () => {
                // Setup real-time listener only if campaign is still sending
                if (campaign.status === 'g√∂nderiliyor') {
                    const campaignDocRef = doc(state.db, `users/${state.userId}/campaigns`, campaign.id);
                    liveListener = onSnapshot(campaignDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            updateModalContent({ id: docSnap.id, ...docSnap.data() });
                        }
                    });
                }
                
                document.getElementById('modal-close').onclick = () => {
                    if (liveListener) liveListener();
                    ModalManager.hide();
                };
                
                window.switchMonitorTab = (tab) => {
                    // Update tab styles
                    document.querySelectorAll('.monitor-tab').forEach(t => {
                        t.classList.remove('active', 'border-green-500', 'text-green-600', 'border-red-500', 'text-red-600', 'border-blue-500', 'text-blue-600');
                        t.classList.add('border-transparent', 'text-gray-500');
                    });
                    
                    const activeTab = document.getElementById(`monitor-tab-${tab}`);
                    if (tab === 'sent') {
                        activeTab.classList.add('active', 'border-green-500', 'text-green-600');
                    } else if (tab === 'error') {
                        activeTab.classList.add('active', 'border-red-500', 'text-red-600');
                    } else {
                        activeTab.classList.add('active', 'border-orange-500', 'text-orange-600');
                    }
                    activeTab.classList.remove('border-transparent', 'text-gray-500');
                    
                    // Update content
                    const content = document.getElementById('monitor-content');
                    const { sentNumbers, errorNumbers, errorReasons, sentTimestamps, pendingNumbers } = window.currentLiveData || { sentNumbers: [], errorNumbers: [], errorReasons: {}, sentTimestamps: {}, pendingNumbers: [] };
                    
                    if (tab === 'sent') {
                        content.innerHTML = sentNumbers.length > 0 ? sentNumbers.map((num, idx) => {
                            const timestamp = sentTimestamps[num];
                            const timeStr = timestamp ? new Date(timestamp).toLocaleTimeString('tr-TR', {
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            }) : '';
                            return `
                            <div class="py-2 px-3 hover:bg-gray-50 border-b border-gray-100">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">${idx + 1}. ${num}</span>
                                    <span class="text-xs text-green-600">‚úÖ G√∂nderildi</span>
                                </div>
                                ${timeStr ? `<div class="text-xs text-gray-500 mt-1 pl-4">üïê ${timeStr}</div>` : ''}
                            </div>
                        `}).join('') : '<p class="text-gray-500 text-center py-4">Hen√ºz g√∂nderilmi≈ü mesaj yok.</p>';
                    } else if (tab === 'error') {
                        // Gruplandƒ±rƒ±lmƒ±≈ü, anla≈üƒ±lƒ±r hata listesi hazƒ±rla
                        const groupedByReason = {};
                        errorNumbers.forEach(number => {
                            const originalReason = errorReasons[number] || 'Bilinmeyen hata';
                            const friendly = getErrorMessage(originalReason);
                            if (!groupedByReason[friendly]) groupedByReason[friendly] = [];
                            groupedByReason[friendly].push(number);
                        });

                        const reasonBadges = Object.entries(groupedByReason).map(([reason, nums]) => `
                            <span class="inline-flex items-center bg-red-50 border border-red-200 text-red-700 text-xs px-2 py-1 rounded mr-2 mb-2">
                                ${reason}
                                <span class="ml-2 bg-red-600 text-white rounded-full px-2">${nums.length}</span>
                            </span>
                        `).join('');

                        const groupsHtml = Object.entries(groupedByReason).map(([reason, nums]) => `
                            <details class="bg-white border border-red-100 rounded-lg p-3" ${Object.keys(groupedByReason).length === 1 ? 'open' : ''}>
                                <summary class="cursor-pointer font-medium text-red-700 flex items-center justify-between">
                                    <span>${reason}</span>
                                    <span class="text-xs bg-red-600 text-white rounded-full px-2">${nums.length}</span>
                                </summary>
                                <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                                    ${nums.slice(0, 50).map(n => `
                                        <div class="flex items-center justify-between bg-red-50 rounded p-2 text-sm">
                                            <span class="font-mono text-gray-800">${n}</span>
                                            <button class="text-blue-600 hover:text-blue-800" onclick="navigator.clipboard.writeText('${n}'); showToast('Numara kopyalandƒ±');">
                                                <i class="fas fa-copy"></i> Kopyala
                                            </button>
                                </div>
                                    `).join('')}
                                    ${nums.length > 50 ? `<div class="text-xs text-gray-500 mt-1">... ve ${nums.length - 50} numara daha</div>` : ''}
                                </div>
                            </details>
                        `).join('');

                        content.innerHTML = errorNumbers.length > 0 ? `
                            <div class="mb-3 flex flex-wrap">${reasonBadges}</div>
                            <div class="space-y-2 max-h-64 overflow-y-auto">${groupsHtml}</div>
                        ` : '<p class="text-gray-500 text-center py-4">Ba≈üarƒ±sƒ±z mesaj yok.</p>';
                    } else {
                        content.innerHTML = pendingNumbers.length > 0 ? pendingNumbers.map((num, idx) => `
                            <div class="flex items-center justify-between py-2 px-3 hover:bg-gray-50 border-b border-gray-100">
                                <span class="text-sm">${idx + 1}. ${num}</span>
                                <span class="text-xs text-orange-600">üì§ G√∂nderiliyor</span>
                            </div>
                        `).join('') : '<p class="text-gray-500 text-center py-4">G√∂nderilecek mesaj yok.</p>';
                    }
                };
            }
        });
    }
    
    function showCampaignDetailsModal(campaign) { 
        const group = state.collections.groups.find(g => g.id === campaign.groupId);
        const device = (state.collections.settings.devices || []).find(d => d.id === campaign.deviceId);
        
        const currentScheduleIndex = campaign.currentScheduleIndex || 0;
        const allNumbers = getGroupNumbers(group);
        const sentNumbers = campaign.sentNumbers || [];
        const errorNumbers = campaign.errorNumbers || [];
        const sentTimestamps = campaign.sentTimestamps || {};
        
        // Her par√ßa i√ßin hangi numaralar g√∂nderildi hesapla
        let startIndex = 0;
        
        let scheduleHtml = campaign.schedule.map((s, index) => {
            const date = new Date(s.sendTime.toDate());
            const formattedDate = date.toLocaleString('tr-TR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const now = new Date();
            const isPast = date < now;
            const isCompleted = index < currentScheduleIndex;
            const isCurrent = index === currentScheduleIndex;
            const isFuture = index > currentScheduleIndex;
            
            // Bu par√ßanƒ±n numaralarƒ±nƒ± belirle (orijinal gruptan)
            const pieceNumbers = allNumbers.slice(startIndex, startIndex + s.count);
            startIndex += s.count;
            
            // Bu par√ßadan ka√ß ki≈üi ba≈üarƒ±lƒ±/ba≈üarƒ±sƒ±z
            // SADECE tamamlanmƒ±≈ü veya ≈üu anki par√ßalar i√ßin istatistik g√∂ster
            let pieceSent = 0;
            let pieceError = 0;
            let piecePending = s.count;
            
            if (isCompleted || isCurrent) {
                pieceSent = pieceNumbers.filter(num => sentNumbers.includes(num)).length;
                pieceError = pieceNumbers.filter(num => errorNumbers.includes(num)).length;
                piecePending = pieceNumbers.length - pieceSent - pieceError;
            }
            
            let statusIcon = '';
            let statusText = '';
            let bgColor = '';
            let borderColor = '';
            let iconColor = '';
            
            if (isCompleted) {
                statusIcon = 'fa-check-circle';
                statusText = 'Tamamlandƒ±';
                bgColor = 'bg-green-50';
                borderColor = 'border-green-300';
                iconColor = 'bg-green-500';
            } else if (isCurrent) {
                statusIcon = isPast ? 'fa-hourglass-half' : 'fa-clock';
                statusText = isPast ? 'G√∂nderiliyor...' : 'Bekliyor';
                bgColor = isPast ? 'bg-amber-50' : 'bg-blue-50';
                borderColor = isPast ? 'border-amber-300' : 'border-blue-300';
                iconColor = isPast ? 'bg-amber-500' : 'bg-blue-500';
            } else {
                statusIcon = 'fa-pause-circle';
                statusText = 'Planlandƒ±';
                bgColor = 'bg-gray-50';
                borderColor = 'border-gray-300';
                iconColor = 'bg-gray-400';
            }
            
            // D√ºzenleme butonu sadece hen√ºz g√∂nderilmemi≈ü par√ßalarda g√∂r√ºns√ºn
            const canEdit = !isCompleted && campaign.status !== 'Tamamlandƒ±' && campaign.status !== 'tamamlandƒ±';
            
            return `
                <div class="flex items-center justify-between ${bgColor} border ${borderColor} rounded-lg p-3">
                    <div class="flex items-center space-x-3 flex-1">
                        <div class="${iconColor} text-white rounded-full w-8 h-8 flex items-center justify-center flex-shrink-0">
                            <i class="fas ${statusIcon} text-xs"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center space-x-2">
                                <span class="font-semibold text-gray-700">Par√ßa ${index + 1}</span>
                                <span class="text-xs px-2 py-0.5 rounded-full ${bgColor === 'bg-green-50' ? 'bg-green-100 text-green-700' : bgColor === 'bg-amber-50' ? 'bg-amber-100 text-amber-700' : bgColor === 'bg-blue-50' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'}">${statusText}</span>
                            </div>
                            <div class="font-medium text-gray-800 text-sm mt-1">${formattedDate}</div>
                            ${!isPast && isCurrent ? `<div class="text-xs text-gray-500 mt-0.5">‚è∞ ${Math.ceil((date - now) / 1000 / 60)} dakika sonra</div>` : ''}
                            ${isCompleted ? `
                                <div class="text-xs text-gray-600 mt-1 flex items-center space-x-2">
                                    ${pieceSent > 0 ? `<span class="text-green-600">‚úÖ ${pieceSent}</span>` : ''}
                                    ${pieceError > 0 ? `<span class="text-red-600">‚ùå ${pieceError}</span>` : ''}
                                    ${piecePending > 0 ? `<span class="text-orange-600">‚è≥ ${piecePending}</span>` : ''}
                                </div>
                            ` : ''}
                            ${isCurrent && isPast && pieceSent + pieceError > 0 ? `
                                <div class="text-xs text-gray-600 mt-1 flex items-center space-x-2">
                                    ${pieceSent > 0 ? `<span class="text-green-600">‚úÖ ${pieceSent}</span>` : ''}
                                    ${pieceError > 0 ? `<span class="text-red-600">‚ùå ${pieceError}</span>` : ''}
                                    ${piecePending > 0 ? `<span class="text-orange-600">‚è≥ ${piecePending}</span>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="bg-white px-3 py-1 rounded-full border ${borderColor} flex-shrink-0">
                            <span class="font-bold" style="color: ${bgColor === 'bg-green-50' ? '#059669' : bgColor === 'bg-amber-50' ? '#d97706' : bgColor === 'bg-blue-50' ? '#2563eb' : '#6b7280'}">${s.count}</span>
                            <span class="text-xs text-gray-600"> ki≈üi</span>
                        </div>
                        ${canEdit ? `
                            <button 
                                onclick="editSchedulePiece('${campaign.id}', ${index})" 
                                class="text-blue-600 hover:text-blue-800 p-2 hover:bg-blue-50 rounded transition-colors"
                                title="G√∂nderim Zamanƒ±nƒ± D√ºzenle">
                                <i class="fas fa-edit"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');

        // Get error reasons and skipped numbers (allNumbers, sentNumbers, errorNumbers already defined above)
        const errorReasons = campaign.errorReasons || {};
        const skippedNumbers = campaign.skippedNumbers || [];
        
        // Calculate pending numbers
        const pendingNumbers = allNumbers.filter(num => !sentNumbers.includes(num) && !errorNumbers.includes(num) && !skippedNumbers.includes(num));

        // Status Badge
        const statusBadgeClass = campaign.status === 'Tamamlandƒ±' || campaign.status === 'tamamlandƒ±' ? 'bg-green-500 text-white border-green-600' : 
                                 campaign.status === 'g√∂nderiliyor' ? 'bg-amber-100 text-amber-700 border-amber-300' : 
                                 campaign.status === 'planlandƒ±' ? 'bg-blue-100 text-blue-700 border-blue-300' : 
                                 'bg-gray-100 text-gray-700 border-gray-300';

        // Stats Cards
        const statsHtml = `
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-green-600">${sentNumbers.length}</div>
                    <div class="text-xs text-green-700 mt-1">‚úÖ G√∂nderildi</div>
                </div>
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-red-600">${errorNumbers.length}</div>
                    <div class="text-xs text-red-700 mt-1">‚ùå Ba≈üarƒ±sƒ±z</div>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-yellow-600">${skippedNumbers.length}</div>
                    <div class="text-xs text-yellow-700 mt-1">‚è≠Ô∏è Atlandƒ±</div>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-blue-600">${pendingNumbers.length}</div>
                    <div class="text-xs text-blue-700 mt-1">‚è≥ Beklemede</div>
                </div>
            </div>
        `;

        // Success details (ba≈üarƒ±lƒ± mesajlar)
        let successDetailsHtml = '';
        if (sentNumbers.length > 0) {
            const successList = sentNumbers.slice(0, 10).map(number => {
                return `
                    <div class="flex items-start space-x-2 bg-white p-2 rounded border border-green-100">
                        <i class="fas fa-check-circle text-green-500 mt-1"></i>
                        <div class="flex-1">
                            <div class="font-mono text-sm text-gray-800">${number}</div>
                            <div class="text-xs text-gray-500">Ba≈üarƒ±yla g√∂nderildi</div>
                        </div>
                    </div>
                `;
            }).join('');
            const moreText = sentNumbers.length > 10 ? `<p class="text-xs text-gray-500 text-center mt-2">... ve ${sentNumbers.length - 10} numara daha</p>` : '';
            successDetailsHtml = `
                <div class="mt-6">
                    <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        Ba≈üarƒ±lƒ± Mesajlar (${sentNumbers.length})
                    </h4>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3 max-h-60 overflow-y-auto space-y-2">
                        ${successList}
                        ${moreText}
                    </div>
                </div>
            `;
        }

        // Hata mesajlarƒ±nƒ± T√ºrk√ßele≈ütir ve a√ßƒ±kla
        function getErrorMessage(errorReason) {
            if (!errorReason) return '‚ùì Bilinmeyen hata';
            
            const error = errorReason.toLowerCase();
            
            // Yaygƒ±n hata mesajlarƒ±
            if (error.includes('internal server error')) {
                return 'üîß Sunucu hatasƒ± - Tekrar deneyin veya destek ile ileti≈üime ge√ßin';
            }
            if (error.includes('hatalƒ± istek formatƒ±') || error.includes('bad request')) {
                return 'üìµ Bu numara WhatsApp kullanmƒ±yor';
            }
            if (error.includes('load failed')) {
                return 'üìµ Bu numara WhatsApp\'ta kayƒ±tlƒ± deƒüil veya √ßevrimdƒ±≈üƒ±';
            }
            if (error.includes('rate limit') || error.includes('√ßok fazla istek')) {
                return '‚è±Ô∏è √áok fazla mesaj g√∂nderildi - L√ºtfen bekleyin';
            }
            if (error.includes('unauthorized') || error.includes('yetkisiz')) {
                return 'üîí Yetkilendirme hatasƒ± - Cihaz baƒülantƒ±sƒ±nƒ± kontrol edin';
            }
            if (error.includes('timeout') || error.includes('zaman a≈üƒ±mƒ±')) {
                return '‚è≥ Zaman a≈üƒ±mƒ± - ƒ∞nternet baƒülantƒ±sƒ±nƒ± kontrol edin';
            }
            if (error.includes('not registered') || error.includes('kayƒ±tlƒ± deƒüil')) {
                return 'üì± Numara WhatsApp\'ta kayƒ±tlƒ± deƒüil';
            }
            if (error.includes('blocked') || error.includes('engellenmi≈ü')) {
                return 'üö´ Numara sizi engellemi≈ü';
            }
            if (error.includes('invalid number') || error.includes('ge√ßersiz numara')) {
                return '‚ùå Ge√ßersiz telefon numarasƒ±';
            }
            if (error.includes('media error') || error.includes('medya hatasƒ±')) {
                return 'üñºÔ∏è G√∂rsel/medya y√ºklenemedi';
            }
            if (error.includes('connection') || error.includes('baƒülantƒ±')) {
                return 'üì° Baƒülantƒ± hatasƒ± - Cihaz √ßevrimdƒ±≈üƒ± olabilir';
            }
            
            // Varsayƒ±lan - orijinal mesajƒ± g√∂ster ama temizle
            return '‚ö†Ô∏è ' + errorReason.substring(0, 50);
        }

        // Error details (sadece hatalƒ± mesajlar)
        let errorDetailsHtml = '';
        if (errorNumbers.length > 0) {
            // Gruplandƒ±rƒ±lmƒ±≈ü, anla≈üƒ±lƒ±r hata listesi hazƒ±rla
            const groupedByReason = {};
            errorNumbers.forEach(number => {
                const originalReason = errorReasons[number] || 'Bilinmeyen hata';
                const friendly = getErrorMessage(originalReason);
                if (!groupedByReason[friendly]) groupedByReason[friendly] = [];
                groupedByReason[friendly].push(number);
            });

            const reasonBadges = Object.entries(groupedByReason).map(([reason, nums]) => `
                <span class="inline-flex items-center bg-red-50 border border-red-200 text-red-700 text-xs px-2 py-1 rounded mr-2 mb-2">
                    ${reason}
                    <span class="ml-2 bg-red-600 text-white rounded-full px-2">${nums.length}</span>
                </span>
            `).join('');

            const groupsHtml = Object.entries(groupedByReason).map(([reason, nums]) => `
                <details class="bg-white border border-red-100 rounded-lg p-3" ${Object.keys(groupedByReason).length === 1 ? 'open' : ''}>
                    <summary class="cursor-pointer font-medium text-red-700 flex items-center justify-between">
                        <span>${reason}</span>
                        <span class="text-xs bg-red-600 text-white rounded-full px-2">${nums.length}</span>
                    </summary>
                    <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                        ${nums.slice(0, 50).map(n => `
                            <div class="flex items-center justify-between bg-red-50 rounded p-2 text-sm">
                                <span class="font-mono text-gray-800">${n}</span>
                                <button class="text-blue-600 hover:text-blue-800" onclick="navigator.clipboard.writeText('${n}'); showToast('Numara kopyalandƒ±');">
                                    <i class="fas fa-copy"></i> Kopyala
                                </button>
                        </div>
                        `).join('')}
                        ${nums.length > 50 ? `<div class="text-xs text-gray-500 mt-1">... ve ${nums.length - 50} numara daha</div>` : ''}
                    </div>
                </details>
            `).join('');

            errorDetailsHtml = `
                <div class="mt-6">
                    <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                        Ba≈üarƒ±sƒ±z Mesajlar (${errorNumbers.length})
                    </h4>
                    <div class="mb-3 flex flex-wrap">${reasonBadges}</div>
                    <div class="space-y-2 max-h-64 overflow-y-auto">${groupsHtml}</div>
                </div>
            `;
        }
        const body = `
            <!-- Header with status -->
            <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="bg-gradient-to-br from-blue-500 to-purple-600 text-white rounded-lg w-12 h-12 flex items-center justify-center">
                        <i class="fas fa-bullhorn text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 text-lg">${campaign.name}</h3>
                        <span class="inline-block px-3 py-1 rounded-full text-xs font-medium border ${statusBadgeClass} mt-1">${campaign.status === 'tamamlandƒ±' ? 'Tamamlandƒ±' : (campaign.status || 'Taslak')}</span>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            ${statsHtml}

            <!-- Campaign Info -->
            <div class="space-y-4">
                <!-- Device Info -->
                <div class="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-lg p-4">
                    <div class="flex items-center space-x-3">
                        <div class="bg-purple-500 text-white rounded-full w-10 h-10 flex items-center justify-center">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs text-gray-500 mb-1">G√∂nderici Cihaz</div>
                            <div class="font-semibold text-gray-800">${device?.instanceName || device?.cihazAdi || 'N/A'}</div>
                            <div class="text-sm text-gray-600">${device?.phoneNumber || device?.phone || 'Telefon numarasƒ± yok'}</div>
                        </div>
                    </div>
                </div>

                <!-- Group Info -->
                <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center space-x-3">
                        <div class="bg-blue-500 text-white rounded-full w-10 h-10 flex items-center justify-center">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs text-gray-500 mb-1">Hedef Grup</div>
                            <div class="font-semibold text-gray-800">${group?.name || 'N/A'}</div>
                            <div class="text-sm text-gray-600">${allNumbers.length} ki≈üi</div>
                        </div>
                    </div>
                </div>

                <!-- Message Content -->
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <div class="bg-green-500 text-white rounded-full w-10 h-10 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-comment-alt"></i>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs text-gray-500 mb-2">Mesaj ƒ∞√ßeriƒüi</div>
                            <div class="bg-white rounded-lg p-3 text-sm text-gray-800 whitespace-pre-wrap border border-green-100">${campaign.message}</div>
                        </div>
                    </div>
                </div>

                ${campaign.imageUrl ? `
                    <div class="bg-gradient-to-r from-orange-50 to-yellow-50 border border-orange-200 rounded-lg p-4">
                        <div class="text-xs text-gray-500 mb-2 flex items-center">
                            <i class="fas fa-image text-orange-500 mr-2"></i>
                            Eklenen G√∂rsel
                        </div>
                        <img src="${campaign.imageUrl}" class="max-h-60 w-auto rounded-lg shadow-md border border-orange-100">
                    </div>
                ` : ''}

                <!-- Send Schedule -->
                <div class="bg-gradient-to-r from-indigo-50 to-blue-50 border border-indigo-200 rounded-lg p-4">
                    <div class="text-xs text-gray-500 mb-3 flex items-center">
                        <i class="fas fa-calendar-alt text-indigo-500 mr-2"></i>
                        G√∂nderim Planƒ±
                    </div>
                    <div class="space-y-2">
                        ${scheduleHtml}
                    </div>
                </div>
            </div>

            ${successDetailsHtml}
            ${errorDetailsHtml}
        `;
        
        ModalManager.show({ 
            title: `<div class="flex items-center space-x-2">
                        <i class="fas fa-info-circle text-blue-500"></i>
                        <span>Kampanya Detaylarƒ±</span>
                    </div>`, 
            body: body, 
            width: 'max-w-4xl',
            footer: `<button id="modal-close" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition-all">
                        <i class="fas fa-times mr-2"></i>Kapat
                    </button>`, 
            onReady: () => document.getElementById('modal-close').onclick = ModalManager.hide 
        });
    }
    function showNumbersModal(campaign) {
        const group = state.collections.groups.find(g => g.id === campaign.groupId);
        const allNumbers = getGroupNumbers(group);
        const sentNumbers = campaign.sentNumbers || [];
        const errorNumbers = campaign.errorNumbers || [];
        const errorReasons = campaign.errorReasons || {};
        const sentTimestamps = campaign.sentTimestamps || {};
        const skippedNumbers = campaign.skippedNumbers || [];
        const skippedReasons = campaign.skippedReasons || {};
        
        // Calculate pending numbers
        const pendingNumbers = allNumbers.filter(num => !sentNumbers.includes(num) && !errorNumbers.includes(num) && !skippedNumbers.includes(num));
        
        const totalNumbers = allNumbers.length;
        const successRate = totalNumbers > 0 ? Math.round((sentNumbers.length / totalNumbers) * 100) : 0;
        const progress = totalNumbers > 0 ? ((sentNumbers.length + errorNumbers.length) / totalNumbers) * 100 : 0;

        const body = `
            <div class="space-y-4">
                <!-- Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                        <p class="text-2xl font-bold text-green-600">${sentNumbers.length}</p>
                        <p class="text-xs text-green-700">‚úÖ G√∂nderildi</p>
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-center">
                        <p class="text-2xl font-bold text-red-600">${errorNumbers.length}</p>
                        <p class="text-xs text-red-700">‚ùå Ba≈üarƒ±sƒ±z</p>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-center">
                        <p class="text-2xl font-bold text-yellow-600">${skippedNumbers.length}</p>
                        <p class="text-xs text-yellow-700">‚è≠Ô∏è Atlandƒ±</p>
                    </div>
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 text-center">
                        <p class="text-2xl font-bold text-orange-600">${pendingNumbers.length > 0 ? pendingNumbers.length : 0}</p>
                        <p class="text-xs text-orange-700">üì§ ${campaign.status === 'Tamamlandƒ±' ? 'Beklemede' : 'G√∂nderiliyor'}</p>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div class="bg-gradient-to-r from-green-500 to-green-600 h-full transition-all duration-500" style="width: ${progress}%"></div>
                </div>
                <p class="text-center text-sm text-gray-600">${Math.round(progress)}% Tamamlandƒ±</p>
                
                ${campaign.status === 'Tamamlandƒ±' ? `
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                        <p class="text-blue-700 font-medium mb-2">‚úÖ Kampanya Tamamlandƒ±</p>
                        <div class="text-blue-600 text-sm space-y-1">
                            <p><strong>Toplam Mesaj:</strong> ${totalNumbers}</p>
                            <p><strong>Ba≈üarƒ±lƒ±:</strong> ${sentNumbers.length} (${totalNumbers > 0 ? Math.round((sentNumbers.length / totalNumbers) * 100) : 0}%)</p>
                            <p><strong>Ba≈üarƒ±sƒ±z:</strong> ${errorNumbers.length} (${totalNumbers > 0 ? Math.round((errorNumbers.length / totalNumbers) * 100) : 0}%)</p>
                            <p><strong>Ba≈üarƒ± Oranƒ±:</strong> ${successRate}%</p>
                        </div>
                    </div>
                ` : ''}

                <!-- Tabs -->
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-2 overflow-x-auto">
                        <button onclick="switchNumbersTab('success')" id="tab-success" class="numbers-tab active py-2 px-3 text-xs md:text-sm font-medium border-b-2 border-green-500 text-green-600 whitespace-nowrap">
                            G√∂nderildi (${sentNumbers.length})
                        </button>
                        <button onclick="switchNumbersTab('error')" id="tab-error" class="numbers-tab py-2 px-3 text-xs md:text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap">
                            Ba≈üarƒ±sƒ±z (${errorNumbers.length})
                        </button>
                        ${skippedNumbers.length > 0 ? `
                            <button onclick="switchNumbersTab('skipped')" id="tab-skipped" class="numbers-tab py-2 px-3 text-xs md:text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap">
                                Atlandƒ± (${skippedNumbers.length})
                            </button>
                        ` : ''}
                        ${campaign.status !== 'Tamamlandƒ±' ? `
                            <button onclick="switchNumbersTab('pending')" id="tab-pending" class="numbers-tab py-2 px-3 text-xs md:text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap">
                                G√∂nderiliyor (${pendingNumbers.length > 0 ? pendingNumbers.length : 0})
                            </button>
                        ` : ''}
                    </nav>
                </div>

                <!-- Content -->
                <div id="numbers-content" class="max-h-64 overflow-y-auto">
                    <div id="numbers-tab-success" class="numbers-tab-content">
                        ${sentNumbers.length > 0 ? sentNumbers.map((num, idx) => {
                            const timestamp = sentTimestamps[num];
                            const timeStr = timestamp ? new Date(timestamp).toLocaleString('tr-TR', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit'
                            }) : '';
                            return `
                            <div class="py-2 px-3 hover:bg-gray-50 border-b border-gray-100">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">${idx + 1}. ${num}</span>
                                    <span class="text-xs text-green-600">‚úÖ G√∂nderildi</span>
                                </div>
                                ${timeStr ? `<div class="text-xs text-gray-500 mt-1 pl-4">üïê ${timeStr}</div>` : ''}
                            </div>
                            `;
                        }).join('') : '<p class="text-gray-500 text-center py-4">Hen√ºz g√∂nderilen mesaj yok</p>'}
                    </div>

                    <div id="numbers-tab-error" class="numbers-tab-content hidden">
                        ${errorNumbers.length > 0 ? errorNumbers.map((num, idx) => {
                            const reason = errorReasons[num] || 'Bilinmeyen hata';
                            return `
                            <div class="py-2 px-3 hover:bg-gray-50 border-b border-gray-100">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">${idx + 1}. ${num}</span>
                                    <span class="text-xs text-red-600">‚ùå Ba≈üarƒ±sƒ±z</span>
                                </div>
                                <div class="text-xs text-red-500 mt-1 pl-4">‚ö†Ô∏è ${reason}</div>
                            </div>
                            `;
                        }).join('') : '<p class="text-gray-500 text-center py-4">Ba≈üarƒ±sƒ±z mesaj yok</p>'}
                    </div>

                    <div id="numbers-tab-skipped" class="numbers-tab-content hidden">
                        ${skippedNumbers.length > 0 ? skippedNumbers.map((num, idx) => {
                            const reason = skippedReasons[num] || '24 saat kuralƒ±';
                            return `
                            <div class="py-2 px-3 hover:bg-gray-50 border-b border-gray-100">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">${idx + 1}. ${num}</span>
                                    <span class="text-xs text-yellow-600">‚è≠Ô∏è Atlandƒ±</span>
                                </div>
                                <div class="text-xs text-yellow-600 mt-1 pl-4">${reason}</div>
                            </div>
                            `;
                        }).join('') : '<p class="text-gray-500 text-center py-4">Atlanan mesaj yok</p>'}
                    </div>

                    <div id="numbers-tab-pending" class="numbers-tab-content hidden">
                        ${pendingNumbers.length > 0 ? pendingNumbers.map((num, idx) => `
                            <div class="py-2 px-3 hover:bg-gray-50 border-b border-gray-100">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">${idx + 1}. ${num}</span>
                                    <span class="text-xs text-orange-600">üì§ ${campaign.status === 'Tamamlandƒ±' ? 'Beklemede' : 'G√∂nderiliyor'}</span>
                                </div>
                            </div>
                        `).join('') : '<p class="text-gray-500 text-center py-4">Bekleyen mesaj yok</p>'}
                    </div>
                </div>
            </div>
        `;

        ModalManager.show({ 
            title: `üìä ƒ∞statistikler - ${campaign.name}`, 
            body: body, 
            footer: `<button id="modal-close" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Kapat</button>`, 
            onReady: () => {
                document.getElementById('modal-close').onclick = ModalManager.hide;
                
                // Tab switching function
                window.switchNumbersTab = function(tab) {
                    // Hide all tabs
                    document.querySelectorAll('.numbers-tab-content').forEach(el => el.classList.add('hidden'));
                    document.querySelectorAll('.numbers-tab').forEach(el => {
                        el.classList.remove('active', 'border-green-500', 'border-red-500', 'border-yellow-500', 'border-blue-500', 'text-green-600', 'text-red-600', 'text-yellow-600', 'text-blue-600');
                        el.classList.add('border-transparent', 'text-gray-500');
                    });
                    
                    // Show selected tab
                    const selectedTab = document.getElementById(`numbers-tab-${tab}`);
                    const selectedButton = document.getElementById(`tab-${tab}`);
                    
                    if (selectedTab) selectedTab.classList.remove('hidden');
                    if (selectedButton) {
                        selectedButton.classList.add('active');
                        selectedButton.classList.remove('border-transparent', 'text-gray-500');
                        
                        if (tab === 'success') {
                            selectedButton.classList.add('border-green-500', 'text-green-600');
                        } else if (tab === 'error') {
                            selectedButton.classList.add('border-red-500', 'text-red-600');
                        } else if (tab === 'skipped') {
                            selectedButton.classList.add('border-yellow-500', 'text-yellow-600');
                        } else if (tab === 'pending') {
                            selectedButton.classList.add('border-blue-500', 'text-blue-600');
                        }
                    }
                };
            }
        });
    }
    function showGroupTemplateModal(groupId, template = null, templateIndex = null) {
        const isEdit = template !== null;
        const templateGroup = state.collections.templateGroups.find(tg => tg.id === groupId);
    
        ModalManager.show({
            title: isEdit ? '≈ûablonu D√ºzenle' : 'Yeni ≈ûablon Ekle',
            body: `<div class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700">≈ûablon Adƒ±</label><input type="text" id="group-template-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${template?.name || ''}" placeholder="Mesaj 1"></div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ƒ∞√ßerik</label>
                    <textarea id="group-template-content" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" rows="5" placeholder="Merhaba {Ad} {Soyad}! Yeni √ºr√ºnlerimizi g√∂rmek ister misiniz?">${template?.content || ''}</textarea>
                    <p class="text-xs text-gray-500 mt-1">
                        üìù Kullanƒ±labilir deƒüi≈ükenler: <code class="bg-gray-100 px-1 rounded">{Ad}</code> <code class="bg-gray-100 px-1 rounded">{Soyad}</code> <code class="bg-gray-100 px-1 rounded">{AdSoyad}</code>
                    </p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">G√∂rsel Ekle (Opsiyonel)</label>
                    <div class="mt-1">
                        <input type="file" id="group-template-image" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"/>
                        <p class="text-xs text-gray-500 mt-1">Desteklenen formatlar: JPG, PNG, GIF (Max: 5MB)</p>
                    </div>
                    <div id="group-template-image-preview" class="mt-3">
                        ${template?.imageUrl ? `
                            <div class="relative inline-block">
                                <img src="${template.imageUrl}" class="max-h-32 rounded-md shadow-sm border border-gray-200">
                                <button type="button" id="remove-group-template-image-btn" class="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>`,
            footer: `<button id="modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">ƒ∞ptal</button><button id="modal-save-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Kaydet</button>`,
            onReady: () => {
                document.getElementById('modal-cancel-btn').onclick = ModalManager.hide;
                
                // Image preview
                const imageInput = document.getElementById('group-template-image');
                imageInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const previewContainer = document.getElementById('group-template-image-preview');
                            previewContainer.innerHTML = `
                                <div class="relative inline-block">
                                    <img src="${event.target.result}" class="max-h-32 rounded-md shadow-sm border border-gray-200">
                                    <button type="button" id="remove-group-template-image-btn" class="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            `;
                            document.getElementById('remove-group-template-image-btn').onclick = () => {
                                imageInput.value = '';
                                previewContainer.innerHTML = '';
                            };
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                // Remove existing image button
                if (template?.imageUrl) {
                    const removeBtn = document.getElementById('remove-group-template-image-btn');
                if (removeBtn) {
                    removeBtn.onclick = () => {
                        imageInput.value = '';
                            document.getElementById('group-template-image-preview').innerHTML = '';
                    };
                    }
                }
                
                document.getElementById('modal-save-btn').onclick = async () => {
                    const name = document.getElementById('group-template-name').value.trim();
                    const content = document.getElementById('group-template-content').value.trim();
                    const imageFile = imageInput.files[0];
                    
                    if(!name || !content) { 
                        showToast("L√ºtfen ≈üablon adƒ± ve i√ßerik girin.", true); 
                        return; 
                    }
                    
                    let imageUrl = template?.imageUrl || '';
                    
                    // Upload image if new file selected
                    if (imageFile) {
                        try {
                            const storageRef = ref(state.storage, `template-images/${state.userId}/${Date.now()}_${imageFile.name}`);
                            await uploadBytes(storageRef, imageFile);
                            imageUrl = await getDownloadURL(storageRef);
                        } catch (error) {
                            console.error("Image upload error:", error);
                            showToast("G√∂rsel y√ºklenemedi: " + error.message, true);
            return;
        }
                    }
                    
                    const newTemplate = { 
                        id: template?.id || Date.now().toString(),
                        name, 
                        content, 
                        imageUrl,
                        createdAt: template?.createdAt || new Date().toISOString()
                    };
                    
                    let updatedTemplates = [...(templateGroup.templates || [])];
                    if (isEdit && templateIndex !== null) {
                        updatedTemplates[templateIndex] = newTemplate;
                    } else {
                        updatedTemplates.push(newTemplate);
                    }
                    
                    const success = await Firestore.update('templateGroups', groupId, { templates: updatedTemplates });
                    if (success) {
                        showToast(`≈ûablon ${isEdit ? 'g√ºncellendi' : 'eklendi'}`);
                        ModalManager.hide();
                        showGroupTemplates(groupId); // Refresh the view
                    }
                };
            }
        });
    }

    function showGroupTemplates(groupId) {
        const templateGroup = state.collections.templateGroups.find(tg => tg.id === groupId);
        if (!templateGroup) {
            showToast("≈ûablon grubu bulunamadƒ±", true);
            return;
        }
        
        const templates = templateGroup.templates || [];
        const templatesList = templates.map((t, idx) => `
            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow bg-white">
                <div class="flex items-start justify-between mb-2">
                    <h4 class="font-semibold text-gray-800">${idx + 1}. ${t.name}</h4>
                                    <div class="flex gap-2">
                        <button data-index="${idx}" class="edit-template-btn text-blue-600 hover:text-blue-800 p-1" title="D√ºzenle">
                                            <i class="fas fa-edit"></i>
                                        </button>
                        <button data-index="${idx}" class="delete-template-btn text-red-600 hover:text-red-800 p-1" title="Sil">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded border border-gray-100 font-mono whitespace-pre-wrap">${t.content}</div>
                ${t.imageUrl ? `<div class="mt-2"><img src="${t.imageUrl}" class="max-h-32 rounded border border-gray-200"></div>` : ''}
                            </div>
        `).join('') || '<p class="text-center text-gray-500 py-8">Bu grupta hen√ºz ≈üablon yok</p>';
        
        // Render as a full page
        appContent.innerHTML = `
            <div class="mb-6">
                <div class="flex items-center gap-3 mb-4">
                    <button id="back-to-groups-btn" class="text-gray-600 hover:text-gray-800 transition-colors">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </button>
                    <div class="flex-1">
                        <h2 class="text-3xl font-bold text-gray-800">üìã ${templateGroup.name}</h2>
                        <p class="text-sm text-gray-500 mt-1">${templates.length} ≈üablon</p>
                    </div>
                    <button id="add-template-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>Yeni ≈ûablon Ekle
                    </button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                ${templates.length > 0 ? templatesList : '<div class="col-span-full text-center py-16 text-gray-500 bg-white rounded-lg border-2 border-dashed border-gray-300"><i class="fas fa-inbox text-4xl mb-3 text-gray-400"></i><p>Bu grupta hen√ºz ≈üablon yok</p><p class="text-sm mt-1">Ba≈ülamak i√ßin yukarƒ±daki butonlarƒ± kullanƒ±n</p></div>'}
            </div>
        `;
        
        // Event listeners
        document.getElementById('back-to-groups-btn').onclick = () => {
            state.currentViewingGroupId = null;
            renderTemplateGroups();
        };
        
        document.getElementById('add-template-btn').onclick = () => {
            showGroupTemplateModal(groupId);
        };
        
        document.querySelectorAll('.edit-template-btn').forEach(btn => {
            btn.onclick = () => {
                const idx = parseInt(btn.dataset.index);
                showGroupTemplateModal(groupId, templates[idx], idx);
            };
        });
        
        document.querySelectorAll('.delete-template-btn').forEach(btn => {
            btn.onclick = async () => {
                const idx = parseInt(btn.dataset.index);
                const confirmed = confirm(`"${templates[idx].name}" ≈üablonunu silmek istediƒüinize emin misiniz?`);
                if (confirmed) {
                    const updatedTemplates = templates.filter((_, i) => i !== idx);
                    const success = await Firestore.update('templateGroups', groupId, { templates: updatedTemplates });
                    if (success) {
                        showToast("≈ûablon silindi");
                        showGroupTemplates(groupId);
                    }
                }
            };
        });
    }
    function showTemplateGroupModal(group = null) {
        const isEdit = !!group;
        
        ModalManager.show({
            title: isEdit ? '≈ûablon Grubunu D√ºzenle' : 'Yeni ≈ûablon Grubu',
            body: `<div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Grup Adƒ±</label>
                    <input type="text" id="template-group-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${group?.name || ''}" placeholder="√ñrn: Yaz ƒ∞ndirimleri Mesajlarƒ±">
                    </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">A√ßƒ±klama (Opsiyonel)</label>
                    <textarea id="template-group-description" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" rows="3" placeholder="Bu grubun amacƒ±nƒ± kƒ±saca a√ßƒ±klayƒ±n...">${group?.description || ''}</textarea>
                            </div>
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                    <p class="text-sm text-gray-700">
                        <i class="fas fa-info-circle text-purple-600 mr-1"></i>
                        Grubu olu≈üturduktan sonra i√ßine ≈üablonlar ekleyebilirsiniz.
                    </p>
                </div>
            </div>`,
            footer: `<button id="modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">ƒ∞ptal</button><button id="modal-save-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Kaydet</button>`,
            onReady: () => {
                document.getElementById('modal-cancel-btn').onclick = ModalManager.hide;
                document.getElementById('modal-save-btn').onclick = async () => {
                    const name = document.getElementById('template-group-name').value.trim();
                    const description = document.getElementById('template-group-description').value.trim();
                    
                    if(!name) { 
                        showToast("L√ºtfen grup adƒ± girin.", true); 
                        return; 
                    }
                    
                    const data = { 
                        name, 
                        description, 
                        templates: group?.templates || []
                    };
                    
                    const success = isEdit 
                        ? await Firestore.update('templateGroups', group.id, data) 
                        : await Firestore.add('templateGroups', data);
                    
                    if(success) {
                        showToast(`≈ûablon grubu ${isEdit ? 'g√ºncellendi' : 'olu≈üturuldu'}`);
                        ModalManager.hide();
                    }
                };
            }
        });
    }
    
    function showTemplateModal(template = null) {
        const isEdit = !!template;
        
        ModalManager.show({
            title: isEdit ? '≈ûablonu D√ºzenle' : 'Yeni ≈ûablon',
            body: `<div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">≈ûablon Adƒ±</label>
                    <input type="text" id="template-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${template?.name || ''}" placeholder="√ñrn: Ho≈ügeldin Mesajƒ±">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Mesaj ƒ∞√ßeriƒüi</label>
                    <textarea id="template-content" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 font-mono text-sm" rows="8" placeholder="Merhaba {Ad} {Soyad}, kampanyamƒ±z hakkƒ±nda...">${template?.content || ''}</textarea>
                    <p class="text-xs text-gray-500 mt-1">
                        üìù Kullanƒ±labilir deƒüi≈ükenler: <code class="bg-gray-100 px-1 rounded">{Ad}</code> <code class="bg-gray-100 px-1 rounded">{Soyad}</code> <code class="bg-gray-100 px-1 rounded">{AdSoyad}</code>
                    </p>
                </div>
            </div>`,
            footer: `<button id="modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">ƒ∞ptal</button><button id="modal-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Kaydet</button>`,
            onReady: () => {
                document.getElementById('modal-cancel-btn').onclick = ModalManager.hide;
                document.getElementById('modal-save-btn').onclick = async () => {
                    const name = document.getElementById('template-name').value.trim();
                    const content = document.getElementById('template-content').value.trim();
                    
                    if(!name || !content) { 
                        showToast("L√ºtfen ≈üablon adƒ± ve i√ßerik girin.", true); 
                        return; 
                    }
                    
                    const data = { name, content };
                    const success = isEdit ? await Firestore.update('templates', template.id, data) : await Firestore.add('templates', data);
                    if(success) {
                        showToast(`≈ûablon ${isEdit ? 'g√ºncellendi' : 'olu≈üturuldu'}`);
                        ModalManager.hide();
                    }
                };
            }
        });
    }
    
    function showGroupModal(group = null) {
        const isEdit = !!group;
        
        // Eski format numbers array ise contacts'e d√∂n√º≈üt√ºr
        let contactsText = '';
        if (group?.contacts && Array.isArray(group.contacts)) {
            contactsText = group.contacts.map(c => `${c.phone}, ${c.name || ''}, ${c.surname || ''}`).join('\n');
        } else if (group?.numbers && Array.isArray(group.numbers)) {
            // Geriye d√∂n√ºk uyumluluk
            contactsText = group.numbers.map(n => `${n}, ,`).join('\n');
        }
        
        ModalManager.show({
            title: isEdit ? 'Grubu D√ºzenle' : 'Yeni Grup',
            body: `<div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Grup Adƒ±</label>
                    <input type="text" id="group-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" value="${group?.name || ''}">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Ki≈üiler (Her satƒ±rda: Telefon, Ad, Soyad)</label>
                    <textarea id="group-contacts" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 font-mono text-sm" rows="10" placeholder="905XXXXXXXXXX, Ali, Yƒ±lmaz\n905XXXXXXXXXX, Ay≈üe, Kaya\n905XXXXXXXXXX">${contactsText}</textarea>
                    <p class="text-xs text-gray-500 mt-1">
                        Format: <code class="bg-gray-100 px-1 rounded">Telefon, Ad, Soyad</code> veya sadece <code class="bg-gray-100 px-1 rounded">Telefon</code><br>
                        Mesajlarda <code class="bg-gray-100 px-1 rounded">{Ad}</code> ve <code class="bg-gray-100 px-1 rounded">{Soyad}</code> deƒüi≈ükenlerini kullanabilirsiniz.
                    </p>
                </div>
            </div>`,
            footer: `<button id="modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">ƒ∞ptal</button><button id="modal-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Kaydet</button>`,
            onReady: () => {
                document.getElementById('modal-cancel-btn').onclick = ModalManager.hide;
                document.getElementById('modal-save-btn').onclick = async () => {
                    const name = document.getElementById('group-name').value.trim();
                    let contactsText = document.getElementById('group-contacts').value.trim();
                    
                    if(!name || !contactsText) { 
                        showToast("L√ºtfen grup adƒ± ve en az bir ki≈üi girin.", true); 
                        return; 
                    }
                    
                    // Parse contacts - virg√ºl veya pipe karakteri ile ayrƒ±lmƒ±≈ü
                    const contacts = [];
                    const numbers = []; // Geriye d√∂n√ºk uyumluluk i√ßin
                    const lines = contactsText.split('\n').map(l => l.trim()).filter(l => l); // Bo≈ü satƒ±rlarƒ± kaldƒ±r
                    
                    for (const line of lines) {
                        // Hem virg√ºl hem pipe destekle
                        let separator = ',';
                        if (line.includes('|')) separator = '|';
                        
                        const parts = line.split(separator).map(p => p.trim());
                        const phone = parts[0] || '';
                        const firstName = parts[1] || '';
                        const lastName = parts[2] || '';
                        
                        if (phone) {
                            contacts.push({ phone, name: firstName, surname: lastName });
                            numbers.push(phone); // Geriye d√∂n√ºk uyumluluk
                        }
                    }
                    
                    if(contacts.length === 0) {
                        showToast("L√ºtfen en az bir ge√ßerli ki≈üi girin.", true);
                        return;
                    }
                    
                    const data = { name, contacts, numbers }; // Her iki formatƒ± da sakla
                    const success = isEdit ? await Firestore.update('groups', group.id, data) : await Firestore.add('groups', data);
                    if(success) {
                        showToast(`Grup ${isEdit ? 'g√ºncellendi' : 'olu≈üturuldu'}: ${contacts.length} ki≈üi`);
                        ModalManager.hide();
                    }
                };
            }
        });
    }
    function showAddDeviceModal() {
        ModalManager.show({
            title: 'Yeni Cihaz Baƒüla',
            width: 'max-w-md',
            body: `<div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Cihaz Adƒ±</label>
                    <input type="text" id="device-friendly-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="√∂rn: Satƒ±≈ü Destek Hattƒ±">
                    <p class="text-xs text-gray-500 mt-1">Bu cihaza vermek istediƒüiniz kolay anla≈üƒ±lƒ±r bir isim girin.</p>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Baƒülanacak WhatsApp Numarasƒ±</label>
                    <input type="text" id="device-phone-number" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="905551234567">
                </div>
            </div>`,
            footer: `<button id="modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">ƒ∞ptal</button><button id="modal-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Kaydet ve QR Kodu Al</button>`,
            onReady: () => {
                document.getElementById('modal-cancel-btn').onclick = ModalManager.hide;
                document.getElementById('modal-save-btn').onclick = async () => {
                    const cihazAdi = document.getElementById('device-friendly-name').value.trim();
                    const phone = document.getElementById('device-phone-number').value.trim();
                    if (!cihazAdi || !phone) {
                        showToast("L√ºtfen t√ºm alanlarƒ± doldurun.", true); return;
                    }

                    const sanitizedName = cihazAdi.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, "").replace(/-+/g, '-').replace(/^-+|-+$/g, '').toLowerCase();
                    if (!sanitizedName) {
                        showToast("Ge√ßerli bir cihaz adƒ± girin (sadece harf ve rakam).", true); return;
                    }

                    const instanceName = `${state.userId.slice(0, 8)}-${sanitizedName}-${Date.now().toString().slice(-5)}`;
                    
                    const newDevice = {
                        id: Date.now().toString(),
                        cihazAdi: cihazAdi,
                        phone: phone,
                        instanceName: instanceName,
                        status: 'disconnected',
                        apiKey: '' // Will be filled after creation
                    };
                    
                    ModalManager.hide();
                    connectDevice(newDevice, true); // Pass true for isNew
                };
            }
        });
    }

    // Helper: Grup'tan telefon numaralarƒ±nƒ± al (contacts veya numbers)
    function getGroupNumbers(group) {
        if (!group) return [];
        if (group.contacts && Array.isArray(group.contacts)) {
            return group.contacts.map(c => c.phone);
        }
        if (group.numbers && Array.isArray(group.numbers)) {
            return group.numbers;
        }
        return [];
    }

    // --- EVOLUTION API INTEGRATION ---
    function isApiConfigured() {
        if (EVOLUTION_API_URL.includes("Sƒ∞Zƒ∞N_EVO_API_ADRESƒ∞Nƒ∞Z") || EVOLUTION_API_KEY.includes("Sƒ∞Zƒ∞N_GENEL_EVO_API_ANAHTARINIZ")) {
            showToast("L√ºtfen kodun en ba≈üƒ±ndaki sunucu ve API anahtarƒ± bilgilerini g√ºncelleyin.", true);
            return false;
        }
        return true;
    }

    async function saveDevices(newDevices) {
        if (await Firestore.updateSettings({ devices: newDevices })) {
            showToast("Cihaz listesi g√ºncellendi.");
        }
    }

    function editDevice(device) {
        if (!device) return;
        
        const modal = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Cihaz D√ºzenle</h3>
                    <form id="edit-device-form">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Cihaz Adƒ±</label>
                            <input type="text" id="edit-device-name" value="${device.cihazAdi || ''}" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Telefon Numarasƒ±</label>
                            <input type="tel" id="edit-device-phone" value="${device.phone || ''}" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">API URL</label>
                            <input type="url" id="edit-device-apiurl" value="${device.apiUrl || ''}" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                            <input type="text" id="edit-device-apikey" value="${device.apiKey || ''}" class="w-full border border-gray-300 rounded-md px-3 py-2" required>
                        </div>
                        <div class="flex gap-3">
                            <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md">Kaydet</button>
                            <button type="button" onclick="closeEditDeviceModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">ƒ∞ptal</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modal);
        
        // Form submit handler
        document.getElementById('edit-device-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const updatedDevice = {
                ...device,
                cihazAdi: document.getElementById('edit-device-name').value.trim(),
                phone: document.getElementById('edit-device-phone').value.trim(),
                phoneNumber: document.getElementById('edit-device-phone').value.trim(),
                apiUrl: document.getElementById('edit-device-apiurl').value.trim(),
                apiKey: document.getElementById('edit-device-apikey').value.trim()
            };
            
            const devices = state.collections.settings.devices || [];
            const updatedDevices = devices.map(d => d.id === device.id ? updatedDevice : d);
            
            await saveDevices(updatedDevices);
            state.collections.settings.devices = updatedDevices;
            
            closeEditDeviceModal();
            renderCurrentPage();
            showToast('Cihaz g√ºncellendi');
        });
    }

    function closeEditDeviceModal() {
        const modal = document.querySelector('.fixed.inset-0');
        if (modal) modal.remove();
    }
    function base64ToBlobUrl(base64Data) {
        try {
            // Strip off the data URI scheme if it exists
            const base64String = base64Data.split(',')[1] || base64Data;
            const byteCharacters = atob(base64String);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], {type: 'image/png'});
            return URL.createObjectURL(blob);
        } catch (e) {
            console.error("Base64 to Blob conversion failed:", e);
            return null;
        }
    }


    async function connectDevice(device, isNew = false) {
        if (!isApiConfigured()) return;
        
        // Clear previous intervals if any
        if (state.countdownInterval) clearInterval(state.countdownInterval);
        if (state.qrPollInterval) clearInterval(state.qrPollInterval);

        ModalManager.show({
            title: `Cihaz Baƒülanƒ±yor: ${device.cihazAdi}`,
            width: 'max-w-md',
            body: `<div id="qr-container" class="text-center p-4"><div class="fas fa-spinner fa-spin text-4xl text-gray-500"></div><p class="mt-4 text-gray-600">WhatsApp'tan QR kod bekleniyor...</p></div>`,
            footer: `<button id="modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">ƒ∞ptal</button>`
        });
        document.getElementById('modal-cancel-btn').onclick = ModalManager.hide;
        
        const qrContainer = document.getElementById('qr-container');

        const startCountdown = () => {
            let timeLeft = 60;
            const timerElement = document.createElement('p');
            timerElement.className = "mt-2 text-sm text-gray-500";
            qrContainer.appendChild(timerElement);

            state.countdownInterval = setInterval(() => {
                if (timeLeft > 0) {
                    timerElement.textContent = `Bu kod ${timeLeft} saniye i√ßinde zaman a≈üƒ±mƒ±na uƒürayacak.`;
                    timeLeft--;
                } else {
                    clearInterval(state.countdownInterval);
                    clearInterval(state.qrPollInterval);
                    state.qrPollInterval = null;
                    qrContainer.innerHTML = `
                        <p class="text-red-500 font-medium">QR Kodu zaman a≈üƒ±mƒ±na uƒüradƒ±.</p>
                        <button id="refresh-qr-btn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                            <i class="fas fa-sync-alt mr-2"></i> Yeni Kod Al
                        </button>
                    `;
                    document.getElementById('refresh-qr-btn').onclick = () => connectDevice(device, false);
                }
            }, 1000);
        };

        const updateQrDisplay = (base64) => {
            if (state.currentQrBlobUrl) URL.revokeObjectURL(state.currentQrBlobUrl);
            
            const blobUrl = base64ToBlobUrl(base64);
            if (blobUrl) {
                state.currentQrBlobUrl = blobUrl;
                qrContainer.innerHTML = `
                    <img src="${blobUrl}" class="mx-auto" alt="QR Kodu Y√ºklenemedi">
                    <p class="mt-4 text-gray-600">L√ºtfen WhatsApp ile QR kodu okutun.</p>
                    <p id="qr-countdown" class="mt-2 text-sm text-blue-600">QR kod 20 saniye sonra yenilenecek...</p>
                `;
                
                // Start 20 second countdown
                if (state.countdownInterval) clearInterval(state.countdownInterval);
                let timeLeft = 20;
                state.countdownInterval = setInterval(() => {
                    timeLeft--;
                    const countdownEl = document.getElementById('qr-countdown');
                    if (countdownEl) {
                        if (timeLeft > 0) {
                            countdownEl.textContent = `QR kod ${timeLeft} saniye sonra yenilenecek...`;
                        } else {
                            countdownEl.textContent = `QR kod yenileniyor...`;
                        }
                    }
                    if (timeLeft <= 0) {
                        clearInterval(state.countdownInterval);
                        state.countdownInterval = null;
                    }
                }, 1000);
            } else {
                qrContainer.innerHTML = `<p class="text-red-500">QR Kodu olu≈üturulamadƒ±.</p>`;
            }
        };

        try {
            const createRes = await fetch(`${EVOLUTION_API_URL}/instance/create`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'apikey': EVOLUTION_API_KEY },
                body: JSON.stringify({ 
                    instanceName: device.instanceName, 
                    number: device.phone,
                    owner: device.phone,
                    profileName: device.cihazAdi,
                    qrcode: true,
                    integration: "WHATSAPP-BAILEYS"
                })
            });

            const createData = await createRes.json();
            
            // If instance already exists (409 or 403 with "already in use" message), continue with QR code
            const isAlreadyExists = createRes.status === 409 || 
                                   (createRes.status === 403 && createData.message && 
                                    JSON.stringify(createData.message).includes('already in use'));
            
            if(!createRes.ok && !isAlreadyExists) {
                let errorDetails = `HTTP Durum Kodu: ${createRes.status}`;
                try {
                    errorDetails = createData.message || JSON.stringify(createData.response || createData);
                } catch (e) {
                   errorDetails = await createRes.text();
                }
                throw new Error(`Instance olu≈üturulamadƒ±. Detay: ${errorDetails}`);
            }

            // If instance already exists, fetch QR code from connect endpoint
            if (isAlreadyExists) {
                showToast("Cihaz zaten mevcut, QR kod alƒ±nƒ±yor...", false);
                try {
                    const connectRes = await fetch(`${EVOLUTION_API_URL}/instance/connect/${device.instanceName}`, {
                        method: 'GET',
                        headers: { 'apikey': EVOLUTION_API_KEY }
                    });
                    const connectData = await connectRes.json();
                    if (connectData.base64) {
                        updateQrDisplay(connectData.base64);
                    }
                } catch (e) {
                    console.error("QR fetch error:", e);
                }
            } else if (createData.qrcode && createData.qrcode.base64) {
                 updateQrDisplay(createData.qrcode.base64);
            }

            // Save device immediately with API key
            if (isNew) {
                device.status = 'pending';
                device.apiKey = createData.hash?.apikey || EVOLUTION_API_KEY;
                device.instanceName = device.instanceName;
                device.phone = device.phone;
                const currentDevices = state.collections.settings.devices || [];
                await saveDevices([...currentDevices, device]);
                state.collections.settings.devices = [...currentDevices, device];
            }
            
            let lastBase64 = createData.qrcode?.base64 || '';

            state.qrPollInterval = setInterval(async () => {
                try {
                    // Check connection status using multiple methods like in WhatsApp.html
                    let isConnected = false;
                    
                    // Method 1: Check connection state
                    try {
                        const stateResponse = await fetch(`${EVOLUTION_API_URL}/instance/connectionState/${device.instanceName}`, {
                            method: 'GET',
                            headers: { 'apikey': EVOLUTION_API_KEY }
                        });
                        const stateData = await stateResponse.json();
                        
                        if (stateData.state === 'open' || stateData.instance?.state === 'open') {
                            isConnected = true;
                            // Update device with instance data if available
                            if (stateData.instance && !device.apiKey) {
                                device.apiKey = stateData.instance.apikey || device.apiKey;
                            }
                        }
                    } catch (e) {}
                    
                    // Method 2: Check fetch instances
                    if (!isConnected) {
                        try {
                            const instancesResponse = await fetch(`${EVOLUTION_API_URL}/instance/fetchInstances`, {
                                method: 'GET',
                                headers: { 'apikey': EVOLUTION_API_KEY }
                            });
                            const instances = await instancesResponse.json();
                            
                            if (Array.isArray(instances)) {
                                const instance = instances.find(i => i.instanceName === device.instanceName);
                                if (instance && instance.state === 'open') {
                                    isConnected = true;
                                    // Update device with instance data if available
                                    if (!device.apiKey) {
                                        device.apiKey = instance.apikey || device.apiKey;
                                    }
                                }
                            }
                        } catch (e) {}
                    }
                    
                    if (!document.getElementById('qr-container')) {
                        clearInterval(state.qrPollInterval); 
                        if(state.countdownInterval) clearInterval(state.countdownInterval);
                        return;
                    }

                    if (isConnected) {
                        clearInterval(state.qrPollInterval); state.qrPollInterval = null;
                        if(state.countdownInterval) clearInterval(state.countdownInterval); state.countdownInterval = null;

                        let updatedDevices;
                        const deviceExists = (state.collections.settings.devices || []).some(d => d.id === device.id);

                        // Update device status to connected
                        updatedDevices = state.collections.settings.devices.map(d => {
                            if (d.id === device.id) {
                                const finalApiKey = device.apiKey || d.apiKey || EVOLUTION_API_KEY;
                                return { 
                                    ...d, 
                                    status: 'connected', 
                                    apiKey: finalApiKey,
                                    phone: d.phone || device.phone,
                                    instanceName: d.instanceName || device.instanceName
                                };
                            }
                            return d;
                        });
                        
                        await saveDevices(updatedDevices);
                        
                        // Force UI update
                        state.collections.settings.devices = updatedDevices;
                        renderCurrentPage();

                        ModalManager.hide();
                        showToast(`${device.cihazAdi} ba≈üarƒ±yla baƒülandƒ±!`);
                    } else {
                        const qrRes = await fetch(`${EVOLUTION_API_URL}/instance/connect/${device.instanceName}`, { headers: { 'apikey': EVOLUTION_API_KEY } });
                        const qrData = await qrRes.json();
                        
                        if (qrData.base64 && qrData.base64 !== lastBase64) {
                            lastBase64 = qrData.base64;
                            updateQrDisplay(qrData.base64);
                        }
                    }
                } catch(pollError) {
                    console.error("Polling error:", pollError);
                    clearInterval(state.qrPollInterval);
                    if(state.countdownInterval) clearInterval(state.countdownInterval);
                }
            }, 20000); // Check every 20 seconds
        } catch (error) {
            console.error("Connection error:", error);
            showToast(`Baƒülantƒ± hatasƒ±: ${error.message}`, true);
            ModalManager.hide();
        }
    }
    window.showAddCreditsModal = function(userId) {
        ModalManager.show({
            title: 'Kullanƒ±cƒ±ya Mesaj Hakkƒ± Ekle',
            body: `
                <div class="space-y-4">
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                        <p class="text-blue-700 text-sm">
                            <strong>Kullanƒ±cƒ± ID:</strong> <code class="bg-blue-100 px-2 py-1 rounded text-xs">${userId}</code>
                        </p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Eklenecek Mesaj Hakkƒ±</label>
                        <input type="number" id="add-credits-amount" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="100" min="1" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">A√ßƒ±klama</label>
                        <textarea id="add-credits-note" class="w-full border border-gray-300 rounded-md px-3 py-2" rows="2" placeholder="Mesaj hakkƒ± ekleme nedeni"></textarea>
                    </div>
                </div>
            `,
            footer: `
                <button id="modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">ƒ∞ptal</button>
                <button id="modal-submit-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Ekle</button>
            `,
            onReady: () => {
                document.getElementById('modal-cancel-btn').onclick = ModalManager.hide;
                document.getElementById('modal-submit-btn').onclick = async () => {
                    const credits = parseInt(document.getElementById('add-credits-amount').value);
                    const note = document.getElementById('add-credits-note').value.trim();

                    if (!credits || credits <= 0) {
                        showToast("Ge√ßerli bir miktar girin.", true);
                        return;
                    }

                    try {
                        const userDocRef = doc(state.db, "users", userId);
                        const userDoc = await getDoc(userDocRef);
                        const currentCredits = userDoc.exists() ? (userDoc.data().credits || 0) : 0;
                        const newCredits = currentCredits + credits;

                        await setDoc(userDocRef, {
                            credits: newCredits,
                            lastCreditUpdate: serverTimestamp()
                        }, { merge: true });

                        // Log transaction
                        await addDoc(collection(state.db, "credit_transactions"), {
                            userId: userId,
                            type: 'admin_add',
                            credits: credits,
                            note: note,
                            adminId: state.userId,
                            createdAt: serverTimestamp()
                        });

                        showToast(`${credits} mesaj hakkƒ± eklendi!`);
                        ModalManager.hide();
                        refreshAdminUsers();
                    } catch (error) {
                        console.error("Add credits error:", error);
                        showToast("Mesaj hakkƒ± eklenemedi: " + error.message, true);
                    }
                };
            }
        });
    };

    // --- Navigation & Init ---
    function renderCurrentPage() {
        if (!state.userId) {
            console.log('‚ö†Ô∏è renderCurrentPage: User not logged in');
            return;
        }
        const pageKey = window.location.hash.substring(1) || 'dashboard';
        console.log('üé® Rendering page:', pageKey);
        
        if (pageRenderers[pageKey]) {
            pageRenderers[pageKey]();
        } else {
            console.warn(`‚ö†Ô∏è Page renderer not found for: ${pageKey}, showing dashboard`);
            pageRenderers['dashboard']();
        }
    }
    function handleNavigation() {
        const hash = window.location.hash.substring(1) || 'dashboard';
        console.log('üìç Navigating to:', hash);
        state.currentPage = hash;
        
        // Update active menu item
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.classList.toggle('active', link.getAttribute('href') === `#${hash}`);
        });
        
        // Open dropdown if navigating to template or campaign pages
        const templatePages = ['sablonlar', 'sablon-gruplari'];
        const campaignPages = ['planlanmis', 'devam-eden', 'tamamlanan'];
        
        const templateDropdown = document.querySelector('.dropdown-menu');
        if (templatePages.includes(hash) && templateDropdown) {
            templateDropdown.classList.add('open');
        }
        
        const campaignsDropdown = document.getElementById('campaigns-dropdown');
        if (campaignPages.includes(hash) && campaignsDropdown) {
            campaignsDropdown.classList.add('open');
        }
        
        // Render the page
        renderCurrentPage();
    }
    
    // Initialize dropdown toggle
    function initializeDropdown() {
        // T√ºm dropdown men√ºleri i√ßin toggle ekle
        document.querySelectorAll('.dropdown-menu').forEach(dropdown => {
            const dropdownToggle = dropdown.querySelector('.dropdown-toggle');
            if (dropdownToggle) {
                dropdownToggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    dropdown.classList.toggle('open');
                });
            }
        });
        
        // Kampanya Olu≈ütur butonuna tƒ±klama eventi ekle
        const newCampaignMenuBtn = document.getElementById('new-campaign-menu-btn');
        if (newCampaignMenuBtn) {
            newCampaignMenuBtn.addEventListener('click', (e) => {
                e.preventDefault();
                showCampaignModal();
            });
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        initializeFirebase();
        initializeDropdown(); // Initialize dropdown menu
        document.getElementById('login-btn').addEventListener('click', handleEmailLogin);
        document.getElementById('signup-btn').addEventListener('click', handleEmailSignUp);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        document.getElementById('reset-password-btn').addEventListener('click', handlePasswordReset);

        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const forgotPasswordForm = document.getElementById('forgot-password-form');
        const showSignup = document.getElementById('show-signup');
        const showLogin = document.getElementById('show-login');
        const showForgotPassword = document.getElementById('show-forgot-password');
        const backToLogin = document.getElementById('back-to-login');

        showSignup.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            forgotPasswordForm.classList.add('hidden');
        });

        showLogin.addEventListener('click', (e) => {
            e.preventDefault();
            signupForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            forgotPasswordForm.classList.add('hidden');
        });

        showForgotPassword.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            signupForm.classList.add('hidden');
            forgotPasswordForm.classList.remove('hidden');
        });

        backToLogin.addEventListener('click', (e) => {
            e.preventDefault();
            forgotPasswordForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        });

        // Enter tu≈üu ile form g√∂nderimi
        document.getElementById('login-email').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleEmailLogin();
        });
        document.getElementById('login-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleEmailLogin();
        });
        
        // Signup form enter handlers
        ['signup-name', 'signup-surname', 'signup-phone', 'signup-company', 'signup-email', 'signup-password'].forEach(id => {
            document.getElementById(id).addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleEmailSignUp();
            });
        });
        
        document.getElementById('reset-email').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handlePasswordReset();
        });
    });

    // --- Mesajla≈üma Page ---
    let mesajlasmaState = {
        selectedContact: null,
        contacts: [],
        messages: {},
        loadingMessages: false,
        selectedDevice: null,
        messageListener: null // Firestore listener
    };

    function renderMesajlasma() {
        // Yapƒ±m a≈üamasƒ±nda mesajƒ± g√∂ster
        renderPage('Mesajla≈üma', '', `
            <div class="text-center py-12">
                <div class="w-24 h-24 bg-gradient-to-br from-yellow-500 to-orange-600 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-tools text-3xl text-white"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-3">üöß Yapƒ±m A≈üamasƒ±nda</h3>
                <p class="text-gray-600 mb-4 max-w-md mx-auto">Mesajla≈üma √∂zelliƒüi ≈üu anda geli≈ütirilme a≈üamasƒ±ndadƒ±r.</p>
                <p class="text-sm text-gray-500 max-w-md mx-auto">Yakƒ±nda kullanƒ±ma a√ßƒ±lacaktƒ±r. L√ºtfen daha sonra tekrar kontrol edin.</p>
                <div class="mt-8">
                    <button onclick="navigateToPage('dashboard')" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-home mr-2"></i>Ana Sayfaya D√∂n
                    </button>
                </div>
            </div>
        `);
        return;
        
        /* MESAJLA≈ûMA √ñZELLƒ∞ƒûƒ∞ - GELƒ∞≈ûTƒ∞RME A≈ûAMASINDA
        const devices = state.collections.settings.devices || [];
        
        if (devices.length === 0) {
            renderPage('Mesajla≈üma', '', `
                <div class="text-center py-12">
                    <div class="w-24 h-24 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-mobile-alt text-3xl text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-3">Cihaz Bulunamadƒ±</h3>
                    <p class="text-gray-600 mb-8 max-w-md mx-auto">Mesajla≈üma yapabilmek i√ßin √∂nce bir cihaz eklemeniz gerekiyor.</p>
                    <button onclick="navigateToPage('ayarlar')" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-plus mr-2"></i>Cihaz Ekle
                    </button>
                </div>
            `);
            return;
        }
        */

        // CORS uyarƒ±sƒ± kontrol√º
        if (window.location.protocol === 'file:') {
            renderPage('Mesajla≈üma', '', `
                <div class="text-center py-12">
                    <div class="w-24 h-24 bg-gradient-to-br from-yellow-500 to-orange-600 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-exclamation-triangle text-3xl text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-3">CORS Hatasƒ±</h3>
                    <p class="text-gray-600 mb-6 max-w-md mx-auto">Dosya file:// protokol√º ile a√ßƒ±lƒ±yor. Mesajla≈üma i√ßin HTTP sunucusu gerekiyor.</p>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6 max-w-2xl mx-auto">
                        <h4 class="font-semibold text-yellow-800 mb-3">üöÄ √á√∂z√ºm Y√∂ntemleri:</h4>
                        <div class="text-left space-y-3">
                            <div class="flex items-start">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-semibold mr-3">1</span>
                                <div>
                                    <p class="font-semibold text-gray-800">VS Code Live Server:</p>
                                    <p class="text-sm text-gray-600">VS Code'da "Live Server" extension'ƒ±nƒ± y√ºkleyin ve dosyayƒ± a√ßƒ±n</p>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm font-semibold mr-3">2</span>
                                <div>
                                    <p class="font-semibold text-gray-800">Python HTTP Server:</p>
                                    <p class="text-sm text-gray-600">Terminal'de: <code class="bg-gray-100 px-2 py-1 rounded">python -m http.server</code></p>
                                </div>
                            </div>
                            <div class="flex items-start">
                                <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-sm font-semibold mr-3">3</span>
                                <div>
                                    <p class="font-semibold text-gray-800">Node.js HTTP Server:</p>
                                    <p class="text-sm text-gray-600">Terminal'de: <code class="bg-gray-100 px-2 py-1 rounded">npx http-server</code></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-4 justify-center">
                        <button onclick="navigateToPage('ayarlar')" class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition-all duration-200">
                            <i class="fas fa-cog mr-2"></i>Cihaz Ayarlarƒ±
                        </button>
                        <button onclick="location.reload()" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition-all duration-200">
                            <i class="fas fa-refresh mr-2"></i>Yenile
                        </button>
                    </div>
                </div>
            `);
            return;
        }

        // Modern cihaz se√ßimi
        const deviceSelector = `
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-3">üì± G√∂nderici Cihaz Se√ßin</label>
                <div class="relative">
                    <select id="device-selector" class="w-full appearance-none bg-white border-2 border-gray-200 rounded-xl px-4 py-3 pr-10 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-200 shadow-sm hover:shadow-md">
                        <option value="">Cihaz se√ßin...</option>
                        ${devices.map(device => `
                            <option value="${device.id}" ${mesajlasmaState.selectedDevice === device.id ? 'selected' : ''}>
                                ${device.instanceName} (${device.phoneNumber || device.phone || 'N/A'})
                            </option>
                        `).join('')}
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <i class="fas fa-chevron-down text-gray-400"></i>
                    </div>
                </div>
            </div>
        `;

        // Ki≈üi listesi - API'den y√ºklenecek
        mesajlasmaState.contacts = mesajlasmaState.contacts || [];

        const contactsList = mesajlasmaState.contacts.map(contact => `
            <div class="contact-item p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-all duration-150 ${mesajlasmaState.selectedContact?.id === contact.id ? 'bg-blue-50 border-l-4 border-blue-500' : ''}" 
                 onclick="selectMesajlasmaContact('${contact.id}')">
                <div class="flex items-center">
                    <div class="relative">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-md">
                            ${contact.name.charAt(0).toUpperCase()}
                        </div>
                        ${contact.unread > 0 ? `<div class="absolute -top-1 -right-1 w-5 h-5 bg-green-500 rounded-full flex items-center justify-center text-white text-xs font-bold">${contact.unread}</div>` : ''}
                    </div>
                    <div class="ml-3 flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-1">
                            <div class="font-semibold text-gray-900 truncate">${contact.name}</div>
                            <div class="text-xs text-gray-500 ml-2 flex-shrink-0">${contact.time || ''}</div>
                        </div>
                        <div class="text-sm text-gray-600 truncate">${contact.lastMessage || contact.phone}</div>
                    </div>
                </div>
            </div>
        `).join('');

        const content = `
            <div class="flex h-[700px] border-2 border-gray-200 rounded-2xl overflow-hidden shadow-xl">
                <!-- Sol Panel - Ki≈üi Listesi -->
                <div class="w-1/3 border-r border-gray-200 bg-white">
                    <div class="p-4 border-b border-gray-200 bg-gradient-to-r from-green-50 to-green-100">
                        <h3 class="font-bold text-gray-800 text-lg flex items-center justify-between">
                            <span class="flex items-center">
                                <i class="fas fa-comments mr-2 text-green-600"></i>
                                Sohbetler
                            </span>
                            ${mesajlasmaState.contacts.length > 0 ? `<span class="bg-green-500 text-white px-2.5 py-0.5 rounded-full text-xs font-semibold">${mesajlasmaState.contacts.length}</span>` : ''}
                        </h3>
                    </div>
                    <div class="overflow-y-auto h-full">
                        ${contactsList || `
                            <div class="p-8 text-center text-gray-500">
                                <i class="fas fa-comments text-5xl mb-4 text-gray-300"></i>
                                <p class="font-semibold mb-2">Hen√ºz sohbet yok</p>
                                <p class="text-sm">Cihaz se√ßtikten sonra konu≈ümalar burada g√∂r√ºnecek</p>
                            </div>
                        `}
                    </div>
                </div>
                
                <!-- Saƒü Panel - Mesajla≈üma -->
                <div class="flex-1 flex flex-col bg-gradient-to-br from-gray-50 to-white">
                    ${mesajlasmaState.selectedContact ? `
                        <!-- Mesaj Ba≈ülƒ±ƒüƒ± -->
                        <div class="p-6 border-b border-gray-200 bg-white shadow-sm">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-lg">
                                    ${mesajlasmaState.selectedContact.name.charAt(0).toUpperCase()}
                                </div>
                                <div class="ml-4">
                                    <div class="font-bold text-gray-900 text-lg">${mesajlasmaState.selectedContact.name}</div>
                                    <div class="text-sm text-gray-600">${mesajlasmaState.selectedContact.phone}</div>
                                </div>
                                <div class="ml-auto">
                                    <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mesajlar -->
                        <div id="messages-container" class="flex-1 p-6 overflow-y-auto bg-gradient-to-b from-gray-50 to-white">
                            <div class="text-center text-gray-500 py-12">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-comments text-2xl text-blue-600"></i>
                                </div>
                                <p class="text-lg">Mesajlar y√ºkleniyor...</p>
                            </div>
                        </div>
                        
                        <!-- Mesaj G√∂nderme -->
                        <div class="p-6 border-t border-gray-200 bg-white shadow-lg">
                            <div class="flex space-x-3">
                                <div class="flex-1 relative">
                                    <input type="text" id="message-input" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." 
                                           class="w-full border-2 border-gray-200 rounded-2xl px-4 py-3 pr-12 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-200 shadow-sm hover:shadow-md">
                                    <button id="message-send-btn"
                                            class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-blue-600 hover:bg-blue-700 text-white w-8 h-8 rounded-full flex items-center justify-center transition-all duration-200">
                                        <i class="fas fa-paper-plane text-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="flex-1 flex items-center justify-center bg-gradient-to-br from-gray-50 to-white">
                            <div class="text-center text-gray-500">
                                <div class="w-24 h-24 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <i class="fas fa-comments text-3xl text-white"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-gray-800 mb-3">Mesajla≈ümaya Ba≈ülayƒ±n</h3>
                                <p class="text-lg">Sol panelden bir ki≈üi se√ßin ve sohbete ba≈ülayƒ±n</p>
                            </div>
                        </div>
                    `}
                </div>
            </div>
        `;

        renderPage('Mesajla≈üma', deviceSelector, content);
        
        // Event listeners
        document.getElementById('device-selector').onchange = async (e) => {
            mesajlasmaState.selectedDevice = e.target.value;
            if (mesajlasmaState.selectedDevice) {
                // Cihaz se√ßildiƒüinde konu≈ümalarƒ± y√ºkle
                await loadChats();
                renderMesajlasma();
            }
        };
        
        // Mesaj g√∂nderme event listener'larƒ±
        const messageInput = document.getElementById('message-input');
        const messageSendBtn = document.getElementById('message-send-btn');
        
        if (messageInput && messageSendBtn && mesajlasmaState.selectedContact) {
            messageSendBtn.onclick = () => window.sendMessage();
            messageInput.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    window.sendMessage();
                }
            };
        }
    }

    // Konu≈ümalarƒ± y√ºkle (WhatsApp gibi son mesajla≈üƒ±lanlar)
    async function loadChats() {
        if (!mesajlasmaState.selectedDevice) {
            console.log('‚ùå Cihaz se√ßilmedi');
            return;
        }

        const device = state.collections.settings.devices.find(d => d.id === mesajlasmaState.selectedDevice);
        if (!device || !device.apiUrl || !device.instanceName) {
            console.log('‚ùå Cihaz bilgileri eksik');
            return;
        }

        try {
            console.log('üìû Konu≈ümalar y√ºkleniyor...');
            console.log('üåê API URL:', device.apiUrl);
            console.log('üì± Instance:', device.instanceName);
            
            const apiUrl = `${device.apiUrl}/chat/findChats/${device.instanceName}`;
            console.log('üîó Tam URL:', apiUrl);
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'apikey': device.apiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            });

            if (response.ok) {
                const data = await response.json();
                console.log('üìû Konu≈ümalar API Yanƒ±tƒ±:', data);

                // Konu≈ümalarƒ± parse et
                let chats = [];
                if (Array.isArray(data)) {
                    chats = data;
                } else if (data.chats && Array.isArray(data.chats)) {
                    chats = data.chats;
                } else if (typeof data === 'object') {
                    chats = Object.values(data).filter(item => 
                        item && typeof item === 'object' && item.id
                    );
                }

                console.log('üìû ƒ∞≈ülenmi≈ü konu≈ümalar:', chats);

                // Konu≈ümalarƒ± ki≈üi listesine √ßevir
                mesajlasmaState.contacts = chats.map(chat => {
                    // remoteJid tam WhatsApp ID'si (905551234567@s.whatsapp.net)
                    // chat.id database ID'si, chat.remoteJid ger√ßek WhatsApp ID'si
                    const remoteJid = chat.remoteJid || chat.id || '';
                    
                    // Telefon numarasƒ±nƒ± √ßƒ±kar (@ i≈üaretinden √∂nceki kƒ±sƒ±m)
                    const phone = remoteJid.replace('@s.whatsapp.net', '').replace('@g.us', '');
                    
                    // ƒ∞sim
                    const name = chat.name || chat.pushName || phone;
                    
                    // Son mesaj
                    const lastMessage = chat.lastMessage?.message?.conversation || 
                                      chat.lastMessage?.message?.extendedTextMessage?.text ||
                                      'Mesaj yok';
                    
                    // Zaman
                    const timestamp = chat.lastMessage?.messageTimestamp || chat.conversationTimestamp || Date.now();
                    const time = formatMessageTime(timestamp);
                    
                    // Okunmamƒ±≈ü mesaj sayƒ±sƒ±
                    const unread = chat.unreadCount || 0;

                    return {
                        id: remoteJid, // Tam WhatsApp ID (mesaj √ßekmek i√ßin gerekli)
                        name: name,
                        phone: phone, // Sadece numara (g√∂sterim i√ßin)
                        remoteJid: remoteJid, // Tam WhatsApp ID
                        lastMessage: lastMessage,
                        time: time,
                        unread: unread
                    };
                }).filter(contact => contact.remoteJid && !contact.remoteJid.includes('@g.us')); // Gruplarƒ± filtrele

                console.log('‚úÖ Ki≈üiler y√ºklendi:', mesajlasmaState.contacts.length);
            } else {
                console.log('‚ùå Konu≈ümalar y√ºklenemedi:', response.status);
                showToast(`Konu≈ümalar y√ºklenemedi: HTTP ${response.status}`, true);
            }
        } catch (error) {
            console.log('‚ùå Konu≈üma y√ºkleme hatasƒ±:', error);
            
            // Hata mesajƒ±nƒ± kullanƒ±cƒ±ya g√∂ster
            if (error.message.includes('Failed to fetch')) {
                showToast('API sunucusuna baƒülanƒ±lamadƒ±. L√ºtfen API URL ve internet baƒülantƒ±nƒ±zƒ± kontrol edin.', true);
            } else if (error.message.includes('CORS')) {
                showToast('CORS hatasƒ±. API sunucusu CORS ayarlarƒ±nƒ± kontrol edin.', true);
            } else {
                showToast(`Konu≈üma y√ºkleme hatasƒ±: ${error.message}`, true);
            }
        }
    }

    // Mesaj zamanƒ±nƒ± formatla
    function formatMessageTime(timestamp) {
        if (!timestamp) return '';
        
        const messageDate = new Date(parseInt(timestamp) * 1000);
        const now = new Date();
        const diffMs = now - messageDate;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return '≈ûimdi';
        if (diffMins < 60) return `${diffMins} dk √∂nce`;
        if (diffHours < 24) return `${diffHours} saat √∂nce`;
        if (diffDays === 1) return 'D√ºn';
        if (diffDays < 7) return `${diffDays} g√ºn √∂nce`;
        
        return messageDate.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' });
    }

    // Mesajla≈üma fonksiyonlarƒ±
    window.selectMesajlasmaContact = async function(contactId) {
        mesajlasmaState.selectedContact = mesajlasmaState.contacts.find(c => c.id === contactId);
        if (!mesajlasmaState.selectedContact) return;
        
        // Sayfayƒ± yeniden render et
        renderMesajlasma();
        
        // Mesajlarƒ± y√ºkle
        await loadMessages();
    }

    async function loadMessages() {
        if (!mesajlasmaState.selectedContact || !mesajlasmaState.selectedDevice) {
            console.log('‚ùå Mesaj y√ºkleme hatasƒ±: Se√ßili ki≈üi veya cihaz yok');
            return;
        }
        
        const device = state.collections.settings.devices.find(d => d.id === mesajlasmaState.selectedDevice);
        if (!device) {
            console.log('‚ùå Mesaj y√ºkleme hatasƒ±: Cihaz bulunamadƒ±');
            return;
        }
        
        // √ñnceki listener'ƒ± temizle
        if (mesajlasmaState.messageListener) {
            mesajlasmaState.messageListener();
            mesajlasmaState.messageListener = null;
        }
        
        console.log('üîç Cihaz bilgileri:', {
            id: device.id,
            name: device.cihazAdi,
            apiUrl: device.apiUrl,
            apiKey: device.apiKey ? 'Mevcut' : 'Yok',
            instanceName: device.instanceName
        });
        
        const messagesContainer = document.getElementById('messages-container');
        if (!messagesContainer) return;
        
        // API URL kontrol√º
        if (!device.apiUrl) {
            console.log('‚ùå API URL tanƒ±mlanmamƒ±≈ü');
            messagesContainer.innerHTML = `
                <div class="text-center text-red-500 py-12">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                    </div>
                    <p class="text-lg font-semibold">API URL Tanƒ±mlanmamƒ±≈ü</p>
                    <p class="text-sm text-gray-500">Cihaz ayarlarƒ±ndan API URL'yi tanƒ±mlayƒ±n</p>
                    <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-sm text-yellow-800">
                            <strong>√á√∂z√ºm:</strong> Ayarlar ‚Üí WhatsApp Cihaz Y√∂netimi ‚Üí Cihazƒ± D√ºzenle
                        </p>
                    </div>
                </div>
            `;
            return;
        }
        
        // API Key kontrol√º
        if (!device.apiKey) {
            console.log('‚ùå API Key tanƒ±mlanmamƒ±≈ü');
            messagesContainer.innerHTML = `
                <div class="text-center text-red-500 py-12">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-key text-2xl text-red-600"></i>
                    </div>
                    <p class="text-lg font-semibold">API Key Tanƒ±mlanmamƒ±≈ü</p>
                    <p class="text-sm text-gray-500">Cihaz ayarlarƒ±ndan API Key'i tanƒ±mlayƒ±n</p>
                    <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-sm text-yellow-800">
                            <strong>√á√∂z√ºm:</strong> Ayarlar ‚Üí WhatsApp Cihaz Y√∂netimi ‚Üí Cihazƒ± D√ºzenle
                        </p>
                    </div>
                </div>
            `;
            return;
        }
        
        messagesContainer.innerHTML = `
            <div class="text-center text-gray-500 py-12">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i>
                </div>
                <p class="text-lg">Mesajlar y√ºkleniyor...</p>
            </div>
        `;
        
        try {
            // Firestore'dan mesajlarƒ± ger√ßek zamanlƒ± dinle
            const remoteJid = mesajlasmaState.selectedContact.remoteJid || mesajlasmaState.selectedContact.id;
            const phone = mesajlasmaState.selectedContact.phone;
            
            console.log('üì± Firestore\'dan mesajlar dinleniyor:', phone);
            
            // messages koleksiyonundan bu telefon numarasƒ±na ait mesajlarƒ± getir
            const messagesRef = window.firebase.firestore().collection('messages')
                .where('deviceId', '==', device.id)
                .where('phone', '==', phone)
                .orderBy('timestamp', 'asc')
                .limit(100);
            
            // Ger√ßek zamanlƒ± listener
            mesajlasmaState.messageListener = messagesRef.onSnapshot((snapshot) => {
                const messages = [];
                snapshot.forEach((doc) => {
                    messages.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log('üì® Firestore\'dan mesajlar:', messages.length);
                displayMessages(messages);
            }, (error) => {
                console.error('‚ùå Firestore dinleme hatasƒ±:', error);
                messagesContainer.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-info-circle text-2xl text-yellow-600"></i>
                        </div>
                        <p class="text-lg font-semibold">Hen√ºz mesaj yok</p>
                        <p class="text-sm text-gray-400 mt-2">Yeni mesajlar burada g√∂r√ºnecek</p>
                    </div>
                `;
            });
        } catch (error) {
            console.error('Mesaj y√ºkleme hatasƒ±:', error);
            messagesContainer.innerHTML = `
                <div class="text-center text-gray-500 py-12">
                    <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-info-circle text-2xl text-yellow-600"></i>
                    </div>
                    <p class="text-lg font-semibold">Hen√ºz mesaj yok</p>
                    <p class="text-sm text-gray-400 mt-2">Yeni mesajlar burada g√∂r√ºnecek</p>
                </div>
            `;
        }
    }

    function displayMessages(messages) {
        const messagesContainer = document.getElementById('messages-container');
        if (!messagesContainer) return;
        
        console.log('üí¨ displayMessages √ßaƒürƒ±ldƒ±, mesaj sayƒ±sƒ±:', messages.length);
        
        if (messages.length === 0) {
            messagesContainer.innerHTML = `
                <div class="text-center text-gray-500 py-12">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-comments text-2xl text-green-600"></i>
                    </div>
                    <p class="text-lg font-semibold">Hen√ºz mesaj yok</p>
                    <p class="text-sm text-gray-400">ƒ∞lk mesajƒ± siz g√∂nderin!</p>
                </div>
            `;
            return;
        }
        
        const messagesHtml = messages.map((msg, index) => {
            // Firestore formatƒ±: {text, fromMe, timestamp, phone, deviceId}
            const messageText = msg.text || msg.body || 'Mesaj i√ßeriƒüi yok';
            const isFromMe = msg.fromMe || false;
            
            // Timestamp
            const timestamp = msg.timestamp || Date.now();
            const date = new Date(timestamp);
            const timeString = date.toLocaleTimeString('tr-TR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            return `
                <div class="flex ${isFromMe ? 'justify-end' : 'justify-start'} mb-4">
                    <div class="max-w-xs lg:max-w-md px-4 py-3 rounded-2xl ${isFromMe ? 'bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-lg' : 'bg-white text-gray-800 border border-gray-200 shadow-sm'}">
                        <div class="text-sm leading-relaxed">${messageText}</div>
                        <div class="text-xs mt-2 ${isFromMe ? 'text-blue-100' : 'text-gray-500'}">${timeString}</div>
                    </div>
                </div>
            `;
        }).join('');
        
        messagesContainer.innerHTML = messagesHtml;
        
        // Mesajlarƒ± en alta kaydƒ±r
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Mesaj g√∂nderme fonksiyonu
    window.sendMessage = async function() {
        const messageInput = document.getElementById('message-input');
        const messageText = messageInput.value.trim();
        
        if (!messageText) return;
        if (!mesajlasmaState.selectedContact) return;
        if (!mesajlasmaState.selectedDevice) {
            showToast('L√ºtfen bir cihaz se√ßin', true);
            return;
        }
        
        const device = state.collections.settings.devices.find(d => d.id === mesajlasmaState.selectedDevice);
        if (!device) return;
        
        // API URL kontrol√º
        if (!device.apiUrl) {
            showToast('API URL tanƒ±mlanmamƒ±≈ü', true);
            return;
        }
        
        // CORS kontrol√º
        if (window.location.protocol === 'file:') {
            showToast('CORS Hatasƒ±: HTTP sunucusu kullanƒ±n', true);
            return;
        }
        
        // Mesajƒ± hemen g√∂ster
        const messagesContainer = document.getElementById('messages-container');
        const tempMessage = `
            <div class="flex justify-end mb-4">
                <div class="max-w-xs lg:max-w-md px-4 py-3 rounded-2xl bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-lg">
                    <div class="text-sm leading-relaxed">${messageText}</div>
                    <div class="text-xs mt-2 text-blue-100">G√∂nderiliyor...</div>
                </div>
            </div>
        `;
        messagesContainer.insertAdjacentHTML('beforeend', tempMessage);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Input'u temizle
        messageInput.value = '';
        
        try {
            // Evolution API v2.3 ile mesaj g√∂nder
            const apiUrl = `${device.apiUrl}/message/sendText/${device.instanceName}`;
            const requestBody = {
                number: mesajlasmaState.selectedContact.phone,
                text: messageText
            };
            
            console.log('üì§ Mesaj g√∂nderiliyor:', apiUrl);
            console.log('üì§ Request Body:', requestBody);
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'apikey': device.apiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });
            
            if (response.ok) {
                const data = await response.json();
                showToast('Mesaj g√∂nderildi');
                
                // Firestore'a kaydet
                await window.firebase.firestore().collection('messages').add({
                    deviceId: device.id,
                    phone: mesajlasmaState.selectedContact.phone,
                    text: messageText,
                    fromMe: true,
                    timestamp: Date.now(),
                    createdAt: new Date()
                });
                
                console.log('‚úÖ Mesaj Firestore\'a kaydedildi');
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
        } catch (error) {
            console.error('Mesaj g√∂nderme hatasƒ±:', error);
            let errorMessage = error.message;
            
            if (error.message.includes('CORS')) {
                errorMessage = 'CORS Hatasƒ±: HTTP sunucusu kullanƒ±n';
            } else if (error.message.includes('Failed to fetch')) {
                errorMessage = 'Baƒülantƒ± hatasƒ±: API sunucusuna ula≈üƒ±lamƒ±yor';
            }
            
            showToast('Mesaj g√∂nderilemedi: ' + errorMessage, true);
            
            // Hatalƒ± mesajƒ± kaldƒ±r
            const lastMessage = messagesContainer.lastElementChild;
            if (lastMessage) {
                lastMessage.remove();
            }
        }
    }

    // --- Chat/Messages Page ---
    let chatState = {
        selectedContact: null,
        contacts: [],
        messages: {},
        loadingMessages: false,
        selectedDevice: null
    };

    function renderChat() {
        const devices = state.collections.settings.devices || [];
        
        if (devices.length === 0) {
            renderPage('Chat', '', `
                <div class="text-center py-12">
                    <div class="w-24 h-24 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-mobile-alt text-3xl text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-3">Cihaz Bulunamadƒ±</h3>
                    <p class="text-gray-600 mb-8 max-w-md mx-auto">Chat yapabilmek i√ßin √∂nce bir cihaz eklemeniz gerekiyor.</p>
                    <button onclick="navigateToPage('ayarlar')" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-plus mr-2"></i>Cihaz Ekle
                    </button>
                </div>
            `);
            return;
        }

        // Cihaz se√ßimi
        const deviceSelector = `
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-3">üì± G√∂nderici Cihaz Se√ßin</label>
                <div class="relative">
                    <select id="device-selector" class="w-full appearance-none bg-white border-2 border-gray-200 rounded-xl px-4 py-3 pr-10 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all duration-200 shadow-sm hover:shadow-md">
                        <option value="">Cihaz se√ßin...</option>
                        ${devices.map(device => `
                            <option value="${device.id}" ${chatState.selectedDevice === device.id ? 'selected' : ''}>
                                ${device.instanceName} (${device.phoneNumber || device.phone || 'N/A'})
                            </option>
                        `).join('')}
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <i class="fas fa-chevron-down text-gray-400"></i>
                    </div>
                </div>
            </div>
        `;

        // Ki≈üi listesini gruplardan olu≈ütur
        chatState.contacts = [];
        (state.collections.groups || []).forEach(group => {
            if (group.contacts && Array.isArray(group.contacts)) {
                group.contacts.forEach(contact => {
                    if (contact.phone) {
                        const exists = chatState.contacts.find(c => c.id === contact.phone);
                        if (!exists) {
                            chatState.contacts.push({
                                id: contact.phone,
                                name: contact.name || contact.phone,
                                phone: contact.phone,
                                groupName: group.name,
                                avatar: contact.name ? contact.name.charAt(0).toUpperCase() : contact.phone.slice(-2)
                            });
                        }
                    }
                });
            }
        });

        const contactsList = chatState.contacts.map(contact => `
            <div class="contact-item p-4 border-b border-gray-100 hover:bg-gradient-to-r hover:from-green-50 hover:to-green-100 cursor-pointer transition-all duration-200 ${chatState.selectedContact?.id === contact.id ? 'bg-gradient-to-r from-green-100 to-green-200 border-l-4 border-green-500' : ''}" 
                 onclick="selectChatContact('${contact.id}')">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg">
                        ${contact.avatar}
                    </div>
                    <div class="ml-4 flex-1">
                        <div class="font-semibold text-gray-900 text-lg">${contact.name}</div>
                        <div class="text-sm text-gray-600">${contact.phone}</div>
                        <div class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full inline-block mt-1">${contact.groupName}</div>
                    </div>
                    <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                </div>
            </div>
        `).join('');

        const content = `
            <div class="flex h-[700px] border-2 border-gray-200 rounded-2xl overflow-hidden shadow-xl">
                <!-- Sol Panel - Ki≈üi Listesi -->
                <div class="w-1/3 border-r border-gray-200 bg-gradient-to-b from-gray-50 to-white">
                    <div class="p-6 border-b border-gray-200 bg-white">
                        <h3 class="font-bold text-gray-800 text-xl flex items-center">
                            <i class="fas fa-users mr-2 text-green-600"></i>
                            Ki≈üiler <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-sm ml-2">${chatState.contacts.length}</span>
                        </h3>
                    </div>
                    <div class="overflow-y-auto h-full">
                        ${contactsList || '<div class="p-8 text-center text-gray-500"><i class="fas fa-user-plus text-4xl mb-4"></i><p>Hen√ºz ki≈üi yok</p></div>'}
                            </div>
                                    </div>
                
                <!-- Saƒü Panel - Chat -->
                <div class="flex-1 flex flex-col bg-gradient-to-br from-gray-50 to-white">
                    ${chatState.selectedContact ? `
                        <!-- Chat Ba≈ülƒ±ƒüƒ± -->
                        <div class="p-6 border-b border-gray-200 bg-white shadow-sm">
                            <div class="flex items-center">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-lg">
                                    ${chatState.selectedContact.avatar}
                                </div>
                                <div class="ml-4">
                                    <div class="font-bold text-gray-900 text-lg">${chatState.selectedContact.name}</div>
                                    <div class="text-sm text-gray-600">${chatState.selectedContact.phone}</div>
                            </div>
                                <div class="ml-auto">
                                    <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                                </div>
                    </div>
                </div>
                
                        <!-- Mesajlar -->
                        <div id="chat-messages-container" class="flex-1 p-6 overflow-y-auto bg-gradient-to-b from-gray-50 to-white">
                            <div class="text-center text-gray-500 py-12">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-comments text-2xl text-green-600"></i>
                        </div>
                                <p class="text-lg">Mesajlar y√ºkleniyor...</p>
                            </div>
                        </div>
                        
                        <!-- Mesaj G√∂nderme -->
                        <div class="p-6 border-t border-gray-200 bg-white shadow-lg">
                            <div class="flex space-x-3">
                                <div class="flex-1 relative">
                                    <input type="text" id="chat-render-message-input" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." 
                                           class="w-full border-2 border-gray-200 rounded-2xl px-4 py-3 pr-12 focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-200 transition-all duration-200 shadow-sm hover:shadow-md">
                                    <button id="chat-render-send-btn"
                                            class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-green-600 hover:bg-green-700 text-white w-8 h-8 rounded-full flex items-center justify-center transition-all duration-200">
                                        <i class="fas fa-paper-plane text-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="flex-1 flex items-center justify-center bg-gradient-to-br from-gray-50 to-white">
                            <div class="text-center text-gray-500">
                                <div class="w-24 h-24 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <i class="fas fa-comments text-3xl text-white"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-gray-800 mb-3">Chat'e Ba≈ülayƒ±n</h3>
                                <p class="text-lg">Sol panelden bir ki≈üi se√ßin ve sohbete ba≈ülayƒ±n</p>
                            </div>
                        </div>
                    `}
                </div>
            </div>
        `;

        renderPage('Chat', deviceSelector, content);
        
        // Event listeners
        document.getElementById('device-selector').onchange = (e) => {
            chatState.selectedDevice = e.target.value;
            if (chatState.selectedContact) {
                loadChatMessages();
            }
        };
        
        // Chat mesaj g√∂nderme event listener'larƒ±
        const chatRenderInput = document.getElementById('chat-render-message-input');
        const chatRenderBtn = document.getElementById('chat-render-send-btn');
        
        if (chatRenderInput && chatRenderBtn && chatState.selectedContact) {
            chatRenderBtn.onclick = () => sendChatMessage();
            chatRenderInput.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendChatMessage();
                }
            };
        }
    }

    // API helpers (basic stubs to avoid runtime errors if not configured)
    async function fetchWhatsAppMessages(instanceName, contactPhone) {
        console.log('fetchWhatsAppMessages called', instanceName, contactPhone);
        return [];
    }

    async function sendWhatsAppMessage(instanceName, contactPhone, messageText) {
        console.log('sendWhatsAppMessage called', instanceName, contactPhone, messageText);
        return { ok: true };
    }

    // Chat fonksiyonlarƒ±
    async function selectChatContact(contactId) {
        chatState.selectedContact = chatState.contacts.find(c => c.id === contactId);
        if (!chatState.selectedContact) return;
        
        // Sayfayƒ± yeniden render et
        renderChat();
        
        // Mesajlarƒ± y√ºkle
        await loadChatMessages();
    }

    async function loadChatMessages() {
        if (!chatState.selectedContact || !chatState.selectedDevice) return;
        
        const device = state.collections.settings.devices.find(d => d.id === chatState.selectedDevice);
        if (!device) return;
        
        const messagesContainer = document.getElementById('chat-messages-container');
        if (!messagesContainer) return;
        
        messagesContainer.innerHTML = `
            <div class="text-center text-gray-500 py-12">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-spinner fa-spin text-2xl text-green-600"></i>
                </div>
                <p class="text-lg">Mesajlar y√ºkleniyor...</p>
            </div>
        `;
        
        try {
            // Evo API ile mesajlarƒ± √ßek
            const response = await fetch(`${device.apiUrl}/messages/${chatState.selectedContact.phone}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${device.apiKey}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                displayChatMessages(data.messages || []);
            } else {
                throw new Error('Mesajlar y√ºklenemedi');
            }
        } catch (error) {
            console.error('Mesaj y√ºkleme hatasƒ±:', error);
            messagesContainer.innerHTML = `
                <div class="text-center text-red-500 py-12">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                    </div>
                    <p class="text-lg font-semibold">Mesajlar y√ºklenemedi</p>
                    <p class="text-sm text-gray-500">${error.message}</p>
                </div>
            `;
        }
    }

    function displayChatMessages(messages) {
        const messagesContainer = document.getElementById('chat-messages-container');
        if (!messagesContainer) return;
        
        if (messages.length === 0) {
            messagesContainer.innerHTML = `
                <div class="text-center text-gray-500 py-12">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-comments text-2xl text-green-600"></i>
                    </div>
                    <p class="text-lg font-semibold">Hen√ºz mesaj yok</p>
                    <p class="text-sm text-gray-400">ƒ∞lk mesajƒ± siz g√∂nderin!</p>
                </div>
            `;
            return;
        }
        
        const messagesHtml = messages.map(msg => {
            const isFromMe = msg.fromMe || msg.direction === 'outgoing';
            const timestamp = new Date(msg.timestamp * 1000).toLocaleTimeString('tr-TR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            return `
                <div class="flex ${isFromMe ? 'justify-end' : 'justify-start'} mb-4">
                    <div class="max-w-xs lg:max-w-md px-4 py-3 rounded-2xl ${isFromMe ? 'bg-gradient-to-r from-green-500 to-green-600 text-white shadow-lg' : 'bg-white text-gray-800 border border-gray-200 shadow-sm'}">
                        <div class="text-sm leading-relaxed">${msg.body || msg.message || 'Mesaj i√ßeriƒüi yok'}</div>
                        <div class="text-xs mt-2 ${isFromMe ? 'text-green-100' : 'text-gray-500'}">${timestamp}</div>
                    </div>
                </div>
            `;
        }).join('');
        
        messagesContainer.innerHTML = messagesHtml;
        
        // Mesajlarƒ± en alta kaydƒ±r
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    async function sendChatMessage() {
        const messageInput = document.getElementById('chat-render-message-input');
        if (!messageInput) return;
        
        const messageText = messageInput.value.trim();
        
        if (!messageText) return;
        if (!chatState.selectedContact) return;
        if (!chatState.selectedDevice) {
            showToast('L√ºtfen bir cihaz se√ßin', true);
            return;
        }
        
        const device = state.collections.settings.devices.find(d => d.id === chatState.selectedDevice);
        if (!device) return;
        
        // Mesajƒ± hemen g√∂ster
        const messagesContainer = document.getElementById('chat-messages-container');
        const tempMessage = `
            <div class="flex justify-end mb-4">
                <div class="max-w-xs lg:max-w-md px-4 py-3 rounded-2xl bg-gradient-to-r from-green-500 to-green-600 text-white shadow-lg">
                    <div class="text-sm leading-relaxed">${messageText}</div>
                    <div class="text-xs mt-2 text-green-100">G√∂nderiliyor...</div>
                </div>
            </div>
        `;
        messagesContainer.insertAdjacentHTML('beforeend', tempMessage);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Input'u temizle
        messageInput.value = '';
        
        try {
            // Evo API ile mesaj g√∂nder
            const response = await fetch(`${device.apiUrl}/send-message`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${device.apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    instance: device.instanceName,
                    to: chatState.selectedContact.phone,
                    message: messageText
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                showToast('Mesaj g√∂nderildi');
                
                // Mesajlarƒ± yenile
                setTimeout(() => {
                    loadChatMessages();
                }, 1000);
            } else {
                throw new Error('Mesaj g√∂nderilemedi');
            }
        } catch (error) {
            console.error('Mesaj g√∂nderme hatasƒ±:', error);
            showToast('Mesaj g√∂nderilemedi: ' + error.message, true);
            
            // Hatalƒ± mesajƒ± kaldƒ±r
            const lastMessage = messagesContainer.lastElementChild;
            if (lastMessage) {
                lastMessage.remove();
            }
        }
    }

    async function selectContact(contactId) {
        chatState.selectedContact = chatState.contacts.find(c => c.id === contactId);
        if (!chatState.selectedContact) return;
        
        const mainArea = document.getElementById('chat-main-area');
        if (!mainArea) return;
        
        const contact = chatState.selectedContact;
        
        // Baƒülƒ± cihazƒ± bul
        const connectedDevice = (state.collections.settings.devices || []).find(d => d.status === 'connected');
        
        // Mesajlarƒ± y√ºkle
        mainArea.innerHTML = `
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="chat-header-avatar">${contact.avatar}</div>
                <div class="chat-header-info">
                    <div class="chat-header-name">${contact.name}</div>
                    <div class="chat-header-status">${contact.phone}</div>
                </div>
                <button id="refresh-messages-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded-lg transition-colors" title="Mesajlarƒ± Yenile">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            
            <!-- Messages -->
            <div class="chat-messages" id="chat-messages-container">
                <div style="text-align: center; padding: 20px; color: #667781;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
                    <p style="margin-top: 10px;">Mesajlar y√ºkleniyor...</p>
                </div>
            </div>
            
            <!-- Input Area -->
            <div class="chat-input-container">
                <input type="text" class="chat-input" placeholder="Mesaj yazƒ±n..." id="chat-message-input" ${!connectedDevice ? 'disabled' : ''}>
                <button class="chat-send-btn" id="chat-send-btn" ${!connectedDevice ? 'disabled' : ''}>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        `;
        
        const loadMessages = async () => {
            const messagesContainer = document.getElementById('chat-messages-container');
            if (!messagesContainer) return;
            
            if (!connectedDevice) {
                messagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #f59e0b;">
                        <i class="fas fa-plug" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>Cihaz baƒülƒ± deƒüil</p>
                        <p style="font-size: 13px; margin-top: 8px;">WhatsApp mesajlarƒ±nƒ± g√∂rmek i√ßin bir cihaz baƒülayƒ±n</p>
                    </div>
                `;
                return;
            }
            
            try {
                const messages = await fetchWhatsAppMessages(connectedDevice.instanceName, contact.phone);
                contact.messages = messages;
                
                if (messages.length === 0) {
                    messagesContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #667781;">
                            <i class="far fa-comment-dots" style="font-size: 48px; color: #d1d7db; margin-bottom: 16px;"></i>
                            <p>Hen√ºz mesaj yok</p>
                            <p style="font-size: 13px; margin-top: 8px;">ƒ∞lk mesajƒ± g√∂nderin</p>
                        </div>
                    `;
                } else {
                    messagesContainer.innerHTML = messages.map(msg => `
                        <div class="chat-message ${msg.sent ? 'sent' : 'received'}">
                            <div class="chat-bubble">
                                <div class="chat-bubble-text">${escapeHtml(msg.text)}</div>
                                <div class="chat-bubble-time">
                                    ${msg.time}
                                    ${msg.sent ? `<span class="chat-tick ${msg.read ? 'read' : ''}">‚úì‚úì</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            } catch (error) {
                console.error('Mesaj y√ºkleme hatasƒ±:', error);
                messagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>Mesajlar y√ºklenemedi</p>
                        <p style="font-size: 13px; margin-top: 8px;">${error.message}</p>
                    </div>
                `;
            }
        };
        
        await loadMessages();
        
        document.getElementById('refresh-messages-btn').onclick = loadMessages;
        
        const messageInput = document.getElementById('chat-message-input');
        const sendBtn = document.getElementById('chat-send-btn');
        
        if (messageInput && sendBtn && connectedDevice) {
            const sendMessage = async () => {
                const messageText = messageInput.value.trim();
                if (!messageText) return;
                
                sendBtn.disabled = true;
                
                try {
                    await sendWhatsAppMessage(connectedDevice.instanceName, contact.phone, messageText);
                    messageInput.value = '';
                    await loadMessages();
                } catch (error) {
                    showToast('Mesaj g√∂nderilemedi: ' + error.message, true);
                } finally {
                    sendBtn.disabled = false;
                }
            };
            
            messageInput.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    sendMessage();
                }
            };
            
            sendBtn.onclick = sendMessage;
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

</script>
</body>
</html>