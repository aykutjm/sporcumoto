<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sporcum - Y√∂netim Paneli</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéæ</text></svg>">
    <!-- Firebase -->
    <script type="module">
        // Using a more recent version of Firebase for better performance and security
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, getDoc, updateDoc, deleteDoc, doc, onSnapshot, query, where, orderBy, limit, arrayUnion, arrayRemove, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // IMPORTANT: Replace with your actual Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCytn56Jwtf2tOnftW8MjUtLoH3PgGQnqU",
            authDomain: "uyekayit-5964b.firebaseapp.com",
            projectId: "uyekayit-5964b",
            storageBucket: "uyekayit-5964b.appspot.com",
            messagingSenderId: "493041591853",
            appId: "1:493041591853:web:939cb6494e8469ad133aa4"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        window.db = db;
        window.auth = auth;
        window.firebase = { 
            collection, addDoc, getDocs, getDoc, updateDoc, deleteDoc, doc, onSnapshot, query, where, orderBy, limit, arrayUnion, arrayRemove, setDoc
        };

        // --- GLOBAL STATE ---
        let currentSection = 'dashboard', preRegistrations = [], members = [], schedules = [], groups = [], holidays = [], users = [], attendanceRecords = [], tasks = [], isLoading = false;
        let clubSettings = { 
            clubName: 'Sporcum',
            // ‚úÖ Random bekleme s√ºresi ayarlarƒ±
            minWaitTime: 20,
            maxWaitTime: 50,
            longWaitTrigger: 100,
            minLongWait: 400,
            maxLongWait: 800
        };
        let branches = []; // Bran≈ülar listesi (kul√ºp bazƒ±nda)
        let paymentFilter = 'all'; // Default payment filter
        let selectedBranchForGroups = null;
        let selectedBranchForSchedule = null;
        let currentUser = null;
        let currentClubId = null; // ≈ûu anki kul√ºb√ºn ID'si
        
        // CRM i√ßin global state
        let crmLeads = []; // Potansiyel m√º≈üteriler
        let deletedCalls = []; // Silinen √ßaƒürƒ±lar (localStorage'da saklanƒ±yor - kalƒ±cƒ±)
        let showDeletedCalls = false; // Silinenleri g√∂ster/gizle
        let selectedIncomingCalls = new Set(); // Se√ßili gelen aramalar
        let selectedOutgoingCalls = new Set(); // Se√ßili giden aramalar
        
        // Silinen √ßaƒürƒ±larƒ± localStorage'dan y√ºkle
        function loadDeletedCalls() {
            try {
                const stored = localStorage.getItem(`deletedCalls_${currentClubId}`);
                if (stored) {
                    deletedCalls = JSON.parse(stored);
                }
            } catch (error) {
                console.error('Silinen √ßaƒürƒ±lar y√ºklenirken hata:', error);
                deletedCalls = [];
            }
        }
        
        // Silinen √ßaƒürƒ±larƒ± localStorage'a kaydet
        function saveDeletedCalls() {
            try {
                localStorage.setItem(`deletedCalls_${currentClubId}`, JSON.stringify(deletedCalls));
            } catch (error) {
                console.error('Silinen √ßaƒürƒ±lar kaydedilirken hata:', error);
            }
        }
        let crmTemplates = []; // CRM mesaj ≈üablonlarƒ±
        let crmStatuses = [
            { id: 'new', name: 'Yeni', icon: 'üÜï', color: '#4CAF50' },
            { id: 'contacted', name: 'ƒ∞leti≈üime Ge√ßildi', icon: 'üìû', color: '#2196F3' },
            { id: 'trial', name: 'Deneme Randevusu', icon: 'üéæ', color: '#FF9800' },
            { id: 'negotiating', name: 'G√∂r√º≈üme A≈üamasƒ±nda', icon: 'üí¨', color: '#9C27B0' },
            { id: 'converted', name: '√úye Oldu', icon: '‚úÖ', color: '#4CAF50' },
            { id: 'lost', name: 'Kayƒ±p', icon: '‚ùå', color: '#F44336' }
        ];
        let ageSortDirection = 'none'; // 'none', 'asc', 'desc'
        let membersCurrentPage = 1;
        let membersItemsPerPage = 10;
        let whatsappDevices = []; // WhatsApp devices stored in Firebase
        let defaultWhatsAppDevice = null; // Default device for notifications
        let sentMessages = []; // Message history
        let userActivities = []; // User activity logs
        let incomingMessages = []; // Incoming WhatsApp messages from webhook
        let autoRefreshInterval = null; // Auto-refresh interval
        let lastMessageSentTime = 0; // ‚úÖ Track last message sent time for rate limiting
        let totalMessagesSent = 0; // ‚úÖ Track total messages sent in session for long wait triggers
        
        // ‚úÖ Cache functions for ultra-fast loading
        function applyDataFromCache(data) {
            preRegistrations = data.preRegistrations || [];
            members = data.members || [];
            schedules = data.schedules || [];
            groups = data.groups || [];
            holidays = data.holidays || [];
            users = data.users || [];
            attendanceRecords = data.attendanceRecords || [];
            clubSettings = data.clubSettings || {};
            tasks = data.tasks || [];
            whatsappDevices = data.whatsappDevices || [];
            defaultWhatsAppDevice = data.defaultWhatsAppDevice || null;
            sentMessages = data.sentMessages || [];
            userActivities = data.userActivities || [];
            branches = data.branches || [];
            incomingMessages = data.incomingMessages || [];
            crmLeads = data.crmLeads || [];
            hiddenCalls = data.hiddenCalls || [];
            
            // UI g√ºncelle
            const clubName = clubSettings.clubName || currentUser.clubName || 'Sporcum';
            document.getElementById('club-title').textContent = clubName;
            const clubTitleHeader = document.getElementById('club-title-header');
            if (clubTitleHeader) clubTitleHeader.textContent = `${clubName} - Y√∂netim Paneli`;
            document.title = `${clubName} - Y√∂netim Paneli`;
            
            updateBranchDropdowns();
            updateCRMMenuVisibility();
            renderCurrentSection();
            
            // Dashboard'ƒ± hemen g√ºncelle (cache'ten veri geldiƒüinde)
            if (currentSection === 'dashboard') {
                updateDashboard();
            }
        }
        
        function updateCRMMenuVisibility() {
            // CRM men√ºs√º her zaman g√∂r√ºn√ºr - Eri≈üim kontrol√º i√ßerikte yapƒ±lacak
            const crmMenuDropdown = document.getElementById('crm-menu-dropdown');
            if (crmMenuDropdown) {
                crmMenuDropdown.style.display = 'block';
            }
        }
        
        function saveDataToCache() {
            const cacheKey = `clubData_${currentClubId}`;
            const data = {
                timestamp: Date.now(),
                preRegistrations,
                members,
                schedules,
                groups,
                holidays,
                users,
                attendanceRecords,
                clubSettings,
                tasks,
                whatsappDevices,
                defaultWhatsAppDevice,
                sentMessages,
                userActivities,
                branches,
                incomingMessages,
                crmLeads,
                hiddenCalls
            };
            
            try {
                localStorage.setItem(cacheKey, JSON.stringify(data));
                console.log('üíæ Data cached successfully');
            } catch (e) {
                console.warn('‚ö†Ô∏è Cache save error:', e);
                if (e.name === 'QuotaExceededError') {
                    // Storage full, temizle
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('clubData_') && key !== cacheKey) {
                            localStorage.removeItem(key);
                        }
                    }
                }
            }
        }


        // --- AUTHENTICATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            // ‚úÖ Check if user came from giris.html with valid session
            const sessionUser = sessionStorage.getItem('currentUser');
            const userType = sessionStorage.getItem('userType');
            
            if (sessionUser && userType === 'admin') {
                // User logged in from giris.html, skip login screen
                try {
                    currentUser = JSON.parse(sessionUser);
                    currentClubId = currentUser.clubId; // Set club ID from user data
                    
                    if (!currentClubId) {
                        alert('‚ùå Bu kullanƒ±cƒ± bir kul√ºbe atanmamƒ±≈ü! L√ºtfen SuperAdmin ile ileti≈üime ge√ßin.');
                        sessionStorage.clear();
                        window.location.replace('giris');
                        return;
                    }
                    
                    console.log('‚úÖ Session found, auto-login:', currentUser.email || currentUser.fullName);
                    console.log('üè¢ Club ID:', currentClubId, '- Club Name:', currentUser.clubName);
                    
                    // ‚úÖ Sayfayƒ± g√∂r√ºn√ºr yap (login ekranƒ± atlandƒ±)
                    document.body.style.visibility = 'visible';
                    
                    // Start app directly (no login overlay needed)
                    startApp();
                    return;
                } catch (error) {
                    console.error('Session parse error:', error);
                    sessionStorage.clear();
                }
            }
            
            // ‚ùå No valid session, redirect to login page (sayfayƒ± g√∂stermeden!)
            console.log('‚ùå No valid admin session found, redirecting to giris...');
            sessionStorage.clear();
            window.location.replace('giris');
        });


        function handleLogout() {
            console.log('üö™ Logging out...');
            
            // Stop auto-refresh
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('‚úÖ Auto-refresh stopped');
            }
            
            // Clear cache for this club
            if (currentClubId) {
                const cacheKey = `clubData_${currentClubId}`;
                localStorage.removeItem(cacheKey);
                console.log('‚úÖ Cache cleared');
            }
            
            // Clear ALL storage
            sessionStorage.clear();
            console.log('‚úÖ Storage cleared');
            
            currentUser = null;
            currentClubId = null;
            
            // Force redirect to login page
            console.log('‚úÖ Redirecting to login...');
            window.location.replace('giris');
        }

        async function startApp() {
            if (!window.firebase || !window.db) return showAlert('Firebase baƒülantƒ±sƒ± kurulamadƒ±.', 'danger');
            
            console.log('üöÄ Starting app...');
            const appStartTime = performance.now();
            
            // Display user name safely
            const displayName = currentUser?.fullName || currentUser?.email || 'Y√∂netici';
            document.querySelector('.current-user-display').textContent = `Ho≈ügeldiniz, ${displayName}`;
            
            applyRolePermissions();
            
            // ‚úÖ Paralel y√ºkleme - kritik veriler
            await Promise.all([
                loadData(),
                loadMessageTemplates(),
                loadClubInfo()
            ]);
            
            setupEventListeners();
            // Initial setup for the form
            toggleParentStudentFields(document.getElementById('preRegistrationForm'));
            
            // Bildirim izni iste ve otomatik kontrol√º ba≈ülat
            requestNotificationPermission();
            startMissedCallsAutoCheck();
            
            // S√ºresi dolmu≈ü gizli √ßaƒürƒ±larƒ± temizle (ba≈ülangƒ±√ßta ve her 1 saatte bir)
            // Not: Gizli √ßaƒürƒ± temizleme sistemi kaldƒ±rƒ±ldƒ±
            
            // Dashboard ve CRM istatistik g√∂r√ºn√ºrl√ºƒü√ºn√º kontrol et
            checkDashboardAmountsVisibility();
            checkPaymentVisibility();
            
            // WhatsApp otomatik ba≈ülat (ilk y√ºkleme bildirimi i√ßin)
            autoStartWhatsApp();
            
            const appEndTime = performance.now();
            const appLoadTime = (appEndTime - appStartTime).toFixed(2);
            console.log(`üéâ App ready in ${appLoadTime}ms`);
        }
        
        // WhatsApp'ƒ± otomatik ba≈ülat (connected cihaz varsa)
        async function autoStartWhatsApp() {
            // Kƒ±sa bir gecikme ile cihazlarƒ±n y√ºklenmesini bekle
            setTimeout(async () => {
                if (whatsappDevices && whatsappDevices.length > 0) {
                    // Connected cihaz bul
                    const connectedDevice = whatsappDevices.find(d => d.status === 'connected');
                    
                    if (connectedDevice) {
                        console.log('üì± WhatsApp otomatik ba≈ülatƒ±lƒ±yor:', connectedDevice.instanceName);
                        
                        // Cihazƒ± se√ß
                        selectedWhatsAppDevice = connectedDevice;
                        
                        // üî• Firebase realtime listeners ba≈ülat (√∂ncelik - anlƒ±k bildirimler)
                        if (window.startWhatsAppRealtimeListeners) {
                            startWhatsAppRealtimeListeners();
                            console.log('üî• WhatsApp realtime listeners ba≈ülatƒ±ldƒ±');
                        }
                        
                        // Kontaktlarƒ± y√ºkle (bu ilk y√ºkleme bildirimi tetikleyecek)
                        await loadWhatsAppContacts();
                        
                        // ‚è±Ô∏è Fallback polling ba≈ülat (10 saniyede bir)
                        if (window.startWhatsAppAutoRefresh) {
                            startWhatsAppAutoRefresh();
                            console.log('‚è±Ô∏è WhatsApp fallback polling ba≈ülatƒ±ldƒ±');
                        }
                        
                        console.log('‚úÖ WhatsApp otomatik ba≈ülatƒ±ldƒ± ve bildirimler hazƒ±r');
                    } else {
                        console.log('‚ÑπÔ∏è Baƒülƒ± WhatsApp cihazƒ± yok, bildirimler devre dƒ±≈üƒ±');
                    }
                } else {
                    console.log('‚ÑπÔ∏è WhatsApp cihazƒ± bulunamadƒ±');
                }
            }, 500);
        }
        
        function setupEventListeners() {
            // ‚úÖ √áƒ±kƒ±≈ü butonu
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
                console.log('‚úÖ Logout button initialized');
            }
            
            // ‚úÖ Sidebar logout button
            const logoutBtnSidebar = document.getElementById('logout-btn-sidebar');
            if (logoutBtnSidebar) {
                logoutBtnSidebar.addEventListener('click', handleLogout);
            }
            
            document.getElementById('preRegistrationForm').addEventListener('submit', (e) => handleRegistration(e, 'pending'));
            
            document.getElementById('paymentForm').addEventListener('submit', handlePayment);
            document.getElementById('newScheduleForm').addEventListener('submit', handleNewSchedule);
            document.getElementById('groupForm').addEventListener('submit', handleGroup);
            document.getElementById('memberEditForm').addEventListener('submit', handleMemberUpdate);
            document.getElementById('preRegEditForm').addEventListener('submit', handlePreRegUpdate);
            document.getElementById('attendanceForm').addEventListener('submit', handleAttendanceSubmit);
            document.getElementById('settingsForm').addEventListener('submit', handleSettingsUpdate);
            document.getElementById('userForm').addEventListener('submit', handleUserSubmit);
            document.getElementById('userEditForm').addEventListener('submit', handleUserUpdate);
            document.getElementById('taskForm').addEventListener('submit', handleTaskSubmit);
            document.getElementById('taskMessageForm').addEventListener('submit', sendTaskMessage);
            document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);
            // WhatsApp instance form moved to devices tab
            const whatsappInstanceForm = document.getElementById('whatsappInstanceForm-new');
            if (whatsappInstanceForm) {
                whatsappInstanceForm.addEventListener('submit', handleWhatsAppInstanceCreate);
            }
            
            document.getElementById('memberTypePre').addEventListener('change', () => toggleParentStudentFields(document.getElementById('preRegistrationForm')));
            
            document.getElementById('memberSearch').addEventListener('input', () => {
                membersCurrentPage = 1;
                renderMembersTable();
            });
            document.getElementById('paymentSearch').addEventListener('input', () => renderPaymentsList());
            document.getElementById('groupSearch').addEventListener('input', () => renderGroupsList());

            document.querySelector('#userForm [name="phone"]').addEventListener('input', (e) => {
                const phone = e.target.value.replace(/\D/g, '');
                e.target.value = phone;
                document.querySelector('#userForm [name="username"]').value = phone;
            });
            
            document.querySelector('#userEditForm [name="phone"]').addEventListener('input', (e) => {
                const phone = e.target.value.replace(/\D/g, '');
                e.target.value = phone;
            });
            
            document.querySelector('#profileForm [name="phone"]').addEventListener('input', (e) => {
                const phone = e.target.value.replace(/\D/g, '');
                e.target.value = phone;
            });
            
            // --- Searchable Group Dropdown Logic ---
            const preRegBranchSelect = document.getElementById('preRegBranchPre');
            const groupSearchInput = document.getElementById('preRegGroupSearch');
            const groupHiddenInput = document.getElementById('preRegGroupId');
            const groupResultsContainer = document.getElementById('preRegGroupResults');
            let availableGroupsForSearch = [];

            preRegBranchSelect.addEventListener('change', (e) => {
                const branch = e.target.value;
                groupSearchInput.value = '';
                groupHiddenInput.value = '';
                groupResultsContainer.innerHTML = '';
                if(branch) {
                    const actualGroups = groups.filter(g => {
                         const memberCount = members.filter(m => (g.members || []).includes(m.id) && m.status !== 'expired').length;
                         return g.branch === branch && memberCount < g.maxMembers;
                    });
                    availableGroupsForSearch = actualGroups;
                    groupSearchInput.disabled = false;
                    groupSearchInput.placeholder = "Grup ara...";
                } else {
                    availableGroupsForSearch = [];
                    groupSearchInput.disabled = true;
                    groupSearchInput.placeholder = "√ñnce bran≈ü se√ßin";
                }
            });

            groupSearchInput.addEventListener('input', () => {
                const searchTerm = groupSearchInput.value.toLowerCase();
                groupHiddenInput.value = ''; // Clear hidden ID if user types again
                const filtered = availableGroupsForSearch.filter(g => g.groupName.toLowerCase().includes(searchTerm));
                
                groupResultsContainer.innerHTML = filtered.length > 0 ? filtered.map(g => {
                    const memberCount = members.filter(m => (g.members || []).includes(m.id) && m.status !== 'expired').length;
                    return `<div class="searchable-select-item" data-id="${g.id}" data-name="${g.groupName}">${g.groupName} - (${memberCount}/${g.maxMembers})</div>`
                }).join('') : '<div class="searchable-select-item disabled">Sonu√ß bulunamadƒ±</div>';
                groupResultsContainer.classList.add('active');
            });

            groupResultsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('searchable-select-item') && e.target.dataset.id) {
                    groupHiddenInput.value = e.target.dataset.id;
                    groupSearchInput.value = e.target.dataset.name;
                    groupResultsContainer.classList.remove('active');
                }
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.searchable-select-container')) {
                    groupResultsContainer.classList.remove('active');
                }
            });

            // Generic setup for form inputs
            const form = document.getElementById('preRegistrationForm');
            form.querySelector('[name="phone"]').addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '');
            });
            form.querySelector('[name="phone2"]').addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '');
            });
            const previewInputs = ['firstPeriodStart', 'firstPeriodEnd', 'firstInstallmentAmount', 'firstDueDate', 'installments', 'subsequentInstallmentAmount', 'dueDay', 'firstLessonCount'];
            previewInputs.forEach(id => {
                const element = form.querySelector(`[name=${id}]`);
                if(element) element.addEventListener('input', () => previewPaymentPlan(form));
            });
            const dateInputs = ['firstPeriodStart', 'firstPeriodEnd'];
            dateInputs.forEach(id => {
                form.querySelector(`[name=${id}]`).addEventListener('change', () => autoCalculateLessonCount(form));
            });
            const today = getTodayString();
            form.querySelector('[name="firstPeriodStart"]').value = today;
            form.querySelector('[name="firstDueDate"]').value = today;

            // Set max date for birth date fields (today)
            const studentBirthDatePre = document.getElementById('studentBirthDatePre');
            if (studentBirthDatePre) studentBirthDatePre.setAttribute('max', today);
            
            const studentBirthdates = document.querySelectorAll('.student-birthdate');
            studentBirthdates.forEach(field => field.setAttribute('max', today));

            // Currency formatting listeners
            document.querySelector('#preRegistrationForm [name="firstInstallmentAmount"]').addEventListener('input', (e) => formatCurrency(e.target));
            document.querySelector('#preRegistrationForm [name="subsequentInstallmentAmount"]').addEventListener('input', (e) => formatCurrency(e.target));
            document.querySelector('#paymentForm [name="paymentAmount"]').addEventListener('input', (e) => formatCurrency(e.target));


            // Close modal on outside click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });
            
            // Close actions menu on outside click
            document.addEventListener('click', (e) => closeAllMenus(e));
            
            // WhatsApp forms
            const whatsappNewForm = document.getElementById('whatsappInstanceForm-new');
            if (whatsappNewForm) {
                whatsappNewForm.addEventListener('submit', handleWhatsAppInstanceCreate);
            }
            
            const whatsappSendForm = document.getElementById('whatsappSendMessageForm');
            if (whatsappSendForm) {
                whatsappSendForm.addEventListener('submit', handleWhatsAppSendMessage);
            }
            
            const bulkMessageForm = document.getElementById('bulkMessageForm');
            if (bulkMessageForm) {
                bulkMessageForm.addEventListener('submit', handleBulkMessageSend);
            }
            
            const contactSearch = document.getElementById('contact-search');
            if (contactSearch) {
                contactSearch.addEventListener('input', (e) => {
                    renderWhatsAppContactsList(e.target.value);
                });
            }
            
            const bulkBranchSelector = document.getElementById('bulk-branch-selector');
            if (bulkBranchSelector) {
                bulkBranchSelector.addEventListener('change', onBulkBranchChange);
            }
        }

        // ‚úÖ Pasif √ºyeleri gruplardan otomatik temizle
        async function cleanupExpiredMembersFromGroups() {
            try {
                const expiredMemberIds = members.filter(m => m.status === 'expired').map(m => m.id);
                if (expiredMemberIds.length === 0) return;
                
                let updatedGroupsCount = 0;
                
                for (const group of groups) {
                    if (!group.members || group.members.length === 0) continue;
                    
                    const originalMemberCount = group.members.length;
                    const cleanedMembers = group.members.filter(memberId => !expiredMemberIds.includes(memberId));
                    
                    if (cleanedMembers.length < originalMemberCount) {
                        await window.firebase.updateDoc(
                            window.firebase.doc(window.db, 'groups', group.id),
                            { members: cleanedMembers }
                        );
                        updatedGroupsCount++;
                        group.members = cleanedMembers; // Update local cache
                        console.log(`üßπ Grup "${group.groupName}"dan ${originalMemberCount - cleanedMembers.length} pasif √ºye temizlendi`);
                    }
                }
                
                if (updatedGroupsCount > 0) {
                    console.log(`‚úÖ Toplamda ${updatedGroupsCount} gruptan pasif √ºyeler temizlendi`);
                }
            } catch (error) {
                console.error('‚ùå Pasif √ºyeleri temizlerken hata:', error);
            }
        }

        // Sessiz yenileme - deƒüi≈üiklik varsa yenile
        async function checkAndRefreshIfNeeded() {
            try {
                const currentClubId = window.currentClubId;
                if (!currentClubId) return;
                
                // Mevcut veri sayƒ±larƒ±nƒ± sakla
                const oldCounts = {
                    members: members.length,
                    preRegistrations: preRegistrations.length,
                    crmLeads: crmLeads.length
                };
                
                // Firestore'dan g√ºncel sayƒ±larƒ± al (sessizce)
                const [membersSnapshot, preRegsSnapshot, crmLeadsSnapshot] = await Promise.all([
                    getDocs(query(collection(window.db, 'members'), where('clubId', '==', currentClubId))),
                    getDocs(query(collection(window.db, 'preRegistrations'), where('clubId', '==', currentClubId))),
                    getDocs(query(collection(window.db, 'crmLeads'), where('clubId', '==', currentClubId)))
                ]);
                
                const newCounts = {
                    members: membersSnapshot.size,
                    preRegistrations: preRegsSnapshot.size,
                    crmLeads: crmLeadsSnapshot.size
                };
                
                // Deƒüi≈üiklik var mƒ± kontrol et
                const hasChanges = 
                    oldCounts.members !== newCounts.members ||
                    oldCounts.preRegistrations !== newCounts.preRegistrations ||
                    oldCounts.crmLeads !== newCounts.crmLeads;
                
                if (hasChanges) {
                    console.log('üîÑ Veri deƒüi≈üikliƒüi tespit edildi, yenileniyor...');
                    await loadData(false); // Cache kullanmadan yenile
                    
                    // Mesaj kuyruƒüunu i≈üle
                    await processMessageQueue();
                    
                    // Mevcut section'ƒ± yenile
                    renderCurrentSection();
                } else {
                    console.log('‚úì Veri deƒüi≈üikliƒüi yok');
                }
            } catch (error) {
                console.error('Sessiz yenileme hatasƒ±:', error);
            }
        }

        async function loadData(useCache = true) {
            if (isLoading) return;
            isLoading = true;
            
            if (!currentClubId) {
                console.error('‚ùå No club ID found!');
                alert('Kul√ºp bilgisi bulunamadƒ±! L√ºtfen tekrar giri≈ü yapƒ±n.');
                handleLogout();
                return;
            }
            
            const startTime = performance.now();
            
            // ‚úÖ CACHE CHECK - Anƒ±nda y√ºkleme!
            if (useCache) {
                const cacheKey = `clubData_${currentClubId}`;
                const cachedData = localStorage.getItem(cacheKey);
                if (cachedData) {
                    try {
                        const data = JSON.parse(cachedData);
                        const cacheAge = Date.now() - (data.timestamp || 0);
                        
                        // Cache 5 dakikadan yeniyse kullan
                        if (cacheAge < 300000) { // 5 minutes
                            console.log('‚ö° Loading from cache...');
                            applyDataFromCache(data);
                            
                            const cacheTime = performance.now() - startTime;
                            console.log(`üí® Data loaded from cache in ${cacheTime.toFixed(2)}ms`);
                            
                            isLoading = false;
                            
                            // Arka planda fresh data y√ºkle
                            setTimeout(() => loadData(false), 1000);
                            return;
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Cache parse error:', e);
                    }
                }
            }
            
            try {
                console.log('üìä Loading fresh data for club:', currentClubId);
                const { getDocs, query, collection, orderBy, doc, getDoc, where } = window.firebase;
                
                // ‚úÖ T√ºm query'lere clubId filtresi eklendi (orderBy kaldƒ±rƒ±ldƒ± - manuel sƒ±ralama)
                const queries = [
                    getDocs(query(collection(window.db, 'preRegistrations'), where('clubId', '==', currentClubId))),
                    getDocs(query(collection(window.db, 'members'), where('clubId', '==', currentClubId))),
                    getDocs(query(collection(window.db, 'schedules'), where('clubId', '==', currentClubId))),
                    getDocs(query(collection(window.db, 'groups'), where('clubId', '==', currentClubId))),
                    getDoc(doc(window.db, 'settings', `holidays_${currentClubId}`)), // Kul√ºp bazƒ±nda
                    getDocs(query(collection(window.db, 'users'), where('clubId', '==', currentClubId))),
                    getDocs(query(collection(window.db, 'attendance'), where('clubId', '==', currentClubId))),
                    getDoc(doc(window.db, 'settings', `club_${currentClubId}`)), // Kul√ºp bazƒ±nda
                    getDocs(query(collection(window.db, 'tasks'), where('clubId', '==', currentClubId))),
                    getDocs(query(collection(window.db, 'whatsappDevices'), where('clubId', '==', currentClubId))),
                    getDoc(doc(window.db, 'settings', `whatsapp_${currentClubId}`)), // Kul√ºp bazƒ±nda
                    getDocs(query(collection(window.db, 'sentMessages'), where('clubId', '==', currentClubId))),
                    getDocs(query(collection(window.db, 'userActivities'), where('clubId', '==', currentClubId))),
                    getDoc(doc(window.db, 'settings', `branches_${currentClubId}`)), // Kul√ºp bazƒ±nda
                    getDocs(query(collection(window.db, 'incomingMessages'), where('clubId', '==', currentClubId))),
                    getDocs(query(collection(window.db, 'crmLeads'), where('clubId', '==', currentClubId))), // CRM Leads
                    getDoc(doc(window.db, 'clubs', currentClubId)) // Club info for CRM status
                ];
                
                const results = await Promise.all(queries);

                preRegistrations = results[0].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Manuel sƒ±ralama (Firebase index gerektirmemek i√ßin)
                preRegistrations.sort((a, b) => {
                    const dateA = new Date(a.createdAt || 0);
                    const dateB = new Date(b.createdAt || 0);
                    return dateB - dateA; // Yeniden eskiye
                });
                
                members = results[1].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Manuel sƒ±ralama (Firebase index gerektirmemek i√ßin)
                members.sort((a, b) => {
                    const dateA = new Date(a.registrationDate || a.createdAt || 0);
                    const dateB = new Date(b.registrationDate || b.createdAt || 0);
                    return dateB - dateA; // Yeniden eskiye
                });
                
                // ‚úÖ Debug: Yeni kayƒ±tlarƒ± g√∂ster
                const newMembers = members.filter(m => {
                    const memberAge = Date.now() - new Date(m.createdAt || 0).getTime();
                    return memberAge < 60000; // Son 1 dakika i√ßinde
                });
                if (newMembers.length > 0) {
                    console.log('üÜï Yeni √ºyeler (son 1 dakika):', newMembers.length);
                    newMembers.forEach(m => {
                        console.log(`  - ${m.fullName || m.Ad_Soyad} (${m.status || 'no status'}) - Kaynak: ${m.source || 'bilinmiyor'}`);
                    });
                }
                
                schedules = results[2].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                groups = results[3].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const holidaysDoc = results[4];
                holidays = holidaysDoc.exists() ? holidaysDoc.data().off_days || [] : [];
                
                users = results[5].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                attendanceRecords = results[6].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // ‚úÖ Kul√ºp bazƒ±nda ayarlar
                const clubSettingsDoc = results[7];
                if (clubSettingsDoc.exists()) {
                    clubSettings = clubSettingsDoc.data();
                } else {
                    // ƒ∞lk kez, kul√ºpten gelen bilgileri kullan
                    clubSettings = {
                        clubName: currentUser.clubName || 'Sporcum',
                        clubId: currentClubId
                    };
                    await window.firebase.setDoc(window.firebase.doc(window.db, 'settings', `club_${currentClubId}`), clubSettings);
                }
                
                // ‚úÖ Kul√ºp bilgisini clubs collection'dan al (CRM durumu i√ßin)
                const clubDoc = results[16];
                console.log('üìÑ Club document check:', clubDoc ? 'exists' : 'not exists', 'Club ID:', currentClubId);
                
                if (clubDoc && clubDoc.exists && clubDoc.exists()) {
                    const clubData = clubDoc.data();
                    // ‚úÖ Varsayƒ±lan olarak CRM aktif (sadece a√ßƒ±k√ßa false ise pasif)
                    clubSettings.crmEnabled = clubData.crmEnabled !== false;
                    console.log('‚úÖ CRM durumu y√ºklendi:', clubSettings.crmEnabled, 'Club data:', clubData);
                } else {
                    // Eƒüer clubs collection'da yoksa, varsayƒ±lan true (aktif)
                    clubSettings.crmEnabled = true;
                    console.log('‚ö†Ô∏è Club document bulunamadƒ± (ID:', currentClubId, '), CRM varsayƒ±lan olarak aktif');
                    
                    // Settings'teki bilgiyi de kontrol et
                    if (clubSettingsDoc.exists()) {
                        const settingsData = clubSettingsDoc.data();
                        if (settingsData.crmEnabled !== undefined) {
                            clubSettings.crmEnabled = settingsData.crmEnabled !== false;
                            console.log('‚úÖ CRM durumu settings\'ten y√ºklendi:', clubSettings.crmEnabled);
                        }
                    }
                }
                const clubName = clubSettings.clubName || currentUser.clubName || 'Sporcum';
                document.getElementById('club-title').textContent = clubName;
                const clubTitleHeader = document.getElementById('club-title-header');
                if (clubTitleHeader) clubTitleHeader.textContent = `${clubName} - Y√∂netim Paneli`;
                document.title = `${clubName} - Y√∂netim Paneli`;

                tasks = results[8].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Manuel sƒ±ralama (Firebase index gerektirmemek i√ßin)
                tasks.sort((a, b) => {
                    const dateA = new Date(a.createdAt || 0);
                    const dateB = new Date(b.createdAt || 0);
                    return dateB - dateA; // Yeniden eskiye
                });
                
                // ‚úÖ WhatsApp cihazlarƒ± (kul√ºp bazƒ±nda)
                whatsappDevices = results[9].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('‚úÖ Loaded WhatsApp devices for this club:', whatsappDevices.length);
                
                // WhatsApp config (kul√ºp bazƒ±nda)
                const whatsappConfigDoc = results[10];
                if (whatsappConfigDoc.exists()) {
                    defaultWhatsAppDevice = whatsappConfigDoc.data().defaultDevice || null;
                }
                
                sentMessages = results[11].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Manuel sƒ±ralama (Firebase index gerektirmemek i√ßin)
                sentMessages.sort((a, b) => {
                    const dateA = new Date(a.sentAt || 0);
                    const dateB = new Date(b.sentAt || 0);
                    return dateB - dateA; // Yeniden eskiye
                });
                sentMessages = sentMessages.slice(0, 50); // Son 50 mesaj
                
                userActivities = results[12].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Manuel sƒ±ralama (Firebase index gerektirmemek i√ßin)
                userActivities.sort((a, b) => {
                    const dateA = new Date(a.timestamp || 0);
                    const dateB = new Date(b.timestamp || 0);
                    return dateB - dateA; // Yeniden eskiye
                });
                
                // ‚úÖ Bran≈ülar (kul√ºp bazƒ±nda) - VARSAYILAN BRAN≈û YOK!
                const branchesDoc = results[13];
                if (branchesDoc.exists()) {
                    branches = branchesDoc.data().list || [];
                    
                    // ‚úÖ Mevcut bran≈ülara courts ekle (eƒüer yoksa)
                    let needsUpdate = false;
                    branches = branches.map(b => {
                        if (!b.courts) {
                            needsUpdate = true;
                            return { ...b, courts: [] };
                        }
                        return b;
                    });
                    
                    // Eƒüer g√ºncelleme gerekiyorsa kaydet
                    if (needsUpdate) {
                        await window.firebase.setDoc(window.firebase.doc(window.db, 'settings', `branches_${currentClubId}`), { 
                            list: branches,
                            clubId: currentClubId
                        });
                    }
                } else {
                    // Bo≈ü ba≈üla, kullanƒ±cƒ± kendi bran≈ülarƒ±nƒ± ekleyecek
                    branches = [];
                    await window.firebase.setDoc(window.firebase.doc(window.db, 'settings', `branches_${currentClubId}`), { 
                        list: branches,
                        clubId: currentClubId
                    });
                }
                
                // ‚úÖ Gelen mesajlar (kul√ºp bazƒ±nda)
                incomingMessages = results[14].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Manuel sƒ±ralama (Firebase index gerektirmemek i√ßin)
                incomingMessages.sort((a, b) => {
                    const dateA = new Date(a.timestamp || 0);
                    const dateB = new Date(b.timestamp || 0);
                    return dateB - dateA; // Yeniden eskiye
                });
                
                // ‚úÖ CRM Leads (kul√ºp bazƒ±nda)
                crmLeads = results[15].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Manuel sƒ±ralama (Firebase index gerektirmemek i√ßin)
                crmLeads.sort((a, b) => {
                    const dateA = new Date(a.createdAt || 0);
                    const dateB = new Date(b.createdAt || 0);
                    return dateB - dateA; // Yeniden eskiye
                });
                
                console.log('‚úÖ Loaded data summary:');
                console.log('  - Members:', members.length);
                console.log('  - Groups:', groups.length);
                console.log('  - Branches:', branches.length);
                console.log('  - Pre-registrations:', preRegistrations.length);
                console.log('  - CRM Leads:', crmLeads.length);
                
                // ‚úÖ Pasif √ºyeleri gruplardan otomatik temizle
                await cleanupExpiredMembersFromGroups();
                
                // ‚úÖ CRITICAL: Bran≈ü dropdown'larƒ±nƒ± hemen g√ºncelle
                updateBranchDropdowns();
                
                // ‚úÖ CRITICAL: CRM men√º g√∂r√ºn√ºrl√ºƒü√ºn√º g√ºncelle
                updateCRMMenuVisibility();
                
                // ‚úÖ CRITICAL: Mevcut sekmeyi render et
                renderCurrentSection();
                
                // ‚úÖ CACHE: Fresh data'yƒ± cache'e kaydet
                if (!useCache) {
                    saveDataToCache();
                }
                
                // ‚úÖ NON-CRITICAL: Sessiz otomatik yenileme - deƒüi≈üiklik varsa yenile
                if (!autoRefreshInterval) {
                    setTimeout(() => {
                        autoRefreshInterval = setInterval(async () => {
                            await checkAndRefreshIfNeeded();
                        }, 60000); // 60 seconds
                        console.log('‚úÖ Sessiz otomatik yenileme ba≈ülatƒ±ldƒ± (her 60 saniyede)');
                    }, 5000); // 5 saniye sonra ba≈ülat
                }
                
                // ‚úÖ Mesaj kuyruƒüunu ilk kez y√ºkle
                setTimeout(() => {
                    renderMessageQueue();
                    processMessageQueue(); // ƒ∞lk kontrol
                }, 3000);
                
                // ‚úÖ NON-CRITICAL: Doƒüum g√ºn√º kontrol√ºn√º lazy load
                setTimeout(() => {
                    checkAndSendBirthdayMessages();
                    
                    // Her g√ºn saat 9'da kontrol et
                    setInterval(() => {
                        const now = new Date();
                        if (now.getHours() === 9 && now.getMinutes() === 0) {
                            console.log('üéÇ Running daily birthday check...');
                            checkAndSendBirthdayMessages();
                        }
                    }, 60000); // Check every minute
                }, 10000); // 10 saniye sonra ba≈ülat
                
            } catch (error) {
                console.error('Veri y√ºklenirken hata:', error);
                showAlert('Veri y√ºklenirken hata olu≈ütu', 'danger');
            } finally { 
                isLoading = false;
                const endTime = performance.now();
                const loadTime = (endTime - startTime).toFixed(2);
                console.log(`‚ö° Data loaded in ${loadTime}ms`);
                
                // Yava≈ü y√ºkleme uyarƒ±sƒ±
                if (loadTime > 3000) {
                    console.warn(`‚ö†Ô∏è Slow loading detected: ${loadTime}ms (should be < 3000ms)`);
                }
                
                // Silinen √ßaƒürƒ±larƒ± localStorage'dan y√ºkle
                loadDeletedCalls();
            }
        }
        
        // ‚úÖ T√ºm bran≈ü dropdown'larƒ±nƒ± g√ºncelle
        function updateBranchDropdowns() {
            const branchOptions = '<option value="">Se√ßiniz...</option>' + 
                branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
            
            // 1. Kayƒ±t formundaki bran≈ü dropdown
            const preRegBranchSelect = document.getElementById('preRegBranchPre');
            if (preRegBranchSelect) {
                const currentValue = preRegBranchSelect.value;
                preRegBranchSelect.innerHTML = branchOptions;
                if (currentValue) preRegBranchSelect.value = currentValue;
            }
            
            // 2. Toplu mesaj bran≈ü se√ßimi (kul√ºp bazƒ±nda)
            const bulkBranchSelector = document.getElementById('bulk-branch-selector');
            if (bulkBranchSelector) {
                const currentValue = bulkBranchSelector.value;
                // Sadece bu kul√ºb√ºn bran≈ülarƒ±nƒ± g√∂ster
                const clubBranches = branches.filter(b => !b.clubId || b.clubId === currentClubId);
                bulkBranchSelector.innerHTML = '<option value="">Bran≈ü se√ßin...</option>' + 
                    clubBranches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('') + 
                    '<option value="all">‚ú® T√ºm Bran≈ülar</option>';
                if (currentValue) bulkBranchSelector.value = currentValue;
                console.log('‚úÖ Toplu mesaj bran≈ü dropdown g√ºncellendi:', clubBranches.length, 'bran≈ü');
            }
            
            // 3. Aktivite filtresi
            const activityBranchFilter = document.getElementById('activityBranchFilter');
            if (activityBranchFilter) {
                const currentValue = activityBranchFilter.value;
                activityBranchFilter.innerHTML = '<option value="all">T√ºm Bran≈ülar</option>' + 
                    branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
                if (currentValue) activityBranchFilter.value = currentValue;
            }
            
            // 4. Grup formu bran≈ü se√ßimleri (birden fazla olabilir)
            document.querySelectorAll('select[name="branch"]').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = branchOptions;
                if (currentValue) select.value = currentValue;
            });
            
            console.log('‚úÖ T√ºm dropdown\'lar g√ºncellendi:', branches.length, 'bran≈ü');
        }
        
        function renderCurrentSection() {
            // ‚úÖ Otomatik yenileyicileri durdur
            stopMembersAutoRefresh();
            
            // ‚úÖ CRM Eri≈üim Kontrol√º - √ñnce sections objesini kontrol et
            console.log('üîç renderCurrentSection:', currentSection, 'CRM Enabled:', clubSettings.crmEnabled);
            
            // CRM aktif deƒüilse ve CRM section'larƒ±ndan birine eri≈ümeye √ßalƒ±≈üƒ±yorsa
            if ((currentSection === 'crm' || currentSection.startsWith('crm-')) && clubSettings.crmEnabled !== true) {
                console.log('‚ö†Ô∏è CRM aktif deƒüil, bilgilendirme mesajƒ± g√∂steriliyor');
                
                // T√ºm section'larƒ± gizle
                document.querySelectorAll('.section').forEach(sec => sec.style.display = 'none');
                
                // CRM section'ƒ±nƒ± g√∂ster ve mesajƒ± yaz
                let crmSection = document.getElementById('crm');
                if (crmSection) {
                    crmSection.style.display = 'block';
                    crmSection.innerHTML = `
                        <div style="display: flex; justify-content: center; align-items: center; min-height: 400px;">
                            <div style="text-align: center; max-width: 500px; padding: 40px; background: #fff3cd; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                <div style="font-size: 64px; margin-bottom: 20px;">üîí</div>
                                <h2 style="color: #856404; margin-bottom: 15px;">CRM Mod√ºl√º Aktif Deƒüil</h2>
                                <p style="font-size: 16px; color: #856404; margin-bottom: 20px;">
                                    CRM mod√ºl√ºn√º kullanmak i√ßin l√ºtfen ileti≈üime ge√ßiniz.
                                </p>
                                <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
                                    <a href="tel:03623630063" style="font-size: 24px; color: #007bff; text-decoration: none; font-weight: bold;">
                                        üìû 0362 363 00 63
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                }
                return;
            }
            
            const sections = {
                dashboard: updateDashboard, 
                'registration-procedures': () => {
                    renderPreRegistrationTable();
                    renderInactiveMembersTable();
                },
                members: renderMembersTable, 
                payments: renderPaymentsList,
                schedule: renderScheduleGrid, 
                groups: renderGroupsList,
                tasks: renderTasksPage,
                whatsapp: renderWhatsAppPage,
                crm: () => {
                    renderCRMDashboard();
                    renderCRMLeads();
                    loadCRMTags();
                },
                'crm-filter': () => {
                    // Bran≈ü filtresini doldur
                    const branchFilter = document.getElementById('filter-branch');
                    if (branchFilter) {
                        branchFilter.innerHTML = '<option value="all">T√ºm Bran≈ülar</option>' +
                            branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
                    }
                    loadCRMTags();
                },
                'crm-trials': () => {
                    // Bran≈ü filtresini doldur
                    const branchFilter = document.getElementById('trial-branch-filter');
                    if (branchFilter) {
                        branchFilter.innerHTML = '<option value="all">T√ºm Bran≈ülar</option>' +
                            branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
                    }
                    renderTrials();
                },
                'crm-tags': () => {
                    loadCRMTags();
                },
                'crm-templates': renderCRMTemplatesPage,
                'crm-incoming-calls': () => {
                    renderIncomingCallsPage();
                    // Gelen aramalar otomatik yenileme ba≈ülat
                    if (window.startIncomingCallsAutoRefresh) {
                        startIncomingCallsAutoRefresh();
                    }
                },
                'crm-outgoing-calls': renderOutgoingCallsPage,
                settings: renderSettings,
                'attendance-tracking': renderAllAbsences,
                'user-activities': renderUserActivitiesPage,
                'inactive-members': loadInactiveMembers,
                'campaigns': renderCampaignsPage,
                'members': () => {
                    renderMembersTable();
                    startMembersAutoRefresh();
                }
            };
            if (sections[currentSection]) {
                if (typeof sections[currentSection] === 'function') {
                    sections[currentSection]();
                }
            }
        }
        
        function renderAllAbsences() {
            const container = document.getElementById('attendance-content');
            const titleEl = document.getElementById('header-title-attendance');
            
            if (!container) return;
            
            titleEl.textContent = 'üìã T√ºm Devamsƒ±zlƒ±klar';
            
            const allAbsences = attendanceRecords.filter(rec => rec.status === 'absent').sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allAbsences.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>Devamsƒ±zlƒ±k kaydƒ± bulunmuyor.</h3></div>';
                return;
            }
            
            container.innerHTML = `
                <div class="card">
                    <h3 class="card-title">Toplam ${allAbsences.length} Devamsƒ±zlƒ±k Kaydƒ±</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>√ñƒürenci</th>
                                    <th>Telefon</th>
                                    <th>Tarih</th>
                                    <th>Sebep</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allAbsences.map(absence => {
                                    const member = members.find(m => m.id === absence.memberId);
                                    if (!member) return '';
                                    const memberName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad;
                                    return `
                                        <tr style="cursor: pointer;" onclick="showMemberAttendancePage('${member.id}')">
                                            <td><strong>${memberName}</strong></td>
                                            <td>${member.Telefon}</td>
                                            <td>${formatDate(absence.date)}</td>
                                            <td>${absence.reason || '<i>Sebep belirtilmedi</i>'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // User Activities Page
        function renderUserActivitiesPage() {
            const searchInput = document.getElementById('activitySearch');
            const branchFilter = document.getElementById('activityBranchFilter');
            
            // Setup event listeners
            if (searchInput) {
                searchInput.removeEventListener('input', filterActivities);
                searchInput.addEventListener('input', filterActivities);
            }
            if (branchFilter) {
                branchFilter.removeEventListener('change', filterActivities);
                branchFilter.addEventListener('change', filterActivities);
            }
            
            filterActivities();
        }
        
        function filterActivities() {
            const searchText = document.getElementById('activitySearch')?.value.toLowerCase() || '';
            const selectedBranch = document.getElementById('activityBranchFilter')?.value || 'all';
            
            let filtered = userActivities;
            
            // Filter by search text
            if (searchText) {
                const searchNoSpaces = searchText.replace(/\s/g, '');
                filtered = filtered.filter(activity => 
                    activity.memberName?.toLowerCase().includes(searchText) ||
                    activity.phone?.toLowerCase().includes(searchText) ||
                    activity.phone?.replace(/\s/g, '').includes(searchNoSpaces)
                );
            }
            
            // Filter by branch
            if (selectedBranch !== 'all') {
                filtered = filtered.filter(activity => activity.branch === selectedBranch);
            }
            
            displayActivitiesTable(filtered);
        }
        
        function displayActivitiesTable(activities) {
            const container = document.getElementById('activitiesTableContainer');
            
            if (!activities || activities.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>Kullanƒ±cƒ± hareketi bulunmuyor.</h3></div>';
                return;
            }
            
            const tableHtml = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Tarih/Saat</th>
                                <th>ƒ∞sim</th>
                                <th>Telefon</th>
                                <th>Bran≈ü</th>
                                <th>Tip</th>
                                <th>Hareket</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${activities.map(activity => {
                                const date = new Date(activity.timestamp);
                                const formattedDate = date.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                                const formattedTime = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                                const branchIcon = activity.branch === 'tenis' ? 'üéæ' : activity.branch === 'yuzme' ? 'üèä' : '';
                                const activityType = activity.type === 'staff' ? 'üë®‚Äçüíº Personel' : 'üë§ √úye';
                                const displayName = activity.memberName || activity.staffName || 'Bilinmiyor';
                                
                                return `
                                    <tr>
                                        <td>${formattedDate} ${formattedTime}</td>
                                        <td><strong>${displayName}</strong></td>
                                        <td><a href="#" class="phone-link" onclick="handlePhoneClick(event, '${activity.phone}')">${activity.phone || '-'}</a></td>
                                        <td>${branchIcon} ${capitalize(activity.branch || '-')}</td>
                                        <td><span class="status-badge ${activity.type === 'staff' ? 'status-pending' : 'status-active'}">${activityType}</span></td>
                                        <td><span class="status-badge status-active">${activity.activity}</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        }
        
        async function refreshUserActivities() {
            try {
                const { getDocs, query, collection, orderBy } = window.firebase;
                const activitiesSnapshot = await getDocs(query(collection(window.db, 'userActivities'), orderBy('timestamp', 'desc')));
                userActivities = activitiesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filterActivities();
                showAlert('Kullanƒ±cƒ± hareketleri g√ºncellendi.', 'success');
            } catch (error) {
                console.error('Error refreshing activities:', error);
                showAlert('Hareketler y√ºklenirken hata olu≈ütu.', 'danger');
            }
        }
        
        window.refreshUserActivities = refreshUserActivities;

        // ‚úÖ Sidebar Toggle Function
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.toggle('collapsed');
                // LocalStorage'a kaydet
                const isCollapsed = sidebar.classList.contains('collapsed');
                localStorage.setItem('sidebarCollapsed', isCollapsed);
            }
        }
        
        window.toggleSidebar = toggleSidebar;
        
        // Sayfa y√ºklendiƒüinde sidebar durumunu geri y√ºkle
        document.addEventListener('DOMContentLoaded', () => {
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (isCollapsed) {
                document.querySelector('.sidebar')?.classList.add('collapsed');
            }
        });

        async function showSection(sectionId, element) {
            // ‚úÖ CRM yetkisi kontrol√º - isSuperAdmin VEYA view_crm yetkisi varsa eri≈üebilir
            if (sectionId === 'crm' && currentUser && currentUser.permissions && !currentUser.isSuperAdmin && !currentUser.permissions.view_crm) {
                showAlert('Bu b√∂l√ºme eri≈üim yetkiniz yok.', 'danger');
                return;
            }

            // √ñnceki section'dan √ßƒ±karken temizlik yap
            if (currentSection === 'crm-incoming-calls' && sectionId !== 'crm-incoming-calls') {
                // Gelen aramalar otomatik yenileme durdur
                if (window.stopIncomingCallsAutoRefresh) {
                    stopIncomingCallsAutoRefresh();
                }
            }

            currentSection = sectionId;
            console.log('üìç Switching to section:', sectionId);
            
            // T√ºm section'larƒ± gizle ve nav butonlarƒ±nƒ± pasif yap
            document.querySelectorAll('.section').forEach(s => {
                s.classList.remove('active');
                s.style.display = 'none';
            });
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            // G√∂sterilecek section'ƒ± bul ve g√∂ster
            const sectionToShow = document.getElementById(sectionId);
            if(sectionToShow) {
                sectionToShow.classList.add('active');
                sectionToShow.style.display = 'block';
            } else {
                console.warn('‚ö†Ô∏è Section not found:', sectionId);
            }
            if (element) element.classList.add('active');
            
            // WhatsApp section'a girildiƒüinde √∂zel i≈ülem yapma
            // (Bildirimler artƒ±k otomatik √ßalƒ±≈üƒ±yor)
            
            renderCurrentSection();
        }
        
        function renderBranchesTable() {
            const tbody = document.getElementById('branchesTable');
            if (!tbody) return;
            
            if (branches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Hen√ºz bran≈ü eklenmemi≈ü.</td></tr>';
                return;
            }
            
            tbody.innerHTML = branches.map(branch => {
                const courtsList = (branch.courts && branch.courts.length > 0) 
                    ? branch.courts.map(c => c.name).join(', ') 
                    : '<span style="color: #999;">-</span>';
                    
                return `
                    <tr>
                        <td style="font-size: 28px; text-align: center;">${branch.icon}</td>
                        <td><code>${branch.id}</code></td>
                        <td><strong>${branch.name}</strong></td>
                        <td>${branch.lessonName}</td>
                        <td>${courtsList}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editBranch('${branch.id}')" style="margin-right: 5px;">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteBranch('${branch.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        window.addBranch = async function(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const idInput = form.querySelector('[name="branchId"]');
            const isEditing = idInput.getAttribute('data-editing') === 'true';
            
            console.log('üîµ addBranch √ßaƒürƒ±ldƒ±, editing mode:', isEditing);
            
            // ‚úÖ Eƒüer d√ºzenleme modundaysa, saveBranchEdit √ßaƒüƒ±r
            if (isEditing) {
                console.log('‚û°Ô∏è saveBranchEdit √ßaƒürƒ±lƒ±yor...');
                return await saveBranchEdit(event);
            }
            
            console.log('‚û°Ô∏è Yeni bran≈ü ekleme modu');
            const branchId = formData.get('branchId').toLowerCase().trim();
            
            const icon = formData.get('branchIcon').trim();
            
            // ‚úÖ Sahalarƒ± al (virg√ºlle ayrƒ±lmƒ±≈ü)
            const courtsInput = formData.get('branchCourts').trim();
            const courts = courtsInput ? courtsInput.split(',').map((c, idx) => ({
                id: idx + 1,
                name: c.trim()
            })).filter(c => c.name) : [];
            
            const newBranch = {
                id: branchId,
                name: formData.get('branchName').trim(),
                icon: icon || '‚öΩ', // ‚úÖ ƒ∞kon opsiyonel - varsayƒ±lan emoji
                lessonName: formData.get('branchLessonName').trim(),
                courts: courts // ‚úÖ Sahalar
            };
            
            // Check if branch ID already exists
            if (branches.find(b => b.id === newBranch.id)) {
                showAlert('Bu bran≈ü ID zaten mevcut!', 'danger');
                return;
            }
            
            try {
                branches.push(newBranch);
                // ‚úÖ Kul√ºp bazƒ±nda kaydet
                await window.firebase.setDoc(window.firebase.doc(window.db, 'settings', `branches_${currentClubId}`), { 
                    list: branches,
                    clubId: currentClubId
                });
                showAlert('‚úÖ Bran≈ü ba≈üarƒ±yla eklendi!', 'success');
                form.reset();
                renderBranchesTable();
                
                // ‚úÖ T√ºm verileri yeniden y√ºkle ki bran≈ülar her yerde g√∂r√ºns√ºn
                await loadData();
            } catch (error) {
                console.error('Error adding branch:', error);
                showAlert('‚ùå Bran≈ü eklenirken hata olu≈ütu!', 'danger');
            }
        };
        
        // ‚úÖ Formu temizle ve yeni ekleme moduna ge√ß
        window.resetBranchForm = function() {
            const form = document.getElementById('branchForm');
            form.reset();
            
            const idInput = form.querySelector('[name="branchId"]');
            idInput.readOnly = false;
            idInput.style.backgroundColor = '';
            idInput.style.cursor = '';
            idInput.removeAttribute('data-editing');
            
            document.getElementById('branchFormTitle').textContent = '‚ûï Yeni Bran≈ü Ekle';
            document.getElementById('branchSubmitBtn').innerHTML = '‚ûï Ekle';
        };
        
        window.editBranch = async function(branchId) {
            const branch = branches.find(b => b.id === branchId);
            if (!branch) return;
            
            // ‚úÖ Modal ile d√ºzenleme (daha kullanƒ±cƒ± dostu)
            const form = document.getElementById('branchForm');
            form.reset();
            
            // Form alanlarƒ±nƒ± doldur
            const idInput = form.querySelector('[name="branchId"]');
            idInput.value = branch.id;
            form.querySelector('[name="branchName"]').value = branch.name;
            form.querySelector('[name="branchIcon"]').value = branch.icon || '';
            form.querySelector('[name="branchLessonName"]').value = branch.lessonName;
            
            // Sahalar (virg√ºlle ayrƒ±lmƒ±≈ü string)
            const courtsStr = (branch.courts || []).map(c => c.name).join(', ');
            form.querySelector('[name="branchCourts"]').value = courtsStr;
            
            // ‚úÖ ID alanƒ±nƒ± readonly yap (disabled deƒüil, √ß√ºnk√º disabled form submit'te gelmez)
            idInput.readOnly = true;
            idInput.style.backgroundColor = '#f0f0f0';
            idInput.style.cursor = 'not-allowed';
            idInput.setAttribute('data-editing', 'true'); // ‚úÖ D√ºzenleme flag'i
            
            // ‚úÖ Ba≈ülƒ±k ve butonu deƒüi≈ütir
            document.getElementById('branchFormTitle').textContent = '‚úèÔ∏è Bran≈ü D√ºzenle';
            document.getElementById('branchSubmitBtn').innerHTML = 'üíæ G√ºncelle';
            
            // Forma scroll yap
            form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // ƒ∞lk input'a focus
            form.querySelector('[name="branchName"]').focus();
        };
        
        window.saveBranchEdit = async function(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const branchId = formData.get('branchId');
            console.log('üíæ saveBranchEdit √ßaƒürƒ±ldƒ±, branchId:', branchId);
            
            const branch = branches.find(b => b.id === branchId);
            if (!branch) {
                console.error('‚ùå Bran≈ü bulunamadƒ±:', branchId);
                showAlert('Bran≈ü bulunamadƒ±!', 'danger');
                return;
            }
            
            console.log('‚úÖ Bran≈ü bulundu, g√ºncelleniyor...', branch);
            
            const icon = formData.get('branchIcon').trim();
            const courtsInput = formData.get('branchCourts').trim();
            const courts = courtsInput ? courtsInput.split(',').map((c, idx) => ({
                id: idx + 1,
                name: c.trim()
            })).filter(c => c.name) : [];
            
            try {
                const index = branches.findIndex(b => b.id === branchId);
                branches[index] = {
                    ...branches[index],
                    name: formData.get('branchName').trim(),
                    icon: icon || '‚öΩ',
                    lessonName: formData.get('branchLessonName').trim(),
                    courts: courts
                };
                
                // ‚úÖ Kul√ºp bazƒ±nda kaydet
                await window.firebase.setDoc(window.firebase.doc(window.db, 'settings', `branches_${currentClubId}`), { 
                    list: branches,
                    clubId: currentClubId
                });
                showAlert('‚úÖ Bran≈ü ba≈üarƒ±yla g√ºncellendi!', 'success');
                
                // ‚úÖ Formu temizle ve normal moda √ßevir
                const idInput = form.querySelector('[name="branchId"]');
                idInput.readOnly = false;
                idInput.style.backgroundColor = '';
                idInput.style.cursor = '';
                idInput.removeAttribute('data-editing');
                
                form.reset();
                renderBranchesTable();
                
                // ‚úÖ Ba≈ülƒ±k ve butonu geri al
                document.getElementById('branchFormTitle').textContent = '‚ûï Yeni Bran≈ü Ekle';
                document.getElementById('branchSubmitBtn').innerHTML = '‚ûï Ekle';
                
                // ‚úÖ T√ºm verileri yeniden y√ºkle
                await loadData();
            } catch (error) {
                console.error('Error updating branch:', error);
                showAlert('‚ùå Bran≈ü g√ºncellenirken hata olu≈ütu!', 'danger');
            }
        };
        
        window.deleteBranch = async function(branchId) {
            if (!confirm(`"${branchId}" bran≈üƒ±nƒ± silmek istediƒüinizden emin misiniz?\n\nDikkat: Bu bran≈üa ait gruplar ve √ºyeler etkilenebilir!`)) {
                return;
            }
            
            try {
                branches = branches.filter(b => b.id !== branchId);
                // ‚úÖ Kul√ºp bazƒ±nda kaydet
                await window.firebase.setDoc(window.firebase.doc(window.db, 'settings', `branches_${currentClubId}`), { 
                    list: branches,
                    clubId: currentClubId
                });
                showAlert('‚úÖ Bran≈ü ba≈üarƒ±yla silindi!', 'success');
                renderBranchesTable();
                
                // ‚úÖ T√ºm verileri yeniden y√ºkle
                await loadData();
            } catch (error) {
                console.error('Error deleting branch:', error);
                showAlert('‚ùå Bran≈ü silinirken hata olu≈ütu!', 'danger');
            }
        };
        
        async function loadClubInfo() {
            try {
                const { getDoc, doc } = window.firebase;
                const clubInfoDoc = await getDoc(doc(window.db, 'settings', `clubInfo_${currentClubId}`));
                
                if (clubInfoDoc.exists()) {
                    const data = clubInfoDoc.data();
                    
                    // Populate form
                    document.getElementById('clubInfoName').value = data.clubName || '';
                    document.getElementById('clubIcon').value = data.clubIcon || '';
                    document.getElementById('clubDescription').value = data.clubDescription || '';
                    document.getElementById('clubAddress').value = data.clubAddress || '';
                    document.getElementById('clubCity').value = data.clubCity || '';
                    document.getElementById('clubPhone').value = data.clubPhone || '';
                    document.getElementById('clubEmail').value = data.clubEmail || '';
                    document.getElementById('clubWebsite').value = data.clubWebsite || '';
                    document.getElementById('clubInstagram').value = data.clubInstagram || '';
                    document.getElementById('clubFacebook').value = data.clubFacebook || '';
                    document.getElementById('clubTwitter').value = data.clubTwitter || '';
                    document.getElementById('clubFounded').value = data.clubFounded || '';
                    document.getElementById('clubTimezone').value = data.clubTimezone || 'Europe/Istanbul';
                    document.getElementById('clubCurrency').value = data.clubCurrency || 'TRY';
                    document.getElementById('clubLanguage').value = data.clubLanguage || 'tr';
                    
                    console.log('‚úÖ Club info loaded');
                } else {
                    // ƒ∞lk kez, kul√ºpten gelen bilgileri kullan
                    document.getElementById('clubInfoName').value = currentUser.clubName || clubSettings.clubName || '';
                    console.log('‚ÑπÔ∏è No club info found, using defaults');
                }
            } catch (error) {
                console.error('Error loading club info:', error);
            }
        }

        window.saveClubInfo = async function(event) {
            event.preventDefault();
            const form = event.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = '‚è≥ Kaydediliyor...';
                
                const clubInfoData = {
                    clubName: document.getElementById('clubInfoName').value,
                    clubIcon: document.getElementById('clubIcon').value,
                    clubDescription: document.getElementById('clubDescription').value,
                    clubAddress: document.getElementById('clubAddress').value,
                    clubCity: document.getElementById('clubCity').value,
                    clubPhone: document.getElementById('clubPhone').value,
                    clubEmail: document.getElementById('clubEmail').value,
                    clubWebsite: document.getElementById('clubWebsite').value,
                    clubInstagram: document.getElementById('clubInstagram').value,
                    clubFacebook: document.getElementById('clubFacebook').value,
                    clubTwitter: document.getElementById('clubTwitter').value,
                    clubFounded: document.getElementById('clubFounded').value,
                    clubTimezone: document.getElementById('clubTimezone').value,
                    clubCurrency: document.getElementById('clubCurrency').value,
                    clubLanguage: document.getElementById('clubLanguage').value,
                    clubId: currentClubId,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.email
                };
                
                const { setDoc, doc } = window.firebase;
                await setDoc(doc(window.db, 'settings', `clubInfo_${currentClubId}`), clubInfoData);
                
                // Update global clubSettings
                clubSettings.clubName = clubInfoData.clubName;
                
                // Update title
                document.getElementById('club-title').textContent = clubInfoData.clubName;
                const clubTitleHeader = document.getElementById('club-title-header');
                if (clubTitleHeader) clubTitleHeader.textContent = `${clubInfoData.clubName} - Y√∂netim Paneli`;
                document.title = `${clubInfoData.clubName} - Y√∂netim Paneli`;
                
                showAlert('‚úÖ Kul√ºp bilgileri ba≈üarƒ±yla kaydedildi!', 'success');
                console.log('‚úÖ Club info saved');
                
            } catch (error) {
                console.error('Error saving club info:', error);
                showAlert('‚ùå Kul√ºp bilgileri kaydedilirken hata olu≈ütu!', 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'üíæ Kul√ºp Bilgilerini Kaydet';
            }
        };
        
        // ‚úÖ Webhook Ayarlarƒ± Y√ºkleme - REMOVED (Now in SuperAdmin)
        // Webhook management is now handled by SuperAdmin panel
        // OLD WEBHOOK FUNCTIONS - REMOVED (loadWebhookSettings moved to line ~10701)
        async function _oldLoadWebhookSettings() {
            try {
                const webhooksCollection = window.firebase.collection(window.db, 'webhooks');
                const q = window.firebase.query(webhooksCollection, window.firebase.where('clubId', '==', currentClubId));
                const querySnapshot = await window.firebase.getDocs(q);
                
                const webhookList = document.getElementById('webhookList');
                
                if (querySnapshot.empty) {
                    webhookList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p style="font-size: 48px; margin: 0;">üîó</p>
                            <p>Hen√ºz tanƒ±mlƒ± webhook bulunmuyor</p>
                            <p style="font-size: 14px;">Yeni webhook eklemek i√ßin yukarƒ±daki butonu kullanƒ±n</p>
                        </div>
                    `;
                    return;
                }
                
                let tableHtml = `
                    <table class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Durum</th>
                                <th>Webhook Adƒ±</th>
                                <th>URL</th>
                                <th>Olaylar</th>
                                <th>G√ºncelleme</th>
                                <th style="width: 150px;">ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                querySnapshot.forEach(doc => {
                    const webhook = doc.data();
                    const statusBadge = webhook.active 
                        ? '<span style="background: #28a745; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px;">‚úì Aktif</span>'
                        : '<span style="background: #6c757d; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px;">‚óã Pasif</span>';
                    
                    const eventIcons = {
                        'whatsapp_message': 'üí¨',
                        'new_member': 'üë§',
                        'payment': 'üí∞',
                        'attendance': 'üìã',
                        'contract_signed': 'üìù'
                    };
                    
                    const eventsHtml = (webhook.eventTypes || [])
                        .map(e => eventIcons[e] || e)
                        .join(' ');
                    
                    const updatedDate = webhook.updatedAt 
                        ? new Date(webhook.updatedAt).toLocaleDateString('tr-TR')
                        : '-';
                    
                    tableHtml += `
                        <tr>
                            <td>${statusBadge}</td>
                            <td><strong>${webhook.name}</strong></td>
                            <td style="font-size: 12px; font-family: monospace; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${webhook.url}">${webhook.url}</td>
                            <td>${eventsHtml || '-'}</td>
                            <td style="font-size: 13px;">${updatedDate}</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="testWebhookById('${doc.id}')" title="Test Et">üß™</button>
                                <button class="btn btn-sm btn-warning" onclick="editWebhook('${doc.id}')" title="D√ºzenle">‚úèÔ∏è</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteWebhook('${doc.id}', '${webhook.name}')" title="Sil">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                webhookList.innerHTML = tableHtml;
                
                console.log(`‚úÖ ${querySnapshot.size} webhook y√ºklendi`);
                
            } catch (error) {
                console.error('Error loading webhooks:', error);
                showAlert('Webhook\'lar y√ºklenirken hata olu≈ütu.', 'danger');
            }
        }
        
        // ‚úÖ Webhook Ekleme/D√ºzenleme Modalƒ± G√∂ster
        window.showWebhookAddModal = function() {
            document.getElementById('webhookModalTitle').textContent = '‚ûï Yeni Webhook Ekle';
            document.getElementById('webhookForm').reset();
            document.getElementById('webhookId').value = '';
            document.getElementById('webhookActive').checked = true;
            
            // Default olarak bazƒ± event'leri i≈üaretle
            document.querySelectorAll('input[name="webhookEventTypes"]').forEach(cb => {
                cb.checked = ['whatsapp_message', 'new_member', 'payment', 'contract_signed'].includes(cb.value);
            });
            
            document.getElementById('webhookModal').style.display = 'block';
        };
        
        // ‚úÖ Webhook D√ºzenleme
        window.editWebhook = async function(webhookId) {
            try {
                const webhookDoc = await window.firebase.getDoc(
                    window.firebase.doc(window.db, 'webhooks', webhookId)
                );
                
                if (!webhookDoc.exists()) {
                    showAlert('Webhook bulunamadƒ±!', 'danger');
                    return;
                }
                
                const webhook = webhookDoc.data();
                
                document.getElementById('webhookModalTitle').textContent = '‚úèÔ∏è Webhook D√ºzenle';
                document.getElementById('webhookId').value = webhookId;
                document.getElementById('webhookName').value = webhook.name || '';
                document.getElementById('webhookUrl').value = webhook.url || '';
                document.getElementById('webhookActive').checked = webhook.active !== false;
                
                // Event types
                document.querySelectorAll('input[name="webhookEventTypes"]').forEach(cb => {
                    cb.checked = (webhook.eventTypes || []).includes(cb.value);
                });
                
                document.getElementById('webhookModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading webhook:', error);
                showAlert('Webhook y√ºklenirken hata olu≈ütu!', 'danger');
            }
        };
        
        // ‚úÖ Modal Kapatma
        window.closeWebhookModal = function() {
            document.getElementById('webhookModal').style.display = 'none';
            document.getElementById('webhookForm').reset();
        };
        
        // ‚úÖ Webhook Kaydetme (Yeni veya G√ºncelleme)
        window.saveWebhook = async function(event) {
            event.preventDefault();
            
            const form = event.target;
            const webhookId = form.webhookId.value;
            const webhookName = form.webhookName.value.trim();
            const webhookUrl = form.webhookUrl.value.trim();
            const active = form.webhookActive.checked;
            
            if (!webhookName || !webhookUrl) {
                showAlert('L√ºtfen webhook adƒ± ve URL\'ini girin.', 'warning');
                return;
            }
            
            // Get selected event types
            const eventTypes = Array.from(form.querySelectorAll('input[name="webhookEventTypes"]:checked'))
                .map(cb => cb.value);
            
            const webhookData = {
                name: webhookName,
                url: webhookUrl,
                active: active,
                eventTypes: eventTypes,
                clubId: currentClubId,
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser.fullName || currentUser.email
            };
            
            try {
                if (webhookId) {
                    // Update existing
                    await window.firebase.updateDoc(
                        window.firebase.doc(window.db, 'webhooks', webhookId),
                        webhookData
                    );
                    showAlert('‚úÖ Webhook ba≈üarƒ±yla g√ºncellendi!', 'success');
                } else {
                    // Create new
                    webhookData.createdAt = new Date().toISOString();
                    await window.firebase.addDoc(
                        window.firebase.collection(window.db, 'webhooks'),
                        webhookData
                    );
                    showAlert('‚úÖ Webhook ba≈üarƒ±yla eklendi!', 'success');
                }
                
                closeWebhookModal();
                loadWebhookSettings();
                
            } catch (error) {
                console.error('Error saving webhook:', error);
                showAlert('‚ùå Webhook kaydedilirken hata olu≈ütu!', 'danger');
            }
        };
        
        // ‚úÖ Webhook Silme
        window.deleteWebhook = async function(webhookId, webhookName) {
            if (!confirm(`"${webhookName}" webhook'unu silmek istediƒüinize emin misiniz?`)) {
                return;
            }
            
            try {
                await window.firebase.deleteDoc(
                    window.firebase.doc(window.db, 'webhooks', webhookId)
                );
                
                showAlert('‚úÖ Webhook ba≈üarƒ±yla silindi!', 'success');
                loadWebhookSettings();
                
            } catch (error) {
                console.error('Error deleting webhook:', error);
                showAlert('‚ùå Webhook silinirken hata olu≈ütu!', 'danger');
            }
        };
        
        // ‚úÖ Webhook Test (ID ile)
        window.testWebhookById = async function(webhookId) {
            try {
                const webhookDoc = await window.firebase.getDoc(
                    window.firebase.doc(window.db, 'webhooks', webhookId)
                );
                
                if (!webhookDoc.exists()) {
                    showAlert('Webhook bulunamadƒ±!', 'danger');
                    return;
                }
                
                const webhook = webhookDoc.data();
                
                if (!webhook.active) {
                    if (!confirm('Bu webhook pasif durumda. Test etmek istiyor musunuz?')) {
                        return;
                    }
                }
                
                const testPayload = {
                    event: 'test',
                    clubId: currentClubId,
                    clubName: clubInfo.clubName || 'Test Kul√ºb√º',
                    timestamp: new Date().toISOString(),
                    message: 'Bu bir test mesajƒ±dƒ±r',
                    webhookName: webhook.name
                };
                
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                showAlert('üîÑ Test ediliyor...', 'info');
                
                const response = await fetch(webhook.url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(testPayload)
                });
                
                if (response.ok) {
                    const responseText = await response.text();
                    showAlert(`‚úÖ Webhook test ba≈üarƒ±lƒ±! (${response.status})`, 'success');
                    console.log('Webhook test response:', responseText);
                } else {
                    showAlert(`‚ùå Webhook test ba≈üarƒ±sƒ±z! (${response.status} ${response.statusText})`, 'danger');
                }
                
            } catch (error) {
                console.error('Webhook test error:', error);
                showAlert(`‚ùå Webhook test hatasƒ±: ${error.message}`, 'danger');
            }
        };
        
        // ‚úÖ S√∂zle≈üme Linki Kopyalama
        window.copyContractLink = function() {
            const linkInput = document.getElementById('contractLink');
            linkInput.select();
            document.execCommand('copy');
            showAlert('‚úÖ S√∂zle≈üme linki kopyalandƒ±!', 'success');
        };
        
        // ‚úÖ URL-friendly slug olu≈ütur (T√ºrk√ße karakter desteƒüi ile)
        function createSlug(text) {
            if (!text) return 'kulup';
            
            const turkishMap = {
                '√ß': 'c', 'ƒü': 'g', 'ƒ±': 'i', '√∂': 'o', '≈ü': 's', '√º': 'u',
                '√á': 'c', 'ƒû': 'g', 'ƒ∞': 'i', '√ñ': 'o', '≈û': 's', '√ú': 'u'
            };
            
            return text
                .split('')
                .map(char => turkishMap[char] || char)
                .join('')
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '') // Sadece harf ve rakam
                .replace(/^-+|-+$/g, ''); // Ba≈ütaki ve sondaki tire
        }
        
        // ‚úÖ S√∂zle≈üme ≈ûablonu Y√ºkleme
        async function loadContractTemplate() {
            try {
                // Kul√ºp adƒ±nƒ± al
                const clubName = clubSettings?.clubName || currentUser?.clubName || 'Kul√ºp';
                
                // URL-friendly slug olu≈ütur
                const clubSlug = createSlug(clubName);
                
                // Kul√ºbe √∂zel linki olu≈ütur ve g√∂ster (slug ile) - kayit.html kullanƒ±yoruz
                const contractLink = `${window.location.origin}${window.location.pathname.replace('admin.html', 'kayit.html')}?club=${clubSlug}`;
                document.getElementById('contractLink').value = contractLink;
                document.getElementById('contractLinkOpen').href = contractLink;
                
                // Kul√ºp adƒ±nƒ± g√∂ster (okunabilir halde)
                const clubNameEl = document.getElementById('contractClubName');
                if (clubNameEl) {
                    clubNameEl.textContent = clubName;
                }
                
                const contractDoc = await window.firebase.getDoc(
                    window.firebase.doc(window.db, 'settings', `contract_${currentClubId}`)
                );
                
                if (contractDoc.exists()) {
                    const data = contractDoc.data();
                    
                    // S√∂zle≈üme i√ßeriƒüi ve durum
                    document.getElementById('contractTemplate').value = data.text || '';
                    document.getElementById('contract-enabled').checked = data.enabled || false;
                    
                    // Sayfa ba≈ülƒ±klarƒ±
                    document.getElementById('contract-page-title').value = data.pageTitle || 'Spor Kul√ºb√º';
                    document.getElementById('contract-page-subtitle').value = data.pageSubtitle || '√úyelik S√∂zle≈ümesi';
                    
                    // Checkbox metinleri
                    document.getElementById('contract-checkbox1-text').value = data.checkbox1Text || '√úyelik s√∂zle≈ümesini okudum, anladƒ±m ve kabul ediyorum.';
                    document.getElementById('contract-checkbox2-text').value = data.checkbox2Text || '√úyeliƒüiniz iptal edilene kadar devam etmektedir. Her ayƒ±n 14\'√º, yeni d√∂nem i√ßin kayƒ±t iptali yapƒ±labilecek son g√ºnd√ºr. Bu tarihe kadar iptal edilmeyen kayƒ±tlar, devam eden d√∂nem i√ßin ge√ßerli sayƒ±lƒ±r.';
                    
                    // Bran≈ü bazlƒ± IBAN bilgilerini y√ºkle
                    // Tenis IBAN
                    if (data.ibanTenis) {
                        document.getElementById('iban_tenis_1_name').value = data.ibanTenis.iban1?.name || '';
                        document.getElementById('iban_tenis_1_number').value = data.ibanTenis.iban1?.number || '';
                        document.getElementById('iban_tenis_2_name').value = data.ibanTenis.iban2?.name || '';
                        document.getElementById('iban_tenis_2_number').value = data.ibanTenis.iban2?.number || '';
                    } else {
                        document.getElementById('iban_tenis_1_name').value = '';
                        document.getElementById('iban_tenis_1_number').value = '';
                        document.getElementById('iban_tenis_2_name').value = '';
                        document.getElementById('iban_tenis_2_number').value = '';
                    }
                    
                    // Y√ºzme IBAN
                    if (data.ibanYuzme) {
                        document.getElementById('iban_yuzme_1_name').value = data.ibanYuzme.iban1?.name || '';
                        document.getElementById('iban_yuzme_1_number').value = data.ibanYuzme.iban1?.number || '';
                        document.getElementById('iban_yuzme_2_name').value = data.ibanYuzme.iban2?.name || '';
                        document.getElementById('iban_yuzme_2_number').value = data.ibanYuzme.iban2?.number || '';
                    } else {
                        document.getElementById('iban_yuzme_1_name').value = '';
                        document.getElementById('iban_yuzme_1_number').value = '';
                        document.getElementById('iban_yuzme_2_name').value = '';
                        document.getElementById('iban_yuzme_2_number').value = '';
                    }
                } else {
                    // Varsayƒ±lan ≈üablon (kayit.html'den alƒ±ndƒ±)
                    document.getElementById('contractTemplate').value = `<h4>√úYELƒ∞K S√ñZLE≈ûMESƒ∞</h4>
<p><strong>1-) TARAFLAR</strong><br>
<strong>A-KUL√úP</strong><br>
Adƒ±-Soyadƒ± : {YETKILI_ADI}<br>
√únvanƒ± : {KULUP_ADI}<br>
Adres : {KULUP_ADRES}<br>
Vergi No : {VERGI_NO}<br>
Telefon : {KULUP_TELEFON}<br>
E-mail : {KULUP_EMAIL}<br>
Bu s√∂zle≈ümede bundan sonra "Eƒûƒ∞TMEN/KUL√úP" olarak anƒ±lacaktƒ±r.<br>
<strong>B-√úYE/VELƒ∞</strong><br>
Adƒ±-Soyadƒ± : {UYE_AD_SOYAD}<br>
Doƒüum Tarihi : {UYE_DOGUM_TARIHI}<br>
Adres : {UYE_ADRES}<br>
TCKN : {UYE_TCKN}<br>
Telefon : {UYE_TELEFON}<br>
Bu s√∂zle≈ümede bundan sonra "√úYE/VELƒ∞" olarak anƒ±lacaktƒ±r. √úye ve varsa veliye ait bilgiler yukarƒ±da yer alan kƒ±sma ayrƒ± ayrƒ± yazƒ±larak doldurulacaktƒ±r.</p>
<p>√úye/Veli i≈übu s√∂zle≈ümeyi onaylamasƒ± sƒ±rasƒ±nda Eƒüitmen tarafƒ±ndan kendisinden talep edilen her t√ºrl√º bilgiyi eksiksiz ve doƒüru olarak Eƒüitmene vermeyi kabul etmektedir. √úye/Veli, eƒüitimler sƒ±rasƒ±nda Eƒüitmene bildirdiƒüi bilgilerin doƒüruluƒüundan bizzat sorumludur.</p>
<p>√úye/Veli, i≈übu s√∂zle≈ümeye onayƒ± esnasƒ±nda beyan etmi≈ü olduƒüu cep telefonu numarasƒ± ve e-posta adresinin Eƒüitmen tarafƒ±ndan yapƒ±lacak her t√ºrl√º bildirim i√ßin ge√ßerli tebligat mecralarƒ± sayƒ±lacaƒüƒ±nƒ±, bu cep telefonu numarasƒ± ve e-posta adresinin kullanƒ±mƒ± ile ilgili her t√ºrl√º yetkinin kendisinde olduƒüunu, ilgili cep telefonu numarasƒ± ve e-posta adresinin 3. ki≈üiler tarafƒ±ndan kullanƒ±ldƒ±ƒüƒ± ≈ü√ºphesinin varlƒ±ƒüƒ± halinde bu durumu ve her halde cep telefonu numarasƒ± ve e-posta adresinde meydana gelen deƒüi≈üiklikleri Eƒüitmene bildirmekle y√ºk√ºml√º olduƒüunu kabul ve taahh√ºt eder.</p>

<p><strong>2-) KONU</strong><br>
ƒ∞≈übu √ºyelik s√∂zle≈ümesi, √ºyelik i≈ülemlerinin ger√ßekle≈ütirilmesi ile i≈übu s√∂zle≈ümenin onaylanmasƒ± suretiyle, Eƒüitmen tarafƒ±ndan sunulacak hizmetin ≈üartlarƒ±nƒ± ve taraflarƒ±n kar≈üƒ±lƒ±klƒ± hak ve y√ºk√ºml√ºl√ºklerini d√ºzenlemektedir.</p>

<p><strong>3-) S√úRE</strong><br>
S√∂zle≈üme s√ºresi aylƒ±k ve 6 aylƒ±k periyotlar halinde d√ºzenlenmekte olup; kayƒ±tlar s√∂zle≈ümenin biteceƒüi ayƒ±n 15'inden √∂nce iptal edilmediƒüi takdirde aylƒ±k veya 6 aylƒ±k olarak uzatƒ±lmƒ±≈ü sayƒ±lmaktadƒ±r. Kayƒ±t silinmediƒüi takdirde yeni d√∂neme ili≈ükin √ºcret √úye/Veli tarafƒ±ndan kul√ºbe √∂denecektir.</p>

<p><strong>4-) √úCRET</strong><br>
√úyelik bedeli, √úyelik satƒ±≈ü formunda belirtilen √ºyelik paketine g√∂re belirlenir ve i≈übu bedel √úye/Veli tarafƒ±ndan √∂denecektir.</p>

<p><strong>5-) √ñDEMELER</strong><br>
√ñdemelerin her ayƒ±n 20'sine kadar belirtilen hesaba yapƒ±lmasƒ± gerekmektedir. D√∂nem tarihlerine g√∂re eksik ya da fazla √∂deme durumu olu≈üabilir. √ñdemelerin zamanƒ±nda yapƒ±lmamasƒ± durumunda; √úye/Veli, yapacaƒüƒ± √∂demenin %25'i tutarƒ±nda cezai ≈üart √∂demeyi kabul ve taahh√ºt eder.</p>
<p>Yapƒ±lan √∂demeler, derslere katƒ±lƒ±m taahh√ºd√º olarak kabul edilir. √úyenin derslere katƒ±lamamasƒ± sebebiyle √ºcret iadesi yapƒ±lmaz.</p>

<p><strong>6-) √úYELƒ∞K ƒ∞PTALLERƒ∞</strong><br>
Her ayƒ±n 14'√º kayƒ±t sildirme i√ßin son g√ºnd√ºr. Bu tarihler sonrasƒ±nda yapƒ±lan kayƒ±t sildirmelerde yeni d√∂nem √ºcreti tahsil edilir. Kul√ºbe veya kul√ºp tesislerine zarar verici davranƒ±≈ülarda bulunulmasƒ± durumunda kul√ºp √ºyeliƒüi sonlandƒ±rƒ±labilir.</p>

{AIDAT_TAKVIMI}

<p><strong>7-) Eƒûƒ∞Tƒ∞ME ƒ∞Lƒ∞≈ûKƒ∞N KURALLAR</strong><br>
A) √úyelik ≈ûartlarƒ± ile √úye/Velinin Hak ve Y√ºk√ºml√ºl√ºkleri<br>
1) Eƒüitmen, her t√ºrl√º √ºyelik talebini hi√ßbir gerek√ße g√∂stermeksizin tek taraflƒ± olarak reddetme hakkƒ±na sahiptir.<br>
2) Eƒüitmenden, su√ß i≈ülememi≈ü ve herhangi bir y√ºz kƒ±zartƒ±cƒ± su√ßtan sabƒ±ka kaydƒ± bulunmayan T.C. vatanda≈ülarƒ± ile yabancƒ± uyruklu ki≈üiler ders alabilir.<br>
3) √úye/Veli, √ºyelik i√ßin gerekli olan her t√ºrl√º belgeyi eksiksiz ve doƒüru bir ≈üekilde temin edecektir.<br>
4) √úyelerin spor faaliyetine katƒ±lmak i√ßin gerekli saƒülƒ±k ≈üartlarƒ±nƒ± ta≈üƒ±yƒ±p ta≈üƒ±madƒ±klarƒ±, tƒ±bbi kontrollerini yaptƒ±rƒ±p yaptƒ±rmadƒ±klarƒ± sorumluluƒüu √úye/Veliye aittir.<br>
5) √úyelerin, ders veya aktivitelerden faydalanmamalarƒ± halinde dahi belirlenen bedelleri zamanƒ±nda ve tam olarak √∂demeleri zorunludur.<br>
6) √úye/Veli, kendisinin veya misafirlerinin ≈üahsi kusurlarƒ±, dikkatsizliƒüi veya ihmalleri ile kul√ºbe veya 3. ki≈üilere ait e≈üyalar √ºzerinde meydana getirecekleri t√ºm hasar ve zarardan sorumludur.</p>

<p>B) KUL√úP KURALLARI<br>
a) Grup dersleri aylƒ±k 8 derstir.<br>
b) Grup derslerinde ders bir kez i≈ülendiƒüinden, √ºyenin katƒ±lamadƒ±ƒüƒ± dersler i√ßin telafi yapƒ±lmaz.<br>
c) √ñzel ders paketleri 1 aylƒ±k s√ºreyle ge√ßerlidir. Bu s√ºre i√ßinde kullanƒ±lmayan ders haklarƒ± bir sonraki aya devredilmez.<br>
d) Spor bran≈ülarƒ±nda herhangi bir kaza, yaralanma veya saƒülƒ±k problemi durumunda sorumluluk tamamen √úye/Veliye aittir.<br>
e) √úyelerin derse zamanƒ±nda, uygun kƒ±yafetle ve hazƒ±r ≈üekilde gelmesi √úye/Velilerin sorumluluƒüundadƒ±r.</p>

<p>C) GENEL KURALLAR<br>
1) Kul√ºp b√ºnyesinde √úye/Veliler genel nezaket kurallarƒ±na uymakla y√ºk√ºml√ºd√ºrler. Kort i√ßinde veya dƒ±≈üƒ±nda nezaket kurallarƒ±na uymayan davranƒ±≈ülarda bulunan, huzuru ka√ßƒ±ran, hakaret, k√ºf√ºr kullanan √úye/Velilerin √úye/Velilikleri herhangi bir uyarƒ±ya gerek kalmadan resen iptal edilebilir.<br>
2) Kayƒ±p e≈üyalardan Kul√ºp sorumlu deƒüildir.<br>
3) Kul√ºp i√ßine dƒ±≈üarƒ±dan yiyecek i√ßecek getirmek yasaktƒ±r.<br>
4) Kul√ºp sƒ±nƒ±rlarƒ± i√ßerisinde sigara i√ßmek yasaktƒ±r.</p>

<p><strong>8-) Kƒ∞≈ûƒ∞SEL VERƒ∞LERƒ∞N ƒ∞≈ûLENMESƒ∞</strong><br>
√úye/Veli, i≈übu s√∂zle≈ümeye taraf olma suretiyle, verdiƒüi t√ºm bilgilerin ve ki≈üisel verilerinin, KVKK kapsamƒ±nda i≈ülenmesine a√ßƒ±k√ßa rƒ±za g√∂sterdiƒüini kabul eder.</p>

<p><strong>9-) SON H√úK√úMLER</strong><br>
1) Bu anla≈ümanƒ±n uygulanmasƒ±ndan kaynaklanan t√ºm ihtilaflar yerel mahkemeler ve icra dairelerinde √ß√∂z√ºlecektir.<br>
2) √úye/Veli, adres ve ileti≈üim bilgilerindeki deƒüi≈üiklikleri Eƒüitmene bildirmekle y√ºk√ºml√ºd√ºr.</p>

<p><strong>S√∂zle≈üme Tarihi:</strong> {TARIH}</p>

{OGRENCI_BILGILERI}

<p>√úYE/VELƒ∞<br>
Adƒ± Soyadƒ±: {UYE_AD_SOYAD}<br>
ƒ∞mza: _________________</p>

<p>Eƒûƒ∞TMEN/KUL√úP<br>
Adƒ± Soyadƒ±: {YETKILI_ADI}<br>
ƒ∞mza: _________________</p>`;
                    document.getElementById('contract-enabled').checked = false;
                    
                    // Varsayƒ±lan IBAN'larƒ± temizle
                    document.getElementById('iban_tenis_1_name').value = '';
                    document.getElementById('iban_tenis_1_number').value = '';
                    document.getElementById('iban_tenis_2_name').value = '';
                    document.getElementById('iban_tenis_2_number').value = '';
                    document.getElementById('iban_yuzme_1_name').value = '';
                    document.getElementById('iban_yuzme_1_number').value = '';
                    document.getElementById('iban_yuzme_2_name').value = '';
                    document.getElementById('iban_yuzme_2_number').value = '';
                }
                
            } catch (error) {
                console.error('Error loading contract template:', error);
                showAlert('S√∂zle≈üme ≈üablonu y√ºklenirken hata olu≈ütu.', 'danger');
            }
        }
        
        // ‚úÖ S√∂zle≈üme ≈ûablonu Kaydetme
        window.saveContractTemplate = async function(event) {
            event.preventDefault();
            
            const form = event.target;
            const contractText = form.contractText.value.trim();
            const enabled = form.contractEnabled.checked;
            
            if (!contractText) {
                showAlert('L√ºtfen s√∂zle≈üme metnini girin.', 'warning');
                return;
            }
            
            try {
                const contractData = {
                    text: contractText,
                    enabled: enabled,
                    clubId: currentClubId,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.fullName || currentUser.email,
                    
                    // Sayfa ba≈ülƒ±klarƒ±
                    pageTitle: form.pageTitle.value.trim(),
                    pageSubtitle: form.pageSubtitle.value.trim(),
                    
                    // Onay checkbox metinleri
                    checkbox1Text: form.checkbox1Text.value.trim(),
                    checkbox2Text: form.checkbox2Text.value.trim()
                };
                
                // Bran≈ü bazlƒ± IBAN bilgileri
                // Tenis IBAN
                const tenisIban1Name = document.getElementById('iban_tenis_1_name').value.trim();
                const tenisIban1Number = document.getElementById('iban_tenis_1_number').value.trim();
                const tenisIban2Name = document.getElementById('iban_tenis_2_name').value.trim();
                const tenisIban2Number = document.getElementById('iban_tenis_2_number').value.trim();
                
                if (tenisIban1Name || tenisIban1Number || tenisIban2Name || tenisIban2Number) {
                    contractData.ibanTenis = {};
                    if (tenisIban1Name || tenisIban1Number) {
                        contractData.ibanTenis.iban1 = {
                            name: tenisIban1Name,
                            number: tenisIban1Number
                        };
                    }
                    if (tenisIban2Name || tenisIban2Number) {
                        contractData.ibanTenis.iban2 = {
                            name: tenisIban2Name,
                            number: tenisIban2Number
                        };
                    }
                }
                
                // Y√ºzme IBAN
                const yuzmeIban1Name = document.getElementById('iban_yuzme_1_name').value.trim();
                const yuzmeIban1Number = document.getElementById('iban_yuzme_1_number').value.trim();
                const yuzmeIban2Name = document.getElementById('iban_yuzme_2_name').value.trim();
                const yuzmeIban2Number = document.getElementById('iban_yuzme_2_number').value.trim();
                
                if (yuzmeIban1Name || yuzmeIban1Number || yuzmeIban2Name || yuzmeIban2Number) {
                    contractData.ibanYuzme = {};
                    if (yuzmeIban1Name || yuzmeIban1Number) {
                        contractData.ibanYuzme.iban1 = {
                            name: yuzmeIban1Name,
                            number: yuzmeIban1Number
                        };
                    }
                    if (yuzmeIban2Name || yuzmeIban2Number) {
                        contractData.ibanYuzme.iban2 = {
                            name: yuzmeIban2Name,
                            number: yuzmeIban2Number
                        };
                    }
                }
                
                await window.firebase.setDoc(
                    window.firebase.doc(window.db, 'settings', `contract_${currentClubId}`),
                    contractData
                );
                
                showAlert('‚úÖ S√∂zle≈üme ≈üablonu ba≈üarƒ±yla kaydedildi! T√ºm ayarlarƒ±nƒ±z g√ºncellendi.', 'success');
            } catch (error) {
                console.error('Error saving contract template:', error);
                showAlert('‚ùå S√∂zle≈üme ≈üablonu kaydedilirken hata olu≈ütu!', 'danger');
            }
        };
        
        
        function switchSettingsTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.settings-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.settings-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(`settings-tab-${tabName}`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Load data when switching tabs
            if (tabName === 'club') {
                loadClubInfo();
            } else if (tabName === 'contract') {
                loadContractTemplate();
            } else if (tabName === 'webhook') {
                loadWebhookSettings();
            } else if (tabName === 'general') {
                loadWhatsAppSettings(); // Bulutfon ve diƒüer genel ayarlarƒ± y√ºkle
            }
            
            // Activate button
            event.target.classList.add('active');
            
            // Load WhatsApp instances if switching to WhatsApp tab
            if (tabName === 'whatsapp') {
                loadWhatsAppInstances();
            }
            
            // Load message templates if switching to templates tab
            if (tabName === 'templates') {
                loadMessageTemplates();
            }
            
            // Load branches when switching to branches tab
            if (tabName === 'branches') {
                renderBranchesTable();
            }
            
            // Load users when switching to users tab
            if (tabName === 'users') {
                renderUsersTable();
            }
        }
        
        // --- MESSAGE TEMPLATES FUNCTIONS ---
        let messageTemplates = {};
        
        async function loadMessageTemplates() {
            try {
                const templatesDoc = await window.firebase.getDoc(
                    window.firebase.doc(window.db, 'settings', 'messageTemplates')
                );
                
                if (templatesDoc.exists()) {
                    messageTemplates = templatesDoc.data();
                } else {
                    // Default templates
                    messageTemplates = {
                        birthday: {
                            textChild: 'Sayƒ±n {UYE_AD_SOYAD},\n\nVelisi olduƒüunuz {OGRENCI_AD_SOYAD}\'nƒ±n doƒüum g√ºn√ºn√º en i√ßten dileklerimizle kutlar, saƒülƒ±k ve mutluluk dolu nice yƒ±llar dileriz! üéâüéÇ\n\nSizinle birlikte olmaktan mutluluk duyuyoruz.',
                            textAdult: 'Sayƒ±n {UYE_AD_SOYAD},\n\nDoƒüum g√ºn√ºn√ºz√º en i√ßten dileklerimizle kutlar, saƒülƒ±k ve mutluluk dolu nice yƒ±llar dileriz! üéâüéÇ\n\nSizinle birlikte olmaktan mutluluk duyuyoruz.',
                            text: 'Sayƒ±n {UYE_AD_SOYAD}, Doƒüum g√ºn√ºn√ºz√º kutlarƒ±z!',
                            enabled: false
                        },
                        payment: {
                            textChild: 'Sayƒ±n {UYE_AD_SOYAD},\n\nVelisi olduƒüunuz {OGRENCI_AD_SOYAD} i√ßin {TUTAR} TL tutarƒ±ndaki √∂demeniz {TARIH} tarihinden beri gecikmi≈ü durumdadƒ±r.\n\nüìÖ D√∂nem: {DONEM_BASLANGIC} - {DONEM_BITIS}\nüìö Ders Sayƒ±sƒ±: {DERS_SAYISI}\n\nEn kƒ±sa s√ºrede √∂demenizi yapmanƒ±zƒ± rica ederiz.\n\nTe≈üekk√ºr ederiz.',
                            textAdult: 'Sayƒ±n {UYE_AD_SOYAD},\n\n{TUTAR} TL tutarƒ±ndaki √∂demeniz {TARIH} tarihinden beri gecikmi≈ü durumdadƒ±r.\n\nüìÖ D√∂nem: {DONEM_BASLANGIC} - {DONEM_BITIS}\nüìö Ders Sayƒ±sƒ±: {DERS_SAYISI}\n\nEn kƒ±sa s√ºrede √∂demenizi yapmanƒ±zƒ± rica ederiz.\n\nTe≈üekk√ºr ederiz.',
                            text: 'Sayƒ±n {UYE_AD_SOYAD}, √∂demeniz gecikmi≈ütir.',
                            enabled: false
                        },
                        absence: {
                            textChild: 'Sayƒ±n {UYE_AD_SOYAD},\n\nVelisi olduƒüunuz {OGRENCI_AD_SOYAD}\'nƒ±n {TARIH} tarihindeki {DERS} dersine katƒ±lamadƒ±ƒüƒ±nƒ± fark ettik.\n\nUmarƒ±z her ≈üey yolundadƒ±r. Herhangi bir sorun varsa bizimle ileti≈üime ge√ßebilirsiniz.\n\nGe√ßmi≈ü olsun.',
                            textAdult: 'Sayƒ±n {UYE_AD_SOYAD},\n\n{TARIH} tarihindeki {DERS} dersine katƒ±lamadƒ±ƒüƒ±nƒ±zƒ± fark ettik.\n\nUmarƒ±z her ≈üey yolundadƒ±r. Herhangi bir sorun varsa bizimle ileti≈üime ge√ßebilirsiniz.\n\nGe√ßmi≈ü olsun.',
                            text: 'Devamsƒ±zlƒ±k bildirimi',
                            enabled: false
                        },
                        announcement: {
                            textChild: 'Sayƒ±n {UYE_AD_SOYAD},\n\nVelisi olduƒüunuz {OGRENCI_AD_SOYAD} ile ilgili kul√ºb√ºm√ºzden √∂nemli bir duyuru:\n\n{MESAJ}\n\nBilgilerinize sunarƒ±z.',
                            textAdult: 'Sayƒ±n {UYE_AD_SOYAD},\n\nKul√ºb√ºm√ºzden √∂nemli bir duyuru:\n\n{MESAJ}\n\nBilgilerinize sunarƒ±z.',
                            text: 'Duyuru',
                            enabled: false
                        },
                        task: {
                            text: 'Sayƒ±n {UYE_AD_SOYAD},\n\nSize yeni bir g√∂rev atandƒ±:\n\nüìã G√∂rev: {GOREV}\nüìù A√ßƒ±klama: {ACIKLAMA}\nüìÖ Tarih: {TARIH}\n\nƒ∞yi √ßalƒ±≈ümalar dileriz.',
                            enabled: false
                        },
                        upcomingPayment: {
                            textChild: 'Sayƒ±n {UYE_AD_SOYAD},\n\nVelisi olduƒüunuz {OGRENCI_AD_SOYAD} i√ßin {TARIH} tarihinde {TUTAR} TL tutarƒ±nda √∂demeniz bulunmaktadƒ±r. ({GUN_KALDI} g√ºn kaldƒ±)\n\nüìÖ D√∂nem: {DONEM_BASLANGIC} - {DONEM_BITIS}\nüìö Ders Sayƒ±sƒ±: {DERS_SAYISI}\n\nZamanƒ±nda √∂demenizi hatƒ±rlatmak isteriz.\n\nTe≈üekk√ºr ederiz.',
                            textAdult: 'Sayƒ±n {UYE_AD_SOYAD},\n\n{TARIH} tarihinde {TUTAR} TL tutarƒ±nda √∂demeniz bulunmaktadƒ±r. ({GUN_KALDI} g√ºn kaldƒ±)\n\nüìÖ D√∂nem: {DONEM_BASLANGIC} - {DONEM_BITIS}\nüìö Ders Sayƒ±sƒ±: {DERS_SAYISI}\n\nZamanƒ±nda √∂demenizi hatƒ±rlatmak isteriz.\n\nTe≈üekk√ºr ederiz.',
                            text: 'Yakla≈üan √∂deme',
                            enabled: false
                        },
                        taskMessage: {
                            text: 'Sayƒ±n {UYE_AD_SOYAD},\n\n"{GOREV}" g√∂revi i√ßin yeni bir mesaj aldƒ±nƒ±z:\n\nüí¨ {MESAJ}\nüì§ G√∂nderen: {GONDEREN}\nüìÖ Tarih: {TARIH}\n\nG√∂rev detaylarƒ±nƒ± kontrol ediniz.',
                            enabled: false
                        },
                        pendingRegistration: {
                            textChild: 'Sayƒ±n {UYE_AD_SOYAD},\n\nKul√ºb√ºm√ºze {OGRENCI_AD_SOYAD} i√ßin √∂n kaydƒ±nƒ±z alƒ±nmƒ±≈ütƒ±r. üéâ\n\nAncak kayƒ±t i≈ülemleriniz hen√ºz tamamlanmamƒ±≈ütƒ±r. Kayƒ±t formunuz hazƒ±rlanmƒ±≈ütƒ±r.\n\nKaydƒ±nƒ±zƒ± tamamlamak i√ßin l√ºtfen a≈üaƒüƒ±daki linke tƒ±klayƒ±n:\n{LINK}\n\nSorularƒ±nƒ±z i√ßin bize ula≈üabilirsiniz.\n\nTe≈üekk√ºr ederiz.',
                            textAdult: 'Sayƒ±n {UYE_AD_SOYAD},\n\nKul√ºb√ºm√ºze √∂n kaydƒ±nƒ±z alƒ±nmƒ±≈ütƒ±r. üéâ\n\nAncak kayƒ±t i≈ülemleriniz hen√ºz tamamlanmamƒ±≈ütƒ±r. Kayƒ±t formunuz hazƒ±rlanmƒ±≈ütƒ±r.\n\nKaydƒ±nƒ±zƒ± tamamlamak i√ßin l√ºtfen a≈üaƒüƒ±daki linke tƒ±klayƒ±n:\n{LINK}\n\nSorularƒ±nƒ±z i√ßin bize ula≈üabilirsiniz.\n\nTe≈üekk√ºr ederiz.',
                            text: 'Sayƒ±n {UYE_AD_SOYAD}, Kayƒ±t hatƒ±rlatma',
                            enabled: false
                        }
                    };
                }
                
                // Fill form with templates
                // Birthday templates (child/adult)
                const birthdayChildElem = document.getElementById('template-birthday-child');
                birthdayChildElem.value = messageTemplates.birthday?.textChild || messageTemplates.birthday?.text || birthdayChildElem.placeholder;
                const birthdayAdultElem = document.getElementById('template-birthday-adult');
                birthdayAdultElem.value = messageTemplates.birthday?.textAdult || messageTemplates.birthday?.text || birthdayAdultElem.placeholder;
                document.getElementById('birthday-enabled').checked = messageTemplates.birthday?.enabled || false;
                
                // Payment templates (child/adult)
                const paymentChildElem = document.getElementById('template-payment-child');
                paymentChildElem.value = messageTemplates.payment?.textChild || messageTemplates.payment?.text || paymentChildElem.placeholder;
                const paymentAdultElem = document.getElementById('template-payment-adult');
                paymentAdultElem.value = messageTemplates.payment?.textAdult || messageTemplates.payment?.text || paymentAdultElem.placeholder;
                document.getElementById('payment-enabled').checked = messageTemplates.payment?.enabled || false;
                
                // Absence templates (child/adult)
                const absenceChildElem = document.getElementById('template-absence-child');
                absenceChildElem.value = messageTemplates.absence?.textChild || messageTemplates.absence?.text || absenceChildElem.placeholder;
                const absenceAdultElem = document.getElementById('template-absence-adult');
                absenceAdultElem.value = messageTemplates.absence?.textAdult || messageTemplates.absence?.text || absenceAdultElem.placeholder;
                document.getElementById('absence-enabled').checked = messageTemplates.absence?.enabled || false;
                
                // Announcement templates (child/adult)
                const announcementChildElem = document.getElementById('template-announcement-child');
                announcementChildElem.value = messageTemplates.announcement?.textChild || messageTemplates.announcement?.text || announcementChildElem.placeholder;
                const announcementAdultElem = document.getElementById('template-announcement-adult');
                announcementAdultElem.value = messageTemplates.announcement?.textAdult || messageTemplates.announcement?.text || announcementAdultElem.placeholder;
                document.getElementById('announcement-enabled').checked = messageTemplates.announcement?.enabled || false;
                
                const taskElem = document.getElementById('template-task');
                taskElem.value = messageTemplates.task?.text || taskElem.placeholder;
                document.getElementById('task-enabled').checked = messageTemplates.task?.enabled || false;
                
                // Upcoming Payment templates (child/adult)
                const upcomingPaymentChildElem = document.getElementById('template-upcomingPayment-child');
                upcomingPaymentChildElem.value = messageTemplates.upcomingPayment?.textChild || messageTemplates.upcomingPayment?.text || upcomingPaymentChildElem.placeholder;
                const upcomingPaymentAdultElem = document.getElementById('template-upcomingPayment-adult');
                upcomingPaymentAdultElem.value = messageTemplates.upcomingPayment?.textAdult || messageTemplates.upcomingPayment?.text || upcomingPaymentAdultElem.placeholder;
                document.getElementById('upcomingPayment-enabled').checked = messageTemplates.upcomingPayment?.enabled || false;
                
                const taskMessageElem = document.getElementById('template-taskMessage');
                taskMessageElem.value = messageTemplates.taskMessage?.text || taskMessageElem.placeholder;
                document.getElementById('taskMessage-enabled').checked = messageTemplates.taskMessage?.enabled || false;
                
                // Pending registration templates (child/adult)
                const pendingRegChildElem = document.getElementById('template-pendingRegistration-child');
                pendingRegChildElem.value = messageTemplates.pendingRegistration?.textChild || messageTemplates.pendingRegistration?.text || pendingRegChildElem.placeholder;
                const pendingRegAdultElem = document.getElementById('template-pendingRegistration-adult');
                pendingRegAdultElem.value = messageTemplates.pendingRegistration?.textAdult || messageTemplates.pendingRegistration?.text || pendingRegAdultElem.placeholder;
                document.getElementById('pendingRegistration-enabled').checked = messageTemplates.pendingRegistration?.enabled || false;
                
            } catch (error) {
                showAlert('≈ûablonlar y√ºklenirken hata olu≈ütu.', 'danger');
            }
        }
        
        window.saveMessageTemplates = async function(event) {
            event.preventDefault();
            
            const form = event.target;
            
            const templates = {
                birthday: {
                    textChild: form.birthdayChild.value.trim(),
                    textAdult: form.birthdayAdult.value.trim(),
                    text: form.birthdayChild.value.trim(), // Backward compatibility
                    enabled: form.birthdayEnabled.checked
                },
                payment: {
                    textChild: form.paymentChild.value.trim(),
                    textAdult: form.paymentAdult.value.trim(),
                    text: form.paymentChild.value.trim(), // Backward compatibility
                    enabled: form.paymentEnabled.checked
                },
                absence: {
                    textChild: form.absenceChild.value.trim(),
                    textAdult: form.absenceAdult.value.trim(),
                    text: form.absenceChild.value.trim(), // Backward compatibility
                    enabled: form.absenceEnabled.checked
                },
                announcement: {
                    textChild: form.announcementChild.value.trim(),
                    textAdult: form.announcementAdult.value.trim(),
                    text: form.announcementChild.value.trim(), // Backward compatibility
                    enabled: form.announcementEnabled.checked
                },
                task: {
                    text: form.task.value.trim(),
                    enabled: form.taskEnabled.checked
                },
                upcomingPayment: {
                    textChild: form.upcomingPaymentChild.value.trim(),
                    textAdult: form.upcomingPaymentAdult.value.trim(),
                    text: form.upcomingPaymentChild.value.trim(), // Backward compatibility
                    enabled: form.upcomingPaymentEnabled.checked
                },
                taskMessage: {
                    text: form.taskMessage.value.trim(),
                    enabled: form.taskMessageEnabled.checked
                },
                pendingRegistration: {
                    textChild: form.pendingRegistrationChild.value.trim(),
                    textAdult: form.pendingRegistrationAdult.value.trim(),
                    text: form.pendingRegistrationChild.value.trim(), // Backward compatibility
                    enabled: form.pendingRegistrationEnabled.checked
                },
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser?.email || 'admin'
            };
            
            try {
                await window.firebase.setDoc(
                    window.firebase.doc(window.db, 'settings', 'messageTemplates'),
                    templates
                );
                
                messageTemplates = templates;
                showAlert('‚úÖ ≈ûablonlar ba≈üarƒ±yla kaydedildi!', 'success');
            } catch (error) {
                showAlert('‚ùå ≈ûablonlar kaydedilirken hata olu≈ütu.', 'danger');
            }
        };
        
        // --- WHATSAPP EVOLUTION API FUNCTIONS ---
        const EVOLUTION_API_URL = "https://evo-2.edu-ai.online";
        const EVOLUTION_API_KEY = "iHAF8gWNA1axdRDY9e98UKpork00dBO2";
        
        // WhatsApp Header Actions
        
        window.searchInMessages = function() {
            if (!currentWhatsAppContact) return;
            const searchTerm = prompt('üîç Mesajlarda ara:', '');
            if (!searchTerm) return;
            
            // TODO: Implement message search
            showAlert(`"${searchTerm}" aranƒ±yor...\n\n(Arama √∂zelliƒüi yakƒ±nda eklenecek)`, 'info');
        };
        
        window.showContactInfo = function() {
            if (!currentWhatsAppContact) return;
            
            const contact = currentWhatsAppContact;
            const phone = formatPhoneDisplay(contact.phone);
            
            let info = `üë§ ${contact.name}\nüì± ${phone}\n`;
            
            if (contact.type === 'member') {
                info += `\n‚úÖ Bu ki≈üi kayƒ±tlƒ± bir √ºyedir`;
                if (contact.memberId) {
                    setTimeout(() => {
                        showMemberAttendancePage(contact.memberId);
                    }, 500);
                }
            } else if (contact.type === 'crm') {
                info += `\nüìã Bu ki≈üi CRM kaydƒ±nda`;
                if (contact.leadId) {
                    setTimeout(() => {
                        openCrmLeadDetail(contact.leadId);
                    }, 500);
                }
            } else {
                info += `\n‚ûï Bu ki≈üi hen√ºz kayƒ±tlƒ± deƒüil`;
            }
            
            showAlert(info, 'info');
        };
        
        window.showMoreOptions = function() {
            if (!currentWhatsAppContact) return;
            
            const options = [
                'üìã Ki≈üi Bilgileri',
                'üîÑ Sohbeti Yenile',
                'üóëÔ∏è Sohbeti Temizle',
                'üîá Bildirimleri Kapat',
                '‚≠ê Favori Olarak ƒ∞≈üaretle'
            ];
            
            showAlert('Daha fazla se√ßenek:\n\n' + options.join('\n') + '\n\n(√ñzellikler yakƒ±nda eklenecek)', 'info');
        };
        
        // üß™ Debug sent messages
        window.debugSentMessages = function(phone) {
            const normalizedPhone = formatPhoneForWhatsApp(phone || currentWhatsAppContact?.phone);
            
            console.log('üîç DEBUG SENT MESSAGES');
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            console.log('üì± Aranan telefon:', phone || currentWhatsAppContact?.phone);
            console.log('üì± Normalize edilmi≈ü:', normalizedPhone);
            console.log('üîß Se√ßili cihaz:', selectedWhatsAppDevice?.instanceName);
            console.log('üì¶ Toplam sentMessages:', sentMessages.length);
            console.log('');
            
            if (sentMessages.length > 0) {
                console.log('üìù ƒ∞lk 5 mesaj:');
                sentMessages.slice(0, 5).forEach((m, i) => {
                    const recipientNormalized = formatPhoneForWhatsApp(m.recipientPhone || '');
                    const phoneMatch = recipientNormalized === normalizedPhone;
                    const instanceMatch = m.instanceName === selectedWhatsAppDevice?.instanceName;
                    
                    console.log(`\n${i + 1}. Mesaj:`);
                    console.log('   recipientPhone:', m.recipientPhone);
                    console.log('   normalized:', recipientNormalized);
                    console.log('   instanceName:', m.instanceName);
                    console.log('   message:', m.message?.substring(0, 50));
                    console.log('   sentAt:', m.sentAt);
                    console.log('   ‚úì Phone match:', phoneMatch);
                    console.log('   ‚úì Instance match:', instanceMatch);
                    console.log('   ‚úì WOULD SHOW:', phoneMatch && instanceMatch);
                });
            }
            
            // ≈ûimdi filtrelemeyi test et
            const filtered = sentMessages.filter(m => {
                const recipientNormalized = formatPhoneForWhatsApp(m.recipientPhone || '');
                return recipientNormalized === normalizedPhone && 
                       m.instanceName === selectedWhatsAppDevice?.instanceName;
            });
            
            console.log('\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
            console.log(`‚úÖ E≈üle≈üen mesaj sayƒ±sƒ±: ${filtered.length}`);
            console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');
            
            return filtered;
        };
        
        
        
        async function handleWhatsAppInstanceCreate(e) {
            e.preventDefault();
            const form = e.target;
            const instanceName = form.instanceName.value.trim();
            const phoneNumber = document.getElementById('newInstancePhone').value.trim();
            
            // ‚úÖ Sabit API deƒüerleri kullanƒ±lƒ±yor
            const evolutionUrl = EVOLUTION_API_URL;
            const apiKey = EVOLUTION_API_KEY;
            
            if (!instanceName) {
                return showAlert('Cihaz adƒ± zorunludur.', 'warning');
            }
            
            if (!phoneNumber) {
                return showAlert('Telefon numarasƒ± zorunludur.', 'warning');
            }
            
            // Show loading state
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '‚è≥ Cihaz olu≈üturuluyor...';
            
            try {
                // Create instance via Evolution API (using user-provided URL and API Key)
                const response = await fetch(`${evolutionUrl}/instance/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': apiKey
                    },
                    body: JSON.stringify({
                        instanceName: instanceName,
                        number: phoneNumber,
                        owner: phoneNumber,
                        qrcode: true,
                        integration: "WHATSAPP-BAILEYS",
                        // ‚úÖ Webhook event'lerini ekle (mesajlar ve √ßaƒürƒ±lar i√ßin)
                        webhook: {
                            enabled: true,
                            url: clubSettings?.evolutionWebhookUrl || '', // Webhook URL'i ayarlardan √ßek
                            events: [
                                "MESSAGES_UPSERT",
                                "MESSAGES_UPDATE",
                                "MESSAGES_DELETE",
                                "SEND_MESSAGE",
                                "CALL_UPSERT",       // ‚úÖ √áaƒürƒ± event'i
                                "CALL_OFFER",        // ‚úÖ √áaƒürƒ± teklifi
                                "CALL_REJECT",       // ‚úÖ √áaƒürƒ± reddi
                                "CALL_ACCEPT"        // ‚úÖ √áaƒürƒ± kabul
                            ],
                            webhookByEvents: false,
                            webhookBase64: false
                        }
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Save to Firebase with Evolution URL and API Key
                    const deviceData = {
                        instanceName: instanceName,
                        phoneNumber: phoneNumber,
                        evolutionUrl: evolutionUrl,
                        apiKey: apiKey,
                        status: 'pending', // pending, connected, disconnected
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser?.email || 'unknown',
                        lastUpdated: new Date().toISOString(),
                        clubId: currentClubId // ‚úÖ Kul√ºp ID'si eklendi
                    };
                    
                    const docRef = await window.firebase.addDoc(
                        window.firebase.collection(window.db, 'whatsappDevices'),
                        deviceData
                    );
                    
                    whatsappDevices.push({ id: docRef.id, ...deviceData });
                    
                    showAlert('‚úÖ Cihaz ba≈üarƒ±yla olu≈üturuldu! QR kodu y√ºkleniyor...', 'success');
                    form.reset();
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    
                    // Show loading modal first
                    showQRLoadingModal(instanceName);
                    
                    // Always fetch QR code from API after creation
                    setTimeout(() => {
                        fetchAndShowQR(instanceName, docRef.id);
                    }, 500);
                    
                    // Reload instances after a delay
                    setTimeout(() => loadWhatsAppInstances(), 800);
                } else {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    
                    let errorMsg = '';
                    if (response.status === 403) {
                        errorMsg = 'üîí Eri≈üim Hatasƒ±: Cihaz olu≈üturma yetkiniz yok.';
                    } else {
                        errorMsg = `‚ùå Hata (${response.status}): ${data.message || data.error || 'Cihaz olu≈üturulamadƒ±.'}`;
                    }
                    
                    showAlert(errorMsg, 'danger');
                }
            } catch (error) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                showAlert(`‚ùå Cihaz olu≈üturulurken hata olu≈ütu.`, 'danger');
            }
        }
        
        function showQRLoadingModal(instanceName) {
            const modal = document.getElementById('qrCodeModal');
            if (!modal) return;
            
            const modalContent = modal.querySelector('.modal-content');
            if (!modalContent) return;
            
            document.getElementById('qrCodeTitle').textContent = `üì± ${instanceName} - QR Kod Hazƒ±rlanƒ±yor`;
            
            const qrImage = document.getElementById('qrCodeImage');
            if (qrImage) {
                qrImage.src = '';
                qrImage.style.display = 'none';
            }
            
            // Add loading spinner
            const existingLoader = modalContent.querySelector('.qr-loading');
            if (!existingLoader) {
                const loader = document.createElement('div');
                loader.className = 'qr-loading';
                loader.innerHTML = '<div class="spinner"></div><p>QR kod olu≈üturuluyor, l√ºtfen bekleyin...</p>';
                modalContent.insertBefore(loader, qrImage);
            }
            
            openModal('qrCodeModal');
        }
        
        async function loadWhatsAppInstances() {
            const container = document.getElementById('whatsappDevicesList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Cihazlar y√ºkleniyor...</span></div>';
            
            try {
                // Load from Firebase instead of API
                if (whatsappDevices.length === 0) {
                    container.innerHTML = '<p class="empty-state">Hen√ºz baƒülƒ± cihaz yok. Yukarƒ±dan yeni cihaz ekleyebilirsiniz.</p>';
                } else {
                    container.innerHTML = whatsappDevices.map(device => {
                        const statusClass = device.status === 'connected' ? 'status-active' : (device.status === 'disconnected' ? 'status-inactive' : 'status-pending');
                        const statusText = device.status === 'connected' ? 'üü¢ Baƒülƒ±' : (device.status === 'disconnected' ? 'üî¥ Baƒülantƒ± Kesildi' : 'üü° Beklemede');
                        return `
                            <div class="whatsapp-device-card">
                                <div class="device-info">
                                    <h4>${device.instanceName}</h4>
                                    <p><span class="status-badge ${statusClass}">${statusText}</span></p>
                                    <p><small>üì± ${device.phoneNumber}</small></p>
                                    <p><small>üìÖ ${formatDate(device.createdAt)}</small></p>
                                </div>
                                    <div class="device-actions">
                                        ${device.status !== 'connected' ? `<button class="btn btn-info btn-sm" onclick="window.showInstanceQR('${device.instanceName}')">üì∑ QR Kod</button>` : ''}
                                        ${device.status === 'pending' ? `<button class="btn btn-success btn-sm" onclick="window.manualCheckConnection('${device.instanceName}', '${device.id}')">‚úîÔ∏è Durumu Kontrol Et</button>` : ''}
                                        <button class="btn btn-warning btn-sm" onclick="window.restartInstance('${device.instanceName}', '${device.id}')">üîÑ Yeniden Ba≈ülat</button>
                                        <button class="btn btn-danger btn-sm" onclick="window.deleteInstance('${device.instanceName}', '${device.id}')">üóëÔ∏è Sil</button>
                                    </div>
                            </div>
                        `;
                    }).join('');
                }
                
                // Update test message device dropdown
                updateTestMessageDeviceDropdown();
                updateDefaultDeviceDropdown();
                loadSentMessagesLog();
            } catch (error) {
                container.innerHTML = '<p class="empty-state">Cihazlar y√ºklenirken hata olu≈ütu.</p>';
            }
        }
        
        function updateTestMessageDeviceDropdown() {
            const select = document.getElementById('testMessageDevice');
            if (!select) return;
            
            const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
            
            if (connectedDevices.length === 0) {
                select.innerHTML = '<option value="">√ñnce cihaz baƒülayƒ±n...</option>';
                select.disabled = true;
            } else {
                select.disabled = false;
                select.innerHTML = '<option value="">Cihaz se√ßin...</option>' + 
                    connectedDevices.map(device => 
                        `<option value="${device.instanceName}">${device.instanceName} (${device.phoneNumber})</option>`
                    ).join('');
            }
        }
        
        function updateDefaultDeviceDropdown() {
            const select = document.getElementById('defaultWhatsAppDevice');
            if (!select) return;
            
            const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
            
            if (connectedDevices.length === 0) {
                select.innerHTML = '<option value="">√ñnce cihaz baƒülayƒ±n...</option>';
                select.disabled = true;
            } else {
                select.disabled = false;
                select.innerHTML = '<option value="">Cihaz se√ßin...</option>' + 
                    connectedDevices.map(device => {
                        const isDefault = defaultWhatsAppDevice === device.instanceName;
                        return `<option value="${device.instanceName}" ${isDefault ? 'selected' : ''}>${device.instanceName} ${isDefault ? '‚≠ê' : ''} (${device.phoneNumber})</option>`;
                    }).join('');
            }
        }
        
        window.setDefaultWhatsAppDevice = async function(instanceName) {
            if (!instanceName) return;
            
            try {
                await window.firebase.setDoc(
                    window.firebase.doc(window.db, 'settings', 'whatsappConfig'),
                    {
                        defaultDevice: instanceName,
                        updatedAt: new Date().toISOString(),
                        updatedBy: currentUser?.email || 'admin'
                    }
                );
                
                defaultWhatsAppDevice = instanceName;
                showAlert('‚úÖ Ana WhatsApp hattƒ± ayarlandƒ±!', 'success');
                updateDefaultDeviceDropdown();
            } catch (error) {
                showAlert('‚ùå Ayar kaydedilemedi.', 'danger');
            }
        };
        
        function loadSentMessagesLog() {
            const container = document.getElementById('sentMessagesLog');
            if (!container) return;
            
            if (sentMessages.length === 0) {
                container.innerHTML = '<p class="empty-state">Hen√ºz mesaj g√∂nderilmedi.</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="table-container">
                    <table class="data-table" style="font-size: 12px;">
                        <thead>
                            <tr>
                                <th>Tarih/Saat</th>
                                <th>Alƒ±cƒ±</th>
                                <th>Mesaj</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sentMessages.map((msg, index) => `
                                <tr style="cursor: pointer;" onclick="showMessageDetail(${index})">
                                    <td style="white-space: nowrap;">${formatDate(msg.sentAt)}</td>
                                    <td>${msg.recipient}</td>
                                    <td style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        ${msg.message.substring(0, 50)}${msg.message.length > 50 ? '...' : ''}
                                    </td>
                                    <td>
                                        ${msg.success ? '<span style="color: green;">‚úì G√∂nderildi</span>' : '<span style="color: red;">‚úó Ba≈üarƒ±sƒ±z</span>'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        window.showMessageDetail = function(index) {
            const msg = sentMessages[index];
            if (!msg) return;
            
            const modal = document.getElementById('messageDetailModal');
            document.getElementById('messageDetailTitle').textContent = `üì© Mesaj Detayƒ± - ${msg.recipient}`;
            document.getElementById('messageDetailRecipient').textContent = msg.recipient;
            document.getElementById('messageDetailPhone').textContent = msg.recipientPhone || '-';
            document.getElementById('messageDetailDate').textContent = formatDate(msg.sentAt);
            document.getElementById('messageDetailStatus').innerHTML = msg.success 
                ? '<span style="color: green; font-weight: bold;">‚úì G√∂nderildi</span>' 
                : '<span style="color: red; font-weight: bold;">‚úó Ba≈üarƒ±sƒ±z</span>';
            document.getElementById('messageDetailText').textContent = msg.message;
            document.getElementById('messageDetailInstance').textContent = msg.instanceName || '-';
            
            openModal('messageDetailModal');
        }
        
        // ===== WHATSAPP PAGE FUNCTIONS =====
        let currentWhatsAppContact = null;
        let whatsappMessages = {}; // { phoneNumber: [messages] }
        let whatsappContacts = []; // Ki≈üi listesi
        
        let unreadMessagesCount = 0;
        let lastWhatsAppUnreadCount = -1; // ƒ∞lk y√ºkleme kontrol√º i√ßin (-1 = hen√ºz y√ºklenmedƒ±)
        
        let selectedWhatsAppDevice = null;
        
        function renderWhatsAppPage() {
            loadWhatsAppDevicesMain();
            updateActiveDeviceDropdown();
            updateTestMessageDeviceDropdown();
            updateDefaultDeviceDropdown();
            loadSentMessagesLog();
            updateBulkMessageSettings();
            loadWhatsAppSettings(); // Ayarlarƒ± inputlara y√ºkle
            renderMessageQueue(); // Mesaj kuyruƒüunu g√∂ster
            
            // üî• Start Firebase realtime listeners (Priority)
            startWhatsAppRealtimeListeners();
            
            // Start auto-refresh for live updates (Fallback)
            startWhatsAppAutoRefresh();
            
            // Load contacts if device is already selected
            if (selectedWhatsAppDevice) {
                loadWhatsAppContacts();
            }
        }
        
        // Ayarlarƒ± inputlara y√ºkle
        function loadWhatsAppSettings() {
            // √áalƒ±≈üma saatleri ayarlarƒ±
            try {
                if (clubSettings.workingHoursEnabled) {
                    const enabledCheckbox = document.getElementById('workingHoursEnabled');
                    const fieldsDiv = document.getElementById('workingHoursFields');
                    if (enabledCheckbox) enabledCheckbox.checked = true;
                    if (fieldsDiv) fieldsDiv.style.display = 'block';
                }
                
                if (clubSettings.workingHoursStart) {
                    const startInput = document.getElementById('workingHoursStart');
                    if (startInput) startInput.value = clubSettings.workingHoursStart;
                }
                if (clubSettings.workingHoursEnd) {
                    const endInput = document.getElementById('workingHoursEnd');
                    if (endInput) endInput.value = clubSettings.workingHoursEnd;
                }
                
                // √áalƒ±≈üma g√ºnleri
                if (clubSettings.workingDays) {
                    clubSettings.workingDays.forEach(day => {
                        const checkbox = document.getElementById(`workDay-${day}`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
                
                // Bulutfon ayarlarƒ±
                if (clubSettings.bulutfonEnabled) {
                    const bulutfonCheckbox = document.getElementById('bulutfonEnabled');
                    const bulutfonSettings = document.getElementById('bulutfon-api-settings');
                    if (bulutfonCheckbox) bulutfonCheckbox.checked = true;
                    if (bulutfonSettings) bulutfonSettings.style.display = 'block';
                }
                
                if (clubSettings.bulutfonApiKey) {
                    const apiKeyInput = document.getElementById('bulutfonApiKey');
                    if (apiKeyInput) apiKeyInput.value = clubSettings.bulutfonApiKey;
                }
            } catch (error) {
                console.warn('loadWhatsAppSettings error (non-critical):', error);
            }
        }
        
        // ‚úÖ Toplu mesaj √∂zetini ayarlara g√∂re g√ºncelle
        function updateBulkMessageSettings() {
            const waitTimeDisplay = document.getElementById('bulk-wait-time-display');
            const longWaitTrigger = document.getElementById('bulk-long-wait-trigger');
            const longWaitDisplay = document.getElementById('bulk-long-wait-display');
            
            if (waitTimeDisplay) {
                waitTimeDisplay.textContent = `${clubSettings.minWaitTime || 20}-${clubSettings.maxWaitTime || 50} saniye`;
            }
            if (longWaitTrigger) {
                longWaitTrigger.textContent = clubSettings.longWaitTrigger || 100;
            }
            if (longWaitDisplay) {
                longWaitDisplay.textContent = `${clubSettings.minLongWait || 400}-${clubSettings.maxLongWait || 800} saniye`;
            }
        }
        
        // Switch WhatsApp Tabs
        function switchWhatsAppTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('#whatsapp .settings-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('#whatsapp .settings-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(`whatsapp-tab-${tabName}`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Set active class on clicked tab
            event.target.classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'devices') {
                loadWhatsAppDevicesMain();
            } else if (tabName === 'campaigns') {
                loadCampaigns();
            } else if (tabName === 'calls') {
                loadWhatsAppCalls();
            }
        }
        
        window.switchWhatsAppTab = switchWhatsAppTab;
        
        // === WHATSAPP CALLS FUNCTIONS ===
        
        async function loadWhatsAppCalls() {
            const container = document.getElementById('whatsapp-calls-list');
            if (!container) return;
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>WhatsApp aramalarƒ± y√ºkleniyor...</span></div>';
            
            console.log('üìû WhatsApp aramalarƒ± Firebase\'den y√ºkleniyor...');
            console.log('‚ÑπÔ∏è Not: Evolution API\'de direkt call history endpoint\'i yok, webhook ile Firebase\'e kaydediliyor');
            
            try {
                // Firebase'den √ßekelim
                const callsRef = window.firebase.collection(window.db, 'whatsappIncomingCalls');
                let callsSnapshot;
                
                // √ñnce index'li sorguyu dene
                try {
                    console.log('üîç Index\'li sorgu deneniyor (clubId + timestamp)...');
                    const callsQuery = window.firebase.query(
                        callsRef,
                        window.firebase.where('clubId', '==', currentClubId),
                        window.firebase.orderBy('timestamp', 'desc'),
                        window.firebase.limit(100)
                    );
                    callsSnapshot = await window.firebase.getDocs(callsQuery);
                    console.log('‚úÖ Index\'li sorgu ba≈üarƒ±lƒ±:', callsSnapshot.docs.length, 'arama bulundu');
                } catch (indexError) {
                    // Index yoksa sadece clubId ile filtrele
                    console.warn('‚ö†Ô∏è Index hatasƒ±, basit sorgu deneniyor...', indexError.message);
                    const simpleQuery = window.firebase.query(
                        callsRef,
                        window.firebase.where('clubId', '==', currentClubId)
                    );
                    callsSnapshot = await window.firebase.getDocs(simpleQuery);
                    console.log('‚úÖ Basit sorgu ba≈üarƒ±lƒ±:', callsSnapshot.docs.length, 'arama bulundu');
                }
                
                // T√ºm d√∂k√ºmanlarƒ± da kontrol et (debug i√ßin)
                console.log('üîç T√ºm whatsappIncomingCalls d√∂k√ºmanlarƒ± kontrol ediliyor...');
                const allCallsSnapshot = await window.firebase.getDocs(callsRef);
                console.log(`üìä Toplam ${allCallsSnapshot.docs.length} WhatsApp arama d√∂k√ºmanƒ± var (t√ºm clublar dahil)`);
                
                if (allCallsSnapshot.docs.length > 0) {
                    console.log('üîç ƒ∞lk d√∂k√ºman √∂rneƒüi:', allCallsSnapshot.docs[0].data());
                    
                    // Bu club'a ait ka√ß tane var?
                    const thisClubCalls = allCallsSnapshot.docs.filter(doc => doc.data().clubId === currentClubId);
                    console.log(`üìä Bu club'a ait ${thisClubCalls.length} arama var`);
                    
                    if (thisClubCalls.length === 0) {
                        console.warn('‚ö†Ô∏è Firebase\'de WhatsApp aramasƒ± var ama clubId e≈üle≈ümiyor!');
                        console.log('Mevcut clubId:', currentClubId);
                        console.log('ƒ∞lk d√∂k√ºmanƒ±n clubId\'si:', allCallsSnapshot.docs[0].data().clubId);
                    }
                }
                
                if (callsSnapshot.empty) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p style="padding: 40px; color: #999;">üìû Bu club i√ßin WhatsApp aramasƒ± bulunmadƒ±</p>
                            <p style="color: #666; font-size: 14px;">Club ID: ${currentClubId}</p>
                            <p style="color: #666; font-size: 14px;">Toplam sistemdeki aramalar: ${allCallsSnapshot.docs.length}</p>
                            <button class="btn btn-secondary" onclick="loadWhatsAppCalls()">üîÑ Tekrar Dene</button>
                        </div>
                    `;
                    return;
                }
                
                const calls = [];
                callsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    calls.push({
                        id: doc.id,
                        ...data
                    });
                });
                
                console.log(`üìû ${calls.length} WhatsApp aramasƒ± y√ºklendi`);
                
                // ƒ∞lk aramayƒ± konsola yazdƒ±r (debug i√ßin)
                if (calls.length > 0) {
                    console.log('üîç ƒ∞lk arama detayƒ±:', calls[0]);
                    console.log('  - from:', calls[0].from);
                    console.log('  - caller:', calls[0].caller);
                    console.log('  - timestamp:', calls[0].timestamp);
                    console.log('  - instanceName:', calls[0].instanceName);
                    console.log('  - is_missing_call:', calls[0].is_missing_call);
                    console.log('  - isVideo:', calls[0].isVideo);
                }
                
                // Aramalarƒ± tarihe g√∂re sƒ±rala (eƒüer index sorgusu √ßalƒ±≈ümadƒ±ysa)
                calls.sort((a, b) => {
                    const dateA = new Date(a.timestamp);
                    const dateB = new Date(b.timestamp);
                    return dateB - dateA;
                });
                
                // Aramalarƒ± render et
                container.innerHTML = calls.map(call => {
                    const caller = call.from || call.caller || 'Bilinmeyen';
                    const formattedCaller = formatPhoneDisplay(caller);
                    const callTime = new Date(call.timestamp);
                    const timeStr = callTime.toLocaleString('tr-TR', { 
                        day: '2-digit', 
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit', 
                        minute: '2-digit'
                    });
                    
                    // Zaman farkƒ± hesapla
                    const now = new Date();
                    const diffMs = now - callTime;
                    const diffMins = Math.floor(diffMs / 60000);
                    let timeSinceStr = '';
                    if (diffMins < 60) {
                        timeSinceStr = `${diffMins} dakika √∂nce`;
                    } else if (diffMins < 1440) {
                        timeSinceStr = `${Math.floor(diffMins / 60)} saat ${diffMins % 60} dakika √∂nce`;
                    } else {
                        timeSinceStr = `${Math.floor(diffMins / 1440)} g√ºn √∂nce`;
                    }
                    
                    // Durum
                    const isMissed = call.is_missing_call === true || call.is_missing_call === 'true';
                    const statusText = isMissed ? 'Cevapsƒ±z' : 'Cevaplandƒ±';
                    const statusColor = isMissed ? '#f44336' : '#4caf50';
                    const statusIcon = isMissed ? 'üìµ' : '‚úÖ';
                    
                    // Video/Ses
                    const isVideo = call.isVideo === true;
                    const callTypeIcon = isVideo ? 'üìπ' : 'üìû';
                    const callTypeText = isVideo ? 'Video Arama' : 'Ses Arama';
                    
                    // CRM'de veya √ºyelerde var mƒ± kontrol et
                    const leadMatch = crmLeads.find(l => phonesMatch(l.phone, caller));
                    const memberMatch = members.find(m => phonesMatch(m.Telefon, caller) || phonesMatch(m.Telefon_2, caller));
                    
                    let personInfo = '';
                    let actionButtons = '';
                    
                    if (memberMatch) {
                        personInfo = `
                            <div style="font-size: 14px; color: #25D366; font-weight: 600; margin-top: 5px;">
                                üë§ ${memberMatch.Resit_Olmayan_Adi_Soyadi || memberMatch.Ad_Soyad}
                                <span style="background: #25D366; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px;">√úYE</span>
                            </div>
                        `;
                        actionButtons = `
                            <button class="btn btn-sm btn-info" onclick="showMemberAttendancePage('${memberMatch.id}')" title="√úye detaylarƒ±nƒ± g√∂r√ºnt√ºle">
                                üë§ √úye Detayƒ±
                            </button>
                        `;
                    } else if (leadMatch) {
                        personInfo = `
                            <div style="font-size: 14px; color: #ff9800; font-weight: 600; margin-top: 5px;">
                                üíº ${leadMatch.fullName}
                                <span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px;">CRM</span>
                            </div>
                        `;
                        actionButtons = `
                            <button class="btn btn-sm btn-warning" onclick="openCustomerDetail('${leadMatch.id}')" title="CRM detaylarƒ±nƒ± g√∂r√ºnt√ºle">
                                üíº CRM Detayƒ±
                            </button>
                        `;
                    } else {
                        actionButtons = `
                            <button class="btn btn-sm btn-primary" onclick="quickAddToCRM('${caller}')" title="CRM'e ekle">
                                ‚ûï CRM'e Ekle
                            </button>
                        `;
                    }
                    
                    return `
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid ${statusColor}; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                        <span style="font-size: 24px;">${callTypeIcon}</span>
                                        <div>
                                            <div style="font-size: 16px; font-weight: 600; color: #333;">
                                                ${formattedCaller}
                                            </div>
                                            <div style="font-size: 12px; color: #666;">
                                                ${callTypeText} ‚Ä¢ ${call.instanceName || 'WhatsApp'}
                                            </div>
                                        </div>
                                    </div>
                                    ${personInfo}
                                    <div style="font-size: 12px; color: #999; margin-top: 8px;">
                                        üìÖ ${timeStr} (${timeSinceStr})
                                    </div>
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: end; gap: 8px;">
                                    <div style="font-size: 14px; font-weight: 600; color: ${statusColor};">
                                        ${statusIcon} ${statusText}
                                    </div>
                                    ${actionButtons}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('‚ùå WhatsApp aramalarƒ± y√ºklenirken hata:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="padding: 40px; color: #f44336;">
                            ‚ùå Aramalar y√ºklenirken bir hata olu≈ütu
                        </p>
                        <p style="color: #666; font-size: 14px;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        window.loadWhatsAppCalls = loadWhatsAppCalls;
        
        // Debug fonksiyonu - Firebase'deki t√ºm WhatsApp aramalarƒ±nƒ± g√∂ster
        async function debugWhatsAppCalls() {
            const debugContainer = document.getElementById('whatsapp-calls-debug');
            if (!debugContainer) return;
            
            debugContainer.style.display = 'block';
            debugContainer.innerHTML = '<p>üîç Firebase kontrol ediliyor...</p>';
            
            try {
                const callsRef = window.firebase.collection(window.db, 'whatsappIncomingCalls');
                const allCallsSnapshot = await window.firebase.getDocs(callsRef);
                
                let debugInfo = `
                    <h4 style="margin-bottom: 10px;">üìä Firebase Debug Bilgileri</h4>
                    <p><strong>Toplam WhatsApp aramasƒ±:</strong> ${allCallsSnapshot.docs.length}</p>
                    <p><strong>Mevcut Club ID:</strong> ${currentClubId}</p>
                    <hr style="margin: 10px 0;">
                `;
                
                if (allCallsSnapshot.docs.length === 0) {
                    debugInfo += '<p style="color: red;">‚ùå Firebase\'de hi√ß WhatsApp aramasƒ± yok!</p>';
                    debugInfo += '<p>Webhook\'unuzun doƒüru √ßalƒ±≈ütƒ±ƒüƒ±ndan emin olun.</p>';
                } else {
                    // Bu club'a ait aramalarƒ± filtrele
                    const thisClubCalls = allCallsSnapshot.docs.filter(doc => doc.data().clubId === currentClubId);
                    debugInfo += `<p><strong>Bu club'a ait aramalar:</strong> ${thisClubCalls.length}</p>`;
                    
                    // T√ºm farklƒ± clubId'leri g√∂ster
                    const allClubIds = [...new Set(allCallsSnapshot.docs.map(doc => doc.data().clubId))];
                    debugInfo += `<p><strong>Sistemdeki Club ID'ler:</strong> ${allClubIds.join(', ')}</p>`;
                    
                    debugInfo += '<hr style="margin: 10px 0;">';
                    debugInfo += '<h5>Son 5 Arama √ñrneƒüi:</h5>';
                    
                    allCallsSnapshot.docs.slice(0, 5).forEach((doc, index) => {
                        const data = doc.data();
                        debugInfo += `
                            <div style="background: white; padding: 10px; margin: 10px 0; border-radius: 4px; border-left: 4px solid ${data.clubId === currentClubId ? '#4caf50' : '#ff9800'};">
                                <p><strong>Arama ${index + 1}:</strong></p>
                                <p style="margin: 5px 0;"><strong>ID:</strong> ${doc.id}</p>
                                <p style="margin: 5px 0;"><strong>from:</strong> ${data.from || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>caller:</strong> ${data.caller || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>instanceName:</strong> ${data.instanceName || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>timestamp:</strong> ${data.timestamp || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>clubId:</strong> ${data.clubId || 'N/A'} ${data.clubId === currentClubId ? '‚úÖ (E≈üle≈üiyor)' : '‚ùå (E≈üle≈ümiyor)'}</p>
                                <p style="margin: 5px 0;"><strong>is_missing_call:</strong> ${data.is_missing_call}</p>
                                <p style="margin: 5px 0;"><strong>isVideo:</strong> ${data.isVideo}</p>
                            </div>
                        `;
                    });
                    
                    if (thisClubCalls.length === 0 && allCallsSnapshot.docs.length > 0) {
                        debugInfo += `
                            <div style="background: #fff3cd; padding: 15px; margin: 15px 0; border-radius: 4px; border-left: 4px solid #ffc107;">
                                <p style="color: #856404; margin: 0;"><strong>‚ö†Ô∏è UYARI:</strong></p>
                                <p style="color: #856404; margin: 5px 0;">Firebase'de aramalar var ama clubId e≈üle≈ümiyor!</p>
                                <p style="color: #856404; margin: 5px 0;">Webhook'unuzda clubId'nin doƒüru g√∂nderildiƒüinden emin olun.</p>
                            </div>
                        `;
                    }
                }
                
                debugContainer.innerHTML = debugInfo;
                
            } catch (error) {
                console.error('Debug hatasƒ±:', error);
                debugContainer.innerHTML = `
                    <p style="color: red;">‚ùå Hata olu≈ütu: ${error.message}</p>
                    <pre style="background: white; padding: 10px; border-radius: 4px; overflow-x: auto;">${error.stack}</pre>
                `;
            }
        }
        
        window.debugWhatsAppCalls = debugWhatsAppCalls;
        
        // Mevcut instance'larƒ±n webhook ayarlarƒ±nƒ± g√ºncelle (√ßaƒürƒ± event'lerini aktif et)
        async function updateInstanceWebhookEvents(instanceName) {
            try {
                const device = whatsappDevices.find(d => d.instanceName === instanceName);
                if (!device) {
                    throw new Error('Cihaz bulunamadƒ±');
                }
                
                const evolutionUrl = device.evolutionUrl || EVOLUTION_API_URL;
                const apiKey = device.apiKey || EVOLUTION_API_KEY;
                
                console.log(`üîÑ ${instanceName} i√ßin webhook event'leri g√ºncelleniyor...`);
                
                const webhookUrl = clubSettings?.evolutionWebhookUrl || device.webhookUrl || '';
                
                // Evolution API'de webhook ayarlarƒ±nƒ± g√ºncelle
                // √ñnce /webhook/set endpoint'ini dene
                let response = await fetch(`${evolutionUrl}/webhook/set/${instanceName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': apiKey
                    },
                    body: JSON.stringify({
                        enabled: true,
                        url: webhookUrl,
                        webhookByEvents: false,
                        webhookBase64: false,
                        events: [
                            "MESSAGES_UPSERT",
                            "MESSAGES_UPDATE",
                            "MESSAGES_DELETE",
                            "SEND_MESSAGE",
                            "CALL_UPSERT",
                            "CALL_OFFER",
                            "CALL_REJECT",
                            "CALL_ACCEPT"
                        ]
                    })
                });
                
                // Eƒüer 400 hatasƒ± alƒ±rsak, alternatif format dene
                if (response.status === 400) {
                    console.log(`‚ö†Ô∏è ƒ∞lk format ba≈üarƒ±sƒ±z, alternatif format deneniyor...`);
                    response = await fetch(`${evolutionUrl}/webhook/set/${instanceName}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': apiKey
                        },
                        body: JSON.stringify({
                            webhook: {
                                enabled: true,
                                url: webhookUrl,
                                webhookByEvents: false,
                                webhookBase64: false,
                                events: [
                                    "MESSAGES_UPSERT",
                                    "MESSAGES_UPDATE",
                                    "MESSAGES_DELETE",
                                    "SEND_MESSAGE",
                                    "CALL_UPSERT",
                                    "CALL_OFFER",
                                    "CALL_REJECT",
                                    "CALL_ACCEPT"
                                ]
                            }
                        })
                    });
                }
                
                // Hala ba≈üarƒ±sƒ±z olursa instance settings √ºzerinden dene
                if (response.status === 400 || response.status === 404) {
                    console.log(`‚ö†Ô∏è Webhook endpoint ba≈üarƒ±sƒ±z, instance settings √ºzerinden deneniyor...`);
                    response = await fetch(`${evolutionUrl}/instance/update/${instanceName}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': apiKey
                        },
                        body: JSON.stringify({
                            webhook: {
                                enabled: true,
                                url: webhookUrl,
                                webhookByEvents: false,
                                webhookBase64: false,
                                events: [
                                    "MESSAGES_UPSERT",
                                    "MESSAGES_UPDATE",
                                    "MESSAGES_DELETE",
                                    "SEND_MESSAGE",
                                    "CALL_UPSERT",
                                    "CALL_OFFER",
                                    "CALL_REJECT",
                                    "CALL_ACCEPT"
                                ]
                            }
                        })
                    });
                }
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(`‚úÖ ${instanceName} webhook event'leri g√ºncellendi:`, result);
                    showAlert(`‚úÖ ${instanceName} i√ßin √ßaƒürƒ± event'leri aktif edildi`, 'success');
                    return true;
                } else {
                    let errorMessage = 'Bilinmeyen hata';
                    try {
                        const error = await response.json();
                        console.error(`‚ùå Webhook g√ºncelleme hatasƒ± (${response.status}):`, error);
                        errorMessage = error.message || error.error || JSON.stringify(error);
                    } catch (e) {
                        const errorText = await response.text();
                        console.error(`‚ùå Webhook g√ºncelleme hatasƒ± (${response.status}):`, errorText);
                        errorMessage = errorText || `HTTP ${response.status}`;
                    }
                    showAlert(`‚ùå Webhook g√ºncellenemedi: ${errorMessage}`, 'danger');
                    return false;
                }
            } catch (error) {
                console.error('Webhook g√ºncelleme hatasƒ±:', error);
                showAlert(`‚ùå Hata: ${error.message}`, 'danger');
                return false;
            }
        }
        
        window.updateInstanceWebhookEvents = updateInstanceWebhookEvents;
        
        // T√ºm instance'lar i√ßin webhook event'lerini g√ºncelle
        async function updateAllInstancesWebhookEvents() {
            if (!confirm('T√ºm WhatsApp cihazlarƒ±nƒ±z i√ßin √ßaƒürƒ± event\'lerini aktif etmek istediƒüinizden emin misiniz?')) {
                return;
            }
            
            const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
            
            if (connectedDevices.length === 0) {
                showAlert('‚ö†Ô∏è Baƒülƒ± cihaz bulunamadƒ±', 'warning');
                return;
            }
            
            showAlert(`üîÑ ${connectedDevices.length} cihaz g√ºncelleniyor...`, 'info');
            
            let successCount = 0;
            let failCount = 0;
            
            for (const device of connectedDevices) {
                const success = await updateInstanceWebhookEvents(device.instanceName);
                if (success) {
                    successCount++;
                } else {
                    failCount++;
                }
                // API'ye spam yapmamak i√ßin kƒ±sa bir bekleme
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            showAlert(`‚úÖ G√ºncelleme tamamlandƒ±: ${successCount} ba≈üarƒ±lƒ±, ${failCount} ba≈üarƒ±sƒ±z`, successCount > 0 ? 'success' : 'danger');
        }
        
        window.updateAllInstancesWebhookEvents = updateAllInstancesWebhookEvents;
        
        // === INCOMING MESSAGES FUNCTIONS ===
        
        function renderIncomingMessages() {
            const container = document.getElementById('incoming-messages-container');
            if (!container) return;
            
            if (incomingMessages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>üì≠ Hen√ºz gelen mesaj yok</h3>
                        <p>Webhook'unuzu yapƒ±landƒ±rdƒ±ƒüƒ±nƒ±zda, gelen mesajlar burada g√∂r√ºnecektir.</p>
                        <p style="margin-top: 15px;">
                            <a href="#" onclick="switchWhatsAppTab('devices'); return false;" class="btn btn-primary">
                                üì± WhatsApp Cihazlarƒ±nƒ± Yapƒ±landƒ±r
                            </a>
                        </p>
                    </div>
                `;
                return;
            }
            
            filterIncomingMessages();
        }
        
        function filterIncomingMessages() {
            const searchTerm = document.getElementById('incoming-search')?.value.toLowerCase() || '';
            const filterType = document.getElementById('incoming-filter')?.value || 'all';
            
            let filtered = [...incomingMessages];
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(msg => 
                    msg.fromName?.toLowerCase().includes(searchTerm) ||
                    msg.from?.includes(searchTerm) ||
                    msg.message?.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply type filter
            if (filterType === 'members') {
                filtered = filtered.filter(msg => msg.memberInfo && msg.memberInfo.id);
            } else if (filterType === 'non-members') {
                filtered = filtered.filter(msg => !msg.memberInfo || !msg.memberInfo.id);
            } else if (filterType === 'unread') {
                filtered = filtered.filter(msg => !msg.processed);
            }
            
            displayIncomingMessages(filtered);
        }
        
        function displayIncomingMessages(messages) {
            const container = document.getElementById('incoming-messages-container');
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>üîç Aramanƒ±za uygun mesaj bulunamadƒ±</h3></div>';
                return;
            }
            
            const tableHtml = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Tarih/Saat</th>
                                <th>G√∂nderen</th>
                                <th>Telefon</th>
                                <th>Mesaj</th>
                                <th>√úye Durumu</th>
                                <th>Durum</th>
                                <th>ƒ∞≈ülem</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${messages.map(msg => {
                                const date = new Date(msg.timestamp);
                                const formattedDate = date.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                                const formattedTime = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                                const isMember = msg.memberInfo && msg.memberInfo.id;
                                const memberBadge = isMember 
                                    ? `<span class="status-badge status-active" title="${msg.memberInfo.name}">‚úÖ √úye</span>`
                                    : `<span class="status-badge status-pending">‚ùå √úye Deƒüil</span>`;
                                const processedBadge = msg.processed 
                                    ? `<span class="status-badge status-completed">‚úì ƒ∞≈ülendi</span>`
                                    : `<span class="status-badge status-pending">‚è≥ Bekliyor</span>`;
                                
                                return `
                                    <tr>
                                        <td style="white-space: nowrap;">${formattedDate}<br><small>${formattedTime}</small></td>
                                        <td><strong>${msg.fromName || 'Bilinmiyor'}</strong></td>
                                        <td><a href="#" class="phone-link" onclick="handlePhoneClick(event, '${msg.from}')">${msg.from}</a></td>
                                        <td style="max-width: 300px; white-space: normal; word-wrap: break-word;">
                                            <div style="max-height: 60px; overflow: hidden; text-overflow: ellipsis;">
                                                ${msg.message || '<i>Mesaj i√ßeriƒüi yok</i>'}
                                            </div>
                                        </td>
                                        <td>${memberBadge}</td>
                                        <td>${processedBadge}</td>
                                        <td>
                                            <button class="btn btn-info btn-sm" onclick="viewIncomingMessage('${msg.id}')" title="Detaylarƒ± G√∂r">
                                                üëÅÔ∏è
                                            </button>
                                            ${!msg.processed ? `
                                            <button class="btn btn-success btn-sm" onclick="markMessageProcessed('${msg.id}')" title="ƒ∞≈ülendi olarak i≈üaretle">
                                                ‚úì
                                            </button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        }
        
        async function refreshIncomingMessages() {
            try {
                const { getDocs, query, collection, orderBy } = window.firebase;
                const snapshot = await getDocs(query(collection(window.db, 'incomingMessages'), orderBy('timestamp', 'desc')));
                incomingMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                showAlert('‚úÖ Gelen mesajlar g√ºncellendi!', 'success');
                renderIncomingMessages();
            } catch (error) {
                console.error('Error refreshing incoming messages:', error);
                showAlert('Mesajlar y√ºklenirken hata olu≈ütu: ' + error.message, 'danger');
            }
        }
        
        function viewIncomingMessage(messageId) {
            const msg = incomingMessages.find(m => m.id === messageId);
            if (!msg) return;
            
            const date = new Date(msg.timestamp);
            const formattedDate = date.toLocaleString('tr-TR');
            const isMember = msg.memberInfo && msg.memberInfo.id;
            
            const modalContent = `
                <div style="padding: 20px;">
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="margin: 0 0 10px 0;">üì® Mesaj Detayƒ±</h4>
                        <p style="margin: 5px 0;"><strong>G√∂nderen:</strong> ${msg.fromName || 'Bilinmiyor'}</p>
                        <p style="margin: 5px 0;"><strong>Telefon:</strong> ${msg.from}</p>
                        <p style="margin: 5px 0;"><strong>Tarih:</strong> ${formattedDate}</p>
                        <p style="margin: 5px 0;"><strong>√úye Durumu:</strong> ${isMember ? `‚úÖ √úye (${msg.memberInfo.name})` : '‚ùå √úye Deƒüil'}</p>
                    </div>
                    <div style="padding: 20px; background: white; border: 1px solid #ddd; border-radius: 8px; min-height: 100px;">
                        <strong>Mesaj:</strong><br>
                        <p style="margin-top: 10px; white-space: pre-wrap; font-size: 15px;">${msg.message || '<i>Mesaj i√ßeriƒüi yok</i>'}</p>
                    </div>
                </div>
            `;
            
            showAlert(modalContent, 'info');
        }
        
        async function markMessageProcessed(messageId) {
            try {
                await window.firebase.updateDoc(
                    window.firebase.doc(window.db, 'incomingMessages', messageId),
                    { processed: true, processedAt: new Date().toISOString() }
                );
                
                // Update local data
                const msg = incomingMessages.find(m => m.id === messageId);
                if (msg) {
                    msg.processed = true;
                }
                
                showAlert('‚úÖ Mesaj i≈ülendi olarak i≈üaretlendi', 'success');
                filterIncomingMessages();
            } catch (error) {
                console.error('Error marking message:', error);
                showAlert('ƒ∞≈ülem ba≈üarƒ±sƒ±z: ' + error.message, 'danger');
            }
        }
        
        window.refreshIncomingMessages = refreshIncomingMessages;
        window.filterIncomingMessages = filterIncomingMessages;
        window.viewIncomingMessage = viewIncomingMessage;
        window.markMessageProcessed = markMessageProcessed;
        
        // Add event listener for search input
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('incoming-search');
            if (searchInput) {
                searchInput.addEventListener('input', filterIncomingMessages);
            }
        });
        
        function updateActiveDeviceDropdown() {
            const dropdown = document.getElementById('whatsapp-active-device');
            if (!dropdown) return;
            
            const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
            
            dropdown.innerHTML = '<option value="">Bir cihaz se√ßin...</option>' + 
                connectedDevices.map(d => 
                    `<option value="${d.instanceName}">${d.instanceName} (${d.phoneNumber})</option>`
                ).join('');
        }
        
        window.onDeviceSelectionChange = function() {
            const dropdown = document.getElementById('whatsapp-active-device');
            const deviceInfo = document.getElementById('whatsapp-device-info');
            const messagingArea = document.getElementById('whatsapp-messaging-area');
            
            const selectedInstance = dropdown.value;
            
            if (!selectedInstance) {
                deviceInfo.textContent = '';
                messagingArea.style.display = 'none';
                selectedWhatsAppDevice = null;
                return;
            }
            
            // Find selected device
            const device = whatsappDevices.find(d => d.instanceName === selectedInstance);
            if (!device) return;
            
            selectedWhatsAppDevice = device;
            
            // Update info
            deviceInfo.innerHTML = `
                <span style="color: green; font-weight: 500;">‚úì Baƒülƒ±</span> | 
                Telefon: <strong>${device.phoneNumber}</strong> | 
                Olu≈üturulma: ${device.createdBy}
            `;
            
            // Show messaging area
            messagingArea.style.display = 'block';
            
            // Load contacts for this device
            loadWhatsAppContacts();
        };
        
        window.switchWhatsAppTab = function(tabName) {
            // Hide all tabs
            document.querySelectorAll('#whatsapp .settings-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#whatsapp .settings-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`whatsapp-tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
            
            // Load data for tab
            if (tabName === 'devices') {
                loadWhatsAppDevicesMain();
            } else if (tabName === 'bulk') {
                loadBulkMessageForm();
            } else if (tabName === 'reports') {
                loadMessageReports();
            }
        };
        
        window.filterMessageReports = function() {
            loadMessageReports();
        };
        
        window.exportMessageReports = function() {
            alert('Excel indirme √∂zelliƒüi yakƒ±nda eklenecek!');
        };
        
        window.clearMessageReports = async function() {
            if (!confirm('T√ºm mesaj raporlarƒ± silinecek. Emin misiniz?')) return;
            
            try {
                console.log('Deleting messages:', sentMessages.length);
                
                // Delete all messages from Firebase
                const { getDocs, collection, deleteDoc, doc } = window.firebase;
                const messagesSnapshot = await getDocs(collection(window.db, 'sentMessages'));
                
                const deletePromises = [];
                messagesSnapshot.forEach(docSnapshot => {
                    deletePromises.push(deleteDoc(docSnapshot.ref));
                });
                
                await Promise.all(deletePromises);
                
                // Clear local array
                sentMessages = [];
                
                // Reload reports
                loadMessageReports();
                showAlert(`${deletePromises.length} mesaj raporu silindi!`, 'success');
            } catch (error) {
                console.error('Error clearing reports:', error);
                showAlert('Raporlar temizlenirken hata olu≈ütu: ' + error.message, 'danger');
            }
        };
        
        function loadMessageReports() {
            const statusFilter = document.getElementById('report-filter-status')?.value || 'all';
            const dateFilter = document.getElementById('report-filter-date')?.value;
            
            let filtered = [...sentMessages];
            
            // Filter by status
            if (statusFilter === 'success') {
                filtered = filtered.filter(m => m.success === true);
            } else if (statusFilter === 'failed') {
                filtered = filtered.filter(m => m.success === false);
            } else if (statusFilter === 'pending') {
                filtered = filtered.filter(m => m.success === undefined || m.success === null);
            }
            
            // Filter by date
            if (dateFilter) {
                filtered = filtered.filter(m => m.sentAt?.startsWith(dateFilter));
            }
            
            // Sort by date (newest first)
            filtered.sort((a, b) => new Date(b.sentAt) - new Date(a.sentAt));
            
            // Update statistics
            const successCount = sentMessages.filter(m => m.success === true).length;
            const failedCount = sentMessages.filter(m => m.success === false).length;
            const pendingCount = sentMessages.filter(m => m.success === undefined || m.success === null).length;
            
            document.getElementById('report-success-count').textContent = successCount;
            document.getElementById('report-failed-count').textContent = failedCount;
            document.getElementById('report-pending-count').textContent = pendingCount;
            document.getElementById('report-total-count').textContent = sentMessages.length;
            
            // Render table
            const tbody = document.getElementById('message-reports-table');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Mesaj raporu bulunamadƒ±</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map((msg, index) => {
                const statusBadge = msg.success === true 
                    ? '<span class="badge bg-success">‚úÖ G√∂nderildi</span>'
                    : msg.success === false
                    ? '<span class="badge bg-danger">‚ùå Ba≈üarƒ±sƒ±z</span>'
                    : '<span class="badge bg-warning">‚è≥ Bekliyor</span>';
                
                const shortMessage = msg.message?.length > 50 
                    ? msg.message.substring(0, 50) + '...' 
                    : msg.message;
                
                return `
                    <tr>
                        <td>${formatDate(msg.sentAt)}</td>
                        <td>${msg.recipient || '-'}</td>
                        <td>${msg.recipientPhone || '-'}</td>
                        <td><span style="cursor: pointer;" onclick="showMessageDetail(${sentMessages.indexOf(msg)})" title="${escapeHtml(msg.message)}">${shortMessage}</span></td>
                        <td><small>${msg.instanceName || '-'}</small></td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="showMessageDetail(${sentMessages.indexOf(msg)})">üëÅÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        async function loadWhatsAppContacts() {
            whatsappContacts = [];
            
            console.log('üì± Loading WhatsApp contacts from Evolution API...');
            
            if (!selectedWhatsAppDevice) {
                console.warn('‚ö†Ô∏è No device selected');
                renderWhatsAppContactsList();
                return;
            }
            
            try {
                // Fetch all chats from Evolution API
                const device = selectedWhatsAppDevice;
                const evolutionUrl = device.evolutionUrl || EVOLUTION_API_URL;
                const apiKey = device.apiKey || EVOLUTION_API_KEY;
                
                const response = await fetch(`${evolutionUrl}/chat/findChats/${device.instanceName}`, {
                    method: 'POST',
                    headers: {
                        'apikey': apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        where: {}
                    })
                });
                
                if (response.ok) {
                    const chats = await response.json();
                    console.log(`‚úÖ Evolution API'den ${chats.length} sohbet y√ºklendi`);
                    
                    // Debug: Show first chat object structure
                    if (chats.length > 0) {
                    console.log('üîç ƒ∞lk chat objesi yapƒ±sƒ±:', chats[0]);
                    console.log('üîç ƒ∞lk 5 chat ID √∂rneƒüi:', chats.slice(0, 5).map(c => c.id));
                        if (chats[0].lastMessage) {
                            console.log('üîç ƒ∞lk lastMessage yapƒ±sƒ±:', chats[0].lastMessage);
                            console.log('  - fromMe:', chats[0].lastMessage.key?.fromMe);
                            console.log('  - messageTimestamp:', chats[0].lastMessage.messageTimestamp);
                        }
                    }
                    
                    let skippedGroups = 0;
                    let skippedInvalid = 0;
                    let processedPhones = 0;
                    
                    // Process each chat
                    for (const chat of chats) {
                        // Use remoteJid instead of id for phone number
                        const remoteJid = chat.remoteJid || chat.id;
                        
                        if (!remoteJid || remoteJid.includes('@g.us') || remoteJid.includes('@broadcast')) {
                            skippedGroups++;
                            continue; // Skip groups and broadcasts
                        }
                        
                        // Extract phone number from remoteJid
                        let phone = remoteJid.replace('@s.whatsapp.net', '').replace('@c.us', '').replace('@lid', '');
                        
                        // Check if this is a phone number (should only contain digits and optional leading +)
                        // Skip if contains letters (newsletters, special IDs, etc.)
                        const originalPhone = phone;
                        if (/[a-zA-Z]/.test(originalPhone)) {
                            // Contains letters, not a phone number - skip silently
                            skippedInvalid++;
                            continue;
                        }
                        
                        // Remove all non-digits
                        phone = phone.replace(/\D/g, '');
                        
                        // Skip if too short (not a valid phone)
                        if (phone.length < 10) {
                            skippedInvalid++;
                            continue; // Skip silently
                        }
                        
                        // Fix phone format for Turkish numbers
                        if (phone.startsWith('0') && phone.length === 11) {
                            // 05449367543 ‚Üí 905449367543
                            phone = '90' + phone.substring(1);
                        } else if (!phone.startsWith('90') && phone.length === 10) {
                            // 5449367543 ‚Üí 905449367543
                            phone = '90' + phone;
                        } else if (phone.startsWith('90') && phone.length === 12) {
                            // Already correct: 905449367543
                            // Do nothing
                        } else if (phone.length >= 10 && phone.length <= 15) {
                            // International number - keep as is
                            console.log(`üåç International number detected: ${phone}`);
                        } else {
                            // Invalid length
                            skippedInvalid++;
                            continue;
                        }
                        
                        // More flexible validation - accept any phone with 10-15 digits
                        if (phone.length < 10 || phone.length > 15) {
                            skippedInvalid++;
                            continue;
                        }
                        
                        processedPhones++;
                        
                        // Get contact name from Evolution API or use phone number
                        let contactName = chat.name || chat.pushName || phone;
                        
                        // Check if contact exists in members/CRM
                        const member = members.find(m => {
                            const memberPhone = formatPhoneForWhatsApp(m.Telefon || m.phone || '');
                            const memberPhone2 = formatPhoneForWhatsApp(m.Telefon_2 || m.phone2 || '');
                            return memberPhone === phone || memberPhone2 === phone;
                        });
                        
                        const crmLead = crmLeads.find(l => {
                            const leadPhone = formatPhoneForWhatsApp(l.phone || '');
                            return leadPhone === phone;
                        });
                        
                        // Determine contact type and name
                        let type = 'unknown';
                        let extraData = {};
                        
                        if (member) {
                            contactName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad || contactName;
                            type = 'member';
                            extraData.memberId = member.id;
                        } else if (crmLead) {
                            contactName = crmLead.name || contactName;
                            type = 'crm';
                            extraData.leadId = crmLead.id;
                        }
                        
                        // Get last message info
                        const lastMessage = chat.lastMessage || {};
                        const lastMessageTime = lastMessage.messageTimestamp 
                            ? new Date(lastMessage.messageTimestamp * 1000) 
                            : new Date(0);
                        
                        // Extract message text
                        let lastMessageText = '';
                        if (lastMessage.message) {
                            lastMessageText = lastMessage.message?.conversation || 
                                            lastMessage.message?.extendedTextMessage?.text || 
                                            lastMessage.message?.imageMessage?.caption ||
                                            (lastMessage.message?.imageMessage ? 'üì∑ Fotoƒüraf' : '') ||
                                            (lastMessage.message?.videoMessage ? 'üé• Video' : '') ||
                                            (lastMessage.message?.audioMessage ? 'üéµ Ses' : '') ||
                                            (lastMessage.message?.documentMessage ? 'üìÑ Dosya' : '') ||
                                            (lastMessage.message?.stickerMessage ? 'üé® Sticker' : '') ||
                                            '';
                        }
                        
                        // Check if message is from me
                        const fromMe = lastMessage.key?.fromMe === true || lastMessage.fromMe === true;
                        
                        whatsappContacts.push({
                            name: contactName,
                            phone: phone,
                            type: type,
                            lastMessage: lastMessageText,
                            lastMessageFromMe: fromMe,
                            lastMessageTime: lastMessageTime,
                            unreadCount: chat.unreadCount || 0,
                            instanceName: device.instanceName || device.name,
                            ...extraData
                        });
                    }
                    
                    // Sort by last message time (newest first)
                    whatsappContacts.sort((a, b) => b.lastMessageTime - a.lastMessageTime);
                    
                    console.log(`üìä ƒ∞≈ülem √ñzeti: ${chats.length} sohbet y√ºklendi ‚Üí ${skippedGroups} grup atlandƒ±, ${skippedInvalid} ge√ßersiz atlandƒ±, ${processedPhones} telefon i≈ülendi`);
                    console.log(`üìä Toplam ${whatsappContacts.length} konu≈üma (${whatsappContacts.filter(c => c.type === 'member').length} √ºye, ${whatsappContacts.filter(c => c.type === 'crm').length} CRM, ${whatsappContacts.filter(c => c.type === 'unknown').length} diƒüer)`);
                } else {
                    console.error('‚ùå Evolution API chat fetch failed:', response.status);
                }
            } catch (error) {
                console.error('‚ùå Error fetching chats from Evolution API:', error);
            }
            
            // ‚úÖ ƒ∞lk y√ºklemede okunmamƒ±≈ü mesaj varsa bildirim g√∂ster
            const currentUnreadCount = whatsappContacts.reduce((sum, c) => sum + (c.unreadCount || 0), 0);
            
            if (lastWhatsAppUnreadCount === -1) {
                // ƒ∞lk y√ºkleme
                lastWhatsAppUnreadCount = currentUnreadCount;
                console.log(`üìä ƒ∞lk y√ºkleme: ${currentUnreadCount} okunmamƒ±≈ü WhatsApp mesajƒ± tespit edildi`);
                
                // Eƒüer okunmamƒ±≈ü mesaj varsa bildirim g√∂ster
                if (currentUnreadCount > 0) {
                    console.log(`üîî ƒ∞lk y√ºkleme bildirimi: ${currentUnreadCount} okunmamƒ±≈ü mesaj mevcut`);
                    
                    // En son mesajƒ± olan contact'ƒ± bul
                    const latestContact = whatsappContacts
                        .filter(c => c.unreadCount > 0)
                        .sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0))[0];
                    
                    if (latestContact) {
                        const sender = latestContact.name || formatPhoneDisplay(latestContact.phone);
                        const messagePreview = latestContact.lastMessage || '';
                        await showWhatsAppMessageNotification(currentUnreadCount, sender, messagePreview, latestContact.instanceName);
                    } else {
                        await showWhatsAppMessageNotification(currentUnreadCount);
                    }
                }
            }
            
            renderWhatsAppContactsList();
        }
        
        function renderWhatsAppContactsList(searchTerm = '') {
            const container = document.getElementById('whatsapp-contacts-list');
            
            let filtered = whatsappContacts;
            if (searchTerm) {
                const searchNoSpaces = searchTerm.replace(/\s/g, '');
                filtered = whatsappContacts.filter(c => 
                    c.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    c.phone.includes(searchTerm) ||
                    c.phone.replace(/\s/g, '').includes(searchNoSpaces)
                );
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p class="empty-state" style="padding: 20px; text-align: center; color: #666;">Ki≈üi bulunamadƒ±</p>';
                return;
            }
            
            container.innerHTML = filtered.map(contact => {
                const safeName = (contact.name || 'ƒ∞simsiz').replace(/'/g, "\\'");
                const displayName = contact.name || 'ƒ∞simsiz';
                const displayPhone = formatPhoneDisplay(contact.phone);
                const firstLetter = displayName.charAt(0).toUpperCase();
                
                // Contact type styling
                let avatarColor = '#25D366'; // Default green
                let statusBadge = '';
                let actionButton = '';
                
                if (contact.type === 'member') {
                    avatarColor = '#128C7E';
                    statusBadge = '<span style="font-size: 10px; background: #25D366; color: white; padding: 2px 6px; border-radius: 10px; margin-left: 5px;">√úye</span>';
                    actionButton = `<button onclick="event.stopPropagation(); window.location.hash='members'; setTimeout(() => showMemberAttendancePage('${contact.memberId}'), 100);" style="padding: 4px 8px; font-size: 11px; background: #128C7E; color: white; border: none; border-radius: 4px; cursor: pointer;">G√∂r√ºnt√ºle</button>`;
                } else if (contact.type === 'crm') {
                    avatarColor = '#FFA500';
                    statusBadge = '<span style="font-size: 10px; background: #FFA500; color: white; padding: 2px 6px; border-radius: 10px; margin-left: 5px;">CRM</span>';
                    actionButton = `<button onclick="event.stopPropagation(); openCrmLeadDetail('${contact.leadId}');" style="padding: 4px 8px; font-size: 11px; background: #FFA500; color: white; border: none; border-radius: 4px; cursor: pointer;">G√∂r√ºnt√ºle</button>`;
                } else {
                    avatarColor = '#9E9E9E';
                    actionButton = `<button onclick="event.stopPropagation(); addToCRM('${contact.phone}', '${safeName}');" style="padding: 4px 8px; font-size: 11px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">+ CRM'e Ekle</button>`;
                }
                
                // Last message preview
                let lastMsgPreview = '';
                if (contact.lastMessage) {
                    // Eƒüer mesaj benden g√∂nderildiyse "Sen: " prefix'i ekle
                    const messagePrefix = contact.lastMessageFromMe ? '‚úì Sen: ' : '';
                    const messageText = contact.lastMessage.substring(0, 35) + (contact.lastMessage.length > 35 ? '...' : '');
                    
                    // Okunmamƒ±≈ü mesajlarƒ± bold yap
                    const textStyle = contact.unreadCount > 0 ? 'font-weight: 600; color: #111;' : 'color: #667781;';
                    
                    lastMsgPreview = `<div style="font-size: 12px; ${textStyle} margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${messagePrefix}${messageText}</div>`;
                }
                
                // Time display
                const timeDisplay = contact.lastMessageTime && contact.lastMessageTime.getTime() > 0
                    ? formatTimeAgo(contact.lastMessageTime)
                    : '';
                
                // Unread badge
                const unreadBadge = contact.unreadCount > 0 
                    ? `<span style="background: #25D366; color: white; border-radius: 50%; min-width: 20px; height: 20px; padding: 0 6px; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold;">${contact.unreadCount}</span>`
                    : '';
                
                return `
                    <div class="whatsapp-contact-item ${currentWhatsAppContact?.phone === contact.phone ? 'active' : ''}" 
                         onclick="selectWhatsAppContact('${contact.phone}', '${safeName}', ${JSON.stringify(contact).replace(/"/g, '&quot;')})"
                         style="padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.2s;"
                         onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=this.classList.contains('active')?'#E8F5E9':'white'">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 50px; height: 50px; border-radius: 50%; background: ${avatarColor}; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; font-weight: bold; flex-shrink: 0;">
                                ${firstLetter}
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: ${contact.unreadCount > 0 ? '600' : '500'}; color: #111; font-size: 15px;">${displayName} ${statusBadge}</div>
                                        <div style="font-size: 11px; color: #999; margin-top: 1px;">${displayPhone}</div>
                                    </div>
                                    <div style="font-size: 11px; color: ${contact.unreadCount > 0 ? '#25D366' : '#667781'}; font-weight: ${contact.unreadCount > 0 ? '600' : 'normal'};">${timeDisplay}</div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                                    <div style="flex: 1; min-width: 0;">${lastMsgPreview}</div>
                                    ${unreadBadge}
                                </div>
                                <div style="margin-top: 6px;">${actionButton}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (seconds < 60) return '≈ûimdi';
            if (minutes < 60) return `${minutes} dk`;
            if (hours < 24) return `${hours} sa`;
            if (days < 7) return `${days} g√ºn`;
            return date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
        }
        
        window.addToCRM = async function(phone, name) {
            // Telefonu formatla (05xxx formatƒ±na)
            const cleanPhone = phone.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            console.log(`üìù CRM'e ekleniyor: ${name} - Telefon: ${phone} ‚Üí ${formattedPhone}`);
            
            // Yeni potansiyel m√º≈üteri modalƒ±nƒ± a√ß
            openAddLeadModal();
            
            // Verileri doldur
            setTimeout(() => {
                const nameInput = document.querySelector('#addLeadModal input[name="name"]');
                const phoneInput = document.querySelector('#addLeadModal input[name="phone"]');
                if (nameInput) nameInput.value = name || '';
                if (phoneInput) {
                    phoneInput.value = formattedPhone;
                    // Telefon kontrol√ºn√º tetikle
                    phoneInput.dispatchEvent(new Event('blur'));
                }
                
                showAlert(`üìù CRM formu ${name} i√ßin hazƒ±rlandƒ±`, 'success');
            }, 300);
        };
        
        // WhatsApp notification sound - Web Audio API ile basit bir bildirim sesi olu≈ütur
        let audioContext = null;
        let whatsappNotificationSound = null;
        
        function createNotificationSound() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                return audioContext;
            } catch (e) {
                console.warn('AudioContext desteklenmiyor:', e);
                return null;
            }
        }
        
        async function playNotificationSound() {
            try {
                const ctx = createNotificationSound();
                if (!ctx) {
                    console.warn('Ses √ßalƒ±namƒ±yor - AudioContext yok');
                    return;
                }
                
                // AudioContext suspended ise resume et
                if (ctx.state === 'suspended') {
                    await ctx.resume();
                }
                
                // Hala suspended ise ses √ßalamazsƒ±n (kullanƒ±cƒ± etkile≈üimi gerekli)
                if (ctx.state !== 'running') {
                    console.log('‚ÑπÔ∏è Ses √ßalmak i√ßin kullanƒ±cƒ± etkile≈üimi gerekli (ilk tƒ±klamadan sonra √ßalƒ±≈üacak)');
                    return;
                }
                
                // Basit bir bildirim sesi olu≈ütur (beep)
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                // Ses ayarlarƒ±
                oscillator.frequency.value = 800; // Frekans (Hz)
                oscillator.type = 'sine'; // Sin√ºs dalgasƒ±
                
                // Ses seviyesi
                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                
                // Sesi √ßal
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.5);
                
                console.log('‚úÖ Bildirim sesi √ßalƒ±ndƒ±');
            } catch (e) {
                console.log('‚ÑπÔ∏è Ses √ßalƒ±namadƒ± (kullanƒ±cƒ± etkile≈üimi sonrasƒ± √ßalƒ±≈üacak):', e.message);
            }
        }
        
        // Ses izni iste
        let audioPermissionGranted = false;
        
        async function requestAudioPermission() {
            if (audioPermissionGranted) {
                return true; // Zaten verilmi≈ü
            }
            
            try {
                // AudioContext'i ba≈ülat
                const ctx = createNotificationSound();
                if (ctx && ctx.state === 'suspended') {
                    await ctx.resume();
                }
                audioPermissionGranted = true;
                console.log('‚úÖ Ses izni verildi');
                showAlert('‚úÖ Ses izni verildi', 'success');
                return true;
            } catch (e) {
                console.warn('‚ö†Ô∏è Ses izni verilmedi:', e);
                audioPermissionGranted = false;
                return false;
            }
        }
        
        // Ses testi fonksiyonu
        window.testWhatsAppSound = async function() {
            try {
                await playNotificationSound();
                audioPermissionGranted = true;
                console.log('‚úÖ WhatsApp bildirim sesi √ßalƒ±ndƒ±');
                showAlert('üîî WhatsApp bildirim sesi √ßalƒ±ndƒ±!', 'success', 2000);
            } catch (e) {
                console.error('‚ùå Ses √ßalƒ±namadƒ±:', e);
                showAlert('‚ùå Ses √ßalƒ±namadƒ±: ' + e.message + '\n\nTarayƒ±cƒ±nƒ±zƒ±n ses ayarlarƒ±nƒ± kontrol edin.', 'danger', 4000);
                audioPermissionGranted = false;
            }
        };
        
        // Sayfa y√ºklendiƒüinde ses izni kontrol√º
        window.checkAndRequestAudioPermission = async function() {
            console.log('üîä Ses izni hazƒ±r');
            // ƒ∞lk kullanƒ±cƒ± etkile≈üiminde AudioContext ba≈ülatƒ±lacak
        };
        
        // Bildirim panelini g√ºncelle
        window.updateNotificationPanel = function() {
            const statusText = document.getElementById('notification-status');
            const permissionBtn = document.getElementById('request-permission-btn');
            const panel = document.getElementById('whatsapp-notification-panel');
            
            if (!statusText || !permissionBtn || !panel) return;
            
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    panel.style.borderColor = '#4CAF50';
                    panel.style.background = '#e8f5e9';
                    statusText.innerHTML = '‚úÖ Bildirimler aktif! Yeni mesajlardan haberdar olacaksƒ±nƒ±z.';
                    statusText.style.color = '#2e7d32';
                    permissionBtn.style.display = 'none'; // ƒ∞zin butonu gizle
                } else if (Notification.permission === 'denied') {
                    panel.style.borderColor = '#f44336';
                    panel.style.background = '#ffebee';
                    statusText.innerHTML = '‚ùå Bildirim izni reddedildi. Tarayƒ±cƒ± ayarlarƒ±ndan izin vermeniz gerekiyor.';
                    statusText.style.color = '#c62828';
                    permissionBtn.textContent = '‚öôÔ∏è Ayarlar';
                    permissionBtn.onclick = () => {
                        alert('Bildirim izni tarayƒ±cƒ± ayarlarƒ±ndan verilmelidir:\n\n1. Tarayƒ±cƒ±nƒ±zƒ±n adres √ßubuƒüundaki kilit simgesine tƒ±klayƒ±n\n2. "Site ayarlarƒ±" veya "ƒ∞zinler" b√∂l√ºm√ºne gidin\n3. "Bildirimler" iznini "ƒ∞zin ver" olarak ayarlayƒ±n\n4. Sayfayƒ± yenileyin');
                    };
                } else {
                    // default - izin istenmemi≈ü
                    permissionBtn.style.display = 'inline-block';
                }
            } else {
                statusText.innerHTML = '‚ö†Ô∏è Tarayƒ±cƒ±nƒ±z bildirimleri desteklemiyor.';
                permissionBtn.style.display = 'none';
            }
        };
        
        // Bildirim izni iste
        window.requestNotificationPermission = async function() {
            if (!('Notification' in window)) {
                showAlert('‚ö†Ô∏è Tarayƒ±cƒ±nƒ±z bildirimlarƒ± desteklemiyor.', 'warning');
                return false;
            }
            
            if (Notification.permission === 'granted') {
                showAlert('‚úÖ Bildirim izni zaten verilmi≈ü!', 'success', 2000);
                // Paneli g√ºncelle
                if (window.updateNotificationPanel) updateNotificationPanel();
                return true;
            }
            
            if (Notification.permission === 'denied') {
                showAlert('‚ùå Bildirim izni reddedilmi≈ü. L√ºtfen tarayƒ±cƒ± ayarlarƒ±ndan izin verin.', 'danger', 5000);
                // Paneli g√ºncelle
                if (window.updateNotificationPanel) updateNotificationPanel();
                return false;
            }
            
            try {
                console.log('üîî Bildirim izni isteniyor...');
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    console.log('‚úÖ Bildirim izni verildi');
                    showAlert('‚úÖ Bildirim izni ba≈üarƒ±yla verildi!', 'success', 2000);
                    // Paneli g√ºncelle
                    if (window.updateNotificationPanel) updateNotificationPanel();
                    return true;
                } else {
                    console.log('‚ùå Bildirim izni reddedildi');
                    showAlert('‚ùå Bildirim izni reddedildi', 'warning');
                    // Paneli g√ºncelle
                    if (window.updateNotificationPanel) updateNotificationPanel();
                    return false;
                }
            } catch (error) {
                console.error('Bildirim izni hatasƒ±:', error);
                showAlert('‚ùå Bildirim izni alƒ±namadƒ±: ' + error.message, 'danger');
                return false;
            }
        };
        
        // Global variables for live updates
        let whatsappAutoRefreshInterval = null;
        let lastContactsCount = 0;
        
        // Gelen aramalar otomatik yenileme
        let incomingCallsAutoRefreshInterval = null;
        let lastIncomingCallsData = null;
        
        // Gelen aramalar otomatik yenileme ba≈ülat
        function startIncomingCallsAutoRefresh() {
            // Eƒüer zaten √ßalƒ±≈üƒ±yorsa durdur
            if (incomingCallsAutoRefreshInterval) {
                clearInterval(incomingCallsAutoRefreshInterval);
            }
            
            console.log('üîÑ Gelen aramalar otomatik yenileme ba≈ülatƒ±ldƒ± (30 saniye)');
            
            incomingCallsAutoRefreshInterval = setInterval(async () => {
                // Sadece gelen aramalar sekmesi a√ßƒ±ksa yenile
                const container = document.getElementById('incoming-calls-list');
                if (!container || container.offsetParent === null) {
                    // Sayfa g√∂r√ºn√ºr deƒüil, yenileme yapmayalƒ±m
                    return;
                }
                
                console.log('üìû Gelen aramalar arka planda yenileniyor...');
                
                try {
                    // Mevcut veriyi kaydet
                    const oldData = window.incomingCallsCategories ? JSON.stringify(window.incomingCallsCategories) : null;
                    
                    // Yenile
                    await renderIncomingCallsPage();
                    
                    // Yeni veriyi kontrol et
                    const newData = window.incomingCallsCategories ? JSON.stringify(window.incomingCallsCategories) : null;
                    
                    // Deƒüi≈üiklik varsa bildir
                    if (oldData && newData && oldData !== newData) {
                        console.log('‚úÖ Gelen aramalarda deƒüi≈üiklik tespit edildi, liste g√ºncellendi');
                        
                        // Kƒ±sa bir bildirim g√∂ster (opsiyonel)
                        const notification = document.createElement('div');
                        notification.style.cssText = 'position: fixed; top: 70px; right: 20px; background: #4CAF50; color: white; padding: 10px 20px; border-radius: 8px; z-index: 10000; animation: fadeIn 0.3s;';
                        notification.textContent = 'üîÑ Gelen aramalar g√ºncellendi';
                        document.body.appendChild(notification);
                        
                        setTimeout(() => {
                            notification.style.opacity = '0';
                            notification.style.transition = 'opacity 0.5s';
                            setTimeout(() => notification.remove(), 500);
                        }, 2000);
                    }
                } catch (error) {
                    console.error('‚ùå Gelen aramalar otomatik yenileme hatasƒ±:', error);
                }
            }, 30000); // 30 saniyede bir
        }
        
        // Gelen aramalar otomatik yenileme durdur
        function stopIncomingCallsAutoRefresh() {
            if (incomingCallsAutoRefreshInterval) {
                clearInterval(incomingCallsAutoRefreshInterval);
                incomingCallsAutoRefreshInterval = null;
                console.log('‚è∏Ô∏è Gelen aramalar otomatik yenileme durduruldu');
            }
        }
        
        window.startIncomingCallsAutoRefresh = startIncomingCallsAutoRefresh;
        window.stopIncomingCallsAutoRefresh = stopIncomingCallsAutoRefresh;
        
        // Start auto-refresh when WhatsApp section is opened
        function startWhatsAppAutoRefresh() {
            if (whatsappAutoRefreshInterval) {
                clearInterval(whatsappAutoRefreshInterval);
            }
            
            whatsappAutoRefreshInterval = setInterval(async () => {
                const oldContacts = [...whatsappContacts];
                const oldContactsCount = whatsappContacts.length;
                
                // Toplam okunmamƒ±≈ü mesaj sayƒ±sƒ±nƒ± hesapla (√∂nceki)
                const oldTotalUnread = oldContacts.reduce((sum, c) => sum + (c.unreadCount || 0), 0);
                
                await loadWhatsAppContacts();
                
                // Toplam okunmamƒ±≈ü mesaj sayƒ±sƒ±nƒ± hesapla (yeni)
                const newTotalUnread = whatsappContacts.reduce((sum, c) => sum + (c.unreadCount || 0), 0);
                
                // Yeni mesaj geldi mi kontrol et (yeni ki≈üi veya okunmamƒ±≈ü artƒ±≈üƒ±)
                const hasNewMessage = whatsappContacts.length > oldContactsCount || newTotalUnread > oldTotalUnread;
                
                // Play notification sound if new messages detected
                if (hasNewMessage) {
                    try {
                        const newMessagesCount = Math.max(1, newTotalUnread - oldTotalUnread);
                        console.log(`üîî Yeni mesaj bildirimi! (+${newMessagesCount} okunmamƒ±≈ü mesaj)`);
                        
                        // En son mesaj gelen contact'ƒ± bul
                        const latestContact = whatsappContacts
                            .filter(c => c.unreadCount > 0)
                            .sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0))[0];
                        
                        if (latestContact) {
                            const sender = latestContact.name || formatPhoneDisplay(latestContact.phone);
                            const messagePreview = latestContact.lastMessage || '';
                            // Show WhatsApp notification with details
                            await showWhatsAppMessageNotification(newMessagesCount, sender, messagePreview, latestContact.instanceName);
                        } else {
                            // Fallback if no contact found
                            await showWhatsAppMessageNotification(newMessagesCount);
                        }
                    } catch (e) {
                        console.log('Bildirim sesi √ßalƒ±namadƒ±:', e);
                    }
                }
                
                // Refresh current chat if open
                if (currentWhatsAppContact) {
                    const currentPhone = currentWhatsAppContact.phone;
                    const updatedContact = whatsappContacts.find(c => c.phone === currentPhone);
                    if (updatedContact && updatedContact.unreadCount > 0) {
                        // Silently reload messages
                        await loadMessagesForContact(currentPhone);
                    }
                }
            }, 10000); // Check every 10 seconds for faster notifications
            
            console.log('‚úÖ WhatsApp fallback polling ba≈ülatƒ±ldƒ± (10 saniyede bir - hƒ±zlƒ± bildirimler i√ßin)');
            
            // ‚úÖ WhatsApp √ßaƒürƒ±larƒ± i√ßin de polling ba≈ülat
            startWhatsAppCallsPolling();
        }
        
        function stopWhatsAppAutoRefresh() {
            if (whatsappAutoRefreshInterval) {
                clearInterval(whatsappAutoRefreshInterval);
                whatsappAutoRefreshInterval = null;
                console.log('‚è∏Ô∏è WhatsApp otomatik yenileme durduruldu');
            }
            
            // √áaƒürƒ± polling'ini de durdur
            if (whatsappCallsPollingInterval) {
                clearInterval(whatsappCallsPollingInterval);
                whatsappCallsPollingInterval = null;
                console.log('‚è∏Ô∏è WhatsApp √ßaƒürƒ± polling durduruldu');
            }
        }
        
        // ‚úÖ WhatsApp √áaƒürƒ±larƒ± Polling Sistemi
        let whatsappCallsPollingInterval = null;
        let lastProcessedCallId = null;
        
        async function startWhatsAppCallsPolling() {
            console.log('üìû WhatsApp √ßaƒürƒ± polling ba≈ülatƒ±lƒ±yor...');
            
            // ƒ∞lk kontrol√º hemen yap
            await fetchAndSaveWhatsAppCalls();
            
            // Her 20 saniyede bir kontrol et (√ßaƒürƒ±lar daha az sƒ±klƒ±kta geliyor)
            whatsappCallsPollingInterval = setInterval(async () => {
                await fetchAndSaveWhatsAppCalls();
            }, 20000); // 20 saniye
            
            console.log('‚úÖ WhatsApp √ßaƒürƒ± polling ba≈ülatƒ±ldƒ± (20 saniyede bir)');
        }
        
        async function fetchAndSaveWhatsAppCalls() {
            if (!clubSettings.whatsappDevices || clubSettings.whatsappDevices.length === 0) {
                return;
            }
            
            try {
                // Firebase'den mevcut √ßaƒürƒ±larƒ± al (tekrar kaydetmemek i√ßin)
                const existingCalls = new Set();
                try {
                    const callsRef = window.firebase.collection(window.db, 'whatsappIncomingCalls');
                    const callsQuery = window.firebase.query(
                        callsRef,
                        window.firebase.where('clubId', '==', currentClubId)
                    );
                    const callsSnapshot = await window.firebase.getDocs(callsQuery);
                    callsSnapshot.docs.forEach(doc => {
                        const data = doc.data();
                        const callKey = `${data.from}_${data.timestamp}`;
                        existingCalls.add(callKey);
                    });
                    console.log(`üìä Firebase'de ${existingCalls.size} WhatsApp √ßaƒürƒ±sƒ± bulundu`);
                } catch (error) {
                    console.warn('‚ö†Ô∏è Mevcut √ßaƒürƒ±lar kontrol edilemedi:', error);
                }
                
                let newCallsCount = 0;
                const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
                
                // Her cihaz i√ßin √ßaƒürƒ±larƒ± kontrol et
                for (const device of clubSettings.whatsappDevices) {
                    try {
                        // Evolution API'den instance bilgilerini √ßek (√ßaƒürƒ± olaylarƒ± i√ßin)
                        // Not: Evolution API'nin call history endpoint'i yoksa, webhook ile alƒ±nmalƒ±
                        // ≈ûimdilik Firebase'e manuel kayƒ±t i√ßin hazƒ±rlƒ±k yapƒ±yoruz
                        
                        console.log(`‚úÖ Cihaz ${device.instanceName} hazƒ±r (√ßaƒürƒ±lar webhook ile gelecek)`);
                        
                        // Alternatif: n8n workflow'undan gelen √ßaƒürƒ±larƒ± kontrol et
                        // Bu kƒ±sƒ±m webhook kurulduktan sonra √ßalƒ±≈üacak
                        
                    } catch (deviceError) {
                        console.error(`‚ùå Cihaz ${device.instanceName} hatasƒ±:`, deviceError);
                    }
                }
                
                if (newCallsCount > 0) {
                    console.log(`‚úÖ ${newCallsCount} yeni WhatsApp √ßaƒürƒ±sƒ± Firebase'e kaydedildi`);
                    
                    // Gelen aramalarƒ± yenile
                    if (document.getElementById('incoming-calls-list')) {
                        await renderIncomingCallsPage();
                    }
                }
                
            } catch (error) {
                console.error('‚ùå WhatsApp √ßaƒürƒ±larƒ± polling hatasƒ±:', error);
            }
        }
        
        // ‚úÖ Webhook'tan gelen WhatsApp √ßaƒürƒ±sƒ±nƒ± Firebase'e kaydet
        window.saveWhatsAppCallToFirebase = async function(callData) {
            try {
                // Telefon numarasƒ±nƒ± temizle ve formatla
                const from = (callData.from || callData.data?.from || '').replace('@lid', '').replace('@s.whatsapp.net', '');
                const caller = from.startsWith('90') ? '0' + from.substring(2) : from;
                
                // √áaƒürƒ± verisi
                const whatsappCall = {
                    from: from,
                    caller: caller,
                    to: callData.instance,
                    instanceName: callData.instance,
                    timestamp: callData.data?.date || callData.date_time || new Date().toISOString(),
                    status: callData.data?.status || 'unknown',
                    isVideo: callData.data?.isVideo || false,
                    callId: callData.data?.id || Date.now().toString(),
                    is_missing_call: ['ringing', 'missed'].includes(callData.data?.status || ''),
                    clubId: currentClubId,
                    createdAt: new Date().toISOString()
                };
                
                // Firebase'e kaydet
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'whatsappIncomingCalls'),
                    whatsappCall
                );
                
                console.log('WhatsApp √ßaƒürƒ±sƒ± Firebase e kaydedildi:', whatsappCall);
                
                // Gelen aramalarƒ± yenile (eƒüer o sayfadaysak)
                if (document.getElementById('incoming-calls-list')) {
                    await renderIncomingCallsPage();
                }
                
                return true;
            } catch (error) {
                console.error('WhatsApp √ßaƒürƒ±sƒ± Firebase e kaydedilemedi:', error);
                return false;
            }
        };
        
        // üî• Firebase Realtime Listeners (Multi-Tenant)
        let whatsappMessageListener = null;
        let whatsappCallListener = null;
        
        function startWhatsAppRealtimeListeners() {
            if (!currentClubId) {
                console.error('‚ùå Club ID bulunamadƒ±, realtime listeners ba≈ülatƒ±lamadƒ±');
                return;
            }
            
            console.log(`üî• Firebase realtime listeners ba≈ülatƒ±lƒ±yor (Club: ${currentClubId})...`);
            
            try {
                // 1. üì® Mesaj Listener
                const messagesRef = window.firebase.collection(window.db, 'whatsappIncomingMessages');
                const messagesQuery = window.firebase.query(
                    messagesRef,
                    window.firebase.where('clubId', '==', currentClubId),
                    window.firebase.orderBy('timestamp', 'desc'),
                    window.firebase.limit(50)
                );
                
                whatsappMessageListener = window.firebase.onSnapshot(messagesQuery, (snapshot) => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === 'added') {
                            const message = { id: change.doc.id, ...change.doc.data() };
                            
                            // Skip old messages on first load
                            const messageTime = new Date(message.timestamp || message.messageTimestamp * 1000);
                            if (Date.now() - messageTime.getTime() > 10000) return; // Skip >10s old
                            
                            console.log('üì® Yeni mesaj geldi (realtime):', message);
                            
                            // If chat is open with this contact, refresh messages immediately
                            if (currentWhatsAppContact && message.remoteJid) {
                                const messagePhone = message.remoteJid.replace('@s.whatsapp.net', '');
                                if (formatPhoneForWhatsApp(messagePhone) === currentWhatsAppContact.phone) {
                                    setTimeout(() => loadMessagesForContact(currentWhatsAppContact.phone), 200);
                                }
                            }
                            
                            // Refresh contact list immediately for faster updates
                            setTimeout(() => loadWhatsAppContacts(), 50);
                            
                            // Show notification with sender name and message content
                            const sender = message.pushName || formatPhoneDisplay(message.remoteJid?.replace('@s.whatsapp.net', ''));
                            const messageText = message.message?.conversation || 
                                              message.message?.extendedTextMessage?.text || 
                                              (message.message?.imageMessage ? 'üì∑ Fotoƒüraf' : '') ||
                                              (message.message?.videoMessage ? 'üé• Video' : '') ||
                                              (message.message?.audioMessage ? 'üéµ Ses' : '') ||
                                              (message.message?.documentMessage ? 'üìÑ Dosya' : '') ||
                                              'Mesaj';
                            await showWhatsAppMessageNotification(1, sender, messageText, message.instanceName);
                        }
                    });
                }, (error) => {
                    console.error('‚ùå Message listener error:', error);
                    
                    // Check if it's an index error
                    if (error.code === 'failed-precondition' || error.message?.includes('index')) {
                        console.warn('‚ö†Ô∏è Firebase index gerekli! L√ºtfen a≈üaƒüƒ±daki linke tƒ±klayƒ±p index olu≈üturun:');
                        console.warn(error.message);
                        
                        // Show user-friendly alert
                        const indexMatch = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]+/);
                        if (indexMatch) {
                            let indexUrl = indexMatch[0];
                            
                            // Remove trailing characters that might break the URL
                            indexUrl = indexUrl.replace(/[\)\]}\s]+$/, '');
                            
                            showAlert(
                                '‚ö†Ô∏è Firebase Index Gerekli!\n\n' +
                                'WhatsApp mesajlarƒ± i√ßin Firebase index olu≈üturmanƒ±z gerekiyor.\n\n' +
                                'F12 basƒ±p Console\'da mavi linke TIKLAYIN.\n\n' +
                                '≈ûimdilik fallback polling (30s) aktif.',
                                'warning',
                                10000
                            );
                            console.log('%c\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: orange; font-weight: bold;');
                            console.log('%cüìã INDEX Lƒ∞NKƒ∞ (Messages) - Bu linke TIKLAYIN:', 'color: red; font-size: 18px; font-weight: bold;');
                            console.log('%c' + indexUrl, 'color: blue; font-size: 16px; text-decoration: underline; cursor: pointer;');
                            console.log('%cYukarƒ±daki mavi linke SAƒûA TIK yapƒ±p "Open in new tab" se√ßin', 'color: green; font-size: 14px;');
                            console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n', 'color: orange; font-weight: bold;');
                        }
                    }
                });
                
                // 2. üìû Arama Listener (GE√áƒ∞Cƒ∞ DEVRE DI≈ûI - Index beklemeden √ßalƒ±≈ümak i√ßin)
                // TODO: Index tamamlandƒ±ƒüƒ±nda aktif et
                console.log('‚è∏Ô∏è Arama listener ge√ßici olarak devre dƒ±≈üƒ± (Index beklemek yerine)');
                /*
                const callsRef = window.firebase.collection(window.db, 'whatsappIncomingCalls');
                const callsQuery = window.firebase.query(
                    callsRef,
                    window.firebase.where('clubId', '==', currentClubId),
                    window.firebase.orderBy('timestamp', 'desc'),
                    window.firebase.limit(20)
                );
                
                whatsappCallListener = window.firebase.onSnapshot(callsQuery, (snapshot) => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === 'added') {
                            const call = { id: change.doc.id, ...change.doc.data() };
                            
                            // Skip old calls on first load
                            const callTime = new Date(call.timestamp || call.callTimestamp * 1000);
                            if (Date.now() - callTime.getTime() > 10000) return; // Skip >10s old
                            
                            console.log('üìû Yeni arama geldi (realtime):', call);
                            
                            // Notification sound
                            try {
                                await playNotificationSound();
                            } catch (e) {}
                            
                            // Show call notification
                            const callType = call.isVideo ? 'üìπ G√∂r√ºnt√ºl√º' : 'üìû Sesli';
                            const callStatus = call.status === 'offer' ? 'Gelen Arama' : call.status;
                            const caller = call.pushName || formatPhoneDisplay(call.remoteJid?.replace('@s.whatsapp.net', ''));
                            
                            showAlert(`${callType} ${callStatus}!\n${caller}`, 'warning', 5000);
                            
                            // Refresh contact list
                            setTimeout(() => loadWhatsAppContacts(), 500);
                        }
                    });
                }, (error) => {
                    console.error('‚ùå Call listener error:', error);
                    
                    // Check if it's an index error
                    if (error.code === 'failed-precondition' || error.message?.includes('index')) {
                        console.warn('‚ö†Ô∏è Firebase index gerekli! L√ºtfen a≈üaƒüƒ±daki linke tƒ±klayƒ±p index olu≈üturun:');
                        console.warn(error.message);
                        
                        // Show user-friendly alert
                        const indexMatch = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]+/);
                        if (indexMatch) {
                            let indexUrl = indexMatch[0];
                            
                            // Remove trailing characters that might break the URL
                            indexUrl = indexUrl.replace(/[\)\]}\s]+$/, '');
                            
                            showAlert(
                                '‚ö†Ô∏è Firebase Index Gerekli!\n\n' +
                                'WhatsApp √ßaƒürƒ±larƒ± i√ßin Firebase index olu≈üturmanƒ±z gerekiyor.\n\n' +
                                'F12 basƒ±p Console\'da mavi linke TIKLAYIN.\n\n' +
                                '≈ûimdilik fallback polling (30s) aktif.',
                                'warning',
                                10000
                            );
                            console.log('%c\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: orange; font-weight: bold;');
                            console.log('%cüìã INDEX Lƒ∞NKƒ∞ (Calls) - Bu linke TIKLAYIN:', 'color: red; font-size: 18px; font-weight: bold;');
                            console.log('%c' + indexUrl, 'color: blue; font-size: 16px; text-decoration: underline; cursor: pointer;');
                            console.log('%cYukarƒ±daki mavi linke SAƒûA TIK yapƒ±p "Open in new tab" se√ßin', 'color: green; font-size: 14px;');
                            console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n', 'color: orange; font-weight: bold;');
                        }
                    }
                });
                */
                
                console.log('‚úÖ Firebase realtime listeners aktif (Sadece Mesajlar - Aramalar devre dƒ±≈üƒ±)');
            } catch (error) {
                console.error('‚ùå Realtime listeners ba≈ülatƒ±lamadƒ±:', error);
            }
        }
        
        function stopWhatsAppRealtimeListeners() {
            if (whatsappMessageListener) {
                whatsappMessageListener();
                whatsappMessageListener = null;
            }
            if (whatsappCallListener) {
                whatsappCallListener();
                whatsappCallListener = null;
            }
            console.log('‚è∏Ô∏è Firebase realtime listeners durduruldu');
        }
        
        window.selectWhatsAppContact = function(phone, name, contactData) {
            // Normalize phone for storage and API calls
            const normalizedPhone = formatPhoneForWhatsApp(phone);
            currentWhatsAppContact = { 
                phone: normalizedPhone, 
                name,
                type: contactData?.type || 'unknown',
                memberId: contactData?.memberId,
                leadId: contactData?.leadId
            };
            
            // Format phone for display (05xxx xxx xxxx)
            const displayPhone = formatPhoneDisplay(normalizedPhone);
            
            // Update old header (keep for backwards compatibility)
            const oldHeaderContact = document.getElementById('whatsapp-selected-contact');
            const oldHeaderPhone = document.getElementById('whatsapp-selected-phone');
            if (oldHeaderContact) oldHeaderContact.textContent = name;
            if (oldHeaderPhone) oldHeaderPhone.textContent = displayPhone;
            document.getElementById('whatsapp-selected-number').value = normalizedPhone;
            
            // Update new header with initial
            const newHeader = document.getElementById('whatsapp-messages-header');
            const chatContactName = document.getElementById('chat-contact-name');
            const chatContactPhone = document.getElementById('chat-contact-phone');
            const chatContactInitial = document.getElementById('chat-contact-initial');
            const chatContactBadge = document.getElementById('chat-contact-badge');
            
            if (newHeader) newHeader.style.display = 'block';
            if (chatContactName) chatContactName.textContent = name;
            if (chatContactPhone) chatContactPhone.textContent = displayPhone;
            if (chatContactInitial) {
                // Get first letter of first name
                const firstLetter = name.trim().charAt(0).toUpperCase();
                chatContactInitial.textContent = firstLetter;
            }
            
            // Set badge based on type
            if (chatContactBadge && contactData) {
                if (contactData.type === 'member') {
                    chatContactBadge.textContent = '√úYE';
                    chatContactBadge.style.background = '#25D366';
                    chatContactBadge.style.display = 'inline-block';
                } else if (contactData.type === 'crm') {
                    chatContactBadge.textContent = 'CRM';
                    chatContactBadge.style.background = '#FFA500';
                    chatContactBadge.style.display = 'inline-block';
                } else {
                    chatContactBadge.style.display = 'none';
                }
            }
            
            // Show message input
            document.getElementById('whatsapp-message-input').style.display = 'block';
            const refreshBtn = document.getElementById('refresh-messages-btn');
            if (refreshBtn) refreshBtn.style.display = 'none'; // Hide old refresh button
            
            // Highlight selected contact
            document.querySelectorAll('.whatsapp-contact-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.whatsapp-contact-item')?.classList.add('active');
            
            // Load messages with normalized phone
            loadMessagesForContact(normalizedPhone);
        };
        
        window.refreshCurrentMessages = async function() {
            if (!currentWhatsAppContact) {
                showAlert('L√ºtfen bir ki≈üi se√ßin!', 'warning');
                return;
            }
            
            const btn = document.getElementById('refresh-messages-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Yenileniyor...';
            btn.disabled = true;
            
            await loadMessagesForContact(currentWhatsAppContact.phone);
            
            btn.innerHTML = originalText;
            btn.disabled = false;
            showAlert('Mesajlar yenilendi!', 'success');
        };
        
        window.testFetchMessages = async function() {
            if (!currentWhatsAppContact) {
                showAlert('L√ºtfen bir ki≈üi se√ßin!', 'warning');
                return;
            }
            
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîç WhatsApp Debug Test Ba≈ülatƒ±ldƒ±');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üìû Telefon:', currentWhatsAppContact.phone);
            console.log('üë§ ƒ∞sim:', currentWhatsAppContact.name);
            console.log('üì± Se√ßili Cihaz:', selectedWhatsAppDevice?.instanceName);
            console.log('üîó Evolution URL:', selectedWhatsAppDevice?.evolutionUrl || EVOLUTION_API_URL);
            console.log('üîë API Key Var mƒ±:', selectedWhatsAppDevice?.apiKey ? 'Evet' : 'Hayƒ±r');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            showAlert('üîç Debug bilgileri konsola yazdƒ±rƒ±lƒ±yor, F12 ile konsolunuzu a√ßƒ±n...', 'info');
            
            // Wait a bit so user can open console
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Test fetch
            console.log('üì° Mesajlar √ßekiliyor...');
            await loadMessagesForContact(currentWhatsAppContact.phone);
            
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('‚úÖ Test Tamamlandƒ±');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            showAlert('‚úÖ Test tamamlandƒ±! Konsol √ßƒ±ktƒ±larƒ±nƒ± kontrol edin (F12)', 'success');
        };
        
        window.syncMessagesToFirebase = async function() {
            if (!currentWhatsAppContact) {
                showAlert('L√ºtfen bir ki≈üi se√ßin!', 'warning');
                return;
            }
            
            if (!selectedWhatsAppDevice) {
                showAlert('L√ºtfen bir cihaz se√ßin!', 'warning');
                return;
            }
            
            const confirmSync = confirm(`${currentWhatsAppContact.name} ile olan t√ºm mesajlar Firebase'e kaydedilecek. Devam etmek istiyor musunuz?`);
            if (!confirmSync) return;
            
            try {
                showAlert('üì° Mesajlar Evolution API\'den √ßekiliyor...', 'info');
                
                // Fetch messages from Evolution API
                const receivedMessages = await fetchReceivedMessages(currentWhatsAppContact.phone);
                
                if (receivedMessages.length === 0) {
                    showAlert('‚ö†Ô∏è Kaydedilecek mesaj bulunamadƒ±.', 'warning');
                    return;
                }
                
                showAlert(`üíæ ${receivedMessages.length} mesaj Firebase'e kaydediliyor...`, 'info');
                
                let savedCount = 0;
                let errorCount = 0;
                
                // Save each message to Firebase
                for (const msg of receivedMessages) {
                    try {
                        await window.firebase.addDoc(
                            window.firebase.collection(window.db, 'whatsappMessages'),
                            {
                                phone: currentWhatsAppContact.phone,
                                contactName: currentWhatsAppContact.name,
                                message: msg.message,
                                timestamp: msg.timestamp,
                                messageId: msg.messageId,
                                fromMe: msg.fromMe || false,
                                instanceName: selectedWhatsAppDevice.instanceName,
                                clubId: currentUser.clubId,
                                savedAt: new Date().toISOString(),
                                source: 'evolution_api_sync'
                            }
                        );
                        savedCount++;
                    } catch (saveError) {
                        console.error('Error saving message:', saveError);
                        errorCount++;
                    }
                }
                
                // Also save sent messages if any
                const ourMessages = sentMessages.filter(m => 
                    m.recipientPhone === currentWhatsAppContact.phone && 
                    m.instanceName === selectedWhatsAppDevice.instanceName
                );
                
                for (const msg of ourMessages) {
                    try {
                        // Check if already saved
                        const existingQuery = window.firebase.query(
                            window.firebase.collection(window.db, 'whatsappMessages'),
                            window.firebase.where('timestamp', '==', msg.sentAt),
                            window.firebase.where('fromMe', '==', true),
                            window.firebase.where('phone', '==', currentWhatsAppContact.phone)
                        );
                        const existingDocs = await window.firebase.getDocs(existingQuery);
                        
                        if (existingDocs.empty) {
                            await window.firebase.addDoc(
                                window.firebase.collection(window.db, 'whatsappMessages'),
                                {
                                    phone: currentWhatsAppContact.phone,
                                    contactName: currentWhatsAppContact.name,
                                    message: msg.message,
                                    timestamp: msg.sentAt,
                                    messageId: msg.messageId || null,
                                    fromMe: true,
                                    instanceName: selectedWhatsAppDevice.instanceName,
                                    clubId: currentUser.clubId,
                                    savedAt: new Date().toISOString(),
                                    success: msg.success,
                                    source: 'admin_panel_sent'
                                }
                            );
                            savedCount++;
                        }
                    } catch (saveError) {
                        console.error('Error saving sent message:', saveError);
                        errorCount++;
                    }
                }
                
                showAlert(`‚úÖ Ba≈üarƒ±lƒ±! ${savedCount} mesaj Firebase'e kaydedildi${errorCount > 0 ? `, ${errorCount} hata` : ''}.`, 'success');
                
                console.log(`üìä Firebase Sync Sonucu: ${savedCount} ba≈üarƒ±lƒ±, ${errorCount} hata`);
                
            } catch (error) {
                console.error('Sync error:', error);
                showAlert('‚ùå Mesajlar kaydedilirken hata olu≈ütu: ' + error.message, 'danger');
            }
        };
        
        async function loadMessagesForContact(phone) {
            const messagesArea = document.getElementById('whatsapp-messages-area');
            messagesArea.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #667781;"><div style="text-align: center;"><div class="spinner" style="width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #25D366; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div><p>Mesajlar y√ºkleniyor...</p></div></div>';
            
            if (!selectedWhatsAppDevice) {
                messagesArea.innerHTML = '<div class="empty-state" style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"><p style="margin: 0; color: #666;">L√ºtfen √∂nce bir cihaz se√ßin</p></div>';
                return;
            }
            
            try {
                // Normalize phone number for comparison
                const normalizedPhone = formatPhoneForWhatsApp(phone);
                
                console.log(`üîç Mesaj arama: ${phone} ‚Üí ${normalizedPhone}`);
                console.log(`üì¶ sentMessages array'de toplam ${sentMessages.length} mesaj var`);
                
                // Debug: Show first few sent messages
                if (sentMessages.length > 0) {
                    console.log('üìù ƒ∞lk g√∂nderilen mesaj √∂rneƒüi:', {
                        recipientPhone: sentMessages[0].recipientPhone,
                        normalized: formatPhoneForWhatsApp(sentMessages[0].recipientPhone || ''),
                        instanceName: sentMessages[0].instanceName,
                        currentInstance: selectedWhatsAppDevice.instanceName
                    });
                }
                
                // Get messages from sentMessages (our sent messages)
                const ourMessages = sentMessages.filter(m => {
                    const recipientNormalized = formatPhoneForWhatsApp(m.recipientPhone || '');
                    const matches = recipientNormalized === normalizedPhone && 
                                   m.instanceName === selectedWhatsAppDevice.instanceName;
                    
                    // Debug: Log filtering
                    if (recipientNormalized === normalizedPhone && !matches) {
                        console.log(`‚ö†Ô∏è Telefon e≈üle≈üti ama instance farklƒ±: ${m.instanceName} vs ${selectedWhatsAppDevice.instanceName}`);
                    }
                    
                    return matches;
                }).map(m => ({
                    type: 'sent',
                    message: m.message,
                    timestamp: m.sentAt,
                    success: m.success
                }));
                
                console.log(`üí¨ G√∂nderilen mesajlar (Firebase): ${ourMessages.length} adet (${normalizedPhone} i√ßin)`);
                
                // Get ALL messages from Evolution API (including sent and received)
                const evolutionMessages = await fetchReceivedMessages(phone);
                console.log(`üì° Evolution API mesajlarƒ±: ${evolutionMessages.length} adet (${evolutionMessages.filter(m => m.type === 'sent').length} g√∂nderilen, ${evolutionMessages.filter(m => m.type === 'received').length} alƒ±nan)`);
                
                // Evolution API'den gelen mesajlarƒ± kullan (zaten type'larƒ± var)
                const receivedMessages = evolutionMessages.filter(m => !m.fromMe).map(m => ({
                    type: 'received',
                    message: m.message,
                    timestamp: m.timestamp,
                    sender: m.sender
                }));
                
                const sentFromEvolution = evolutionMessages.filter(m => m.fromMe).map(m => ({
                    type: 'sent',
                    message: m.message,
                    timestamp: m.timestamp,
                    success: true
                }));
                
                // Combine and sort all messages by timestamp
                // Use Evolution API sent messages + Firebase fallback + received messages
                const allMessages = [
                    ...sentFromEvolution,  // ‚Üê Evolution API'den gelen sent mesajlar (√∂ncelikli)
                    ...ourMessages,        // ‚Üê Firebase'den gelen sent mesajlar (fallback)
                    ...receivedMessages    // ‚Üê Evolution API'den gelen received mesajlar
                ]
                .filter((msg, index, self) => {
                    // Remove duplicates based on timestamp and message
                    return index === self.findIndex(m => 
                        Math.abs(new Date(m.timestamp) - new Date(msg.timestamp)) < 2000 && // 2 saniye tolerans
                        m.message === msg.message
                    );
                })
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                console.log(`üìä Toplam ${allMessages.length} mesaj (Evolution: ${sentFromEvolution.length} sent + ${receivedMessages.length} received, Firebase: ${ourMessages.length} sent)`);
                
                // Debug: Log all message types
                console.log('üìù Mesaj detaylarƒ±:', {
                    sentFromEvolution: sentFromEvolution.slice(0, 3),
                    ourMessages: ourMessages.slice(0, 3),
                    receivedMessages: receivedMessages.slice(0, 3),
                    allMessages: allMessages.slice(0, 5)
                });
                
                if (allMessages.length === 0) {
                    messagesArea.innerHTML = `
                        <div class="empty-state">
                            <p>Hen√ºz mesaj yok. ƒ∞lk mesajƒ± g√∂nderin! üëã</p>
                        </div>
                    `;
                    return;
                }
                
                // Group messages by date
                const messagesByDate = {};
                allMessages.forEach(msg => {
                    const date = new Date(msg.timestamp).toLocaleDateString('tr-TR');
                    if (!messagesByDate[date]) messagesByDate[date] = [];
                    messagesByDate[date].push(msg);
                });
                
                // Render messages
                messagesArea.innerHTML = Object.keys(messagesByDate).map(date => {
                    const msgs = messagesByDate[date];
                    return `
                        <div style="text-align: center; margin: 15px 0;">
                            <span class="message-date-divider">${date}</span>
                        </div>
                        ${msgs.map(msg => {
                            if (msg.type === 'sent') {
                                return `
                                    <div class="whatsapp-message-wrapper sent">
                                        <div class="whatsapp-message sent">
                                            <div class="message-content">${escapeHtml(msg.message)}</div>
                                            <div class="message-time">${formatTime(msg.timestamp)} ${msg.success ? '<span class="message-check">‚úì‚úì</span>' : '‚úó'}</div>
                                        </div>
                                    </div>
                                `;
                            } else {
                                return `
                                    <div class="whatsapp-message-wrapper received">
                                        <div class="whatsapp-message received">
                                            <div class="message-content">${escapeHtml(msg.message)}</div>
                                            <div class="message-time">${formatTime(msg.timestamp)}</div>
                                        </div>
                                    </div>
                                `;
                            }
                        }).join('')}
                    `;
                }).join('');
                
                // Scroll to bottom
                messagesArea.scrollTop = messagesArea.scrollHeight;
            } catch (error) {
                console.error('Error loading messages:', error);
                messagesArea.innerHTML = `
                    <div class="empty-state">
                        <p style="color: #f44336;">‚ö†Ô∏è Mesajlar y√ºklenirken hata olu≈ütu.</p>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }
        
        async function fetchReceivedMessages(phone) {
            try {
                // Use the selected device
                if (!selectedWhatsAppDevice) {
                    console.log('No device selected for fetching messages');
                    return [];
                }
                
                const device = selectedWhatsAppDevice;
                const evolutionUrl = device.evolutionUrl || EVOLUTION_API_URL;
                const apiKey = device.apiKey || EVOLUTION_API_KEY;
                
                console.log(`üì± Fetching messages for ${phone} from device ${device.instanceName}`);
                console.log(`üîó Using Evolution API: ${evolutionUrl}`);
                
                // Format phone number correctly
                let formattedPhone = phone.replace(/\D/g, '');
                
                // Ensure phone starts with country code (12 digits: 905449367543)
                if (formattedPhone.startsWith('0') && formattedPhone.length === 11) {
                    // 05449367543 ‚Üí 905449367543
                    formattedPhone = '90' + formattedPhone.substring(1);
                } else if (!formattedPhone.startsWith('90') && formattedPhone.length === 10) {
                    // 5449367543 ‚Üí 905449367543
                    formattedPhone = '90' + formattedPhone;
                } else if (formattedPhone.startsWith('90') && formattedPhone.length === 12) {
                    // Already correct: 905449367543
                    // Do nothing
                } else {
                    console.warn(`‚ö†Ô∏è Ge√ßersiz telefon formatƒ±: ${phone} ‚Üí ${formattedPhone} (${formattedPhone.length} hane)`);
                }
                
                const remoteJid = `${formattedPhone}@s.whatsapp.net`;
                
                console.log(`üìû Remote JID: ${remoteJid} (${formattedPhone.length} hane)`);
                
                // ‚úÖ Evolution API v2.x endpoints
                const endpoints = [
                    // Method 1: Chat messages endpoint (recommended)
                    {
                        url: `${evolutionUrl}/chat/findMessages/${device.instanceName}`,
                        body: {
                            where: {
                                key: {
                                    remoteJid: remoteJid
                                }
                            },
                            limit: 100
                        }
                    },
                    // Method 2: Message fetch endpoint
                    {
                        url: `${evolutionUrl}/message/find/${device.instanceName}`,
                        body: {
                            where: {
                                key: {
                                    remoteJid: remoteJid
                                }
                            },
                            limit: 100
                        }
                    },
                    // Method 3: Chat find with messages
                    {
                        url: `${evolutionUrl}/chat/find/${device.instanceName}`,
                        body: {
                            where: {
                                id: remoteJid
                            }
                        }
                    }
                ];
                
                let allMessages = [];
                
                for (const endpoint of endpoints) {
                    try {
                        console.log(`üîç Trying endpoint: ${endpoint.url}`);
                        
                        const response = await fetch(endpoint.url, {
                            method: 'POST',
                            headers: {
                                'apikey': apiKey,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(endpoint.body)
                        });
                        
                        console.log(`üìä Response status: ${response.status}`);
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log(`‚úÖ Success with endpoint, data structure:`, Object.keys(data));
                            console.log(`üì¶ Full data (JSON):`, JSON.stringify(data, null, 2));
                            
                            // Parse different response structures
                            let messages = [];
                            
                            // Evolution API v2 Response Formats:
                            
                            // Format 1: Direct array of messages
                            if (Array.isArray(data)) {
                                console.log(`üîç Format 1: Direct array, length: ${data.length}`);
                                
                                // Check if it's array of chat objects with messages inside
                                if (data.length > 0 && data[0].messages) {
                                    console.log(`üîç Format 1a: Array of chat objects`);
                                    // Merge all messages from all chats
                                    data.forEach(chat => {
                                        if (chat.messages && Array.isArray(chat.messages)) {
                                            messages.push(...chat.messages);
                                        }
                                    });
                                } else if (data.length > 0 && data[0].key) {
                                    // Direct array of message objects
                                    console.log(`üîç Format 1b: Direct message array`);
                                    messages = data;
                                } else {
                                    console.log(`üîç Format 1c: Unknown array structure`, data[0]);
                                }
                            }
                            // Format 2: data.messages.records array (Evolution API v2 paginated)
                            else if (data.messages && data.messages.records && Array.isArray(data.messages.records)) {
                                console.log(`üîç Format 2a: data.messages.records (paginated response)`);
                                console.log(`üìä Total messages available: ${data.messages.total}, Current page: ${data.messages.currentPage}/${data.messages.pages}`);
                                messages = data.messages.records;
                            }
                            // Format 2b: data.messages array
                            else if (data.messages && Array.isArray(data.messages)) {
                                console.log(`üîç Format 2b: data.messages array`);
                                messages = data.messages;
                            }
                            // Format 3: data.data array
                            else if (data.data && Array.isArray(data.data)) {
                                console.log(`üîç Format 3: data.data array`);
                                messages = data.data;
                            }
                            // Format 4: Wrapped response
                            else if (data.response && Array.isArray(data.response)) {
                                console.log(`üîç Format 4: data.response array`);
                                messages = data.response;
                            }
                            // Format 5: Single chat object
                            else if (data.id && data.messages) {
                                console.log(`üîç Format 5: Single chat object`);
                                messages = data.messages;
                            }
                            
                            console.log(`üìù Found ${messages.length} total messages`);
                            console.log(`üìù Sample message structure:`, messages[0]);
                            
                            // Extract message content
                            const parsedMessages = messages
                                .map(m => {
                                    // Extract message text from various formats
                                    let messageText = '';
                                    if (m.message) {
                                        messageText = m.message.conversation 
                                            || m.message.extendedTextMessage?.text
                                            || m.message.imageMessage?.caption
                                            || m.message.videoMessage?.caption
                                            || m.message.documentMessage?.caption
                                            || '';
                                    }
                                    
                                    if (!messageText) return null;
                                    
                                    // Check if this is from us (fromMe: true)
                                    const isFromMe = m.key?.fromMe === true;
                                    
                                    return {
                                        message: messageText,
                                        timestamp: m.messageTimestamp 
                                            ? new Date(m.messageTimestamp * 1000).toISOString() 
                                            : new Date().toISOString(),
                                        sender: phone,
                                        messageId: m.key?.id || Math.random().toString(36),
                                        fromMe: isFromMe,
                                        type: isFromMe ? 'sent' : 'received' // ‚Üê Yeni!
                                    };
                                })
                                .filter(m => m !== null);
                            
                            console.log(`‚úÖ Parsed ${parsedMessages.length} messages (${parsedMessages.filter(m => m.type === 'sent').length} sent, ${parsedMessages.filter(m => m.type === 'received').length} received)`);
                            
                            if (parsedMessages.length > 0) {
                                allMessages = parsedMessages;
                                break; // Success, stop trying other endpoints
                            }
                        } else {
                            const errorText = await response.text();
                            console.log(`‚ùå Endpoint failed: ${response.status} - ${errorText}`);
                        }
                    } catch (endpointError) {
                        console.error(`‚ùå Endpoint error:`, endpointError);
                    }
                }
                
                if (allMessages.length === 0) {
                    console.warn('‚ö†Ô∏è No messages found from any endpoint');
                    console.log('üí° Tip: Make sure webhook is configured and messages are being stored in Evolution API');
                }
                
                return allMessages;
            } catch (error) {
                console.error('‚ùå Error fetching received messages:', error);
                return [];
            }
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function loadWhatsAppDevicesMain() {
            const container = document.getElementById('whatsappDevicesList-main');
            
            const userDevices = currentUser.isSuperAdmin 
                ? whatsappDevices 
                : whatsappDevices.filter(d => d.createdBy === currentUser.email);
            
            if (userDevices.length === 0) {
                container.innerHTML = '<p class="empty-state">Hen√ºz baƒülƒ± cihaz yok.</p>';
                return;
            }
            
            container.innerHTML = userDevices.map(device => `
                <div class="settings-subsection" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 5px 0;">${device.instanceName}</h4>
                            <small style="color: #666;">üìû ${device.phoneNumber}</small><br>
                            <small style="color: #666;">üÜî ${device.instanceName}</small><br>
                            <small>Durum: <span class="badge ${device.status === 'connected' ? 'bg-success' : device.status === 'pending' ? 'bg-warning' : 'bg-danger'}">${device.status === 'connected' ? 'üü¢ Baƒülƒ±' : device.status === 'pending' ? 'üü° Beklemede' : 'üî¥ Baƒülƒ± Deƒüil'}</span></small>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                            ${device.status !== 'connected' ? `<button class="btn btn-sm btn-primary" onclick="window.showInstanceQR('${device.instanceName}')">üì± QR G√∂ster</button>` : ''}
                            <button class="btn btn-sm btn-secondary" onclick="window.checkConnectionStatus('${device.instanceName}', '${device.id}')">‚úîÔ∏è Durum</button>
                            <button class="btn btn-sm btn-warning" onclick="window.restartInstance('${device.instanceName}', '${device.id}')">üîÑ Yenile</button>
                            <button class="btn btn-sm btn-danger" onclick="window.deleteInstance('${device.instanceName}', '${device.id}')">üóëÔ∏è Sil</button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Update webhook device dropdown
            updateWebhookDeviceDropdown();
            
            // ‚úÖ Load WhatsApp settings into form fields
            document.getElementById('minWaitTime').value = clubSettings.minWaitTime || 20;
            document.getElementById('maxWaitTime').value = clubSettings.maxWaitTime || 50;
            document.getElementById('longWaitTrigger').value = clubSettings.longWaitTrigger || 100;
            document.getElementById('minLongWait').value = clubSettings.minLongWait || 400;
            document.getElementById('maxLongWait').value = clubSettings.maxLongWait || 800;
        }
        
        // Edit Device
        function editDevice(deviceId) {
            const device = whatsappDevices.find(d => d.id === deviceId);
            if (!device) {
                showAlert('Cihaz bulunamadƒ±', 'danger');
                return;
            }
            
            const modalHtml = `
                <div style="padding: 20px;">
                    <h3 style="margin-bottom: 20px;">‚úèÔ∏è Cihaz D√ºzenle: ${device.instanceName}</h3>
                    <form id="editDeviceForm" onsubmit="saveDeviceEdit(event, '${deviceId}')">
                        <div class="form-group">
                            <label>Cihaz Adƒ±</label>
                            <input type="text" id="edit_instanceName" class="form-control" value="${device.instanceName}" readonly>
                            <small style="color: #666;">Cihaz adƒ± deƒüi≈ütirilemez</small>
                        </div>
                        <div class="form-group">
                            <label>Telefon Numarasƒ±</label>
                            <input type="tel" id="edit_phoneNumber" class="form-control" value="${device.phoneNumber}" readonly>
                            <small style="color: #666;">Telefon numarasƒ± deƒüi≈ütirilemez</small>
                        </div>
                        <div class="form-group">
                            <label>Evolution API URL *</label>
                            <input type="url" id="edit_evolutionUrl" class="form-control" value="${device.evolutionUrl || ''}" placeholder="https://evo.example.com" required>
                            <small style="color: #666;">Evolution API sunucunuzun adresi</small>
                        </div>
                        <div class="form-group">
                            <label>API Key *</label>
                            <input type="text" id="edit_apiKey" class="form-control" value="${device.apiKey || ''}" placeholder="your-api-key" required>
                            <small style="color: #666;">Evolution API anahtarƒ±nƒ±z</small>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-success">üíæ Kaydet</button>
                            <button type="button" class="btn btn-secondary" onclick="closeAlert()">ƒ∞ptal</button>
                        </div>
                    </form>
                </div>
            `;
            
            showAlert(modalHtml, 'info');
        }
        
        async function saveDeviceEdit(event, deviceId) {
            event.preventDefault();
            
            const evolutionUrl = document.getElementById('edit_evolutionUrl').value.trim();
            const apiKey = document.getElementById('edit_apiKey').value.trim();
            
            if (!evolutionUrl || !apiKey) {
                showAlert('L√ºtfen t√ºm alanlarƒ± doldurun', 'danger');
                return;
            }
            
            try {
                const { updateDoc, doc } = window.firebase;
                await updateDoc(doc(window.db, 'whatsappDevices', deviceId), {
                    evolutionUrl: evolutionUrl,
                    apiKey: apiKey,
                    updatedAt: new Date().toISOString()
                });
                
                // Update local data
                const device = whatsappDevices.find(d => d.id === deviceId);
                if (device) {
                    device.evolutionUrl = evolutionUrl;
                    device.apiKey = apiKey;
                }
                
                showAlert('‚úÖ Cihaz bilgileri g√ºncellendi!', 'success');
                loadWhatsAppDevicesMain();
            } catch (error) {
                console.error('Error updating device:', error);
                showAlert('G√ºncelleme hatasƒ±: ' + error.message, 'danger');
            }
        }
        
        window.editDevice = editDevice;
        window.saveDeviceEdit = saveDeviceEdit;
        
        // === WEBHOOK MANAGEMENT FUNCTIONS ===
        
        function updateWebhookDeviceDropdown() {
            const select = document.getElementById('webhookDevice');
            if (!select) return;
            
            const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
            
            if (connectedDevices.length === 0) {
                select.innerHTML = '<option value="">√ñnce cihaz baƒülayƒ±n...</option>';
                return;
            }
            
            select.innerHTML = '<option value="">Cihaz se√ßin...</option>' +
                connectedDevices.map(d => `<option value="${d.instanceName}">${d.instanceName} (${d.phoneNumber})</option>`).join('');
        }
        
        async function loadWebhookForDevice(instanceName) {
            if (!instanceName) {
                document.getElementById('webhookUrl').value = '';
                document.getElementById('webhookEnabled').checked = true;
                document.getElementById('webhookStatus').style.display = 'none';
                return;
            }
            
            const device = whatsappDevices.find(d => d.instanceName === instanceName);
            if (!device) return;
            
            // Check if evolutionUrl exists
            if (!device.evolutionUrl || device.evolutionUrl === 'undefined') {
                showAlert('‚ö†Ô∏è Bu cihazƒ±n Evolution API URL\'si tanƒ±mlanmamƒ±≈ü. L√ºtfen WhatsApp ayarlarƒ±ndan cihazƒ± d√ºzenleyin ve Evolution API URL\'sini ekleyin.', 'danger');
                console.error('Device missing evolutionUrl:', device);
                return;
            }
            
            try {
                // Fetch current webhook config from Evolution API
                const response = await fetch(`${device.evolutionUrl}/webhook/find/${instanceName}`, {
                    method: 'GET',
                    headers: {
                        'apikey': device.apiKey
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update form fields
                    document.getElementById('webhookUrl').value = data.url || '';
                    document.getElementById('webhookEnabled').checked = data.enabled !== false;
                    
                    // Update event checkboxes
                    document.querySelectorAll('input[name="webhookEvents"]').forEach(cb => {
                        cb.checked = data.events && data.events.includes(cb.value);
                    });
                    
                    // Show webhook status
                    showWebhookStatus(data);
                } else {
                    console.log('No webhook configured for this device yet');
                    document.getElementById('webhookUrl').value = '';
                    document.getElementById('webhookEnabled').checked = true;
                    document.getElementById('webhookStatus').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading webhook:', error);
                showAlert('Webhook bilgileri y√ºklenirken hata olu≈ütu: ' + error.message, 'danger');
            }
        }
        
        async function saveWebhookConfig(event) {
            event.preventDefault();
            
            const instanceName = document.getElementById('webhookDevice').value;
            const webhookUrl = document.getElementById('webhookUrl').value;
            const enabled = document.getElementById('webhookEnabled').checked;
            
            if (!instanceName) {
                showAlert('L√ºtfen bir cihaz se√ßin.', 'danger');
                return;
            }
            
            const device = whatsappDevices.find(d => d.instanceName === instanceName);
            if (!device) {
                showAlert('Cihaz bulunamadƒ±.', 'danger');
                return;
            }
            
            // Check if evolutionUrl exists
            if (!device.evolutionUrl || device.evolutionUrl === 'undefined') {
                showAlert('‚ö†Ô∏è Bu cihazƒ±n Evolution API URL\'si tanƒ±mlanmamƒ±≈ü. L√ºtfen WhatsApp ayarlarƒ±ndan cihazƒ± d√ºzenleyin ve Evolution API URL\'sini ekleyin.', 'danger');
                console.error('Device missing evolutionUrl:', device);
                return;
            }
            
            // Get selected events
            const selectedEvents = Array.from(document.querySelectorAll('input[name="webhookEvents"]:checked'))
                .map(cb => cb.value);
            
            if (selectedEvents.length === 0) {
                showAlert('En az bir event se√ßmelisiniz.', 'danger');
                return;
            }
            
            try {
                const response = await fetch(`${device.evolutionUrl}/webhook/set/${instanceName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': device.apiKey
                    },
                    body: JSON.stringify({
                        enabled: enabled,
                        url: webhookUrl,
                        webhookByEvents: false,
                        webhookBase64: true,
                        events: selectedEvents
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showAlert('‚úÖ Webhook ba≈üarƒ±yla kaydedildi!', 'success');
                    showWebhookStatus(data.webhook || {
                        enabled: enabled,
                        url: webhookUrl,
                        events: selectedEvents
                    });
                    
                    // Save to Firebase for tracking
                    await window.firebase.updateDoc(
                        window.firebase.doc(window.db, 'whatsappDevices', device.id),
                        {
                            webhookUrl: webhookUrl,
                            webhookEnabled: enabled,
                            webhookEvents: selectedEvents,
                            webhookLastUpdated: new Date().toISOString()
                        }
                    );
                } else {
                    const error = await response.text();
                    throw new Error(error || 'Webhook kaydedilemedi');
                }
            } catch (error) {
                console.error('Error saving webhook:', error);
                showAlert('Webhook kaydedilirken hata olu≈ütu: ' + error.message, 'danger');
            }
        }
        
        function showWebhookStatus(webhookData) {
            const statusDiv = document.getElementById('webhookStatus');
            const contentDiv = document.getElementById('webhookStatusContent');
            
            if (!webhookData || !webhookData.url) {
                statusDiv.style.display = 'none';
                return;
            }
            
            const statusHtml = `
                <div style="display: grid; gap: 10px;">
                    <div>
                        <strong>Webhook URL:</strong><br>
                        <code style="background: #f0f0f0; padding: 5px 10px; border-radius: 4px; display: inline-block; margin-top: 5px; word-break: break-all;">
                            ${webhookData.url}
                        </code>
                    </div>
                    <div>
                        <strong>Durum:</strong> 
                        <span class="badge ${webhookData.enabled ? 'bg-success' : 'bg-secondary'}">
                            ${webhookData.enabled ? '‚úÖ Etkin' : '‚ùå Devre Dƒ±≈üƒ±'}
                        </span>
                    </div>
                    <div>
                        <strong>ƒ∞zlenen Event'ler:</strong><br>
                        ${(webhookData.events || []).map(e => `<span class="badge bg-info" style="margin-right: 5px;">${e}</span>`).join('')}
                    </div>
                </div>
            `;
            
            contentDiv.innerHTML = statusHtml;
            statusDiv.style.display = 'block';
        }
        
        async function testWebhook() {
            const instanceName = document.getElementById('webhookDevice').value;
            const webhookUrl = document.getElementById('webhookUrl').value;
            
            if (!instanceName || !webhookUrl) {
                showAlert('L√ºtfen cihaz ve webhook URL se√ßin.', 'danger');
                return;
            }
            
            try {
                // Send a test POST request to the webhook URL
                const testData = {
                    event: "webhook_test",
                    instance: instanceName,
                    data: {
                        message: "Bu bir test mesajƒ±dƒ±r",
                        timestamp: new Date().toISOString(),
                        from: "Admin Panel"
                    }
                };
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                if (response.ok) {
                    showAlert('‚úÖ Webhook test ba≈üarƒ±lƒ±! URL\'niz √ßalƒ±≈üƒ±yor.', 'success');
                } else {
                    showAlert(`‚ö†Ô∏è Webhook yanƒ±t verdi ama hata kodu d√∂nd√º: ${response.status}`, 'warning');
                }
            } catch (error) {
                console.error('Webhook test error:', error);
                showAlert('‚ùå Webhook test ba≈üarƒ±sƒ±z. URL eri≈üilebilir deƒüil: ' + error.message, 'danger');
            }
        }
        
        window.loadWebhookForDevice = loadWebhookForDevice;
        window.saveWebhookConfig = saveWebhookConfig;
        window.testWebhook = testWebhook;
        
        function loadBulkMessageForm() {
            // This function is now handled by onBulkBranchChange
            // Groups are loaded dynamically based on selected branch
        }
        
        function formatPhoneForWhatsApp(phone) {
            if (!phone) return '';
            phone = phone.replace(/\D/g, '');
            if (phone.startsWith('0')) {
                phone = '90' + phone.substring(1);
            } else if (!phone.startsWith('90')) {
                phone = '90' + phone;
            }
            return phone;
        }
        
        // Telefon numarasƒ±nƒ± g√∂rsel formatlama (05xx xxx xxxx)
        function formatPhoneDisplay(phone) {
            if (!phone) return '';
            
            // T√ºm rakam olmayan karakterleri temizle
            let cleaned = phone.replace(/\D/g, '');
            
            // 90 ile ba≈ülƒ±yorsa 0'a √ßevir
            if (cleaned.startsWith('90') && cleaned.length === 12) {
                cleaned = '0' + cleaned.substring(2);
            }
            
            // 0 ile ba≈ülayan 11 haneli T√ºrkiye numarasƒ± formatƒ±
            if (cleaned.startsWith('0') && cleaned.length === 11) {
                return `${cleaned.substring(0, 4)} ${cleaned.substring(4, 7)} ${cleaned.substring(7, 9)} ${cleaned.substring(9)}`;
            }
            
            // Diƒüer formatlar i√ßin olduƒüu gibi d√∂nd√ºr
            return phone;
        }
        
        async function handleWhatsAppSendMessage(e) {
            e.preventDefault();
            const form = e.target;
            const phone = form.querySelector('#whatsapp-selected-number').value;
            const message = form.querySelector('#whatsapp-message-text').value.trim();
            
            if (!phone || !message) {
                showAlert('Telefon numarasƒ± ve mesaj gerekli!', 'danger');
                return;
            }
            
            // Use the selected device from the main dropdown
            if (!selectedWhatsAppDevice) {
                showAlert('L√ºtfen √∂nce bir WhatsApp cihazƒ± se√ßin!', 'danger');
                return;
            }
            
            const device = selectedWhatsAppDevice;
            
            // Send message
            console.log(`üì§ Sending message from device: ${device.instanceName} (${device.phoneNumber})`);
            const result = await sendWhatsAppMessage(device.instanceName, phone, message, currentWhatsAppContact.name);
            const success = result?.success || result === true; // Handle both object and boolean return
            
            if (success) {
                const textarea = form.querySelector('#whatsapp-message-text');
                textarea.value = '';
                textarea.style.height = 'auto'; // Reset height
                showAlert(`‚úÖ Mesaj g√∂nderildi!`, 'success');
                
                // Reload sent messages from Firebase first
                console.log('üîÑ Reloading sent messages...');
                try {
                    const messagesSnapshot = await window.firebase.getDocs(
                        window.firebase.query(
                            window.firebase.collection(window.db, 'sentMessages'),
                            window.firebase.where('clubId', '==', currentClubId),
                            window.firebase.orderBy('sentAt', 'desc')
                        )
                    );
                    sentMessages = messagesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).slice(0, 50); // Artƒ±k 50 mesaj
                    console.log(`‚úÖ Reloaded ${sentMessages.length} sent messages`);
                } catch (e) {
                    console.warn('‚ö†Ô∏è Could not reload sent messages:', e);
                }
                
                // Reload messages and scroll to bottom
                setTimeout(() => {
                    loadMessagesForContact(phone);
                }, 500);
            } else {
                showAlert('‚ùå Mesaj g√∂nderilemedi!', 'danger');
            }
        }
        
        let selectedBulkGroups = [];
        let currentBranchGroups = []; // Arama i√ßin mevcut gruplarƒ± sakla
        
        function onBulkBranchChange() {
            const branch = document.getElementById('bulk-branch-selector').value;
            selectedBulkGroups = [];
            
            if (!branch) {
                document.getElementById('bulk-groups-container').style.display = 'none';
                document.getElementById('bulk-recipients-container').style.display = 'none';
                return;
            }
            
            // Show groups for selected branch
            const branchGroups = branch === 'all' 
                ? groups 
                : groups.filter(g => g.branch === branch);
            
            currentBranchGroups = branchGroups; // Arama i√ßin sakla
            renderBulkGroups(branchGroups);
            
            document.getElementById('bulk-groups-container').style.display = 'block';
            document.getElementById('bulk-group-search').value = ''; // Arama kutusunu temizle
            
            // Hide recipients container until groups are confirmed
            document.getElementById('bulk-recipients-container').style.display = 'none';
        }
        
        function renderBulkGroups(groupsToRender) {
            const groupsListHTML = groupsToRender.map(g => {
                const memberCount = members.filter(m => (g.members || []).includes(m.id) && m.status === 'active').length;
                return `
                    <div class="form-check bulk-group-item" data-group-name="${g.groupName.toLowerCase()}" style="padding: 10px; border-bottom: 1px solid #eee;">
                        <input class="form-check-input bulk-group-checkbox" type="checkbox" value="${g.id}" id="bulkGroup${g.id}" onchange="updateBulkRecipients()">
                        <label class="form-check-label" for="bulkGroup${g.id}" style="cursor: pointer; width: 100%;">
                            <strong>${g.groupName}</strong> <span style="color: #666;">(${memberCount} ki≈üi)</span>
                            <br><small style="color: #999;">${g.branch === 'tenis' ? 'üéæ' : 'üèä'} ${g.branch}</small>
                        </label>
                    </div>
                `;
            }).join('');
            
            document.getElementById('bulk-groups-list').innerHTML = groupsListHTML || '<p class="empty-state">Bu bran≈üta grup bulunamadƒ±</p>';
        }
        
        window.filterBulkGroups = function() {
            const searchTerm = document.getElementById('bulk-group-search').value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderBulkGroups(currentBranchGroups);
                return;
            }
            
            const filteredGroups = currentBranchGroups.filter(g => 
                g.groupName.toLowerCase().includes(searchTerm)
            );
            
            renderBulkGroups(filteredGroups);
        };
        
        window.selectAllGroups = function() {
            document.querySelectorAll('.bulk-group-checkbox').forEach(cb => {
                cb.checked = true;
            });
        };
        
        window.deselectAllGroups = function() {
            document.querySelectorAll('.bulk-group-checkbox').forEach(cb => {
                cb.checked = false;
            });
        };
        
        window.confirmGroupSelection = function() {
            const selectedCheckboxes = document.querySelectorAll('.bulk-group-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                showAlert('L√ºtfen en az bir grup se√ßin!', 'warning');
                return;
            }
            
            selectedBulkGroups = Array.from(selectedCheckboxes).map(cb => cb.value);
            showAlert(`${selectedBulkGroups.length} grup se√ßildi! ≈ûimdi ki≈üileri se√ßin.`, 'success');
            loadBulkRecipients();
        };
        
        window.selectAllRecipients = function() {
            document.querySelectorAll('.bulk-recipient-checkbox').forEach(cb => {
                cb.checked = true;
            });
            updateRecipientCount();
        };
        
        window.deselectAllRecipients = function() {
            document.querySelectorAll('.bulk-recipient-checkbox').forEach(cb => {
                cb.checked = false;
            });
            updateRecipientCount();
        };
        
        window.confirmRecipientSelection = function() {
            const selectedCheckboxes = document.querySelectorAll('.bulk-recipient-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                showAlert('L√ºtfen en az bir ki≈üi se√ßin!', 'warning');
                return;
            }
            
            const count = selectedCheckboxes.length;
            showAlert(`${count} ki≈üi se√ßildi! Artƒ±k mesajƒ±nƒ±zƒ± yazƒ±p g√∂nderebilirsiniz.`, 'success');
            updateFinalRecipientCount();
        };
        
        function loadBulkRecipients() {
            // Get all members from selected groups
            const recipientMembers = members.filter(m => 
                (m.status === 'active' || m.status === 'pending') &&
                (m.Telefon || m.Telefon_2) &&
                selectedBulkGroups.some(groupId => {
                    const group = groups.find(g => g.id === groupId);
                    return group && (group.members || []).includes(m.id);
                })
            );
            
            // Build recipients list including both parent phones
            const uniqueRecipients = [];
            const seenPhones = new Set();
            
            recipientMembers.forEach(m => {
                const memberName = m.Resit_Olmayan_Adi_Soyadi || m.Ad_Soyad || 'ƒ∞simsiz';
                
                // Add first parent (Telefon)
                if (m.Telefon) {
                    const phone1 = formatPhoneForWhatsApp(m.Telefon);
                    if (!seenPhones.has(phone1)) {
                        seenPhones.add(phone1);
                        uniqueRecipients.push({
                            memberId: m.id,
                            memberName: memberName,
                            phone: phone1,
                            parentName: m.Ad_Soyad || memberName,
                            label: '1. Veli',
                            isChild: !!m.Resit_Olmayan_Adi_Soyadi
                        });
                    }
                }
                
                // Add second parent (Telefon_2)
                if (m.Telefon_2 && m.Telefon_2.trim() !== '') {
                    const phone2 = formatPhoneForWhatsApp(m.Telefon_2);
                    if (!seenPhones.has(phone2)) {
                        seenPhones.add(phone2);
                        uniqueRecipients.push({
                            memberId: m.id,
                            memberName: memberName,
                            phone: phone2,
                            parentName: m.Veli_2_Adi_Soyadi || m.Ad_Soyad || memberName,
                            label: '2. Veli',
                            isChild: !!m.Resit_Olmayan_Adi_Soyadi
                        });
                    }
                }
            });
            
            if (uniqueRecipients.length === 0) {
                document.getElementById('bulk-recipients-list').innerHTML = '<p class="empty-state">Se√ßilen gruplarda telefon numarasƒ± olan ki≈üi bulunamadƒ±</p>';
                document.getElementById('bulk-recipients-container').style.display = 'block';
                return;
            }
            
            // Show recipients list with checkboxes
            const recipientsHTML = uniqueRecipients.map((recipient, index) => {
                return `
                <div class="form-check" style="padding: 8px; border-bottom: 1px solid #f0f0f0;">
                    <input class="form-check-input bulk-recipient-checkbox" type="checkbox" value="${recipient.memberId}" data-phone="${recipient.phone}" data-name="${recipient.parentName}" id="bulkRecipient${index}" onchange="updateRecipientCount()">
                    <label class="form-check-label" for="bulkRecipient${index}" style="cursor: pointer; width: 100%;">
                        <span style="color: #666; font-size: 12px;">${index + 1}.</span>
                        <strong>${recipient.parentName}</strong>
                        ${recipient.isChild ? `<span style="color: #999; font-size: 0.85em;">(${recipient.memberName} - ${recipient.label})</span>` : ''}
                        <small style="color: #666; margin-left: 10px;">üìû ${recipient.phone}</small>
                    </label>
                    <span class="badge bg-secondary recipient-status-badge" data-index="${index}">Bekliyor</span>
                </div>
            `}).join('');
            
            document.getElementById('bulk-recipients-list').innerHTML = recipientsHTML;
            document.getElementById('bulk-recipients-container').style.display = 'block';
            document.getElementById('bulk-recipient-count-badge').textContent = uniqueRecipients.length;
            
            // Auto-select all recipients by default
            setTimeout(() => {
                selectAllRecipients();
                updateRecipientCount();
            }, 100);
        }
        
        function updateRecipientCount() {
            const selectedCount = document.querySelectorAll('.bulk-recipient-checkbox:checked').length;
            document.getElementById('bulk-recipient-count-badge').textContent = selectedCount;
        }
        
        function updateFinalRecipientCount() {
            const selectedCount = document.querySelectorAll('.bulk-recipient-checkbox:checked').length;
            document.getElementById('bulk-final-count').textContent = selectedCount;
            
            // Calculate estimated time (5-45 seconds per message, average 25 seconds)
            const avgTime = 25;
            const totalSeconds = selectedCount * avgTime;
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            document.getElementById('bulk-estimated-time').textContent = `~${minutes} dk ${seconds} sn`;
        }
        
        async function handleBulkMessageSend(e) {
            e.preventDefault();
            const form = e.target;
            const messageTemplate = document.getElementById('bulk-message-text').value.trim();
            
            if (!messageTemplate) {
                showAlert('Mesaj metni gerekli!', 'danger');
                return;
            }
            
            // Get selected recipients from checkboxes
            const selectedCheckboxes = document.querySelectorAll('.bulk-recipient-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                showAlert('L√ºtfen en az bir ki≈üi se√ßin!', 'danger');
                return;
            }
            
            // Find connected device
            let device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
            if (!device) {
                device = whatsappDevices.find(d => d.status === 'connected');
            }
            
            if (!device) {
                showAlert('Baƒülƒ± WhatsApp cihazƒ± bulunamadƒ±!', 'danger');
                return;
            }
            
            // Build recipients list from selected checkboxes
            const uniqueRecipients = Array.from(selectedCheckboxes).map(cb => ({
                name: cb.dataset.name,
                phone: cb.dataset.phone,
                memberId: cb.value
            }));
            
            // Confirm
            if (!confirm(`${uniqueRecipients.length} ki≈üiye mesaj g√∂nderilecek. Devam edilsin mi?`)) {
                return;
            }
            
            // Show status panel
            document.getElementById('bulk-sending-status').style.display = 'block';
            document.getElementById('bulk-send-btn').disabled = true;
            document.getElementById('bulk-status-log').innerHTML = '';
            
            let successCount = 0;
            let failCount = 0;
            
            function addLog(message, type = 'info') {
                const logContainer = document.getElementById('bulk-status-log');
                const timestamp = new Date().toLocaleTimeString('tr-TR');
                const color = type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue';
                logContainer.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            addLog(`üöÄ G√∂nderim ba≈üladƒ±! Toplam ${uniqueRecipients.length} ki≈üi`);
            
            // Find which checkbox index corresponds to each recipient
            const checkboxes = Array.from(selectedCheckboxes);
            
            for (let i = 0; i < uniqueRecipients.length; i++) {
                const recipient = uniqueRecipients[i];
                const checkbox = checkboxes[i];
                const checkboxIndex = Array.from(document.querySelectorAll('.bulk-recipient-checkbox')).indexOf(checkbox);
                
                // Update status badge
                const statusBadge = document.querySelector(`.recipient-status-badge[data-index="${checkboxIndex}"]`);
                if (statusBadge) {
                    statusBadge.textContent = 'üì§ G√∂nderiliyor...';
                    statusBadge.className = 'badge bg-info recipient-status-badge';
                    statusBadge.dataset.index = checkboxIndex;
                }
                
                // Personalize message
                let personalizedMessage = messageTemplate;
                const uyeName = recipient.isChild ? recipient.parentName : recipient.parentName;
                const ogrenciName = recipient.isChild ? recipient.memberName : '';
                
                personalizedMessage = personalizedMessage.replace(/{UYE_AD_SOYAD}/g, uyeName);
                personalizedMessage = personalizedMessage.replace(/{OGRENCI_AD_SOYAD}/g, ogrenciName);
                // Backward compatibility for old templates
                personalizedMessage = personalizedMessage.replace(/{VELI_AD_SOYAD}/g, recipient.parentName);
                personalizedMessage = personalizedMessage.replace(/{AD_SOYAD}/g, uyeName).replace(/{AD}/g, uyeName);
                
                addLog(`üì® ${i + 1}/${uniqueRecipients.length}: ${recipient.parentName} (${recipient.phone})`);
                
                // Send message
                const result = await sendWhatsAppMessage(device.instanceName, recipient.phone, personalizedMessage, recipient.name);
                const success = result.success || result === true; // Backward compatibility
                
                if (success) {
                    successCount++;
                    if (statusBadge) {
                        statusBadge.textContent = '‚úÖ G√∂nderildi';
                        statusBadge.className = 'badge bg-success recipient-status-badge';
                        statusBadge.dataset.index = checkboxIndex;
                    }
                    addLog(`‚úÖ Ba≈üarƒ±lƒ±: ${recipient.name}`, 'success');
                } else {
                    failCount++;
                    const errorMsg = result.errorReason ? ` - ${result.errorReason}` : '';
                    if (statusBadge) {
                        statusBadge.textContent = '‚ùå Ba≈üarƒ±sƒ±z';
                        statusBadge.className = 'badge bg-danger recipient-status-badge';
                        statusBadge.dataset.index = checkboxIndex;
                        statusBadge.title = errorMsg ? result.errorReason : 'Bilinmeyen hata';
                    }
                    addLog(`‚ùå Ba≈üarƒ±sƒ±z: ${recipient.name}${errorMsg}`, 'error');
                }
                
                // Update progress bar
                const progress = ((i + 1) / uniqueRecipients.length) * 100;
                const progressBar = document.getElementById('bulk-progress-bar');
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${i + 1} / ${uniqueRecipients.length}`;
                
                // ‚úÖ Random wait time (ayarlardan)
                if (i < uniqueRecipients.length - 1) {
                    const messageCount = i + 1;
                    let waitTime;
                    
                    // Her X mesajda bir uzun bekleme
                    const shouldLongWait = (messageCount % (clubSettings.longWaitTrigger || 100)) === 0;
                    
                    if (shouldLongWait) {
                        const min = clubSettings.minLongWait || 400;
                        const max = clubSettings.maxLongWait || 800;
                        waitTime = Math.floor(Math.random() * (max - min + 1)) + min;
                        addLog(`‚è≥ UZUN BEKLEME: Sonraki mesaj i√ßin ${waitTime} saniye bekleniyor... (Her ${clubSettings.longWaitTrigger} mesajda bir)`, 'info');
                    } else {
                        const min = clubSettings.minWaitTime || 20;
                        const max = clubSettings.maxWaitTime || 50;
                        waitTime = Math.floor(Math.random() * (max - min + 1)) + min;
                        addLog(`‚è≥ Sonraki mesaj i√ßin ${waitTime} saniye bekleniyor...`);
                    }
                    
                    // Show countdown
                    for (let countdown = waitTime; countdown > 0; countdown--) {
                        if (statusBadge) {
                            statusBadge.textContent = `‚è≥ ${countdown}s`;
                            statusBadge.className = 'badge bg-warning recipient-status-badge';
                            statusBadge.dataset.index = checkboxIndex;
                        }
                        await new Promise(resolve => setTimeout(resolve, 400));
                    }
                }
            }
            
            addLog(`üéâ G√∂nderim tamamlandƒ±! Ba≈üarƒ±lƒ±: ${successCount}, Ba≈üarƒ±sƒ±z: ${failCount}`, 'success');
            
            showAlert(`Toplu mesaj g√∂nderimi tamamlandƒ±! ‚úÖ ${successCount} ba≈üarƒ±lƒ±, ‚ùå ${failCount} ba≈üarƒ±sƒ±z`, 'success');
            
            document.getElementById('bulk-send-btn').disabled = false;
            
            // Reset form after 5 seconds
            setTimeout(() => {
                document.getElementById('bulk-sending-status').style.display = 'none';
            }, 5000);
        }
        
        async function fetchAndShowQR(instanceName, deviceId) {
            try {
                const response = await fetch(`${EVOLUTION_API_URL}/instance/connect/${instanceName}`, {
                    method: 'GET',
                    headers: {
                        'apikey': EVOLUTION_API_KEY
                    }
                });
                
                const data = await response.json();
                
                // Try different response formats
                let qrBase64 = null;
                
                if (data.qrcode && data.qrcode.base64) {
                    qrBase64 = data.qrcode.base64;
                } else if (data.base64) {
                    qrBase64 = data.base64;
                } else if (data.code) {
                    qrBase64 = data.code;
                } else if (typeof data === 'string' && data.startsWith('data:image')) {
                    qrBase64 = data;
                }
                
                if (qrBase64) {
                    showQRCodeModal(instanceName, qrBase64, deviceId);
                } else {
                    closeModal('qrCodeModal');
                    showAlert('‚ö†Ô∏è QR kod alƒ±namadƒ±. Cihaz listesinden "QR Kod" butonuna tƒ±klayƒ±n.', 'warning');
                }
            } catch (error) {
                closeModal('qrCodeModal');
                showAlert('‚ö†Ô∏è QR kod y√ºklenemedi. L√ºtfen cihaz listesinden tekrar deneyin.', 'danger');
            }
        }
        
        async function showInstanceQR(instanceName) {
            const device = whatsappDevices.find(d => d.instanceName === instanceName);
            const deviceId = device ? device.id : null;
            
            showQRLoadingModal(instanceName);
            await fetchAndShowQR(instanceName, deviceId);
        }
        
        function showQRCodeModal(instanceName, base64QR, deviceId = null) {
            const modal = document.getElementById('qrCodeModal');
            if (!modal) return;
            
            const modalContent = modal.querySelector('.modal-content');
            const qrImage = document.getElementById('qrCodeImage');
            
            // Remove loading spinner if exists
            if (modalContent) {
                const loader = modalContent.querySelector('.qr-loading');
                if (loader) {
                    loader.remove();
                }
            }
            
            // Update title and show QR
            document.getElementById('qrCodeTitle').textContent = `üì± ${instanceName} - QR Kod`;
            
            if (qrImage) {
                qrImage.src = base64QR;
                qrImage.style.display = 'block';
            }
            
            // If modal not already open, open it
            if (!modal.classList.contains('active')) {
                openModal('qrCodeModal');
            }
            
            // Start polling for connection if deviceId is provided
            if (deviceId) {
                startConnectionPolling(instanceName, deviceId);
            }
        }
        
        // Poll Evolution API to check if instance is connected
        let pollingIntervals = {};
        
        async function checkConnectionStatus(instanceName, deviceId) {
            try {
                // Try multiple endpoints to check connection
                let isConnected = false;
                
                // Method 1: Check connection state
                try {
                    const stateResponse = await fetch(`${EVOLUTION_API_URL}/instance/connectionState/${instanceName}`, {
                        method: 'GET',
                        headers: { 'apikey': EVOLUTION_API_KEY }
                    });
                    const stateData = await stateResponse.json();
                    
                    if (stateData.state === 'open' || stateData.instance?.state === 'open') {
                        isConnected = true;
                    }
                } catch (e) {}
                
                // Method 2: Check fetch instances
                if (!isConnected) {
                    try {
                        const instancesResponse = await fetch(`${EVOLUTION_API_URL}/instance/fetchInstances`, {
                            method: 'GET',
                            headers: { 'apikey': EVOLUTION_API_KEY }
                        });
                        const instances = await instancesResponse.json();
                        
                        if (Array.isArray(instances)) {
                            const instance = instances.find(i => i.instanceName === instanceName);
                            if (instance && instance.state === 'open') {
                                isConnected = true;
                            }
                        }
                    } catch (e) {}
                }
                
                if (isConnected) {
                    // Update Firebase
                    await window.firebase.updateDoc(
                        window.firebase.doc(window.db, 'whatsappDevices', deviceId),
                        {
                            status: 'connected',
                            lastUpdated: new Date().toISOString()
                        }
                    );
                    
                    // Update local state
                    const deviceIndex = whatsappDevices.findIndex(d => d.id === deviceId);
                    if (deviceIndex !== -1) {
                        whatsappDevices[deviceIndex].status = 'connected';
                        whatsappDevices[deviceIndex].lastUpdated = new Date().toISOString();
                    }
                    
                    return true;
                }
                
                return false;
            } catch (error) {
                return false;
            }
        }
        
        async function startConnectionPolling(instanceName, deviceId) {
            // Clear existing polling for this instance
            if (pollingIntervals[instanceName]) {
                clearInterval(pollingIntervals[instanceName]);
            }
            
            let attempts = 0;
            const maxAttempts = 60; // Poll for 2 minutes (60 attempts * 2 seconds)
            
            pollingIntervals[instanceName] = setInterval(async () => {
                attempts++;
                
                const isConnected = await checkConnectionStatus(instanceName, deviceId);
                
                if (isConnected) {
                    // Connection successful!
                    clearInterval(pollingIntervals[instanceName]);
                    delete pollingIntervals[instanceName];
                    
                    // Close QR modal and show success
                    closeModal('qrCodeModal');
                    showAlert('‚úÖ WhatsApp baƒülantƒ±sƒ± ba≈üarƒ±lƒ±! Cihaz kullanƒ±ma hazƒ±r.', 'success');
                    
                    // Reload instances
                    loadWhatsAppInstances();
                    
                } else if (attempts >= maxAttempts) {
                    // Timeout
                    clearInterval(pollingIntervals[instanceName]);
                    delete pollingIntervals[instanceName];
                    showAlert('‚è±Ô∏è QR kod okutma zaman a≈üƒ±mƒ±na uƒüradƒ±. Manuel olarak kontrol edin.', 'warning');
                }
            }, 3000); // Check every 3 seconds
        }
        
        async function restartInstance(instanceName, deviceId) {
            showConfirmModal(`${instanceName} cihazƒ±nƒ± yeniden ba≈ülatmak istediƒüinizden emin misiniz?`, async () => {
                closeModal('confirmModal');
                try {
                    const response = await fetch(`${EVOLUTION_API_URL}/instance/restart/${instanceName}`, {
                        method: 'PUT',
                        headers: {
                            'apikey': EVOLUTION_API_KEY
                        }
                    });
                    
                    if (response.ok) {
                        // Update status to pending in Firebase
                        await window.firebase.updateDoc(
                            window.firebase.doc(window.db, 'whatsappDevices', deviceId),
                            {
                                status: 'pending',
                                lastUpdated: new Date().toISOString()
                            }
                        );
                        
                        // Update local state
                        const deviceIndex = whatsappDevices.findIndex(d => d.id === deviceId);
                        if (deviceIndex !== -1) {
                            whatsappDevices[deviceIndex].status = 'pending';
                            whatsappDevices[deviceIndex].lastUpdated = new Date().toISOString();
                        }
                        
                        showAlert('Cihaz yeniden ba≈ülatƒ±lƒ±yor...', 'success');
                        setTimeout(() => loadWhatsAppInstances(), 800);
                    } else {
                        showAlert('Cihaz yeniden ba≈ülatƒ±lamadƒ±.', 'danger');
                    }
                } catch (error) {
                    console.error('Restart instance error:', error);
                    showAlert('ƒ∞≈ülem sƒ±rasƒ±nda hata olu≈ütu.', 'danger');
                }
            });
        }
        
        async function deleteInstance(instanceName, deviceId) {
            showConfirmModal(`${instanceName} cihazƒ±nƒ± kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz?`, async () => {
                closeModal('confirmModal');
                try {
                    // Delete from Evolution API
                    const response = await fetch(`${EVOLUTION_API_URL}/instance/delete/${instanceName}`, {
                        method: 'DELETE',
                        headers: {
                            'apikey': EVOLUTION_API_KEY
                        }
                    });
                    
                    const data = await response.json();
                    
                    // Delete from Firebase regardless of API response
                    await window.firebase.deleteDoc(
                        window.firebase.doc(window.db, 'whatsappDevices', deviceId)
                    );
                    
                    // Remove from local state
                    const deviceIndex = whatsappDevices.findIndex(d => d.id === deviceId);
                    if (deviceIndex !== -1) {
                        whatsappDevices.splice(deviceIndex, 1);
                    }
                    
                    // Stop polling if any
                    if (pollingIntervals[instanceName]) {
                        clearInterval(pollingIntervals[instanceName]);
                        delete pollingIntervals[instanceName];
                    }
                    
                    showAlert('‚úÖ Cihaz ba≈üarƒ±yla silindi.', 'success');
                    loadWhatsAppInstances();
                } catch (error) {
                    console.error('Delete instance error:', error);
                    showAlert('ƒ∞≈ülem sƒ±rasƒ±nda hata olu≈ütu.', 'danger');
                }
            });
        }

        // --- HANDLER FUNCTIONS ---
        async function handleRegistration(e, initialStatus) {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            
            // Butonu devre dƒ±≈üƒ± bƒ±rak (√ßift tƒ±klama √∂nleme)
            if (submitBtn) {
                if (submitBtn.disabled) return; // Zaten i≈ülem yapƒ±lƒ±yorsa √ßƒ±k
                submitBtn.disabled = true;
                submitBtn.textContent = '‚è≥ Kaydediliyor...';
            }
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const memberType = data.memberType;
                let parentName = data.parentName;

                if (memberType === 'child' && !parentName) {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'üìù Kayƒ±t Olu≈ütur';
                    }
                    return showAlert('√áocuk kayƒ±tlarƒ± i√ßin Veli Adƒ± Soyadƒ± zorunludur.', 'warning');
                }
                if (memberType === 'adult') {
                    parentName = '';
                }

                // ‚úÖ √ñƒürenci listesini topla
                let students = [];
                if (memberType === 'child') {
                    // √áoklu √ßocuk desteƒüi
                    const studentFields = form.querySelectorAll('.student-field-group');
                    studentFields.forEach((field, index) => {
                        const studentName = formData.get(`studentName_${index}`);
                        const studentBirthDate = formData.get(`studentBirthDate_${index}`) || '';
                        if (studentName) {
                            students.push({ studentName, studentBirthDate, index });
                        }
                    });
                    
                    if (students.length === 0) {
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'üìù Kayƒ±t Olu≈ütur';
                        }
                        return showAlert('En az bir √∂ƒürenci eklemelisiniz.', 'warning');
                    }
                } else {
                    // Yeti≈ükin i√ßin tek √∂ƒürenci
                    students.push({
                        studentName: data.studentName,
                        studentBirthDate: data.studentBirthDate || ''
                    });
                }

                const subsequentInstallments = parseInt(data.installments);
                if (isNaN(subsequentInstallments)) throw new Error("Taksit sayƒ±sƒ± ge√ßersiz.");
                const totalInstallments = subsequentInstallments + 1;
                
                const firstAmount = parseFloat(unformatCurrency(data.firstInstallmentAmount) || '0');
                const subsequentAmount = parseFloat(unformatCurrency(data.subsequentInstallmentAmount) || '0');

                const paymentSchedule = generatePaymentSchedule(
                    new Date(data.firstPeriodStart), new Date(data.firstPeriodEnd), new Date(data.firstDueDate),
                    totalInstallments, firstAmount, subsequentAmount,
                    parseInt(data.dueDay), parseInt(data.firstLessonCount)
                );

                if (paymentSchedule.length === 0) {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'üìù Kayƒ±t Olu≈ütur';
                    }
                    return showAlert('√ñdeme planƒ± olu≈üturulamadƒ±. L√ºtfen tarihleri ve tutarlarƒ± kontrol edin.', 'warning');
                }

                const finalEndDate = paymentSchedule[paymentSchedule.length - 1].period.end;
                const isChild = memberType === 'child';

                // ‚úÖ Her √∂ƒürenci i√ßin kayƒ±t olu≈ütur
                let createdCount = 0;
                for (const student of students) {
                    // ‚úÖ √á√ñZ√úM: Her √∂ƒürenci i√ßin √∂deme planƒ±nƒ±n baƒüƒ±msƒ±z bir kopyasƒ±nƒ± olu≈ütur
                    const independentPaymentSchedule = JSON.parse(JSON.stringify(paymentSchedule));
                    
                    const preRegData = {
                        parentName,
                        parentName2: data.parentName2 || '',
                        phone2: data.phone2 || '',
                        studentName: student.studentName,
                        studentBirthDate: student.studentBirthDate,
                        phone: data.phone,
                        branch: data.branch,
                        periodStart: data.firstPeriodStart,
                        periodEnd: finalEndDate,
                        paymentSchedule: independentPaymentSchedule,
                        status: 'pending_contract',
                        createdAt: new Date().toISOString(),
                        notes: data.notes,
                        clubId: currentClubId
                    };

                    const preRegRef = await window.firebase.addDoc(window.firebase.collection(window.db, 'preRegistrations'), preRegData);
                    
                    const memberData = {
                        Ad_Soyad: isChild ? parentName : student.studentName,
                        Veli_2_Adi_Soyadi: data.parentName2 || '',
                        Telefon_2: data.phone2 || '',
                        Resit_Olmayan_Adi_Soyadi: isChild ? student.studentName : '',
                        Telefon: data.phone,
                        Brans: data.branch,
                        studentBirthDate: student.studentBirthDate,
                        status: initialStatus,
                        registrationDate: new Date().toISOString(),
                        preRegistrationId: preRegRef.id,
                        clubId: currentClubId
                    };
                    
                    let memberIdToAssign = null;
                    const existingMember = members.find(m => m.Telefon === data.phone && (m.Resit_Olmayan_Adi_Soyadi || m.Ad_Soyad) === student.studentName);

                    if(!existingMember) {
                        const memberRef = await window.firebase.addDoc(window.firebase.collection(window.db, 'members'), memberData);
                        memberIdToAssign = memberRef.id;
                    } else {
                        memberIdToAssign = existingMember.id;
                        const { preRegistrationId, ...memberDataWithoutPreRegId } = memberData;
                        await window.firebase.updateDoc(window.firebase.doc(window.db, 'members', existingMember.id), memberDataWithoutPreRegId);
                    }

                    if(data.groupId && memberIdToAssign) {
                         await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', data.groupId), {
                             members: window.firebase.arrayUnion(memberIdToAssign)
                        });
                    }
                    
                    createdCount++;
                }
                
                showAlert(`‚úÖ ${createdCount} √∂ƒürenci i√ßin kayƒ±t ba≈üarƒ±lƒ±! "Bekleyen Kayƒ±tlar" listesine eklendi.`, 'success');
                form.reset();
                toggleParentStudentFields(form);
                previewPaymentPlan(form);
                await loadData();
            } catch (error) { 
                console.error(error); 
                showAlert(`Kayƒ±t olu≈üturulurken hata olu≈ütu: ${error.message}`, 'danger'); 
            } finally {
                // Butonu tekrar aktif et
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üìù Kayƒ±t Olu≈ütur';
                }
            }
        }

        function recalculateSubsequentPayments(schedule, startIndex) {
            for (let i = startIndex + 1; i < schedule.length; i++) {
                const prevPayment = schedule[i - 1];
                const currentPayment = schedule[i];

                let newStartDate = new Date(prevPayment.period.end);
                newStartDate.setDate(newStartDate.getDate() + 1);
                currentPayment.period.start = newStartDate.toISOString().split('T')[0];

                let newEndDate = new Date(newStartDate);
                newEndDate.setDate(newEndDate.getDate() + 27); 
                currentPayment.period.end = newEndDate.toISOString().split('T')[0];
                
                let newDueDate = new Date(prevPayment.dueDate + 'T12:00:00');
                newDueDate.setMonth(newDueDate.getMonth() + 1);
                currentPayment.dueDate = newDueDate.toISOString().split('T')[0];
            }
            return schedule;
        }

        async function handlePayment(e) {
            e.preventDefault();
            const form = e.target;
            const preRegId = form.paymentPreRegId.value;
            const paymentNumber = parseInt(form.paymentNumber.value);
            const isNewPayment = form.dataset.mode === 'new';
            
            try {
                const preReg = preRegistrations.find(p => p.id === preRegId);
                if (!preReg || !preReg.paymentSchedule) throw new Error("√ñdeme planƒ± bulunamadƒ±.");
                
                let updatedSchedule = [...preReg.paymentSchedule];
                let totalPaymentsToAdd = 1; // ‚úÖ Declare outside if block to avoid scope issue

                if (isNewPayment) {
                    // ‚úÖ Ka√ß ay daha aidat eklenecek?
                    const additionalMonths = parseInt(form.additionalMonths.value) || 0;
                    totalPaymentsToAdd = additionalMonths + 1; // Bu ay + ek aylar
                    
                    const baseAmount = parseFloat(unformatCurrency(form.paymentAmount.value) || '0');
                    const basePeriodStart = new Date(form.periodStart.value);
                    const basePeriodEnd = new Date(form.periodEnd.value);
                    const baseDueDate = new Date(form.paymentDueDate.value);
                    const baseLessonCount = parseInt(form.lessonCount.value) || 8;
                    
                    // ‚úÖ Birden fazla aidat olu≈ütur
                    for (let i = 0; i < totalPaymentsToAdd; i++) {
                        let periodStart, periodEnd, dueDate;
                        
                        if (i === 0) {
                            // ƒ∞lk aidat - formdan gelen deƒüerler
                            periodStart = new Date(basePeriodStart);
                            periodEnd = new Date(basePeriodEnd);
                            dueDate = new Date(baseDueDate);
                        } else {
                            // Sonraki aidatlar - otomatik hesaplama
                            const prevPayment = updatedSchedule[updatedSchedule.length - 1];
                            periodStart = new Date(prevPayment.period.end);
                            periodStart.setDate(periodStart.getDate() + 1);
                            
                            periodEnd = new Date(periodStart);
                            periodEnd.setDate(periodEnd.getDate() + 27); // ~4 hafta
                            
                            dueDate = new Date(baseDueDate);
                            dueDate.setMonth(dueDate.getMonth() + i);
                        }
                        
                        const newPayment = {
                            paymentNumber: updatedSchedule.length + 1,
                            amount: baseAmount,
                            dueDate: dueDate.toISOString().split('T')[0],
                            status: form.paymentStatus.value,
                            note: i === 0 ? form.paymentNote.value : `Otomatik olu≈üturuldu (${i + 1}/${totalPaymentsToAdd})`,
                            method: form.paymentMethod.value,
                            paymentDate: form.paymentDate.value || null,
                            period: {
                                start: periodStart.toISOString().split('T')[0],
                                end: periodEnd.toISOString().split('T')[0],
                                lessonCount: baseLessonCount
                            }
                        };
                        updatedSchedule.push(newPayment);
                    }
                    
                    updatedSchedule.sort((a,b) => new Date(a.period.start) - new Date(b.period.start));
                    
                    // √ñdeme numaralarƒ±nƒ± yeniden d√ºzenle
                    updatedSchedule.forEach((p, idx) => {
                        p.paymentNumber = idx + 1;
                    });
                } else {
                    const paymentIndex = updatedSchedule.findIndex(p => p.paymentNumber === paymentNumber);
                    if (paymentIndex === -1) throw new Error("D√ºzenlenecek √∂deme bulunamadƒ±.");

                    const originalPayment = updatedSchedule[paymentIndex];
                    const updatedPaymentData = { ...originalPayment };
                    updatedPaymentData.amount = parseFloat(unformatCurrency(form.paymentAmount.value) || '0');
                    updatedPaymentData.dueDate = form.paymentDueDate.value;
                    updatedPaymentData.status = form.paymentStatus.value;
                    updatedPaymentData.note = form.paymentNote.value;
                    if (form.paymentDate.value) updatedPaymentData.paymentDate = form.paymentDate.value;
                    if (form.paymentMethod.value) updatedPaymentData.method = form.paymentMethod.value;
                     // Update period info only if the fields exist in the form
                    if(form.periodStart && form.periodEnd && form.lessonCount){
                        updatedPaymentData.period = {
                            start: form.periodStart.value,
                            end: form.periodEnd.value,
                            lessonCount: parseInt(form.lessonCount.value) || 0
                        };
                    }


                    updatedSchedule[paymentIndex] = updatedPaymentData;

                    // Recalculate subsequent payments
                    updatedSchedule = recalculateSubsequentPayments(updatedSchedule, paymentIndex);
                }

                // Renumber payments to ensure they are sequential
                updatedSchedule.forEach((p, index) => {
                    p.paymentNumber = index + 1;
                });

                await window.firebase.updateDoc(window.firebase.doc(window.db, 'preRegistrations', preRegId), { paymentSchedule: updatedSchedule });
                
                closeModal('paymentModal');
                
                // ‚úÖ Ka√ß tane √∂deme eklendiƒüini g√∂ster
                const successMessage = isNewPayment 
                    ? (totalPaymentsToAdd > 1 ? `${totalPaymentsToAdd} aidat ba≈üarƒ±yla eklendi` : '√ñdeme ba≈üarƒ±yla eklendi')
                    : '√ñdeme ba≈üarƒ±yla g√ºncellendi';
                showAlert(successMessage, 'success');
                
                await loadData();
                viewPaymentPlan(preRegId); 

            } catch (error) { 
                console.error("Payment update error:", error);
                showAlert(`√ñdeme ${isNewPayment ? 'eklenirken' : 'g√ºncellenirken'} hata olu≈ütu: ${error.message}`, 'danger'); 
            }
        }


        async function handleNewSchedule(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const selectedDays = formData.getAll('days');

            if (selectedDays.length === 0) {
                return showAlert('L√ºtfen en az bir ders g√ºn√º se√ßin.', 'warning');
            }

            const group = groups.find(g => g.id === data.groupId);
            if (!group) return showAlert('Ge√ßersiz grup.', 'danger');
            
            try {
                const schedulePromises = selectedDays.map(day => {
                    const scheduleData = {
                        groupId: data.groupId, 
                        day: day, 
                        startTime: data.startTime, 
                        endTime: data.endTime,
                        branch: group.branch,
                        court: data.court || null, // ‚úÖ Saha bilgisi
                        clubId: currentClubId
                    };
                    return window.firebase.addDoc(window.firebase.collection(window.db, 'schedules'), scheduleData);
                });

                await Promise.all(schedulePromises);
                showAlert(`${selectedDays.length} ders ba≈üarƒ±yla olu≈üturuldu`, 'success');
                closeModal('scheduleModal');
                await loadData();
            } catch (error) { 
                console.error('Error creating schedules:', error);
                showAlert('Dersler olu≈üturulurken hata olu≈ütu', 'danger'); 
            }
        }

        async function handleGroup(e) {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());
            const groupId = data.groupId;
            delete data.groupId;

            try {
                if(groupId){
                     await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', groupId), data);
                     showAlert('Grup ba≈üarƒ±yla g√ºncellendi', 'success');
                } else {
                    await window.firebase.addDoc(window.firebase.collection(window.db, 'groups'), { 
                        ...data, 
                        members: [], 
                        createdAt: new Date().toISOString(),
                        clubId: currentClubId // ‚úÖ Kul√ºp ID'si eklendi
                    });
                    showAlert('Grup ba≈üarƒ±yla olu≈üturuldu', 'success');
                }
                closeModal('groupModal');
                form.reset();
                await loadData();
            } catch (error) { showAlert('Grup kaydedilirken hata olu≈ütu', 'danger'); }
        }

        async function handleMemberUpdate(e) {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());
            const memberId = data.memberId;
            delete data.memberId;

            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'members', memberId), data);
                showAlert('√úye bilgileri g√ºncellendi.', 'success');
                closeModal('memberEditModal');
                await loadData();
            } catch (error) {
                 showAlert('√úye bilgileri g√ºncellenirken hata olu≈ütu.', 'danger');
            }
        }

        async function handlePreRegUpdate(e) {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());
            const preRegId = data.preRegId;
            const newGroupId = data.groupId;
            delete data.preRegId;
            delete data.groupId;
            delete data.groupSearch; // remove search text from data
            
            console.log('PreReg Update - Form Data:', { preRegId, newGroupId, data });
            
            const member = members.find(m => m.preRegistrationId === preRegId);
            console.log('PreReg Update - Found member:', member);
            
            // If it's an adult registration, ensure parentName is cleared
            if(member && !member.Resit_Olmayan_Adi_Soyadi) {
                 data.parentName = '';
            }

            try {
                // Update pre-registration text fields
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'preRegistrations', preRegId), data);

                // Handle group change - only if member exists and newGroupId is provided
                if (member && newGroupId && newGroupId.trim() !== '') {
                    console.log('PreReg Update - Adding member to group:', { memberId: member.id, groupId: newGroupId });
                    
                    // Find current groups this member is in
                    const currentGroups = groups.filter(g => g.members && g.members.includes(member.id));
                    console.log('PreReg Update - Current groups:', currentGroups.map(g => g.id));
                    
                    // Remove from old groups (except the new one)
                    for (const oldGroup of currentGroups) {
                        if (oldGroup.id !== newGroupId) {
                            console.log('PreReg Update - Removing from old group:', oldGroup.id);
                            await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', oldGroup.id), {
                                members: window.firebase.arrayRemove(member.id)
                            });
                        }
                    }
                    
                    // Add to new group
                    await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', newGroupId), {
                        members: window.firebase.arrayUnion(member.id)
                    });
                    console.log('PreReg Update - Successfully added to group');
                } else {
                    console.log('PreReg Update - Skipping group update:', { 
                        hasMember: !!member, 
                        hasGroupId: !!newGroupId,
                        groupIdValue: newGroupId 
                    });
                }

                showAlert('√ñn kayƒ±t bilgileri g√ºncellendi.', 'success');
                closeModal('preRegEditModal');
                await loadData();
            } catch (error) {
                console.error("Pre-registration update error:", error);
                showAlert('√ñn kayƒ±t g√ºncellenirken bir hata olu≈ütu.', 'danger');
            }
        }
        
        async function handleAttendanceSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const groupId = formData.get('groupId');
            const presentMemberIds = formData.getAll('presentMembers');
            const attendanceDate = formData.get('attendanceDate'); // NEW: Get date from form
            if (!attendanceDate) {
                return showAlert('L√ºtfen yoklama tarihini se√ßin.', 'warning');
            }
            
            const group = groups.find(g => g.id === groupId);
            if(!group) return showAlert('Grup bulunamadƒ±', 'danger');

            const groupMembers = members.filter(m => (group.members || []).includes(m.id) && m.status === 'active');
            const attendancePromises = [];

            for (const member of groupMembers) {
                const isPresent = presentMemberIds.includes(member.id);
                const status = isPresent ? 'present' : 'absent';
                const reason = formData.get(`reason_${member.id}`) || '';

                const record = {
                    memberId: member.id,
                    groupId: groupId,
                    date: attendanceDate,
                    status: status,
                    reason: reason,
                    recordedBy: currentUser.fullName || currentUser.username,
                    clubId: currentClubId // ‚úÖ Kul√ºp ID'si eklendi
                };

                // Check for existing record for this member, group, and day
                const q = query(collection(db, 'attendance'), 
                    where('memberId', '==', member.id), 
                    where('groupId', '==', groupId), 
                    where('date', '==', attendanceDate)
                );
                
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    attendancePromises.push(addDoc(collection(db, 'attendance'), record));
                } else {
                    const docId = querySnapshot.docs[0].id;
                    attendancePromises.push(updateDoc(doc(db, 'attendance', docId), record));
                }
            }

            try {
                await Promise.all(attendancePromises);
                
                // Devamsƒ±zlƒ±k mesajlarƒ± g√∂nder (sebep belirtilmemi≈ü olanlar i√ßin)
                const absenceMessagesToSend = [];
                for (const member of groupMembers) {
                    const isPresent = presentMemberIds.includes(member.id);
                    const reason = formData.get(`reason_${member.id}`) || '';
                    
                    // Eƒüer devamsƒ±z ve sebep bo≈üsa mesaj g√∂nder
                    if (!isPresent && !reason) {
                        absenceMessagesToSend.push({
                            member: member,
                            date: attendanceDate,
                            groupName: group.groupName
                        });
                    }
                }
                
                // Mesajlarƒ± arka planda g√∂nder (await etmeden)
                if (absenceMessagesToSend.length > 0) {
                    console.log(`üìß ${absenceMessagesToSend.length} devamsƒ±zlƒ±k mesajƒ± g√∂nderiliyor...`);
                    sendAbsenceNotifications(absenceMessagesToSend).catch(err => {
                        console.error('Devamsƒ±zlƒ±k mesajlarƒ± g√∂nderilirken hata:', err);
                    });
                }
                
                showAlert(`${group.groupName} i√ßin yoklama kaydedildi.${absenceMessagesToSend.length > 0 ? ` (${absenceMessagesToSend.length} devamsƒ±zlƒ±k mesajƒ± g√∂nderiliyor)` : ''}`, 'success');
                closeModal('attendanceModal');
                await loadData();
            } catch(error) {
                console.error("Attendance save error:", error);
                showAlert('Yoklama kaydedilirken bir hata olu≈ütu.', 'danger');
            }
        }
        
        async function handleSettingsUpdate(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const off_days = formData.getAll('holidays');
            const newClubName = formData.get('clubName');
            
            // Bulutfon ayarlarƒ±
            const bulutfonEnabled = document.getElementById('bulutfonEnabled')?.checked || false;
            const bulutfonApiKey = document.getElementById('bulutfonApiKey')?.value || '';

            // ‚úÖ Webhook ayarlarƒ±
            const webhookEnabled = document.getElementById('webhookEnabled')?.checked || false;
            const webhookUrl = document.getElementById('webhookUrl')?.value || '';

            try {
                await window.firebase.setDoc(window.firebase.doc(window.db, 'settings', `holidays_${currentClubId}`), { off_days });
                
                // ‚úÖ Ayarlarƒ± club settings'e kaydet
                const updatedSettings = {
                    clubName: newClubName || clubSettings.clubName,
                    bulutfonEnabled: bulutfonEnabled,
                    bulutfonApiKey: bulutfonApiKey,
                    updatedAt: new Date().toISOString()
                };
                
                await window.firebase.setDoc(
                    window.firebase.doc(window.db, 'settings', `club_${currentClubId}`), 
                    updatedSettings,
                    { merge: true }
                );
                
                // ‚úÖ Webhook ayarlarƒ±nƒ± kaydet
                const webhookData = {
                    active: webhookEnabled,
                    url: webhookUrl,
                    eventType: 'contract_signed',
                    clubId: currentClubId,
                    updatedAt: new Date().toISOString()
                };
                
                await window.firebase.setDoc(
                    window.firebase.doc(window.db, 'webhooks', `contract_${currentClubId}`),
                    webhookData,
                    { merge: true }
                );
                
                // Local state g√ºncelle
                clubSettings = { ...clubSettings, ...updatedSettings };
                
                showAlert('‚úÖ Ayarlar ba≈üarƒ±yla g√ºncellendi.', 'success');
                await loadData();
            } catch (error) {
                console.error("Error updating settings:", error);
                showAlert('Ayarlar g√ºncellenirken bir hata olu≈ütu.', 'danger');
            }
        }
        
        // ‚úÖ WhatsApp Mesaj G√∂nderim Ayarlarƒ±nƒ± Kaydet
        window.saveWhatsAppSettings = async function() {
            try {
                // √áalƒ±≈üma saatleri ayarlarƒ±
                const workingHoursEnabled = document.getElementById('workingHoursEnabled').checked;
                const workingDays = [];
                for (let i = 0; i <= 6; i++) {
                    const checkbox = document.getElementById(`workDay-${i}`);
                    if (checkbox && checkbox.checked) {
                        workingDays.push(i);
                    }
                }
                
                const settings = {
                    minWaitTime: parseInt(document.getElementById('minWaitTime').value) || 20,
                    maxWaitTime: parseInt(document.getElementById('maxWaitTime').value) || 50,
                    longWaitTrigger: parseInt(document.getElementById('longWaitTrigger').value) || 100,
                    minLongWait: parseInt(document.getElementById('minLongWait').value) || 400,
                    maxLongWait: parseInt(document.getElementById('maxLongWait').value) || 800,
                    workingHoursEnabled: workingHoursEnabled,
                    workingHoursStart: document.getElementById('workingHoursStart').value || '09:00',
                    workingHoursEnd: document.getElementById('workingHoursEnd').value || '18:00',
                    workingDays: workingDays
                };
                
                await window.firebase.setDoc(
                    window.firebase.doc(window.db, 'settings', `club_${currentClubId}`), 
                    settings,
                    { merge: true }
                );
                
                // Local state g√ºncelle
                clubSettings = { ...clubSettings, ...settings };
                
                // ‚úÖ Toplu mesaj √∂zetini g√ºncelle
                updateBulkMessageSettings();
                
                showAlert('‚úÖ WhatsApp ayarlarƒ± ba≈üarƒ±yla g√ºncellendi.', 'success');
            } catch (error) {
                console.error("Error updating WhatsApp settings:", error);
                showAlert('Ayarlar g√ºncellenirken bir hata olu≈ütu.', 'danger');
            }
        };
        
        // √áalƒ±≈üma saatleri toggle
        window.toggleWorkingHoursFields = function() {
            const enabled = document.getElementById('workingHoursEnabled').checked;
            document.getElementById('workingHoursFields').style.display = enabled ? 'block' : 'none';
        };
        
        // Bulutfon toggle
        window.toggleBulutfonFields = function() {
            const enabled = document.getElementById('bulutfonEnabled').checked;
            const settingsDiv = document.getElementById('bulutfon-api-settings');
            if (settingsDiv) {
                settingsDiv.style.display = enabled ? 'block' : 'none';
            }
        };
        
        // Bulutfon ayarlarƒ±nƒ± kaydet
        window.saveBulutfonSettings = async function() {
            try {
                const enabled = document.getElementById('bulutfonEnabled').checked;
                const apiKey = document.getElementById('bulutfonApiKey').value;
                
                if (enabled && !apiKey) {
                    showAlert('‚ö†Ô∏è L√ºtfen Bulutfon API Key\'ini girin.', 'warning');
                    return;
                }
                
                const settings = {
                    bulutfonEnabled: enabled,
                    bulutfonApiKey: apiKey
                };
                
                await window.firebase.setDoc(
                    window.firebase.doc(window.db, 'settings', `club_${currentClubId}`), 
                    settings,
                    { merge: true }
                );
                
                clubSettings = { ...clubSettings, ...settings };
                
                showAlert('‚úÖ Bulutfon ayarlarƒ± ba≈üarƒ±yla kaydedildi.', 'success');
            } catch (error) {
                console.error("Error saving Bulutfon settings:", error);
                showAlert('Bulutfon ayarlarƒ± kaydedilirken bir hata olu≈ütu.', 'danger');
            }
        };
        
        // Bulutfon API baƒülantƒ±sƒ±nƒ± test et
        window.testBulutfonConnection = async function() {
            const apiKey = document.getElementById('bulutfonApiKey').value;
            const resultDiv = document.getElementById('bulutfonTestResult');
            
            if (!apiKey) {
                showAlert('‚ö†Ô∏è L√ºtfen √∂nce API Key\'i girin.', 'warning');
                return;
            }
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><span>API baƒülantƒ±sƒ± test ediliyor...</span></div>';
            
            try {
                console.log('üîç Bulutfon API testi ba≈ülatƒ±lƒ±yor...');
                
                // Firebase Functions proxy √ºzerinden √ßaƒüƒ±r (CORS sorunu √ß√∂z√ºm√º)
                // API key query parameter olarak g√∂nderiliyor
                const response = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${apiKey}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üì° API Response Status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    
                    let errorDetail = '';
                    if (response.status === 401 || response.status === 403) {
                        errorDetail = 'API Key ge√ßersiz veya yetkilendirme hatasƒ±.';
                    } else if (response.status === 500) {
                        errorDetail = 'Bulutfon sunucu hatasƒ±. Hesabƒ±nƒ±zda CDR (Arama Kayƒ±tlarƒ±) yetkisi olmayabilir.';
                    } else {
                        errorDetail = response.statusText;
                    }
                    
                    throw new Error(`API Hatasƒ± ${response.status}: ${errorDetail}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ API Response Data:', data);
                console.log('üìä Data Keys:', Object.keys(data));
                console.log('üì¶ Full Response:', JSON.stringify(data, null, 2));
                
                // Bulutfon v2 API'den gelen data yapƒ±sƒ±nƒ± kontrol et
                const records = Array.isArray(data) ? data : (data.cdrs || data.data || []);
                const recordCount = records.length;
                
                resultDiv.innerHTML = `
                    <div style="padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px;">
                        <div style="color: #155724; font-weight: 600; margin-bottom: 8px;">
                            ‚úÖ Baƒülantƒ± ba≈üarƒ±lƒ±!
                        </div>
                        <div style="color: #155724; font-size: 13px;">
                            üìä Bulutfon API'den ${recordCount} adet g√∂r√º≈üme kaydƒ± alƒ±ndƒ±.<br>
                            üîó API Key ge√ßerli ve √ßalƒ±≈üƒ±yor.
                        </div>
                        ${recordCount > 0 ? `
                            <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 6px; font-size: 12px;">
                                <strong>Son g√∂r√º≈üme:</strong><br>
                                üìû ${records[0].caller || records[0].src || 'N/A'} ‚Üí ${records[0].callee || records[0].dst || 'N/A'}<br>
                                üìÖ ${new Date(records[0].call_Time || records[0].call_date).toLocaleString('tr-TR')}<br>
                                ‚è±Ô∏è ${records[0].duration ? records[0].duration + ' sn' : (records[0].billsec ? Math.floor(records[0].billsec / 60) + ':' + (records[0].billsec % 60).toString().padStart(2, '0') : '0:00')}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                showAlert('‚úÖ Bulutfon API baƒülantƒ±sƒ± ba≈üarƒ±lƒ±!', 'success');
            } catch (error) {
                console.error('‚ùå Bulutfon API test hatasƒ±:', error);
                
                resultDiv.innerHTML = `
                    <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px;">
                        <div style="color: #721c24; font-weight: 600; margin-bottom: 8px;">
                            ‚ùå Baƒülantƒ± ba≈üarƒ±sƒ±z!
                        </div>
                        <div style="color: #721c24; font-size: 13px;">
                            <strong>Hata:</strong> ${error.message}<br><br>
                            <strong>Kontrol listesi:</strong><br>
                            ‚Ä¢ Bulutfon panelinden aldƒ±ƒüƒ±nƒ±z API Key'i doƒüru girdikten emin olun<br>
                            ‚Ä¢ API Key'in aktif olduƒüundan emin olun<br>
                            ‚Ä¢ Bulutfon hesabƒ±nƒ±zda <strong>CDR (Call Detail Records)</strong> yetkisinin olduƒüunu kontrol edin<br>
                            ‚Ä¢ ƒ∞nternet baƒülantƒ±nƒ±zƒ± kontrol edin<br>
                            ‚Ä¢ Sorun devam ederse Bulutfon destek ekibiyle ileti≈üime ge√ßin
                        </div>
                    </div>
                `;
                
                showAlert('‚ùå Bulutfon API baƒülantƒ±sƒ± ba≈üarƒ±sƒ±z: ' + error.message, 'danger');
            }
        };
        
        // ============================================
        // ‚úÖ √áALI≈ûMA SAATLERƒ∞ VE MESAJ KUYRUƒûU
        // ============================================
        
        // √áalƒ±≈üma saatleri i√ßinde mi kontrol et
        function isWithinWorkingHours() {
            if (!clubSettings || !clubSettings.workingHoursEnabled) {
                return true; // √áalƒ±≈üma saatleri devre dƒ±≈üƒ±ysa her zaman true
            }
            
            const now = new Date();
            const currentDay = now.getDay(); // 0 = Pazar, 1 = Pazartesi, ...
            const currentTime = now.getHours() * 60 + now.getMinutes(); // Dakika cinsinden
            
            // √áalƒ±≈üma g√ºn√º m√º?
            if (!clubSettings.workingDays || !clubSettings.workingDays.includes(currentDay)) {
                return false;
            }
            
            // √áalƒ±≈üma saati i√ßinde mi?
            const [startHour, startMin] = (clubSettings.workingHoursStart || '09:00').split(':').map(Number);
            const [endHour, endMin] = (clubSettings.workingHoursEnd || '18:00').split(':').map(Number);
            const startTime = startHour * 60 + startMin;
            const endTime = endHour * 60 + endMin;
            
            return currentTime >= startTime && currentTime < endTime;
        }
        
        // Mesajƒ± kuyruƒüa ekle
        async function addMessageToQueue(phone, message, deviceId) {
            try {
                const queueItem = {
                    phone: phone,
                    message: message,
                    deviceId: deviceId,
                    clubId: currentClubId,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    scheduledFor: getNextWorkingHour()
                };
                
                const docRef = await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'messageQueue'),
                    queueItem
                );
                
                console.log('‚úÖ Mesaj kuyruƒüa eklendi:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('‚ùå Mesaj kuyruƒüa eklenirken hata:', error);
                throw error;
            }
        }
        
        // Bir sonraki √ßalƒ±≈üma saatini bul
        function getNextWorkingHour() {
            if (!clubSettings || !clubSettings.workingHoursEnabled) {
                return new Date().toISOString();
            }
            
            const now = new Date();
            let checkDate = new Date(now);
            
            // Maksimum 7 g√ºn ileri kontrol et
            for (let i = 0; i < 7; i++) {
                const dayOfWeek = checkDate.getDay();
                
                if (clubSettings.workingDays && clubSettings.workingDays.includes(dayOfWeek)) {
                    const [startHour, startMin] = (clubSettings.workingHoursStart || '09:00').split(':').map(Number);
                    checkDate.setHours(startHour, startMin, 0, 0);
                    
                    // Eƒüer bu saat gelecekteyse, bu saati d√∂nd√ºr
                    if (checkDate > now) {
                        return checkDate.toISOString();
                    }
                }
                
                // Bir sonraki g√ºne ge√ß
                checkDate.setDate(checkDate.getDate() + 1);
                checkDate.setHours(0, 0, 0, 0);
            }
            
            return new Date().toISOString();
        }
        
        // Mesaj kuyruƒüunu g√∂ster
        async function renderMessageQueue() {
            try {
                const container = document.getElementById('messageQueueList');
                if (!container) return;
                
                // Firestore query olu≈ütur - Basitle≈ütirilmi≈ü versiyon (index gerektirmez)
                const messagesRef = window.firebase.collection(window.db, 'messageQueue');
                const q = window.firebase.query(
                    messagesRef,
                    window.firebase.where('clubId', '==', currentClubId),
                    window.firebase.where('status', '==', 'pending')
                );
                
                const snapshot = await window.firebase.getDocs(q);
                
                if (snapshot.empty) {
                    container.innerHTML = '<p class="empty-state">Kuyrukta bekleyen mesaj yok.</p>';
                    return;
                }
                
                // Client-side sƒ±ralama yapƒ±yoruz (index gerektirmez)
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                
                // scheduledFor'a g√∂re sƒ±rala
                messages.sort((a, b) => {
                    const dateA = new Date(a.scheduledFor || 0);
                    const dateB = new Date(b.scheduledFor || 0);
                    return dateA - dateB;
                });
                
                // ƒ∞lk 20'yi al
                const maxRecords = 20;
                const displayMessages = messages.slice(0, maxRecords);
                
                let html = '<div style="display: grid; gap: 10px;">';
                displayMessages.forEach(message => {
                    const data = message;
                    const scheduledDate = new Date(data.scheduledFor);
                    const dateStr = scheduledDate.toLocaleString('tr-TR');
                    
                    html += `
                        <div style="padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 4px;">üìû ${data.phone}</div>
                                    <div style="font-size: 12px; color: #666; margin-bottom: 8px;">${data.message.substring(0, 100)}...</div>
                                    <div style="font-size: 11px; color: #888;">üïê G√∂nderilecek: ${dateStr}</div>
                                </div>
                                <button onclick="removeFromQueue('${message.id}')" class="btn btn-sm btn-danger" style="margin-left: 10px;">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Mesaj kuyruƒüu y√ºklenirken hata:', error);
            }
        }
        
        // Kuyruktan mesaj sil
        window.removeFromQueue = async function(queueId) {
            if (!confirm('Bu mesajƒ± kuyruktan √ßƒ±karmak istediƒüinize emin misiniz?')) return;
            
            try {
                // Mesajƒ± sil
                await window.firebase.deleteDoc(
                    window.firebase.doc(window.db, 'messageQueue', queueId)
                );
                
                // Listeyi yenile (await ile bekle)
                await renderMessageQueue();
                
                // Ba≈üarƒ± mesajƒ±
                showAlert('‚úÖ Mesaj kuyruktan √ßƒ±karƒ±ldƒ±.', 'success');
            } catch (error) {
                console.error('‚ùå Mesaj silinirken hata:', error);
                showAlert('‚ùå Mesaj silinirken bir hata olu≈ütu: ' + error.message, 'danger');
            }
        };
        
        // Mesaj kuyruk i≈üleyicisi (her 1 dakikada √ßalƒ±≈üƒ±r)
        async function processMessageQueue() {
            try {
                // ‚úÖ √áalƒ±≈üma saati kontrol√º kaldƒ±rƒ±ldƒ± - scheduledFor zamanƒ± zaten √ßalƒ±≈üma saatleri i√ßinde ayarlanmƒ±≈ü olmalƒ±
                // B√∂ylece mesajlar zamanƒ± geldiƒüinde g√∂nderilir
                
                const messagesRef = window.firebase.collection(window.db, 'messageQueue');
                // ‚úÖ Index hatasƒ± i√ßin sadele≈ütirilmi≈ü query - orderBy kaldƒ±rƒ±ldƒ±
                const q = window.firebase.query(
                    messagesRef,
                    window.firebase.where('clubId', '==', currentClubId),
                    window.firebase.where('status', '==', 'pending')
                );
                
                const snapshot = await window.firebase.getDocs(q);
                
                if (snapshot.empty) return;
                
                // Sadece zamanƒ± gelmi≈ü mesajlarƒ± i≈üle ve tarihe g√∂re sƒ±rala (client-side)
                const now = new Date().toISOString();
                const pendingMessages = snapshot.docs
                    .filter(doc => {
                        const data = doc.data();
                        return data.scheduledFor <= now;
                    })
                    .sort((a, b) => {
                        const timeA = a.data().scheduledFor;
                        const timeB = b.data().scheduledFor;
                        return timeA.localeCompare(timeB);
                    });
                
                if (pendingMessages.length === 0) return;
                
                // ƒ∞lk 5 mesajƒ± i≈üle
                let processedCount = 0;
                const maxToProcess = 5;
                
                for (const doc of pendingMessages) {
                    if (processedCount >= maxToProcess) break;
                    processedCount++;
                    
                    const data = doc.data();
                    
                    try {
                        // Mesajƒ± g√∂nder
                        await sendWhatsAppMessageDirect(data.phone, data.message, data.deviceId);
                        
                        // Durumu g√ºncelle
                        await window.firebase.updateDoc(
                            window.firebase.doc(window.db, 'messageQueue', doc.id),
                            {
                                status: 'sent',
                                sentAt: new Date().toISOString()
                            }
                        );
                        
                        console.log('‚úÖ Kuyruktaki mesaj g√∂nderildi:', data.phone);
                    } catch (error) {
                        console.error('‚ùå Kuyruk mesajƒ± g√∂nderilirken hata:', error);
                        
                        // Hata durumunu kaydet
                        await window.firebase.updateDoc(
                            window.firebase.doc(window.db, 'messageQueue', doc.id),
                            {
                                status: 'failed',
                                error: error.message,
                                failedAt: new Date().toISOString()
                            }
                        );
                    }
                }
                
                // Kuyruƒüu yeniden render et
                renderMessageQueue();
            } catch (error) {
                console.error('Mesaj kuyruƒüu i≈ülenirken hata:', error);
            }
        }
        
        // ============================================
        // ‚úÖ BULUTFON API ENTEGRASYONU
        // ============================================
        
        // Bulutfon API ile g√∂r√º≈üme kayƒ±tlarƒ±nƒ± √ßek
        async function fetchBulutfonCallRecords(phoneNumber) {
            if (!clubSettings || !clubSettings.bulutfonEnabled || !clubSettings.bulutfonApiKey) {
                console.log('‚ö†Ô∏è Bulutfon entegrasyonu aktif deƒüil veya API key eksik');
                return [];
            }
            
            try {
                // Telefon numarasƒ±nƒ± temizle ve farklƒ± formatlarƒ± hazƒ±rla
                let cleanPhone = phoneNumber.replace(/[^\d]/g, '');
                
                // 0 ile ba≈ülƒ±yorsa 90 yap
                if (cleanPhone.startsWith('0')) {
                    cleanPhone = '90' + cleanPhone.substring(1);
                } else if (!cleanPhone.startsWith('90') && cleanPhone.length === 10) {
                    cleanPhone = '90' + cleanPhone;
                }
                
                console.log('üìû Bulutfon API √ßaƒürƒ±sƒ± yapƒ±lƒ±yor...', cleanPhone);
                
                // Firebase Functions proxy √ºzerinden CDR listesini √ßek (CORS sorunu √ß√∂z√ºm√º)
                // API key query parameter olarak g√∂nderiliyor
                const response = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${clubSettings.bulutfonApiKey}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Bulutfon API hatasƒ±:', response.status, response.statusText, errorText);
                    
                    let errorMsg = 'Bulutfon API baƒülantƒ± hatasƒ±: ';
                    if (response.status === 401 || response.status === 403) {
                        errorMsg += 'API key ge√ßersiz veya yetkilendirme hatasƒ±. L√ºtfen API key\'inizi kontrol edin.';
                    } else if (response.status === 500) {
                        errorMsg += 'Bulutfon sunucu hatasƒ±. Bulutfon panelinde CDR (Arama Kayƒ±tlarƒ±) eri≈üiminizin aktif olduƒüundan emin olun.';
                    } else {
                        errorMsg += `Hata kodu ${response.status}. L√ºtfen Bulutfon hesabƒ±nƒ±zƒ± ve API ayarlarƒ±nƒ±zƒ± kontrol edin.`;
                    }
                    
                    showAlert(errorMsg, 'danger');
                    return { error: errorMsg };
                }
                
                const data = await response.json();
                console.log('‚úÖ Bulutfon API response:', data);
                
                // Bulutfon v2 API'den gelen data yapƒ±sƒ±nƒ± kontrol et
                const allRecords = Array.isArray(data) ? data : (data.cdrs || data.data || []);
                
                if (allRecords.length === 0) {
                    console.log('‚ö†Ô∏è Bulutfon\'dan kayƒ±t gelmedi');
                    return [];
                }
                
                // M√º≈üteri numarasƒ±yla e≈üle≈üen kayƒ±tlarƒ± filtrele - phonesMatch kullan
                // Hem caller/src (kaynak) hem callee/dst (hedef) alanlarƒ±na bak
                const matchingRecords = allRecords.filter(record => {
                    const caller = record.caller || record.src || '';
                    const callee = record.callee || record.dst || '';
                    
                    // phonesMatch ile g√º√ßl√º e≈üle≈ütirme (bo≈üluk, tire, +90 vs fark etmez)
                    return phonesMatch(caller, phoneNumber) || phonesMatch(callee, phoneNumber);
                });
                
                console.log(`üìä ${matchingRecords.length} adet g√∂r√º≈üme kaydƒ± bulundu`);
                
                // DEBUG: ƒ∞lk kaydƒ±n detaylarƒ±nƒ± g√∂ster
                if (matchingRecords.length > 0) {
                    console.log('üîç ƒ∞lk kayƒ±t detayƒ±:', matchingRecords[0]);
                    console.log('üîç ƒ∞lk kayƒ±tta bulunan field\'lar:', Object.keys(matchingRecords[0]));
                    console.log('üîç call_record:', matchingRecords[0].call_record);
                    console.log('üîç uuid:', matchingRecords[0].uuid);
                    console.log('üîç direction:', matchingRecords[0].direction);
                    console.log('üîç hangup_state:', matchingRecords[0].hangup_state);
                    console.log('üîç hangup_cause:', matchingRecords[0].hangup_cause, '(ANSWERED=cevaplanan)');
                    console.log('üîç is_missing_call:', matchingRecords[0].is_missing_call, `(type: ${typeof matchingRecords[0].is_missing_call}, true=cevapsƒ±z, false=cevaplanan)`);
                    console.log('üîç answer_time:', matchingRecords[0].answer_time);
                }
                
                return matchingRecords;
            } catch (error) {
                console.error('‚ùå Bulutfon g√∂r√º≈üme kayƒ±tlarƒ± alƒ±nƒ±rken hata:', error);
                showAlert('Bulutfon g√∂r√º≈üme kayƒ±tlarƒ± alƒ±nƒ±rken hata olu≈ütu: ' + error.message, 'danger');
                return [];
            }
        }
        
        // G√∂r√º≈üme kayƒ±tlarƒ±nƒ± g√∂ster
        async function renderCallRecords(phoneNumber, containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error('‚ùå Container bulunamadƒ±:', containerId);
                return;
            }
            
            console.log('üìû G√∂r√º≈üme kayƒ±tlarƒ± y√ºkleniyor:', phoneNumber);
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>G√∂r√º≈üme kayƒ±tlarƒ± y√ºkleniyor...</span></div>';
            
            // Bulutfon aktif deƒüilse bilgi g√∂ster
            if (!clubSettings || !clubSettings.bulutfonEnabled) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; background: #f5f5f5; border-radius: 8px;">
                        <p style="color: #666; margin-bottom: 10px;">üìû Bulutfon entegrasyonu aktif deƒüil</p>
                        <p style="color: #999; font-size: 12px;">G√∂r√º≈üme kayƒ±tlarƒ±nƒ± g√∂rmek i√ßin WhatsApp > Ayarlar > Bulutfon API Entegrasyonu b√∂l√ºm√ºnden aktif edin.</p>
                    </div>
                `;
                return;
            }
            
            const records = await fetchBulutfonCallRecords(phoneNumber);
            
            // Hata durumunu kontrol et
            if (records && records.error) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; background: #ffebee; border-radius: 8px; border-left: 4px solid #f44336;">
                        <p style="color: #c62828; margin-bottom: 10px; font-weight: 600;">‚ùå Bulutfon API Baƒülantƒ± Hatasƒ±</p>
                        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">${records.error}</p>
                        <div style="background: white; padding: 15px; border-radius: 6px; margin-top: 15px; text-align: left;">
                            <p style="font-weight: 600; color: #333; margin-bottom: 10px;">üîß √á√∂z√ºm √ñnerileri:</p>
                            <ul style="margin: 0; padding-left: 20px; color: #666; font-size: 12px;">
                                <li>Bulutfon panelinden aldƒ±ƒüƒ±nƒ±z API key'i doƒüru girdiƒüinizden emin olun</li>
                                <li>Bulutfon hesabƒ±nƒ±zda <strong>CDR (Call Detail Records - Arama Kayƒ±tlarƒ±)</strong> √∂zelliƒüinin aktif olmasƒ± gerekiyor</li>
                                <li>"API Baƒülantƒ±sƒ±nƒ± Test Et" butonuna basarak baƒülantƒ±yƒ± test edin</li>
                                <li>API key'i yeni olu≈üturduysanƒ±z, birka√ß dakika bekleyip tekrar deneyin</li>
                                <li>Bulutfon hesap y√∂neticinizle ileti≈üime ge√ßerek API eri≈üim yetkilerinizi kontrol edin</li>
                            </ul>
                        </div>
                    </div>
                `;
                return;
            }
            
            if (!records || records.length === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <p style="color: #666; margin-bottom: 10px;">üìã Bu numara i√ßin g√∂r√º≈üme kaydƒ± bulunamadƒ±</p>
                        <p style="color: #888; font-size: 12px;">Aranan numara: ${phoneNumber}</p>
                        <p style="color: #999; font-size: 11px; margin-top: 10px;">
                            üí° Bulutfon sisteminde bu numarayla yapƒ±lmƒ±≈ü bir g√∂r√º≈üme yoksa veya kayƒ±tlar silinmi≈ü olabilir.
                        </p>
                    </div>
                `;
                return;
            }
            
            // Kayƒ±tlarƒ± gelen ve giden olarak ayƒ±r
            const incomingCalls = records.filter(r => r.direction === 'IN');
            const outgoingCalls = records.filter(r => r.direction === 'OUT');
            
            const uniqueId = container.id; // Her container i√ßin benzersiz ID
            
            let html = `
                <div>
                    <div class="customer-tabs">
                        <button class="tab-button active" onclick="switchCallTab(0, '${uniqueId}')">üìû Gelen Aramalar (${incomingCalls.length})</button>
                        <button class="tab-button" onclick="switchCallTab(1, '${uniqueId}')">üì± Giden Aramalar (${outgoingCalls.length})</button>
                    </div>
                    
                    <div class="call-tab-content active" style="padding: 15px; background: white; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 8px 8px;">
                        <div style="display: grid; gap: 10px;">
            `;
            
            // Gelen Aramalar
            incomingCalls.forEach((record, idx) => {
                html += renderCallRecord(record, 'in-' + idx);
            });
            
            html += `
                        </div>
                    </div>
                    
                    <div class="call-tab-content" style="padding: 15px; background: white; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 8px 8px; display: none;">
                        <div style="display: grid; gap: 10px;">
            `;
            
            // Giden Aramalar
            outgoingCalls.forEach((record, idx) => {
                html += renderCallRecord(record, 'out-' + idx);
            });
            
            html += `
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // G√∂r√º≈üme kayƒ±tlarƒ± sekmelerini deƒüi≈ütir
        window.switchCallTab = function(tabIndex, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const tabs = container.querySelectorAll('.tab-button');
            const contents = container.querySelectorAll('.call-tab-content');
            
            tabs.forEach((btn, idx) => {
                if (idx === tabIndex) {
                    btn.classList.add('active');
                    contents[idx].style.display = 'block';
                } else {
                    btn.classList.remove('active');
                    contents[idx].style.display = 'none';
                }
            });
        };
        
        // Tek bir g√∂r√º≈üme kaydƒ±nƒ± render et
        function renderCallRecord(record, idx) {
            // Bulutfon v2 API field'larƒ± (call_time, caller, callee, duration, call_record)
            const callTime = record.call_time || record.call_Time || record.call_date;
            const date = new Date(callTime);
            date.setHours(date.getHours() - 3); // ‚úÖ UTC'den T√ºrkiye saatine √ßevir
            const dateStr = date.toLocaleString('tr-TR');
            
            // S√ºre hesaplama - duration (saniye) veya billsec
            let duration = '00:00';
            if (record.duration) {
                duration = `${record.duration} sn`;
            } else if (record.billsec) {
                duration = `${Math.floor(record.billsec / 60)}:${(record.billsec % 60).toString().padStart(2, '0')}`;
            }
            
            // Y√∂n belirleme
            const directionIcon = record.direction === 'IN' ? 'üìû Gelen' : 'üì± Giden';
            
            // ‚úÖ Durum belirleme - Gelen ve Giden aramalar i√ßin farklƒ± kontrol
            let isAnswered = false;
            let isMissed = false;
            
            if (record.direction === 'IN') {
                // GELEN ARAMALAR: is_missing_call parametresi kullan
                if (record.is_missing_call !== undefined && record.is_missing_call !== null) {
                    const isMissingCall = record.is_missing_call === true || record.is_missing_call === "true" || record.is_missing_call === 1;
                    isMissed = isMissingCall;
                    isAnswered = !isMissingCall;
                } else {
                    const hangupCause = (record.hangup_cause || '').toUpperCase();
                    isAnswered = hangupCause === 'ANSWERED';
                    isMissed = !isAnswered;
                }
            } else {
                // Gƒ∞DEN ARAMALAR: answer_time kontrol√º (√∂ncelikli)
                if (record.answer_time !== undefined) {
                    isAnswered = record.answer_time && record.answer_time !== null && record.answer_time !== '';
                    isMissed = !isAnswered;
                } else {
                    // Fallback: hangup_cause veya talking_seconds
                    const hangupCause = (record.hangup_cause || '').toUpperCase();
                    if (hangupCause) {
                        isAnswered = hangupCause === 'ANSWERED';
                    } else {
                        const talkingSeconds = parseInt(record.talking_seconds) || 0;
                        isAnswered = talkingSeconds > 0;
                    }
                    isMissed = !isAnswered;
                }
            }
            
            const statusColor = isAnswered ? '#4CAF50' : '#f44336';
            const statusText = isAnswered ? 'Cevaplandƒ±' : 'Cevaplanmadƒ±';
            
            // Arayan ve aranan numaralar - Formatla
            const caller = formatPhoneDisplay(record.caller || record.src || 'N/A');
            const callee = formatPhoneDisplay(record.callee || record.dst || 'N/A');
            
            // Ses kaydƒ± kontrol√º - call_record field'ƒ± veya UUID
            const recordingUrl = record.call_record; // Eƒüer doƒürudan URL ise
            const hasRecordingUrl = recordingUrl && recordingUrl !== null && recordingUrl !== '';
            const hasUuid = record.uuid || record.call_uuid;
            const canPlayRecording = hasRecordingUrl || (hasUuid && isAnswered);
            
            // ‚úÖ Ses kaydƒ± b√∂l√ºm√ºn√º her zaman g√∂ster (cevaplanan aramalar i√ßin)
            let recordingSection = '';
            if (isAnswered) {
                if (hasRecordingUrl) {
                    // Direkt URL varsa audio player g√∂ster
                    recordingSection = `
                        <div style="margin-top: 12px; padding: 10px; background: #e3f2fd; border-radius: 6px; border-left: 3px solid #2196f3;">
                            <div style="font-size: 12px; font-weight: 600; color: #1976d2; margin-bottom: 8px;">üéß Ses Kaydƒ±</div>
                            <audio controls style="width: 100%; height: 32px;">
                                <source src="${recordingUrl}" type="audio/mpeg">
                                Tarayƒ±cƒ±nƒ±z ses oynatmayƒ± desteklemiyor.
                            </audio>
                        </div>
                    `;
                } else if (hasUuid) {
                    // UUID varsa dinle butonu g√∂ster
                    recordingSection = `
                        <div style="margin-top: 12px; padding: 10px; background: #e3f2fd; border-radius: 6px; border-left: 3px solid #2196f3;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-size: 12px; font-weight: 600; color: #1976d2;">üéß Ses Kaydƒ±</span>
                                <button onclick="playRecording('${hasUuid}', 'audio-${idx}')" class="btn btn-sm btn-primary" style="font-size: 11px; padding: 4px 8px;">
                                    ‚ñ∂Ô∏è Dinle
                                </button>
                            </div>
                            <div id="audio-container-${idx}" style="display: none; margin-top: 8px;">
                                <audio id="audio-${idx}" controls style="width: 100%; height: 32px;">
                                    <source id="audio-source-${idx}" type="audio/mpeg">
                                    Tarayƒ±cƒ±nƒ±z ses oynatmayƒ± desteklemiyor.
                                </audio>
                                <div style="font-size: 10px; color: #1976d2; margin-top: 4px; text-align: center;">
                                    üí° Ses kaydƒ± y√ºkleniyor... Birka√ß saniye s√ºrebilir
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Ne URL ne UUID var - bilgilendirme g√∂ster
                    recordingSection = `
                        <div style="margin-top: 12px; padding: 8px; background: #fff3e0; border-radius: 6px; border-left: 3px solid #ff9800;">
                            <div style="font-size: 11px; color: #f57c00;">
                                üéß Ses kaydƒ± bulunamadƒ± (UUID eksik)
                            </div>
                        </div>
                    `;
                }
            } else {
                // Cevaplanmamƒ±≈ü aramalar i√ßin bilgi g√∂ster
                recordingSection = `
                    <div style="margin-top: 12px; padding: 8px; background: #ffebee; border-radius: 6px; border-left: 3px solid #f44336;">
                        <div style="font-size: 11px; color: #c62828;">
                            üìµ Cevapsƒ±z arama - Ses kaydƒ± yok
                        </div>
                    </div>
                `;
            }
            
            return `
                    <div style="padding: 12px; background: white; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <div style="font-weight: 600;">${directionIcon}</div>
                            <div style="font-size: 11px; color: #888;">${dateStr}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 12px;">
                                <span style="color: #666;">üìû</span> <strong>${caller}</strong> ‚Üí <strong>${callee}</strong>
                            </div>
                            <div style="font-size: 12px;">
                                <span style="color: #666;">‚è±Ô∏è</span> <strong>${duration}</strong>
                            </div>
                        </div>
                        ${statusText ? `
                            <div style="margin-top: 6px; font-size: 11px;">
                                <span style="padding: 2px 8px; background: ${statusColor}; color: white; border-radius: 4px;">${statusText}</span>
                            </div>
                        ` : ''}
                        
                        ${recordingSection}
                    </div>
                `;
        }
        
        // Ses kaydƒ±nƒ± √ßal
        window.playRecording = async function(recordingId, audioElementId) {
            try {
                const audioContainer = document.getElementById(`audio-container-${audioElementId.split('-')[1]}`);
                const audioElement = document.getElementById(audioElementId);
                const audioSource = document.getElementById(`audio-source-${audioElementId.split('-')[1]}`);
                
                if (!clubSettings || !clubSettings.bulutfonApiKey) {
                    showAlert('‚ö†Ô∏è Bulutfon API Key tanƒ±mlƒ± deƒüil!', 'warning');
                    return;
                }
                
                console.log('üéß Ses kaydƒ± y√ºkleniyor, UUID:', recordingId);
                
                // Audio elementi g√∂ster
                audioContainer.style.display = 'block';
                
                // Loading g√∂ster
                const buttonIdx = audioElementId.split('-')[1];
                const button = document.querySelector(`button[onclick*="audio-${buttonIdx}"]`);
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '‚è≥ Y√ºkleniyor...';
                }
                
                // Ses dosyasƒ±nƒ± y√ºkle
                try {
                    // Firebase Functions proxy √ºzerinden ses kaydƒ±nƒ± al (CORS sorunu √ß√∂z√ºm√º)
                    const recordingUrl = `https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonRecordingProxy?apikey=${clubSettings.bulutfonApiKey}&uuid=${recordingId}`;
                    
                    const response = await fetch(recordingUrl, {
                        method: 'GET'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'Bilinmeyen hata' }));
                        console.error('‚ùå Ses kaydƒ± API hatasƒ±:', response.status, errorData);
                        
                        if (response.status === 404) {
                            throw new Error('Bu g√∂r√º≈üme i√ßin ses kaydƒ± bulunamadƒ±. Kayƒ±t edilmemi≈ü olabilir.');
                        } else {
                            throw new Error(errorData.message || 'Ses kaydƒ± alƒ±namadƒ±');
                        }
                    }
                    
                    // Blob olarak al ve object URL olu≈ütur
                    const blob = await response.blob();
                    const blobUrl = URL.createObjectURL(blob);
                    
                    console.log('‚úÖ Ses kaydƒ± y√ºklendi, boyut:', blob.size, 'bytes');
                    
                    // Audio source'a ata ve oynat
                    audioSource.src = blobUrl;
                    audioElement.load();
                    await audioElement.play();
                    
                    showAlert('üéß Ses kaydƒ± ba≈üarƒ±yla y√ºklendi', 'success');
                    
                    // Butonu gizle
                    if (button) {
                        button.style.display = 'none';
                    }
                    
                } catch (error) {
                    console.error('Ses kaydƒ± y√ºklenirken hata:', error);
                    showAlert(`‚ùå ${error.message}`, 'danger');
                    audioContainer.style.display = 'none';
                    
                    // Butonu eski haline getir
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = '‚ñ∂Ô∏è Dinle';
                    }
                }
            } catch (error) {
                console.error('Ses oynatma hatasƒ±:', error);
                showAlert('Ses kaydƒ± oynatƒ±lƒ±rken bir hata olu≈ütu.', 'danger');
            }
        };
         async function handleUserSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const selectedPermissions = formData.getAll('permissions');

            const userData = {
                fullName: data.fullName,
                phone: data.phone,
                phoneNumber: data.phone, // For WhatsApp notifications
                username: data.phone,
                password: data.password, 
                email: data.phone + '@kulup.local', // For task assignment
                permissions: {
                    // Finansal Yetkiler
                    view_payments: selectedPermissions.includes('view_payments'),
                    edit_payments: selectedPermissions.includes('edit_payments'),
                    delete_payments: selectedPermissions.includes('delete_payments'),
                    export_payments: selectedPermissions.includes('export_payments'),
                    
                    // √úye Yetkiler
                    view_members: selectedPermissions.includes('view_members'),
                    add_members: selectedPermissions.includes('add_members'),
                    edit_members: selectedPermissions.includes('edit_members'),
                    delete_members: selectedPermissions.includes('delete_members'),
                    export_members: selectedPermissions.includes('export_members'),
                    
                    // CRM Yetkileri
                    view_crm: selectedPermissions.includes('view_crm'),
                    add_crm: selectedPermissions.includes('add_crm'),
                    edit_crm: selectedPermissions.includes('edit_crm'),
                    delete_crm: selectedPermissions.includes('delete_crm'),
                    view_calls: selectedPermissions.includes('view_calls'),
                    
                    // ƒ∞leti≈üim Yetkileri
                    send_messages: selectedPermissions.includes('send_messages'),
                    send_bulk_messages: selectedPermissions.includes('send_bulk_messages'),
                    view_message_history: selectedPermissions.includes('view_message_history'),
                    
                    // Raporlar ve ƒ∞statistikler
                    view_stats: selectedPermissions.includes('view_stats'),
                    view_reports: selectedPermissions.includes('view_reports'),
                    export_reports: selectedPermissions.includes('export_reports'),
                    
                    // Ayarlar ve Y√∂netim
                    manage_users: selectedPermissions.includes('manage_users'),
                    manage_settings: selectedPermissions.includes('manage_settings'),
                    manage_branches: selectedPermissions.includes('manage_branches'),
                    manage_groups: selectedPermissions.includes('manage_groups'),
                    
                    // Yoklama ve Takvim
                    view_attendance: selectedPermissions.includes('view_attendance'),
                    edit_attendance: selectedPermissions.includes('edit_attendance'),
                    manage_schedule: selectedPermissions.includes('manage_schedule')
                },
                clubId: currentClubId // ‚úÖ Kul√ºp ID'si eklendi
            };

            try {
                await window.firebase.addDoc(window.firebase.collection(window.db, 'users'), userData);
                showAlert('Yeni y√∂netici ba≈üarƒ±yla eklendi.', 'success');
                form.reset();
                await loadData();
            } catch (error) {
                console.error('Error adding user:', error);
                showAlert('Y√∂netici eklenirken bir hata olu≈ütu.', 'danger');
            }
        }

        async function openTaskMessagesModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return showAlert('G√∂rev bulunamadƒ±.', 'danger');
            
            const modal = document.getElementById('taskMessagesModal');
            const modalTitle = document.getElementById('taskMessagesModalTitle');
            const messagesList = document.getElementById('taskMessagesList');
            const messageForm = document.getElementById('taskMessageForm');
            
            modalTitle.textContent = `üí¨ Mesajlar - ${task.taskName}`;
            messageForm.taskId.value = taskId;
            
            // Mark messages as read
            const unreadMessages = (task.messages || []).filter(m => !m.read && m.sender !== currentUser.fullName);
            if (unreadMessages.length > 0) {
                const updatedMessages = (task.messages || []).map(m => {
                    if (!m.read && m.sender !== currentUser.fullName) {
                        return { ...m, read: true };
                    }
                    return m;
                });
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'tasks', taskId), { messages: updatedMessages });
                task.messages = updatedMessages;
            }
            
            // Render messages
            const messages = task.messages || [];
            messagesList.innerHTML = messages.length === 0 
                ? '<p class="empty-state">Hen√ºz mesaj yok.</p>'
                : messages.map((msg, index) => {
                    const isMine = msg.sender === currentUser.fullName;
                    const canDelete = currentUser.isSuperAdmin;
                    const deleteBtn = canDelete ? `<button class="task-message-delete" onclick="deleteTaskMessage('${taskId}', ${index})" title="Mesajƒ± Sil">√ó</button>` : '';
                    return `
                        <div class="task-message ${isMine ? 'task-message-mine' : 'task-message-other'}">
                            ${deleteBtn}
                            <div class="task-message-header">
                                <strong>${msg.sender}</strong>
                                <span class="task-message-time">${formatDate(msg.timestamp)}</span>
                            </div>
                            <div class="task-message-body">${msg.message}</div>
                        </div>
                    `;
                }).join('');
            
            // Scroll to bottom
            setTimeout(() => {
                messagesList.scrollTop = messagesList.scrollHeight;
            }, 50);
            
            openModal('taskMessagesModal');
        }
        
        async function sendTaskMessage(e) {
            e.preventDefault();
            const form = e.target;
            const taskId = form.taskId.value;
            const messageText = form.messageText.value.trim();
            
            if (!messageText) return showAlert('Mesaj bo≈ü olamaz.', 'warning');
            
            const task = tasks.find(t => t.id === taskId);
            if (!task) return showAlert('G√∂rev bulunamadƒ±.', 'danger');
            
            const newMessage = {
                sender: currentUser.fullName,
                message: messageText,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            const updatedMessages = [...(task.messages || []), newMessage];
            
            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'tasks', taskId), { messages: updatedMessages });
                task.messages = updatedMessages;
                form.messageText.value = '';
                openTaskMessagesModal(taskId); // Refresh messages
                showAlert('Mesaj g√∂nderildi.', 'success');
                
                // Send WhatsApp notification
                const notificationSent = await sendTaskMessageNotification(task, messageText, currentUser.fullName);
                if (notificationSent) {
                    console.log('‚úÖ WhatsApp bildirimi g√∂nderildi');
                } else {
                    console.log('‚ö†Ô∏è WhatsApp bildirimi g√∂nderilemedi (≈üablon kapalƒ± veya ayarlar eksik olabilir)');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showAlert('Mesaj g√∂nderilirken hata olu≈ütu.', 'danger');
            }
        }
        
        // Send WhatsApp notification when a task message is added
        async function sendTaskMessageNotification(task, messageText, sender) {
            try {
                // Check if template is enabled
                if (!messageTemplates.taskMessage || !messageTemplates.taskMessage.enabled) {
                    console.log('Task message notification: Template not enabled');
                    return false;
                }
                
                // Find the user assigned to this task
                let assignedUser = users.find(u => u.email === task.assignedTo);
                if (!assignedUser) {
                    assignedUser = users.find(u => u.fullName === task.assignedTo);
                }
                
                if (!assignedUser) {
                    console.log('Task message notification: Assigned user not found', task.assignedTo);
                    return false;
                }
                
                // Don't send notification to the sender
                if (assignedUser.fullName === sender) {
                    console.log('Task message notification: Skipping - user is sender');
                    return false;
                }
                
                // Check if user has phone number
                let phoneNumber = assignedUser.phoneNumber || assignedUser.phone;
                if (!phoneNumber) {
                    console.log('Task message notification: User has no phone number', assignedUser.fullName);
                    return false;
                }
                
                // Format phone number to 905xxxxxxxxx
                phoneNumber = phoneNumber.replace(/\D/g, '');
                if (phoneNumber.startsWith('0')) {
                    phoneNumber = '90' + phoneNumber.substring(1);
                } else if (!phoneNumber.startsWith('90')) {
                    phoneNumber = '90' + phoneNumber;
                }
                
                // Get connected WhatsApp device
                let connectedDevice;
                if (defaultWhatsAppDevice) {
                    connectedDevice = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
                }
                if (!connectedDevice) {
                    connectedDevice = whatsappDevices.find(d => d.status === 'connected');
                }
                if (!connectedDevice) {
                    console.log('Task message notification: No connected device');
                    return false;
                }
                
                // Prepare message from template
                let message = messageTemplates.taskMessage.text || '';
                if (!message || message.trim() === '') {
                    message = `Sayƒ±n {VELI_AD_SOYAD},\n\n"{GOREV}" g√∂revi i√ßin yeni bir mesaj aldƒ±nƒ±z:\n\nüí¨ {MESAJ}\nüì§ G√∂nderen: {GONDEREN}\nüìÖ Tarih: {TARIH}\n\nG√∂rev detaylarƒ±nƒ± kontrol ediniz.`;
                }
                
                const userName = assignedUser.fullName || assignedUser.email;
                message = message.replace(/{UYE_AD_SOYAD}/g, userName);
                message = message.replace(/{OGRENCI_AD_SOYAD}/g, '');
                // Backward compatibility
                message = message.replace(/{VELI_AD_SOYAD}/g, userName);
                message = message.replace(/{AD_SOYAD}/g, userName).replace(/{AD}/g, userName);
                
                message = message.replace(/{GOREV}/g, task.taskName);
                message = message.replace(/{MESAJ}/g, messageText.substring(0, 100) + (messageText.length > 100 ? '...' : ''));
                message = message.replace(/{GONDEREN}/g, sender);
                message = message.replace(/{TARIH}/g, formatDate(new Date().toISOString()));
                
                console.log('Task message notification: Sending to', assignedUser.fullName, phoneNumber);
                
                // Send message
                const result = await sendWhatsAppMessage(connectedDevice.instanceName, phoneNumber, message, assignedUser.fullName || assignedUser.email);
                const success = result.success || result === true;
                console.log('Task message notification sent:', success);
                
                return success;
            } catch (error) {
                console.error('Task message notification error:', error);
                return false;
            }
        }
        
        async function deleteTaskMessage(taskId, messageIndex) {
            if (!currentUser.isSuperAdmin) {
                return showAlert('Bu i≈ülem i√ßin yetkiniz yok.', 'danger');
            }
            
            showConfirmModal('Bu mesajƒ± silmek istediƒüinizden emin misiniz?', async () => {
                closeModal('confirmModal');
                try {
                    const task = tasks.find(t => t.id === taskId);
                    if (!task) return showAlert('G√∂rev bulunamadƒ±.', 'danger');
                    
                    const updatedMessages = [...(task.messages || [])];
                    updatedMessages.splice(messageIndex, 1);
                    
                    await window.firebase.updateDoc(window.firebase.doc(window.db, 'tasks', taskId), { messages: updatedMessages });
                    task.messages = updatedMessages;
                    openTaskMessagesModal(taskId); // Refresh
                    showAlert('Mesaj silindi.', 'success');
                } catch (error) {
                    console.error('Error deleting message:', error);
                    showAlert('Mesaj silinirken hata olu≈ütu.', 'danger');
                }
            });
        }

        async function handleTaskSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const taskId = data.taskId;
            delete data.taskId;

            const taskData = {
                taskName: data.taskName,
                assignedTo: data.assignedTo,
                status: data.status,
                notes: data.notes || '',
                clubId: currentClubId // ‚úÖ Kul√ºp ID'si eklendi
            };

            try {
                if (taskId) { // Editing existing task
                    if (taskData.status === 'Tamamlandƒ±') {
                        taskData.completedAt = new Date().toISOString();
                    } else {
                        taskData.completedAt = null;
                    }
                    await window.firebase.updateDoc(window.firebase.doc(window.db, 'tasks', taskId), taskData);
                    showAlert('G√∂rev g√ºncellendi.', 'success');
                } else { // Creating new task
                    taskData.createdAt = new Date().toISOString();
                    taskData.completedAt = null;
                    if (taskData.status === 'Tamamlandƒ±') {
                       taskData.completedAt = new Date().toISOString();
                    }
                    await window.firebase.addDoc(window.firebase.collection(window.db, 'tasks'), taskData);
                    showAlert('Yeni g√∂rev eklendi.', 'success');
                    
                    // Send WhatsApp notification in background (don't wait)
                    sendTaskNotification(taskData).catch(err => {
                        console.error('Task notification failed:', err);
                    });
                }
                closeModal('taskModal');
                await loadData();
            } catch (error) {
                showAlert('G√∂rev kaydedilirken hata olu≈ütu.', 'danger');
            }
        }
        
        // --- WHATSAPP NOTIFICATION FUNCTIONS ---
        async function sendTaskNotification(taskData) {
            try {
                // Check if template is enabled
                if (!messageTemplates.task || !messageTemplates.task.enabled) {
                    console.log('Task notification: Template not enabled');
                    return false;
                }
                
                // Find assigned user by email or fullName
                let assignedUser = users.find(u => u.email === taskData.assignedTo);
                if (!assignedUser) {
                    // Try finding by fullName
                    assignedUser = users.find(u => u.fullName === taskData.assignedTo);
                }
                
                if (!assignedUser) {
                    console.log('Task notification: User not found', taskData.assignedTo);
                    return false;
                }
                
                // Check if user has phone number
                let phoneNumber = assignedUser.phoneNumber || assignedUser.phone;
                if (!phoneNumber) {
                    console.log('Task notification: User has no phone number', assignedUser.fullName);
                    return false;
                }
                
                // Format phone number to 905xxxxxxxxx
                phoneNumber = phoneNumber.replace(/\D/g, ''); // Remove non-digits
                if (phoneNumber.startsWith('0')) {
                    phoneNumber = '90' + phoneNumber.substring(1); // Replace leading 0 with 90
                } else if (!phoneNumber.startsWith('90')) {
                    phoneNumber = '90' + phoneNumber; // Add 90 prefix
                }
                
                // Get default WhatsApp device
                let connectedDevice;
                
                // First try to use default device
                if (defaultWhatsAppDevice) {
                    connectedDevice = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
                }
                
                // If no default or default not connected, use any connected device
                if (!connectedDevice) {
                    connectedDevice = whatsappDevices.find(d => d.status === 'connected');
                }
                
                if (!connectedDevice) {
                    console.log('Task notification: No connected device');
                    return false;
                }
                
                console.log('Task notification: Sending to', assignedUser.fullName, phoneNumber);
                console.log('Message templates:', messageTemplates);
                console.log('Task template:', messageTemplates.task);
                
                // Prepare message from template
                let message = messageTemplates.task?.text || '';
                
                // If no template text, use default
                if (!message || message.trim() === '') {
                    message = `Sayƒ±n {VELI_AD_SOYAD}, Size yeni bir g√∂rev atandƒ±:\n\nüìã G√∂rev: {GOREV}\nüìù A√ßƒ±klama: {ACIKLAMA}\nüìÖ Tarih: {TARIH}\n\nƒ∞yi √ßalƒ±≈ümalar dileriz.`;
                    console.warn('Using default task template as saved template is empty');
                }
                
                const userName = assignedUser.fullName || assignedUser.email;
                message = message.replace(/{UYE_AD_SOYAD}/g, userName);
                message = message.replace(/{OGRENCI_AD_SOYAD}/g, '');
                // Backward compatibility
                message = message.replace(/{VELI_AD_SOYAD}/g, userName);
                message = message.replace(/{AD_SOYAD}/g, userName).replace(/{AD}/g, userName);
                
                message = message.replace(/{GOREV}/g, taskData.taskName);
                message = message.replace(/{ACIKLAMA}/g, taskData.notes || 'A√ßƒ±klama bulunmamaktadƒ±r');
                message = message.replace(/{TARIH}/g, formatDate(taskData.createdAt));
                
                console.log('Final message to send:', message);
                
                // Send message
                const result = await sendWhatsAppMessage(connectedDevice.instanceName, phoneNumber, message, assignedUser.fullName || assignedUser.email);
                const success = result.success || result === true;
                console.log('Task notification sent:', success);
                
                // Show notification to user
                if (success) {
                    setTimeout(() => {
                        showAlert(`üì® WhatsApp bildirimi ${assignedUser.fullName}'a g√∂nderildi`, 'success');
                    }, 200);
                } else {
                    setTimeout(() => {
                        const errorMsg = result.errorReason ? ` (${result.errorReason})` : '';
                        showAlert(`‚ö†Ô∏è WhatsApp bildirimi g√∂nderilemedi${errorMsg}`, 'warning');
                    }, 200);
                }
                
                return success;
                
            } catch (error) {
                console.error('Task notification error:', error);
                setTimeout(() => {
                    showAlert(`‚ö†Ô∏è WhatsApp bildirimi g√∂nderilemedi: ${error.message}`, 'warning');
                }, 200);
                return false;
            }
        }
        
        async function sendWhatsAppMessage(instanceName, phoneNumber, message, logRecipient = 'Bilinmeyen') {
            let success = false;
            let formattedPhone = '';
            let errorReason = '';
            
            try {
                // ‚úÖ √áalƒ±≈üma saatleri kontrol√º
                if (!isWithinWorkingHours()) {
                    console.log('‚è∞ √áalƒ±≈üma saatleri dƒ±≈üƒ±nda, mesaj kuyruƒüa ekleniyor...');
                    await addMessageToQueue(phoneNumber, message, instanceName);
                    showAlert(`üìã Mesaj √ßalƒ±≈üma saatleri dƒ±≈üƒ±nda olduƒüu i√ßin kuyruƒüa eklendi. ${getNextWorkingHour().split('T')[0]} tarihinde g√∂nderilecek.`, 'info');
                    return true; // Kuyruklamanƒ±n ba≈üarƒ±lƒ± olduƒüunu belirt
                }
                
                // ‚úÖ Apply rate limiting with random delays for all messages
                const now = Date.now();
                const timeSinceLastMessage = now - lastMessageSentTime;
                
                // Calculate required wait time based on message count
                const shouldLongWait = (totalMessagesSent % (clubSettings.longWaitTrigger || 100)) === 0 && totalMessagesSent > 0;
                let requiredWaitTime;
                
                if (shouldLongWait) {
                    const min = (clubSettings.minLongWait || 400) * 1000;
                    const max = (clubSettings.maxLongWait || 800) * 1000;
                    requiredWaitTime = Math.floor(Math.random() * (max - min + 1)) + min;
                    console.log(`‚è≥ UZUN BEKLEME: ${(requiredWaitTime / 1000).toFixed(1)}s (Her ${clubSettings.longWaitTrigger} mesajda bir)`);
                } else {
                    const min = (clubSettings.minWaitTime || 20) * 1000;
                    const max = (clubSettings.maxWaitTime || 50) * 1000;
                    requiredWaitTime = Math.floor(Math.random() * (max - min + 1)) + min;
                    if (totalMessagesSent > 0) {
                        console.log(`‚è≥ Mesaj arasƒ± bekleme: ${(requiredWaitTime / 1000).toFixed(1)}s`);
                    }
                }
                
                // If not enough time has passed, wait
                if (timeSinceLastMessage < requiredWaitTime) {
                    const remainingWait = requiredWaitTime - timeSinceLastMessage;
                    await new Promise(resolve => setTimeout(resolve, remainingWait));
                }
                
                // Update tracking
                lastMessageSentTime = Date.now();
                totalMessagesSent++;
                
                // Format phone number for WhatsApp
                formattedPhone = phoneNumber.replace(/\D/g, '');
                if (formattedPhone.startsWith('0') && formattedPhone.length === 11) {
                    // 05449367543 ‚Üí 905449367543
                    formattedPhone = '90' + formattedPhone.substring(1);
                } else if (formattedPhone.startsWith('0')) {
                    formattedPhone = formattedPhone.substring(1);
                }
                if (!formattedPhone.startsWith('90')) {
                    formattedPhone = '90' + formattedPhone;
                }
                
                console.log(`üì§ Sending WhatsApp message to: ${formattedPhone}@s.whatsapp.net via ${instanceName}`);
                
                // Try multiple formats for compatibility
                const formats = [
                    // Format 1: With @s.whatsapp.net (most common)
                    {
                        number: `${formattedPhone}@s.whatsapp.net`,
                        text: message
                    },
                    // Format 2: Without @s.whatsapp.net
                    {
                        number: formattedPhone,
                        text: message
                    }
                ];
                
                let response = null;
                let responseData = null;
                let lastError = null;
                
                // Try each format until one works
                for (let i = 0; i < formats.length && !success; i++) {
                    console.log(`Trying format ${i + 1}:`, JSON.stringify(formats[i]));
                    
                    try {
                        // Create AbortController for timeout
                        const controller = new AbortController();
                        // 2 dakika timeout - API'nin cevap vermesi i√ßin yeterli s√ºre
                        const timeoutId = setTimeout(() => controller.abort(), 120000);
                        
                        response = await fetch(`${EVOLUTION_API_URL}/message/sendText/${instanceName}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': EVOLUTION_API_KEY
                            },
                            body: JSON.stringify(formats[i]),
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        responseData = await response.json().catch(() => ({}));
                        console.log('WhatsApp API response:', response.status, responseData);
                        
                        if (response.ok) {
                            success = true;
                            console.log('‚úÖ Message sent successfully with format', i + 1);
                            break;
                        } else {
                            console.warn(`Format ${i + 1} failed (HTTP ${response.status}), trying next...`);
                            lastError = responseData;
                            if (responseData.response) {
                                console.error('Error details:', JSON.stringify(responseData.response, null, 2));
                            }
                            // Eƒüer HTTP hatasƒ± varsa (404, 401, 500 vs) bir sonraki formatƒ± dene
                            // Timeout deƒüilse devam et
                        }
                    } catch (fetchError) {
                        console.log(`Format ${i + 1} fetch error:`, fetchError.message);
                        if (fetchError.name === 'AbortError') {
                            console.warn('‚è±Ô∏è Request timeout (2 dakika), trying next format...');
                            errorReason = 'ƒ∞stek zaman a≈üƒ±mƒ±na uƒüradƒ± (2 dakika)';
                        } else {
                            errorReason = `Baƒülantƒ± hatasƒ±: ${fetchError.message}`;
                        }
                        lastError = { message: fetchError.message };
                    }
                }
                
                // If all formats failed, set error reason
                if (!success && response) {
                    if (response.status === 500) {
                        errorReason = 'Sunucu hatasƒ± (500)';
                    } else if (response.status === 404) {
                        errorReason = 'Instance bulunamadƒ± (404)';
                    } else if (response.status === 401 || response.status === 403) {
                        errorReason = 'Yetki hatasƒ± (401/403)';
                    } else if (lastError && lastError.message) {
                        errorReason = lastError.message;
                    } else if (lastError && lastError.error) {
                        errorReason = lastError.error;
                    } else {
                        errorReason = `HTTP ${response.status}`;
                    }
                }
            } catch (error) {
                console.error('WhatsApp message error:', error);
                success = false;
                errorReason = `ƒ∞stek hatasƒ±: ${error.message}`;
            }
            
            // Log message to Firebase
            try {
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'sentMessages'),
                    {
                        recipient: logRecipient,
                        recipientPhone: formattedPhone,
                        message: message,
                        instanceName: instanceName,
                        success: success,
                        sentAt: new Date().toISOString(),
                        sentBy: currentUser?.email || 'system',
                        clubId: currentClubId // ‚úÖ Kul√ºp ID'si eklendi
                    }
                );
                
                // Reload messages in background
                const messagesSnapshot = await window.firebase.getDocs(
                    window.firebase.query(
                        window.firebase.collection(window.db, 'sentMessages'),
                        window.firebase.where('clubId', '==', currentClubId),
                        window.firebase.orderBy('sentAt', 'desc')
                    )
                );
                sentMessages = messagesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).slice(0, 50);
                loadSentMessagesLog();
            } catch (error) {
                // Ignore log errors
            }
            
            return { success, errorReason, formattedPhone };
        }

        window.sendBirthdayMessage = async function(memberId) {
            if (!messageTemplates.birthday || !messageTemplates.birthday.enabled) {
                showAlert('Doƒüum g√ºn√º ≈üablonu etkinle≈ütirilmemi≈ü! L√ºtfen ayarlardan etkinle≈ütirin.', 'warning');
                return;
            }

            const member = members.find(m => m.id === memberId);
            if (!member) {
                showAlert('√úye bulunamadƒ±!', 'danger');
                return;
            }

            if (!member.Telefon) {
                showAlert('√úye telefon numarasƒ± bulunamadƒ±!', 'danger');
                return;
            }

            // Find connected device
            let device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
            if (!device) {
                device = whatsappDevices.find(d => d.status === 'connected');
            }
            
            if (!device) {
                showAlert('Baƒülƒ± WhatsApp cihazƒ± bulunamadƒ±!', 'danger');
                return;
            }

            try {
                const isChild = !!member.Resit_Olmayan_Adi_Soyadi;
                
                // Get template text based on member type
                let message = '';
                if (isChild) {
                    message = messageTemplates.birthday.textChild || messageTemplates.birthday.text || '';
                } else {
                    message = messageTemplates.birthday.textAdult || messageTemplates.birthday.text || '';
                }
                
                if (!message || message.trim() === '') {
                    showAlert('Mesaj ≈üablonu bo≈ü! L√ºtfen ayarlardan d√ºzenleyin.', 'warning');
                    return;
                }

                // Replace template variables
                const studentName = member.Resit_Olmayan_Adi_Soyadi || '';
                const parentName = member.Ad_Soyad || 'Deƒüerli √úyemiz';
                const uyeName = isChild ? parentName : parentName;
                
                message = message.replace(/{UYE_AD_SOYAD}/g, uyeName);
                message = message.replace(/{OGRENCI_AD_SOYAD}/g, studentName);
                // Backward compatibility
                message = message.replace(/{VELI_AD_SOYAD}/g, parentName);
                message = message.replace(/{AD_SOYAD}/g, uyeName).replace(/{AD}/g, uyeName);

                // Confirm before sending
                const memberName = isChild ? studentName : parentName;
                if (!confirm(`${memberName} i√ßin doƒüum g√ºn√º mesajƒ± g√∂nderilsin mi?\n\nMesaj:\n${message}`)) {
                    return;
                }

                // Send message
                const result = await sendWhatsAppMessage(device.instanceName, member.Telefon, message, memberName, 'birthday');
                
                if (result.success || result === true) {
                    showAlert('üéÇ Doƒüum g√ºn√º mesajƒ± ba≈üarƒ±yla g√∂nderildi!', 'success');
                } else {
                    showAlert('‚ùå Mesaj g√∂nderilemedi!', 'danger');
                }
            } catch (error) {
                console.error('Error sending birthday message:', error);
                showAlert('Hata: ' + error.message, 'danger');
            }
        };

        async function checkAndSendBirthdayMessages() {
            if (!messageTemplates.birthday || !messageTemplates.birthday.enabled) {
                console.log('üéÇ Doƒüum g√ºn√º ≈üablonu etkin deƒüil');
                return;
            }

            // Find connected device
            let device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
            if (!device) {
                device = whatsappDevices.find(d => d.status === 'connected');
            }
            
            if (!device) {
                console.log('‚ö†Ô∏è Baƒülƒ± WhatsApp cihazƒ± yok, doƒüum g√ºn√º mesajlarƒ± g√∂nderilemedi.');
                return;
            }

            // Get today's date (day and month)
            const today = new Date();
            const todayDay = today.getDate();
            const todayMonth = today.getMonth() + 1; // 0-indexed

            let birthdayCount = 0;

            // Check all members
            for (const member of members) {
                if (!member.Telefon || member.status !== 'active') continue;

                // Check if member has birthday
                const birthdayField = member.Dogum_Tarihi || member.dogumTarihi || member.birthday;
                if (!birthdayField) continue;

                // Parse birthday
                const birthday = new Date(birthdayField);
                const birthdayDay = birthday.getDate();
                const birthdayMonth = birthday.getMonth() + 1;

                // Check if today is birthday
                if (birthdayDay === todayDay && birthdayMonth === todayMonth) {
                    // Check if message already sent today
                    const sentToday = sentMessages.some(msg => {
                        const msgDate = new Date(msg.sentAt);
                        return msg.recipientPhone === member.Telefon && 
                               msg.type === 'birthday' &&
                               msgDate.getDate() === todayDay &&
                               msgDate.getMonth() === todayMonth &&
                               msgDate.getFullYear() === today.getFullYear();
                    });

                    if (sentToday) {
                        console.log(`üéÇ ${member.Ad_Soyad || member.Resit_Olmayan_Adi_Soyadi}: Bug√ºn zaten mesaj g√∂nderilmi≈ü`);
                        continue;
                    }

                    // Send birthday message
                    try {
                        const isChild = !!member.Resit_Olmayan_Adi_Soyadi;
                        
                        // Get template text based on member type
                        let message = '';
                        if (isChild) {
                            message = messageTemplates.birthday.textChild || messageTemplates.birthday.text || '';
                        } else {
                            message = messageTemplates.birthday.textAdult || messageTemplates.birthday.text || '';
                        }
                        
                        if (!message || message.trim() === '') {
                            console.log('‚ö†Ô∏è Doƒüum g√ºn√º mesaj ≈üablonu bo≈ü!');
                            continue;
                        }

                        // Replace template variables
                        const studentName = member.Resit_Olmayan_Adi_Soyadi || '';
                        const parentName = member.Ad_Soyad || 'Deƒüerli √úyemiz';
                        const uyeName = isChild ? parentName : parentName;
                        
                        message = message.replace(/{UYE_AD_SOYAD}/g, uyeName);
                        message = message.replace(/{OGRENCI_AD_SOYAD}/g, studentName);
                        // Backward compatibility
                        message = message.replace(/{VELI_AD_SOYAD}/g, parentName);
                        message = message.replace(/{AD_SOYAD}/g, uyeName).replace(/{AD}/g, uyeName);

                        // Send message
                        const memberName = isChild ? studentName : parentName;
                        const result = await sendWhatsAppMessage(device.instanceName, member.Telefon, message, memberName, 'birthday');
                        
                        if (result.success || result === true) {
                            console.log(`üéÇ‚úÖ Doƒüum g√ºn√º mesajƒ± g√∂nderildi: ${memberName}`);
                            birthdayCount++;
                        } else {
                            console.log(`üéÇ‚ùå Doƒüum g√ºn√º mesajƒ± g√∂nderilemedi: ${memberName}`);
                        }

                        // Small delay between messages
                        await new Promise(resolve => setTimeout(resolve, 500));

                    } catch (error) {
                        console.error('Doƒüum g√ºn√º mesajƒ± g√∂nderme hatasƒ±:', error);
                    }
                }
            }

            if (birthdayCount > 0) {
                console.log(`üéâ ${birthdayCount} doƒüum g√ºn√º mesajƒ± g√∂nderildi!`);
                showAlert(`üéÇ ${birthdayCount} doƒüum g√ºn√º mesajƒ± ba≈üarƒ±yla g√∂nderildi!`, 'success');
            } else {
                console.log('üéÇ Bug√ºn doƒüum g√ºn√º olan √ºye yok');
            }
        }

        async function sendAbsenceNotifications(absenceList) {
            if (!messageTemplates.absence || !messageTemplates.absence.enabled) {
                console.log('‚ö†Ô∏è Devamsƒ±zlƒ±k ≈üablonu etkin deƒüil, mesaj g√∂nderilmedi.');
                return;
            }

            // Find connected device
            let device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
            if (!device) {
                device = whatsappDevices.find(d => d.status === 'connected');
            }
            
            if (!device) {
                console.log('‚ö†Ô∏è Baƒülƒ± WhatsApp cihazƒ± yok, devamsƒ±zlƒ±k mesajlarƒ± g√∂nderilemedi.');
                return;
            }

            let successCount = 0;
            let failCount = 0;

            for (const absence of absenceList) {
                try {
                    const member = absence.member;
                    
                    // Check if member has phone
                    if (!member.Telefon) {
                        console.log(`‚ö†Ô∏è ${member.Ad_Soyad || member.Resit_Olmayan_Adi_Soyadi}: Telefon numarasƒ± yok`);
                        failCount++;
                        continue;
                    }

                    // Check if member is a child
                    const isChild = !!member.Resit_Olmayan_Adi_Soyadi;
                    
                    // Get template text based on member type
                    let message = '';
                    if (isChild) {
                        message = messageTemplates.absence.textChild || messageTemplates.absence.text || '';
                    } else {
                        message = messageTemplates.absence.textAdult || messageTemplates.absence.text || '';
                    }
                    
                    if (!message || message.trim() === '') {
                        console.log('‚ö†Ô∏è Devamsƒ±zlƒ±k mesaj ≈üablonu bo≈ü!');
                        failCount++;
                        continue;
                    }

                    // Replace template variables
                    const studentName = member.Resit_Olmayan_Adi_Soyadi || '';
                    const parentName = member.Ad_Soyad || 'Deƒüerli √úyemiz';
                    const uyeName = isChild ? parentName : parentName;
                    
                    // Get lesson name from branch
                    const group = groups.find(g => g.groupName === absence.groupName);
                    const branchId = group ? group.branch : null;
                    const branch = branches.find(b => b.id === branchId);
                    const lessonName = branch ? branch.lessonName : absence.groupName;
                    
                    message = message.replace(/{UYE_AD_SOYAD}/g, uyeName);
                    message = message.replace(/{OGRENCI_AD_SOYAD}/g, studentName);
                    message = message.replace(/{TARIH}/g, formatDate(absence.date));
                    message = message.replace(/{DERS}/g, lessonName);
                    // Backward compatibility
                    message = message.replace(/{VELI_AD_SOYAD}/g, parentName);
                    message = message.replace(/{AD_SOYAD}/g, uyeName).replace(/{AD}/g, uyeName);

                    // Send message
                    const memberName = isChild ? studentName : parentName;
                    const result = await sendWhatsAppMessage(device.instanceName, member.Telefon, message, memberName);
                    
                    if (result.success || result === true) {
                        console.log(`‚úÖ Devamsƒ±zlƒ±k mesajƒ± g√∂nderildi: ${memberName}`);
                        successCount++;
                    } else {
                        console.log(`‚ùå Devamsƒ±zlƒ±k mesajƒ± g√∂nderilemedi: ${memberName}`);
                        failCount++;
                    }

                    // Small delay between messages
                    await new Promise(resolve => setTimeout(resolve, 1000));

                } catch (error) {
                    console.error('Devamsƒ±zlƒ±k mesajƒ± g√∂nderme hatasƒ±:', error);
                    failCount++;
                }
            }

            console.log(`üìä Devamsƒ±zlƒ±k Mesajlarƒ±: ${successCount} ba≈üarƒ±lƒ±, ${failCount} ba≈üarƒ±sƒ±z`);
            
            if (successCount > 0) {
                setTimeout(() => {
                    showAlert(`‚úÖ ${successCount} devamsƒ±zlƒ±k mesajƒ± ba≈üarƒ±yla g√∂nderildi!`, 'success');
                }, 500);
            }
        }

        window.sendPendingRegistrationReminder = async function(preRegId) {
            try {
                // Find the preRegistration
                const preReg = preRegistrations.find(p => p.id === preRegId);
                if (!preReg) {
                    showAlert('Kayƒ±t bulunamadƒ±!', 'danger');
                    return;
                }

                if (!preReg.phone) {
                    showAlert('Telefon numarasƒ± bulunamadƒ±!', 'danger');
                    return;
                }

                // Check if template is enabled
                if (!messageTemplates.pendingRegistration || !messageTemplates.pendingRegistration.enabled) {
                    showAlert('Bekleyen kayƒ±t hatƒ±rlatma ≈üablonu etkinle≈ütirilmemi≈ü! L√ºtfen ayarlardan etkinle≈ütirin.', 'warning');
                    return;
                }

                // ‚úÖ Determine if child or adult - daha doƒüru kontrol
                const isChild = !!(preReg.parentName && preReg.studentName && preReg.parentName !== preReg.studentName);
                
                // Get template text based on type
                let message = '';
                if (isChild) {
                    message = messageTemplates.pendingRegistration.textChild || messageTemplates.pendingRegistration.text || '';
                } else {
                    message = messageTemplates.pendingRegistration.textAdult || messageTemplates.pendingRegistration.text || '';
                }
                
                if (!message || message.trim() === '') {
                    showAlert('Mesaj ≈üablonu bo≈ü! L√ºtfen ayarlardan d√ºzenleyin.', 'warning');
                    return;
                }

                // ‚úÖ Replace template variables - yeti≈ükin i√ßin studentName kullan
                const parentName = preReg.parentName || 'Deƒüerli Velimiz';
                const studentName = preReg.studentName || '';
                const uyeName = isChild ? parentName : studentName; // Yeti≈ükin i√ßin studentName
                
                // ‚úÖ Kul√ºp adƒ±nƒ± link'e ekle (URL-friendly slug)
                const clubName = clubInfo?.name || clubSettings?.clubName || currentUser?.clubName || 'Kul√ºp';
                const clubSlug = createSlug(clubName);
                const registrationLink = window.location.origin + '/uyeyeni/kayit?club=' + clubSlug;
                
                message = message.replace(/{UYE_AD_SOYAD}/g, uyeName);
                message = message.replace(/{OGRENCI_AD_SOYAD}/g, studentName);
                message = message.replace(/{LINK}/g, registrationLink);
                message = message.replace(/{TARIH}/g, formatDate(new Date().toISOString()));
                // Backward compatibility
                message = message.replace(/{VELI_AD_SOYAD}/g, parentName);
                message = message.replace(/{AD_SOYAD}/g, uyeName);

                // Find connected device
                let device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
                if (!device) {
                    device = whatsappDevices.find(d => d.status === 'connected');
                }
                
                if (!device) {
                    showAlert('Baƒülƒ± WhatsApp cihazƒ± bulunamadƒ±!', 'danger');
                    return;
                }

                // Confirm before sending - doƒüru ismi g√∂ster
                const displayName = isChild ? `${parentName} (Veli - ${studentName})` : studentName;
                if (!confirm(`${displayName} i√ßin kayƒ±t hatƒ±rlatma mesajƒ± g√∂nderilsin mi?\n\nMesaj:\n${message}`)) {
                    return;
                }

                // Send message
                const result = await sendWhatsAppMessage(device.instanceName, preReg.phone, message, displayName);
                const success = result.success || result === true;

                if (success) {
                    showAlert('‚úÖ Kayƒ±t hatƒ±rlatma mesajƒ± ba≈üarƒ±yla g√∂nderildi!', 'success');
                } else {
                    showAlert('‚ùå Mesaj g√∂nderilemedi!', 'danger');
                }
            } catch (error) {
                console.error('Error sending registration reminder:', error);
                showAlert('Hata: ' + error.message, 'danger');
            }
        };

        window.sendPaymentReminderMessage = async function(preRegId, paymentNumber, reminderType) {
            try {
                // Find the preRegistration
                const preReg = preRegistrations.find(p => p.id === preRegId);
                if (!preReg) {
                    showAlert('√ñdeme planƒ± bulunamadƒ±!', 'danger');
                    return;
                }

                // Find the specific payment
                const payment = preReg.paymentSchedule.find(p => p.paymentNumber === paymentNumber);
                if (!payment) {
                    showAlert('√ñdeme bulunamadƒ±!', 'danger');
                    return;
                }

                // Find the member
                const member = members.find(m => m.preRegistrationId === preRegId || m.Telefon === preReg.phone);
                if (!member || !member.Telefon) {
                    showAlert('√úye telefon numarasƒ± bulunamadƒ±!', 'danger');
                    return;
                }

                // Check if template is enabled
                const templateKey = reminderType === 'overdue' ? 'payment' : 'upcomingPayment';
                if (!messageTemplates[templateKey] || !messageTemplates[templateKey].enabled) {
                    showAlert(`${reminderType === 'overdue' ? 'Gecikmi≈ü' : 'Yakla≈üan'} √∂deme ≈üablonu etkinle≈ütirilmemi≈ü! L√ºtfen ayarlardan etkinle≈ütirin.`, 'warning');
                    return;
                }

                // Check if member is a child
                const isChild = !!member.Resit_Olmayan_Adi_Soyadi;
                
                console.log('=== √ñDEME HATƒ∞RLATMA DEBUG ===');
                console.log('Member:', member);
                console.log('isChild:', isChild);
                console.log('Resit_Olmayan_Adi_Soyadi:', member.Resit_Olmayan_Adi_Soyadi);
                console.log('Ad_Soyad:', member.Ad_Soyad);
                console.log('Template Key:', templateKey);
                console.log('Available templates:', messageTemplates[templateKey]);
                
                // Get template text based on member type
                let message = '';
                if (isChild) {
                    message = messageTemplates[templateKey].textChild || messageTemplates[templateKey].text || '';
                    console.log('Using CHILD template');
                } else {
                    message = messageTemplates[templateKey].textAdult || messageTemplates[templateKey].text || '';
                    console.log('Using ADULT template');
                }
                
                console.log('Message template:', message.substring(0, 100));
                
                if (!message || message.trim() === '') {
                    showAlert('Mesaj ≈üablonu bo≈ü! L√ºtfen ayarlardan d√ºzenleyin.', 'warning');
                    return;
                }

                // Calculate days until/since due date
                const today = new Date();
                today.setHours(0,0,0,0);
                const dueDate = new Date(payment.dueDate + 'T00:00:00');
                const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

                // Replace template variables
                const studentName = member.Resit_Olmayan_Adi_Soyadi || '';
                const parentName = member.Ad_Soyad || 'Deƒüerli √úyemiz';
                const uyeName = isChild ? parentName : parentName; // Yeti≈ükinde kendisi, √ßocukta veli
                const memberName = isChild ? studentName : parentName; // G√∂r√ºnen isim
                
                message = message.replace(/{UYE_AD_SOYAD}/g, uyeName);
                message = message.replace(/{OGRENCI_AD_SOYAD}/g, studentName);
                // Backward compatibility
                message = message.replace(/{VELI_AD_SOYAD}/g, parentName);
                message = message.replace(/{AD_SOYAD}/g, uyeName).replace(/{AD}/g, uyeName);
                
                message = message.replace(/{TUTAR}/g, payment.amount.toLocaleString('tr-TR'));
                message = message.replace(/{TARIH}/g, formatDate(payment.dueDate));
                message = message.replace(/{VADE_TARIHI}/g, formatDate(payment.dueDate));
                message = message.replace(/{GUN_KALDI}/g, Math.abs(daysDiff).toString());
                message = message.replace(/{DONEM_BASLANGIC}/g, formatDate(payment.period.start));
                message = message.replace(/{DONEM_BITIS}/g, formatDate(payment.period.end));
                message = message.replace(/{DERS_SAYISI}/g, payment.period.lessonCount.toString());

                // Find connected device
                let device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
                if (!device) {
                    device = whatsappDevices.find(d => d.status === 'connected');
                }
                
                if (!device) {
                    showAlert('Baƒülƒ± WhatsApp cihazƒ± bulunamadƒ±!', 'danger');
                    return;
                }

                // Confirm before sending
                if (!confirm(`${memberName} i√ßin ${reminderType === 'overdue' ? 'gecikmi≈ü' : 'yakla≈üan'} √∂deme hatƒ±rlatma mesajƒ± g√∂nderilsin mi?\n\nMesaj:\n${message}`)) {
                    return;
                }

                // Send message
                const result = await sendWhatsAppMessage(device.instanceName, member.Telefon, message, memberName);
                const success = result.success || result === true;
                
                if (success) {
                    showAlert('Mesaj ba≈üarƒ±yla g√∂nderildi! ‚úÖ', 'success');
                } else {
                    const errorMsg = result.errorReason ? ` Neden: ${result.errorReason}` : '';
                    showAlert(`Mesaj g√∂nderilemedi.${errorMsg}`, 'danger');
                }
            } catch (error) {
                console.error('Error sending payment reminder:', error);
                showAlert('Mesaj g√∂nderilirken hata olu≈ütu: ' + error.message, 'danger');
            }
        };

        // ‚úÖ Gecikmi≈ü √∂demelere toplu mesaj g√∂nderme
        window.sendBulkOverdueReminders = async function() {
            try {
                // Check if template is enabled
                if (!messageTemplates.payment || !messageTemplates.payment.enabled) {
                    showAlert('Gecikmi≈ü √∂deme ≈üablonu etkinle≈ütirilmemi≈ü! L√ºtfen ayarlardan etkinle≈ütirin.', 'warning');
                    return;
                }

                // Find connected device
                let device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
                if (!device) {
                    device = whatsappDevices.find(d => d.status === 'connected');
                }
                
                if (!device) {
                    showAlert('Baƒülƒ± WhatsApp cihazƒ± bulunamadƒ±!', 'danger');
                    return;
                }

                // Find all members with overdue payments
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const overdueList = [];
                
                for (const member of members) {
                    const preReg = preRegistrations.find(p => p.id === member.preRegistrationId || p.phone === member.Telefon);
                    if (!preReg || !preReg.paymentSchedule || !member.Telefon) continue;
                    
                    const overduePayments = preReg.paymentSchedule.filter(p => {
                        const dueDate = new Date(p.dueDate + 'T00:00:00');
                        return p.status === 'unpaid' && dueDate < today;
                    });
                    
                    if (overduePayments.length > 0) {
                        overdueList.push({
                            member,
                            preReg,
                            payments: overduePayments,
                            oldestPayment: overduePayments[0] // En eski gecikmi≈ü √∂deme
                        });
                    }
                }
                
                if (overdueList.length === 0) {
                    showAlert('Gecikmi≈ü √∂demesi olan √ºye bulunamadƒ±.', 'info');
                    return;
                }
                
                // Calculate total overdue amount
                const totalOverdueAmount = overdueList.reduce((sum, item) => {
                    return sum + item.payments.reduce((paymentSum, p) => paymentSum + p.amount, 0);
                }, 0);
                
                // Confirm before sending
                const confirmMsg = `${overdueList.length} √ºyeye gecikmi≈ü √∂deme hatƒ±rlatmasƒ± g√∂nderilecek.\n\nToplam gecikmi≈ü tutar: ${totalOverdueAmount.toLocaleString('tr-TR')}‚Ç∫\n\nDevam etmek istiyor musunuz?`;
                if (!confirm(confirmMsg)) {
                    return;
                }
                
                // Show progress
                showAlert(`${overdueList.length} √ºyeye mesaj g√∂nderiliyor...`, 'info');
                
                let successCount = 0;
                let failCount = 0;
                
                // ‚úÖ Helper function - Random bekleme s√ºresi hesaplama
                const getRandomWaitTime = (messageCount) => {
                    const shouldLongWait = (messageCount % clubSettings.longWaitTrigger) === 0 && messageCount > 0;
                    
                    if (shouldLongWait) {
                        // Uzun bekleme
                        const min = clubSettings.minLongWait * 1000;
                        const max = clubSettings.maxLongWait * 1000;
                        return Math.floor(Math.random() * (max - min + 1)) + min;
                    } else {
                        // Normal bekleme
                        const min = clubSettings.minWaitTime * 1000;
                        const max = clubSettings.maxWaitTime * 1000;
                        return Math.floor(Math.random() * (max - min + 1)) + min;
                    }
                };
                
                // Send messages
                let messageCount = 0;
                for (const item of overdueList) {
                    try {
                        const { member, preReg, oldestPayment } = item;
                        const isChild = !!member.Resit_Olmayan_Adi_Soyadi;
                        
                        // Get template text based on member type
                        let message = isChild 
                            ? (messageTemplates.payment.textChild || messageTemplates.payment.text || '')
                            : (messageTemplates.payment.textAdult || messageTemplates.payment.text || '');
                        
                        if (!message || message.trim() === '') {
                            failCount++;
                            continue;
                        }
                        
                        // Calculate days overdue
                        const dueDate = new Date(oldestPayment.dueDate + 'T00:00:00');
                        const daysDiff = Math.ceil((today - dueDate) / (1000 * 60 * 60 * 24));
                        
                        // Replace template variables
                        const studentName = member.Resit_Olmayan_Adi_Soyadi || '';
                        const parentName = member.Ad_Soyad || 'Deƒüerli √úyemiz';
                        const uyeName = isChild ? parentName : parentName;
                        const memberName = isChild ? studentName : parentName;
                        
                        message = message.replace(/{UYE_AD_SOYAD}/g, uyeName);
                        message = message.replace(/{OGRENCI_AD_SOYAD}/g, studentName);
                        message = message.replace(/{VELI_AD_SOYAD}/g, parentName);
                        message = message.replace(/{AD_SOYAD}/g, uyeName).replace(/{AD}/g, uyeName);
                        message = message.replace(/{TUTAR}/g, oldestPayment.amount.toLocaleString('tr-TR'));
                        message = message.replace(/{TARIH}/g, formatDate(oldestPayment.dueDate));
                        message = message.replace(/{VADE_TARIHI}/g, formatDate(oldestPayment.dueDate));
                        message = message.replace(/{GUN_KALDI}/g, daysDiff.toString());
                        message = message.replace(/{DONEM_BASLANGIC}/g, formatDate(oldestPayment.period.start));
                        message = message.replace(/{DONEM_BITIS}/g, formatDate(oldestPayment.period.end));
                        message = message.replace(/{DERS_SAYISI}/g, oldestPayment.period.lessonCount.toString());
                        
                        // Send message
                        const result = await sendWhatsAppMessage(device.instanceName, member.Telefon, message, memberName);
                        const success = result.success || result === true;
                        
                        if (success) {
                            successCount++;
                            messageCount++;
                        } else {
                            failCount++;
                        }
                        
                        // ‚úÖ Random bekleme s√ºresi (ayarlardan)
                        if (messageCount < overdueList.length) {
                            const waitTime = getRandomWaitTime(messageCount);
                            const waitSeconds = (waitTime / 1000).toFixed(1);
                            console.log(`‚è≥ ${waitSeconds} saniye bekleniyor... (${messageCount}/${overdueList.length})`);
                            await new Promise(resolve => setTimeout(resolve, waitTime));
                        }
                        
                    } catch (error) {
                        console.error('Error sending message to member:', item.member.id, error);
                        failCount++;
                    }
                }
                
                // Show results
                const resultMsg = `Toplu mesaj g√∂nderimi tamamlandƒ±!\n\n‚úÖ Ba≈üarƒ±lƒ±: ${successCount}\n‚ùå Ba≈üarƒ±sƒ±z: ${failCount}`;
                showAlert(resultMsg, successCount > 0 ? 'success' : 'warning');
                
            } catch (error) {
                console.error('Error in bulk overdue reminders:', error);
                showAlert('Toplu mesaj g√∂nderilirken hata olu≈ütu: ' + error.message, 'danger');
            }
        };

        async function handleProfileUpdate(e) {
            e.preventDefault();
            const form = e.target;
            const fullName = form.fullName.value;
            const phone = form.phone.value.replace(/\D/g, ''); // Remove non-digits
            const newPassword = form.newPassword.value;
            const confirmPassword = form.confirmPassword.value;

            if (newPassword && newPassword !== confirmPassword) {
                return showAlert('≈ûifreler e≈üle≈ümiyor.', 'warning');
            }
            
            const updateData = { 
                fullName,
                phone: phone,
                phoneNumber: phone, // For WhatsApp notifications
                username: phone || currentUser.username
            };
            
            if (newPassword) {
                updateData.password = newPassword;
            }

            try {
                const userDoc = users.find(u => u.username === currentUser.username);
                if (!userDoc) throw new Error("Current user document not found.");

                await window.firebase.updateDoc(window.firebase.doc(window.db, 'users', userDoc.id), updateData);
                
                // Update local current user object
                currentUser.fullName = fullName;
                currentUser.phone = phone;
                currentUser.phoneNumber = phone;
                if(newPassword) currentUser.password = newPassword;
                document.querySelector('.current-user-display').textContent = `Ho≈ügeldiniz, ${currentUser.fullName}`;

                showAlert('Profiliniz ba≈üarƒ±yla g√ºncellendi.', 'success');
                closeModal('profileModal');
                await loadData(); // Reload all users data
            } catch (error) {
                console.error("Profile update error:", error);
                showAlert('Profil g√ºncellenirken bir hata olu≈ütu.', 'danger');
            }
        }
        
        // --- RENDER FUNCTIONS ---
        function renderPreRegistrationTable() {
            const tbody = document.getElementById('preRegistrationTable');
            if (!tbody) return;
            
            // SADECE pending_contract durumundaki preRegistration kayƒ±tlarƒ±nƒ± g√∂ster
            const pendingPreRegs = preRegistrations.filter(p => p.status === 'pending_contract');
            
            if (pendingPreRegs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="empty-state"><h3>Beklemede olan kayƒ±t bulunmuyor.</h3></td></tr>`;
                return;
            }
            
            // ‚úÖ PERFORMANCE: Member'larƒ± preRegId ve phone'a g√∂re indexle (O(1) lookup)
            const normalizePhone = (phone) => phone ? phone.replace(/\D/g, '').replace(/^0/, '').replace(/^90/, '') : '';
            const memberByPreRegId = new Map();
            const memberByPhone = new Map();
            members.forEach(m => {
                if (m.preRegistrationId) memberByPreRegId.set(m.preRegistrationId, m);
                if (m.Telefon) memberByPhone.set(normalizePhone(m.Telefon), m);
            });
            
            // ‚úÖ PERFORMANCE: Groups'larƒ± member ID'sine g√∂re indexle (O(1) lookup)
            const groupsByMemberId = new Map();
            groups.forEach(g => {
                if (g.members && Array.isArray(g.members)) {
                    g.members.forEach(memberId => {
                        if (!groupsByMemberId.has(memberId)) groupsByMemberId.set(memberId, []);
                        groupsByMemberId.get(memberId).push(g);
                    });
                }
            });
            
            tbody.innerHTML = '';
            pendingPreRegs.forEach(preReg => {
                // ‚úÖ PERFORMANCE: O(1) member lookup
                const member = memberByPreRegId.get(preReg.id) || 
                               (preReg.phone ? memberByPhone.get(normalizePhone(preReg.phone)) : null);
                
                // ‚úÖ Sadece aktif veya pasif √ºyeleri atla, bekliyor durumundakileri g√∂ster
                if (member && member.status === 'active') {
                    return; // Aktif √ºyeleri atla
                }
                if (member && member.status === 'expired') {
                    return; // Pasif √ºyeleri atla
                }
                // member.status === 'pending' olanlar veya member olmayan √∂n kayƒ±tlar g√∂sterilecek
                
                // ‚úÖ PERFORMANCE: O(1) groups lookup
                const memberGroups = member && member.id ? (groupsByMemberId.get(member.id) || []) : [];
                
                const row = document.createElement('tr');
                const dropdownItems = [];
                
                if (member && member.id) {
                    dropdownItems.push(`<button onclick="event.stopPropagation(); window.assignToGroup('${member.id}')">üë• Grup Ata</button>`);
                    dropdownItems.push(`<button onclick="event.stopPropagation(); window.openMemberEditModal('${member.id}')">‚úèÔ∏è √úye D√ºzenle</button>`);
                }
                dropdownItems.push(`<button onclick="event.stopPropagation(); window.openPreRegEditModal('${preReg.id}')">‚úèÔ∏è √ñn Kayƒ±t D√ºzenle</button>`);
                dropdownItems.push(`<button onclick="event.stopPropagation(); window.viewPaymentPlan('${preReg.id}')">üí∞ √ñdeme Planƒ±</button>`);
                // Kayƒ±t hatƒ±rlatma butonu
                if (preReg.phone) {
                    dropdownItems.push(`<button style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="event.stopPropagation(); window.sendPendingRegistrationReminder('${preReg.id}')">üìß Kayƒ±t Hatƒ±rlat</button>`);
                }
                if (member && member.id) {
                    dropdownItems.push(`<button class="danger" onclick="event.stopPropagation(); window.deleteItem('members', '${member.id}')">üóëÔ∏è √úyeyi Sil</button>`);
                }
                dropdownItems.push(`<button class="danger" onclick="event.stopPropagation(); window.deleteItem('preRegistrations', '${preReg.id}')">üóëÔ∏è √ñn Kaydƒ± Sil</button>`);
                
                const displayName = preReg.studentName || preReg.parentName || 'ƒ∞simsiz';
                const parentName = preReg.studentName && preReg.parentName ? preReg.parentName : '-';
                const phone = preReg.phone || (member ? member.Telefon : '-');
                const branch = preReg.branch || (member ? member.Brans : '-');
                const statusValue = member ? member.status : 'pending';
                
                row.innerHTML = `
                    <td>${displayName}</td>
                    <td>${parentName}</td>
                    <td><a href="#" class="phone-link">${formatPhoneDisplay(phone)}</a></td>
                    <td>${branch === 'tenis' ? 'üéæ' : 'üèä'} ${capitalize(branch)}</td>
                    <td>
                        ${member ? `<select class="status-badge status-${statusValue} member-status-select" data-member-id="${member.id}">
                            <option value="pending" ${statusValue === 'pending' ? 'selected' : ''}>Bekliyor</option>
                            <option value="active" ${statusValue === 'active' ? 'selected' : ''}>Aktif</option>
                            <option value="expired" ${statusValue === 'expired' ? 'selected' : ''}>Pasif</option>
                        </select>` : `<span class="status-badge status-pending">√úye Olu≈üturulmamƒ±≈ü</span>`}
                    </td>
                    <td>${memberGroups.length > 0 ? memberGroups.map(g => g.groupName).join('<br>') : '‚ùå Atanmamƒ±≈ü'}</td>
                    <td class="actions-cell">
                        <div class="actions-dropdown">
                            <button class="actions-dropdown-btn" type="button">‚öôÔ∏è ƒ∞≈ülemler ‚ñº</button>
                            <div class="actions-dropdown-content">
                                ${dropdownItems.join('')}
                            </div>
                        </div>
                    </td>
                `;
                
                // Event listeners
                const phoneLink = row.querySelector('.phone-link');
                if (phoneLink && phone !== '-') {
                    phoneLink.addEventListener('click', (e) => handlePhoneClick(e, phone));
                }
                
                const statusSelect = row.querySelector('.member-status-select');
                if (statusSelect && member) {
                    statusSelect.addEventListener('change', function(e) {
                        e.stopPropagation();
                        const memberId = this.dataset.memberId || member.id;
                        const newStatus = this.value;
                        console.log('Durum deƒüi≈ütiriliyor:', memberId, newStatus);
                        updateMemberStatus(memberId, newStatus);
                    });
                }
                
                tbody.appendChild(row);
            });
        }

        function loadInactiveMembers() {
            renderInactiveMembersTable();
        }
        
        window.loadInactiveMembers = loadInactiveMembers;
        
        function renderInactiveMembersTable() {
            // Render Bekleyen √úyeler (pending)
            const pendingTbody = document.getElementById('pendingMembersTable');
            if (pendingTbody) {
                const pendingMembers = members.filter(m => m.status === 'pending');
                pendingTbody.innerHTML = pendingMembers.length === 0
                    ? `<tr><td colspan="6" class="empty-state"><h3>Bekleyen √ºye bulunmuyor.</h3></td></tr>`
                    : pendingMembers.map(member => {
                        const dropdownItems = [];
                        dropdownItems.push(`<button onclick="event.stopPropagation(); window.openMemberEditModal('${member.id}')">‚úèÔ∏è √úye D√ºzenle</button>`);
                        dropdownItems.push(`<button onclick="event.stopPropagation(); window.showMemberAttendancePage('${member.id}')">üìã Yoklama Kayƒ±tlarƒ±</button>`);
                        const preReg = preRegistrations.find(p => p.id === member.preRegistrationId || p.phone === member.Telefon);
                        if (preReg && preReg.id) {
                            dropdownItems.push(`<button onclick="event.stopPropagation(); window.viewPaymentPlan('${preReg.id}')">üí∞ √ñdeme Planƒ±</button>`);
                            // Kayƒ±t hatƒ±rlatma butonu
                            if (member.Telefon) {
                                dropdownItems.push(`<button style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="event.stopPropagation(); window.sendPendingRegistrationReminder('${preReg.id}')">üìß Kayƒ±t Hatƒ±rlat</button>`);
                            }
                        }
                        dropdownItems.push(`<button class="danger" onclick="event.stopPropagation(); window.deleteItem('members', '${member.id}')">üóëÔ∏è Sil</button>`);
                        
                        return `
                        <tr>
                            <td>${member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad}</td>
                            <td>${member.Ad_Soyad && member.Resit_Olmayan_Adi_Soyadi ? member.Ad_Soyad : '-'}</td>
                            <td><a href="#" class="phone-link" onclick="window.handlePhoneClick(event, '${member.Telefon}')">${member.Telefon}</a></td>
                            <td>${member.Brans === 'tenis' ? 'üéæ' : 'üèä'} ${capitalize(member.Brans)}</td>
                            <td>
                                <select class="status-badge status-pending" onchange="window.updateMemberStatus('${member.id}', this.value)">
                                    <option value="pending" selected>Bekliyor</option>
                                    <option value="active">Aktif</option>
                                    <option value="expired">Pasif</option>
                                </select>
                            </td>
                            <td class="actions-cell">
                                <div class="actions-dropdown">
                                    <button class="actions-dropdown-btn" type="button">‚öôÔ∏è ƒ∞≈ülemler ‚ñº</button>
                                    <div class="actions-dropdown-content">
                                        ${dropdownItems.join('')}
                                    </div>
                                </div>
                            </td>
                        </tr>`}).join('');
            }
            
            // Render Pasif √úyeler (expired)
            const inactiveTbody = document.getElementById('inactiveMembersTable');
            if (inactiveTbody) {
                const inactiveMembers = members.filter(m => m.status === 'expired');
                inactiveTbody.innerHTML = inactiveMembers.length === 0
                    ? `<tr><td colspan="6" class="empty-state"><h3>Pasif √ºye bulunmuyor.</h3></td></tr>`
                    : inactiveMembers.map(member => {
                        const dropdownItems = [];
                        dropdownItems.push(`<button onclick="event.stopPropagation(); window.openMemberEditModal('${member.id}')">‚úèÔ∏è √úye D√ºzenle</button>`);
                        dropdownItems.push(`<button onclick="event.stopPropagation(); window.showMemberAttendancePage('${member.id}')">üìã Yoklama Kayƒ±tlarƒ±</button>`);
                        const preReg = preRegistrations.find(p => p.id === member.preRegistrationId || p.phone === member.Telefon);
                        if (preReg && preReg.id) {
                            dropdownItems.push(`<button onclick="event.stopPropagation(); window.viewPaymentPlan('${preReg.id}')">üí∞ √ñdeme Planƒ±</button>`);
                        }
                        dropdownItems.push(`<button class="danger" onclick="event.stopPropagation(); window.deleteItem('members', '${member.id}')">üóëÔ∏è Sil</button>`);
                        
                        return `
                        <tr>
                            <td>${member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad}</td>
                            <td>${member.Ad_Soyad && member.Resit_Olmayan_Adi_Soyadi ? member.Ad_Soyad : '-'}</td>
                            <td><a href="#" class="phone-link" onclick="window.handlePhoneClick(event, '${member.Telefon}')">${member.Telefon}</a></td>
                            <td>${member.Brans === 'tenis' ? 'üéæ' : 'üèä'} ${capitalize(member.Brans)}</td>
                            <td>
                                <select class="status-badge status-expired" onchange="window.updateMemberStatus('${member.id}', this.value)">
                                    <option value="pending">Bekliyor</option>
                                    <option value="active">Aktif</option>
                                    <option value="expired" selected>Pasif</option>
                                </select>
                            </td>
                            <td class="actions-cell">
                                <div class="actions-dropdown">
                                    <button class="actions-dropdown-btn" type="button">‚öôÔ∏è ƒ∞≈ülemler ‚ñº</button>
                                    <div class="actions-dropdown-content">
                                        ${dropdownItems.join('')}
                                    </div>
                                </div>
                            </td>
                        </tr>`}).join('');
            }
        }
        
        // ‚úÖ √úye listesi otomatik yenileme ve bildirim
        let membersAutoRefreshInterval = null;
        let lastMemberCount = 0;
        
        function startMembersAutoRefresh() {
            if (membersAutoRefreshInterval) return;
            
            lastMemberCount = members.length;
            console.log('üîÑ √úye listesi otomatik yenileme ba≈ülatƒ±ldƒ±');
            
            membersAutoRefreshInterval = setInterval(async () => {
                if (currentSection !== 'members') return;
                
                const oldCount = members.length;
                await loadData(false); // Cache kullanma, fresh data al
                const newCount = members.length;
                
                if (newCount > oldCount) {
                    const diff = newCount - oldCount;
                    console.log(`üÜï ${diff} yeni √ºye eklendi!`);
                    
                    // Bildirim g√∂ster
                    showAlert(`üéâ ${diff} yeni √ºye eklendi!`, 'success');
                    
                    // Listeyi yenile
                    renderMembersTable();
                }
            }, 30000); // 30 saniyede bir
        }
        
        function stopMembersAutoRefresh() {
            if (membersAutoRefreshInterval) {
                clearInterval(membersAutoRefreshInterval);
                membersAutoRefreshInterval = null;
                console.log('‚èπÔ∏è √úye listesi otomatik yenileme durduruldu');
            }
        }
        
        function renderMembersTable() {
            const tbody = document.getElementById('membersTable');
            const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
            if (!tbody) return;

            // Combine members and pending preRegistrations
            // Create pseudo-members from pending preRegistrations
            const pendingPreRegs = preRegistrations.filter(p => {
                if (p.status !== 'pending_contract') return false;
                
                // Eƒüer bu preReg i√ßin zaten member varsa ekleme
                const existingMember = members.find(m => 
                    m.preRegistrationId === p.id || 
                    (m.Telefon && p.phone && m.Telefon.replace(/\D/g, '').replace(/^0/, '') === p.phone.replace(/\D/g, '').replace(/^0/, ''))
                );
                
                return !existingMember;
            }).map(p => ({
                id: 'prereg_' + p.id,
                preRegistrationId: p.id,
                Ad_Soyad: p.parentName || 'Belirtilmemi≈ü',
                Resit_Olmayan_Adi_Soyadi: p.studentName || '',
                Telefon: p.phone || '',
                Telefon_2: '',
                Brans: p.branch || '',
                status: 'pending',
                studentBirthDate: null,
                isPseudoMember: true // Flag to identify pseudo-members
            }));
            
            // Combine actual members with pseudo-members from preRegs
            const combinedMembers = [...members, ...pendingPreRegs];

            // 1. Filtering (Search) - Happens first on the entire dataset
            let filteredMembers = combinedMembers.filter(member => {
                const name = member.Ad_Soyad || '';
                const studentName = member.Resit_Olmayan_Adi_Soyadi || '';
                const phone = member.Telefon || '';
                return name.toLowerCase().includes(searchTerm) || 
                       studentName.toLowerCase().includes(searchTerm) ||
                       phone.includes(searchTerm);
            });

            // Separate passive members
            const passiveMembers = filteredMembers.filter(m => m.status === 'expired');
            let activeAndPendingMembers = filteredMembers.filter(m => m.status !== 'expired');

            // 2. Sorting (apply only to non-passive members)
            const ageHeader = document.querySelector('#membersTable thead th[onclick*="sortMembersByAge"]');
            if (ageHeader) {
                ageHeader.innerHTML = 'Ya≈ü'; // Reset header
                if (ageSortDirection === 'asc') {
                    ageHeader.innerHTML += ' ‚ñ≤';
                    activeAndPendingMembers.sort((a, b) => {
                        const ageA = a.studentBirthDate ? calculateAge(a.studentBirthDate) : Infinity;
                        const ageB = b.studentBirthDate ? calculateAge(b.studentBirthDate) : Infinity;
                        return ageA - ageB;
                    });
                } else if (ageSortDirection === 'desc') {
                    ageHeader.innerHTML += ' ‚ñº';
                    activeAndPendingMembers.sort((a, b) => {
                        const ageA = a.studentBirthDate ? calculateAge(a.studentBirthDate) : -Infinity;
                        const ageB = b.studentBirthDate ? calculateAge(b.studentBirthDate) : -Infinity;
                        return ageB - ageA;
                    });
                }
            }
            
            // Re-combine the lists with passive members at the end
            const sortedMembers = [...activeAndPendingMembers, ...passiveMembers];

            // 3. Pagination
            const totalPages = Math.ceil(sortedMembers.length / membersItemsPerPage);
            const startIndex = (membersCurrentPage - 1) * membersItemsPerPage;
            const endIndex = startIndex + membersItemsPerPage;
            const paginatedMembers = sortedMembers.slice(startIndex, endIndex);


            // Update pagination controls UI
            document.getElementById('pageInfo').textContent = `Sayfa ${membersCurrentPage} / ${totalPages > 0 ? totalPages : 1}`;
            document.getElementById('prevPageBtn').disabled = membersCurrentPage === 1;
            document.getElementById('nextPageBtn').disabled = membersCurrentPage >= totalPages;


            tbody.innerHTML = paginatedMembers.length === 0 
                ? `<tr><td colspan="8" class="empty-state"><h3>√úye bulunamadƒ±.</h3></td></tr>`
                : paginatedMembers.map(member => {
                    const memberGroups = groups.filter(g => g.members && g.members.includes(member.id));
                    
                    let nameCell, parentCell, ageCell;
                    let phoneHtml = `<div style="white-space: nowrap;"><a href="#" class="phone-link" onclick="handlePhoneClick(event, '${member.Telefon}')">${formatPhoneDisplay(member.Telefon)}</a></div>`;
                    if(member.Telefon_2) {
                        phoneHtml += `<div style="white-space: nowrap; margin-top: 4px;"><a href="#" class="phone-link" onclick="handlePhoneClick(event, '${member.Telefon_2}')">${formatPhoneDisplay(member.Telefon_2)}</a></div>`;
                    }


                    if (member.Resit_Olmayan_Adi_Soyadi && member.Resit_Olmayan_Adi_Soyadi.trim() !== '') { // It's a child
                        let veliHtml = capitalizeWords(member.Ad_Soyad);
                        if (member.Veli_2_Adi_Soyadi) {
                            veliHtml += `<br>${capitalizeWords(member.Veli_2_Adi_Soyadi)}`;
                        }
                        // Pseudo-member i√ßin tƒ±klanabilir link olmasƒ±n
                        if (member.isPseudoMember) {
                            nameCell = `<td><strong>${capitalizeWords(member.Resit_Olmayan_Adi_Soyadi)}</strong></td>`;
                        } else {
                            nameCell = `<td><a href="#" class="member-name-link" onclick="event.preventDefault(); showMemberAttendancePage('${member.id}')"><strong>${capitalizeWords(member.Resit_Olmayan_Adi_Soyadi)}</strong></a></td>`;
                        }
                        parentCell = `<td>${veliHtml}</td>`;
                        const birthDate = member.studentBirthDate;
                        const age = birthDate ? calculateAge(birthDate) : null; 
                        ageCell = `<td>${age !== null ? age : '√áocuk'}</td>`;
                    } else { // It's an adult
                        // Pseudo-member i√ßin tƒ±klanabilir link olmasƒ±n
                        if (member.isPseudoMember) {
                            nameCell = `<td><strong>${capitalizeWords(member.Ad_Soyad)}</strong></td>`;
                        } else {
                            nameCell = `<td><a href="#" class="member-name-link" onclick="event.preventDefault(); showMemberAttendancePage('${member.id}')"><strong>${capitalizeWords(member.Ad_Soyad)}</strong></a></td>`;
                        }
                        parentCell = `<td>-</td>`;
                        ageCell = `<td>Yeti≈ükin</td>`;
                    }
                    
                    // Pseudo-member (pending preRegistration) i√ßin farklƒ± UI
                    const statusCell = member.isPseudoMember 
                        ? `<td><span class="status-badge status-pending">‚è≥ Bekleyen Kayƒ±t</span></td>`
                        : `<td><select class="status-badge status-${member.status || 'pending'}" onchange="updateMemberStatus('${member.id}', this.value)">
                                <option value="pending" ${member.status === 'pending' ? 'selected' : ''}>Bekliyor</option>
                                <option value="active" ${member.status === 'active' ? 'selected' : ''}>Aktif</option>
                                <option value="expired" ${member.status === 'expired' ? 'selected' : ''}>Pasif</option>
                            </select></td>`;
                    
                    const actionsCell = member.isPseudoMember
                        ? `<td>
                            <div class="actions-dropdown">
                                <button class="actions-dropdown-btn" onclick="event.stopPropagation();">‚öôÔ∏è ƒ∞≈ülemler</button>
                                <div class="actions-dropdown-content">
                                    <button onclick="event.stopPropagation(); window.openPreRegEditModal('${member.preRegistrationId}'); setTimeout(() => { document.querySelector('.actions-dropdown-content').style.display = 'none'; }, 100);">‚úèÔ∏è √ñn Kayƒ±t D√ºzenle</button>
                                    <button onclick="event.stopPropagation(); window.deleteItem('preRegistration', '${member.preRegistrationId}'); setTimeout(() => { document.querySelector('.actions-dropdown-content').style.display = 'none'; }, 100);">üóëÔ∏è Sil</button>
                                </div>
                            </div>
                        </td>`
                        : `<td>
                            <div class="actions-container">
                                <button class="btn btn-secondary btn-sm actions-toggle"
                                    data-type="member"
                                    data-member-id="${member.id}"
                                    onclick="toggleActionsMenu(event)">‚Ä¢‚Ä¢‚Ä¢</button>
                            </div>
                        </td>`;
                    
                    return `
                        <tr>
                            ${nameCell}
                            ${parentCell}
                            <td>${phoneHtml}</td>
                             ${ageCell}
                            <td>${member.Brans === 'tenis' ? 'üéæ' : 'üèä'} ${capitalize(member.Brans)}</td>
                            ${statusCell}
                            <td>${memberGroups.length > 0 ? memberGroups.map(g => g.groupName).join('<br>') : '‚ùå Atanmamƒ±≈ü'}</td>
                            ${actionsCell}
                        </tr>`;
                }).join('');
        }

        function renderPaymentsList() {
            const container = document.getElementById('member-payment-list');
            const searchTerm = document.getElementById('paymentSearch').value.toLowerCase();
            if (!container) return;
            updatePaymentStats();
            
            // Sync check: Make sure member.preRegistrationId matches the correct preReg
            members.forEach(member => {
                if (member.Telefon) {
                    const normalizedPhone = member.Telefon.replace(/\D/g, '');
                    const preReg = preRegistrations.find(p => {
                        if (!p.phone) return false;
                        const pPhone = p.phone.replace(/\D/g, '');
                        return pPhone === normalizedPhone || 
                               pPhone === '90' + normalizedPhone ||
                               pPhone === normalizedPhone.replace(/^90/, '') ||
                               pPhone === normalizedPhone.replace(/^0/, '');
                    });
                    
                    // Update if mismatch
                    if (preReg && member.preRegistrationId !== preReg.id) {
                        console.warn('‚ö†Ô∏è PreReg ID mismatch for', member.Ad_Soyad, '- Updating...', {
                            old: member.preRegistrationId,
                            new: preReg.id
                        });
                        member.preRegistrationId = preReg.id;
                    }
                }
            });
            
            // SADECE aktif veya bekleyen √ºyeleri g√∂ster (silinen/expired hari√ß)
            let allMembers = members.filter(member => {
                // Silinen veya olmayan √ºyeleri g√∂sterme
                if (!member || !member.id) return false;
                const name = member.Ad_Soyad || '';
                const studentName = member.Resit_Olmayan_Adi_Soyadi || '';
                const phone = member.Telefon || '';
                return name.toLowerCase().includes(searchTerm) || 
                       studentName.toLowerCase().includes(searchTerm) ||
                       phone.includes(searchTerm);
            });


            let filteredMembers = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const memberHasRelevantPayment = (member, condition) => {
                const preReg = preRegistrations.find(p => p.id === member.preRegistrationId || p.phone === member.Telefon);
                return preReg && preReg.paymentSchedule && preReg.paymentSchedule.some(condition);
            };

            if (paymentFilter === 'overdue') {
                filteredMembers = allMembers.filter(m => memberHasRelevantPayment(m, p => p.status === 'unpaid' && new Date(p.dueDate + 'T00:00:00') < today));
            } else if (paymentFilter === 'finished') {
                filteredMembers = allMembers.filter(m => {
                    const preReg = preRegistrations.find(p => p.id === m.preRegistrationId || p.phone === m.Telefon);
                    return preReg && preReg.paymentSchedule && preReg.paymentSchedule.every(p => p.status === 'paid');
                });
            } else { // 'all'
                filteredMembers = allMembers;
            }

            const overdueStatsContainer = document.getElementById('overdue-stats-container');
            if (paymentFilter === 'overdue' && currentUser.isSuperAdmin) {
                let totalOverdueAmount = 0;
                
                filteredMembers.forEach(member => {
                    const preReg = preRegistrations.find(p => p.id === member.preRegistrationId || p.phone === member.Telefon);
                    if (preReg && preReg.paymentSchedule) {
                        preReg.paymentSchedule.forEach(p => {
                            if (p.status === 'unpaid' && new Date(p.dueDate + 'T00:00:00') < today) {
                                totalOverdueAmount += p.amount;
                            }
                        });
                    }
                });

                document.getElementById('overdue-total-amount').textContent = totalOverdueAmount.toLocaleString('tr-TR') + '‚Ç∫';
                document.getElementById('overdue-member-count').textContent = filteredMembers.length;
                overdueStatsContainer.style.display = 'grid';
            } else {
                overdueStatsContainer.style.display = 'none';
            }

            container.innerHTML = filteredMembers.length === 0 
                ? `<div class="empty-state"><h3>Filtreye uygun √ºye bulunamadƒ±.</h3></div>`
                : filteredMembers.map(member => {
                    const preReg = preRegistrations.find(p => p.id === member.preRegistrationId || p.phone === member.Telefon);
                    const group = groups.find(g => g.members && g.members.includes(member.id));
                    let statusHtml = '<span class="status-badge status-pending">Plan Yok</span>';
                    let subStatusHtml = '';

                    if (group) {
                        subStatusHtml += `<div class="sub-status group-name">${group.groupName}</div>`;
                    }
                    if (member.status === 'pending') {
                         subStatusHtml += `<div class="sub-status pending">Beklemede</div>`;
                    }
                     if (member.status === 'expired') {
                        subStatusHtml += `<div class="sub-status expired">Pasif</div>`;
                    }
                    

                    if (preReg && preReg.paymentSchedule) {
                        const overdueCount = preReg.paymentSchedule.filter(p => p.status === 'unpaid' && new Date(p.dueDate + 'T00:00:00') < today).length;
                        if (overdueCount > 0) {
                            statusHtml = `<span class="status-badge status-overdue">${overdueCount} Gecikmi≈ü</span>`;
                        } else {
                            const unpaidCount = preReg.paymentSchedule.filter(p => p.status === 'unpaid').length;
                            if (unpaidCount === 0) {
                                statusHtml = `<span class="status-badge status-completed">T√ºm√º √ñdendi</span>`;
                            } else {
                                statusHtml = ``;
                            }
                        }
                    }
                    return `
                        <div class="payment-member-item">
                            <div class="payment-member-header">
                                <div class="payment-member-info" onclick="togglePaymentDetails('${member.id}')">
                                    <strong>${member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad} ${member.Resit_Olmayan_Adi_Soyadi ? `(${member.Ad_Soyad})` : ''}</strong>
                                    <div style="font-size: 0.9em; color: #555;">üìû <a href="#" class="phone-link" onclick="handlePhoneClick(event, '${member.Telefon || ''}')">${member.Telefon || 'Numara Yok'}</a></div>
                                </div>
                                 <div class="status-container" onclick="togglePaymentDetails('${member.id}')">
                                     ${statusHtml}
                                     ${subStatusHtml}
                                </div>
                            </div>
                            <div class="payment-details" id="payment-details-${member.id}">
                                 ${preReg ? `
                                    <div class="payment-details-header">
                                        <h4>√ñdeme Planƒ±</h4>
                                        <div style="display: flex; gap: 8px;">
                                            ${currentUser.permissions.edit_payments ? `
                                                <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteSelectedPayments('${preReg.id}')">üóëÔ∏è Se√ßilenleri Sil</button>
                                                <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); openPaymentEditModal('${preReg.id}', null, true)">+ Yeni Taksit Ekle</button>
                                            ` : ''}
                                        </div>
                                    </div>
                                    ${renderPaymentDetailsTable(preReg)}
                                 ` : '<p class="empty-state">Bu √ºyeye ait √∂deme planƒ± bulunamadƒ±.</p>'}
                            </div>
                        </div>`;
                }).join('');
            
            // √ñdeme tutarlarƒ±nƒ± maskele (eƒüer gizli ise)
            setTimeout(() => applyPaymentVisibility(), 100);
        }
        
        // ‚úÖ Ders planƒ± i√ßin bran≈ü ve saha se√ßimi
        let selectedCourtForSchedule = null; // Yeni: Se√ßili saha
        
        window.selectBranchForSchedule = function(branchId) {
            selectedBranchForSchedule = branchId;
            selectedCourtForSchedule = null; // Bran≈ü deƒüi≈üince sahayƒ± sƒ±fƒ±rla
            renderScheduleGrid();
        };
        
        window.selectCourtForSchedule = function(courtName) {
            selectedCourtForSchedule = courtName;
            renderScheduleGrid();
        };
        
        function renderScheduleGrid() {
            const grid = document.getElementById('scheduleGrid');
            const unassignedContainer = document.getElementById('unassigned-groups-container');
            if(!grid || !unassignedContainer) return;
            
            // ‚úÖ ƒ∞lk a√ßƒ±lƒ±≈üta otomatik olarak ilk bran≈üƒ± se√ß
            if (!selectedBranchForSchedule && branches.length > 0) {
                selectedBranchForSchedule = branches[0].id;
            }
            
            // ‚úÖ Bran≈ü se√ßim butonlarƒ±nƒ± render et
            const branchButtonsContainer = document.getElementById('schedule-branch-buttons');
            if (branchButtonsContainer) {
                let buttonsHtml = branches.map(b => {
                    const isActive = selectedBranchForSchedule === b.id;
                    const btnStyle = isActive 
                        ? 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: 2px solid #667eea;'
                        : 'background: #f8f9fa; color: #333; border: 1px solid #ddd;';
                    return `<button class="btn btn-sm" 
                             style="${btnStyle} margin: 3px; padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer; transition: all 0.3s;"
                             onmouseover="if('${isActive}' === 'false') this.style.background='#e9ecef'"
                             onmouseout="if('${isActive}' === 'false') this.style.background='#f8f9fa'"
                             onclick="selectBranchForSchedule('${b.id}')">
                        ${b.icon} ${b.name}
                    </button>`;
                }).join('');
                
                // ‚úÖ Se√ßili bran≈üƒ±n sahalarƒ± varsa, saha butonlarƒ±nƒ± ekle
                if (selectedBranchForSchedule) {
                    const selectedBranch = branches.find(b => b.id === selectedBranchForSchedule);
                    if (selectedBranch && selectedBranch.courts && selectedBranch.courts.length > 0) {
                        // Otomatik ilk sahayƒ± se√ß
                        if (!selectedCourtForSchedule) {
                            selectedCourtForSchedule = selectedBranch.courts[0].name;
                        }
                        
                        buttonsHtml += '<div style="width: 100%; height: 1px; background: #ddd; margin: 10px 0;"></div>';
                        buttonsHtml += selectedBranch.courts.map(c => {
                            const isActive = selectedCourtForSchedule === c.name;
                            const btnStyle = isActive 
                                ? 'background: linear-gradient(135deg, #FF6B6B 0%, #EE5A6F 100%); color: white; border: 2px solid #FF6B6B;'
                                : 'background: #fff; color: #666; border: 1px solid #ccc;';
                            return `<button class="btn btn-sm" 
                                     style="${btnStyle} margin: 3px; padding: 6px 14px; border-radius: 15px; font-weight: 500; cursor: pointer; transition: all 0.3s; font-size: 0.9em;"
                                     onmouseover="if('${isActive}' === 'false') this.style.background='#f5f5f5'"
                                     onmouseout="if('${isActive}' === 'false') this.style.background='#fff'"
                                     onclick="selectCourtForSchedule('${c.name}')">
                                üìç ${c.name}
                            </button>`;
                        }).join('');
                    }
                }
                
                branchButtonsContainer.innerHTML = buttonsHtml;
            }

            // ‚úÖ Bran≈ü yoksa uyarƒ± g√∂ster
            if (branches.length === 0) {
                 grid.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;"><h3>Hen√ºz bran≈ü tanƒ±mlanmamƒ±≈ü. Ayarlar > Bran≈ülar'dan ekleyebilirsiniz.</h3></div>`;
                 unassignedContainer.innerHTML = '';
                 return;
            }
            
            if (!selectedBranchForSchedule) {
                 grid.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;"><h3>L√ºtfen bir bran≈ü se√ßin.</h3></div>`;
                 unassignedContainer.innerHTML = '';
                 return;
            }

            const filteredUnassignedGroups = groups.filter(g => g.branch === selectedBranchForSchedule);
            let filteredSchedules = schedules.filter(s => s.branch === selectedBranchForSchedule);
            
            // ‚úÖ Saha se√ßiliyse, sadece o sahaya ait dersleri g√∂ster
            if (selectedCourtForSchedule) {
                filteredSchedules = filteredSchedules.filter(s => s.court === selectedCourtForSchedule);
            }

            const allDays = ['pazartesi', 'salƒ±', '√ßar≈üamba', 'per≈üembe', 'cuma', 'cumartesi', 'pazar'];
            const weekdays = allDays.slice(0, 5);
            const weekends = allDays.slice(5, 7);

            const visibleWeekdays = weekdays.filter(day => !holidays.includes(day));
            const visibleWeekends = weekends.filter(day => !holidays.includes(day));
            
            // ‚úÖ Dinamik bran≈ü ikonu
            unassignedContainer.innerHTML = filteredUnassignedGroups.length > 0 
                ? filteredUnassignedGroups.map(g => {
                    const branchInfo = branches.find(b => b.id === g.branch);
                    const branchIcon = branchInfo ? branchInfo.icon : '‚öΩ';
                    return `<div class="unassigned-group" draggable="true" ondragstart="drag(event, '${g.id}', true)" onclick="openScheduleModalForGroup('${g.id}')">${branchIcon} ${g.groupName}</div>`;
                }).join('')
                : '<p class="empty-state" style="padding:0;font-size:0.9em;">Bu bran≈üta atanacak grup bulunmuyor.</p>';

            grid.innerHTML = ''; // Clear previous content

            const createLessonBlock = (schedule, group) => {
                const isTrial = group.groupName.toLowerCase().includes('deneme');
                const blockClass = `lesson-block ${isTrial ? 'trial-lesson' : ''}`;
                
                // ‚úÖ Bran≈üƒ±n sahalarƒ± var mƒ± kontrol et
                const branchInfo = branches.find(b => b.id === group.branch);
                const hasCourts = branchInfo && branchInfo.courts && branchInfo.courts.length > 0;
                
                // ‚úÖ Saha bilgisi: Sadece bran≈üƒ±n sahalarƒ± varsa g√∂ster
                let courtInfo = '';
                if (hasCourts) {
                    if (schedule.court) {
                        courtInfo = `<div style="font-size: 0.85em; color: #666; cursor: pointer;" onclick="event.stopPropagation(); editScheduleCourt('${schedule.id}')" title="Sahayƒ± deƒüi≈ütir">üìç ${schedule.court}</div>`;
                    } else {
                        courtInfo = `<div style="font-size: 0.75em; color: #999; cursor: pointer; font-style: italic;" onclick="event.stopPropagation(); editScheduleCourt('${schedule.id}')" title="Saha ekle">+ Saha ekle</div>`;
                    }
                }
                
                return `
                <div class="${blockClass}">
                    <button class="delete-lesson-btn" onclick="event.stopPropagation(); deleteSchedule(event, '${schedule.id}')" title="Dersi sil">&times;</button>
                    <button class="delete-lesson-btn" onclick="event.stopPropagation(); openScheduleModalForGroup('${group.id}')" title="Dersi d√ºzenle" style="right: 30px; background: #4CAF50;">‚úèÔ∏è</button>
                    <div onclick="openAttendanceModal('${group.id}')" style="cursor: pointer;">
                        <div><strong>${schedule.startTime} - ${schedule.endTime}</strong></div>
                        <div>${group.groupName}</div>
                        ${courtInfo}
                    </div>
                </div>`;
            }

            const createEmptySlotBlock = (start, end, day) => `
                <div class="lesson-block empty-slot" ondrop="drop(event, '${day}', '${start}')" ondragover="allowDrop(event)">
                    <div><strong>${start} - ${end}</strong></div>
                    <div>Bo≈ü</div>
                </div>`;

            const generateDayHtml = (day) => {
                // Only include schedules where the group still exists
                const daySchedules = filteredSchedules
                    .filter(s => s.day === day && groups.find(g => g.id === s.groupId))
                    .sort((a, b) => a.startTime.localeCompare(b.startTime));
                
                let allBlocksHtml = '';

                if (daySchedules.length > 0) {
                    // Add first lesson
                    const firstGroup = groups.find(g => g.id === daySchedules[0].groupId);
                    allBlocksHtml += createLessonBlock(daySchedules[0], firstGroup);

                    // Add gaps ONLY between consecutive lessons
                    for (let i = 1; i < daySchedules.length; i++) {
                        const prevSchedule = daySchedules[i - 1];
                        const currentSchedule = daySchedules[i];
                        const currentGroup = groups.find(g => g.id === currentSchedule.groupId);

                        // Calculate gap between lessons
                        const prevEndMinutes = timeToMinutes(prevSchedule.endTime);
                        const currentStartMinutes = timeToMinutes(currentSchedule.startTime);

                        // Add empty slot ONLY if there's a gap between two actual lessons
                        if (currentStartMinutes > prevEndMinutes) {
                            const gapStart = minutesToTime(prevEndMinutes);
                            const gapEnd = minutesToTime(currentStartMinutes);
                            allBlocksHtml += createEmptySlotBlock(gapStart, gapEnd, day);
                        }
                        
                        // Add current lesson
                        allBlocksHtml += createLessonBlock(currentSchedule, currentGroup);
                    }
                }

                return `<div class="schedule-day" ondrop="drop(event, '${day}')" ondragover="allowDrop(event)"><h4>${capitalize(day)}</h4>${allBlocksHtml}</div>`;
            };

            if (visibleWeekdays.length > 0) {
                const weekdayContainer = document.createElement('div');
                weekdayContainer.className = 'schedule-row weekday-row';
                weekdayContainer.innerHTML = visibleWeekdays.map(generateDayHtml).join('');
                grid.appendChild(weekdayContainer);
            }

            if (visibleWeekends.length > 0) {
                const weekendContainer = document.createElement('div');
                weekendContainer.className = 'schedule-row weekend-row';
                weekendContainer.innerHTML = visibleWeekends.map(generateDayHtml).join('');
                grid.appendChild(weekendContainer);
            }
        }

        // ‚úÖ Grup y√∂netimi i√ßin bran≈ü se√ßimi
        window.selectBranchForGroups = function(branchId) {
            selectedBranchForGroups = branchId;
            renderGroupsList();
            
            // Yeni grup butonunu g√∂ster/gizle
            const newGroupBtn = document.getElementById('newGroupBtn');
            if (newGroupBtn) {
                newGroupBtn.style.display = branchId ? 'inline-block' : 'none';
            }
        };

        function renderGroupsList() {
            const container = document.getElementById('groupsList');
            const searchTerm = document.getElementById('groupSearch')?.value.toLowerCase() || '';
            if (!container) return;
            
            // ‚úÖ ƒ∞lk a√ßƒ±lƒ±≈üta otomatik olarak ilk bran≈üƒ± se√ß
            if (!selectedBranchForGroups && branches.length > 0) {
                selectedBranchForGroups = branches[0].id;
                // Yeni grup butonunu g√∂ster
                const newGroupBtn = document.getElementById('newGroupBtn');
                if (newGroupBtn) newGroupBtn.style.display = 'inline-block';
            }
            
            // ‚úÖ Bran≈ü se√ßim butonlarƒ±nƒ± render et
            const branchButtonsContainer = document.getElementById('groups-branch-buttons');
            if (branchButtonsContainer) {
                branchButtonsContainer.innerHTML = branches.map(b => {
                    const isActive = selectedBranchForGroups === b.id;
                    const btnStyle = isActive 
                        ? 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: 2px solid #667eea;'
                        : 'background: #f8f9fa; color: #333; border: 1px solid #ddd;';
                    return `<button class="btn btn-sm" 
                             style="${btnStyle} margin: 3px; padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer; transition: all 0.3s;"
                             onmouseover="if('${isActive}' === 'false') this.style.background='#e9ecef'"
                             onmouseout="if('${isActive}' === 'false') this.style.background='#f8f9fa'"
                             onclick="selectBranchForGroups('${b.id}')">
                        ${b.icon} ${b.name}
                    </button>`;
                }).join('');
            }

            // ‚úÖ Bran≈ü yoksa uyarƒ± g√∂ster
            if (branches.length === 0) {
                container.innerHTML = `<div class="empty-state"><h3>Hen√ºz bran≈ü tanƒ±mlanmamƒ±≈ü. Ayarlar > Bran≈ülar'dan ekleyebilirsiniz.</h3></div>`;
                return;
            }

            if (!selectedBranchForGroups) {
                container.innerHTML = `<div class="empty-state"><h3>L√ºtfen bir bran≈ü se√ßin.</h3></div>`;
                return;
            }

            const filteredGroups = groups.filter(g => g.branch === selectedBranchForGroups && g.groupName.toLowerCase().includes(searchTerm));

            const childGroups = [];
            const adultGroups = [];
            const emptyGroups = [];

            filteredGroups.forEach(group => {
                const groupMembers = members.filter(m => (group.members || []).includes(m.id) && m.status !== 'expired');
                if (groupMembers.length === 0) {
                    emptyGroups.push(group);
                    return;
                }

                const isChildGroup = groupMembers.some(m => m.Resit_Olmayan_Adi_Soyadi && m.Resit_Olmayan_Adi_Soyadi.trim() !== '');
                if (isChildGroup) {
                    childGroups.push(group);
                } else {
                    adultGroups.push(group);
                }
            });

            let finalHtml = '';
            
            if (childGroups.length > 0) {
                finalHtml += `<h2 class="group-category-title">√áocuk Gruplarƒ±</h2>`;
                finalHtml += childGroups.map(renderGroupCard).join('');
            }
            if (adultGroups.length > 0) {
                finalHtml += `<h2 class="group-category-title">Yeti≈ükin Gruplarƒ±</h2>`;
                finalHtml += adultGroups.map(renderGroupCard).join('');
            }
            if (emptyGroups.length > 0) {
                finalHtml += `<h2 class="group-category-title">Bo≈ü Gruplar</h2>`;
                finalHtml += emptyGroups.map(renderGroupCard).join('');
            }

            if (finalHtml === '') {
                container.innerHTML = `<div class="empty-state"><h3>Grup bulunamadƒ±.</h3></div>`;
            } else {
                container.innerHTML = finalHtml;
            }
        }

        function renderGroupCard(group) {
             const isTrial = group.groupName.toLowerCase().includes('deneme');
             const cardClass = `group-card ${isTrial ? 'group-card-trial' : ''}`;
             const activeMembers = members.filter(m => (group.members || []).includes(m.id) && m.status !== 'expired');
             const memberCount = activeMembers.length;

            return `
                <div class="${cardClass}" onclick="openGroupEditModal('${group.id}')" style="cursor: pointer;">
                    <div>
                        <h4>${group.groupName}</h4>
                        <p><strong>Bran≈ü:</strong> ${group.branch === 'tenis' ? 'üéæ' : 'üèä'} ${capitalize(group.branch)}</p>
                        <p><strong>Eƒüitmen:</strong> üë®‚Äçüè´ ${group.instructor}</p>
                        <p><strong>√úye Sayƒ±sƒ±:</strong> üë• ${memberCount}/${group.maxMembers}</p>
                    </div>
                    <div class="group-members">${activeMembers.map(member => {
                        return `<span class="member-tag">${member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad}</span>`
                    }).join('') || '<span class="member-tag">Aktif √ºye yok</span>'}</div>
                    <div class="group-card-actions">
                        <button class="btn btn-warning btn-sm" onclick="event.stopPropagation(); assignToGroup(null, '${group.id}')">üë• √úye Ekle/√áƒ±kar</button>
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteItem('groups', '${group.id}')">üóëÔ∏è Sil</button>
                    </div>
                </div>`;
        }
        
        function renderSettings() {
            const holidayContainer = document.getElementById('holiday-settings');
            const allDays = ['pazartesi', 'salƒ±', '√ßar≈üamba', 'per≈üembe', 'cuma', 'cumartesi', 'pazar'];
            holidayContainer.innerHTML = allDays.map(day => `
                <label>
                    <input type="checkbox" name="holidays" value="${day}" ${holidays.includes(day) ? 'checked' : ''}>
                    ${capitalize(day)}
                </label>
            `).join('');

            const clubNameInput = document.querySelector('#settingsForm [name="clubName"]');
            if(clubNameInput) {
                clubNameInput.value = clubSettings.clubName;
            }
            
            // ‚úÖ Random bekleme s√ºresi ayarlarƒ±nƒ± formda g√∂ster
            const minWaitInput = document.getElementById('minWaitTime');
            const maxWaitInput = document.getElementById('maxWaitTime');
            const longWaitTriggerInput = document.getElementById('longWaitTrigger');
            const minLongWaitInput = document.getElementById('minLongWait');
            const maxLongWaitInput = document.getElementById('maxLongWait');
            
            if (minWaitInput) minWaitInput.value = clubSettings.minWaitTime || 20;
            if (maxWaitInput) maxWaitInput.value = clubSettings.maxWaitTime || 50;
            if (longWaitTriggerInput) longWaitTriggerInput.value = clubSettings.longWaitTrigger || 100;
            if (minLongWaitInput) minLongWaitInput.value = clubSettings.minLongWait || 400;
            if (maxLongWaitInput) maxLongWaitInput.value = clubSettings.maxLongWait || 800;
            
            renderUsersTable();
        }

        function renderUsersTable() {
            const tbody = document.getElementById('usersTable');
            if (!tbody) return;
            tbody.innerHTML = users.map(user => {
                const permissionLabels = {
                    // Finansal
                    'view_payments': '√ñdemeleri G√∂r√ºnt√ºleme',
                    'edit_payments': '√ñdemeleri D√ºzenleme',
                    'delete_payments': '√ñdemeleri Silme',
                    'export_payments': '√ñdemeleri Dƒ±≈üa Aktarma',
                    // √úye
                    'view_members': '√úyeleri G√∂r√ºnt√ºleme',
                    'add_members': '√úye Ekleme',
                    'edit_members': '√úye D√ºzenleme',
                    'delete_members': '√úye Silme',
                    'export_members': '√úyeleri Dƒ±≈üa Aktarma',
                    // CRM
                    'view_crm': 'CRM G√∂r√ºnt√ºleme',
                    'add_crm': 'CRM\'e Ekleme',
                    'edit_crm': 'CRM D√ºzenleme',
                    'delete_crm': 'CRM\'den Silme',
                    'view_calls': 'Aramalarƒ± G√∂r√ºnt√ºleme',
                    // ƒ∞leti≈üim
                    'send_messages': 'Mesaj G√∂nderme',
                    'send_bulk_messages': 'Toplu Mesaj',
                    'view_message_history': 'Mesaj Ge√ßmi≈üi',
                    // Raporlar
                    'view_stats': 'ƒ∞statistikler',
                    'view_reports': 'Raporlar',
                    'export_reports': 'Rapor Dƒ±≈üa Aktarma',
                    // Ayarlar
                    'manage_users': 'Kullanƒ±cƒ± Y√∂netimi',
                    'manage_settings': 'Ayarlar',
                    'manage_branches': 'Bran≈ü Y√∂netimi',
                    'manage_groups': 'Grup Y√∂netimi',
                    // Yoklama
                    'view_attendance': 'Yoklama G√∂r√ºnt√ºleme',
                    'edit_attendance': 'Yoklama D√ºzenleme',
                    'manage_schedule': 'Takvim Y√∂netimi'
                };
                
                const permissionsText = Object.entries(user.permissions || {})
                    .filter(([key, value]) => value)
                    .map(([key]) => permissionLabels[key] || key)
                    .join(', ') || 'Yok';
                
                const editButton = `<button class="btn btn-primary btn-sm" onclick="openUserEditModal('${user.id}')">‚úèÔ∏è D√ºzenle</button>`;
                const deleteButton = user.isSuperAdmin 
                    ? '' 
                    : `<button class="btn btn-danger btn-sm" onclick="deleteItem('users', '${user.id}')">üóëÔ∏è Sil</button>`;

                return `<tr>
                    <td>${user.fullName || 'N/A'}</td>
                    <td><a href="#" class="phone-link" onclick="handlePhoneClick(event, '${user.phone || ''}')">${user.phone || user.username}</a></td>
                    <td>${permissionsText}</td>
                    <td>
                        ${editButton}
                        ${deleteButton}
                    </td>
                </tr>`;
            }).join('');
        }

        function openUserEditModal(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            const modal = document.getElementById('userEditModal');
            const form = document.getElementById('userEditForm');
            
            form.elements['fullName'].value = user.fullName || '';
            form.elements['phone'].value = user.phone || '';
            form.elements['password'].value = user.password || '';
            
            // Set permissions checkboxes
            const permissionsCheckboxes = form.querySelectorAll('input[name="permissions"]');
            permissionsCheckboxes.forEach(checkbox => {
                checkbox.checked = user.permissions && user.permissions[checkbox.value];
            });
            
            form.dataset.userId = userId;
            modal.style.display = 'block';
        }

        async function handleUserUpdate(e) {
            e.preventDefault();
            const form = e.target;
            const userId = form.dataset.userId;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const selectedPermissions = formData.getAll('permissions');

            const userData = {
                fullName: data.fullName,
                phone: data.phone,
                phoneNumber: data.phone, // For WhatsApp notifications
                username: data.phone,
                password: data.password, 
                email: data.phone + '@kulup.local', // For task assignment
                permissions: {
                    // Finansal Yetkiler
                    view_payments: selectedPermissions.includes('view_payments'),
                    edit_payments: selectedPermissions.includes('edit_payments'),
                    delete_payments: selectedPermissions.includes('delete_payments'),
                    export_payments: selectedPermissions.includes('export_payments'),
                    
                    // √úye Yetkiler
                    view_members: selectedPermissions.includes('view_members'),
                    add_members: selectedPermissions.includes('add_members'),
                    edit_members: selectedPermissions.includes('edit_members'),
                    delete_members: selectedPermissions.includes('delete_members'),
                    export_members: selectedPermissions.includes('export_members'),
                    
                    // CRM Yetkileri
                    view_crm: selectedPermissions.includes('view_crm'),
                    add_crm: selectedPermissions.includes('add_crm'),
                    edit_crm: selectedPermissions.includes('edit_crm'),
                    delete_crm: selectedPermissions.includes('delete_crm'),
                    view_calls: selectedPermissions.includes('view_calls'),
                    
                    // ƒ∞leti≈üim Yetkileri
                    send_messages: selectedPermissions.includes('send_messages'),
                    send_bulk_messages: selectedPermissions.includes('send_bulk_messages'),
                    view_message_history: selectedPermissions.includes('view_message_history'),
                    
                    // Raporlar ve ƒ∞statistikler
                    view_stats: selectedPermissions.includes('view_stats'),
                    view_reports: selectedPermissions.includes('view_reports'),
                    export_reports: selectedPermissions.includes('export_reports'),
                    
                    // Ayarlar ve Y√∂netim
                    manage_users: selectedPermissions.includes('manage_users'),
                    manage_settings: selectedPermissions.includes('manage_settings'),
                    manage_branches: selectedPermissions.includes('manage_branches'),
                    manage_groups: selectedPermissions.includes('manage_groups'),
                    
                    // Yoklama ve Takvim
                    view_attendance: selectedPermissions.includes('view_attendance'),
                    edit_attendance: selectedPermissions.includes('edit_attendance'),
                    manage_schedule: selectedPermissions.includes('manage_schedule')
                }
            };

            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'users', userId), userData);
                showAlert('Y√∂netici ba≈üarƒ±yla g√ºncellendi.', 'success');
                closeModal('userEditModal');
                await loadData();
                renderUsersTable();
            } catch (error) {
                console.error('Error updating user:', error);
                showAlert('Y√∂netici g√ºncellenirken bir hata olu≈ütu.', 'danger');
            }
        }

        window.openUserEditModal = openUserEditModal;

        // ========== CRM FUNCTIONS ==========
        
        // √úyeleri CRM'e Aktar
        window.importMembersToCRM = async function() {
            if (!members || members.length === 0) {
                showAlert('‚ö†Ô∏è Aktif √ºye bulunamadƒ±!', 'warning');
                return;
            }
            
            const confirmMsg = `${members.length} √ºye CRM'e "Kayƒ±t Oldu" etiketi ile aktarƒ±lacak.\n\nDevam etmek istiyor musunuz?`;
            if (!confirm(confirmMsg)) return;
            
            // Loading g√∂ster
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'import-members-loading';
            loadingDiv.style = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 999999;';
            loadingDiv.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; text-align: center; min-width: 300px;">
                    <div class="spinner" style="margin-bottom: 15px;"></div>
                    <h3 style="margin: 0 0 10px 0;">√úyeler aktarƒ±lƒ±yor...</h3>
                    <p id="import-progress" style="margin: 0; color: #666;">0 / ${members.length}</p>
                </div>
            `;
            document.body.appendChild(loadingDiv);
            
            let successCount = 0;
            let skippedCount = 0;
            let errorCount = 0;
            const errors = [];
            
            const now = new Date();
            const dateStr = now.toLocaleString('tr-TR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            const userName = currentUser.fullName || currentUser.email || 'Admin';
            
            for (let i = 0; i < members.length; i++) {
                const member = members[i];
                
                // Progress g√ºncelle
                document.getElementById('import-progress').textContent = `${i + 1} / ${members.length}`;
                
                try {
                    // Telefon numarasƒ±nƒ± temizle
                    const memberPhone = cleanPhoneNumber(member.Telefon);
                    
                    if (!memberPhone || memberPhone.length < 10) {
                        console.log(`‚ö†Ô∏è ${member.Ad_Soyad}: Ge√ßersiz telefon numarasƒ±`);
                        skippedCount++;
                        continue;
                    }
                    
                    // CRM'de var mƒ± kontrol et
                    const existingLead = crmLeads.find(l => phonesMatch(l.phone, memberPhone));
                    if (existingLead) {
                        console.log(`‚è≠Ô∏è ${member.Ad_Soyad}: Zaten CRM'de kayƒ±tlƒ±`);
                        skippedCount++;
                        continue;
                    }
                    
                    // √úye bran≈üƒ±nƒ± bul (member.Brans bran≈ü ismi olarak kaydediliyor)
                    const memberBranchName = member.Brans || '';
                    const memberBranch = branches.find(b => b.name === memberBranchName || b.icon === memberBranchName);
                    if (!memberBranch) {
                        console.log(`‚ö†Ô∏è ${member.Ad_Soyad}: Bran≈ü bulunamadƒ± (${memberBranchName})`);
                        skippedCount++;
                        continue;
                    }
                    
                    // Bran≈ü verisi olu≈ütur
                    const branchData = {
                        branchId: memberBranch.id,
                        branchName: memberBranch.name,
                        ageGroup: 'adult', // √úyeler i√ßin varsayƒ±lan yeti≈ükin
                        fullName: member.Ad_Soyad || member.Resit_Olmayan_Adi_Soyadi || '√úye',
                        parentName: '',
                        children: [],
                        selectedTag: 'Kayƒ±t Oldu', // Kayƒ±t olmu≈ü etiket
                        notesHistory: [{
                            text: '√úye sisteminden otomatik aktarƒ±ldƒ±',
                            by: userName,
                            date: dateStr
                        }],
                        kayitOlabilirDate: null,
                        denemeDate: null
                    };
                    
                    // Lead verisi olu≈ütur
                    const leadData = {
                        fullName: member.Ad_Soyad || member.Resit_Olmayan_Adi_Soyadi || '√úye',
                        phone: memberPhone,
                        source: 'other', // √úyelerden geldiƒüi i√ßin 'other'
                        clubId: currentClubId,
                        createdAt: now.toISOString(),
                        createdBy: userName + ' (√úye Aktarƒ±mƒ±)',
                        updatedAt: now.toISOString(),
                        status: 'converted', // √úye oldu statusu
                        branches: [branchData],
                        history: [
                            {
                                action: 'created',
                                by: userName,
                                date: dateStr,
                                details: `√úye sisteminden otomatik aktarƒ±ldƒ± - ${branchData.fullName} (${memberPhone})`
                            },
                            {
                                action: 'tag_added',
                                by: userName,
                                date: dateStr,
                                details: `${memberBranch.name} - Etiket: "Kayƒ±t Oldu"`
                            },
                            {
                                action: 'status_changed',
                                by: userName,
                                date: dateStr,
                                details: 'Durum "Kayƒ±t Oldu" olarak i≈üaretlendi'
                            }
                        ]
                    };
                    
                    // Firebase'e ekle
                    await window.firebase.addDoc(
                        window.firebase.collection(window.db, 'crmLeads'),
                        leadData
                    );
                    
                    successCount++;
                    
                } catch (error) {
                    console.error(`‚ùå ${member.Ad_Soyad} aktarƒ±lƒ±rken hata:`, error);
                    errorCount++;
                    errors.push(`${member.Ad_Soyad}: ${error.message}`);
                }
                
                // Rate limiting
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            // Loading kaldƒ±r
            document.getElementById('import-members-loading').remove();
            
            // Sonu√ß mesajƒ±
            let resultMsg = `‚úÖ √úye aktarƒ±mƒ± tamamlandƒ±!\n\n`;
            resultMsg += `‚úì Ba≈üarƒ±lƒ±: ${successCount}\n`;
            resultMsg += `‚è≠Ô∏è Atlandƒ± (zaten kayƒ±tlƒ±): ${skippedCount}\n`;
            if (errorCount > 0) {
                resultMsg += `‚ùå Hata: ${errorCount}\n\n`;
                resultMsg += `Hatalar:\n${errors.slice(0, 5).join('\n')}`;
                if (errors.length > 5) {
                    resultMsg += `\n... ve ${errors.length - 5} hata daha`;
                }
            }
            
            showAlert(resultMsg, successCount > 0 ? 'success' : 'warning');
            
            // CRM verilerini yenile
            if (successCount > 0) {
                await loadData();
                renderCRMDashboard();
                renderCRMLeads();
            }
        };
        
        // CRM Dashboard ƒ∞statistikleri
        function renderCRMDashboard() {
            renderCRMStats();
            renderTodayTrials();
            renderUpcomingRegistrations();
            renderMissedCalls();
            renderBranchDistribution();
            renderTagDistribution();
            renderAccumulationAnalysis();
        }
        
        function renderBranchTagStats() {
            const statsContainer = document.getElementById('branch-tag-stats');
            if (!statsContainer) return;
            
            // ‚úÖ CRM etiketlerini dinamik olarak al (t√ºm etiketler dahil)
            const tagsList = crmTags
                .filter(tag => tag.isActive !== false) // Sadece aktif etiketler
                .sort((a, b) => (a.order || 999) - (b.order || 999)) // Sƒ±raya g√∂re
                .map(tag => tag.name); // Sadece isimleri al
            
            // Eƒüer hi√ß etiket yoksa, varsayƒ±lan liste kullan
            if (tagsList.length === 0) {
                tagsList.push('Aranmadƒ±', 'Mesaj Atƒ±lacak', 'Denemeye Gelecek', 'Kayƒ±t Olabilir', 'Kayƒ±t Oldu');
            }
            
            // Her bran≈ü i√ßin etiket sayƒ±larƒ±nƒ± hesapla
            const branchStats = {};
            branches.forEach(branch => {
                branchStats[branch.id] = {
                    name: branch.name,
                    icon: branch.icon,
                    ageGroups: {
                        child: {},
                        adult: {}
                    }
                };
                
                // Her etiket i√ßin saya√ßlarƒ± ba≈ülat
                tagsList.forEach(tag => {
                    branchStats[branch.id].ageGroups.child[tag] = 0;
                    branchStats[branch.id].ageGroups.adult[tag] = 0;
                });
            });
            
            // CRM leads √ºzerinden etiket sayƒ±larƒ±nƒ± hesapla
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        if (branchStats[br.branchId]) {
                            if (br.ageGroup === 'adult' && br.selectedTag) {
                                branchStats[br.branchId].ageGroups.adult[br.selectedTag] = 
                                    (branchStats[br.branchId].ageGroups.adult[br.selectedTag] || 0) + 1;
                            }
                            
                            if (br.ageGroup === 'child' && br.children) {
                                br.children.forEach(child => {
                                    if (child.selectedTag) {
                                        branchStats[br.branchId].ageGroups.child[child.selectedTag] = 
                                            (branchStats[br.branchId].ageGroups.child[child.selectedTag] || 0) + 1;
                                    }
                                });
                            }
                        }
                    });
                }
            });
            
            // Modern g√∂r√ºn√ºm ile render et
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';
            
            branches.forEach(branch => {
                const stats = branchStats[branch.id];
                
                html += `
                    <div style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 15px 0; font-size: 18px; color: #333;">${branch.icon} ${branch.name}</h4>
                        
                        <!-- √áocuk Grubu -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 12px;">
                            <div style="font-weight: 600; color: #667eea; margin-bottom: 10px; font-size: 14px;">üë∂ √áocuk</div>
                            <div style="display: flex; flex-direction: column; gap: 6px;">
                `;
                
                // Aranmadƒ± her zaman en √ºstte
                const childAranmadiCount = stats.ageGroups.child['Aranmadƒ±'] || 0;
                if (childAranmadiCount > 0) {
                    html += `
                        <div onclick="filterByBranchAndTag('${branch.id}', 'child', 'Aranmadƒ±')" style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: #fff3cd; border-radius: 6px; border-left: 3px solid #ffc107; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#ffe4a3'" onmouseout="this.style.background='#fff3cd'">
                            <span style="font-size: 13px; color: #555; font-weight: 600;">Aranmadƒ±</span>
                            <span style="font-weight: 700; color: #ff9800; font-size: 14px;">${childAranmadiCount}</span>
                        </div>
                    `;
                }
                
                // Diƒüer etiketler
                tagsList.forEach(tag => {
                    if (tag === 'Aranmadƒ±') return; // Aranmadƒ±'yƒ± atla, zaten √ºstte g√∂sterildi
                    const count = stats.ageGroups.child[tag] || 0;
                    if (count > 0) {
                        html += `
                            <div onclick="filterByBranchAndTag('${branch.id}', 'child', '${tag}')" style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: #f8f9fa; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                <span style="font-size: 13px; color: #555;">${tag}</span>
                                <span style="font-weight: 700; color: #667eea; font-size: 14px;">${count}</span>
                            </div>
                        `;
                    }
                });
                
                html += `
                            </div>
                        </div>
                        
                        <!-- Yeti≈ükin Grubu -->
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-weight: 600; color: #f093fb; margin-bottom: 10px; font-size: 14px;">üë® Yeti≈ükin</div>
                            <div style="display: flex; flex-direction: column; gap: 6px;">
                `;
                
                // Aranmadƒ± her zaman en √ºstte
                const adultAranmadiCount = stats.ageGroups.adult['Aranmadƒ±'] || 0;
                if (adultAranmadiCount > 0) {
                    html += `
                        <div onclick="filterByBranchAndTag('${branch.id}', 'adult', 'Aranmadƒ±')" style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: #fff3cd; border-radius: 6px; border-left: 3px solid #ffc107; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#ffe4a3'" onmouseout="this.style.background='#fff3cd'">
                            <span style="font-size: 13px; color: #555; font-weight: 600;">Aranmadƒ±</span>
                            <span style="font-weight: 700; color: #ff9800; font-size: 14px;">${adultAranmadiCount}</span>
                        </div>
                    `;
                }
                
                // Diƒüer etiketler
                tagsList.forEach(tag => {
                    if (tag === 'Aranmadƒ±') return; // Aranmadƒ±'yƒ± atla, zaten √ºstte g√∂sterildi
                    const count = stats.ageGroups.adult[tag] || 0;
                    if (count > 0) {
                        html += `
                            <div onclick="filterByBranchAndTag('${branch.id}', 'adult', '${tag}')" style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: #f8f9fa; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                <span style="font-size: 13px; color: #555;">${tag}</span>
                                <span style="font-weight: 700; color: #f093fb; font-size: 14px;">${count}</span>
                            </div>
                        `;
                    }
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            statsContainer.innerHTML = html;
            
            // CRM bran≈ü filtresi dropdown'unu g√ºncelle
            const crmBranchFilter = document.getElementById('crm-branch-filter');
            if (crmBranchFilter) {
                const currentValue = crmBranchFilter.value;
                crmBranchFilter.innerHTML = '<option value="all">T√ºm Bran≈ülar</option>' + 
                    branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
                if (currentValue) crmBranchFilter.value = currentValue;
            }
        }
        
        // Backward compatibility - renderCRMStats artƒ±k renderBranchTagStats'ƒ± √ßaƒüƒ±racak
        function renderCRMStats() {
            renderBranchTagStats();
            // ƒ∞statistik g√∂r√ºn√ºrl√ºƒü√ºn√º kontrol et
            checkBranchStatsVisibility();
        }
        
        // ƒ∞statistikleri gizle/g√∂ster fonksiyonu
        window.toggleBranchStats = function() {
            const statsContainer = document.getElementById('branch-tag-stats');
            const toggleBtn = document.getElementById('toggle-branch-stats-btn');
            if (!statsContainer || !toggleBtn) return;
            
            const isHidden = statsContainer.style.display === 'none';
            
            if (isHidden) {
                // G√∂ster
                statsContainer.style.display = 'grid';
                toggleBtn.innerHTML = 'üëÅÔ∏è';
                toggleBtn.title = 'ƒ∞statistikleri Gizle/G√∂ster';
                localStorage.setItem('branchStatsHidden', 'false');
            } else {
                // Gizle
                statsContainer.style.display = 'none';
                toggleBtn.innerHTML = 'üëÅÔ∏è‚Äçüó®Ô∏è';
                toggleBtn.title = 'ƒ∞statistikleri G√∂ster';
                localStorage.setItem('branchStatsHidden', 'true');
            }
        };
        
        // Sayfa y√ºklendiƒüinde istatistik g√∂r√ºn√ºrl√ºƒü√ºn√º kontrol et
        function checkBranchStatsVisibility() {
            const statsContainer = document.getElementById('branch-tag-stats');
            const toggleBtn = document.getElementById('toggle-branch-stats-btn');
            if (!statsContainer || !toggleBtn) return;
            
            const isHidden = localStorage.getItem('branchStatsHidden') === 'true';
            
            if (isHidden) {
                statsContainer.style.display = 'none';
                toggleBtn.innerHTML = 'üëÅÔ∏è‚Äçüó®Ô∏è';
                toggleBtn.title = 'ƒ∞statistikleri G√∂ster';
            } else {
                statsContainer.style.display = 'grid';
                toggleBtn.innerHTML = 'üëÅÔ∏è';
                toggleBtn.title = 'ƒ∞statistikleri Gizle/G√∂ster';
            }
        }
        
        // Dashboard istatistiklerini gizle/g√∂ster fonksiyonu
        window.toggleDashboardStats = function() {
            const statsContainer = document.getElementById('dashboard-stats-grid');
            const toggleBtn = document.getElementById('toggle-dashboard-stats-btn');
            if (!statsContainer || !toggleBtn) return;
            
            const isHidden = statsContainer.style.display === 'none';
            
            if (isHidden) {
                // G√∂ster
                statsContainer.style.display = 'grid';
                toggleBtn.innerHTML = 'üëÅÔ∏è';
                toggleBtn.title = 'ƒ∞statistikleri Gizle/G√∂ster';
                localStorage.setItem('dashboardStatsHidden', 'false');
            } else {
                // Gizle
                statsContainer.style.display = 'none';
                toggleBtn.innerHTML = 'üëÅÔ∏è‚Äçüó®Ô∏è';
                toggleBtn.title = 'ƒ∞statistikleri G√∂ster';
                localStorage.setItem('dashboardStatsHidden', 'true');
            }
        };
        
        // Sayfa y√ºklendiƒüinde dashboard istatistik g√∂r√ºn√ºrl√ºƒü√ºn√º kontrol et
        function checkDashboardStatsVisibility() {
            const statsContainer = document.getElementById('dashboard-stats-grid');
            const toggleBtn = document.getElementById('toggle-dashboard-stats-btn');
            if (!statsContainer || !toggleBtn) return;
            
            const isHidden = localStorage.getItem('dashboardStatsHidden') === 'true';
            
            if (isHidden) {
                statsContainer.style.display = 'none';
                toggleBtn.innerHTML = 'üëÅÔ∏è‚Äçüó®Ô∏è';
                toggleBtn.title = 'ƒ∞statistikleri G√∂ster';
            } else {
                statsContainer.style.display = 'grid';
                toggleBtn.innerHTML = 'üëÅÔ∏è';
                toggleBtn.title = 'ƒ∞statistikleri Gizle/G√∂ster';
            }
        }
        
        // Dashboard ana sayfa istatistiklerini gizle/g√∂ster fonksiyonu
        let dashboardAmountsHidden = false;
        
        window.toggleDashboardAmounts = function() {
            dashboardAmountsHidden = !dashboardAmountsHidden;
            const toggleBtn = document.getElementById('toggle-dashboard-amounts-btn');
            
            if (dashboardAmountsHidden) {
                // Gizle
                toggleBtn.innerHTML = 'üëÅÔ∏è‚Äçüó®Ô∏è';
                toggleBtn.title = 'Tutarlarƒ± G√∂ster';
                localStorage.setItem('dashboardAmountsHidden', 'true');
            } else {
                // G√∂ster
                toggleBtn.innerHTML = 'üëÅÔ∏è';
                toggleBtn.title = 'Tutarlarƒ± Gizle/G√∂ster';
                localStorage.setItem('dashboardAmountsHidden', 'false');
            }
            
            // Tutarlarƒ± g√ºncelle
            applyDashboardAmountsVisibility();
        };
        
        // Dashboard tutarlarƒ±na maskeleme uygula
        function applyDashboardAmountsVisibility() {
            const statNumbers = document.querySelectorAll('#dashboard .stat-number');
            statNumbers.forEach(el => {
                // Orijinal deƒüeri sakla
                if (el.dataset.originalValue === undefined) {
                    el.dataset.originalValue = el.textContent;
                }
                
                if (dashboardAmountsHidden) {
                    // Gizle - Sadece sayƒ±larƒ± i√ßeriyorsa maskele
                    if (el.dataset.originalValue.match(/\d/)) {
                        const currencyMatch = el.dataset.originalValue.match(/[‚Ç∫$‚Ç¨]/);
                        el.textContent = '****' + (currencyMatch ? currencyMatch[0] : '');
                    }
                } else {
                    // G√∂ster - Orijinal deƒüeri geri y√ºkle
                    el.textContent = el.dataset.originalValue;
                }
            });
        }
        
        // Sayfa y√ºklendiƒüinde dashboard tutar g√∂r√ºn√ºrl√ºƒü√ºn√º kontrol et
        function checkDashboardAmountsVisibility() {
            const toggleBtn = document.getElementById('toggle-dashboard-amounts-btn');
            if (!toggleBtn) return;
            
            const isHidden = localStorage.getItem('dashboardAmountsHidden') === 'true';
            dashboardAmountsHidden = isHidden;
            
            if (isHidden) {
                toggleBtn.innerHTML = 'üëÅÔ∏è‚Äçüó®Ô∏è';
                toggleBtn.title = 'Tutarlarƒ± G√∂ster';
                applyDashboardAmountsVisibility();
            } else {
                toggleBtn.innerHTML = 'üëÅÔ∏è';
                toggleBtn.title = 'Tutarlarƒ± Gizle/G√∂ster';
            }
        }
        
        // √ñdeme tutarlarƒ±nƒ± gizle/g√∂ster fonksiyonu
        let paymentAmountsHidden = false;
        
        window.togglePaymentVisibility = function() {
            paymentAmountsHidden = !paymentAmountsHidden;
            const toggleBtn = document.getElementById('toggle-payment-visibility-btn');
            
            if (paymentAmountsHidden) {
                // Gizle
                toggleBtn.innerHTML = 'üëÅÔ∏è‚Äçüó®Ô∏è';
                toggleBtn.title = 'Tutarlarƒ± G√∂ster';
                localStorage.setItem('paymentAmountsHidden', 'true');
            } else {
                // G√∂ster
                toggleBtn.innerHTML = 'üëÅÔ∏è';
                toggleBtn.title = 'Tutarlarƒ± Gizle/G√∂ster';
                localStorage.setItem('paymentAmountsHidden', 'false');
            }
            
            // Tutarlarƒ± g√ºncelle
            applyPaymentVisibility();
        };
        
        // √ñdeme tutarlarƒ±na maskeleme uygula
        function applyPaymentVisibility() {
            // ƒ∞statistik kartlarƒ±ndaki tutarlarƒ± maskele/g√∂ster
            const statNumbers = document.querySelectorAll('#payments .stat-number');
            statNumbers.forEach(el => {
                // Orijinal deƒüeri sakla
                if (el.dataset.originalValue === undefined) {
                    el.dataset.originalValue = el.textContent;
                }
                
                if (paymentAmountsHidden) {
                    // Gizle - Sadece sayƒ±larƒ± i√ßeriyorsa maskele
                    if (el.dataset.originalValue.match(/\d/)) {
                        const currencyMatch = el.dataset.originalValue.match(/[‚Ç∫$‚Ç¨]/);
                        el.textContent = '****' + (currencyMatch ? currencyMatch[0] : '');
                    }
                } else {
                    // G√∂ster - Orijinal deƒüeri geri y√ºkle
                    el.textContent = el.dataset.originalValue;
                }
            });
            
            // Tablodaki t√ºm tutarlarƒ± bul ve maskele/g√∂ster
            const paymentElements = document.querySelectorAll('#member-payment-list [style*="font-weight: bold"]');
            paymentElements.forEach(el => {
                const text = el.textContent.trim();
                // Sadece TL i√ßeren elementleri i≈üle
                if (text.includes('‚Ç∫') || text.includes('TL')) {
                    // Orijinal deƒüeri sakla
                    if (el.dataset.originalValue === undefined) {
                        el.dataset.originalValue = el.textContent;
                    }
                    
                    if (paymentAmountsHidden) {
                        // Gizle
                        if (el.dataset.originalValue.match(/\d/)) {
                            el.textContent = '****‚Ç∫';
                        }
                    } else {
                        // G√∂ster - Orijinal deƒüeri geri y√ºkle
                        el.textContent = el.dataset.originalValue;
                    }
                }
            });
        }
        
        // Sayfa y√ºklendiƒüinde √∂deme g√∂r√ºn√ºrl√ºƒü√ºn√º kontrol et
        function checkPaymentVisibility() {
            const toggleBtn = document.getElementById('toggle-payment-visibility-btn');
            if (!toggleBtn) return;
            
            const isHidden = localStorage.getItem('paymentAmountsHidden') === 'true';
            paymentAmountsHidden = isHidden;
            
            if (isHidden) {
                toggleBtn.innerHTML = 'üëÅÔ∏è‚Äçüó®Ô∏è';
                toggleBtn.title = 'Tutarlarƒ± G√∂ster';
            } else {
                toggleBtn.innerHTML = 'üëÅÔ∏è';
                toggleBtn.title = 'Tutarlarƒ± Gizle/G√∂ster';
            }
        }
        
        // Bran≈ü ve etikete g√∂re filtreleme yap
        window.filterByBranchAndTag = function(branchId, ageGroup, tag) {
            // CRM filtre sayfasƒ±na git
            showSection('crm-filter');
            
            // Filtre deƒüerlerini ayarla
            setTimeout(() => {
                const branchFilter = document.getElementById('filter-branch');
                const ageGroupFilter = document.getElementById('filter-age-group');
                const tagFilter = document.getElementById('filter-tag');
                
                if (branchFilter) branchFilter.value = branchId;
                if (ageGroupFilter) ageGroupFilter.value = ageGroup;
                if (tagFilter) tagFilter.value = tag;
                
                // Filtrelemeyi √ßalƒ±≈ütƒ±r
                applyCustomerFilters();
            }, 100);
        };
        
        // Panoya kopyala fonksiyonu
        window.copyToClipboard = function(text, message = 'Kopyalandƒ±!') {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showAlert(message, 'success');
                }).catch(err => {
                    console.error('Kopyalama hatasƒ±:', err);
                    fallbackCopyToClipboard(text, message);
                });
            } else {
                fallbackCopyToClipboard(text, message);
            }
        };
        
        // Eski tarayƒ±cƒ±lar i√ßin alternatif kopyalama
        function fallbackCopyToClipboard(text, message) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showAlert(message, 'success');
            } catch (err) {
                console.error('Kopyalama hatasƒ±:', err);
                showAlert('Kopyalama ba≈üarƒ±sƒ±z oldu', 'error');
            }
            document.body.removeChild(textArea);
        }
        
        function renderTodayTrials() {
            const container = document.getElementById('today-trials-list');
            if (!container) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            let todayTrials = [];
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        if (br.ageGroup === 'adult' && br.denemeDate) {
                            const trialDate = new Date(br.denemeDate);
                            if (trialDate >= today && trialDate < tomorrow) {
                                todayTrials.push({ lead, branch: br, type: 'adult', date: trialDate });
                            }
                        }
                        if (br.ageGroup === 'child' && br.children) {
                            br.children.forEach(c => {
                                if (c.denemeDate) {
                                    const trialDate = new Date(c.denemeDate);
                                    if (trialDate >= today && trialDate < tomorrow) {
                                        todayTrials.push({ lead, branch: br, child: c, type: 'child', date: trialDate });
                                    }
                                }
                            });
                        }
                    });
                }
            });
            
            todayTrials.sort((a, b) => a.date - b.date);
            
            if (todayTrials.length === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">Bug√ºn deneme dersi yok</p></div>';
                return;
            }
            
            container.innerHTML = todayTrials.map(trial => {
                const branch = branches.find(b => b.id === trial.branch.branchId);
                const timeStr = trial.date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                const name = trial.type === 'child' ? trial.child.name : trial.branch.fullName || trial.lead.fullName;
                const parentInfo = trial.type === 'child' ? `<div style="font-size: 11px; color: #888;">Veli: ${trial.branch.parentName || '-'}</div>` : '';
                
                // ‚úÖ Bran≈üa g√∂re renk paleti
                const branchColors = {
                    'tenis': { bg: 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)', border: '#4caf50', text: '#2e7d32', icon: 'üéæ' },
                    'yuzme': { bg: 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)', border: '#2196f3', text: '#1565c0', icon: 'üèä' },
                    'default': { bg: 'linear-gradient(135deg, #fff9e6 0%, #fff3cc 100%)', border: '#ffc107', text: '#ff9800', icon: 'üéØ' }
                };
                
                const branchStyle = branchColors[branch?.id] || branchColors['default'];
                
                return `
                    <div style="padding: 15px; margin-bottom: 10px; background: ${branchStyle.bg}; border-left: 4px solid ${branchStyle.border}; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onclick="openCustomerDetail('${trial.lead.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 14px; color: #333; margin-bottom: 4px;">${name}</div>
                                ${parentInfo}
                                <div style="font-size: 12px; color: #666;">üìû <a href="#" class="phone-link" onclick="event.stopPropagation(); handlePhoneClick(event, '${trial.lead.phone}')">${trial.lead.phone}</a></div>
                                <div style="font-size: 12px; color: ${branchStyle.text}; margin-top: 4px; font-weight: 600;">${branch ? branch.icon + ' ' + branch.name : 'Bran≈ü'}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 18px; font-weight: 700; color: ${branchStyle.text};">${timeStr}</div>
                                <div style="font-size: 11px; color: #888;">${branchStyle.icon} Deneme</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderUpcomingRegistrations() {
            const container = document.getElementById('upcoming-registrations-list');
            if (!container) return;
            
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);
            
            let upcomingRegs = [];
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        if (br.selectedTag === 'Kayƒ±t Olabilir' && br.kayitOlabilirDate) {
                            const regDate = new Date(br.kayitOlabilirDate);
                            if (regDate >= today && regDate <= nextWeek) {
                                upcomingRegs.push({ lead, branch: br, type: 'adult', date: regDate });
                            }
                        }
                        if (br.ageGroup === 'child' && br.children) {
                            br.children.forEach(c => {
                                if (c.selectedTag === 'Kayƒ±t Olabilir' && c.kayitOlabilirDate) {
                                    const regDate = new Date(c.kayitOlabilirDate);
                                    if (regDate >= today && regDate <= nextWeek) {
                                        upcomingRegs.push({ lead, branch: br, child: c, type: 'child', date: regDate });
                                    }
                                }
                            });
                        }
                    });
                }
            });
            
            upcomingRegs.sort((a, b) => a.date - b.date);
            
            if (upcomingRegs.length === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">Yakla≈üan kayƒ±t olabilir yok</p></div>';
                return;
            }
            
            container.innerHTML = upcomingRegs.map(reg => {
                const branch = branches.find(b => b.id === reg.branch.branchId);
                const dateStr = reg.date.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' });
                const name = reg.type === 'child' ? reg.child.name : reg.branch.fullName || reg.lead.fullName;
                const parentInfo = reg.type === 'child' ? `<div style="font-size: 11px; color: #888;">Veli: ${reg.branch.parentName || '-'}</div>` : '';
                
                // ‚úÖ Bran≈üa g√∂re renk paleti  
                const branchColors = {
                    'tenis': { bg: 'linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%)', border: '#9c27b0', text: '#6a1b9a', icon: 'üéæ' },
                    'yuzme': { bg: 'linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%)', border: '#00acc1', text: '#00838f', icon: 'üèä' },
                    'default': { bg: 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)', border: '#4caf50', text: '#2e7d32', icon: 'üìù' }
                };
                
                const branchStyle = branchColors[branch?.id] || branchColors['default'];
                
                return `
                    <div style="padding: 15px; margin-bottom: 10px; background: ${branchStyle.bg}; border-left: 4px solid ${branchStyle.border}; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onclick="openCustomerDetail('${reg.lead.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 14px; color: #333; margin-bottom: 4px;">${name}</div>
                                ${parentInfo}
                                <div style="font-size: 12px; color: #666;">üìû <a href="#" class="phone-link" onclick="event.stopPropagation(); handlePhoneClick(event, '${reg.lead.phone}')">${reg.lead.phone}</a></div>
                                <div style="font-size: 12px; color: ${branchStyle.text}; margin-top: 4px; font-weight: 600;">${branch ? branch.icon + ' ' + branch.name : 'Bran≈ü'}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 16px; font-weight: 700; color: ${branchStyle.text};">${dateStr}</div>
                                <div style="font-size: 11px; color: #888;">${branchStyle.icon} Kayƒ±t</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Cevapsƒ±z √ßaƒürƒ±larƒ± render et
        async function renderMissedCalls() {
            const container = document.getElementById('missed-calls-list');
            if (!container) return;
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Cevapsƒ±z √ßaƒürƒ±lar y√ºkleniyor...</span></div>';
            
            let missedCalls = await fetchBulutfonMissedCalls();
            
            // ‚úÖ Cevaplandƒ± olarak i≈üaretlenenleri filtrele
            const answeredCalls = JSON.parse(localStorage.getItem('answeredMissedCalls') || '[]');
            missedCalls = missedCalls.filter(call => {
                const caller = call.caller || '';
                // Telefon numarasƒ±nƒ± normalize et
                const cleanCaller = caller.replace(/\D/g, '');
                let formattedCaller = cleanCaller;
                if (cleanCaller.startsWith('90') && cleanCaller.length === 12) {
                    formattedCaller = '0' + cleanCaller.slice(2);
                } else if (!cleanCaller.startsWith('0') && cleanCaller.length === 10) {
                    formattedCaller = '0' + cleanCaller;
                }
                
                // Cevaplandƒ± listesinde yoksa g√∂ster
                return !answeredCalls.includes(formattedCaller);
            });
            
            // Silinenleri filtrele (showDeletedCalls false ise)
            if (!showDeletedCalls) {
                missedCalls = missedCalls.filter(call => !isCallDeleted(call.caller, 'incoming', call.call_time));
            }
            
            if (!missedCalls || missedCalls.length === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">Cevapsƒ±z √ßaƒürƒ± yok</p></div>';
                return;
            }
            
            container.innerHTML = missedCalls.map(call => {
                const caller = call.caller || 'Bilinmeyen';
                const formattedCaller = formatPhoneDisplay(caller);
                const callee = call.callee || 'Bilinmeyen';
                const formattedCallee = formatPhoneDisplay(callee);
                // Bulutfon API UTC formatƒ±nda veriyor, 3 saat √ßƒ±karmalƒ±yƒ±z
                const callTime = new Date(call.lastCall.call_time);
                callTime.setHours(callTime.getHours() - 3); // UTC'den T√ºrkiye saatine √ßevir
                const timeStr = callTime.toLocaleString('tr-TR', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit'
                });
                
                // D√∂n√º≈ü yapƒ±lmama s√ºresi
                const minutesSince = call.minutesSinceMissed || 0;
                let timeSinceStr = '';
                if (minutesSince < 60) {
                    timeSinceStr = `${minutesSince} dakika √∂nce`;
                } else if (minutesSince < 1440) {
                    timeSinceStr = `${Math.floor(minutesSince / 60)} saat ${minutesSince % 60} dakika √∂nce`;
                } else {
                    timeSinceStr = `${Math.floor(minutesSince / 1440)} g√ºn √∂nce`;
                }
                
                // Ka√ß kere aradƒ±
                const callCount = call.callCount || 1;
                const callCountStr = callCount > 1 ? `<div style="font-size: 12px; color: #d32f2f; font-weight: 600; margin-top: 4px;">üîÅ ${callCount} kere aradƒ±</div>` : '';
                
                // T√ºm arama tarihlerini listele (en fazla 5 tane)
                let allCallTimesStr = '';
                if (call.allCallTimes && call.allCallTimes.length > 1) {
                    const times = call.allCallTimes.slice(0, 5).map((t, idx) => {
                        const time = new Date(t);
                        time.setHours(time.getHours() - 3); // UTC'den T√ºrkiye saatine √ßevir
                        const today = new Date();
                        const isToday = time.getDate() === today.getDate() && 
                                       time.getMonth() === today.getMonth() && 
                                       time.getFullYear() === today.getFullYear();
                        
                        if (isToday) {
                            return `${idx + 1}. Bug√ºn ${time.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}`;
                        } else {
                            return `${idx + 1}. ${time.toLocaleDateString('tr-TR', { day: '2-digit', month: 'short' })} ${time.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}`;
                        }
                    });
                    allCallTimesStr = `<div style="font-size: 10px; color: #666; margin-top: 6px; background: rgba(0,0,0,0.05); padding: 6px; border-radius: 4px;">üìÖ ${times.join(' ‚Ä¢ ')}</div>`;
                }
                
                // CRM'de veya √ºyelerde var mƒ± kontrol et - G√ú√áLENDƒ∞Rƒ∞LMƒ∞≈û E≈ûLE≈ûTME
                const leadMatch = crmLeads.find(l => phonesMatch(l.phone, caller));
                const memberMatch = members.find(m => phonesMatch(m.Telefon, caller) || phonesMatch(m.Telefon_2, caller));
                
                let personInfo = '';
                let clickAction = '';
                let actionButtons = '';
                let backgroundColor = '#fff3e0'; // Default: cevapsƒ±z √ßaƒürƒ± rengi
                let borderColor = '#ff9800';
                
                // ƒ∞kili durum: Hem CRM'de hem cevapsƒ±z √ßaƒürƒ±
                const isInCRM = !!leadMatch;
                const isMissedCall = true; // Bu zaten cevapsƒ±z √ßaƒürƒ±lar sayfasƒ±
                
                // ƒ∞kili renk sistemi
                if (isInCRM && isMissedCall) {
                    // Gradient: yarƒ± CRM (mavi), yarƒ± cevapsƒ±z (turuncu)
                    backgroundColor = 'linear-gradient(90deg, #e3f2fd 0%, #e3f2fd 50%, #fff3e0 50%, #fff3e0 100%)';
                    borderColor = '#ff9800';
                }
                
                if (leadMatch) {
                    personInfo = `<div style="font-weight: 600; color: #1976d2; margin-bottom: 4px;">üë§ ${leadMatch.fullName} <span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">CRM'de</span> <span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">Cevapsƒ±z</span></div>`;
                    clickAction = `onclick="openCustomerDetail('${leadMatch.id}')"`;
                    actionButtons = `
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1);">
                            <div class="dropdown" style="display: inline-block; position: relative; z-index: 1000;">
                                <button class="btn btn-sm btn-primary dropdown-toggle" type="button" onclick="event.stopPropagation();" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="font-size: 11px; padding: 4px 8px;">
                                    ‚ö° ƒ∞≈ülemler
                            </button>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); openCustomerDetail('${leadMatch.id}');">üìã G√∂r√ºnt√ºle</a>
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); updateCRMFromMissedCall('${leadMatch.id}');">‚úèÔ∏è G√ºncelle</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); markAsUnreachableWithMessage('${caller}', '${timeStr}');">üö´ Ula≈üƒ±lamadƒ± + Mesaj</a>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (memberMatch) {
                    const memberName = memberMatch.Resit_Olmayan_Adi_Soyadi || memberMatch.Ad_Soyad;
                    personInfo = `<div style="font-weight: 600; color: #388e3c; margin-bottom: 4px;">‚úÖ √úye: ${memberName}</div>`;
                    clickAction = `onclick="showMemberAttendancePage('${memberMatch.id}')"`;
                    actionButtons = `
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1);">
                            <div class="dropdown" style="display: inline-block; position: relative; z-index: 1000;">
                                <button class="btn btn-sm btn-success dropdown-toggle" type="button" onclick="event.stopPropagation();" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="font-size: 11px; padding: 4px 8px;">
                                    ‚ö° ƒ∞≈ülemler
                            </button>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); showMemberAttendancePage('${memberMatch.id}');">üìã √úye Bilgileri</a>
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); sendMissedCallMessage('${memberMatch.Telefon || caller}', '${memberName}');">üí¨ Mesaj G√∂nder</a>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Sistemde yok - CRM'e ekle, Ula≈üƒ±lamadƒ± ve Manuel Cevaplandƒ± butonlarƒ±
                    actionButtons = `
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1);">
                            <div class="dropdown" style="display: inline-block; position: relative; z-index: 1000;">
                                <button class="btn btn-sm btn-primary dropdown-toggle" type="button" onclick="event.stopPropagation();" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="font-size: 11px; padding: 4px 8px;">
                                    ‚ö° ƒ∞≈ülemler
                            </button>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); addToCRMFromMissedCall('${caller}');">‚ûï CRM'e Ekle</a>
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); markMissedCallAsAnswered('${caller}', '${timeStr}');">‚úÖ Cevaplandƒ±</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); markAsUnreachableWithMessage('${caller}', '${timeStr}');">üö´ Ula≈üƒ±lamadƒ± + Mesaj</a>
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); sendMissedCallMessage('${caller}', '${timeStr}');">üí¨ Mesaj G√∂nder</a>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div style="position: relative; padding: 12px; margin-bottom: 10px; background: ${backgroundColor}; border-left: 4px solid ${borderColor}; border-radius: 6px; cursor: ${clickAction ? 'pointer' : 'default'};" ${clickAction} onmouseover="this.style.zIndex='100';" onmouseout="this.style.zIndex='1';">
                        ${personInfo}
                        <div style="font-size: 13px; color: #666;">üìû Arayan: ${formattedCaller}</div>
                        <div style="font-size: 12px; color: #888; margin-top: 2px;">üì± Aranan: ${formattedCallee}</div>
                        ${callCountStr}
                        <div style="font-size: 11px; color: #999; margin-top: 4px;">üïê Son arama: ${timeStr}</div>
                        ${allCallTimesStr}
                        <div style="font-size: 11px; color: #ff5722; margin-top: 4px; font-weight: 600;">‚è∞ D√∂n√º≈ü yapƒ±lmadƒ±: ${timeSinceStr}</div>
                        ${!personInfo ? '<div style="font-size: 11px; color: #d32f2f; margin-top: 4px;">‚ö†Ô∏è CRM\'de kayƒ±tlƒ± deƒüil</div>' : ''}
                        ${actionButtons}
                    </div>
                `;
            }).join('');
        }
        
        // Bulutfon'dan cevapsƒ±z √ßaƒürƒ±larƒ± √ßek
        async function fetchBulutfonMissedCalls() {
            if (!clubSettings || !clubSettings.bulutfonEnabled || !clubSettings.bulutfonApiKey) {
                console.log('‚ö†Ô∏è Bulutfon entegrasyonu aktif deƒüil');
                return [];
            }
            
            try {
                console.log('üìû Cevapsƒ±z √ßaƒürƒ±lar y√ºkleniyor...');
                
                const response = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${clubSettings.bulutfonApiKey}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    console.error('‚ùå Bulutfon API hatasƒ±:', response.status);
                    return [];
                }
                
                const data = await response.json();
                const allRecords = Array.isArray(data) ? data : (data.cdrs || data.data || []);
                
                if (allRecords.length === 0) {
                    return [];
                }
                
                // ‚úÖ Cevapsƒ±z √ßaƒürƒ±larƒ± filtrele (is_missing_call kullan - API dok√ºmantasyonuna g√∂re)
                let missedCalls = allRecords.filter(record => {
                    if (record.direction !== 'IN') return false;
                    
                    // API'den gelen is_missing_call parametresini kullan
                    // is_missing_call: true ‚Üí Ka√ßan/cevapsƒ±z √ßaƒürƒ±
                    // is_missing_call: false ‚Üí Cevaplanan √ßaƒürƒ±
                    if (record.is_missing_call !== undefined && record.is_missing_call !== null) {
                        // Boolean veya string olabilir ("true"/"false")
                        const isMissing = record.is_missing_call === true || record.is_missing_call === "true" || record.is_missing_call === 1;
                        return isMissing;
                    }
                    
                    // Fallback: is_missing_call yoksa hangup_cause kontrol et
                    // API dok√ºmantasyonuna g√∂re: ANSWERED = Cevaplandƒ±
                    const hangupCause = (record.hangup_cause || '').toUpperCase();
                    const isAnswered = hangupCause === 'ANSWERED';
                    
                    return !isAnswered; // Cevapsƒ±z olanlarƒ± al
                });
                
                // Son 72 saat i√ßindeki √ßaƒürƒ±larƒ± al
                const threeDaysAgo = new Date();
                threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
                missedCalls = missedCalls.filter(record => {
                    const callTime = new Date(record.call_time);
                    return callTime >= threeDaysAgo;
                });
                
                // Aynƒ± numaradan gelen t√ºm cevapsƒ±z √ßaƒürƒ±larƒ± grupla
                const callsByNumber = {};
                
                for (const missedCall of missedCalls) {
                    const caller = missedCall.caller?.replace(/\D/g, '');
                    if (!caller) continue;
                    
                    if (!callsByNumber[caller]) {
                        callsByNumber[caller] = [];
                    }
                    callsByNumber[caller].push(missedCall);
                }
                
                // Her numara i√ßin sonraki gelen veya giden aramayƒ± kontrol et
                const filteredMissedCalls = [];
                
                for (const [caller, calls] of Object.entries(callsByNumber)) {
                    // En son arama zamanƒ±nƒ± al (UTC olarak)
                    const lastCallTime = new Date(Math.max(...calls.map(c => new Date(c.call_time))));
                    
                    // Debug i√ßin √∂zel numara kontrol√º
                    const isDebugNumber = caller.includes('5321646303');
                    if (isDebugNumber) {
                        console.log(`üîç DEBUG - ${caller} i√ßin kontrol ba≈ülƒ±yor:`, {
                            missedCallsCount: calls.length,
                            lastCallTime: lastCallTime.toISOString()
                        });
                    }
                    
                    // Bu numaradan sonraki aramalar var mƒ± kontrol et (is_missing_call veya hangup_cause kullan)
                    const hasFollowUp = allRecords.some(record => {
                        const recordTime = new Date(record.call_time);
                        const recordCaller = (record.caller || '').replace(/\D/g, '');
                        const recordCallee = (record.callee || '').replace(/\D/g, '');
                        
                        // Aynƒ± numara ve en son cevapsƒ±z √ßaƒürƒ±dan sonra (UTC bazƒ±nda kar≈üƒ±la≈ütƒ±r)
                        if (recordTime > lastCallTime) {
                            const sameNumber = (recordCaller === caller) || (recordCallee === caller);
                            
                            // Cevaplanan arama mƒ± kontrol et
                            let wasAnswered = false;
                            
                            // 1. √ñnce is_missing_call kontrol et
                            if (record.is_missing_call !== undefined && record.is_missing_call !== null) {
                                const isMissing = record.is_missing_call === true || record.is_missing_call === "true" || record.is_missing_call === 1;
                                wasAnswered = !isMissing; // is_missing_call false ise cevaplandƒ± demektir
                            } 
                            // 2. is_missing_call yoksa hangup_cause kontrol et
                            else {
                                const hangupCause = (record.hangup_cause || '').toUpperCase();
                                wasAnswered = hangupCause === 'ANSWERED';
                            }
                            
                            // Debug log
                            if (isDebugNumber && sameNumber) {
                                console.log(`  ‚úì Sonraki arama bulundu: time=${recordTime.toISOString()}, direction=${record.direction}, is_missing_call=${record.is_missing_call}, wasAnswered=${wasAnswered}`);
                            }
                            
                            return sameNumber && wasAnswered;
                        }
                        return false;
                    });
                    
                    // Debug log
                    if (isDebugNumber) {
                        console.log(`  ‚Üí hasFollowUp: ${hasFollowUp} (true ise listeden √ßƒ±kar, false ise listede kalƒ±r)`);
                    }
                    
                    // Eƒüer sonrasƒ±nda cevaplanan bir arama yoksa listeye ekle
                    if (!hasFollowUp) {
                        // T√ºm aramalarƒ± tarihe g√∂re sƒ±rala
                        calls.sort((a, b) => new Date(b.call_time) - new Date(a.call_time));
                        
                        // ≈ûu ana kadar ge√ßen s√ºreyi hesapla (en son aramadan)
                        // Bulutfon UTC veriyor, 3 saat √ßƒ±karmalƒ±yƒ±z
                        const now = new Date();
                        const adjustedLastCallTime = new Date(lastCallTime);
                        adjustedLastCallTime.setHours(adjustedLastCallTime.getHours() - 3);
                        const timeDiff = Math.floor((now - adjustedLastCallTime) / 1000 / 60); // dakika
                        
                        // ƒ∞lk (en son) aramayƒ± al ve ek bilgiler ekle
                        const mainCall = calls[0];
                        mainCall.minutesSinceMissed = timeDiff;
                        mainCall.callCount = calls.length; // Ka√ß kere aradƒ±
                        mainCall.allCallTimes = calls.map(c => c.call_time); // T√ºm arama zamanlarƒ±
                        
                        filteredMissedCalls.push(mainCall);
                    }
                }
                
                // En yeniden eskiye sƒ±rala
                filteredMissedCalls.sort((a, b) => new Date(b.call_time) - new Date(a.call_time));
                
                console.log(`üìµ ${filteredMissedCalls.length} cevapsƒ±z √ßaƒürƒ± bulundu (is_missing_call ve hangup_cause kontrolleri yapƒ±ldƒ±)`);
                
                // Debug: T√ºm kayƒ±tlarƒ±n detaylƒ± kontrol√º
                if (allRecords.length > 0) {
                    const incomingCalls = allRecords.filter(r => r.direction === 'IN');
                    console.log(`üîç Toplam ${allRecords.length} kayƒ±t, ${incomingCalls.length} tanesi gelen arama (IN)`);
                    
                    const answeredCalls = incomingCalls.filter(r => 
                        (r.is_missing_call === false || r.is_missing_call === "false" || r.is_missing_call === 0) ||
                        (r.hangup_cause && r.hangup_cause.toUpperCase() === 'ANSWERED')
                    );
                    const missedCallsDebug = incomingCalls.filter(r => 
                        (r.is_missing_call === true || r.is_missing_call === "true" || r.is_missing_call === 1)
                    );
                    
                    console.log(`üìä Gelen aramalardan: ${answeredCalls.length} cevaplanan, ${missedCallsDebug.length} cevapsƒ±z`);
                    
                    // ƒ∞lk 5 gelen aramayƒ± detaylƒ± g√∂ster
                    console.log('üîç ƒ∞lk 5 gelen arama detayƒ±:');
                    incomingCalls.slice(0, 5).forEach((record, idx) => {
                        console.log(`  ${idx + 1}. is_missing_call: ${record.is_missing_call}, hangup_cause: ${record.hangup_cause}, caller: ${record.caller}, call_time: ${record.call_time}`);
                    });
                    
                    // Eƒüer cevaplanan arama varsa, ilkini g√∂ster
                    if (answeredCalls.length > 0) {
                        console.log('‚úÖ √ñrnek cevaplanan arama:', answeredCalls[0]);
                    }
                    
                    // DEBUG: Belirli numaralarƒ±n t√ºm aramalarƒ±nƒ± g√∂ster
                    const debugNumbers = ['905321646303', '5321646303']; // 0532 164 63 03
                    debugNumbers.forEach(debugNum => {
                        const debugCalls = allRecords.filter(r => {
                            const caller = (r.caller || '').replace(/\D/g, '');
                            const callee = (r.callee || '').replace(/\D/g, '');
                            return caller.includes(debugNum) || callee.includes(debugNum) || 
                                   caller === debugNum || callee === debugNum;
                        });
                        if (debugCalls.length > 0) {
                            console.log(`üîç Debug: ${debugNum} numaralƒ± t√ºm aramalar (${debugCalls.length} adet):`);
                            debugCalls.forEach((call, idx) => {
                                console.log(`  ${idx + 1}. direction: ${call.direction}, is_missing_call: ${call.is_missing_call}, hangup_cause: ${call.hangup_cause}, call_time: ${call.call_time}`);
                            });
                        }
                    });
                }
                
                return filteredMissedCalls.slice(0, 20); // En fazla 20 tane g√∂ster
                
            } catch (error) {
                console.error('‚ùå Cevapsƒ±z √ßaƒürƒ±lar alƒ±nƒ±rken hata:', error);
                return [];
            }
        }
        
        // Cevapsƒ±z √ßaƒürƒ±larƒ± yenile (dashboard i√ßin)
        window.refreshMissedCalls = async function() {
            await renderMissedCalls();
        };
        
        // CRM ana sayfa: Cevapsƒ±z √ßaƒürƒ±larƒ± minimal liste olarak g√∂ster (sadece telefon numarasƒ±)
        window.renderMissedCalls = async function() {
            const container = document.getElementById('missed-calls-list');
            if (!container) return;
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Cevapsƒ±z √ßaƒürƒ±lar y√ºkleniyor...</span></div>';

            const missedCalls = await fetchBulutfonMissedCalls();
            if (!missedCalls || missedCalls.length === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">üìµ Son 72 saatte cevapsƒ±z √ßaƒürƒ± yok</p></div>';
                return;
            }

            container.innerHTML = missedCalls.map(call => {
                const caller = call.caller || 'Bilinmeyen';
                // Sadece numara g√∂ster (formatlanmadan, daha temiz g√∂r√ºn√ºm i√ßin)
                const displayNumber = caller.replace(/\D/g, '');
                const formattedNumber = displayNumber.startsWith('90') && displayNumber.length === 12 
                    ? '0' + displayNumber.substring(2) 
                    : displayNumber;
                
                return `
                    <div style="padding: 10px 12px; margin-bottom: 8px; background: #fff8e1; border-left: 4px solid #ffa726; border-radius: 6px; cursor: pointer; font-family: monospace; font-size: 14px;" 
                         onclick="showIncomingCallsForNumber('${formattedNumber}')" 
                         title="Tƒ±klayarak bu numaranƒ±n t√ºm gelen aramalarƒ±nƒ± g√∂r√ºn">
                        üìû ${formattedNumber}
                        ${call.callCount > 1 ? `<span style="background: #ff6b6b; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-left: 8px;">${call.callCount}x</span>` : ''}
                    </div>
                `;
            }).join('');
        };
        
        // Belirli bir numaraya ait gelen aramalarƒ± g√∂ster
        window.showIncomingCallsForNumber = function(phoneNumber) {
            // Gelen aramalar sayfasƒ±na git
            showSection('crm-incoming-calls', document.querySelector('.nav-btn[onclick*=\'crm-incoming-calls\']'));
            
            // Kƒ±sa bir gecikme sonra filtreyi uygula
            setTimeout(() => {
                // Telefon filtre inputunu bul ve numara ile doldur
                const phoneFilterInput = document.getElementById('incomingPhoneFilter');
                if (phoneFilterInput) {
                    phoneFilterInput.value = phoneNumber;
                    // Filtreyi tetikle
                    filterIncomingCalls();
                }
            }, 300);
        };
        
        // Cevapsƒ±z √ßaƒürƒ±lar sayfasƒ±nƒ± yenile (artƒ±k gelen aramalara y√∂nlendiriyor)
        window.refreshMissedCallsPage = async function() {
            await renderIncomingCallsPage();
        };
        
        // CRM ana sayfa - cevapsƒ±z √ßaƒürƒ±larƒ± yenile
        window.refreshMissedCalls = async function() {
            await renderMissedCalls();
        };
        
        // Gelen aramalar sayfasƒ±nƒ± render et
        window.renderIncomingCallsPage = async function() {
            const container = document.getElementById('incoming-calls-list');
            if (!container) return;
            
            // Se√ßimleri temizle
            selectedIncomingCalls.clear();
            const selectAllCheckbox = document.getElementById('selectAllIncoming');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Gelen aramalar y√ºkleniyor...</span></div>';
            
            // Bulutfon kontrol√º - API Key'e g√∂re kontrol et
            if (!clubSettings || !clubSettings.bulutfonApiKey) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <h3 style="color: #856404; margin-bottom: 15px;">üìû Bulutfon Entegrasyonu Gerekli</h3>
                        <p style="color: #666; margin-bottom: 20px;">
                            Gelen aramalarƒ± g√∂r√ºnt√ºlemek i√ßin Bulutfon API entegrasyonunu aktif etmeniz gerekiyor.
                        </p>
                        <button class="btn btn-primary" onclick="showSection('settings', document.querySelector('.nav-btn[onclick*=\\'settings\\']')); setTimeout(() => switchSettingsTab('general'), 500);">
                            ‚öôÔ∏è Ayarlara Git
                        </button>
                    </div>
                `;
                return;
            }
            
            console.log('üìû Bulutfon API Key mevcut, aramalar y√ºkleniyor...');
            
            try {
                const response = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${clubSettings.bulutfonApiKey}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const allRecords = Array.isArray(data) ? data : (data.cdrs || data.data || []);
                
                // Gelen aramalarƒ± filtrele (direction: 'IN')
                let incomingCalls = allRecords.filter(record => record.direction === 'IN');
                
                // ‚úÖ WhatsApp gelen √ßaƒürƒ±larƒ±nƒ± da ekle (Index olmadan da √ßalƒ±≈üsƒ±n)
                try {
                    const whatsappCallsRef = window.firebase.collection(window.db, 'whatsappIncomingCalls');
                    
                    // √ñnce index'li sorguyu dene
                    let whatsappSnapshot;
                    try {
                        const whatsappQuery = window.firebase.query(
                            whatsappCallsRef,
                            window.firebase.where('clubId', '==', currentClubId),
                            window.firebase.orderBy('timestamp', 'desc'),
                            window.firebase.limit(100)
                        );
                        whatsappSnapshot = await window.firebase.getDocs(whatsappQuery);
                        console.log(`üì± ${whatsappSnapshot.docs.length} WhatsApp √ßaƒürƒ±sƒ± bulundu (index'li sorgu)`);
                    } catch (indexError) {
                        // Index yoksa sadece clubId ile filtrele
                        console.log('‚ö†Ô∏è WhatsApp index yok, basit sorgu deneniyor...');
                        const simpleQuery = window.firebase.query(
                            whatsappCallsRef,
                            window.firebase.where('clubId', '==', currentClubId)
                        );
                        whatsappSnapshot = await window.firebase.getDocs(simpleQuery);
                        console.log(`üì± ${whatsappSnapshot.docs.length} WhatsApp √ßaƒürƒ±sƒ± bulundu (basit sorgu)`);
                    }
                    
                    whatsappSnapshot.docs.forEach(doc => {
                        const whatsappCall = doc.data();
                        // Bulutfon formatƒ±na √ßevir
                        incomingCalls.push({
                            caller: whatsappCall.from || whatsappCall.caller,
                            callee: whatsappCall.to || whatsappCall.callee,
                            call_time: whatsappCall.timestamp || whatsappCall.call_time,
                            direction: 'IN',
                            is_missing_call: whatsappCall.is_missing_call !== false,
                            hangup_cause: whatsappCall.is_missing_call === false ? 'ANSWERED' : 'NO_ANSWER',
                            isWhatsApp: true, // ‚úÖ WhatsApp bayraƒüƒ±
                            instanceName: whatsappCall.instanceName || 'WhatsApp'
                        });
                    });
                } catch (whatsappError) {
                    console.error('‚ö†Ô∏è WhatsApp √ßaƒürƒ±larƒ± y√ºklenirken hata:', whatsappError);
                    console.error('Hata detayƒ±:', whatsappError.message);
                    // Hata olsa da devam et (Bulutfon aramalarƒ± g√∂sterilir)
                }
                
                // Son 1 hafta i√ßindeki √ßaƒürƒ±larƒ± al
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                incomingCalls = incomingCalls.filter(record => {
                    const callTime = new Date(record.call_time);
                    return callTime >= oneWeekAgo;
                });
                
                // ‚úÖ NOT: Silinen √ßaƒürƒ±larƒ± burada Fƒ∞LTRELEME - gruplama sonrasƒ± yapƒ±lacak
                // √á√ºnk√º aynƒ± numaranƒ±n birden fazla √ßaƒürƒ±sƒ± olabilir ve sadece en son √ßaƒürƒ± silinmi≈üse
                // diƒüer √ßaƒürƒ±larƒ± da g√∂rmemiz gerekiyor (gruplama i√ßin)
                
                // ‚úÖ ƒ∞lk aramada t√ºm alanlarƒ± g√∂relim
                if (incomingCalls.length > 0) {
                    console.log('üìã Bulutfon Call Sample:', incomingCalls[0]);
                }
                
                // ‚úÖ AKILLI GRUPLAMA: Aynƒ± numaralarƒ± birle≈ütir ve son duruma g√∂re kategorize et
                
                // 1. T√ºm giden aramalarƒ± da al (durum kontrol√º i√ßin)
                const outgoingCalls = allRecords.filter(record => record.direction === 'OUT');
                
                // 2. Numaraya g√∂re grupla
                const groupedByNumber = {};
                
                incomingCalls.forEach(call => {
                    const cleanNumber = call.caller?.replace(/\D/g, '') || 'unknown';
                    const last10Digits = cleanNumber.slice(-10);
                    
                    if (!groupedByNumber[last10Digits]) {
                        groupedByNumber[last10Digits] = {
                            number: call.caller,
                            incomingCalls: [],
                            outgoingCalls: []
                        };
                    }
                    
                    groupedByNumber[last10Digits].incomingCalls.push(call);
                });
                
                // 3. Her numara i√ßin giden aramalarƒ± da bul
                Object.keys(groupedByNumber).forEach(number => {
                    const group = groupedByNumber[number];
                    
                    group.outgoingCalls = outgoingCalls.filter(call => {
                        const cleanCallee = call.callee?.replace(/\D/g, '') || '';
                        return cleanCallee.endsWith(number) || number.endsWith(cleanCallee.slice(-10));
                    });
                });
                
                // 4. Her numara i√ßin durum analizi yap
                const analyzedCalls = Object.values(groupedByNumber).map(group => {
                    // T√ºm aramalarƒ± birle≈ütir ve tarihlerine g√∂re sƒ±rala
                    const allCallsFromNumber = [
                        ...group.incomingCalls.map(c => ({ ...c, type: 'incoming' })),
                        ...group.outgoingCalls.map(c => ({ ...c, type: 'outgoing' }))
                    ].sort((a, b) => new Date(b.call_time) - new Date(a.call_time));
                    
                    // En son √ßaƒürƒ±yƒ± bul
                    const lastCall = allCallsFromNumber[0];
                    
                    // Cevapsƒ±z gelen aramalarƒ± filtrele
                    const missedIncoming = group.incomingCalls.filter(call => {
                        if (call.is_missing_call !== undefined && call.is_missing_call !== null) {
                            return call.is_missing_call === true || call.is_missing_call === "true" || call.is_missing_call === 1;
                        }
                        const hangupCause = (call.hangup_cause || '').toUpperCase();
                        return hangupCause !== 'ANSWERED';
                    });
                    
                    // Cevaplanan gelen aramalarƒ± filtrele
                    const answeredIncoming = group.incomingCalls.filter(call => {
                        if (call.is_missing_call !== undefined && call.is_missing_call !== null) {
                            return !(call.is_missing_call === true || call.is_missing_call === "true" || call.is_missing_call === 1);
                        }
                        const hangupCause = (call.hangup_cause || '').toUpperCase();
                        return hangupCause === 'ANSWERED';
                    });
                    
                    // Durum analizi
                    let status = 'unanswered'; // Varsayƒ±lan: cevapsƒ±z
                    let callbackMade = false;
                    let callbackButStillUnanswered = false; // Yeni flag: geri aradƒ±k ama cevapsƒ±z kaldƒ±
                    
                    // En son arama giden aramaysa
                    if (lastCall.type === 'outgoing') {
                        // ‚úÖ Gƒ∞DEN ARAMALAR i√ßin answer_time kontrol√º (daha g√ºvenilir)
                        let isAnsweredOutgoing = false;
                        
                        if (lastCall.answer_time !== undefined) {
                            // answer_time varsa ve null/bo≈ü deƒüilse ‚Üí Cevaplanmƒ±≈ü
                            isAnsweredOutgoing = lastCall.answer_time && lastCall.answer_time !== null && lastCall.answer_time !== '';
                        } else if (lastCall.hangup_cause) {
                            // Fallback: hangup_cause kontrol√º
                        const hangupCause = (lastCall.hangup_cause || '').toUpperCase();
                            isAnsweredOutgoing = hangupCause === 'ANSWERED';
                        } else if (lastCall.talking_seconds !== undefined) {
                            // Son fallback: talking_seconds
                            const talkingSeconds = parseInt(lastCall.talking_seconds) || 0;
                            isAnsweredOutgoing = talkingSeconds > 0;
                        }
                        
                        if (isAnsweredOutgoing) {
                            // En son giden aramada g√∂r√º≈ü√ºld√º
                            status = 'answered_outgoing';
                            callbackMade = true;
                        } else if (missedIncoming.length > 0) {
                            // ‚úÖ Cevapsƒ±z gelen arama var ama geri d√∂n√º≈ü yapƒ±lmƒ±≈ü (cevapsƒ±z kalmƒ±≈ü)
                            // Hala cevapsƒ±z kategorisinde kalacak ama flag set edilecek
                            status = 'unanswered';
                            callbackButStillUnanswered = true;
                            callbackMade = true;
                        }
                    } 
                    // En son arama gelen aramaysa
                    else {
                        // is_missing_call field'ƒ± daha g√ºvenilir (NORMAL_CLEARING hem cevaplƒ± hem cevapsƒ±z i√ßin kullanƒ±labiliyor)
                        if (lastCall.is_missing_call !== undefined && lastCall.is_missing_call !== null) {
                            const isMissed = lastCall.is_missing_call === true || lastCall.is_missing_call === "true" || lastCall.is_missing_call === 1;
                            status = isMissed ? 'unanswered' : 'answered';
                        } else {
                            // is_missing_call yoksa hangup_cause'a bak
                            const hangupCause = (lastCall.hangup_cause || '').toUpperCase();
                            status = (hangupCause === 'ANSWERED') ? 'answered' : 'unanswered';
                        }
                    }
                    
                    // Cevapsƒ±z arama saatlerini topla
                    const missedCallTimes = missedIncoming.map(call => {
                        const time = new Date(call.call_time);
                        time.setHours(time.getHours() - 3); // UTC'den T√ºrkiye'ye
                        return time.toLocaleString('tr-TR', { 
                            day: '2-digit', 
                            month: '2-digit',
                            hour: '2-digit', 
                            minute: '2-digit'
                        });
                    });
                    
                    return {
                        number: group.number,
                        lastCall: lastCall,
                        status: status,
                        callbackMade: callbackMade,
                        callbackButStillUnanswered: callbackButStillUnanswered, // ‚úÖ Yeni flag
                        totalIncomingCalls: group.incomingCalls.length,
                        totalOutgoingCalls: group.outgoingCalls.length,
                        missedCount: missedIncoming.length,
                        answeredCount: answeredIncoming.length,
                        missedCallTimes: missedCallTimes,
                        allCalls: allCallsFromNumber
                    };
                });
                
                // 5. Duruma g√∂re kategorize et
                let unansweredCalls = analyzedCalls.filter(c => c.status === 'unanswered' && !c.callbackButStillUnanswered); // Sadece tam cevapsƒ±z
                let callbackUnansweredCalls = analyzedCalls.filter(c => c.status === 'unanswered' && c.callbackButStillUnanswered); // D√∂n√º≈ü yapƒ±ldƒ± ama cevapsƒ±z
                let answeredOutgoingCalls = analyzedCalls.filter(c => c.status === 'answered_outgoing');
                let answeredCalls = analyzedCalls.filter(c => c.status === 'answered');
                
                // ‚úÖ "Diƒüer" kategorisi: CRM'de "Diƒüer" etiketine sahip lead'lerin aramalarƒ± (durum fark etmeksizin)
                // ‚úÖ VEYA localStorage'da cevaplandƒ± olarak i≈üaretlenmi≈ü aramalar
                const answeredMissedCallsList = JSON.parse(localStorage.getItem('answeredMissedCalls') || '[]');
                let otherCalls = analyzedCalls.filter(c => {
                    const cleanCaller = c.number?.replace(/\D/g, '') || '';
                    
                    // Telefon numarasƒ±nƒ± normalize et
                    let formattedCaller = cleanCaller;
                    if (cleanCaller.startsWith('90') && cleanCaller.length === 12) {
                        formattedCaller = '0' + cleanCaller.slice(2);
                    } else if (!cleanCaller.startsWith('0') && cleanCaller.length === 10) {
                        formattedCaller = '0' + cleanCaller;
                    }
                    
                    // localStorage'da cevaplandƒ± olarak i≈üaretlenmi≈üse direkt "Diƒüer" kategorisine ekle
                    if (answeredMissedCallsList.includes(formattedCaller)) {
                        console.log('üìû Cevaplandƒ± (localStorage) - Diƒüer kategorisine eklendi:', c.number);
                        return true;
                    }
                    
                    const leadMatch = crmLeads.find(l => {
                        const cleanLead = l.phone?.replace(/\D/g, '');
                        return cleanLead && cleanCaller && (
                            cleanLead.endsWith(cleanCaller.slice(-10)) || 
                            cleanCaller.endsWith(cleanLead.slice(-10))
                        );
                    });
                    
                    // Lead varsa ve t√ºm bran≈ülarƒ± "Diƒüer" etiketine sahipse
                    if (leadMatch && leadMatch.branches && leadMatch.branches.length > 0) {
                        const hasOtherTag = leadMatch.branches.every(b => b.selectedTag === 'Diƒüer');
                        if (hasOtherTag) {
                            console.log('üìû Diƒüer kategorisine eklendi:', c.number, 'Durum:', c.status);
                        }
                        return hasOtherTag;
                    }
                    return false;
                });
                
                // ‚úÖ "Diƒüer" kategorisindeki aramalarƒ± diƒüer kategorilerden √ßƒ±kar
                const otherNumbers = new Set(otherCalls.map(c => c.number));
                unansweredCalls = unansweredCalls.filter(c => !otherNumbers.has(c.number));
                callbackUnansweredCalls = callbackUnansweredCalls.filter(c => !otherNumbers.has(c.number));
                answeredOutgoingCalls = answeredOutgoingCalls.filter(c => !otherNumbers.has(c.number));
                answeredCalls = answeredCalls.filter(c => !otherNumbers.has(c.number));
                
                // ‚úÖ Silinenleri filtrele (showDeletedCalls false ise) - EN SON √áAƒûRIYA g√∂re
                if (!showDeletedCalls) {
                    unansweredCalls = unansweredCalls.filter(c => !isCallDeleted(c.number, 'incoming', c.lastCall.call_time));
                    callbackUnansweredCalls = callbackUnansweredCalls.filter(c => !isCallDeleted(c.number, 'incoming', c.lastCall.call_time));
                    answeredOutgoingCalls = answeredOutgoingCalls.filter(c => !isCallDeleted(c.number, 'incoming', c.lastCall.call_time));
                    answeredCalls = answeredCalls.filter(c => !isCallDeleted(c.number, 'incoming', c.lastCall.call_time));
                    otherCalls = otherCalls.filter(c => !isCallDeleted(c.number, 'incoming', c.lastCall.call_time));
                }
                
                // Sƒ±rala (en yeni en √ºstte)
                unansweredCalls.sort((a, b) => new Date(b.lastCall.call_time) - new Date(a.lastCall.call_time));
                callbackUnansweredCalls.sort((a, b) => new Date(b.lastCall.call_time) - new Date(a.lastCall.call_time));
                answeredOutgoingCalls.sort((a, b) => new Date(b.lastCall.call_time) - new Date(a.lastCall.call_time));
                answeredCalls.sort((a, b) => new Date(b.lastCall.call_time) - new Date(a.lastCall.call_time));
                otherCalls.sort((a, b) => new Date(b.lastCall.call_time) - new Date(a.lastCall.call_time));
                
                // Global deƒüi≈ükende sakla (sekmeler i√ßin)
                window.incomingCallsCategories = {
                    unanswered: unansweredCalls, // Sadece tam cevapsƒ±z
                    'callback-unanswered': callbackUnansweredCalls, // D√∂n√º≈ü yapƒ±ldƒ± ama cevapsƒ±z
                    callback: answeredOutgoingCalls, // Giden aramada cevaplanmƒ±≈ü
                    answered: answeredCalls, // Cevaplanan aramalar
                    other: otherCalls // WhatsApp, Y√ºz Y√ºze veya Diƒüer yolla cevaplananlar
                };
                
                // Sayƒ±larƒ± g√ºncelle
                document.getElementById('count-unanswered').textContent = unansweredCalls.length;
                document.getElementById('count-callback-unanswered').textContent = callbackUnansweredCalls.length;
                document.getElementById('count-callback').textContent = answeredOutgoingCalls.length;
                document.getElementById('count-answered').textContent = answeredCalls.length;
                document.getElementById('count-other').textContent = otherCalls.length;
                
                // Toplam cevapsƒ±z sayƒ±sƒ±nƒ± g√ºncelle (bildirim i√ßin) - SADECE tam cevapsƒ±z
                window.totalUnansweredCount = unansweredCalls.length;
                
                // ‚úÖ ƒ∞lk y√ºkleme ise, bildirim sayacƒ±nƒ± g√ºncelle ve eƒüer cevapsƒ±z varsa bildirim g√∂ster
                if (lastMissedCallsCount === -1) {
                    lastMissedCallsCount = 0; // ƒ∞lk kontrolde 0'dan ba≈ülayalƒ±m
                    console.log(`üìä ƒ∞lk y√ºkleme: Toplam cevapsƒ±z sayƒ±sƒ± ${window.totalUnansweredCount} olarak tespit edildi`);
                    
                    // ‚úÖ ƒ∞lk y√ºklemede cevapsƒ±z √ßaƒürƒ± varsa bildirim g√∂ster
                    if (window.totalUnansweredCount > 0) {
                        console.log(`üîî ƒ∞lk y√ºkleme bildirimi: ${window.totalUnansweredCount} cevapsƒ±z √ßaƒürƒ± mevcut`);
                        await showMissedCallNotification(window.totalUnansweredCount);
                    }
                    
                    lastMissedCallsCount = window.totalUnansweredCount;
                }
                
                if (incomingCalls.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p style="padding: 40px; color: #999;">üìã Son 72 saatte gelen arama yok</p></div>';
                return;
            }
            
                // ƒ∞lk sekmeyi g√∂ster (cevapsƒ±z)
                switchIncomingCallTab('unanswered');
                
                // Toplu silme butonunu g√ºncelle
                updateBulkDeleteButton('incoming');
            } catch (error) {
                console.error('Gelen aramalar y√ºklenirken hata:', error);
                container.innerHTML = '<div class="empty-state"><p style="padding: 40px; color: #f44336;">‚ùå Gelen aramalar y√ºklenirken bir hata olu≈ütu</p></div>';
            }
        }
        
        // Sekme deƒüi≈ütir
        window.switchIncomingCallTab = function(tabName) {
            const container = document.getElementById('incoming-calls-list');
            if (!container || !window.incomingCallsCategories) return;
            
            // Sekme stillerini g√ºncelle
            const tabs = ['unanswered', 'callback-unanswered', 'callback', 'answered', 'other'];
            tabs.forEach(tab => {
                const tabBtn = document.getElementById(`tab-${tab}`);
                if (tabBtn) {
                    if (tab === tabName) {
                        // Aktif sekme
                        let bgColor = '#ffebee';
                        let color = '#f44336';
                        let borderColor = '#f44336';
                        
                        if (tab === 'callback-unanswered') {
                            bgColor = '#fff3e0';
                            color = '#ff9800';
                            borderColor = '#ff9800';
                        } else if (tab === 'callback') {
                            bgColor = '#e3f2fd';
                            color = '#2196f3';
                            borderColor = '#2196f3';
                        } else if (tab === 'answered') {
                            bgColor = '#e8f5e9';
                            color = '#4caf50';
                            borderColor = '#4caf50';
                        } else if (tab === 'other') {
                            bgColor = '#f3e5f5';
                            color = '#9c27b0';
                            borderColor = '#9c27b0';
                        }
                        
                        tabBtn.style.background = bgColor;
                        tabBtn.style.color = color;
                        tabBtn.style.borderBottom = `3px solid ${borderColor}`;
                    } else {
                        // Pasif sekme
                        tabBtn.style.background = '#fff';
                        tabBtn.style.color = '#666';
                        tabBtn.style.borderBottom = '3px solid transparent';
                    }
                }
            });
            
            // ƒ∞√ßeriƒüi render et
            const calls = window.incomingCallsCategories[tabName] || [];
            
            if (calls.length === 0) {
                let emptyMessage = 'üìã Bu kategoride arama yok';
                if (tabName === 'unanswered') {
                    emptyMessage = '‚úÖ Harika! Cevapsƒ±z √ßaƒürƒ±nƒ±z yok.';
                } else if (tabName === 'callback-unanswered') {
                    emptyMessage = 'üìã D√∂n√º≈ü yapƒ±ldƒ± ama cevapsƒ±z √ßaƒürƒ± yok';
                } else if (tabName === 'callback') {
                    emptyMessage = 'üìã Giden aramada cevaplanmƒ±≈ü √ßaƒürƒ± yok';
                } else if (tabName === 'answered') {
                    emptyMessage = 'üìã Gelen aramada cevaplanmƒ±≈ü √ßaƒürƒ± yok';
                } else if (tabName === 'other') {
                    emptyMessage = 'üìã WhatsApp, Y√ºz Y√ºze veya Diƒüer yolla cevaplanan √ßaƒürƒ± yok';
                }
                container.innerHTML = `<div class="empty-state"><p style="padding: 40px; color: #999;">${emptyMessage}</p></div>`;
                return;
            }
            
            // Limitleme
            const displayCalls = calls.slice(0, 50);
            
            // √áaƒürƒ± tipine g√∂re render et
            let callType = 'normal';
            let isMissed = false;
            
            if (tabName === 'unanswered') {
                callType = 'normal';
                isMissed = true;
            } else if (tabName === 'callback-unanswered') {
                callType = 'callback-unanswered';
                isMissed = true;
            } else if (tabName === 'callback') {
                callType = 'callback';
            } else if (tabName === 'other') {
                callType = 'other';
                isMissed = false;
            } else if (tabName === 'answered') {
                callType = 'answered';
                isMissed = false;
            }
            
            const callsHtml = displayCalls.map(call => renderIncomingCall(call, isMissed, callType)).join('');
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; padding: 15px;">
                    ${callsHtml}
                </div>
                ${calls.length > 50 ? `<p style="text-align: center; color: #666; padding: 15px;">ƒ∞lk 50 arama g√∂steriliyor (Toplam: ${calls.length})</p>` : ''}
            `;
        };
        
        // Gelen arama kartƒ±nƒ± render et
        function renderIncomingCall(call, isMissed, callType = 'normal') {
            try {
                        const caller = call.number || call.caller || 'Bilinmeyen';
                        const formattedCaller = formatPhoneDisplay(caller);
                            const callee = call.callee || 'Bilinmeyen';
                            const formattedCallee = formatPhoneDisplay(callee);
                        const callTime = new Date(call.lastCall.call_time);
                        callTime.setHours(callTime.getHours() - 3); // UTC'den T√ºrkiye saatine √ßevir
                        const timeStr = callTime.toLocaleString('tr-TR', { 
                            day: '2-digit', 
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit', 
                            minute: '2-digit'
                        });
                        
                            // Duration bilgisini lastCall'dan al
                            const talkingSeconds = call.lastCall.talking_seconds || call.lastCall.duration || 0;
                            const durationStr = talkingSeconds > 0 ? `${Math.floor(talkingSeconds / 60)}:${String(talkingSeconds % 60).padStart(2, '0')} dk` : '0 sn';
                            
                            // ‚úÖ is_missing_call kullan (API dok√ºmantasyonuna g√∂re) - lastCall'dan al
                            let wasAnswered = false;
                            let isMissed = false;
                            
                            // √ñnce is_missing_call kontrol et (lastCall'dan)
                            if (call.lastCall.is_missing_call !== undefined && call.lastCall.is_missing_call !== null) {
                                const isMissingCall = call.lastCall.is_missing_call === true || call.lastCall.is_missing_call === "true" || call.lastCall.is_missing_call === 1;
                                isMissed = isMissingCall;
                                wasAnswered = !isMissingCall;
                            } 
                            // Fallback: is_missing_call yoksa hangup_cause kontrol et (lastCall'dan)
                            else {
                                const hangupCause = (call.lastCall.hangup_cause || '').toUpperCase();
                                wasAnswered = hangupCause === 'ANSWERED';
                                isMissed = !wasAnswered;
                            }
                            // ‚úÖ Durum bilgileri - callType ve callbackButStillUnanswered durumuna g√∂re ayarla
                            let statusIcon = '‚úÖ';
                            let statusText = 'Cevaplandƒ±';
                            let statusColor = '#4caf50';
                            
                            // callType'a g√∂re durum belirleme
                            if (callType === 'callback-unanswered') {
                                // D√∂n√º≈ü yapƒ±ldƒ± ama cevapsƒ±z (sadece badge g√∂sterilecek, status g√∂sterilmeyecek)
                                statusIcon = '';
                                statusText = '';
                                statusColor = '#ff9800';
                            } else if (callType === 'callback') {
                                // Giden aramada cevaplanmƒ±≈ü (cevapsƒ±z badge'i g√∂sterilmeyecek)
                                statusIcon = '‚úÖ';
                                statusText = 'Cevaplandƒ±';
                                statusColor = '#4caf50';
                            } else if (callType === 'answered') {
                                // Cevaplanan aramalar
                                statusIcon = '‚úÖ';
                                statusText = 'Cevaplandƒ±';
                                statusColor = '#4caf50';
                            } else if (callType === 'other') {
                                // Diƒüer yolla cevaplananlar (WhatsApp, Y√ºz Y√ºze, Diƒüer)
                                statusIcon = 'üìã';
                                statusText = 'Diƒüer Yolla Cevaplandƒ±';
                                statusColor = '#9c27b0';
                            } else if (callType === 'normal' && isMissed) {
                                // Tam cevapsƒ±z
                                statusIcon = '‚ùå';
                                statusText = 'Cevapsƒ±z';
                                statusColor = '#f44336';
                            } else {
                                // Diƒüer durumlar (fallback)
                                statusIcon = wasAnswered ? '‚úÖ' : '‚ùå';
                                statusText = wasAnswered ? 'Cevaplandƒ±' : 'Cevapsƒ±z';
                                statusColor = wasAnswered ? '#4caf50' : '#f44336';
                            }
                            
                            // CRM'de veya √ºyelerde var mƒ± kontrol et
                            const leadMatch = crmLeads.find(l => {
                                const cleanLead = l.phone?.replace(/\\D/g, '');
                                const cleanCaller = caller.replace(/\\D/g, '');
                                return cleanLead && cleanCaller && (
                                    cleanLead.endsWith(cleanCaller.slice(-10)) || 
                                    cleanCaller.endsWith(cleanLead.slice(-10))
                                );
                            });
                            
                            const memberMatch = members.find(m => {
                                const cleanMember = m.Telefon?.replace(/\\D/g, '');
                                const cleanMember2 = m.Telefon_2?.replace(/\\D/g, '');
                                const cleanCaller = caller.replace(/\\D/g, '');
                                return cleanCaller && (
                                    (cleanMember && (cleanMember.endsWith(cleanCaller.slice(-10)) || cleanCaller.endsWith(cleanMember.slice(-10)))) ||
                                    (cleanMember2 && (cleanMember2.endsWith(cleanCaller.slice(-10)) || cleanCaller.endsWith(cleanMember2.slice(-10))))
                                );
                            });
                            
                            // ‚úÖ Ula≈üƒ±lamadƒ± kontrol√º
                            const cleanCaller = caller.replace(/\D/g, '');
                            const unreachableCalls = JSON.parse(localStorage.getItem('unreachableCalls') || '{}');
                            const isUnreachable = Object.values(unreachableCalls).some(u => {
                                const cleanUnreachable = u.phone?.replace(/\D/g, '');
                                return cleanUnreachable && cleanCaller && (
                                    cleanUnreachable.endsWith(cleanCaller.slice(-10)) || 
                                    cleanCaller.endsWith(cleanUnreachable.slice(-10))
                                );
                            });
                            
                            let personInfo = '';
                            let actionButtons = '';
                            let bgColor = wasAnswered ? '#e8f5e9' : (isUnreachable ? '#fff3e0' : '#ffebee');
                            let borderColor = wasAnswered ? statusColor : (isUnreachable ? '#ff9800' : statusColor);
                            
                            // Silinmi≈ü badge ekle
                            const callDeleted = isCallDeleted(caller, 'incoming', call.lastCall.call_time);
                            const deletedBadge = callDeleted ? `<span style="background: #9e9e9e; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">üóëÔ∏è Silindi</span>` : '';
                            
                            // ‚úÖ WhatsApp badge ekle
                            const whatsappBadge = call.lastCall.isWhatsApp ? `<span style="background: #25D366; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">üì± WhatsApp</span>` : '';
                            
                            // ‚úÖ Kategori badge'leri - callType'a g√∂re
                            let categoryBadge = '';
                            if (callType === 'callback-unanswered') {
                                // D√∂n√º≈ü yapƒ±ldƒ± ama cevapsƒ±z kaldƒ± - sadece bu badge g√∂sterilecek
                                categoryBadge = `<span style="background: #ff9800; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">‚Ü©Ô∏è D√∂n√º≈ü Yapƒ±ldƒ± Ama Cevapsƒ±z</span>`;
                            } else if (callType === 'callback') {
                                // Giden aramada cevaplanmƒ±≈ü
                                categoryBadge = `<span style="background: #2196f3; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">üìû Giden Aramada Cevaplanmƒ±≈ü</span>`;
                            }
                            
                            // Arama sayƒ±sƒ± ve cevapsƒ±z saatler bilgisi
                            let callCountInfo = '';
                            if (call.missedCount > 0) {
                                callCountInfo = `
                                    <div style="font-size: 12px; color: #f44336; font-weight: 600; margin-top: 6px; padding: 8px; background: rgba(244, 67, 54, 0.1); border-radius: 4px;">
                                        üìµ ${call.missedCount} kere cevapsƒ±z aradƒ±
                                        ${call.missedCallTimes && call.missedCallTimes.length > 0 ? `
                                            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                                                üïê Saatler: ${call.missedCallTimes.join(', ')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }
                            
                            // Toplam arama sayƒ±sƒ±
                            const totalCallsInfo = call.totalIncomingCalls > 1 ? 
                                `<span style="background: #9c27b0; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">üìû ${call.totalIncomingCalls} arama</span>` : '';
                            
                            if (leadMatch) {
                                personInfo = `<div style="font-weight: 600; font-size: 15px; color: #1976d2; margin-bottom: 6px;">üë§ ${leadMatch.fullName}${deletedBadge}</div>`;
                                
                                // Dropdown men√º olu≈ütur
                                const dropdownId = `dropdown-${call.lastCall.call_time.replace(/[^0-9]/g, '')}`;
                                
                                // ‚úÖ Gelen Aramalar ƒ∞√ßin Sadele≈ütirilmi≈ü Men√º: Cevaplandƒ±, Mesaj G√∂nder, Sil
                                const menuTimeStr = new Date(call.lastCall.call_time).toLocaleString('tr-TR');
                                const missedCallMenuItems = isMissed ? `
                                    <button class="btn btn-sm btn-info" onclick="markMissedCallAsAnswered('${caller}', '${leadMatch.id}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left; margin-bottom: 5px;">
                                        ‚úîÔ∏è Cevaplandƒ±
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="sendMissedCallMessage('${leadMatch.phone || caller}', '${leadMatch.fullName}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left; margin-bottom: 5px;">
                                        üí¨ Mesaj G√∂nder
                                    </button>
                                ` : '';
                                
                                actionButtons = `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; gap: 5px; align-items: center; flex-wrap: wrap;">
                                        <button class="btn btn-sm btn-primary" onclick="openCustomerDetail('${leadMatch.id}')">
                                            üìã G√∂r√ºnt√ºle
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="showCallRecordsModal('${caller}')" title="G√∂r√º≈üme kayƒ±tlarƒ±nƒ± g√∂r√ºnt√ºle">
                                            üìû G√∂r√º≈ümeler
                                        </button>
                                        ${missedCallMenuItems ? `
                                        <div style="position: relative; display: inline-block; z-index: 10000;">
                                            <button class="btn btn-sm btn-secondary" onclick="toggleCallDropdown('${dropdownId}')" style="padding: 4px 10px;">
                                                ‚öôÔ∏è ƒ∞≈ülemler ‚ñº
                                            </button>
                                            <div id="${dropdownId}" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 99999; min-width: 180px; padding: 8px; margin-top: 4px;">
                                                ${missedCallMenuItems}
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                `;
                                bgColor = '#e3f2fd';
                            } else if (memberMatch) {
                                const memberName = memberMatch.Resit_Olmayan_Adi_Soyadi || memberMatch.Ad_Soyad;
                                personInfo = `<div style="font-weight: 600; font-size: 15px; color: #388e3c; margin-bottom: 6px;">‚úÖ √úye: ${memberName}${deletedBadge}</div>`;
                                
                                // √úyeler i√ßin de cevapsƒ±z √ßaƒürƒ± butonlarƒ± ekle
                                const missedCallMemberButtons = isMissed ? `
                                    <button class="btn btn-sm btn-info" onclick="markMissedCallAsAnswered('${caller}', null, '${memberMatch.id}')" title="Manuel olarak cevaplandƒ± i≈üaretle">
                                        ‚úîÔ∏è Cevaplandƒ±
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="sendMissedCallMessage('${memberMatch.Telefon || caller}', '${memberName}')" title="Cevapsƒ±z √ßaƒürƒ± mesajƒ± g√∂nder">
                                        üí¨ Mesaj G√∂nder
                                    </button>
                                ` : '';
                                
                                actionButtons = `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; flex-wrap: wrap; gap: 5px;">
                                        <button class="btn btn-sm btn-success" onclick="showMemberAttendancePage('${memberMatch.id}')">
                                            üìã √úye Bilgileri
                                        </button>
                                        ${missedCallMemberButtons}
                                    </div>
                                `;
                        } else {
                                // CRM'de olmayan cevapsƒ±z √ßaƒürƒ±lar i√ßin - FARKLI RENK
                                bgColor = '#fff8e1'; // A√ßƒ±k sarƒ±/turuncu
                                borderColor = '#ffa726'; // Turuncu border
                                
                                const dropdownId = `dropdown-${call.lastCall.call_time.replace(/[^0-9]/g, '')}`;
                                const menuTimeStr2 = new Date(call.lastCall.call_time).toLocaleString('tr-TR');
                                
                                const missedCallMenuItems = isMissed ? `
                                    <button class="btn btn-sm btn-info" onclick="markMissedCallAsAnswered('${caller}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left; margin-bottom: 5px;">
                                        ‚úîÔ∏è Cevaplandƒ±
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="markAsUnreachableWithMessage('${caller}', '${menuTimeStr2}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left; margin-bottom: 5px;">
                                        üìµ Ula≈üƒ±lamadƒ±
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="sendMissedCallMessage('${caller}', 'M√º≈üteri'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left; margin-bottom: 5px;">
                                        üí¨ Mesaj G√∂nder
                                    </button>
                                ` : `
                                    <button class="btn btn-sm btn-secondary" onclick="sendMissedCallMessage('${caller}', 'M√º≈üteri'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left; margin-bottom: 5px;">
                                        üí¨ Mesaj G√∂nder
                                    </button>
                                `;
                                
                                personInfo = `<div style="font-weight: 600; font-size: 15px; color: #e65100; margin-bottom: 6px;">üåü Yeni Potansiyel M√º≈üteri${deletedBadge}</div>`;
                                
                                actionButtons = `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; gap: 5px; align-items: center;">
                                        <button class="btn btn-sm btn-primary" onclick="addToCRMFromMissedCall('${caller}')">
                                            ‚ûï CRM'e Ekle
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="showCallRecordsModal('${caller}')" title="G√∂r√º≈üme kayƒ±tlarƒ±nƒ± g√∂r√ºnt√ºle">
                                            üìû G√∂r√º≈ümeler
                                        </button>
                                        ${missedCallMenuItems ? `
                                        <div style="position: relative; display: inline-block; z-index: 10000;">
                                            <button class="btn btn-sm btn-secondary" onclick="toggleCallDropdown('${dropdownId}')" style="padding: 4px 10px;">
                                                ‚öôÔ∏è ƒ∞≈ülemler ‚ñº
                                            </button>
                                            <div id="${dropdownId}" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 99999; min-width: 180px; padding: 8px; margin-top: 4px;">
                                                ${missedCallMenuItems}
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                `;
                            }
                            
                            // Checkbox i√ßin unique key - √∂zel karakterleri escape et
                            const safeCallTime = call.lastCall.call_time.replace(/'/g, "\\'");
                            const safeCaller = caller.replace(/'/g, "\\'");
                            const callKey = `${caller}|${call.lastCall.call_time}`;
                            const isChecked = selectedIncomingCalls.has(callKey) ? 'checked' : '';
                            
                            // CRM badge (saƒü √ºst k√∂≈üe)
                            const crmBadge = leadMatch ? `<div style="position: absolute; top: 8px; right: 8px; background: #1976d2; color: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">üìã CRM</div>` : '';
                            
                            return `
                                <div style="position: relative; padding: 15px; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 8px; transition: transform 0.2s; display: flex; gap: 12px; align-items: flex-start;" onmouseover="this.style.transform='translateY(-2px)'; this.style.zIndex='100';" onmouseout="this.style.transform='translateY(0)'; this.style.zIndex='1';">
                                    ${crmBadge}
                                    <div style="padding-top: 2px;">
                                        <input type="checkbox" class="incoming-call-checkbox" value="${callKey}" onchange="toggleIncomingCall(this, '${safeCaller}|${safeCallTime}')" ${isChecked} style="width: 20px; height: 20px; cursor: pointer; margin: 0;">
                                    </div>
                                    <div style="flex: 1;">
                                        ${personInfo}
                                        <div style="font-size: 14px; color: #333; font-weight: 500; margin-bottom: 6px;">üìû Arayan: ${formattedCaller} ${totalCallsInfo} ${whatsappBadge}</div>
                                        <div style="font-size: 13px; color: #666; margin-bottom: 6px;">üì± Aranan: ${formattedCallee}</div>
                                        <div style="font-size: 13px; color: #666; margin-bottom: 4px;">üïê En Son: ${timeStr}</div>
                                        ${statusIcon && statusText ? `<div style="font-size: 13px; color: ${statusColor}; font-weight: 600; margin-bottom: 4px;">
                                            ${statusIcon} ${statusText}
                                        </div>` : ''}
                                        ${categoryBadge ? `<div style="margin-bottom: 4px;">${categoryBadge}</div>` : ''}
                                        <div style="font-size: 12px; color: #666;">‚è±Ô∏è S√ºre: ${durationStr}</div>
                                        ${callCountInfo}
                                        ${actionButtons}
                                    </div>
                                </div>
                            `;
            } catch (error) {
                console.error('Gelen arama kartƒ± render hatasƒ±:', error);
                return `<div style="padding: 15px; background: #ffebee; border-radius: 8px;"><p style="color: #f44336;">‚ùå Kart y√ºklenemedi</p></div>`;
            }
        };
        
        // Giden aramalar sayfasƒ±nƒ± render et
        window.renderOutgoingCallsPage = async function() {
            const container = document.getElementById('outgoing-calls-list');
            if (!container) return;
            
            // Se√ßimleri temizle
            selectedOutgoingCalls.clear();
            const selectAllCheckbox = document.getElementById('selectAllOutgoing');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Giden aramalar y√ºkleniyor...</span></div>';
            
            // Bulutfon kontrol√º - API Key'e g√∂re kontrol et
            if (!clubSettings || !clubSettings.bulutfonApiKey) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <h3 style="color: #856404; margin-bottom: 15px;">üìû Bulutfon Entegrasyonu Gerekli</h3>
                        <p style="color: #666; margin-bottom: 20px;">
                            Giden aramalarƒ± g√∂r√ºnt√ºlemek i√ßin Bulutfon API entegrasyonunu aktif etmeniz gerekiyor.
                        </p>
                        <button class="btn btn-primary" onclick="showSection('settings', document.querySelector('.nav-btn[onclick*=\\'settings\\']')); setTimeout(() => switchSettingsTab('general'), 500);">
                            ‚öôÔ∏è Ayarlara Git
                        </button>
                    </div>
                `;
                return;
            }
            
            console.log('üìû Bulutfon API Key mevcut, aramalar y√ºkleniyor...');
            
            try {
                const response = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${clubSettings.bulutfonApiKey}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const allRecords = Array.isArray(data) ? data : (data.cdrs || data.data || []);
                
                // Giden aramalarƒ± filtrele (direction: 'OUT')
                let outgoingCalls = allRecords.filter(record => record.direction === 'OUT');
                
                // Son 1 hafta i√ßindeki √ßaƒürƒ±larƒ± al
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                outgoingCalls = outgoingCalls.filter(record => {
                    const callTime = new Date(record.call_time);
                    return callTime >= oneWeekAgo;
                });
                
                // ‚úÖ NOT: Silinen √ßaƒürƒ±larƒ± burada Fƒ∞LTRELEME - gruplama sonrasƒ± yapƒ±lacak
                // √á√ºnk√º aynƒ± numaranƒ±n birden fazla √ßaƒürƒ±sƒ± olabilir ve sadece en son √ßaƒürƒ± silinmi≈üse
                // diƒüer √ßaƒürƒ±larƒ± da g√∂rmemiz gerekiyor (gruplama i√ßin)
                
                // ‚úÖ Numaraya g√∂re grupla ve EN SON DURUMA g√∂re kategorilendirme yap
                const groupedByNumber = {};
                
                outgoingCalls.forEach(call => {
                    const cleanNumber = call.callee?.replace(/\D/g, '') || 'unknown';
                    const last10Digits = cleanNumber.slice(-10);
                    
                    if (!groupedByNumber[last10Digits]) {
                        groupedByNumber[last10Digits] = [];
                    }
                    
                    groupedByNumber[last10Digits].push(call);
                });
                
                // Her numara i√ßin en son duruma g√∂re kategorilendirme yap
                const analyzedCalls = Object.values(groupedByNumber).map(calls => {
                    // En son √ßaƒürƒ±yƒ± bul (en yeni tarih)
                    calls.sort((a, b) => new Date(b.call_time) - new Date(a.call_time));
                    const lastCall = calls[0];
                    
                    // En son √ßaƒürƒ±nƒ±n durumunu kontrol et
                    let isAnswered = false;
                    
                    // 1. answer_time kontrol√º (√∂ncelikli - giden aramalar i√ßin)
                    if (lastCall.answer_time !== undefined) {
                        isAnswered = lastCall.answer_time && lastCall.answer_time !== null && lastCall.answer_time !== '';
                    }
                    // 2. hangup_cause kontrol√º (fallback)
                    else if (lastCall.hangup_cause) {
                        const hangupCause = (lastCall.hangup_cause || '').toUpperCase();
                        isAnswered = hangupCause === 'ANSWERED';
                    }
                    // 3. Son fallback: talking_seconds kontrol√º
                    else {
                        const talkingSeconds = parseInt(lastCall.talking_seconds) || 0;
                        isAnswered = talkingSeconds > 0;
                    }
                    
                    return {
                        number: lastCall.callee,
                        lastCall: lastCall,
                        status: isAnswered ? 'answered' : 'unanswered',
                        totalCalls: calls.length,
                        allCalls: calls
                    };
                });
                
                // Duruma g√∂re ayƒ±r
                let missedCalls = analyzedCalls.filter(c => c.status === 'unanswered');
                let answeredCalls = analyzedCalls.filter(c => c.status === 'answered');
                
                // ‚úÖ Silinenleri filtrele (showDeletedCalls false ise) - EN SON √áAƒûRIYA g√∂re
                if (!showDeletedCalls) {
                    missedCalls = missedCalls.filter(c => !isCallDeleted(c.number, 'outgoing', c.lastCall.call_time));
                    answeredCalls = answeredCalls.filter(c => !isCallDeleted(c.number, 'outgoing', c.lastCall.call_time));
                }
                
                // Her ikisini de sƒ±rala (en yeni en √ºstte)
                missedCalls.sort((a, b) => new Date(b.lastCall.call_time) - new Date(a.lastCall.call_time));
                answeredCalls.sort((a, b) => new Date(b.lastCall.call_time) - new Date(a.lastCall.call_time));
                
                // Debug: ƒ∞lk birka√ß kaydƒ± g√∂ster
                console.log(`üìä Giden aramalar: ${missedCalls.length} cevapsƒ±z, ${answeredCalls.length} cevaplanan`);
                if (outgoingCalls.length > 0) {
                    console.log('üîç ƒ∞lk 3 giden arama:');
                    outgoingCalls.slice(0, 3).forEach((call, idx) => {
                        console.log(`  ${idx + 1}. answer_time: ${call.answer_time || 'null'}, hangup_cause: ${call.hangup_cause}, talking_seconds: ${call.talking_seconds}, callee: ${call.callee}`);
                    });
                }
                
                // Global deƒüi≈ükende sakla (sekmeler i√ßin - ileride kullanƒ±labilir)
                window.outgoingCallsCategories = {
                    unanswered: missedCalls,
                    answered: answeredCalls
                };
                
                // En fazla 30 cevapsƒ±z, 50 cevaplƒ±
                const displayMissed = missedCalls.slice(0, 30);
                const displayAnswered = answeredCalls.slice(0, 50);
                
                if (outgoingCalls.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p style="padding: 40px; color: #999;">üìã Son 72 saatte giden arama yok</p></div>';
                    return;
                }
                
                // Cevapsƒ±z √ßaƒürƒ±lar b√∂l√ºm√º
                let missedSection = '';
                if (displayMissed.length > 0) {
                    missedSection = `
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #f44336; font-size: 18px; margin-bottom: 15px; padding: 10px; background: #ffebee; border-left: 4px solid #f44336; border-radius: 4px;">
                                üìµ Cevapsƒ±z √áaƒürƒ±lar (${displayMissed.length}) - En Son Arama
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; padding: 15px;">
                                ${displayMissed.map(call => renderOutgoingCall(call, true)).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // Cevaplanan aramalar b√∂l√ºm√º
                let answeredSection = '';
                if (displayAnswered.length > 0) {
                    answeredSection = `
                        <div>
                            <h3 style="color: #4caf50; font-size: 18px; margin-bottom: 15px; padding: 10px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 4px;">
                                ‚úÖ Cevaplanan Aramalar (${displayAnswered.length}) - En Son Arama
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; padding: 15px;">
                                ${displayAnswered.map(call => renderOutgoingCall(call, false)).join('')}
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = missedSection + answeredSection;
                
                // Toplu silme butonunu g√ºncelle
                updateBulkDeleteButton('outgoing');
            } catch (error) {
                console.error('Giden aramalar y√ºklenirken hata:', error);
                container.innerHTML = '<div class="empty-state"><p style="padding: 40px; color: #f44336;">‚ùå Giden aramalar y√ºklenirken bir hata olu≈ütu</p></div>';
            }
        }
        
        // Giden arama kartƒ±nƒ± render et
        function renderOutgoingCall(call, isMissedParam) {
            try {
                // call.lastCall yapƒ±sƒ±ndan veri al
                const actualCall = call.lastCall || call; // Eski yapƒ±yla uyumluluk i√ßin
                
                const caller = actualCall.caller || 'Bilinmeyen';
                const formattedCaller = formatPhoneDisplay(caller);
                const callee = call.number || actualCall.callee || 'Bilinmeyen';
                const formattedCallee = formatPhoneDisplay(callee);
                const callTime = new Date(actualCall.call_time);
                callTime.setHours(callTime.getHours() - 3); // UTC'den T√ºrkiye saatine √ßevir
                const timeStr = callTime.toLocaleString('tr-TR', { 
                    day: '2-digit', 
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit'
                });
                
                // Duration bilgisini actualCall'dan al
                const talkingSeconds = actualCall.talking_seconds || actualCall.duration || 0;
                const durationStr = talkingSeconds > 0 ? `${Math.floor(talkingSeconds / 60)}:${String(talkingSeconds % 60).padStart(2, '0')} dk` : '0 sn';
                
                // isMissedParam'dan durumu al (status'den de kontrol et)
                const isMissed = call.status === 'unanswered' || isMissedParam;
                const wasAnswered = !isMissedParam;
                const statusIcon = wasAnswered ? '‚úÖ' : '‚ùå';
                const statusText = wasAnswered ? 'Cevaplandƒ±' : 'Cevapsƒ±z';
                const statusColor = wasAnswered ? '#4caf50' : '#f44336';
                        
                        // CRM'de veya √ºyelerde var mƒ± kontrol et
                        const leadMatch = crmLeads.find(l => {
                                const cleanLead = l.phone?.replace(/\\D/g, '');
                                const cleanCallee = callee.replace(/\\D/g, '');
                                return cleanLead && cleanCallee && (
                                    cleanLead.endsWith(cleanCallee.slice(-10)) || 
                                    cleanCallee.endsWith(cleanLead.slice(-10))
                            );
                        });
                        
                        const memberMatch = members.find(m => {
                                const cleanMember = m.Telefon?.replace(/\\D/g, '');
                                const cleanMember2 = m.Telefon_2?.replace(/\\D/g, '');
                                const cleanCallee = callee.replace(/\\D/g, '');
                                return cleanCallee && (
                                    (cleanMember && (cleanMember.endsWith(cleanCallee.slice(-10)) || cleanCallee.endsWith(cleanMember.slice(-10)))) ||
                                    (cleanMember2 && (cleanMember2.endsWith(cleanCallee.slice(-10)) || cleanCallee.endsWith(cleanMember2.slice(-10))))
                            );
                        });
                        
                        let personInfo = '';
                        let actionButtons = '';
                            let bgColor = wasAnswered ? '#e8f5e9' : '#ffebee';
                            let borderColor = statusColor;
                            
                            // Silinmi≈ü badge ekle
                            const callDeleted = isCallDeleted(callee, 'outgoing', call.call_time);
                            const deletedBadge = callDeleted ? `<span style="background: #9e9e9e; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">üóëÔ∏è Silindi</span>` : '';
                            
                            const deleteButton = callDeleted ? 
                                `<button class="btn btn-sm btn-secondary" onclick="undeleteCall('${callee}', 'outgoing', '${call.call_time}')" title="√áaƒürƒ±yƒ± geri getir">‚Ü©Ô∏è Geri Al</button>` :
                                `<button class="btn btn-sm btn-danger" onclick="deleteCall('${callee}', 'outgoing', '${call.call_time}')" title="√áaƒürƒ±yƒ± sil">üóëÔ∏è Sil</button>`;
                        
                        if (leadMatch) {
                                personInfo = `<div style="font-weight: 600; font-size: 15px; color: #1976d2; margin-bottom: 6px;">üë§ ${leadMatch.fullName}${deletedBadge}</div>`;
                                
                                const dropdownId = `dropdown-out-${actualCall.call_time.replace(/[^0-9]/g, '')}`;
                                
                                // Toplam arama sayƒ±sƒ± badge
                                const totalCallsInfo = call.totalCalls && call.totalCalls > 1 ? 
                                    `<span style="background: #9c27b0; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">üìû ${call.totalCalls} arama</span>` : '';
                                
                            actionButtons = `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; gap: 5px; align-items: center; flex-wrap: wrap;">
                                        <button class="btn btn-sm btn-primary" onclick="openCustomerDetail('${leadMatch.id}')">
                                        üìã G√∂r√ºnt√ºle
                                    </button>
                                        <button class="btn btn-sm btn-info" onclick="showCallRecordsModal('${callee}')" title="G√∂r√º≈üme kayƒ±tlarƒ±nƒ± g√∂r√ºnt√ºle">
                                            üìû G√∂r√º≈ümeler
                                        </button>
                                        <div style="position: relative; display: inline-block; z-index: 10000;">
                                            <button class="btn btn-sm btn-secondary" onclick="toggleCallDropdown('${dropdownId}')" style="padding: 4px 10px;">
                                                ‚öôÔ∏è ƒ∞≈ülemler ‚ñº
                                            </button>
                                            <div id="${dropdownId}" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 99999; min-width: 180px; padding: 8px; margin-top: 4px;">
                                                <button class="btn btn-sm btn-success" onclick="updateCRMFromMissedCall('${leadMatch.id}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left; margin-bottom: 5px;">
                                            ‚úèÔ∏è G√ºncelle
                                    </button>
                                                <div style="border-top: 1px solid #e0e0e0; margin: 5px 0;"></div>
                                                ${callDeleted ? 
                                                    `<button class="btn btn-sm btn-secondary" onclick="undeleteCall('${callee}', 'outgoing', '${actualCall.call_time}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left;">‚Ü©Ô∏è Geri Al</button>` :
                                                    `<button class="btn btn-sm btn-danger" onclick="deleteCall('${callee}', 'outgoing', '${actualCall.call_time}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left;">üóëÔ∏è Sil</button>`}
                                            </div>
                                        </div>
                                        ${totalCallsInfo}
                                </div>
                            `;
                            bgColor = '#e3f2fd';
                        } else if (memberMatch) {
                            const memberName = memberMatch.Resit_Olmayan_Adi_Soyadi || memberMatch.Ad_Soyad;
                                personInfo = `<div style="font-weight: 600; font-size: 15px; color: #388e3c; margin-bottom: 6px;">‚úÖ √úye: ${memberName}${deletedBadge}</div>`;
                            actionButtons = `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; flex-wrap: wrap; gap: 5px;">
                                        <button class="btn btn-sm btn-success" onclick="showMemberAttendancePage('${memberMatch.id}')">
                                            üìã √úye Bilgileri
                                    </button>
                                        ${deleteButton}
                                </div>
                            `;
                        } else {
                                // CRM'de olmayan i√ßin - FARKLI RENK
                                bgColor = '#fff8e1'; // A√ßƒ±k sarƒ±/turuncu
                                borderColor = '#ffa726'; // Turuncu border
                                personInfo = `<div style="font-weight: 600; font-size: 15px; color: #e65100; margin-bottom: 6px;">üåü Yeni Potansiyel M√º≈üteri${deletedBadge}</div>`;
                                
                                const dropdownId = `dropdown-out-${actualCall.call_time ? actualCall.call_time.replace(/[^0-9]/g, '') : 'unknown'}`;
                                
                            actionButtons = `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; gap: 5px; align-items: center;">
                                        <button class="btn btn-sm btn-primary" onclick="addToCRMFromMissedCall('${callee}')">
                                        ‚ûï CRM'e Ekle
                                    </button>
                                        <button class="btn btn-sm btn-info" onclick="showCallRecordsModal('${callee}')" title="G√∂r√º≈üme kayƒ±tlarƒ±nƒ± g√∂r√ºnt√ºle">
                                            üìû G√∂r√º≈ümeler
                                        </button>
                                        <div style="position: relative; display: inline-block; z-index: 10000;">
                                            <button class="btn btn-sm btn-secondary" onclick="toggleCallDropdown('${dropdownId}')" style="padding: 4px 10px;">
                                                ‚öôÔ∏è ƒ∞≈ülemler ‚ñº
                                            </button>
                                            <div id="${dropdownId}" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 99999; min-width: 180px; padding: 8px; margin-top: 4px;">
                                                <button class="btn btn-sm btn-secondary" onclick="sendMissedCallMessage('${callee}', 'M√º≈üteri'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left; margin-bottom: 5px;">
                                            üí¨ Mesaj G√∂nder
                                        </button>
                                                <div style="border-top: 1px solid #e0e0e0; margin: 5px 0;"></div>
                                                ${callDeleted ? 
                                                    `<button class="btn btn-sm btn-secondary" onclick="undeleteCall('${callee}', 'outgoing', '${actualCall.call_time}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left;">‚Ü©Ô∏è Geri Al</button>` :
                                                    `<button class="btn btn-sm btn-danger" onclick="deleteCall('${callee}', 'outgoing', '${actualCall.call_time}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left;">üóëÔ∏è Sil</button>`}
                                            </div>
                                        </div>
                                </div>
                            `;
                        }
                        
                // Checkbox i√ßin unique key - √∂zel karakterleri escape et
                const safeCallTime = actualCall.call_time ? actualCall.call_time.replace(/'/g, "\\'") : '';
                const safeCallee = callee ? callee.replace(/'/g, "\\'") : '';
                const callKey = `${callee}|${actualCall.call_time}`;
                const isChecked = selectedOutgoingCalls.has(callKey) ? 'checked' : '';
                
                // CRM badge (saƒü √ºst k√∂≈üe)
                const crmBadge = leadMatch ? `<div style="position: absolute; top: 8px; right: 8px; background: #1976d2; color: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">üìã CRM</div>` : '';
                        
                return `
                    <div style="position: relative; padding: 15px; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 8px; transition: transform 0.2s; display: flex; gap: 12px; align-items: flex-start;" onmouseover="this.style.transform='translateY(-2px)'; this.style.zIndex='100';" onmouseout="this.style.transform='translateY(0)'; this.style.zIndex='1';">
                        ${crmBadge}
                        <div style="padding-top: 2px;">
                            <input type="checkbox" class="outgoing-call-checkbox" value="${callKey}" onchange="toggleOutgoingCall(this, '${safeCallee}|${safeCallTime}')" ${isChecked} style="width: 20px; height: 20px; cursor: pointer; margin: 0;">
                        </div>
                        <div style="flex: 1;">
                            ${personInfo}
                            <div style="font-size: 14px; color: #333; font-weight: 500; margin-bottom: 6px;">üìû Aranan: ${formattedCallee}</div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 6px;">üì± Arayan: ${formattedCaller}</div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 4px;">üïê ${timeStr}</div>
                            <div style="font-size: 13px; color: ${statusColor}; font-weight: 600; margin-bottom: 4px;">
                                ${statusIcon} ${statusText}
                            </div>
                            <div style="font-size: 12px; color: #666;">‚è±Ô∏è S√ºre: ${durationStr}</div>
                            ${actionButtons}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Giden arama kartƒ± render hatasƒ±:', error);
                return `<div style="padding: 15px; background: #ffebee; border-radius: 8px;"><p style="color: #f44336;">‚ùå Kart y√ºklenemedi</p></div>`;
            }
        }
        
        // Cevapsƒ±z √ßaƒürƒ±lar i√ßin otomatik kontrol sistemi
        let missedCallsCheckInterval = null;
        let lastMissedCallsCount = -1; // -1 = hen√ºz kontrol edilmedi, ilk kontrolde bildirim g√∂nder
        
        // Not: Gizli √ßaƒürƒ± sistemi kaldƒ±rƒ±ldƒ± - artƒ±k sadece yerel silme var
        
        // Otomatik kontrol√º ba≈ülat
        async function startMissedCallsAutoCheck() {
            // Eƒüer Bulutfon aktif deƒüilse ba≈ülatma
            if (!clubSettings || !clubSettings.bulutfonEnabled || !clubSettings.bulutfonApiKey) {
                return;
            }
            
            console.log('‚è≥ Cevapsƒ±z √ßaƒürƒ± bildirimi sistemi ba≈ülatƒ±ldƒ±');
            
            // Varsa √∂nceki interval'i temizle
            if (missedCallsCheckInterval) {
                clearInterval(missedCallsCheckInterval);
            }
            
            // ‚úÖ ƒ∞lk kontrol√º hemen yap (sayfa a√ßƒ±lƒ±r a√ßƒ±lmaz)
            setTimeout(async () => {
                await checkForNewMissedCalls();
            }, 2000); // 2 saniye sonra (sayfa y√ºklenmesini bekle)
            
            // Her 1 dakikada bir kontrol et
            missedCallsCheckInterval = setInterval(async () => {
                await checkForNewMissedCalls();
            }, 1 * 60 * 1000); // 1 dakika
            
            console.log('‚úÖ Cevapsƒ±z √ßaƒürƒ±lar otomatik kontrol ba≈ülatƒ±ldƒ± (Her 1 dakikada bir)');
        }
        
        // Yeni cevapsƒ±z √ßaƒürƒ±larƒ± kontrol et
        async function checkForNewMissedCalls() {
            try {
                // ‚úÖ Cevapsƒ±z √ßaƒürƒ±larƒ± yeniden hesapla
                await renderIncomingCallsPage();
                
                // Toplam cevapsƒ±z sayƒ±sƒ±nƒ± al (SADECE tam cevapsƒ±z)
                const currentCount = window.totalUnansweredCount || 0;
                
                console.log(`üîç Kontrol: ≈ûu an ${currentCount} cevapsƒ±z, √∂nceki: ${lastMissedCallsCount}`);
                
                // Eƒüer sayƒ± artmƒ±≈üsa bildirim g√∂ster
                if (currentCount > lastMissedCallsCount && lastMissedCallsCount >= 0) {
                    const newCallsCount = currentCount - lastMissedCallsCount;
                    if (newCallsCount > 0) {
                        console.log(`üîî ${newCallsCount} yeni cevapsƒ±z √ßaƒürƒ± tespit edildi!`);
                        await showMissedCallNotification(newCallsCount);
                    }
                }
                
                lastMissedCallsCount = currentCount;
                
            } catch (error) {
                console.error('‚ùå Cevapsƒ±z √ßaƒürƒ± kontrol√º hatasƒ±:', error);
            }
        }
        
        // Sesli ve g√∂rsel bildirim g√∂ster
        async function showMissedCallNotification(count) {
            console.log(`üîî Bildirim g√∂steriliyor: ${count} yeni cevapsƒ±z √ßaƒürƒ±`);
            
            // G√∂rsel bildirim (Browser Notification API)
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    const notificationBody = count === 1 
                        ? '1 cevapsƒ±z √ßaƒürƒ±nƒ±z var! Hemen inceleyin.' 
                        : `${count} cevapsƒ±z √ßaƒürƒ±nƒ±z var! Hemen inceleyin.`;
                    
                    const notification = new Notification('üìµ Cevapsƒ±z √áaƒürƒ±!', {
                        body: notificationBody,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">üìµ</text></svg>',
                        tag: 'missed-calls-' + Date.now(),
                        requireInteraction: true,
                        silent: false
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        showSection('crm-incoming-calls', document.querySelector('.nav-btn[onclick*=\'crm-incoming-calls\']'));
                        notification.close();
                    };
                    
                    console.log('‚úÖ Browser bildirimi g√∂nderildi');
                } else if (Notification.permission === 'default') {
                    requestNotificationPermission();
                }
            }
            
            // Sesli bildirim
            await playNotificationSound();
            
            // Sayfa i√ßi bildirim (clickable alert) - √áOK DAHA BELƒ∞RGƒ∞N
            let alertMessage;
            if (count >= 3) {
                alertMessage = `üìµ ACELE! ${count} CEVAPSIZ √áAƒûRI! Hemen g√∂r√ºnt√ºlemek i√ßin tƒ±klayƒ±n.`;
            } else if (count === 1) {
                alertMessage = `üìµ 1 CEVAPSIZ √áAƒûRI! G√∂r√ºnt√ºlemek i√ßin tƒ±klayƒ±n.`;
            } else {
                alertMessage = `üìµ ${count} CEVAPSIZ √áAƒûRI! G√∂r√ºnt√ºlemek i√ßin tƒ±klayƒ±n.`;
            }
            
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${count >= 3 ? 'linear-gradient(135deg, #f44336 0%, #e91e63 100%)' : 'linear-gradient(135deg, #ff9800 0%, #ff5722 100%)'};
                color: white;
                padding: 25px 40px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.4);
                z-index: 10000;
                cursor: pointer;
                font-size: 18px;
                font-weight: 700;
                animation: bounceIn 0.5s ease-out;
                max-width: 450px;
                border: 3px solid white;
                text-align: center;
            `;
            alertDiv.textContent = alertMessage;
            alertDiv.onclick = () => {
                showSection('crm-incoming-calls', document.querySelector('.nav-btn[onclick*=\'crm-incoming-calls\']'));
                alertDiv.remove();
            };
            
            document.body.appendChild(alertDiv);
            
            // 15 saniye sonra otomatik kapat
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => alertDiv.remove(), 300);
                }
            }, 15000);
            
            console.log('‚úÖ Sayfa i√ßi bildirim g√∂sterildi');
        }
        
        // ‚úÖ Bildirim sesi √ßal (Web Audio API fonksiyonu satƒ±r 3886'da tanƒ±mlƒ±)
        
        // WhatsApp mesaj bildirimi g√∂ster
        async function showWhatsAppMessageNotification(count, lastSender = '', messageText = '', instanceName = '') {
            console.log(`üîî WhatsApp bildirimi g√∂steriliyor: ${count} yeni mesaj, g√∂nderen: ${lastSender}, mesaj: ${messageText}`);
            
            // G√∂rsel bildirim (Browser Notification API)
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    let notificationBody;
                    if (count === 1 && messageText) {
                        // Kimin kime yazdƒ±ƒüƒ±nƒ± g√∂ster
                        const receiverInfo = instanceName ? ` ‚Üí ${instanceName}` : '';
                        notificationBody = `${lastSender}${receiverInfo}:\n${messageText.substring(0, 100)}`;
                    } else if (count === 1) {
                        notificationBody = `${lastSender} mesaj g√∂nderdi`;
                    } else {
                        notificationBody = `${count} yeni WhatsApp mesajƒ± var!`;
                    }
                    
                    const notification = new Notification('üí¨ WhatsApp Mesajƒ±!', {
                        body: notificationBody,
                        icon: 'https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg',
                        tag: 'whatsapp-messages-' + Date.now(),
                        requireInteraction: false,
                        silent: false
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        showSection('whatsapp', document.querySelector('.nav-btn[onclick*=\'whatsapp\']'));
                        notification.close();
                    };
                    
                    console.log('‚úÖ WhatsApp browser bildirimi g√∂nderildi');
                } else if (Notification.permission === 'default') {
                    // ƒ∞lk mesaj geldiƒüinde izin iste
                    requestNotificationPermission();
                }
            }
            
            // Sesli bildirim - Hemen √ßal
            await playNotificationSound();
            
            // Sayfa i√ßi bildirim (clickable alert)
            let alertMessage;
            if (count === 1 && messageText) {
                const receiverInfo = instanceName ? ` ‚Üí ${instanceName}` : '';
                alertMessage = `üí¨ ${lastSender}${receiverInfo}: ${messageText.substring(0, 50)}... (Tƒ±klayƒ±n)`;
            } else if (count === 1) {
                alertMessage = `üí¨ ${lastSender} mesaj g√∂nderdi! (Tƒ±klayƒ±n)`;
            } else {
                alertMessage = `üí¨ ${count} YENƒ∞ WHATSAPP MESAJI! (Tƒ±klayƒ±n)`;
            }
            
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
                color: white;
                padding: 20px 30px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(37, 211, 102, 0.4);
                z-index: 100000;
                font-size: 18px;
                font-weight: bold;
                cursor: pointer;
                animation: slideInRight 0.5s ease-out, pulse 2s infinite;
                max-width: 400px;
                border: 3px solid white;
            `;
            
            alertDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 32px;">üí¨</div>
                    <div style="flex: 1;">${alertMessage}</div>
                </div>
            `;
            
            alertDiv.onclick = () => {
                showSection('whatsapp', document.querySelector('.nav-btn[onclick*=\'whatsapp\']'));
                alertDiv.remove();
            };
            
            document.body.appendChild(alertDiv);
            
            // 15 saniye sonra otomatik kapat
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.style.animation = 'slideOutRight 0.5s ease-in';
                    setTimeout(() => alertDiv.remove(), 500);
                }
            }, 15000);
            
            console.log('‚úÖ Sayfa i√ßi WhatsApp bildirimi g√∂sterildi');
        }
        
        // Browser bildirim izni iste ve Service Worker kaydet
        async function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                try {
                    // Kullanƒ±cƒ± ID'sini kontrol et
                    if (!currentUser || !currentUser.email) {
                        console.warn('‚ö†Ô∏è Kullanƒ±cƒ± bilgisi yok, bildirim izni atlanƒ±yor');
                        return;
                    }
                    
                    // Firebase'den kullanƒ±cƒ±nƒ±n bildirim izni durumunu kontrol et
                    const userId = currentUser.email.replace('@', '_').replace('.', '_');
                    const userDocRef = window.firebase.doc(window.db, 'users', userId);
                    const userDoc = await window.firebase.getDoc(userDocRef);
                    
                    const userData = userDoc.data();
                    const hasAsked = userData?.notificationPermissionAsked || false;
                    
                    if (!hasAsked) {
                        const permission = await Notification.requestPermission();
                        
                        // Firebase'e kaydet
                        await window.firebase.setDoc(
                            userDocRef,
                            {
                                email: currentUser.email,
                                notificationPermissionAsked: true,
                                notificationPermission: permission,
                                notificationPermissionDate: new Date().toISOString()
                            },
                            { merge: true }
                        );
                        
                    if (permission === 'granted') {
                        console.log('‚úÖ Bildirim izni verildi');
                            
                            // Service Worker kaydet (tarayƒ±cƒ± arka plandayken bildirim i√ßin)
                            if ('serviceWorker' in navigator) {
                                try {
                                    // Inline Service Worker olu≈ütur
                                    const swCode = `
                                        self.addEventListener('push', function(event) {
                                            const data = event.data ? event.data.json() : {};
                                            const title = data.title || 'Yeni Bildirim';
                                            const options = {
                                                body: data.body || '',
                                                icon: '/favicon.ico',
                                                badge: '/favicon.ico',
                                                vibrate: [200, 100, 200],
                                                data: data
                                            };
                                            event.waitUntil(
                                                self.registration.showNotification(title, options)
                                            );
                                        });
                                        
                                        self.addEventListener('notificationclick', function(event) {
                                            event.notification.close();
                                            event.waitUntil(
                                                clients.openWindow(event.notification.data.url || '/')
                                            );
                                        });
                                    `;
                                    
                                    const blob = new Blob([swCode], { type: 'application/javascript' });
                                    const swUrl = URL.createObjectURL(blob);
                                    
                                    const registration = await navigator.serviceWorker.register(swUrl);
                                    console.log('‚úÖ Service Worker kaydedildi:', registration);
                                } catch (error) {
                                    console.log('‚ö†Ô∏è Service Worker kaydedilemedi:', error);
                                }
                            }
                        } else if (permission === 'denied') {
                            console.log('‚ùå Bildirim izni reddedildi');
                        }
                    }
                } catch (error) {
                    console.error('Bildirim izni kontrol√º hatasƒ±:', error);
                }
            }
        }
        
        // CRM'e ekle (cevapsƒ±z √ßaƒürƒ±dan)
        window.addToCRMFromMissedCall = async function(phoneNumber) {
            // Telefonu formatla (05xxx formatƒ±na)
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            // ‚úÖ showSection kaldƒ±rƒ±ldƒ± - kullanƒ±cƒ± bulunduƒüu sayfada kalacak
            
            // Modal'ƒ± a√ß
                openAddLeadModal();
                
            // Telefonu doldur ve g√∂r√º≈üme kayƒ±tlarƒ±nƒ± y√ºkle
                setTimeout(() => {
                    const phoneInput = document.querySelector('#addLeadModal input[name="phone"]');
                    if (phoneInput) {
                        phoneInput.value = formattedPhone;
                        // Telefon kontrol√ºn√º tetikle
                        phoneInput.dispatchEvent(new Event('blur'));
                    }
                
                // G√∂r√º≈üme kayƒ±tlarƒ± sekmesi ekle - daha uzun timeout
                setTimeout(async () => {
                    console.log('üìû G√∂r√º≈üme kayƒ±tlarƒ± y√ºkleniyor...');
                    await addCallRecordsTabToModal(formattedPhone);
                }, 600);
            }, 300);
        };
        
        // Modal'a g√∂r√º≈üme kayƒ±tlarƒ± sekmesi ekle
        async function addCallRecordsTabToModal(phoneNumber) {
            try {
                const modal = document.getElementById('addLeadModal');
                if (!modal) {
                    console.log('‚ö†Ô∏è Modal bulunamadƒ±');
                    return;
                }
                
                // Modal i√ßeriƒüine sekme ekle
                const modalBody = modal.querySelector('.modal-body');
                if (!modalBody) {
                    console.log('‚ö†Ô∏è Modal body bulunamadƒ±');
                    return;
                }
                
                // Bulutfon kontrol√º
                if (!clubSettings || !clubSettings.bulutfonEnabled || !clubSettings.bulutfonApiKey) {
                    console.log('‚ö†Ô∏è Bulutfon entegrasyonu aktif deƒüil');
                    const form = modalBody.querySelector('#addLeadForm');
                    if (form) {
                        const existingCallRecords = modalBody.querySelector('[data-call-records]');
                        if (existingCallRecords) existingCallRecords.remove();
                        
                        const callRecordsDiv = document.createElement('div');
                        callRecordsDiv.setAttribute('data-call-records', 'true');
                        callRecordsDiv.innerHTML = `
                            <div style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 15px;">
                                <h4 style="color: #ff9800; margin-bottom: 10px;">üìû G√∂r√º≈üme Kayƒ±tlarƒ±</h4>
                                <div style="padding: 15px; background: #fff3e0; border-radius: 6px; border-left: 4px solid #ff9800;">
                                    <p style="color: #666; margin: 0; font-size: 13px;">Bulutfon entegrasyonu aktif deƒüil. G√∂r√º≈üme kayƒ±tlarƒ±nƒ± g√∂rmek i√ßin WhatsApp > Ayarlar > Bulutfon API'yi aktif edin.</p>
                                </div>
                            </div>
                        `;
                        form.parentNode.insertBefore(callRecordsDiv, form.nextSibling);
                    }
                    return;
                }
                
                // Y√ºkleniyor mesajƒ± g√∂ster
                const form = modalBody.querySelector('#addLeadForm');
                if (form) {
                    const existingCallRecords = modalBody.querySelector('[data-call-records]');
                    if (existingCallRecords) existingCallRecords.remove();
                    
                    const loadingDiv = document.createElement('div');
                    loadingDiv.setAttribute('data-call-records', 'true');
                    loadingDiv.innerHTML = `
                        <div style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 15px;">
                            <h4 style="color: #1976d2; margin-bottom: 10px;">üìû G√∂r√º≈üme Kayƒ±tlarƒ±</h4>
                            <div class="loading"><div class="spinner"></div><span>G√∂r√º≈üme kayƒ±tlarƒ± y√ºkleniyor...</span></div>
                        </div>
                    `;
                    form.parentNode.insertBefore(loadingDiv, form.nextSibling);
                }
                
                // Bulutfon'dan bu numaraya ait √ßaƒürƒ±larƒ± √ßek
                console.log(`üìû ${phoneNumber} i√ßin g√∂r√º≈üme kayƒ±tlarƒ± √ßekiliyor...`);
                const response = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${clubSettings.bulutfonApiKey}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`Bulutfon API hatasƒ±: HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const allRecords = Array.isArray(data) ? data : (data.cdrs || data.data || []);
                
                console.log(`üìä Toplam ${allRecords.length} arama kaydƒ± alƒ±ndƒ±`);
                
                // Bu telefon numarasƒ±na ait kayƒ±tlarƒ± filtrele - phonesMatch kullan
                const phoneRecords = allRecords.filter(record => {
                    return phonesMatch(record.caller, phoneNumber) || phonesMatch(record.callee, phoneNumber);
                });
                
                console.log(`üìû ${phoneNumber} i√ßin ${phoneRecords.length} g√∂r√º≈üme kaydƒ± bulundu`);
                
                // Sekme olu≈ütur - kayƒ±t yoksa da bilgi g√∂ster
                let callRecordsHtml = `
                    <div style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 15px;">
                        <h4 style="color: #1976d2; margin-bottom: 15px;">üìû G√∂r√º≈üme Kayƒ±tlarƒ± (${phoneRecords.length})</h4>
                `;
                
                if (phoneRecords.length === 0) {
                    callRecordsHtml += `
                        <div style="padding: 15px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                            <p style="color: #666; margin: 0; font-size: 13px;">Bu numara (${phoneNumber}) i√ßin Bulutfon sisteminde g√∂r√º≈üme kaydƒ± bulunamadƒ±.</p>
                            <p style="color: #888; margin: 5px 0 0 0; font-size: 12px;">üí° Kayƒ±tlar silinmi≈ü veya hen√ºz bu numarayla g√∂r√º≈üme yapƒ±lmamƒ±≈ü olabilir.</p>
                        </div>
                    `;
                } else {
                    callRecordsHtml += `<div style="max-height: 300px; overflow-y: auto;">`;
                
                phoneRecords.slice(0, 10).forEach(record => {
                    const callTime = new Date(record.call_time);
                    const timeStr = callTime.toLocaleString('tr-TR');
                    const direction = record.direction === 'IN' ? 'üì• Gelen' : 'üì§ Giden';
                    const duration = record.talking_seconds ? `${record.talking_seconds}s` : 'Cevapsƒ±z';
                    const wasAnswered = record.talking_seconds && parseInt(record.talking_seconds) > 0;
                    const statusColor = wasAnswered ? '#4caf50' : '#f44336';
                    
                const recordingBtn = (record.uuid && clubSettings && clubSettings.bulutfonApiKey) ?
                        `<button class="btn btn-sm btn-info" onclick="window.open('https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonRecordingProxy?apikey=${clubSettings.bulutfonApiKey}&uuid=${record.uuid}', '_blank')" title="Ses kaydƒ±nƒ± dinle">üéß Dinle</button>` :
                        '';
                    
                    callRecordsHtml += `
                        <div style="padding: 12px; background: #f5f5f5; border-left: 4px solid ${statusColor}; border-radius: 6px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${direction}</div>
                                    <div style="font-size: 13px; color: #666;">üïê ${timeStr}</div>
                                    <div style="font-size: 13px; color: ${statusColor}; font-weight: 600; margin-top: 4px;">${duration}</div>
                                </div>
                                <div>
                                    ${recordingBtn}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                if (phoneRecords.length > 10) {
                    callRecordsHtml += `<div style="text-align: center; color: #666; font-size: 13px; margin-top: 10px;">... ve ${phoneRecords.length - 10} kayƒ±t daha</div>`;
                }
                
                    callRecordsHtml += `</div>`;
                }
                
                callRecordsHtml += `</div>`;
                
                // Form'dan sonra ekle
                if (form) {
                    const existingCallRecords = modalBody.querySelector('[data-call-records]');
                    if (existingCallRecords) {
                        existingCallRecords.remove();
                    }
                    
                    const callRecordsDiv = document.createElement('div');
                    callRecordsDiv.setAttribute('data-call-records', 'true');
                    callRecordsDiv.innerHTML = callRecordsHtml;
                    form.parentNode.insertBefore(callRecordsDiv, form.nextSibling);
                }
                
            } catch (error) {
                console.error('‚ùå G√∂r√º≈üme kayƒ±tlarƒ± y√ºklenirken hata:', error);
                
                // Hata mesajƒ±nƒ± modal'da g√∂ster
                const modal = document.getElementById('addLeadModal');
                if (modal) {
                    const modalBody = modal.querySelector('.modal-body');
                    const form = modalBody?.querySelector('#addLeadForm');
                    if (form) {
                        const existingCallRecords = modalBody.querySelector('[data-call-records]');
                        if (existingCallRecords) existingCallRecords.remove();
                        
                        const errorDiv = document.createElement('div');
                        errorDiv.setAttribute('data-call-records', 'true');
                        errorDiv.innerHTML = `
                            <div style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 15px;">
                                <h4 style="color: #f44336; margin-bottom: 10px;">üìû G√∂r√º≈üme Kayƒ±tlarƒ±</h4>
                                <div style="padding: 15px; background: #ffebee; border-radius: 6px; border-left: 4px solid #f44336;">
                                    <p style="color: #c62828; margin: 0 0 5px 0; font-weight: 600;">‚ùå G√∂r√º≈üme kayƒ±tlarƒ± y√ºklenemedi</p>
                                    <p style="color: #666; margin: 0; font-size: 13px;">${error.message}</p>
                                    <p style="color: #888; margin: 5px 0 0 0; font-size: 12px;">üí° Bulutfon API baƒülantƒ±nƒ±zƒ± ve API key'inizi kontrol edin.</p>
                                </div>
                            </div>
                        `;
                        form.parentNode.insertBefore(errorDiv, form.nextSibling);
                    }
                }
            }
        }
        
        // CRM bilgilerini g√ºncelle (cevapsƒ±z √ßaƒürƒ±dan)
        window.updateCRMFromMissedCall = function(leadId) {
            // CRM sayfasƒ±na ge√ß
            showSection('crm', document.querySelector('.nav-btn[onclick*=\'crm\']'));
            
            // Kƒ±sa bir gecikme sonra customer detail'ƒ± a√ß
            setTimeout(() => {
                openCustomerDetail(leadId);
            }, 300);
        };
        
        // Telefon numarasƒ±nƒ± temizle ve formatla
        function cleanPhoneNumber(phone) {
            if (!phone) return '';
            // T√ºm bo≈üluklar, tire, parantez vb temizle - sadece rakamlar kalsƒ±n
            return phone.replace(/\D/g, '');
        }
        
        // Telefon numaralarƒ±nƒ± kar≈üƒ±la≈ütƒ±r - G√ú√áLENDƒ∞Rƒ∞LMƒ∞≈û VERSƒ∞YON
        function phonesMatch(phone1, phone2) {
            if (!phone1 || !phone2) return false;
            
            const clean1 = cleanPhoneNumber(phone1);
            const clean2 = cleanPhoneNumber(phone2);
            
            if (clean1.length < 10 || clean2.length < 10) return false;
            
            // Son 10 haneyi al (T√ºrkiye telefon numarasƒ± standardƒ±)
            const last10_1 = clean1.slice(-10);
            const last10_2 = clean2.slice(-10);
            
            return last10_1 === last10_2;
        }
        
        // Mevcut telefonu kontrol et ve √∂nerileri g√∂ster - M√ú≈ûTERƒ∞ Fƒ∞LTRESƒ∞ Gƒ∞Bƒ∞ G√ú√áL√ú
        window.checkExistingPhone = function(inputValue) {
            const messageDiv = document.getElementById('phone-check-message');
            if (!messageDiv) return;
            
            if (!inputValue || inputValue.trim().length < 3) {
                messageDiv.innerHTML = '';
                return;
            }
            
            // Benzer telefon numaralarƒ±nƒ± bul (phonesMatch kullanarak)
            const cleanInput = cleanPhoneNumber(inputValue);
            const matchingLeads = [];
            
            // Tam e≈üle≈üme kontrol√º (son 10 hane)
            const exactMatch = crmLeads.find(lead => phonesMatch(lead.phone, inputValue));
            
            if (exactMatch) {
                messageDiv.innerHTML = `
                    <div style="color: #f44336; background: #ffebee; padding: 8px; border-radius: 4px; border-left: 3px solid #f44336;">
                        <strong>‚ö†Ô∏è Uyarƒ±:</strong> Bu telefon numarasƒ± zaten kayƒ±tlƒ±!<br>
                        <strong>M√º≈üteri:</strong> ${exactMatch.fullName} | Tel: ${exactMatch.phone}<br>
                        <button class="btn btn-sm btn-primary" onclick="openCustomerDetail('${exactMatch.id}')" style="margin-top: 5px;">
                            üìã M√º≈üteriyi G√∂r√ºnt√ºle
                        </button>
                    </div>
                `;
                return;
            }
            
            // Kƒ±smi e≈üle≈ümeleri bul (en az 5 rakam e≈üle≈ümeli) - M√º≈üteri filtresi gibi
            if (cleanInput.length >= 5) {
                crmLeads.forEach(lead => {
                    const cleanLeadPhone = cleanPhoneNumber(lead.phone);
                    
                    // Her t√ºrl√º e≈üle≈üme: 
                    // 1. Girilen rakamlar lead telefonda ge√ßiyor mu?
                    // 2. Lead telefon girilen rakamlarƒ± i√ßeriyor mu?
                    if (cleanLeadPhone.includes(cleanInput) || cleanInput.includes(cleanLeadPhone)) {
                        if (!matchingLeads.find(l => l.id === lead.id)) {
                            matchingLeads.push(lead);
                        }
                    }
                });
            }
            
            if (matchingLeads.length > 0) {
                const suggestions = matchingLeads.slice(0, 5).map(lead => `
                    <div style="padding: 6px; margin: 4px 0; background: white; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e0e0e0;">
                        <div style="flex: 1;">
                            <strong>${lead.fullName}</strong><br>
                            <small style="color: #666;">${lead.phone}</small>
                        </div>
                        <button onclick="openCustomerDetail('${lead.id}'); event.stopPropagation();" style="padding: 4px 8px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                            A√ß
                        </button>
                    </div>
                `).join('');
                
                messageDiv.innerHTML = `
                    <div style="color: #ff9800; background: #fff3e0; padding: 8px; border-radius: 4px; border-left: 3px solid #ff9800;">
                        <strong>üí° ${matchingLeads.length} benzer numara bulundu:</strong>
                        ${suggestions}
                        ${matchingLeads.length > 5 ? `<div style="font-size: 11px; color: #666; margin-top: 5px;">ve ${matchingLeads.length - 5} tane daha...</div>` : ''}
                    </div>
                `;
            } else {
                messageDiv.innerHTML = '<div style="color: #4caf50; padding: 4px 0;">‚úÖ Bu telefon numarasƒ± kullanƒ±labilir</div>';
            }
        };
        
        // Ula≈üƒ±lamadƒ± olarak i≈üaretle VE mesaj g√∂nder
        window.markAsUnreachableWithMessage = async function(phoneNumber, timeStr) {
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            try {
                // WhatsApp cihazƒ±nƒ± kontrol et
                if (!defaultWhatsAppDevice) {
                    showAlert('‚ö†Ô∏è WhatsApp cihazƒ± yapƒ±landƒ±rƒ±lmamƒ±≈ü.', 'warning');
                    return;
                }
                
                // Mesaj ≈üablonu
                const clubName = clubSettings.clubName || 'Sporcum';
                const messageTemplate = `Merhaba,\n\n${clubName} olarak size ula≈ümaya √ßalƒ±≈ütƒ±k ancak ula≈üamadƒ±k.\n\nBize ${timeStr} tarihinde bir cevapsƒ±z √ßaƒürƒ±nƒ±z d√º≈üm√º≈üt√ºr.\n\nSizinle g√∂r√º≈ümek ve sorularƒ±nƒ±zƒ± yanƒ±tlamak isteriz. L√ºtfen uygun olduƒüunuzda bizi arayƒ±nƒ±z.\n\nTe≈üekk√ºrler,\n${clubName} Ekibi`;
                
                // Mesajƒ± kuyruƒüa ekle - CRM'e EKLEMƒ∞YORUZ, sadece mesaj g√∂nderiyoruz
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'messageQueue'),
                    {
                        clubId: currentClubId,
                        phone: formattedPhone,
                        message: messageTemplate,
                        deviceId: defaultWhatsAppDevice,
                        scheduledFor: new Date().toISOString(),
                        status: 'pending',
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser?.fullName || 'Admin',
                        type: 'unreachable_notification'
                    }
                );
                
                // ‚úÖ Ula≈üƒ±lamadƒ± olarak i≈üaretle (localStorage'a kaydet)
                const unreachableKey = `unreachable_${cleanPhone}_${timeStr}`;
                const unreachableCalls = JSON.parse(localStorage.getItem('unreachableCalls') || '{}');
                unreachableCalls[unreachableKey] = {
                    phone: cleanPhone,
                    timestamp: new Date().toISOString(),
                    timeStr: timeStr
                };
                localStorage.setItem('unreachableCalls', JSON.stringify(unreachableCalls));
                
                showAlert('‚úÖ "Ula≈üƒ±lamadƒ±" mesajƒ± kuyruƒüa eklendi. M√º≈üteri cevapsƒ±z √ßaƒürƒ±larda kalacak.', 'success');
                
                // Cevapsƒ±z √ßaƒürƒ±larƒ± yenile
                await renderMissedCalls();
                // Gelen aramalar sayfasƒ±nƒ± da yenile (eƒüer o sayfadaysak)
                if (document.getElementById('incoming-calls-list')) {
                    await renderIncomingCallsPage();
                }
            } catch (error) {
                console.error('Ula≈üƒ±lamadƒ± mesajƒ± g√∂nderme hatasƒ±:', error);
                showAlert('‚ùå ƒ∞≈ülem ba≈üarƒ±sƒ±z: ' + error.message, 'danger');
            }
        };
        
        // Ula≈üƒ±lamadƒ± olarak i≈üaretle (mesaj olmadan)
        window.markAsUnreachable = async function(phoneNumber, timeStr) {
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            const notes = `Ula≈üƒ±lamadƒ± - ${timeStr} tarihinde cevapsƒ±z √ßaƒürƒ±`;
            
            try {
                // CRM'e ekle - bran≈ü bilinmediƒüi i√ßin ula≈üƒ±lamadƒ± stat√ºs√ºnde kalsƒ±n
                const newLead = {
                    fullName: 'Ula≈üƒ±lamadƒ± - ' + formattedPhone,
                    phone: formattedPhone,
                    email: '',
                    branch: 'Belirsiz',
                    status: 'lost', // Kayƒ±p olarak i≈üaretle
                    source: 'Cevapsƒ±z √áaƒürƒ±',
                    notes: notes,
                    clubId: currentClubId,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    tags: ['Ula≈üƒ±lamadƒ±'],
                    history: [{
                        date: new Date().toISOString(),
                        action: 'Ula≈üƒ±lamadƒ± olarak i≈üaretlendi',
                        notes: notes,
                        user: currentUser?.fullName || 'Admin'
                    }]
                };
                
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'crmLeads'),
                    newLead
                );
                
                showAlert('‚úÖ "Ula≈üƒ±lamadƒ±" olarak i≈üaretlendi ve CRM\'e eklendi', 'success');
                
                // Cevapsƒ±z √ßaƒürƒ±larƒ± yenile
                await renderMissedCalls();
                
                // CRM'i g√ºncelle
                await loadData();
            } catch (error) {
                console.error('Ula≈üƒ±lamadƒ± i≈üaretleme hatasƒ±:', error);
                showAlert('‚ùå ƒ∞≈ülem ba≈üarƒ±sƒ±z: ' + error.message, 'danger');
            }
        };
        
        // Manuel olarak cevaplandƒ± i≈üaretle
        window.markMissedCallAsAnswered = async function(phoneNumber, leadId = null, memberId = null) {
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            const responseMethod = prompt('Nasƒ±l ileti≈üime ge√ßildi?\n\n1: WhatsApp\'tan Mesaj G√∂nderildi\n2: Y√ºz Y√ºze G√∂r√º≈ü√ºld√º\n3: Diƒüer\n\n(Not: Telefonla aramalar ve m√º≈üteri geri aramalarƒ± sistem tarafƒ±ndan otomatik takip edilir)', '1');
            
            if (!responseMethod) return;
            
            // Sadece 1, 2, 3 kabul et
            if (!['1', '2', '3'].includes(responseMethod)) {
                alert('‚ö†Ô∏è L√ºtfen 1, 2 veya 3 se√ßeneklerinden birini girin.');
                return;
            }
            
            const methodTexts = {
                '1': 'WhatsApp\'tan mesaj g√∂nderildi',
                '2': 'Y√ºz y√ºze g√∂r√º≈ü√ºld√º',
                '3': 'Diƒüer y√∂ntemle ileti≈üime ge√ßildi'
            };
            
            const methodText = methodTexts[responseMethod] || 'ƒ∞leti≈üime ge√ßildi';
            const now = new Date().toISOString();
            const notes = `Cevaplandƒ± - ${methodText}`;
            
            try {
                if (leadId) {
                    // CRM'de zaten var - sadece not ekle ve "Diƒüer" etiketine ta≈üƒ±
                    const leadRef = window.firebase.doc(window.db, 'crmLeads', leadId);
                    const leadDoc = await window.firebase.getDoc(leadRef);
                    
                    if (leadDoc.exists()) {
                        const lead = leadDoc.data();
                        const updatedHistory = lead.history || [];
                        updatedHistory.push({
                            date: now,
                            action: 'Cevapsƒ±z √ßaƒürƒ± cevaplandƒ±',
                            notes: methodText,
                            user: currentUser?.fullName || 'Admin'
                        });
                        
                        // ‚úÖ T√ºm bran≈ülarƒ±n etiketini "Diƒüer"e g√ºncelle
                        const updatedBranches = (lead.branches || []).map(branch => ({
                            ...branch,
                            selectedTag: 'Diƒüer'
                        }));
                        
                        await window.firebase.updateDoc(leadRef, {
                            updatedAt: now,
                            history: updatedHistory,
                            notes: (lead.notes ? lead.notes + '\n' : '') + notes,
                            branches: updatedBranches
                        });
                    }
                    
                    showAlert(`‚úÖ "${methodText}" olarak kaydedildi ve "Diƒüer" sekmesine ta≈üƒ±ndƒ±`, 'success');
                } else if (memberId) {
                    // √úye - sadece bilgi mesajƒ±
                    showAlert(`‚úÖ √úye "${methodText}" olarak not edildi`, 'success');
                } else {
                    // CRM'de yok - yeni kayƒ±t olu≈ütur ve "Diƒüer" etiketine ekle
                const newLead = {
                    fullName: formattedPhone,
                    phone: formattedPhone,
                    email: '',
                    branches: [{
                        branchId: 'general',
                        branchName: 'Genel',
                        selectedTag: 'Diƒüer', // ‚úÖ "Diƒüer" etiketi ile olu≈ütur
                        notes: methodText
                    }],
                    source: 'Cevapsƒ±z √áaƒürƒ± - Manuel',
                    notes: notes,
                    clubId: currentClubId,
                    createdAt: now,
                    updatedAt: now,
                    history: [{
                        date: now,
                        action: 'Manuel olarak cevaplandƒ± i≈üaretlendi',
                        notes: methodText,
                        user: currentUser?.fullName || 'Admin'
                    }]
                };
                
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'crmLeads'),
                    newLead
                );
                
                showAlert(`‚úÖ "${methodText}" olarak i≈üaretlendi ve CRM'e eklendi`, 'success');
                }
                
                // ‚úÖ localStorage'a cevaplandƒ± durumunu kaydet
                const answeredCalls = JSON.parse(localStorage.getItem('answeredMissedCalls') || '[]');
                if (!answeredCalls.includes(formattedPhone)) {
                    answeredCalls.push(formattedPhone);
                    localStorage.setItem('answeredMissedCalls', JSON.stringify(answeredCalls));
                }
                
                // ‚úÖ CRM verilerini yeniden y√ºkle (etiket deƒüi≈üikliƒüi i√ßin)
                await loadData();
                
                // Cevapsƒ±z √ßaƒürƒ±larƒ± yenile
                await renderMissedCalls();
                
                // Gelen aramalar sayfasƒ±nƒ± da yenile (eƒüer o sayfadaysak)
                if (document.getElementById('incoming-calls-list')) {
                    await renderIncomingCallsPage();
                    // ‚úÖ Otomatik olarak "Diƒüer" sekmesine ge√ß
                    setTimeout(() => {
                        if (window.switchIncomingCallTab) {
                            window.switchIncomingCallTab('other');
                        }
                    }, 500); // Sayfanƒ±n render edilmesi i√ßin kƒ±sa bir gecikme
                }
                
                // CRM sayfasƒ±nƒ± yenile (eƒüer o sayfadaysak)
                const currentSection = document.querySelector('.nav-btn.active')?.getAttribute('onclick')?.match(/showSection\('([^']+)'/)?.[1];
                if (currentSection === 'crm') {
                    console.log('üîÑ CRM sayfasƒ± yenileniyor (etiket deƒüi≈üikliƒüi i√ßin)...');
                    renderCRMDashboard();
                }
            } catch (error) {
                console.error('Cevaplandƒ± i≈üaretleme hatasƒ±:', error);
                showAlert('‚ùå ƒ∞≈ülem ba≈üarƒ±sƒ±z: ' + error.message, 'danger');
            }
        };
        
        // √áaƒürƒ±yƒ± sil (localStorage'da saklanƒ±yor - kalƒ±cƒ±)
        // Dropdown toggle fonksiyonu
        window.toggleCallDropdown = function(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;
            
            // Diƒüer a√ßƒ±k dropdown'larƒ± kapat ve z-index'lerini resetle
            document.querySelectorAll('[id^="dropdown-"]').forEach(d => {
                if (d.id !== dropdownId && d.style.display === 'block') {
                    d.style.display = 'none';
                    // Parent kartƒ±n z-index'ini resetle
                    let parentCard = d.closest('div[style*="position: relative"]');
                    if (!parentCard) parentCard = d.closest('div[style*="padding: 15px"]');
                    if (!parentCard) parentCard = d.closest('div[style*="padding: 12px"]');
                    if (parentCard) {
                        parentCard.style.cssText = parentCard.style.cssText.replace(/z-index:\s*\d+\s*!important;?/g, '');
                        parentCard.style.zIndex = '1';
                    }
                }
            });
            
            // Bu dropdown'ƒ± a√ß/kapat
            const isOpening = dropdown.style.display === 'none';
            dropdown.style.display = isOpening ? 'block' : 'none';
            
            // Parent kartƒ±n z-index'ini ayarla - !important ile zorla
            let parentCard = dropdown.closest('div[style*="position: relative"]');
            if (!parentCard) parentCard = dropdown.closest('div[style*="padding: 15px"]');
            if (!parentCard) parentCard = dropdown.closest('div[style*="padding: 12px"]');
            if (parentCard) {
                if (isOpening) {
                    parentCard.style.setProperty('z-index', '1000', 'important');
                } else {
                    parentCard.style.cssText = parentCard.style.cssText.replace(/z-index:\s*\d+\s*!important;?/g, '');
                    parentCard.style.zIndex = '1';
                }
            }
        };
        
        // Sayfa tƒ±klamasƒ±nda dropdown'larƒ± kapat
        document.addEventListener('click', function(e) {
            if (!e.target.closest('[onclick*="toggleCallDropdown"]') && !e.target.closest('[id^="dropdown-"]')) {
                document.querySelectorAll('[id^="dropdown-"]').forEach(d => {
                    if (d.style.display === 'block') {
                        d.style.display = 'none';
                        // Parent kartƒ±n z-index'ini resetle
                        const parentCard = d.closest('[style*="position: relative"]');
                        if (parentCard) parentCard.style.zIndex = '1';
                    }
                });
            }
        });
        
        // G√∂r√º≈üme kayƒ±tlarƒ± modalƒ±nƒ± g√∂ster (CRM'e kaydetmeden)
        window.showCallRecordsModal = async function(phoneNumber) {
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            const modalId = 'callRecordsViewModal';
            
            // Modal var mƒ± kontrol et, yoksa olu≈ütur
            let modal = document.getElementById(modalId);
            if (!modal) {
                const modalHtml = `
                    <div id="${modalId}" class="modal">
                        <div class="modal-content" style="max-width: 800px;">
                            <h3 style="margin-bottom: 20px;">üìû G√∂r√º≈üme Kayƒ±tlarƒ±</h3>
                            <div style="background: #f5f5f5; padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                                <div style="font-size: 14px; color: #666;">Telefon Numarasƒ±:</div>
                                <div style="font-size: 18px; font-weight: 600; color: #1976d2;" id="callRecordsPhoneDisplay">${formattedPhone}</div>
                            </div>
                            <div id="callRecordsModalContent" style="max-height: 500px; overflow-y: auto;">
                                <div class="loading"><div class="spinner"></div><span>G√∂r√º≈üme kayƒ±tlarƒ± y√ºkleniyor...</span></div>
                            </div>
                            <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                                <button class="btn btn-primary" onclick="addToCRMFromMissedCall('${formattedPhone}'); closeModal('${modalId}')">
                                    ‚ûï CRM'e Ekle
                                </button>
                                <button class="btn btn-secondary" onclick="closeModal('${modalId}')">Kapat</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                modal = document.getElementById(modalId);
            }
            
            // Telefon numarasƒ±nƒ± g√ºncelle
            const phoneDisplay = document.getElementById('callRecordsPhoneDisplay');
            if (phoneDisplay) phoneDisplay.textContent = formattedPhone;
            
            // Modal'ƒ± a√ß
            openModal(modalId);
            
            // G√∂r√º≈üme kayƒ±tlarƒ±nƒ± y√ºkle
            await renderCallRecords(formattedPhone, 'callRecordsModalContent');
        };
        
        window.deleteCall = function(phoneNumber, callType, callTime) {
            try {
                const deletedCall = {
                    phoneNumber: phoneNumber,
                    callType: callType, // 'incoming', 'outgoing'
                    callTime: callTime,
                    deletedAt: new Date().toISOString()
                };
                
                deletedCalls.push(deletedCall);
                saveDeletedCalls();
                
                showAlert('‚úÖ √áaƒürƒ± silindi', 'success');
                
                // ƒ∞lgili sayfayƒ± yenile
                if (callType === 'incoming') renderIncomingCallsPage();
                if (callType === 'outgoing') renderOutgoingCallsPage();
            } catch (error) {
                console.error('√áaƒürƒ± silme hatasƒ±:', error);
                showAlert('‚ùå √áaƒürƒ± silinemedi: ' + error.message, 'danger');
            }
        };
        
        // √áaƒürƒ±yƒ± geri getir
        window.undeleteCall = function(phoneNumber, callType, callTime) {
            try {
                deletedCalls = deletedCalls.filter(dc => 
                    !(dc.phoneNumber === phoneNumber && dc.callType === callType && dc.callTime === callTime)
                );
                saveDeletedCalls();
                
                showAlert('‚úÖ √áaƒürƒ± geri getirildi', 'success');
                
                // Sayfayƒ± yenile
                renderCurrentSection();
            } catch (error) {
                console.error('√áaƒürƒ± geri getirme hatasƒ±:', error);
                showAlert('‚ùå ƒ∞≈ülem ba≈üarƒ±sƒ±z: ' + error.message, 'danger');
            }
        };
        
        // √áaƒürƒ±nƒ±n silinmi≈ü olup olmadƒ±ƒüƒ±nƒ± kontrol et
        function isCallDeleted(phoneNumber, callType, callTime) {
            return deletedCalls.some(dc => 
                dc.phoneNumber === phoneNumber && 
                dc.callType === callType &&
                dc.callTime === callTime
            );
        }
        
        // Silinenleri g√∂ster/gizle toggle
        window.toggleShowDeletedCalls = function() {
            showDeletedCalls = !showDeletedCalls;
            
            // T√ºm toggle butonlarƒ±nƒ± g√ºncelle
            const buttons = [
                document.getElementById('toggleDeletedCallsIncomingBtn'),
                document.getElementById('toggleDeletedCallsOutgoingBtn')
            ];
            
            buttons.forEach(btn => {
                if (btn) {
                    btn.textContent = showDeletedCalls ? 'üëÅÔ∏è Silinenleri Sakla' : 'üóëÔ∏è Silinenleri G√∂ster';
                    btn.className = showDeletedCalls ? 'btn btn-sm btn-warning' : 'btn btn-sm btn-secondary';
                }
            });
            
            renderCurrentSection();
        };
        
        // Checkbox se√ßim fonksiyonlarƒ±
        window.toggleSelectAllIncoming = function(checkbox) {
            const checkboxes = document.querySelectorAll('.incoming-call-checkbox');
            selectedIncomingCalls.clear();
            
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                if (checkbox.checked) {
                    selectedIncomingCalls.add(cb.value);
                }
            });
            
            updateBulkDeleteButton('incoming');
        };
        
        window.toggleSelectAllOutgoing = function(checkbox) {
            const checkboxes = document.querySelectorAll('.outgoing-call-checkbox');
            selectedOutgoingCalls.clear();
            
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                if (checkbox.checked) {
                    selectedOutgoingCalls.add(cb.value);
                }
            });
            
            updateBulkDeleteButton('outgoing');
        };
        
        window.toggleIncomingCall = function(checkbox, callKey) {
            if (checkbox.checked) {
                selectedIncomingCalls.add(callKey);
            } else {
                selectedIncomingCalls.delete(callKey);
                document.getElementById('selectAllIncoming').checked = false;
            }
            updateBulkDeleteButton('incoming');
        };
        
        window.toggleOutgoingCall = function(checkbox, callKey) {
            if (checkbox.checked) {
                selectedOutgoingCalls.add(callKey);
            } else {
                selectedOutgoingCalls.delete(callKey);
                document.getElementById('selectAllOutgoing').checked = false;
            }
            updateBulkDeleteButton('outgoing');
        };
        
        function updateBulkDeleteButton(callType) {
            const selectedCount = callType === 'incoming' ? selectedIncomingCalls.size : selectedOutgoingCalls.size;
            const btnId = callType === 'incoming' ? 'bulkDeleteIncomingBtn' : 'bulkDeleteOutgoingBtn';
            const btn = document.getElementById(btnId);
            
            if (btn) {
                if (selectedCount > 0) {
                    btn.textContent = `üóëÔ∏è Se√ßilenleri Sil (${selectedCount})`;
                    btn.disabled = false;
                    btn.className = 'btn btn-sm btn-danger';
                } else {
                    btn.textContent = 'üóëÔ∏è Se√ßilenleri Sil';
                    btn.disabled = true;
                    btn.className = 'btn btn-sm btn-secondary';
                }
            }
        }
        
        // Toplu silme fonksiyonlarƒ± - Se√ßilenleri sil
        // Gelen aramalar i√ßin silme modunu a√ß
        window.showIncomingDeleteMode = function() {
            // Checkbox'larƒ± g√∂ster
            document.querySelectorAll('.incoming-call-checkbox').forEach(cb => {
                cb.style.display = 'block';
                cb.parentElement.style.display = 'block';
            });
            document.getElementById('selectAllIncomingLabel').style.display = 'flex';
            
            // Butonlarƒ± deƒüi≈ütir
            document.getElementById('showDeleteModeIncomingBtn').style.display = 'none';
            document.getElementById('confirmDeleteIncomingBtn').style.display = 'inline-block';
            document.getElementById('cancelDeleteIncomingBtn').style.display = 'inline-block';
        };
        
        // Gelen aramalar silmeyi iptal et
        window.cancelIncomingDeleteMode = function() {
            // Checkbox'larƒ± gizle
            document.querySelectorAll('.incoming-call-checkbox').forEach(cb => {
                cb.style.display = 'none';
                cb.parentElement.style.display = 'none';
                cb.checked = false;
            });
            document.getElementById('selectAllIncomingLabel').style.display = 'none';
            document.getElementById('selectAllIncoming').checked = false;
            
            // Se√ßimleri temizle
            selectedIncomingCalls.clear();
            
            // Butonlarƒ± deƒüi≈ütir
            document.getElementById('showDeleteModeIncomingBtn').style.display = 'inline-block';
            document.getElementById('confirmDeleteIncomingBtn').style.display = 'none';
            document.getElementById('cancelDeleteIncomingBtn').style.display = 'none';
        };
        
        // Gelen aramalarƒ± onayla ve sil
        window.confirmDeleteIncomingCalls = async function() {
            if (selectedIncomingCalls.size === 0) {
                showAlert('‚ö†Ô∏è L√ºtfen silmek istediƒüiniz aramalarƒ± se√ßin', 'warning');
                return;
            }
            
            if (!confirm(`Se√ßili ${selectedIncomingCalls.size} aramayƒ± kalƒ±cƒ± olarak silmek istediƒüinize emin misiniz?`)) {
                return;
            }
            
            await bulkDeleteIncomingCalls();
            cancelIncomingDeleteMode();
        };
        
        window.bulkDeleteIncomingCalls = async function() {
            if (selectedIncomingCalls.size === 0) {
                return;
            }
            
            try {
                // Se√ßili aramalarƒ± sil
                selectedIncomingCalls.forEach(callKey => {
                    const [phoneNumber, callTime] = callKey.split('|');
                    const deletedCall = {
                        phoneNumber: phoneNumber,
                        callType: 'incoming',
                        callTime: callTime,
                        deletedAt: new Date().toISOString()
                    };
                    deletedCalls.push(deletedCall);
                });
                
                saveDeletedCalls();
                const deletedCount = selectedIncomingCalls.size;
                selectedIncomingCalls.clear();
                
                showAlert(`‚úÖ ${deletedCount} gelen arama silindi`, 'success');
                renderIncomingCallsPage();
            } catch (error) {
                console.error('Toplu silme hatasƒ±:', error);
                showAlert('‚ùå Toplu silme ba≈üarƒ±sƒ±z: ' + error.message, 'danger');
            }
        };
        
        // Giden aramalar i√ßin silme modunu a√ß
        window.showOutgoingDeleteMode = function() {
            // Checkbox'larƒ± g√∂ster
            document.querySelectorAll('.outgoing-call-checkbox').forEach(cb => {
                cb.style.display = 'block';
                cb.parentElement.style.display = 'block';
            });
            document.getElementById('selectAllOutgoingLabel').style.display = 'flex';
            
            // Butonlarƒ± deƒüi≈ütir
            document.getElementById('showDeleteModeOutgoingBtn').style.display = 'none';
            document.getElementById('confirmDeleteOutgoingBtn').style.display = 'inline-block';
            document.getElementById('cancelDeleteOutgoingBtn').style.display = 'inline-block';
        };
        
        // Giden aramalar silmeyi iptal et
        window.cancelOutgoingDeleteMode = function() {
            // Checkbox'larƒ± gizle
            document.querySelectorAll('.outgoing-call-checkbox').forEach(cb => {
                cb.style.display = 'none';
                cb.parentElement.style.display = 'none';
                cb.checked = false;
            });
            document.getElementById('selectAllOutgoingLabel').style.display = 'none';
            document.getElementById('selectAllOutgoing').checked = false;
            
            // Se√ßimleri temizle
            selectedOutgoingCalls.clear();
            
            // Butonlarƒ± deƒüi≈ütir
            document.getElementById('showDeleteModeOutgoingBtn').style.display = 'inline-block';
            document.getElementById('confirmDeleteOutgoingBtn').style.display = 'none';
            document.getElementById('cancelDeleteOutgoingBtn').style.display = 'none';
        };
        
        // Giden aramalarƒ± onayla ve sil
        window.confirmDeleteOutgoingCalls = async function() {
            if (selectedOutgoingCalls.size === 0) {
                showAlert('‚ö†Ô∏è L√ºtfen silmek istediƒüiniz aramalarƒ± se√ßin', 'warning');
                return;
            }
            
            if (!confirm(`Se√ßili ${selectedOutgoingCalls.size} aramayƒ± kalƒ±cƒ± olarak silmek istediƒüinize emin misiniz?`)) {
                return;
            }
            
            await bulkDeleteOutgoingCalls();
            cancelOutgoingDeleteMode();
        };
        
        window.bulkDeleteOutgoingCalls = async function() {
            if (selectedOutgoingCalls.size === 0) {
                return;
            }
            
            try {
                // Se√ßili aramalarƒ± sil
                selectedOutgoingCalls.forEach(callKey => {
                    const [phoneNumber, callTime] = callKey.split('|');
                    const deletedCall = {
                        phoneNumber: phoneNumber,
                        callType: 'outgoing',
                        callTime: callTime,
                        deletedAt: new Date().toISOString()
                    };
                    deletedCalls.push(deletedCall);
                });
                
                saveDeletedCalls();
                const deletedCount = selectedOutgoingCalls.size;
                selectedOutgoingCalls.clear();
                
                showAlert(`‚úÖ ${deletedCount} giden arama silindi`, 'success');
                renderOutgoingCallsPage();
            } catch (error) {
                console.error('Toplu silme hatasƒ±:', error);
                showAlert('‚ùå Toplu silme ba≈üarƒ±sƒ±z: ' + error.message, 'danger');
            }
        };
        
        // Cevapsƒ±z √ßaƒürƒ± mesajƒ± g√∂nder
        window.sendMissedCallMessage = async function(phoneNumber, timeStr) {
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            // Mesaj ≈üablonu
            const clubName = clubSettings.clubName || 'Sporcum';
            const messageTemplate = `Merhaba,\n\n${clubName} olarak size ula≈ümaya √ßalƒ±≈ütƒ±k ancak ula≈üamadƒ±k.\n\nBize ${timeStr} tarihinde bir cevapsƒ±z √ßaƒürƒ±nƒ±z d√º≈üm√º≈üt√ºr.\n\nSizinle g√∂r√º≈ümek ve sorularƒ±nƒ±zƒ± yanƒ±tlamak isteriz. L√ºtfen uygun olduƒüunuzda bizi arayƒ±nƒ±z.\n\nTe≈üekk√ºrler,\n${clubName} Ekibi`;
            
            if (!confirm(`${formattedPhone} numarasƒ±na a≈üaƒüƒ±daki mesajƒ± g√∂ndermek istiyor musunuz?\n\n${messageTemplate}`)) {
                return;
            }
            
            try {
                // WhatsApp cihazƒ±nƒ± kontrol et
                if (!defaultWhatsAppDevice) {
                    showAlert('‚ö†Ô∏è WhatsApp cihazƒ± yapƒ±landƒ±rƒ±lmamƒ±≈ü. L√ºtfen ayarlardan WhatsApp entegrasyonunu yapƒ±landƒ±rƒ±n.', 'warning');
                    return;
                }
                
                // Mesajƒ± kuyruƒüa ekle
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'messageQueue'),
                    {
                        clubId: currentClubId,
                        phone: formattedPhone,
                        message: messageTemplate,
                        deviceId: defaultWhatsAppDevice,
                        scheduledFor: new Date().toISOString(),
                        status: 'pending',
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser?.fullName || 'Admin',
                        type: 'missed_call_notification'
                    }
                );
                
                showAlert('‚úÖ Mesaj kuyruƒüa eklendi ve en kƒ±sa s√ºrede g√∂nderilecek', 'success');
                
                // Cevapsƒ±z √ßaƒürƒ±larƒ± yenile
                await renderMissedCalls();
            } catch (error) {
                console.error('Mesaj g√∂nderme hatasƒ±:', error);
                showAlert('‚ùå Mesaj g√∂nderilemedi: ' + error.message, 'danger');
            }
        };
        
        // Bulutfon checkbox toggle
        window.addEventListener('DOMContentLoaded', function() {
            const bulutfonCheckbox = document.getElementById('bulutfonEnabled');
            const bulutfonSettings = document.getElementById('bulutfon-api-settings');
            
            if (bulutfonCheckbox && bulutfonSettings) {
                bulutfonCheckbox.addEventListener('change', function() {
                    bulutfonSettings.style.display = this.checked ? 'block' : 'none';
                });
                
                // Sayfa y√ºklendiƒüinde mevcut duruma g√∂re ayarla
                if (clubSettings && clubSettings.bulutfonEnabled) {
                    bulutfonCheckbox.checked = true;
                    bulutfonSettings.style.display = 'block';
                    if (clubSettings.bulutfonApiKey) {
                        document.getElementById('bulutfonApiKey').value = clubSettings.bulutfonApiKey;
                    }
                }
            }
            
            // ‚úÖ Webhook Checkbox Event Listener
            const webhookCheckbox = document.getElementById('webhookEnabled');
            const webhookSettings = document.getElementById('webhook-settings');
            
            if (webhookCheckbox && webhookSettings) {
                webhookCheckbox.addEventListener('change', function() {
                    webhookSettings.style.display = this.checked ? 'block' : 'none';
                });
                
                // Load webhook settings from Firebase
                loadWebhookSettings();
            }
        });
        
        // ‚úÖ Load Webhook Settings
        async function loadWebhookSettings() {
            try {
                const webhookDoc = await window.firebase.getDoc(
                    window.firebase.doc(window.db, 'webhooks', `contract_${currentClubId}`)
                );
                
                if (webhookDoc.exists()) {
                    const webhookData = webhookDoc.data();
                    const webhookCheckbox = document.getElementById('webhookEnabled');
                    const webhookSettings = document.getElementById('webhook-settings');
                    const webhookUrl = document.getElementById('webhookUrl');
                    
                    if (webhookCheckbox && webhookData.active) {
                        webhookCheckbox.checked = true;
                        if (webhookSettings) webhookSettings.style.display = 'block';
                    }
                    
                    if (webhookUrl && webhookData.url) {
                        webhookUrl.value = webhookData.url;
                    }
                }
            } catch (error) {
                console.error('Webhook ayarlarƒ± y√ºklenirken hata:', error);
            }
        }
        
        // ‚úÖ Test Webhook Function
        window.testWebhook = async function() {
            const webhookUrl = document.getElementById('webhookUrl').value;
            
            if (!webhookUrl || webhookUrl.trim() === '') {
                showAlert('‚ö†Ô∏è L√ºtfen √∂nce Webhook URL giriniz', 'warning');
                return;
            }
            
            try {
                showAlert('üîÑ Webhook test ediliyor...', 'info');
                
                const testPayload = {
                    event: 'contract_signed_test',
                    Ad_Soyad: 'Test Kullanƒ±cƒ±',
                    Telefon: '05551234567',
                    TC_Kimlik_No: '12345678901',
                    Adres: 'Test Adresi',
                    branch: 'test',
                    paymentPlan: [],
                    contractPdfBase64: 'data:application/pdf;base64,test',
                    preRegistrationId: 'test-123',
                    timestamp: new Date().toISOString(),
                    isTest: true
                };
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testPayload)
                });
                
                if (response.ok) {
                    showAlert(`‚úÖ Webhook test ba≈üarƒ±lƒ±! (${response.status} ${response.statusText})`, 'success');
                } else {
                    showAlert(`‚ö†Ô∏è Webhook yanƒ±t verdi ama hata kodu: ${response.status} ${response.statusText}`, 'warning');
                }
            } catch (error) {
                console.error('Webhook test hatasƒ±:', error);
                showAlert('‚ùå Webhook test ba≈üarƒ±sƒ±z! URL\'yi kontrol edin. CORS hatasƒ± olabilir.', 'danger');
            }
        };
        
        // Bulutfon baƒülantƒ±sƒ±nƒ± test et
        window.testBulutfonConnection = async function() {
            const apiKey = document.getElementById('bulutfonApiKey').value;
            
            if (!apiKey || apiKey.trim() === '') {
                showAlert('‚ö†Ô∏è L√ºtfen √∂nce API Key giriniz', 'warning');
                return;
            }
            
            try {
                showAlert('üîÑ Baƒülantƒ± test ediliyor...', 'info');
                
                const response = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${apiKey}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const recordCount = Array.isArray(data) ? data.length : (data.data?.length || 0);
                
                showAlert(`‚úÖ Baƒülantƒ± ba≈üarƒ±lƒ±! ${recordCount} adet g√∂r√º≈üme kaydƒ± bulundu.`, 'success');
            } catch (error) {
                console.error('Bulutfon test hatasƒ±:', error);
                showAlert('‚ùå Baƒülantƒ± ba≈üarƒ±sƒ±z! API Key\'inizi kontrol edin veya Bulutfon desteƒüi ile ileti≈üime ge√ßin.', 'danger');
            }
        };
        
        // Telefon numarasƒ±na tƒ±klayƒ±nca kopyala
        window.handlePhoneClick = function(event, phoneNumber) {
            event.preventDefault();
            event.stopPropagation();
            
            if (!phoneNumber) return;
            
            const message = `üìã ${formatPhoneDisplay(phoneNumber)} kopyalandƒ±!`;
            
            // Clipboard API ile kopyala
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(phoneNumber)
                    .then(() => {
                        showAlert(message, 'success');
                    })
                    .catch(err => {
                        console.error('Kopyalama hatasƒ±:', err);
                        // Fallback: Eski y√∂ntem
                        fallbackCopyToClipboard(phoneNumber, message);
                    });
            } else {
                // Eski tarayƒ±cƒ±lar i√ßin fallback
                fallbackCopyToClipboard(phoneNumber, message);
            }
        };
        
        function renderBranchDistribution() {
            const container = document.getElementById('branch-distribution');
            if (!container) return;
            
            const branchCounts = {};
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        const branchName = branches.find(b => b.id === br.branchId)?.name || 'Bilinmiyor';
                        branchCounts[branchName] = (branchCounts[branchName] || 0) + 1;
                    });
                }
            });
            
            const total = Object.values(branchCounts).reduce((a, b) => a + b, 0);
            const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a'];
            
            if (total === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">Hen√ºz bran≈ü verisi yok</p></div>';
                return;
            }
            
            container.innerHTML = Object.entries(branchCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([branchName, count], idx) => {
                    const percentage = ((count / total) * 100).toFixed(1);
                    const color = colors[idx % colors.length];
                    return `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="font-weight: 600; font-size: 14px;">${branchName}</span>
                                <span style="font-weight: 600; color: ${color};">${count} (${percentage}%)</span>
                            </div>
                            <div style="background: #f0f0f0; border-radius: 10px; height: 10px; overflow: hidden;">
                                <div style="background: ${color}; height: 100%; width: ${percentage}%; border-radius: 10px; transition: width 0.5s;"></div>
                            </div>
                        </div>
                    `;
                }).join('');
        }
        
        function renderTagDistribution() {
            const container = document.getElementById('tag-distribution');
            if (!container) return;
            
            const tagCounts = {};
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        if (br.selectedTag) {
                            tagCounts[br.selectedTag] = (tagCounts[br.selectedTag] || 0) + 1;
                        }
                        if (br.ageGroup === 'child' && br.children) {
                            br.children.forEach(c => {
                                if (c.selectedTag) {
                                    tagCounts[c.selectedTag] = (tagCounts[c.selectedTag] || 0) + 1;
                                }
                            });
                        }
                    });
                }
            });
            
            const total = Object.values(tagCounts).reduce((a, b) => a + b, 0);
            const colors = ['#f093fb', '#4facfe', '#43e97b', '#fa709a', '#667eea'];
            
            if (total === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">Hen√ºz etiket verisi yok</p></div>';
                return;
            }
            
            container.innerHTML = Object.entries(tagCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([tagName, count], idx) => {
                    const percentage = ((count / total) * 100).toFixed(1);
                    const color = colors[idx % colors.length];
                    return `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="font-weight: 600; font-size: 14px;">üè∑Ô∏è ${tagName}</span>
                                <span style="font-weight: 600; color: ${color};">${count} (${percentage}%)</span>
                            </div>
                            <div style="background: #f0f0f0; border-radius: 10px; height: 10px; overflow: hidden;">
                                <div style="background: ${color}; height: 100%; width: ${percentage}%; border-radius: 10px; transition: width 0.5s;"></div>
                            </div>
                        </div>
                    `;
                }).join('');
        }
        
        function renderAccumulationAnalysis() {
            const container = document.getElementById('accumulation-analysis');
            if (!container) return;
            
            // Hangi bran≈ü+etiket kombinasyonlarƒ±nda en √ßok birikme var
            const combinations = {};
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        const branchName = branches.find(b => b.id === br.branchId)?.name || 'Bilinmiyor';
                        const tag = br.selectedTag || 'Etiketsiz';
                        const key = `${branchName} - ${tag}`;
                        combinations[key] = (combinations[key] || 0) + 1;
                        
                        if (br.ageGroup === 'child' && br.children) {
                            br.children.forEach(c => {
                                const childTag = c.selectedTag || 'Etiketsiz';
                                const childKey = `${branchName} - ${childTag}`;
                                combinations[childKey] = (combinations[childKey] || 0) + 1;
                            });
                        }
                    });
                }
            });
            
            const sortedCombo = Object.entries(combinations)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            if (sortedCombo.length === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">Hen√ºz veri yok</p></div>';
                return;
            }
            
            const maxCount = sortedCombo[0][1];
            
            container.innerHTML = `
                <div style="display: grid; gap: 12px;">
                    ${sortedCombo.map(([combo, count]) => {
                        const percentage = ((count / maxCount) * 100);
                        return `
                            <div style="padding: 15px; background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border-radius: 10px; border-left: 4px solid #667eea;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 5px;">${combo}</div>
                                        <div style="background: #e3f2fd; border-radius: 10px; height: 8px; width: ${Math.max(percentage, 10)}px; max-width: 300px; transition: width 0.5s;"></div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 24px; font-weight: 700; color: #667eea;">${count}</div>
                                        <div style="font-size: 11px; color: #888;">M√º≈üteri</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // CRM Leads Listesi
        function renderCRMLeads() {
            const container = document.getElementById('crm-leads-list');
            if (!container) return;
            
            const statusFilter = document.getElementById('crm-status-filter')?.value || 'all';
            const branchFilter = document.getElementById('crm-branch-filter')?.value || 'all';
            
            let filteredLeads = crmLeads;
            
            if (statusFilter !== 'all') {
                filteredLeads = filteredLeads.filter(l => l.status === statusFilter);
            }
            
            if (branchFilter !== 'all') {
                filteredLeads = filteredLeads.filter(l => l.branch === branchFilter);
            }
            
            // ‚úÖ Ek filtreler buraya eklenebilir (m√º≈üteri filtrele, denemeler, etiketler)
            
            if (filteredLeads.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Kayƒ±t bulunamadƒ±</h3>
                        <p>Filtrelerinizi deƒüi≈ütirin veya yeni kayƒ±t ekleyin</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ad Soyad</th>
                            <th>Telefon</th>
                            <th>Bran≈ü</th>
                            <th>Durum</th>
                            <th>Kaynak</th>
                            <th>Deneme Tarihi</th>
                            <th>Olu≈üturma</th>
                            <th>ƒ∞≈ülemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredLeads.map(lead => {
                            const status = crmStatuses.find(s => s.id === lead.status);
                            const branch = branches.find(b => b.id === lead.branch);
                            const trialDateFormatted = lead.trialDate ? 
                                new Date(lead.trialDate).toLocaleString('tr-TR', { 
                                    year: 'numeric', month: '2-digit', day: '2-digit',
                                    hour: '2-digit', minute: '2-digit'
                                }) : '-';
                            const createdFormatted = new Date(lead.createdAt).toLocaleDateString('tr-TR');
                            
                            return `
                                <tr>
                                    <td><strong style="cursor: pointer; color: var(--primary-color); text-decoration: underline;" onclick="openCustomerDetail('${lead.id}')">${lead.fullName}</strong></td>
                                    <td><a href="#" class="phone-link" onclick="handlePhoneClick(event, '${lead.phone}')">${lead.phone}</a></td>
                                    <td>${branch ? branch.icon + ' ' + branch.name : '-'}</td>
                                    <td>
                                        <span style="background: ${status?.color}15; color: ${status?.color}; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                            ${status?.icon} ${status?.name}
                                        </span>
                                    </td>
                                    <td>${getSourceName(lead.source)}</td>
                                    <td>${trialDateFormatted}</td>
                                    <td>${createdFormatted}</td>
                                    <td>
                                        <button class="btn btn-sm btn-success" onclick="openCustomerDetail('${lead.id}')" title="Detay">üë§</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteLead('${lead.id}')" title="Sil">üóëÔ∏è</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // WhatsApp ile lead a√ß
        function openWhatsAppWithLead(leadId) {
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) return;
            
            // WhatsApp sayfasƒ±na ge√ß
            showSection('whatsapp', document.querySelector('.nav-btn[onclick*="whatsapp"]'));
            
            // Kƒ±sa bir gecikme ile lead'i se√ß (sayfa y√ºklenmesini beklemek i√ßin)
            setTimeout(() => {
                // WhatsApp contact'ƒ± bul veya olu≈ütur
                const normalizedPhone = lead.phone.replace(/\D/g, '');
                
                // Eƒüer contact listede varsa se√ß
                const contactElement = document.querySelector(`[data-phone="${normalizedPhone}"]`);
                if (contactElement) {
                    contactElement.click();
                } else {
                    // Yeni mesaj ba≈ülat
                    showToast(`üí¨ ${lead.fullName} ile WhatsApp mesajla≈ümasƒ± ba≈ülatƒ±lƒ±yor...`, 'info');
                }
            }, 500);
        }

        // ============================================
        // ‚úÖ CRM FILTER FUNCTIONS
        // ============================================
        
        // M√º≈üteri ya≈üƒ±nƒ± hesapla (doƒüum tarihinden)
        function getCustomerAge(lead) {
            if (!lead.branches || lead.branches.length === 0) return 999; // Bilinmeyen ya≈ü i√ßin b√ºy√ºk deƒüer
            
            let oldestAge = 0;
            
            lead.branches.forEach(branchData => {
                // Yeti≈ükin ya≈ü grubu i√ßin parentBirthDate'i kontrol et
                if (branchData.ageGroup === 'adult' && branchData.parentBirthDate) {
                    const birthDate = new Date(branchData.parentBirthDate);
                    const today = new Date();
                    const age = today.getFullYear() - birthDate.getFullYear();
                    const monthDiff = today.getMonth() - birthDate.getMonth();
                    const adjustedAge = (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) ? age - 1 : age;
                    if (adjustedAge > oldestAge) oldestAge = adjustedAge;
                }
                
                // √áocuk ya≈ü grubu i√ßin children array'indeki ya≈ü bilgisini kontrol et
                if (branchData.ageGroup === 'child' && branchData.children && branchData.children.length > 0) {
                    branchData.children.forEach(child => {
                        // √ñnce direkt age alanƒ±nƒ± kontrol et
                        if (child.age && !isNaN(child.age)) {
                            const childAge = parseInt(child.age);
                            if (childAge > oldestAge) oldestAge = childAge;
                        } 
                        // Yoksa birthDate'den hesapla
                        else if (child.birthDate) {
                            const birthDate = new Date(child.birthDate);
                            const today = new Date();
                            const age = today.getFullYear() - birthDate.getFullYear();
                            const monthDiff = today.getMonth() - birthDate.getMonth();
                            const adjustedAge = (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) ? age - 1 : age;
                            if (adjustedAge > oldestAge) oldestAge = adjustedAge;
                        }
                    });
                }
            });
            
            return oldestAge || 999; // Ya≈ü bulunamazsa b√ºy√ºk deƒüer d√∂nd√ºr
        }
        
        // M√º≈üterinin son i≈ülem tarihini al
        function getLastActionDate(lead) {
            let lastDate = null;
            
            // updatedAt varsa kullan
            if (lead.updatedAt) {
                lastDate = new Date(lead.updatedAt);
            }
            
            // createdAt varsa kar≈üƒ±la≈ütƒ±r
            if (lead.createdAt) {
                const createdDate = new Date(lead.createdAt);
                if (!lastDate || createdDate > lastDate) {
                    lastDate = createdDate;
                }
            }
            
            // History'deki en son tarihi bul
            if (lead.history && lead.history.length > 0) {
                lead.history.forEach(h => {
                    if (h.date) {
                        // T√ºrk√ße tarih formatƒ±nƒ± parse et (DD/MM/YYYY, HH:MM)
                        const dateParts = h.date.split(/[\s,/:]+/);
                        if (dateParts.length >= 5) {
                            const day = parseInt(dateParts[0]);
                            const month = parseInt(dateParts[1]) - 1;
                            const year = parseInt(dateParts[2]);
                            const hour = parseInt(dateParts[3]);
                            const minute = parseInt(dateParts[4]);
                            const historyDate = new Date(year, month, day, hour, minute);
                            
                            if (!lastDate || historyDate > lastDate) {
                                lastDate = historyDate;
                            }
                        }
                    }
                });
            }
            
            return lastDate;
        }
        
        // M√º≈üteri filtrelerini uygula
        window.applyCustomerFilters = function(exportMode = false) {
            const branchFilter = document.getElementById('filter-branch')?.value || 'all';
            const ageGroupFilter = document.getElementById('filter-age-group')?.value || 'all';
            const tagFilter = document.getElementById('filter-tag')?.value || 'all';
            const searchText = document.getElementById('filter-search')?.value.toLowerCase() || '';
            const dateStart = document.getElementById('filter-date-start')?.value || '';
            const dateEnd = document.getElementById('filter-date-end')?.value || '';
            
            // Telefon aramasƒ± i√ßin bo≈üluksuz versiyonu da hazƒ±rla
            const searchTextNoSpaces = searchText.replace(/\s/g, '');
            
            let filtered = [...crmLeads];
            
            // Bran≈ü filtresi - En az bir bran≈üƒ± e≈üle≈ümeli
            if (branchFilter !== 'all') {
                filtered = filtered.filter(l => {
                    if (!l.branches || l.branches.length === 0) return false;
                    return l.branches.some(b => b.branchId === branchFilter);
                });
            }
            
            // Ya≈ü grubu filtresi - Bran≈ü seviyesinde kontrol et
            if (ageGroupFilter !== 'all') {
                filtered = filtered.filter(l => {
                    if (!l.branches || l.branches.length === 0) return false;
                    return l.branches.some(b => b.ageGroup === ageGroupFilter);
                });
            }
            
            // Etiket filtresi - Bran≈ü ve √ßocuk etiketlerini kontrol et
            if (tagFilter !== 'all') {
                filtered = filtered.filter(l => {
                    if (!l.branches || l.branches.length === 0) return false;
                    return l.branches.some(b => {
                        // Bran≈ü etiketi kontrol√º (yeti≈ükinler i√ßin)
                        if (b.selectedTag === tagFilter) return true;
                        // √áocuk etiketleri kontrol√º
                        if (b.children && b.children.length > 0) {
                            return b.children.some(c => c.selectedTag === tagFilter);
                        }
                        return false;
                    });
                });
            }
            
            // Son ƒ∞≈ülem Tarihi Filtresi
            if (dateStart || dateEnd) {
                filtered = filtered.filter(l => {
                    const lastActionDate = getLastActionDate(l);
                    if (!lastActionDate) return false;
                    
                    // Sadece tarih kƒ±smƒ±nƒ± kar≈üƒ±la≈ütƒ±r (saat dahil etme)
                    const actionDateOnly = new Date(lastActionDate.getFullYear(), lastActionDate.getMonth(), lastActionDate.getDate());
                    
                    if (dateStart) {
                        const startDate = new Date(dateStart);
                        if (actionDateOnly < startDate) return false;
                    }
                    
                    if (dateEnd) {
                        const endDate = new Date(dateEnd);
                        if (actionDateOnly > endDate) return false;
                    }
                    
                    return true;
                });
            }
            
            // Arama filtresi - ƒ∞sim, telefon, veli ismi, √ßocuk isimlerinde ara
            if (searchText) {
                filtered = filtered.filter(l => {
                    // Telefon ve genel isim
                    if (l.fullName && l.fullName.toLowerCase().includes(searchText)) return true;
                    
                    // Telefon aramasƒ± - t√ºm rakam olmayan karakterleri temizleyerek ara
                    // Eƒüer arama metni sayƒ± i√ßeriyorsa telefon olarak deƒüerlendir
                    if (/\d/.test(searchText)) {
                        const cleanSearch = cleanPhoneNumber(searchText); // Sadece rakamlar
                        const cleanLeadPhone = cleanPhoneNumber(l.phone); // Sadece rakamlar
                        
                        // En az 3 haneli arama i√ßin kƒ±smi e≈üle≈üme
                        if (cleanSearch.length >= 3) {
                            // Aramanƒ±n telefonda ge√ßip ge√ßmediƒüini kontrol et
                            if (cleanLeadPhone.includes(cleanSearch)) return true;
                            
                            // Tam e≈üle≈üme kontrol√º (son 10 hane)
                            if (cleanSearch.length >= 10 && cleanLeadPhone.length >= 10) {
                                const last10Search = cleanSearch.slice(-10);
                                const last10Phone = cleanLeadPhone.slice(-10);
                                if (last10Search === last10Phone) return true;
                            }
                        }
                    }
                    
                    // Bran≈ülarda ara
                    if (l.branches && l.branches.length > 0) {
                        return l.branches.some(b => {
                            // Yeti≈ükin ismi
                            if (b.fullName && b.fullName.toLowerCase().includes(searchText)) return true;
                            // Veli ismi
                            if (b.parentName && b.parentName.toLowerCase().includes(searchText)) return true;
                            // √áocuk isimleri
                            if (b.children && b.children.length > 0) {
                                return b.children.some(c => c.name && c.name.toLowerCase().includes(searchText));
                            }
                            return false;
                        });
                    }
                    return false;
                });
            }
            
            // Sƒ±ralama uygula
            const sortOption = document.getElementById('filter-sort')?.value || 'date-desc';
            
            filtered.sort((a, b) => {
                switch(sortOption) {
                    case 'date-desc': // Son ƒ∞≈ülem Tarihi (Yeni ‚Üí Eski)
                        const dateA = getLastActionDate(a);
                        const dateB = getLastActionDate(b);
                        return (dateB?.getTime() || 0) - (dateA?.getTime() || 0);
                    
                    case 'date-asc': // Son ƒ∞≈ülem Tarihi (Eski ‚Üí Yeni)
                        const dateA2 = getLastActionDate(a);
                        const dateB2 = getLastActionDate(b);
                        return (dateA2?.getTime() || 0) - (dateB2?.getTime() || 0);
                    
                    case 'age-desc': // Ya≈ü (B√ºy√ºkten K√º√ß√ºƒüe)
                        const ageA = getCustomerAge(a);
                        const ageB = getCustomerAge(b);
                        return ageB - ageA;
                    
                    case 'age-asc': // Ya≈ü (K√º√ß√ºkten B√ºy√ºƒüe)
                        const ageA2 = getCustomerAge(a);
                        const ageB2 = getCustomerAge(b);
                        return ageA2 - ageB2;
                    
                    case 'name-asc': // ƒ∞sim (A ‚Üí Z)
                        return (a.fullName || '').localeCompare(b.fullName || '', 'tr');
                    
                    case 'name-desc': // ƒ∞sim (Z ‚Üí A)
                        return (b.fullName || '').localeCompare(a.fullName || '', 'tr');
                    
                    default:
                        return 0;
                }
            });
            
            // Export mode i√ßin direkt veriyi d√∂nd√ºr
            if (exportMode) {
                return filtered;
            }
            
            // Normal mode: ƒ∞statistikleri g√ºncelle ve listeyi render et
            updateFilterStats(filtered);
            renderFilteredCustomers(filtered);
        };
        
        // Filtrelenmi≈ü m√º≈üteri istatistiklerini g√ºncelle
        function updateFilterStats(filtered) {
            document.getElementById('total-filtered').textContent = filtered.length;
            document.getElementById('new-filtered').textContent = filtered.filter(l => l.status === 'new').length;
            document.getElementById('trial-filtered').textContent = filtered.filter(l => l.status === 'trial').length;
            document.getElementById('converted-filtered').textContent = filtered.filter(l => l.status === 'converted').length;
        }
        
        // Filtrelenmi≈ü m√º≈üterileri listele
        function renderFilteredCustomers(filtered) {
            const container = document.getElementById('filtered-customers-list');
            if (!container) return;
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>M√º≈üteri bulunamadƒ±</h3>
                        <p>Filtrelerinizi deƒüi≈ütirerek yeniden deneyin</p>
                    </div>
                `;
                return;
            }
            
            // Status'a g√∂re renk atama
            const statusColors = {
                'new': { bg: '#e3f2fd', border: '#2196F3', text: '#1976D2' },
                'trial': { bg: '#f3e5f5', border: '#9C27B0', text: '#7B1FA2' },
                'converted': { bg: '#e8f5e9', border: '#4CAF50', text: '#388E3C' },
                'lost': { bg: '#ffebee', border: '#f44336', text: '#d32f2f' },
                'default': { bg: '#fff3e0', border: '#FF9800', text: '#F57C00' }
            };
            
            container.innerHTML = filtered.map(customer => {
                // Status rengi belirle
                const statusColor = statusColors[customer.status] || statusColors['default'];
                
                // Bran≈ü bilgilerini kompakt listele
                const branchesInfo = [];
                if (customer.branches && customer.branches.length > 0) {
                    customer.branches.forEach(branchData => {
                        const branch = branches.find(b => b.id === branchData.branchId);
                        const branchIcon = branch ? branch.icon : 'üéØ';
                        const branchName = branch ? branch.name : 'Bilinmeyen';
                        
                        if (branchData.ageGroup === 'adult') {
                            const tag = branchData.selectedTag || 'Aranmadƒ±';
                            branchesInfo.push(`<div style="display: inline-flex; align-items: center; margin: 2px 4px 2px 0; padding: 4px 8px; background: rgba(255,255,255,0.7); border-radius: 12px; font-size: 10px; border: 1px solid rgba(0,0,0,0.08);">
                                ${branchIcon} <strong style="margin: 0 4px;">${branchName}</strong> <span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 8px; margin-right: 4px;">üë®</span> <span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 8px;">${tag}</span>
                            </div>`);
                        } else if (branchData.ageGroup === 'child' && branchData.children) {
                            branchData.children.forEach(child => {
                                const childTag = child.selectedTag || 'Aranmadƒ±';
                                const childAgeInfo = child.age ? ` (${child.age} ya≈ü)` : '';
                                const veliName = branchData.parentName || 'Belirtilmemi≈ü';
                                const displayText = `√ñƒürenci: ${child.name}${childAgeInfo} / Veli: ${veliName}`;
                                branchesInfo.push(`<div style="display: inline-flex; align-items: center; margin: 2px 4px 2px 0; padding: 4px 8px; background: rgba(255,255,255,0.7); border-radius: 12px; font-size: 10px; border: 1px solid rgba(0,0,0,0.08);">
                                    ${branchIcon} <strong style="margin: 0 4px;">${branchName}</strong> <span style="background: #FFC107; color: white; padding: 2px 6px; border-radius: 8px; margin-right: 4px; font-weight: 600;">${displayText}</span> <span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 8px;">${childTag}</span>
                                </div>`);
                            });
                        }
                    });
                }
                
                const branchesHtml = branchesInfo.length > 0 ? branchesInfo.join('') : '<div style="font-size: 11px; color: #999; padding: 4px 0;">Bran≈ü yok</div>';
                
                // Son i≈ülem tarihi
                const lastActionDate = getLastActionDate(customer);
                let lastActionStr = '';
                if (lastActionDate) {
                    const now = new Date();
                    const diffMs = now - lastActionDate;
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 0) {
                        lastActionStr = 'Bug√ºn';
                    } else if (diffDays === 1) {
                        lastActionStr = 'D√ºn';
                    } else if (diffDays < 7) {
                        lastActionStr = `${diffDays} g√ºn √∂nce`;
                    } else if (diffDays < 30) {
                        lastActionStr = `${Math.floor(diffDays / 7)} hafta √∂nce`;
                    } else {
                        lastActionStr = lastActionDate.toLocaleDateString('tr-TR');
                    }
                }
                
                // Status badge
                const statusLabels = {
                    'new': 'üÜï Yeni',
                    'trial': 'üéæ Deneme',
                    'converted': '‚úÖ √úye Oldu',
                    'lost': '‚ùå Kayƒ±p'
                };
                const statusLabel = statusLabels[customer.status] || 'üìã M√º≈üteri';
                
                return `
                    <div class="filtered-customer-item" style="cursor: pointer; padding: 15px; margin-bottom: 10px; background: ${statusColor.bg}; border-radius: 10px; border-left: 5px solid ${statusColor.border}; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.08);" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.12)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.08)'; this.style.transform='translateY(0)'" onclick="openCustomerDetail('${customer.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-weight: 600; font-size: 14px; color: #333;">${customer.fullName || customer.phone}</div>
                            <div style="background: ${statusColor.border}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">${statusLabel}</div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                            üìû <span onclick="event.stopPropagation()" style="cursor: pointer; display: inline-flex; gap: 6px; align-items: center;">
                                <span onclick="copyToClipboard('${customer.phone}', 'Telefon numarasƒ± kopyalandƒ±')" style="padding: 3px 8px; background: rgba(255,255,255,0.8); border-radius: 4px; transition: all 0.2s; border: 1px solid rgba(0,0,0,0.1);" onmouseover="this.style.background='rgba(255,255,255,1)'" onmouseout="this.style.background='rgba(255,255,255,0.8)'" title="Kopyala">${customer.phone} üìã</span>
                                <a href="tel:${customer.phone}" style="padding: 3px 8px; background: rgba(76,175,80,0.1); border-radius: 4px; text-decoration: none; color: #4CAF50; transition: all 0.2s; border: 1px solid rgba(76,175,80,0.2);" onmouseover="this.style.background='rgba(76,175,80,0.2)'" onmouseout="this.style.background='rgba(76,175,80,0.1)'" title="Ara">üìû</a>
                            </span>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 4px; margin-bottom: 8px;">
                            ${branchesHtml}
                        </div>
                        ${lastActionStr ? `<div style="font-size: 11px; color: ${statusColor.text}; font-weight: 500;">üïê Son i≈ülem: ${lastActionStr}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Filtreleri temizle
        window.clearCRMFilters = function() {
            document.getElementById('filter-branch').value = 'all';
            document.getElementById('filter-age-group').value = 'all';
            document.getElementById('filter-tag').value = 'all';
            document.getElementById('filter-search').value = '';
            document.getElementById('filter-date-start').value = '';
            document.getElementById('filter-date-end').value = '';
            document.getElementById('filter-sort').value = 'date-desc'; // Sƒ±ralamayƒ± varsayƒ±lana d√∂nd√ºr
            
            // Listeyi temizle
            document.getElementById('filtered-customers-list').innerHTML = `
                <div class="empty-state">
                    <h3>Filtre uygulayƒ±n</h3>
                    <p>Yukarƒ±daki filtrelerden m√º≈üterileri se√ßin</p>
                </div>
            `;
            
            // ƒ∞statistikleri sƒ±fƒ±rla
            document.getElementById('total-filtered').textContent = '0';
            document.getElementById('new-filtered').textContent = '0';
            document.getElementById('trial-filtered').textContent = '0';
            document.getElementById('converted-filtered').textContent = '0';
        };
        
        // Filtrelenmi≈ü m√º≈üterileri dƒ±≈üa aktar
        window.exportFilteredCustomers = function() {
            // Filtre uygula
            const filtered = applyCustomerFilters(true); // true = export mode
            
            if (!filtered || filtered.length === 0) {
                alert('Dƒ±≈üa aktarƒ±lacak m√º≈üteri bulunamadƒ±! √ñnce filtre uygulayƒ±n.');
                return;
            }
            
            // CSV olu≈ütur
            const csvRows = [
                ['Telefon', 'Ad Soyad', 'Bran≈ü', 'Ya≈ü Grubu', 'Etiket', 'Veli/√ñƒürenci', 'Ya≈ü', 'Kaynak', 'Olu≈üturma Tarihi']
            ];
            
            filtered.forEach(customer => {
                if (customer.branches && customer.branches.length > 0) {
                    customer.branches.forEach(branchData => {
                        const branch = branches.find(b => b.id === branchData.branchId);
                        const branchName = branch ? branch.name : 'Bilinmeyen';
                        
                        if (branchData.ageGroup === 'adult') {
                            csvRows.push([
                                customer.phone,
                                customer.fullName || branchData.fullName || '',
                                branchName,
                                'Yeti≈ükin',
                                branchData.selectedTag || '',
                                branchData.fullName || '',
                                '',
                                getSourceName(customer.source || 'other'),
                                customer.createdAt ? new Date(customer.createdAt).toLocaleDateString('tr-TR') : ''
                            ]);
                        } else if (branchData.ageGroup === 'child') {
                            if (branchData.children && branchData.children.length > 0) {
                                branchData.children.forEach(child => {
                                    csvRows.push([
                                        customer.phone,
                                        branchData.parentName || '',
                                        branchName,
                                        '√áocuk',
                                        child.selectedTag || '',
                                        child.name || '',
                                        child.age || '',
                                        getSourceName(customer.source || 'other'),
                                        customer.createdAt ? new Date(customer.createdAt).toLocaleDateString('tr-TR') : ''
                                    ]);
                                });
                            } else {
                                csvRows.push([
                                    customer.phone,
                                    branchData.parentName || '',
                                    branchName,
                                    '√áocuk',
                                    branchData.selectedTag || '',
                                    '',
                                    '',
                                    getSourceName(customer.source || 'other'),
                                    customer.createdAt ? new Date(customer.createdAt).toLocaleDateString('tr-TR') : ''
                                ]);
                            }
                        }
                    });
                } else {
                    csvRows.push([
                        customer.phone,
                        customer.fullName || '',
                        '',
                        '',
                        '',
                        '',
                        '',
                        getSourceName(customer.source || 'other'),
                        customer.createdAt ? new Date(customer.createdAt).toLocaleDateString('tr-TR') : ''
                    ]);
                }
            });
            
            // BOM ekleyerek UTF-8 desteƒüi saƒüla
            const csvContent = '\ufeff' + csvRows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `musteriler_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showAlert('‚úÖ M√º≈üteriler dƒ±≈üa aktarƒ±ldƒ±!', 'success');
        };

        // Ortak g√∂r√º≈üme kayƒ±tlarƒ± render fonksiyonu (√ºyeler ve CRM detaylarƒ± i√ßin)
        window.renderCallRecords = async function(phoneNumber, containerId) {
            try {
                const container = document.getElementById(containerId);
                if (!container) return;

                container.innerHTML = '<div class="loading"><div class="spinner"></div><span>G√∂r√º≈üme kayƒ±tlarƒ± y√ºkleniyor...</span></div>';

                if (!clubSettings || !clubSettings.bulutfonApiKey) {
                    container.innerHTML = '<p style="color:#999; padding: 12px;">Bulutfon API anahtarƒ± tanƒ±mlƒ± deƒüil.</p>';
                    return;
                }

                const res = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${clubSettings.bulutfonApiKey}`, { headers: { 'Content-Type': 'application/json' } });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const records = Array.isArray(data) ? data : (data.cdrs || data.data || []);

                const phoneRecords = records.filter(r => phonesMatch(r.caller, phoneNumber) || phonesMatch(r.callee, phoneNumber));

                if (phoneRecords.length === 0) {
                    container.innerHTML = '<p style="color:#999; padding: 12px;">Bu numara i√ßin g√∂r√º≈üme kaydƒ± bulunamadƒ±.</p>';
                    return;
                }

                const html = phoneRecords.slice(0, 20).map(record => {
                    const callTime = new Date(record.call_time);
                    callTime.setHours(callTime.getHours() - 3); // ‚úÖ UTC'den T√ºrkiye saatine √ßevir
                    const timeStr = callTime.toLocaleString('tr-TR');
                    const direction = record.direction === 'IN' ? 'üì• Gelen' : 'üì§ Giden';
                    const duration = record.talking_seconds ? `${record.talking_seconds}s` : 'Cevapsƒ±z';
                    const wasAnswered = record.talking_seconds && parseInt(record.talking_seconds) > 0;
                    const statusColor = wasAnswered ? '#4caf50' : '#f44336';
                    const recordingBtn = (record.uuid && clubSettings && clubSettings.bulutfonApiKey) ?
                        `<button class="btn btn-sm btn-info" onclick="window.open('https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonRecordingProxy?apikey=${clubSettings.bulutfonApiKey}&uuid=${record.uuid}', '_blank')" title="Ses kaydƒ±nƒ± dinle">üéß Dinle</button>` : '';
                    return `
                        <div style="padding: 12px; background: #f5f5f5; border-left: 4px solid ${statusColor}; border-radius: 6px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${direction}</div>
                                    <div style="font-size: 13px; color: #666;">üïê ${timeStr}</div>
                                    <div style="font-size: 13px; color: ${statusColor}; font-weight: 600; margin-top: 4px;">${duration}</div>
                                </div>
                                <div>${recordingBtn}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `<div>${html}</div>`;
            } catch (err) {
                const container = document.getElementById(containerId);
                if (container) container.innerHTML = '<p style="color:#c00; padding: 12px;">G√∂r√º≈üme kayƒ±tlarƒ± y√ºklenemedi.</p>';
                console.error('renderCallRecords error:', err);
            }
        };

        // ============================================
        // ‚úÖ CRM TRIALS FUNCTIONS
        // ============================================
        
        // Denemeleri render et
        window.renderTrials = function() {
            const container = document.getElementById('trials-list');
            if (!container) {
                console.log('‚ùå trials-list container bulunamadƒ±!');
                return;
            }
            
            const branchFilter = document.getElementById('trial-branch-filter')?.value || 'all';
            const searchText = document.getElementById('trial-search')?.value.toLowerCase() || '';
            
            console.log('üéæ renderTrials √ßaƒürƒ±ldƒ±, crmLeads:', crmLeads.length);
            
            // Deneme tarihi olan her ki≈üiyi (yeti≈ükin veya √ßocuk) topla
            // Etiket deƒüi≈üse bile deneme tarihi varsa listede kalmalƒ± (manuel kaldƒ±rma ile silinir)
            let trials = [];
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(branchData => {
                        // Yeti≈ükin i√ßin bran≈ü seviyesinde kontrol - sadece denemeDate kontrol et
                        if (branchData.ageGroup === 'adult' && branchData.denemeDate) {
                            trials.push({
                                lead,
                                branchData,
                                childData: null,
                                trialStatus: branchData.trialStatus || 'scheduled'
                            });
                        }
                        // √áocuklar i√ßin her √ßocuƒüu ayrƒ± kontrol et - sadece denemeDate kontrol et
                        else if (branchData.ageGroup === 'child' && branchData.children && branchData.children.length > 0) {
                            branchData.children.forEach(childData => {
                                if (childData.denemeDate) {
                                    trials.push({
                                        lead,
                                        branchData,
                                        childData,
                                        trialStatus: childData.trialStatus || 'scheduled'
                                    });
                                }
                            });
                        }
                    });
                }
            });
            
            console.log('üéæ Bulunan deneme sayƒ±sƒ±:', trials.length);
            
            // Filtreleri uygula
            if (branchFilter !== 'all') {
                trials = trials.filter(t => t.branchData.branchId === branchFilter);
            }
            if (searchText) {
                trials = trials.filter(t => {
                    const parentName = t.branchData.parentName || '';
                    const childName = t.childData ? t.childData.name : '';
                    const adultName = t.branchData.fullName || lead.fullName || '';
                    const searchNoSpaces = searchText.replace(/\s/g, '');
                    
                    return parentName.toLowerCase().includes(searchText) ||
                           childName.toLowerCase().includes(searchText) ||
                           adultName.toLowerCase().includes(searchText) ||
                           t.lead.phone.includes(searchText) ||
                           t.lead.phone.replace(/\s/g, '').includes(searchNoSpaces);
                });
            }
            
            // ƒ∞statistikleri g√ºncelle
            updateTrialStats(trials);
            
            if (trials.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Deneme dersi bulunamadƒ±</h3>
                        <p>"Denemeye Gelecek" etiketine sahip m√º≈üteriler burada g√∂r√ºn√ºr</p>
                    </div>
                `;
                return;
            }
            
            // Tarihe g√∂re gruplandƒ±r ve sƒ±rala
            const trialsByDate = {};
            const dateColorMap = {};
            const dateBranchMap = {}; // Bran≈ü bilgisini saklamak i√ßin
            
            // ‚úÖ Bran≈üa g√∂re renk ve stil tanƒ±mlarƒ±
            const branchStyles = {
                'tenis': {
                    colors: ['#fff9e6', '#fff3cc', '#ffe4b3', '#ffd699', '#ffc780'], // Sarƒ± tonlarƒ±
                    emoji: 'üéæ',
                    borderColor: '#ffc107'
                },
                'yuzme': {
                    colors: ['#e3f2fd', '#bbdefb', '#90caf9', '#64b5f6', '#42a5f5'], // Mavi tonlarƒ±
                    emoji: 'üèä',
                    borderColor: '#2196f3'
                },
                'default': {
                    colors: ['#f3e5f5', '#e1bee7', '#ce93d8', '#ba68c8', '#ab47bc'], // Mor tonlarƒ±
                    emoji: 'üéØ',
                    borderColor: '#9c27b0'
                }
            };
            
            trials.forEach(trial => {
                const trialDate = trial.childData ? new Date(trial.childData.denemeDate) : new Date(trial.branchData.denemeDate);
                const dateTimeStr = trialDate.toLocaleString('tr-TR', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // ‚úÖ Aynƒ± bran≈ü + aynƒ± ya≈ü grubu + aynƒ± saat i√ßin aynƒ± renk
                const ageGroup = trial.branchData.ageGroup || 'adult';
                const dateKey = `${trial.branchData.branchId}_${ageGroup}_${dateTimeStr}`;
                
                if (!trialsByDate[dateKey]) {
                    trialsByDate[dateKey] = [];
                    
                    // Bran≈ü stilini al
                    const branchStyle = branchStyles[trial.branchData.branchId] || branchStyles['default'];
                    dateBranchMap[dateKey] = branchStyle;
                    
                    // Aynƒ± bran≈ü i√ßin farklƒ± saatlere farklƒ± tonlar
                    const existingBranchKeys = Object.keys(dateBranchMap).filter(k => k.startsWith(trial.branchData.branchId));
                    const colorIndex = existingBranchKeys.length - 1;
                    dateColorMap[dateKey] = branchStyle.colors[colorIndex % branchStyle.colors.length];
                }
                trialsByDate[dateKey].push(trial);
            });
            
            // Tarihe g√∂re sƒ±ralƒ± HTML olu≈ütur (branchId_datetime formatƒ±ndan tarihi al)
            const sortedDates = Object.keys(trialsByDate).sort((a, b) => {
                const dateA = trialsByDate[a][0].childData 
                    ? new Date(trialsByDate[a][0].childData.denemeDate)
                    : new Date(trialsByDate[a][0].branchData.denemeDate);
                const dateB = trialsByDate[b][0].childData 
                    ? new Date(trialsByDate[b][0].childData.denemeDate)
                    : new Date(trialsByDate[b][0].branchData.denemeDate);
                // √ñnce tarihe g√∂re sƒ±rala, aynƒ± tarihse bran≈ü ID'ye g√∂re
                const timeDiff = dateA - dateB;
                if (timeDiff !== 0) return timeDiff;
                return a.localeCompare(b); // BranchId i√ßin alfasayƒ±sal sƒ±ralama
            });
            
            container.innerHTML = sortedDates.map(dateKey => {
                const dateTrials = trialsByDate[dateKey];
                const bgColor = dateColorMap[dateKey];
                const branchStyle = dateBranchMap[dateKey]; // Bran≈ü stilini al
                
                return dateTrials.map(({lead, branchData, childData, trialStatus}) => {
                    const branch = branches.find(b => b.id === branchData.branchId);
                    const trialDate = childData ? new Date(childData.denemeDate) : new Date(branchData.denemeDate);
                    const lastNote = branchData.notesHistory && branchData.notesHistory.length > 0 
                        ? branchData.notesHistory[branchData.notesHistory.length - 1].text 
                        : 'Not yok';
                    
                    // ƒ∞sim bilgisini belirle
                    let displayName = '';
                    let branchFullName = '';
                    
                    if (childData) {
                        // √áocuk denemesi - veli: xx √∂ƒürenci: xx formatƒ±nda
                        const ageInfo = childData.age ? ` (${childData.age} ya≈ü)` : '';
                        displayName = `Veli: ${branchData.parentName || 'Belirtilmemi≈ü'} / √ñƒürenci: ${childData.name}${ageInfo}`;
                        branchFullName = 'üë∂ √áocuk - ' + (branch ? branch.name : 'Bran≈ü yok');
                    } else if (branchData.ageGroup === 'adult') {
                        // Yeti≈ükin denemesi
                        displayName = branchData.fullName || lead.fullName || 'Yeti≈ükin';
                        branchFullName = 'üë® Yeti≈ükin - ' + (branch ? branch.name : 'Bran≈ü yok');
                    }
                    
                    // Etiket bilgisi
                    const selectedTag = childData ? childData.selectedTag : branchData.selectedTag;
                    const tagBadge = selectedTag ? `<span style="background: #667eea; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">üè∑Ô∏è ${selectedTag}</span>` : '';
                    
                    // Deneme ID'si
                    const branchIndex = lead.branches.findIndex(b => b === branchData);
                    const childIndex = childData && branchData.children ? branchData.children.findIndex(c => c === childData) : -1;
                    
                    // Tarih formatƒ± - daha belirgin
                    const dateFormatted = trialDate.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const timeFormatted = trialDate.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                    
                    return `
                        <div class="trial-item ${trialStatus}" style="position: relative; background: ${bgColor}; border-left: 6px solid ${branchStyle.borderColor}; padding: 18px; border-radius: 10px; margin-bottom: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div style="position: absolute; top: 10px; right: 10px; font-size: 64px; opacity: 0.15; pointer-events: none; z-index: 0;">
                                ${branchStyle.emoji}
                            </div>
                            <div style="position: relative; z-index: 1; display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 15px; font-weight: 600; color: #333; margin-bottom: 6px;">
                                        <span style="font-size: 20px; margin-right: 8px;">${branchStyle.emoji}</span>${displayName}
                                    </div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 4px;">
                                        üìû <span onclick="event.stopPropagation()" style="cursor: pointer; display: inline-flex; gap: 8px; align-items: center;">
                                            <span onclick="copyToClipboard('${lead.phone}', 'Telefon numarasƒ± kopyalandƒ±')" style="padding: 4px 8px; background: #e3f2fd; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#bbdefb'" onmouseout="this.style.background='#e3f2fd'" title="Kopyala">${lead.phone} üìã</span>
                                            <a href="tel:${lead.phone}" style="padding: 4px 8px; background: #e8f5e9; border-radius: 4px; text-decoration: none; color: #666; transition: background 0.2s;" onmouseover="this.style.background='#c8e6c9'" onmouseout="this.style.background='#e8f5e9'" title="Ara">üìû</a>
                                        </span>
                                    </div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 4px;">
                                        üéØ ${branchFullName}
                                    </div>
                                    <div style="margin-top: 6px;">
                                        ${tagBadge}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 18px; font-weight: 700; color: #2c3e50; margin-bottom: 2px;">
                                        ${timeFormatted}
                                    </div>
                                    <div style="font-size: 14px; font-weight: 600; color: #555;">
                                        üìÖ ${dateFormatted}
                                    </div>
                                    <div style="margin-top: 8px; background: ${getTrialStatusColor(trialStatus)}15; color: ${getTrialStatusColor(trialStatus)}; padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 600; text-align: center;">
                                        ${getTrialStatusIcon(trialStatus)} ${getTrialStatusName(trialStatus)}
                                    </div>
                                </div>
                            </div>
                            <div style="position: relative; z-index: 1; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px;">
                                <button class="btn btn-sm btn-primary" onclick="openCustomerDetail('${lead.id}', ${branchIndex})" style="width: 100%; padding: 8px 12px; font-size: 12px;">üë§ Detay</button>
                                <button class="btn btn-sm btn-warning trial-reminder-btn" id="trialBtn_${lead.phone}_${branchIndex}_${childIndex}" onclick="sendTrialReminder('${lead.phone}', '${displayName.replace(/'/g, "\\'")}', '${timeFormatted}', '${dateFormatted}', 'trialBtn_${lead.phone}_${branchIndex}_${childIndex}')" style="width: 100%; padding: 8px 12px; font-size: 12px;">‚è∞ Hatƒ±rlat</button>
                                <button class="btn btn-sm btn-danger" onclick="removeFromTrials('${lead.id}', ${branchIndex}, ${childIndex})" style="width: 100%; padding: 8px 12px; font-size: 12px; background: #f44336;">üóëÔ∏è Denemeden Kaldƒ±r</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }).join('');
        };
        
        // Denemeden kaldƒ±r (sadece listeden, m√º≈üteriyi silmez)
        window.removeFromTrials = async function(leadId, branchIndex, childIndex) {
            try {
                const lead = crmLeads.find(l => l.id === leadId);
                if (!lead || !lead.branches || !lead.branches[branchIndex]) {
                    showAlert('‚ùå M√º≈üteri bulunamadƒ±', 'danger');
                    return;
                }
                
                const branchData = lead.branches[branchIndex];
                let selectedTag = '';
                
                // √áocuk denemesi mi yoksa yeti≈ükin denemesi mi?
                if (childIndex >= 0 && branchData.children && branchData.children[childIndex]) {
                    selectedTag = branchData.children[childIndex].selectedTag;
                } else {
                    selectedTag = branchData.selectedTag;
                }
                
                // ‚úÖ Eƒüer etiket "Denemeye Gelecek" ise hi√ßbir ≈üekilde silmeye izin verme
                if (selectedTag === 'Denemeye Gelecek') {
                    showAlert('‚ö†Ô∏è Bu m√º≈üterinin etiketi "Denemeye Gelecek" olarak i≈üaretli!\n\nL√ºtfen √∂nce denemeyi sonu√ßlandƒ±rƒ±n ve etiketini deƒüi≈ütirin. Denemeye gelecek etiketli m√º≈üteriler listeden kaldƒ±rƒ±lamaz.', 'warning');
                    return; // ƒ∞≈ülemi tamamen iptal et
                }
                
                // Diƒüer etiketler i√ßin onay iste
                if (!confirm('Bu denemeyi listeden kaldƒ±rmak istediƒüinize emin misiniz?\n(M√º≈üteri kaydƒ± silinmeyecek, sadece deneme tarihi temizlenecek, etiket korunacak)')) {
                    return;
                }
                
                // √áocuk denemesi mi yoksa yeti≈ükin denemesi mi?
                if (childIndex >= 0 && branchData.children && branchData.children[childIndex]) {
                    // ‚úÖ √áocuk denemesi - SADECE deneme tarihini temizle, ETƒ∞KET KALSIN
                    branchData.children[childIndex].denemeDate = null;
                } else {
                    // ‚úÖ Yeti≈ükin denemesi - SADECE deneme tarihini temizle, ETƒ∞KET KALSIN
                    branchData.denemeDate = null;
                }
                
                // Firebase'e kaydet
                await window.firebase.updateDoc(
                    window.firebase.doc(window.db, 'crmLeads', leadId),
                    { branches: lead.branches }
                );
                
                showAlert('‚úÖ Deneme listeden kaldƒ±rƒ±ldƒ±! (Etiket korundu)', 'success');
                await loadData();
                renderTrials();
                updateDashboard();
            } catch (error) {
                console.error('Deneme kaldƒ±rma hatasƒ±:', error);
                showAlert('‚ùå ƒ∞≈ülem ba≈üarƒ±sƒ±z: ' + error.message, 'danger');
            }
        };
        
        // Deneme hatƒ±rlatmasƒ± g√∂nder (Evolution API ile)
        window.sendTrialReminder = async function(phone, name, time, date, buttonId) {
            try {
                // ‚úÖ Butonu disable et ve g√∂r√ºn√ºm√ºn√º deƒüi≈ütir
                const btn = document.getElementById(buttonId);
                if (btn) {
                    if (btn.disabled) {
                        showAlert('‚è≥ Mesaj zaten g√∂nderildi veya kuyruƒüa eklendi!', 'warning');
                        return;
                    }
                    btn.disabled = true;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '‚è≥ G√∂nderiliyor...';
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                }
                
                // WhatsApp cihazƒ±nƒ± kontrol et
                if (!whatsappDevices || whatsappDevices.length === 0) {
                    showAlert('‚ö†Ô∏è WhatsApp cihazƒ± bulunamadƒ±!', 'warning');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                    }
                    return;
                }
                
                const instanceName = whatsappDevices[0].instanceName || whatsappDevices[0].instance;
                
                // Varsayƒ±lan mesaj
                const message = `Merhaba,\n\nüìÖ ${date} tarihinde saat ${time}'de deneme dersini hatƒ±rlatmak isteriz.\n\nG√∂r√º≈ümek √ºzere! üéæ`;
                
                // Evolution API ile g√∂nder
                const cleanPhone = phone.replace(/\D/g, '');
                
                console.log('üì§ Deneme hatƒ±rlatmasƒ± g√∂nderiliyor:', { instanceName, phone: cleanPhone, name });
                
                const success = await sendWhatsAppMessage(instanceName, cleanPhone, message, name);
                
                // ‚úÖ Butonu "G√∂nderildi" durumuna getir
                if (btn) {
                    btn.innerHTML = '‚úÖ G√∂nderildi';
                    btn.classList.remove('btn-warning');
                    btn.classList.add('btn-success');
                    btn.style.background = '#4caf50';
                }
                
                showAlert('‚úÖ Deneme hatƒ±rlatmasƒ± kuyruƒüa eklendi!', 'success');
            } catch (error) {
                console.error('‚ùå Deneme hatƒ±rlatma hatasƒ±:', error);
                showAlert('‚ùå Mesaj g√∂nderilemedi: ' + error.message, 'danger');
                
                // ‚úÖ Hata durumunda butonu tekrar aktif et
                const btn = document.getElementById(buttonId);
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '‚è∞ Hatƒ±rlat';
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            }
        };
        
        // Deneme istatistiklerini g√ºncelle - ƒ∞statistikler kaldƒ±rƒ±ldƒ±, fonksiyon bo≈ü bƒ±rakƒ±ldƒ±
        function updateTrialStats(trials) {
            // ƒ∞statistik kartlarƒ± kaldƒ±rƒ±ldƒ±
        }
        
        // Deneme durumu rengi
        function getTrialStatusColor(status) {
            const colors = {
                scheduled: '#4facfe',
                completed: '#43e97b',
                cancelled: '#f5576c',
                converted: '#f093fb'
            };
            return colors[status] || '#667eea';
        }
        
        // Deneme durumu ikonu
        function getTrialStatusIcon(status) {
            const icons = {
                scheduled: 'üìÖ',
                completed: '‚úÖ',
                cancelled: '‚ùå',
                converted: 'üéâ'
            };
            return icons[status] || 'üìã';
        }
        
        // Deneme durumu adƒ±
        function getTrialStatusName(status) {
            const names = {
                scheduled: 'Planlandƒ±',
                completed: 'Tamamlandƒ±',
                cancelled: 'ƒ∞ptal',
                converted: '√úye Oldu'
            };
            return names[status] || 'Bilinmiyor';
        }
        
        // Deneme tamamla
        window.markTrialCompleted = async function(leadId) {
            if (!confirm('Deneme dersini tamamlandƒ± olarak i≈üaretlemek istediƒüinize emin misiniz?')) return;
            
            try {
                const leadRef = window.firebase.doc(window.db, 'crmLeads', leadId);
                await window.firebase.updateDoc(leadRef, {
                    trialStatus: 'completed',
                    updatedAt: new Date().toISOString()
                });
                showAlert('‚úÖ Deneme tamamlandƒ± olarak i≈üaretlendi!', 'success');
                await loadData();
                renderTrials();
            } catch (error) {
                console.error('Deneme g√ºncellenirken hata:', error);
                showAlert('‚ùå Hata olu≈ütu: ' + error.message, 'danger');
            }
        };
        
        // Deneme iptal et
        window.cancelTrial = async function(leadId) {
            if (!confirm('Deneme dersini iptal etmek istediƒüinize emin misiniz?')) return;
            
            try {
                const leadRef = window.firebase.doc(window.db, 'crmLeads', leadId);
                await window.firebase.updateDoc(leadRef, {
                    trialStatus: 'cancelled',
                    updatedAt: new Date().toISOString()
                });
                showAlert('‚úÖ Deneme iptal edildi!', 'success');
                await loadData();
                renderTrials();
            } catch (error) {
                console.error('Deneme g√ºncellenirken hata:', error);
                showAlert('‚ùå Hata olu≈ütu: ' + error.message, 'danger');
            }
        };
        
        // Deneme modal a√ß
        window.openAddTrialModal = function() {
            openAddLeadModal();
            // Deneme tarihi alanƒ±na odaklan
            setTimeout(() => {
                document.querySelector('[name="trialDate"]')?.focus();
            }, 100);
        };

        // ============================================
        // ‚úÖ CRM TAGS FUNCTIONS
        // ============================================
        
        // Global etiket listesi
        let crmTags = [];
        
        // Etiketleri y√ºkle
        async function loadCRMTags() {
            if (!currentClubId) return;
            
            try {
                const tagsRef = window.firebase.collection(window.db, `clubs/${currentClubId}/crmTags`);
                const tagsSnapshot = await window.firebase.getDocs(tagsRef);
                crmTags = tagsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Bran≈ülarƒ± otomatik etiket olarak ekle
                await syncBranchTags();
                
                // Sistem etiketlerini ekle
                await ensureSystemTags();
                
                renderAllTags();
                updateTagStats();
                loadTagsToFilters();
            } catch (error) {
                console.error('Etiketler y√ºklenirken hata:', error);
            }
        }
        
        // Bran≈ülarƒ± otomatik etiket olarak senkronize et
        async function syncBranchTags() {
            if (!branches || branches.length === 0) return;
            
            try {
                for (const branch of branches) {
                    // Bu bran≈ü etiketi var mƒ± kontrol et
                    const existingTag = crmTags.find(t => t.name === branch.name && t.category === 'branch');
                    
                    if (!existingTag) {
                        // Yoksa ekle
                        const newTag = {
                            name: branch.name,
                            category: 'branch',
                            description: `${branch.icon} ${branch.name} bran≈üƒ±`,
                            isActive: true,
                            isAutoGenerated: true,
                            createdAt: new Date().toISOString(),
                            clubId: currentClubId
                        };
                        
                        const docRef = await window.firebase.addDoc(
                            window.firebase.collection(window.db, `clubs/${currentClubId}/crmTags`),
                            newTag
                        );
                        
                        crmTags.push({ id: docRef.id, ...newTag });
                    }
                }
            } catch (error) {
                console.error('Bran≈ü etiketleri senkronize edilirken hata:', error);
            }
        }
        
        // Sistem etiketlerini olu≈ütur (Kayƒ±t Olabilir, Denemeye Gelecek, √úye Oldu)
        async function ensureSystemTags() {
            const systemTags = [
                {
                    name: 'Aranmadƒ±',
                    category: 'status',
                    description: 'Hen√ºz aranmamƒ±≈ü m√º≈üteriler',
                    isSystem: true,
                    requiresDate: false,
                    order: 1
                },
                {
                    name: 'Mesaj Atƒ±lacak',
                    category: 'status',
                    description: 'Mesaj g√∂nderilecek m√º≈üteriler',
                    isSystem: true,
                    requiresDate: false,
                    order: 2
                },
                {
                    name: 'Denemeye Gelecek',
                    category: 'status',
                    description: 'Deneme dersi i√ßin randevusu olan m√º≈üteriler',
                    isSystem: true,
                    requiresDate: true,
                    order: 3
                },
                {
                    name: 'Kayƒ±t Olabilir',
                    category: 'status',
                    description: 'ƒ∞leri tarihte kayƒ±t olabilecek m√º≈üteriler i√ßin',
                    isSystem: true,
                    requiresDate: true,
                    order: 4
                },
                {
                    name: 'Kayƒ±t Oldu',
                    category: 'status',
                    description: 'Kayƒ±t olmu≈ü m√º≈üteriler',
                    isSystem: true,
                    requiresDate: false,
                    order: 5
                },
                {
                    name: 'Diƒüer',
                    category: 'status',
                    description: 'Diƒüer durumdaki m√º≈üteriler',
                    isSystem: true,
                    requiresDate: false,
                    order: 6
                }
            ];
            
            try {
                for (const sysTag of systemTags) {
                    const existing = crmTags.find(t => t.name === sysTag.name);
                    
                    if (!existing) {
                        const newTag = {
                            ...sysTag,
                            isActive: true,
                            createdAt: new Date().toISOString(),
                            clubId: currentClubId
                        };
                        
                        const docRef = await window.firebase.addDoc(
                            window.firebase.collection(window.db, `clubs/${currentClubId}/crmTags`),
                            newTag
                        );
                        
                        crmTags.push({ id: docRef.id, ...newTag });
                    }
                }
            } catch (error) {
                console.error('Sistem etiketleri olu≈üturulurken hata:', error);
            }
        }
        
        // T√ºm etiketleri render et
        window.renderAllTags = function() {
            const searchText = document.getElementById('tag-search')?.value.toLowerCase() || '';
            const categoryFilter = document.getElementById('tag-category-filter')?.value || 'all';
            
            let filtered = [...crmTags];
            
            if (searchText) {
                filtered = filtered.filter(tag => tag.name.toLowerCase().includes(searchText));
            }
            
            if (categoryFilter !== 'all') {
                filtered = filtered.filter(tag => tag.category === categoryFilter);
            }
            
            // Sƒ±ralamaya g√∂re sƒ±rala
            filtered.sort((a, b) => (a.order || 999) - (b.order || 999));
            
            // Kategorilere g√∂re ayƒ±r ve sƒ±rala
            const statusTags = filtered.filter(t => t.category === 'status').sort((a, b) => (a.order || 999) - (b.order || 999));
            const branchTags = filtered.filter(t => t.category === 'branch').sort((a, b) => (a.order || 999) - (b.order || 999));
            const customTags = filtered.filter(t => t.category === 'custom').sort((a, b) => (a.order || 999) - (b.order || 999));
            
            // Her kategoriyi render et
            renderTagCategory('status-tags-list', statusTags, 'status');
            renderTagCategory('branch-tags-list', branchTags, 'branch');
            renderTagCategory('custom-tags-list', customTags, 'custom');
            
            // T√ºm etiketler listesi
            const allContainer = document.getElementById('all-tags-list');
            if (allContainer) {
                if (filtered.length === 0) {
                    allContainer.innerHTML = `
                        <div class="empty-state">
                            <h3>Etiket bulunamadƒ±</h3>
                            <p>Yeni etiket eklemek i√ßin yukarƒ±daki butonu kullanƒ±n</p>
                        </div>
                    `;
                } else {
                    allContainer.innerHTML = filtered.map((tag, index) => {
                        const usageCount = crmLeads.filter(l => (l.tags || []).includes(tag.name)).length;
                        const tagId = tag.id.replace(/'/g, "\\'");
                        return `
                            <div class="tag-item ${tag.category}-tag" data-tag-id="${tag.id}">
                                <div style="display: flex; flex-direction: column; gap: 2px; margin-right: 8px;">
                                    <button onclick="moveTagUp('${tagId}', 'all')" ${index === 0 ? 'disabled' : ''} style="padding: 2px 6px; font-size: 10px; background: ${index === 0 ? '#ccc' : '#4CAF50'}; color: white; border: none; border-radius: 3px; cursor: ${index === 0 ? 'not-allowed' : 'pointer'};" title="Yukarƒ± Ta≈üƒ±">‚ñ≤</button>
                                    <button onclick="moveTagDown('${tagId}', 'all')" ${index === filtered.length - 1 ? 'disabled' : ''} style="padding: 2px 6px; font-size: 10px; background: ${index === filtered.length - 1 ? '#ccc' : '#4CAF50'}; color: white; border: none; border-radius: 3px; cursor: ${index === filtered.length - 1 ? 'not-allowed' : 'pointer'};" title="A≈üaƒüƒ± Ta≈üƒ±">‚ñº</button>
                                </div>
                                <span class="tag-name">${tag.name}</span>
                                <span class="tag-count">${usageCount}</span>
                                <div class="tag-actions">
                                    <button onclick="editTag('${tagId}')" title="D√ºzenle">‚úèÔ∏è</button>
                                    <button onclick="deleteTag('${tagId}')" title="Sil">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
        };
        
        // Kategori etiketlerini render et
        function renderTagCategory(containerId, tags, category) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (tags.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 12px; padding: 10px;">Hen√ºz etiket yok</p>';
                return;
            }
            
            container.innerHTML = tags.map((tag, index) => {
                const usageCount = crmLeads.filter(l => (l.tags || []).includes(tag.name)).length;
                const tagId = tag.id.replace(/'/g, "\\'");
                const categoryStr = category.replace(/'/g, "\\'");
                return `
                    <div class="tag-item ${category}-tag" data-tag-id="${tag.id}">
                        <div style="display: flex; flex-direction: column; gap: 2px; margin-right: 8px;">
                            <button onclick="moveTagUp('${tagId}', '${categoryStr}')" ${index === 0 ? 'disabled' : ''} style="padding: 2px 6px; font-size: 10px; background: ${index === 0 ? '#ccc' : '#4CAF50'}; color: white; border: none; border-radius: 3px; cursor: ${index === 0 ? 'not-allowed' : 'pointer'};" title="Yukarƒ± Ta≈üƒ±">‚ñ≤</button>
                            <button onclick="moveTagDown('${tagId}', '${categoryStr}')" ${index === tags.length - 1 ? 'disabled' : ''} style="padding: 2px 6px; font-size: 10px; background: ${index === tags.length - 1 ? '#ccc' : '#4CAF50'}; color: white; border: none; border-radius: 3px; cursor: ${index === tags.length - 1 ? 'not-allowed' : 'pointer'};" title="A≈üaƒüƒ± Ta≈üƒ±">‚ñº</button>
                        </div>
                        <span class="tag-name">${tag.name}</span>
                        <span class="tag-count">${usageCount}</span>
                        <div class="tag-actions">
                            <button onclick="editTag('${tagId}')" title="D√ºzenle">‚úèÔ∏è</button>
                            <button onclick="deleteTag('${tagId}')" title="Sil">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Etiket ta≈üƒ±ma fonksiyonlarƒ± (ok i≈üaretleri ile)
        window.moveTagUp = async function(tagId, category) {
            console.log('moveTagUp √ßaƒürƒ±ldƒ±:', tagId, category);
            const tag = crmTags.find(t => t.id === tagId);
            if (!tag) {
                console.error('Etiket bulunamadƒ±:', tagId);
                return;
            }
            
            // Aynƒ± kategorideki etiketleri al ve sƒ±rala
            const sameCategoryTags = crmTags
                .filter(t => category === 'all' || t.category === category)
                .sort((a, b) => (a.order || 999) - (b.order || 999));
            
            console.log('Aynƒ± kategorideki etiketler:', sameCategoryTags.length);
            
            const currentIndex = sameCategoryTags.findIndex(t => t.id === tagId);
            if (currentIndex <= 0) {
                console.log('Etiket zaten en √ºstte');
                return; // Zaten en √ºstte
            }
            
            // Sadece iki etiketin order deƒüerlerini deƒüi≈ütir (swap)
            const currentTag = sameCategoryTags[currentIndex];
            const previousTag = sameCategoryTags[currentIndex - 1];
            
            const tempOrder = currentTag.order;
            currentTag.order = previousTag.order;
            previousTag.order = tempOrder;

            try {
                // Sadece 2 etiketi g√ºncelle
                await Promise.all([
                    window.firebase.updateDoc(
                        window.firebase.doc(window.db, `clubs/${currentClubId}/crmTags`, currentTag.id),
                        { order: currentTag.order }
                    ),
                    window.firebase.updateDoc(
                        window.firebase.doc(window.db, `clubs/${currentClubId}/crmTags`, previousTag.id),
                        { order: previousTag.order }
                    )
                ]);

                console.log('‚úÖ Etiket sƒ±ralamasƒ± g√ºncellendi');
                await loadCRMTags();
                renderAllTags();
            } catch (error) {
                console.error('Etiket ta≈üƒ±nƒ±rken hata:', error);
                showAlert('‚ùå Etiket ta≈üƒ±nƒ±rken hata olu≈ütu: ' + error.message, 'danger');
            }
        };
        
        window.moveTagDown = async function(tagId, category) {
            console.log('moveTagDown √ßaƒürƒ±ldƒ±:', tagId, category);
            const tag = crmTags.find(t => t.id === tagId);
            if (!tag) {
                console.error('Etiket bulunamadƒ±:', tagId);
                return;
            }
            
            // Aynƒ± kategorideki etiketleri al ve sƒ±rala
            const sameCategoryTags = crmTags
                .filter(t => category === 'all' || t.category === category)
                .sort((a, b) => (a.order || 999) - (b.order || 999));
            
            console.log('Aynƒ± kategorideki etiketler:', sameCategoryTags.length);
            
            const currentIndex = sameCategoryTags.findIndex(t => t.id === tagId);
            if (currentIndex >= sameCategoryTags.length - 1 || currentIndex < 0) {
                console.log('Etiket zaten en altta');
                return; // Zaten en altta
            }
            
            // Sadece iki etiketin order deƒüerlerini deƒüi≈ütir (swap)
            const currentTag = sameCategoryTags[currentIndex];
            const nextTag = sameCategoryTags[currentIndex + 1];
            
            const tempOrder = currentTag.order;
            currentTag.order = nextTag.order;
            nextTag.order = tempOrder;

            try {
                // Sadece 2 etiketi g√ºncelle
                await Promise.all([
                    window.firebase.updateDoc(
                        window.firebase.doc(window.db, `clubs/${currentClubId}/crmTags`, currentTag.id),
                        { order: currentTag.order }
                    ),
                    window.firebase.updateDoc(
                        window.firebase.doc(window.db, `clubs/${currentClubId}/crmTags`, nextTag.id),
                        { order: nextTag.order }
                    )
                ]);

                console.log('‚úÖ Etiket sƒ±ralamasƒ± g√ºncellendi');
                await loadCRMTags();
                renderAllTags();
            } catch (error) {
                console.error('Etiket ta≈üƒ±nƒ±rken hata:', error);
                showAlert('‚ùå Etiket ta≈üƒ±nƒ±rken hata olu≈ütu: ' + error.message, 'danger');
            }
        };
        
        // Drag & Drop fonksiyonlarƒ± (eski sistem - opsiyonel)
        let draggedTagElement = null;
        let draggedTagId = null;
        
        window.handleTagDragStart = function(event) {
            draggedTagElement = event.target;
            draggedTagId = event.target.dataset.tagId;
            event.target.style.opacity = '0.4';
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.innerHTML);
        };
        
        window.handleTagDragOver = function(event) {
            if (event.preventDefault) {
                event.preventDefault();
            }
            event.dataTransfer.dropEffect = 'move';
            
            const target = event.target.closest('.tag-item');
            if (target && target !== draggedTagElement) {
                target.style.borderTop = '2px solid #4CAF50';
            }
            return false;
        };
        
        window.handleTagDrop = async function(event) {
            if (event.stopPropagation) {
                event.stopPropagation();
            }
            
            const target = event.target.closest('.tag-item');
            if (!target || target === draggedTagElement) return false;
            
            target.style.borderTop = '';
            
            // Sƒ±ralamayƒ± deƒüi≈ütir
            const draggedTag = crmTags.find(t => t.id === draggedTagId);
            const targetTagId = target.dataset.tagId;
            const targetTag = crmTags.find(t => t.id === targetTagId);
            
            if (!draggedTag || !targetTag) return false;
            
            // Sadece aynƒ± kategorideki etiketleri sƒ±ralayabilir
            if (draggedTag.category !== targetTag.category) {
                showAlert('‚ö†Ô∏è Sadece aynƒ± kategorideki etiketleri sƒ±ralayabilirsiniz', 'warning');
                return false;
            }
            
            // Sƒ±ralamayƒ± deƒüi≈ütir
            const draggedOrder = draggedTag.order || 999;
            const targetOrder = targetTag.order || 999;
            
            // Aynƒ± kategorideki t√ºm etiketleri al ve sƒ±rala
            const sameCategoryTags = crmTags
                .filter(t => t.category === draggedTag.category)
                .sort((a, b) => (a.order || 999) - (b.order || 999));
            
            // Yeni sƒ±ralamayƒ± hesapla
            const draggedIndex = sameCategoryTags.findIndex(t => t.id === draggedTagId);
            const targetIndex = sameCategoryTags.findIndex(t => t.id === targetTagId);
            
            // Sƒ±ralamayƒ± deƒüi≈ütir
            sameCategoryTags.splice(draggedIndex, 1);
            sameCategoryTags.splice(targetIndex, 0, draggedTag);
            
            // Her etikete yeni order deƒüeri ata ve kaydet
            try {
                for (let i = 0; i < sameCategoryTags.length; i++) {
                    const tag = sameCategoryTags[i];
                    tag.order = i;
                    
                    // Firebase'e kaydet
                    const tagRef = window.firebase.doc(window.db, `clubs/${currentClubId}/crmTags/${tag.id}`);
                    await window.firebase.updateDoc(tagRef, { order: i });
                }
                
                // Local array'i g√ºncelle
                await loadCRMTags();
                
                showAlert('‚úÖ Etiket sƒ±ralamasƒ± g√ºncellendi', 'success');
            } catch (error) {
                console.error('Sƒ±ralama kaydedilirken hata:', error);
                showAlert('‚ùå Sƒ±ralama kaydedilemedi', 'danger');
            }
            
            return false;
        };
        
        window.handleTagDragEnd = function(event) {
            event.target.style.opacity = '1';
            
            // T√ºm border'larƒ± temizle
            document.querySelectorAll('.tag-item').forEach(item => {
                item.style.borderTop = '';
            });
        };
        
        // Etiket istatistiklerini g√ºncelle
        function updateTagStats() {
            const activeTags = crmTags.filter(t => t.isActive !== false);
            const taggedCustomers = new Set();
            crmLeads.forEach(lead => {
                if (lead.tags && lead.tags.length > 0) {
                    taggedCustomers.add(lead.id);
                }
            });
            
            document.getElementById('total-tags').textContent = crmTags.length;
            document.getElementById('active-tags').textContent = activeTags.length;
            document.getElementById('tagged-customers').textContent = taggedCustomers.size;
        }
        
        // Etiketleri filtrelere y√ºkle
        function loadTagsToFilters() {
            const filterTag = document.getElementById('filter-tag');
            if (filterTag) {
                // Bran≈ü etiketlerini gizle ve ORDER'a g√∂re sƒ±rala
                const nonBranchTags = crmTags
                    .filter(tag => tag.category !== 'branch')
                    .sort((a, b) => {
                        const orderA = a.order !== undefined ? a.order : 999;
                        const orderB = b.order !== undefined ? b.order : 999;
                        return orderA - orderB;
                    });
                filterTag.innerHTML = '<option value="all">T√ºm√º</option>' + 
                    nonBranchTags.map(tag => 
                        `<option value="${tag.name}">${tag.name}</option>`
                    ).join('');
            }
        }
        
        // CRM ≈ûablonlar Sayfasƒ±nƒ± Render Et
        function renderCRMTemplatesPage() {
            const container = document.getElementById('main-content') || document.querySelector('.admin-content');
            if (!container) return;
            
            // Potansiyel √ºyeler i√ßin ≈üablonlar (sadece CRM)
            const templatesByBranch = {};
            
            // Genel CRM ≈üablonlarƒ± (potansiyel √ºyeler i√ßin)
            templatesByBranch['genel'] = [
                {
                    id: 'gen-template-1',
                    name: 'Sizi Aradƒ±k Mesajƒ±',
                    message: 'Merhaba {isim},\n\nBug√ºn sizi aramaya √ßalƒ±≈ütƒ±k ancak ula≈üamadƒ±k. Size uygun bir zamanda g√∂r√º≈ümek isteriz.\n\nBize uygun bir zaman dilimi bildirebilir misiniz?\n\nSaygƒ±larƒ±mƒ±zla,\n{kulup_adi}',
                    icon: 'üìû',
                    color: '#2196F3'
                },
                {
                    id: 'gen-template-2',
                    name: 'Cevapsƒ±z √áaƒürƒ±',
                    message: 'Merhaba,\n\nBizi aramaya √ßalƒ±≈ütƒ±nƒ±z ancak o anda m√ºsait deƒüildik. Size nasƒ±l yardƒ±mcƒ± olabiliriz?\n\n{kulup_adi}',
                    icon: 'üìµ',
                    color: '#f44336'
                },
                {
                    id: 'gen-template-3',
                    name: 'Kayƒ±t Davetiyesi',
                    message: 'Merhaba {isim},\n\nBizimle g√∂r√º≈üt√ºkten sonra kayƒ±t i≈üleminizi tamamlamadƒ±ƒüƒ±nƒ±zƒ± fark ettik.\n\nSize √∂zel fƒ±rsatlarƒ±mƒ±z devam ediyor!\n\n{kulup_adi}',
                    icon: '‚ú®',
                    color: '#9C27B0'
                },
                {
                    id: 'gen-template-4',
                    name: 'Bilgi Talebi',
                    message: 'Merhaba {isim},\n\nKul√ºb√ºm√ºz hakkƒ±nda bilgi almak istediƒüinizi √∂ƒürendik.\n\nSize detaylƒ± bilgi vermek ve sorularƒ±nƒ±zƒ± yanƒ±tlamak i√ßin buradayƒ±z.\n\nBizi arayabilir veya ziyaret edebilirsiniz.\n\n{kulup_adi}',
                    icon: '‚ÑπÔ∏è',
                    color: '#00BCD4'
                }
            ];
            
            // Her bran≈ü i√ßin deneme dersi ≈üablonlarƒ± olu≈ütur
            branches.forEach(branch => {
                const branchId = branch.id;
                const branchName = branch.name;
                const branchIcon = branch.icon || 'üéØ';
                
                templatesByBranch[branchId] = [
                    {
                        id: `${branchId}-template-1`,
                        name: `${branchName} Deneme Dersi Daveti`,
                        message: `Merhaba {isim},\n\n${branchIcon} ${branchName} bran≈üƒ±mƒ±zda deneme dersi yapmak ister misiniz?\n\nDeneme dersimiz tamamen √ºcretsizdir ve size kul√ºb√ºm√ºz√º tanƒ±ma fƒ±rsatƒ± verir.\n\nBize uygun bir g√ºn ve saat bildirerek randevu alabilirsiniz.\n\nüìç Adres: {adres}\n\nG√∂r√º≈ümek √ºzere!\n{kulup_adi}`,
                        icon: branchIcon,
                        color: '#FF9800'
                    },
                    {
                        id: `${branchId}-template-2`,
                        name: `${branchName} Deneme Dersi Hatƒ±rlatma`,
                        message: `Merhaba {isim},\n\n${branchIcon} ${branchName} deneme dersiniz i√ßin sizi bekliyoruz!\n\nüìÖ Tarih: {tarih}\nüïê Saat: {saat}\nüìç Adres: {adres}\n\nYanƒ±nƒ±zda spor kƒ±yafeti ve i√ßecek getirmeyi unutmayƒ±n.\n\nG√∂r√º≈ümek √ºzere!\n{kulup_adi}`,
                        icon: branchIcon,
                        color: '#4CAF50'
                    },
                    {
                        id: `${branchId}-template-3`,
                        name: `${branchName} Deneme Sonrasƒ± Takip`,
                        message: `Merhaba {isim},\n\n${branchIcon} ${branchName} deneme dersinize katƒ±ldƒ±ƒüƒ±nƒ±z i√ßin te≈üekk√ºr ederiz!\n\nDeneyiminiz hakkƒ±nda g√∂r√º≈ülerinizi √∂ƒürenmek isteriz.\n\nKayƒ±t olmak veya ba≈üka sorularƒ±nƒ±z i√ßin bize ula≈üabilirsiniz.\n\n{kulup_adi}`,
                        icon: branchIcon,
                        color: '#9C27B0'
                    },
                    {
                        id: `${branchId}-template-4`,
                        name: `${branchName} Fiyat Bilgisi`,
                        message: `Merhaba {isim},\n\n${branchIcon} ${branchName} bran≈üƒ±mƒ±z i√ßin fiyat bilgilerimiz:\n\nüí∞ Aylƒ±k: {tutar} TL\nüìÖ Ders Sayƒ±sƒ±: Haftada X g√ºn\n\n≈ûu anda √∂zel kampanyalarƒ±mƒ±z da mevcut!\n\nDetaylƒ± bilgi i√ßin bizi arayabilirsiniz.\n\n{kulup_adi}`,
                        icon: branchIcon,
                        color: '#FFC107'
                    }
                ];
            });
            
            // Sekme butonlarƒ± olu≈ütur
            let tabsHTML = '<div class="customer-tabs" style="margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch;">';
            
            // Genel sekmesi
            tabsHTML += `
                <button class="tab-button active" onclick="switchTemplateTab('genel')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    üåê Genel CRM ≈ûablonlarƒ±
                </button>
            `;
            
            // Bran≈ü sekmeleri
            branches.forEach(branch => {
                tabsHTML += `
                    <button class="tab-button" onclick="switchTemplateTab('${branch.id}')">
                        ${branch.icon || 'üéØ'} ${branch.name}
                    </button>
                `;
            });
            
            tabsHTML += '</div>';
            
            // Sekme i√ßerikleri
            let contentsHTML = '';
            
            // Her bran≈ü i√ßin i√ßerik olu≈ütur
            Object.keys(templatesByBranch).forEach((branchKey, index) => {
                const isActive = branchKey === 'genel';
                const templates = templatesByBranch[branchKey];
                const branchName = branchKey === 'genel' ? 'Genel CRM' : (branches.find(b => b.id === branchKey)?.name || branchKey);
                
                contentsHTML += `
                    <div class="tab-content ${isActive ? 'active' : ''}" id="template-tab-${branchKey}" style="display: ${isActive ? 'block' : 'none'};">
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #667eea; margin-bottom: 15px;">${branchName} Mesaj ≈ûablonlarƒ±</h3>
                            <div style="display: grid; gap: 15px;">
                                ${templates.map(template => `
                                    <div style="background: ${template.color}15; border-left: 4px solid ${template.color}; border-radius: 8px; padding: 15px;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                                            <div>
                                                <div style="font-size: 24px; margin-bottom: 5px;">${template.icon}</div>
                                                <h4 style="margin: 0; font-size: 16px; color: #333;">${template.name}</h4>
                            </div>
                                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                                <button class="btn btn-sm btn-primary" onclick="copyTemplateToClipboard(\`${template.message.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, '${branchKey}')" title="≈ûablonu Kopyala">
                                                    üìã Kopyala
                                                </button>
                                                <button class="btn btn-sm btn-success" onclick="useTemplateInWhatsApp(\`${template.message.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" title="WhatsApp'ta Kullan">
                                                    üí¨ Kullan
                                                </button>
                            </div>
                            </div>
                                        <pre style="background: white; padding: 12px; border-radius: 6px; font-size: 13px; white-space: pre-wrap; margin: 0; font-family: inherit; border: 1px solid ${template.color}30; line-height: 1.6;">${template.message}</pre>
                                        <div style="margin-top: 10px; font-size: 11px; color: #666; padding: 8px; background: white; border-radius: 4px;">
                                            <strong>üìù Deƒüi≈ükenler:</strong> {isim}, {tarih}, {saat}, {kulup_adi}, {adres}, {tutar}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                    </div>
                </div>
            `;
            });
            
            // Ana HTML'i olu≈ütur
            const html = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">üìù CRM Mesaj ≈ûablonlarƒ±</h2>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3; margin-bottom: 20px;">
                        <strong>‚ÑπÔ∏è Kullanƒ±m:</strong> Bu ≈üablonlar <strong>potansiyel √ºyeler</strong> (CRM'deki ki≈üiler) i√ßin hazƒ±rlanmƒ±≈ütƒ±r. 
                        Deneme dersi, arama, kayƒ±t davetiyesi gibi ilk ileti≈üim mesajlarƒ±nƒ± i√ßerir. 
                        ≈ûablonlarƒ± kopyalayƒ±p d√ºzenleyebilir veya doƒürudan WhatsApp'ta kullanabilirsiniz.
                    </div>
                    
                    ${tabsHTML}
                    ${contentsHTML}
                </div>
            `;
            
            // Render et
            const mainContent = document.querySelector('.admin-content');
            if (mainContent) {
                // Mevcut i√ßeriƒüi temizle ve yeni i√ßeriƒüi ekle
                const sections = mainContent.querySelectorAll('.section');
                sections.forEach(s => s.style.display = 'none');
                
                // CRM Templates section varsa g√ºncelle, yoksa olu≈ütur
                let templateSection = document.getElementById('crm-templates-section');
                if (!templateSection) {
                    templateSection = document.createElement('div');
                    templateSection.id = 'crm-templates-section';
                    templateSection.className = 'section';
                    mainContent.appendChild(templateSection);
                }
                
                templateSection.innerHTML = html;
                templateSection.style.display = 'block';
            }
        }
        
        // ≈ûablon sekmesini deƒüi≈ütir
        window.switchTemplateTab = function(branchId) {
            // T√ºm sekmeleri pasif yap
            const tabs = document.querySelectorAll('.customer-tabs .tab-button');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // T√ºm i√ßerikleri gizle
            const contents = document.querySelectorAll('[id^="template-tab-"]');
            contents.forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // Se√ßilen sekmeyi aktif yap
            const selectedTab = Array.from(tabs).find(tab => tab.getAttribute('onclick').includes(branchId));
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Se√ßilen i√ßeriƒüi g√∂ster
            const selectedContent = document.getElementById(`template-tab-${branchId}`);
            if (selectedContent) {
                selectedContent.classList.add('active');
                selectedContent.style.display = 'block';
            }
        };
        
        // ≈ûablonu panoya kopyala
        window.copyTemplateToClipboard = function(message, branchId) {
            navigator.clipboard.writeText(message).then(() => {
                showAlert('‚úÖ ≈ûablon panoya kopyalandƒ±!', 'success', 2000);
            }).catch(err => {
                console.error('Kopyalama hatasƒ±:', err);
                showAlert('‚ùå Kopyalama ba≈üarƒ±sƒ±z!', 'danger');
            });
        };
        
        // ≈ûablonu WhatsApp'ta kullan
        window.useTemplateInWhatsApp = function(message) {
            // WhatsApp sayfasƒ±na git
            showSection('whatsapp', document.querySelector('.nav-btn[onclick*="whatsapp"]'));
            
            // Mesaj alanƒ±na ≈üablonu yerle≈ütir
            setTimeout(() => {
                const messageField = document.getElementById('bulkMessageText');
                if (messageField) {
                    messageField.value = message;
                    showAlert('‚úÖ ≈ûablon WhatsApp mesaj alanƒ±na y√ºklendi!', 'success', 2000);
                    
                    // Mesajla≈üma sekmesine ge√ß
                    if (window.switchWhatsAppTab) {
                        switchWhatsAppTab('messages');
                    }
                } else {
                    showAlert('‚ùå WhatsApp mesaj alanƒ± bulunamadƒ±!', 'danger');
                }
            }, 500);
        };
        
        // Etiket modal a√ß
        window.openAddTagModal = function() {
            const html = `
                <div id="addTagModal" class="modal" style="display: block;">
                    <div class="modal-content">
                        <span class="close" onclick="closeModal('addTagModal')">&times;</span>
                        <h3>‚ûï Yeni Etiket</h3>
                        <form id="addTagForm" onsubmit="handleAddTag(event)">
                            <div class="form-group">
                                <label>Etiket Adƒ± *</label>
                                <input type="text" name="tagName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Kategori *</label>
                                <select name="category" class="form-control" required>
                                    <option value="status">Durum</option>
                                    <option value="branch">Bran≈ü</option>
                                    <option value="custom">√ñzel</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>A√ßƒ±klama</label>
                                <textarea name="description" class="form-control" rows="3"></textarea>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="submit" class="btn btn-primary" style="flex: 1;">üíæ Kaydet</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('addTagModal')">ƒ∞ptal</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Modal varsa kaldƒ±r
            const existing = document.getElementById('addTagModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', html);
        };
        
        // Etiket ekle
        window.handleAddTag = async function(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const newTag = {
                name: formData.get('tagName'),
                category: formData.get('category'),
                description: formData.get('description') || '',
                isActive: true,
                order: (crmTags && crmTags.length > 0) ? Math.max(...crmTags.map(t => t.order ?? 0)) + 1 : 0,
                createdAt: new Date().toISOString(),
                clubId: currentClubId
            };
            
            try {
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, `clubs/${currentClubId}/crmTags`), 
                    newTag
                );
                showAlert('‚úÖ Etiket ba≈üarƒ±yla eklendi!', 'success');
                closeModal('addTagModal');
                loadCRMTags();
            } catch (error) {
                console.error('Etiket eklenirken hata:', error);
                showAlert('‚ùå Etiket eklenirken hata olu≈ütu: ' + error.message, 'danger');
            }
        };
        
        // Etiket d√ºzenle
        window.editTag = function(tagId) {
            const tag = crmTags.find(t => t.id === tagId);
            if (!tag) return;
            
            const html = `
                <div id="editTagModal" class="modal" style="display: block;">
                    <div class="modal-content">
                        <span class="close" onclick="closeModal('editTagModal')">&times;</span>
                        <h3>‚úèÔ∏è Etiket D√ºzenle</h3>
                        <form id="editTagForm" onsubmit="handleEditTag(event, '${tagId}')">
                            <div class="form-group">
                                <label>Etiket Adƒ± *</label>
                                <input type="text" name="tagName" class="form-control" value="${tag.name}" required>
                            </div>
                            <div class="form-group">
                                <label>Kategori *</label>
                                <select name="category" class="form-control" required>
                                    <option value="status" ${tag.category === 'status' ? 'selected' : ''}>Durum</option>
                                    <option value="branch" ${tag.category === 'branch' ? 'selected' : ''}>Bran≈ü</option>
                                    <option value="custom" ${tag.category === 'custom' ? 'selected' : ''}>√ñzel</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>A√ßƒ±klama</label>
                                <textarea name="description" class="form-control" rows="3">${tag.description || ''}</textarea>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="submit" class="btn btn-primary" style="flex: 1;">üíæ G√ºncelle</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('editTagModal')">ƒ∞ptal</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('editTagModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', html);
        };
        
        // Etiket g√ºncelle
        window.handleEditTag = async function(event, tagId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const updatedTag = {
                name: formData.get('tagName'),
                category: formData.get('category'),
                description: formData.get('description') || '',
                updatedAt: new Date().toISOString()
            };
            
            try {
                const tagRef = window.firebase.doc(window.db, `clubs/${currentClubId}/crmTags`, tagId);
                await window.firebase.updateDoc(tagRef, updatedTag);
                showAlert('‚úÖ Etiket ba≈üarƒ±yla g√ºncellendi!', 'success');
                closeModal('editTagModal');
                loadCRMTags();
            } catch (error) {
                console.error('Etiket g√ºncellenirken hata:', error);
                showAlert('‚ùå Etiket g√ºncellenirken hata olu≈ütu: ' + error.message, 'danger');
            }
        };
        
        // Etiket sil
        window.deleteTag = async function(tagId) {
            if (!confirm('Bu etiketi silmek istediƒüinize emin misiniz?')) return;
            
            try {
                await window.firebase.deleteDoc(
                    window.firebase.doc(window.db, `clubs/${currentClubId}/crmTags`, tagId)
                );
                showAlert('‚úÖ Etiket ba≈üarƒ±yla silindi!', 'success');
                loadCRMTags();
            } catch (error) {
                console.error('Etiket silinirken hata:', error);
                showAlert('‚ùå Etiket silinirken hata olu≈ütu: ' + error.message, 'danger');
            }
        };
        
        // Global bran≈ü sayacƒ±
        let branchFieldCounter = 0;
        
        // Bran≈ü field HTML'i olu≈ütur
        function generateBranchFieldHTML(params) {
            const { index, branchId, branchData, ageGroup, fullName, parentName, children, selectedTag, kayitOlabilirDate, denemeDate, notesHistory, newNote } = params;
            
            const nonBranchTags = crmTags
                .filter(tag => tag.category !== 'branch')
                .sort((a, b) => (a.order || 999) - (b.order || 999));
            
            // √áocuklarƒ± render et
            const childrenArray = children || [];
            const childrenHtml = childrenArray.map((child, childIndex) => `
                <div style="padding: 15px; background: white; border-radius: 8px; border: 2px solid #e0e0e0; margin-bottom: 10px; position: relative;" data-child-index="${childIndex}">
                    <button type="button" onclick="removeChildFromBranch(${index}, ${childIndex})" style="position: absolute; top: 10px; right: 10px; background: #f44336; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 16px; z-index: 10;">√ó</button>
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 11px; color: #666;">√áocuk Ad Soyad</label>
                            <input type="text" placeholder="Ad Soyad" value="${child.name || ''}" class="form-control" onchange="updateChildData(${index}, ${childIndex}, 'name', this.value)">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 11px; color: #666;">Ya≈ü</label>
                            <input type="number" placeholder="Ya≈ü" value="${child.age || ''}" class="form-control" min="1" max="18" onchange="updateChildData(${index}, ${childIndex}, 'age', this.value)">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-size: 11px; color: #666;">üè∑Ô∏è Etiket *</label>
                        <select class="form-control" required onchange="updateChildData(${index}, ${childIndex}, 'selectedTag', this.value); handleChildTagSelection(${index}, ${childIndex}, this)">
                            <option value="">Etiket se√ßiniz...</option>
                            ${nonBranchTags.map(tag => `<option value="${tag.name}" ${child.selectedTag === tag.name ? 'selected' : ''}>${tag.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div id="child-${index}-${childIndex}-dates" style="display: ${child.selectedTag ? 'block' : 'none'};">
                        <div id="child-${index}-${childIndex}-kayit" style="display: ${child.selectedTag === 'Kayƒ±t Olabilir' ? 'block' : 'none'}; margin-bottom: 10px;">
                            <label style="font-size: 11px; color: #666;">üìÖ Kayƒ±t Olabilir Tarihi</label>
                            <input type="datetime-local" value="${child.kayitOlabilirDate || ''}" class="form-control" onchange="updateChildData(${index}, ${childIndex}, 'kayitOlabilirDate', this.value)">
                        </div>
                        
                        <div id="child-${index}-${childIndex}-deneme" style="display: ${child.selectedTag === 'Denemeye Gelecek' ? 'block' : 'none'}; margin-bottom: 10px;">
                            <label style="font-size: 11px; color: #666;">üìÖ Deneme Dersi Tarihi</label>
                            <input type="datetime-local" value="${child.denemeDate || ''}" class="form-control" onchange="updateChildData(${index}, ${childIndex}, 'denemeDate', this.value)">
                        </div>
                    </div>
                </div>
            `).join('');
            
            return `
                <div class="branch-field-card" id="branch-field-${index}" style="background: #f9f9f9; border: 2px solid #ddd; border-radius: 12px; padding: 15px; margin-bottom: 15px; position: relative;">
                    <button type="button" onclick="removeBranchField(${index})" style="position: absolute; top: 10px; right: 10px; background: #f44336; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px; z-index: 10;">√ó</button>
                    
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label>Bran≈ü *</label>
                            <select name="branches[${index}][branchId]" class="form-control" required>
                                <option value="">Se√ßiniz...</option>
                                ${branches.map(b => `<option value="${b.id}" ${branchId === b.id ? 'selected' : ''}>${b.icon} ${b.name}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Ya≈ü Grubu *</label>
                            <select name="branches[${index}][ageGroup]" class="form-control" required onchange="handleBranchAgeGroupChange(${index}, this)">
                                <option value="">Se√ßiniz...</option>
                                <option value="adult" ${ageGroup === 'adult' ? 'selected' : ''}>üë® Yeti≈ükin</option>
                                <option value="child" ${ageGroup === 'child' ? 'selected' : ''}>üë∂ √áocuk</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="branch-tag-field-${index}">
                            <label>üè∑Ô∏è Etiket *</label>
                            <select name="branches[${index}][selectedTag]" class="form-control" required onchange="handleBranchTagSelection(${index}, this)">
                                <option value="">Etiket se√ßiniz...</option>
                                ${nonBranchTags.map(tag => `<option value="${tag.name}" ${selectedTag === tag.name ? 'selected' : ''}>${tag.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Yeti≈ükin i√ßin Alan -->
                    <div id="branch-adult-${index}" style="display: ${ageGroup === 'adult' ? 'block' : 'none'};">
                        <div class="form-group">
                            <label>Ad Soyad *</label>
                            <input type="text" name="branches[${index}][fullName]" class="form-control" value="${fullName || ''}">
                        </div>
                        
                        <!-- Yeti≈ükin i√ßin √∂zel etiket tarihleri -->
                        <div id="branch-adult-dates-${index}" style="display: ${selectedTag ? 'block' : 'none'};">
                            <div id="branch-adult-kayit-${index}" style="display: ${selectedTag === 'Kayƒ±t Olabilir' ? 'block' : 'none'};">
                                <div class="form-group">
                                    <label>üìÖ Kayƒ±t Olabilir Tarihi</label>
                                    <input type="datetime-local" name="branches[${index}][kayitOlabilirDate]" class="form-control" value="${kayitOlabilirDate || ''}">
                                </div>
                            </div>
                            
                            <div id="branch-adult-deneme-${index}" style="display: ${selectedTag === 'Denemeye Gelecek' ? 'block' : 'none'};">
                                <div class="form-group">
                                    <label>üìÖ Deneme Dersi Tarihi</label>
                                    <input type="datetime-local" name="branches[${index}][denemeDate]" class="form-control" value="${denemeDate || ''}">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- √áocuk i√ßin Alanlar -->
                    <div id="branch-child-${index}" style="display: ${ageGroup === 'child' ? 'block' : 'none'};">
                        <div class="form-group">
                            <label>Veli Ad Soyad *</label>
                            <input type="text" name="branches[${index}][parentName]" class="form-control" value="${parentName || ''}" list="parent-names-${index}" placeholder="Veli ismi giriniz (varsa listeden se√ßebilirsiniz)">
                            <datalist id="parent-names-${index}">
                                ${window.existingParentNames && window.existingParentNames.length > 0 
                                    ? window.existingParentNames.map(name => `<option value="${name}">${name}</option>`).join('')
                                    : ''}
                            </datalist>
                        </div>
                        
                        <div class="form-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <label style="margin: 0;">üë∂ √áocuklar</label>
                                <button type="button" class="btn btn-sm btn-success" onclick="addChildToBranch(${index})">+ √áocuk Ekle</button>
                            </div>
                            <div id="branch-children-${index}">
                                ${childrenHtml || '<p style="color: #999; font-size: 12px; text-align: center; padding: 10px;">Hen√ºz √ßocuk eklenmedi</p>'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>üìù A√ßƒ±klama</label>
                        <textarea name="branches[${index}][newNote]" class="form-control" rows="2" placeholder="Bu bran≈ü i√ßin a√ßƒ±klama...">${newNote || ''}</textarea>
                    </div>
                    
                    ${notesHistory && notesHistory.length > 0 ? `
                        <div class="form-group">
                            <label>üìã Ge√ßmi≈ü A√ßƒ±klamalar</label>
                            <div style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: white;">
                                ${notesHistory.slice().reverse().map((note, reverseIndex) => {
                                    const noteIndex = notesHistory.length - 1 - reverseIndex;
                                    return `
                                    <div style="padding: 8px; margin-bottom: 8px; border-left: 3px solid var(--primary-color); background: #f9f9f9; position: relative;">
                                        <button type="button" onclick="deleteBranchNote(${index}, ${noteIndex})" style="position: absolute; top: 5px; right: 5px; background: #f44336; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 14px;">√ó</button>
                                        <div style="font-size: 11px; color: #666; margin-bottom: 4px;">üë§ ${note.by} - ${note.date}</div>
                                        <div style="font-size: 12px; white-space: pre-wrap;">${note.text}</div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <input type="hidden" name="branches[${index}][notesHistory]" value='${notesHistory ? JSON.stringify(notesHistory) : '[]'}'>
                    <input type="hidden" name="branches[${index}][children]" value='${childrenArray.length > 0 ? JSON.stringify(childrenArray) : '[]'}'>
                </div>
            `;
        }
        
        // Bran≈ü alanƒ± ekle
        window.addBranchField = function(branchData = null) {
            const index = branchFieldCounter++;
            const container = document.getElementById('branches-container');
            
            const branchHtml = generateBranchFieldHTML({
                index: index,
                branchId: branchData?.branchId,
                branchData: branchData,
                ageGroup: branchData?.ageGroup || 'adult',
                fullName: branchData?.fullName || '',
                parentName: branchData?.parentName || '',
                children: branchData?.children || [],
                selectedTag: branchData?.selectedTag || '',
                kayitOlabilirDate: branchData?.kayitOlabilirDate || '',
                denemeDate: branchData?.denemeDate || '',
                notesHistory: branchData?.notesHistory || [],
                newNote: branchData?.newNote || ''
            });
            
            container.insertAdjacentHTML('beforeend', branchHtml);
            
            // Etiket se√ßilmi≈üse tarihleri g√∂ster
            if (branchData && branchData.selectedTag) {
                const select = document.querySelector(`[name="branches[${index}][selectedTag]"]`);
                if (select) {
                    handleBranchTagSelection(index, select);
                }
            }
        };
        
        // Bran≈ü etiket se√ßimi (Yeti≈ükinler i√ßin)
        window.handleBranchTagSelection = function(index, selectElement) {
            const selectedTag = selectElement.value;
            const datesContainer = document.getElementById(`branch-adult-dates-${index}`);
            const kayitField = document.getElementById(`branch-adult-kayit-${index}`);
            const denemeField = document.getElementById(`branch-adult-deneme-${index}`);
            
            if (!datesContainer) return; // √áocuk bran≈üƒ± ise
            
            const kayitInput = kayitField?.querySelector('input[type="datetime-local"]');
            const denemeInput = denemeField?.querySelector('input[type="datetime-local"]');
            
            if (selectedTag === 'Kayƒ±t Olabilir') {
                datesContainer.style.display = 'block';
                kayitField.style.display = 'block';
                denemeField.style.display = 'none';
                if (kayitInput) kayitInput.required = false;
                if (denemeInput) {
                    denemeInput.required = false;
                    // ‚úÖ Deneme tarihi Sƒ∞Lƒ∞NMEYECEK - sadece gizlenecek (manuel kaldƒ±rma i√ßin korunacak)
                }
            } else if (selectedTag === 'Denemeye Gelecek') {
                datesContainer.style.display = 'block';
                kayitField.style.display = 'none';
                denemeField.style.display = 'block';
                if (denemeInput) denemeInput.required = false; // ‚úÖ JavaScript validasyonu kullanƒ±lƒ±yor, HTML required kaldƒ±rƒ±ldƒ±
                if (kayitInput) {
                    kayitInput.required = false;
                    // ‚úÖ Kayƒ±t tarihi Sƒ∞Lƒ∞NMEYECEK - sadece gizlenecek
                }
            } else {
                datesContainer.style.display = 'none';
                kayitField.style.display = 'none';
                denemeField.style.display = 'none';
                if (kayitInput) {
                    kayitInput.required = false;
                    // ‚úÖ Kayƒ±t tarihi Sƒ∞Lƒ∞NMEYECEK - sadece gizlenecek
                }
                if (denemeInput) {
                    denemeInput.required = false;
                    // ‚úÖ Deneme tarihi Sƒ∞Lƒ∞NMEYECEK - sadece gizlenecek (manuel kaldƒ±rma i√ßin korunacak)
                }
            }
        };
        
        // Bran≈ü ya≈ü grubu deƒüi≈üimi
        window.handleBranchAgeGroupChange = function(branchIndex, selectElement) {
            const value = selectElement.value;
            const adultDiv = document.getElementById(`branch-adult-${branchIndex}`);
            const childDiv = document.getElementById(`branch-child-${branchIndex}`);
            const tagField = document.getElementById(`branch-tag-field-${branchIndex}`);
            const tagSelect = document.querySelector(`[name="branches[${branchIndex}][selectedTag]"]`);
            
            if (value === 'adult') {
                adultDiv.style.display = 'block';
                childDiv.style.display = 'none';
                if (tagField) tagField.style.display = 'block'; // Yeti≈ükin i√ßin etiket g√∂ster
                if (tagSelect) tagSelect.required = true; // ‚úÖ Etiket zorunlu
                // Adult zorunlu yap
                const fullNameInput = document.querySelector(`[name="branches[${branchIndex}][fullName]"]`);
                if (fullNameInput) fullNameInput.required = true;
                // Child opsiyonel yap
                const parentNameInput = document.querySelector(`[name="branches[${branchIndex}][parentName]"]`);
                if (parentNameInput) parentNameInput.required = false;
            } else if (value === 'child') {
                adultDiv.style.display = 'none';
                childDiv.style.display = 'block';
                if (tagField) tagField.style.display = 'none'; // √áocuk i√ßin etiket gizle
                if (tagSelect) {
                    tagSelect.required = false; // ‚úÖ Etiket zorunlu deƒüil
                    tagSelect.value = ''; // ‚úÖ Deƒüeri temizle
                }
                // Child zorunlu yap
                const parentNameInput = document.querySelector(`[name="branches[${branchIndex}][parentName]"]`);
                if (parentNameInput) parentNameInput.required = true;
                // Adult opsiyonel yap
                const fullNameInput = document.querySelector(`[name="branches[${branchIndex}][fullName]"]`);
                if (fullNameInput) fullNameInput.required = false;
            } else {
                adultDiv.style.display = 'none';
                childDiv.style.display = 'none';
                if (tagField) tagField.style.display = 'block';
                if (tagSelect) tagSelect.required = true; // ‚úÖ Etiket zorunlu
            }
        };
        
        // Bran≈üa √ßocuk ekle
        window.addChildToBranch = function(branchIndex) {
            const container = document.getElementById(`branch-children-${branchIndex}`);
            const childrenInput = document.querySelector(`[name="branches[${branchIndex}][children]"]`);
            const children = JSON.parse(childrenInput.value || '[]');
            
            const childIndex = children.length;
            children.push({ name: '', age: '', selectedTag: '', kayitOlabilirDate: '', denemeDate: '' });
            childrenInput.value = JSON.stringify(children);
            
            const nonBranchTags = crmTags
                .filter(tag => tag.category !== 'branch')
                .sort((a, b) => (a.order || 999) - (b.order || 999));
            
            const childHtml = `
                <div style="padding: 15px; background: white; border-radius: 8px; border: 2px solid #e0e0e0; margin-bottom: 10px; position: relative;" data-child-index="${childIndex}">
                    <button type="button" onclick="removeChildFromBranch(${branchIndex}, ${childIndex})" style="position: absolute; top: 10px; right: 10px; background: #f44336; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 16px; z-index: 10;">√ó</button>
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 11px; color: #666;">√áocuk Ad Soyad</label>
                            <input type="text" placeholder="Ad Soyad" class="form-control" onchange="updateChildData(${branchIndex}, ${childIndex}, 'name', this.value)">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 11px; color: #666;">Ya≈ü</label>
                            <input type="number" placeholder="Ya≈ü" class="form-control" min="1" max="18" onchange="updateChildData(${branchIndex}, ${childIndex}, 'age', this.value)">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-size: 11px; color: #666;">üè∑Ô∏è Etiket</label>
                        <select class="form-control" onchange="updateChildData(${branchIndex}, ${childIndex}, 'selectedTag', this.value); handleChildTagSelection(${branchIndex}, ${childIndex}, this)">
                            <option value="">Etiket se√ßiniz...</option>
                            ${nonBranchTags.map(tag => `<option value="${tag.name}">${tag.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div id="child-${branchIndex}-${childIndex}-dates" style="display: none;">
                        <div id="child-${branchIndex}-${childIndex}-kayit" style="display: none; margin-bottom: 10px;">
                            <label style="font-size: 11px; color: #666;">üìÖ Kayƒ±t Olabilir Tarihi</label>
                            <input type="datetime-local" class="form-control" onchange="updateChildData(${branchIndex}, ${childIndex}, 'kayitOlabilirDate', this.value)">
                        </div>
                        
                        <div id="child-${branchIndex}-${childIndex}-deneme" style="display: none; margin-bottom: 10px;">
                            <label style="font-size: 11px; color: #666;">üìÖ Deneme Dersi Tarihi</label>
                            <input type="datetime-local" class="form-control" onchange="updateChildData(${branchIndex}, ${childIndex}, 'denemeDate', this.value)">
                        </div>
                    </div>
                </div>
            `;
            
            if (container.querySelector('p')) {
                container.innerHTML = '';
            }
            container.insertAdjacentHTML('beforeend', childHtml);
        };
        
        // √áocuk verisini g√ºncelle
        window.updateChildData = function(branchIndex, childIndex, field, value) {
            const childrenInput = document.querySelector(`[name="branches[${branchIndex}][children]"]`);
            const children = JSON.parse(childrenInput.value || '[]');
            if (children[childIndex]) {
                children[childIndex][field] = value;
                childrenInput.value = JSON.stringify(children);
            }
        };
        
        // √áocuƒüu bran≈ütan kaldƒ±r
        window.removeChildFromBranch = function(branchIndex, childIndex) {
            const childrenInput = document.querySelector(`[name="branches[${branchIndex}][children]"]`);
            const children = JSON.parse(childrenInput.value || '[]');
            children.splice(childIndex, 1);
            childrenInput.value = JSON.stringify(children);
            
            // UI'den kaldƒ±r
            const container = document.getElementById(`branch-children-${branchIndex}`);
            const childElements = container.querySelectorAll('[data-child-index]');
            childElements[childIndex]?.remove();
            
            // Eƒüer hi√ß √ßocuk kalmadƒ±ysa mesaj g√∂ster
            if (children.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 12px; text-align: center; padding: 10px;">Hen√ºz √ßocuk eklenmedi</p>';
            }
        };
        
        // Bran≈ü alanƒ±nƒ± kaldƒ±r
        window.removeBranchField = function(index) {
            const field = document.getElementById(`branch-field-${index}`);
            if (field) {
                field.remove();
            }
        };
        
        // Bran≈ü not silme
        window.deleteBranchNote = function(branchIndex, noteIndex) {
            const notesInput = document.querySelector(`[name="branches[${branchIndex}][notesHistory]"]`);
            if (notesInput) {
                const notesHistory = JSON.parse(notesInput.value || '[]');
                notesHistory.splice(noteIndex, 1);
                notesInput.value = JSON.stringify(notesHistory);
                
                // Kartƒ± yeniden render et
                const branchField = document.getElementById(`branch-field-${branchIndex}`);
                if (branchField) {
                    // Mevcut deƒüerleri al
                    const branchId = document.querySelector(`[name="branches[${branchIndex}][branchId]"]`).value;
                    const selectedTag = document.querySelector(`[name="branches[${branchIndex}][selectedTag]"]`).value;
                    const kayitDate = document.querySelector(`[name="branches[${branchIndex}][kayitOlabilirDate]"]`)?.value;
                    const denemeDate = document.querySelector(`[name="branches[${branchIndex}][denemeDate]"]`)?.value;
                    const newNote = document.querySelector(`[name="branches[${branchIndex}][newNote]"]`).value;
                    
                    // Kartƒ± kaldƒ±r
                    branchField.remove();
                    
                    // Yeni kart ekle
                    branchFieldCounter--;
                    addBranchField({
                        branchId,
                        selectedTag,
                        kayitOlabilirDate: kayitDate,
                        denemeDate: denemeDate,
                        newNote,
                        notesHistory
                    });
                }
            }
        };
        
        
        // Her √ßocuk i√ßin etiket se√ßimi
        window.handleChildTagSelection = function(branchIndex, childIndex, selectElement) {
            const selectedTag = selectElement.value;
            const datesContainer = document.getElementById(`child-${branchIndex}-${childIndex}-dates`);
            const kayitField = document.getElementById(`child-${branchIndex}-${childIndex}-kayit`);
            const denemeField = document.getElementById(`child-${branchIndex}-${childIndex}-deneme`);
            
            // Tarih inputlarƒ±nƒ± bul
            const kayitInput = kayitField?.querySelector('input[type="datetime-local"]');
            const denemeInput = denemeField?.querySelector('input[type="datetime-local"]');
            
            if (selectedTag === 'Kayƒ±t Olabilir') {
                datesContainer.style.display = 'block';
                kayitField.style.display = 'block';
                denemeField.style.display = 'none';
                if (kayitInput) kayitInput.required = false;
                if (denemeInput) {
                    denemeInput.required = false;
                    // ‚úÖ Deneme tarihi Sƒ∞Lƒ∞NMEYECEK - sadece gizlenecek (manuel kaldƒ±rma i√ßin korunacak)
                }
            } else if (selectedTag === 'Denemeye Gelecek') {
                datesContainer.style.display = 'block';
                kayitField.style.display = 'none';
                denemeField.style.display = 'block';
                if (denemeInput) denemeInput.required = false; // ‚úÖ JavaScript validasyonu kullanƒ±lƒ±yor, HTML required kaldƒ±rƒ±ldƒ±
                if (kayitInput) {
                    kayitInput.required = false;
                    // ‚úÖ Kayƒ±t tarihi Sƒ∞Lƒ∞NMEYECEK - sadece gizlenecek
                }
            } else {
                if (datesContainer) datesContainer.style.display = 'none';
                if (kayitField) kayitField.style.display = 'none';
                if (denemeField) denemeField.style.display = 'none';
                if (kayitInput) kayitInput.required = false;
                if (denemeInput) denemeInput.required = false;
                // ‚úÖ Tarihler Sƒ∞Lƒ∞NMEYECEK - sadece gizlenecek (manuel kaldƒ±rma i√ßin korunacak)
            }
        };
        
        // Ya≈ü grubu deƒüi≈ütiƒüinde alanlarƒ± g√∂ster/gizle
        window.handleAgeGroupChange = function(selectElement) {
            const value = selectElement.value;
            const childFields = document.getElementById('child-fields');
            const adultFields = document.getElementById('adult-fields');
            
            if (value === 'child') {
                childFields.style.display = 'block';
                adultFields.style.display = 'none';
                // Sadece veli ismi zorunlu
                childFields.querySelectorAll('input').forEach(input => {
                    if (input.name === 'parentName') {
                        input.required = true;
                    } else {
                        input.required = false;
                    }
                });
                adultFields.querySelectorAll('input').forEach(input => input.required = false);
            } else if (value === 'adult') {
                childFields.style.display = 'none';
                adultFields.style.display = 'block';
                // Yeti≈ükin ismi zorunlu
                adultFields.querySelectorAll('input').forEach(input => input.required = true);
                childFields.querySelectorAll('input').forEach(input => input.required = false);
            } else {
                childFields.style.display = 'none';
                adultFields.style.display = 'none';
            }
        };
        
        // Tek etiket se√ßimi deƒüi≈ütiƒüinde tarih alanlarƒ±nƒ± g√∂ster/gizle
        window.handleSingleTagSelection = function(selectElement) {
            const selectedTag = selectElement.value;
            
            const tagDateFields = document.getElementById('tag-date-fields');
            const kayitOlabilirField = document.getElementById('kayit-olabilir-date');
            const denemeField = document.getElementById('denemeye-gelecek-date');
            
            // Kayƒ±t Olabilir se√ßildi mi?
            if (selectedTag === 'Kayƒ±t Olabilir') {
                kayitOlabilirField.style.display = 'block';
                denemeField.style.display = 'none';
                tagDateFields.style.display = 'block';
            } else if (selectedTag === 'Denemeye Gelecek') {
                denemeField.style.display = 'block';
                kayitOlabilirField.style.display = 'none';
                tagDateFields.style.display = 'block';
            } else {
                kayitOlabilirField.style.display = 'none';
                denemeField.style.display = 'none';
                tagDateFields.style.display = 'none';
            }
        };
        
        // Eski handleTagSelection fonksiyonu - artƒ±k kullanƒ±lmƒ±yor ama uyumluluk i√ßin bƒ±rakƒ±yoruz
        window.handleTagSelection = function(selectElement) {
            const selectedTags = Array.from(selectElement.selectedOptions).map(o => o.value);
            
            const tagDateFields = document.getElementById('tag-date-fields');
            const kayitOlabilirField = document.getElementById('kayit-olabilir-date');
            const denemeField = document.getElementById('denemeye-gelecek-date');
            
            // Kayƒ±t Olabilir se√ßildi mi?
            if (selectedTags.includes('Kayƒ±t Olabilir')) {
                kayitOlabilirField.style.display = 'block';
                tagDateFields.style.display = 'block';
            } else {
                kayitOlabilirField.style.display = 'none';
            }
            
            // Denemeye Gelecek se√ßildi mi?
            if (selectedTags.includes('Denemeye Gelecek')) {
                denemeField.style.display = 'block';
                tagDateFields.style.display = 'block';
            } else {
                denemeField.style.display = 'none';
            }
            
            // Hi√ßbiri se√ßili deƒüilse gizle
            if (!selectedTags.includes('Kayƒ±t Olabilir') && !selectedTags.includes('Denemeye Gelecek')) {
                tagDateFields.style.display = 'none';
            }
        };
    
        // Telefon numarasƒ± kontrol√º
        let phoneCheckTimeout;
        let lastCheckedPhone = '';
        window.checkExistingPhone = function(phone) {
            clearTimeout(phoneCheckTimeout);
            const messageDiv = document.getElementById('phone-check-message');
            const form = document.getElementById('addLeadForm');
            
            // Telefon numarasƒ± deƒüi≈ütiƒüinde ve daha √∂nce bir m√º≈üteri y√ºklendiyse formu temizle
            if (lastCheckedPhone && phone && lastCheckedPhone !== phone && form.dataset.leadId) {
                // Formu sƒ±fƒ±rla
                clearAddLeadForm();
                messageDiv.innerHTML = '';
                lastCheckedPhone = '';
            }
            
            if (!phone || phone.length < 10) {
                messageDiv.innerHTML = '';
                return;
            }
            
            phoneCheckTimeout = setTimeout(() => {
                const existingLead = crmLeads.find(l => phonesMatch(l.phone, phone));
                
                if (existingLead) {
                    // Mevcut m√º≈üteri bulundu
                    const branchNames = existingLead.branches?.map(b => {
                        const branch = branches.find(br => br.id === b.branchId);
                        return branch ? branch.name : 'Yok';
                    }).join(', ') || 'Yok';
                    
                    // Mevcut veli isimlerini topla
                    const parentNames = new Set();
                    if (existingLead.branches && existingLead.branches.length > 0) {
                        existingLead.branches.forEach(branch => {
                            if (branch.ageGroup === 'child' && branch.parentName) {
                                parentNames.add(branch.parentName);
                            }
                        });
                    }
                    window.existingParentNames = Array.from(parentNames);
                    
                    let displayName = 'M√º≈üteri';
                    if (existingLead.branches && existingLead.branches.length > 0) {
                        const firstBranch = existingLead.branches[0];
                        if (firstBranch.ageGroup === 'adult') {
                            displayName = firstBranch.fullName || 'M√º≈üteri';
                        } else {
                            displayName = firstBranch.parentName || 'Veli';
                        }
                    }
                    
                    messageDiv.innerHTML = `<span style="color: #2196F3;">‚úÖ Mevcut m√º≈üteri: <strong>${displayName}</strong> (${branchNames}). Yeni bran≈ü ekleyebilirsiniz.</span>`;
                    
                    // Mevcut m√º≈üterinin bilgilerini y√ºkle
                    form.dataset.leadId = existingLead.id;
                    form.elements['source'].value = existingLead.source || 'other';
                    
                    // Sekmeli yapƒ± olu≈ütur
                    branchFieldCounter = 0;
                    const mainContainer = document.getElementById('branches-container');
                    mainContainer.innerHTML = '';
                    
                    if (existingLead.branches && existingLead.branches.length > 0) {
                        // Sekmeli yapƒ± olu≈ütur
                        let tabsHtml = '<div class="customer-tabs" style="margin-bottom: 15px;">';
                        let tabContentsHtml = '<div id="edit-tabs-content">';
                        
                        existingLead.branches.forEach((branch, index) => {
                            const branchObj = branches.find(b => b.id === branch.branchId);
                            const baseBranchName = branchObj ? `${branchObj.icon} ${branchObj.name}` : 'Bran≈ü';
                            const ageGroupPrefix = branch.ageGroup === 'child' ? 'üë∂ √áOCUK - ' : 
                                                   branch.ageGroup === 'adult' ? 'üë® YETƒ∞≈ûKƒ∞N - ' : '';
                            const branchName = ageGroupPrefix + baseBranchName;
                            
                            // Sekme ba≈ülƒ±ƒüƒ±
                            tabsHtml += `
                                <button type="button" class="tab-button ${index === 0 ? 'active' : ''}" onclick="switchEditTab(${index})">
                                    ${branchName}
                                </button>
                            `;
                            
                            // formatDate fonksiyonu
                            const formatDate = (dateStr) => {
                                if (!dateStr) return '';
                                const d = new Date(dateStr);
                                if (isNaN(d.getTime())) return '';
                                const y = d.getFullYear();
                                const m = String(d.getMonth() + 1).padStart(2, '0');
                                const day = String(d.getDate()).padStart(2, '0');
                                const h = String(d.getHours()).padStart(2, '0');
                                const min = String(d.getMinutes()).padStart(2, '0');
                                return y + '-' + m + '-' + day + 'T' + h + ':' + min;
                            };
                            
                            // Bu bran≈ü i√ßin i√ßeriƒüi olu≈ütur
                            const branchFieldHtml = generateBranchFieldHTML({
                                index: index,
                                branchId: branch.branchId,
                                branchData: branch,
                                ageGroup: branch.ageGroup || 'adult',
                                fullName: branch.fullName || '',
                                parentName: branch.parentName || '',
                                children: branch.children || [],
                                selectedTag: branch.selectedTag || '',
                                kayitOlabilirDate: formatDate(branch.kayitOlabilirDate),
                                denemeDate: formatDate(branch.denemeDate),
                                notesHistory: branch.notesHistory || [],
                                newNote: ''
                            });
                            
                            // Sekme i√ßeriƒüi
                            tabContentsHtml += `
                                <div class="tab-content ${index === 0 ? 'active' : ''}" id="edit-tab-${index}" style="display: ${index === 0 ? 'block' : 'none'};">
                                    ${branchFieldHtml}
                                </div>
                            `;
                        });
                        
                        // Yeni bran≈ü ekleme sekmesi
                        const newIndex = existingLead.branches.length;
                        tabsHtml += `
                            <button type="button" class="tab-button" onclick="switchEditTab(${newIndex})" style="background: #4CAF50; color: white;">
                                ‚ûï Yeni Bran≈ü
                            </button>
                        `;
                        
                        // ‚úÖ Yeni bran≈ü formu i√ßin tab content ekle
                        const newBranchFormHtml = generateBranchFieldHTML({
                            index: newIndex,
                            branchId: '',
                            ageGroup: '',
                            selectedTag: '',
                            fullName: '',
                            parentName: '',
                            newNote: '',
                            notesHistory: [],
                            childrenArray: [],
                            kayitOlabilirDate: '',
                            denemeDate: ''
                        });
                        
                        tabContentsHtml += `
                            <div class="tab-content" id="edit-tab-${newIndex}" style="display: none;">
                                ${newBranchFormHtml}
                            </div>
                        `;
                        
                        tabsHtml += '</div>';
                        tabContentsHtml += '</div>';
                        
                        mainContainer.innerHTML = tabsHtml + tabContentsHtml;
                        
                        // Her bran≈ü i√ßin event handler'larƒ± ayarla
                        existingLead.branches.forEach((branch, index) => {
                            const ageGroupSelect = document.querySelector(`#edit-tab-${index} [name="branches[${index}][ageGroup]"]`);
                            if (ageGroupSelect && branch.ageGroup) {
                                handleBranchAgeGroupChange(index, ageGroupSelect);
                            }
                            
                            const tagSelect = document.querySelector(`#edit-tab-${index} [name="branches[${index}][selectedTag]"]`);
                            if (tagSelect && branch.selectedTag) {
                                handleBranchTagSelection(index, tagSelect);
                            }
                        });
                        
                        // ‚úÖ ƒ∞lk sekmeyi aktif et ve required alanlarƒ± enable et
                        setTimeout(() => {
                            switchEditTab(0);
                        }, 100);
                    } else {
                        // Hi√ß bran≈ü yoksa tek bran≈ü ekle
                        addBranchField();
                    }
                    
                    document.querySelector('#addLeadModal h3').textContent = `‚úèÔ∏è ${displayName} - Bran≈ü Ekle/D√ºzenle`;
                    
                    // Son kontrol edilen telefonu kaydet
                    lastCheckedPhone = phone;
                } else {
                    // Yeni m√º≈üteri
                    messageDiv.innerHTML = '<span style="color: #4CAF50;">‚úÖ Yeni m√º≈üteri kaydƒ±</span>';
                    form.removeAttribute('data-lead-id');
                    document.querySelector('#addLeadModal h3').textContent = '‚ûï Yeni Potansiyel M√º≈üteri';
                    
                    // Son kontrol edilen telefonu kaydet
                    lastCheckedPhone = phone;
                }
            }, 500);
        };
        
        // Form temizleme fonksiyonu
        function clearAddLeadForm() {
            const form = document.getElementById('addLeadForm');
            if (!form) return;
            
            // leadId'yi temizle
            form.removeAttribute('data-lead-id');
            
            // Telefon hari√ß formu resetle (telefon inputu deƒüi≈ümemeli)
            const phoneInput = form.querySelector('input[name="phone"]');
            const phoneValue = phoneInput ? phoneInput.value : '';
            
            // Kaynaƒüƒ± varsayƒ±lana √ßek
            const sourceSelect = form.querySelector('select[name="source"]');
            if (sourceSelect) sourceSelect.value = 'other';
            
            // Bran≈ü container'ƒ± temizle ve yeni bir tane ekle
            const branchesContainer = document.getElementById('branches-container');
            if (branchesContainer) {
                branchesContainer.innerHTML = '';
                branchFieldCounter = 0;
                addBranchField();
            }
            
            // Telefon deƒüerini geri yaz
            if (phoneInput) phoneInput.value = phoneValue;
            
            // Modal ba≈ülƒ±ƒüƒ±nƒ± g√ºncelle
            document.querySelector('#addLeadModal h3').textContent = '‚ûï Yeni Potansiyel M√º≈üteri';
            
            // Global deƒüi≈ükenleri temizle
            window.existingParentNames = [];
            lastCheckedPhone = '';
        }
        
        // Lead Modal A√ß
        function openAddLeadModal() {
            const modal = document.getElementById('addLeadModal');
            if (!modal) {
                console.error('‚ùå addLeadModal bulunamadƒ±!');
                return;
            }
            
            const form = document.getElementById('addLeadForm');
            form.reset();
            form.removeAttribute('data-lead-id');
            
            // Submit butonunu resetle
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'üíæ Kaydet';
            }
            
            // Mesajƒ± temizle
            document.getElementById('phone-check-message').innerHTML = '';
            
            // Bran≈ü container'ƒ± temizle
            document.getElementById('branches-container').innerHTML = '';
            branchFieldCounter = 0;
            
            // Otomatik ilk bran≈ü ekle
            addBranchField();
            
            // Bran≈ü ekleme butonunu g√∂ster (yeni m√º≈üteri modunda)
            const addBranchBtn = document.querySelector('#addLeadModal .btn-success[onclick*="addBranchField"]');
            if (addBranchBtn) addBranchBtn.style.display = 'inline-block';
            
            // lastCheckedPhone'u sƒ±fƒ±rla
            lastCheckedPhone = '';
            
            document.querySelector('#addLeadModal h3').textContent = '‚ûï Yeni Potansiyel M√º≈üteri';
            openModal('addLeadModal');
        }
        
        // Lead D√ºzenle
        function editLead(leadId, openBranchIndex = 0) {
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) {
                console.error('Lead bulunamadƒ±:', leadId);
                return;
            }
            
            const modal = document.getElementById('addLeadModal');
            const form = document.getElementById('addLeadForm');
            
            form.elements['phone'].value = lead.phone || '';
            form.elements['source'].value = lead.source || 'other';
            
            const formatDate = (date) => {
                if (!date) return '';
                const d = new Date(date);
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const h = String(d.getHours()).padStart(2, '0');
                const min = String(d.getMinutes()).padStart(2, '0');
                return `${y}-${m}-${day}T${h}:${min}`;
            };
            
            // Sekmeli yapƒ± olu≈ütur
            branchFieldCounter = 0;
            
            // √ñnce container'ƒ± temizle
            const mainContainer = document.getElementById('branches-container');
            mainContainer.innerHTML = '';
            
            if (lead.branches && lead.branches.length > 0) {
                // Sekmeli yapƒ± olu≈ütur
                let tabsHtml = '<div class="customer-tabs" style="margin-bottom: 15px;">';
                let tabContentsHtml = '<div id="edit-tabs-content">';
                
                lead.branches.forEach((branch, index) => {
                    const branchObj = branches.find(b => b.id === branch.branchId);
                    const baseBranchName = branchObj ? `${branchObj.icon} ${branchObj.name}` : 'Bran≈ü';
                    const ageGroupPrefix = branch.ageGroup === 'child' ? 'üë∂ √áOCUK - ' : 
                                           branch.ageGroup === 'adult' ? 'üë® YETƒ∞≈ûKƒ∞N - ' : '';
                    const branchName = ageGroupPrefix + baseBranchName;
                    
                    // Sekme ba≈ülƒ±ƒüƒ± - openBranchIndex'e g√∂re aktif sekmeyi belirle
                    tabsHtml += `
                        <button type="button" class="tab-button ${index === openBranchIndex ? 'active' : ''}" onclick="switchEditTab(${index})">
                            ${branchName}
                        </button>
                    `;
                    
                    // Bu bran≈ü i√ßin ayrƒ± field container olu≈ütur
                    const tempContainer = document.createElement('div');
                    tempContainer.id = 'temp-branch-container';
                    
                    // addBranchField ile i√ßeriƒüi olu≈ütur
                    const branchFieldHtml = generateBranchFieldHTML({
                        index: index,
                        branchId: branch.branchId,
                        branchData: branch,
                        ageGroup: branch.ageGroup || 'adult',
                        fullName: branch.fullName || '',
                        parentName: branch.parentName || '',
                        children: branch.children || [],
                        selectedTag: branch.selectedTag || '',
                        kayitOlabilirDate: formatDate(branch.kayitOlabilirDate),
                        denemeDate: formatDate(branch.denemeDate),
                        notesHistory: branch.notesHistory || [],
                        newNote: ''
                    });
                    
                    // Sekme i√ßeriƒüi - openBranchIndex'e g√∂re g√∂ster
                    tabContentsHtml += `
                        <div class="tab-content ${index === openBranchIndex ? 'active' : ''}" id="edit-tab-${index}" style="display: ${index === openBranchIndex ? 'block' : 'none'};">
                            ${branchFieldHtml}
                        </div>
                    `;
                });
                
                tabsHtml += '</div>';
                tabContentsHtml += '</div>';
                
                mainContainer.innerHTML = tabsHtml + tabContentsHtml;
                
                // Her bran≈ü i√ßin event handler'larƒ± ayarla
                lead.branches.forEach((branch, index) => {
                    const ageGroupSelect = document.querySelector(`#edit-tab-${index} [name="branches[${index}][ageGroup]"]`);
                    if (ageGroupSelect && branch.ageGroup) {
                        handleBranchAgeGroupChange(index, ageGroupSelect);
                    }
                    
                    const tagSelect = document.querySelector(`#edit-tab-${index} [name="branches[${index}][selectedTag]"]`);
                    if (tagSelect && branch.selectedTag) {
                        handleBranchTagSelection(index, tagSelect);
                    }
                });
                
                // ‚úÖ A√ßƒ±lacak sekmeyi aktif et ve required alanlarƒ± doƒüru ≈üekilde enable/disable et
                setTimeout(() => {
                    switchEditTab(openBranchIndex);
                }, 100);
            }
            
            form.dataset.leadId = leadId;
            
            let displayName = lead.fullName || 'M√º≈üteri';
            if (lead.branches && lead.branches.length > 0) {
                const firstBranch = lead.branches[0];
                if (firstBranch.ageGroup === 'adult') {
                    displayName = firstBranch.fullName || lead.fullName || 'M√º≈üteri';
                } else {
                    displayName = firstBranch.parentName || lead.fullName || 'Veli';
                }
            }
            
            // Bran≈ü ekleme butonunu gizle (d√ºzenleme modunda)
            const addBranchBtn = document.querySelector('#addLeadModal .btn-success[onclick*="addBranchField"]');
            if (addBranchBtn) addBranchBtn.style.display = 'none';
            
            // Submit butonunu resetle
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'üíæ Kaydet';
            }
            
            document.querySelector('#addLeadModal h3').textContent = `‚úèÔ∏è ${displayName} - D√ºzenle`;
            openModal('addLeadModal');
        }
        
        // WhatsApp'tan CRM lead detayƒ±nƒ± a√ß
        window.openCrmLeadDetail = function(leadId) {
            // ‚úÖ Sayfayƒ± deƒüi≈ütirmeden modal'ƒ± a√ß
            editLead(leadId, 0);
        }
        
        // D√ºzenleme sekmelerini deƒüi≈ütir
        window.switchEditTab = function(tabIndex) {
            // T√ºm butonlardan active kaldƒ±r
            document.querySelectorAll('#addLeadModal .tab-button').forEach(btn => btn.classList.remove('active'));
            
            // T√ºm i√ßerikleri gizle ve required attribute'√º disable et
            document.querySelectorAll('#edit-tabs-content .tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
                
                // ‚úÖ Gizli sekmelerdeki required alanlarƒ± disable et
                content.querySelectorAll('[required]').forEach(input => {
                    input.disabled = true;
                });
            });
            
            const tabs = document.querySelectorAll('#addLeadModal .tab-button');
            const contents = document.querySelectorAll('#edit-tabs-content .tab-content');
            
            // Se√ßili sekmeyi aktif yap
            if (tabs[tabIndex]) tabs[tabIndex].classList.add('active');
            if (contents[tabIndex]) {
                contents[tabIndex].classList.add('active');
                contents[tabIndex].style.display = 'block';
                
                // ‚úÖ Aktif sekmedeki required alanlarƒ± enable et
                contents[tabIndex].querySelectorAll('[required]').forEach(input => {
                    input.disabled = false;
                });
            }
        };
        
        // CRM m√º≈üteriyi sil
        window.deleteCRMLead = async function(leadId) {
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) {
                showAlert('‚ùå M√º≈üteri bulunamadƒ±', 'danger');
                return;
            }
            
            if (!confirm(`"${lead.fullName}" isimli m√º≈üteriyi silmek istediƒüinize emin misiniz?\n\nBu i≈ülem geri alƒ±namaz!`)) {
                return;
            }
            
            try {
                await window.firebase.deleteDoc(
                    window.firebase.doc(window.db, 'crmLeads', leadId)
                );
                
                // √ñnce global diziden sil (anƒ±nda UI g√ºncellemesi i√ßin)
                const leadIndex = crmLeads.findIndex(l => l.id === leadId);
                if (leadIndex !== -1) {
                    crmLeads.splice(leadIndex, 1);
                }
                
                // Modal'ƒ± hemen kapat
                closeModal('customerDetailModal');
                
                showAlert('‚úÖ M√º≈üteri ba≈üarƒ±yla silindi', 'success');
                
                // CRM listesini hemen yenile (refresh beklemeden)
                renderCRMLeads();
                renderCRMDashboard();
                renderCurrentSection();
                
                // Arka planda full data reload (senkronizasyon i√ßin)
                loadData().catch(err => console.error('Background loadData error:', err));
            } catch (error) {
                console.error('M√º≈üteri silme hatasƒ±:', error);
                showAlert('‚ùå M√º≈üteri silinemedi: ' + error.message, 'danger');
            }
        };
        
        // M√º≈üteri detay sayfasƒ±nƒ± a√ß
        window.openCustomerDetail = function(leadId, openBranchIndex = 0) {
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) return;
            
            // Sekmeler ve i√ßerikler
            let tabsHtml = '';
            let tabContentsHtml = '';
            
            if (lead.branches && lead.branches.length > 0) {
                lead.branches.forEach((branchData, index) => {
                    const branch = branches.find(b => b.id === branchData.branchId);
                    const baseBranchName = branch ? `${branch.icon} ${branch.name}` : 'Bilinmeyen Bran≈ü';
                    
                    // Ya≈ü grubu etiketi ekle
                    const ageGroupPrefix = branchData.ageGroup === 'child' ? 'üë∂ √áOCUK - ' : 
                                           branchData.ageGroup === 'adult' ? 'üë® YETƒ∞≈ûKƒ∞N - ' : '';
                    const branchName = ageGroupPrefix + baseBranchName;
                    const selectedTag = branchData.selectedTag || 'Yok';
                    
                    // Sekme ba≈ülƒ±ƒüƒ± - a√ßƒ±lacak sekmeyi belirle
                    tabsHtml += `
                        <button class="tab-button ${index === openBranchIndex ? 'active' : ''}" onclick="switchCustomerTab(${index})">
                            ${branchName}
                        </button>
                    `;
                    
                    // Not ge√ßmi≈üi - En yeni a√ßƒ±klamalar en √ºstte
                    const notesHistory = branchData.notesHistory || [];
                    const notesHtml = notesHistory.length > 0 ? notesHistory.slice().reverse().map((note, noteIndex) => `
                        <div style="padding: 10px; margin-bottom: 10px; border-left: 3px solid var(--primary-color); background: white; border-radius: 6px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">
                                üë§ ${note.by} - ${note.date}
                            </div>
                            <div style="font-size: 13px; white-space: pre-wrap;">${note.text}</div>
                        </div>
                    `).join('') : '<p style="color: #999; font-size: 13px; text-align: center; padding: 20px;">Hen√ºz a√ßƒ±klama yok</p>';
                    
                    // Ya≈ü grubu ve isim bilgileri
                    let ageGroupInfo = '';
                    if (branchData.ageGroup === 'child') {
                        ageGroupInfo = `
                            <div class="branch-info-item">
                                <strong>üë∂ Ya≈ü Grubu</strong>
                                <span>√áocuk</span>
                            </div>
                            <div class="branch-info-item">
                                <strong>üë® Veli</strong>
                                <span>${branchData.parentName || 'Belirtilmemi≈ü'}</span>
                            </div>
                        `;
                        
                        if (branchData.children && branchData.children.length > 0) {
                            // Her √ßocuk i√ßin ayrƒ± kartlar
                            ageGroupInfo += `
                                <div class="branch-info-item" style="grid-column: 1 / -1;">
                                    <strong>üë∂ √áocuklar</strong>
                                    <div style="margin-top: 12px; display: grid; gap: 12px;">
                                        ${branchData.children.map((child, childIdx) => `
                                            <div style="background: white; padding: 15px; border-radius: 12px; border: 2px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                                    <div>
                                                        <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 4px;">${child.name}</div>
                                                        <div style="font-size: 13px; color: #666;">üéÇ ${child.age} ya≈ü</div>
                                                    </div>
                                                    ${child.selectedTag ? `
                                                        <span style="background: #667eea; color: white; padding: 6px 12px; border-radius: 16px; font-size: 11px;">
                                                            üè∑Ô∏è ${child.selectedTag}
                                                        </span>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }
                    } else if (branchData.ageGroup === 'adult') {
                        ageGroupInfo = `
                            <div class="branch-info-item">
                                <strong>üë® Ya≈ü Grubu</strong>
                                <span>Yeti≈ükin</span>
                            </div>
                            <div class="branch-info-item">
                                <strong>üìù Ad Soyad</strong>
                                <span>${branchData.fullName || 'Belirtilmemi≈ü'}</span>
                            </div>
                        `;
                    }
                    
                    // Sekme i√ßeriƒüi - openBranchIndex parametresine g√∂re g√∂ster
                    tabContentsHtml += `
                        <div class="tab-content ${index === openBranchIndex ? 'active' : ''}" id="tab-${index}" style="display: ${index === openBranchIndex ? 'block' : 'none'};">
                            <div class="branch-tab-content">
                                <div class="branch-info-grid">
                                    ${ageGroupInfo}
                                    ${branchData.ageGroup === 'adult' ? `
                                        <div class="branch-info-item">
                                            <strong>üè∑Ô∏è Etiket</strong>
                                            <span style="color: var(--primary-color);">${selectedTag}</span>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <div style="margin-top: 20px;">
                                    <h4 style="font-size: 14px; color: #666; margin-bottom: 12px;">üìã A√ßƒ±klama Ge√ßmi≈üi</h4>
                                    <div style="max-height: 300px; overflow-y: auto;">
                                        ${notesHtml}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                tabsHtml = '';
                tabContentsHtml = '';
            }
            
            // G√∂r√º≈üme kayƒ±tlarƒ± sekmesi ekle (Bulutfon aktifse)
            let callRecordsTabIndex = lead.branches ? lead.branches.length : 0;
            let historyTabIndex = callRecordsTabIndex;
            let newBranchIndex = callRecordsTabIndex;
            
            if (clubSettings && clubSettings.bulutfonEnabled) {
                tabsHtml += `
                    <button class="tab-button" onclick="switchCustomerTab(${callRecordsTabIndex}); loadCallRecordsTab('${leadId}', 'tab-calls-${callRecordsTabIndex}')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        üìû G√∂r√º≈üme Kayƒ±tlarƒ±
                    </button>
                `;
                
                tabContentsHtml += `
                    <div class="tab-content" id="tab-calls-${callRecordsTabIndex}" style="display: none;">
                        <div class="branch-tab-content">
                            <h4 style="font-size: 16px; color: #666; margin-bottom: 15px;">üìû G√∂r√º≈üme Kayƒ±tlarƒ±</h4>
                            <div id="callRecords-${leadId}">
                                <div class="loading"><div class="spinner"></div><span>Y√ºkleniyor...</span></div>
                            </div>
                        </div>
                    </div>
                `;
                
                historyTabIndex = callRecordsTabIndex + 1;
                newBranchIndex = historyTabIndex + 1;
            } else {
                historyTabIndex = callRecordsTabIndex;
                newBranchIndex = historyTabIndex + 1;
            }
            
            // History sekmesi ekle
            tabsHtml += `
                <button class="tab-button" onclick="switchCustomerTab(${historyTabIndex})" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                    üìú Ge√ßmi≈ü
                </button>
            `;
            
            const historyHtml = (lead.history && lead.history.length > 0) 
                ? lead.history.slice().reverse().map((entry, index) => `
                    <div style="padding: 12px; margin-bottom: 10px; border-left: 4px solid #f5576c; background: white; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size: 11px; color: #666; margin-bottom: 5px;">
                            üë§ ${entry.by} - ${entry.date}
                        </div>
                        <div style="font-size: 13px; color: #333; font-weight: 500;">${entry.details}</div>
                    </div>
                `).join('')
                : '<p style="color: #999; font-size: 13px; text-align: center; padding: 20px;">Hen√ºz ge√ßmi≈ü kaydƒ± yok</p>';
            
            tabContentsHtml += `
                <div class="tab-content" id="tab-history-${historyTabIndex}" style="display: none;">
                    <div class="branch-tab-content">
                        <h4 style="font-size: 16px; color: #666; margin-bottom: 15px;">üìú M√º≈üteri Ge√ßmi≈üi</h4>
                        <div style="max-height: 500px; overflow-y: auto;">
                            ${historyHtml}
                        </div>
                    </div>
                </div>
            `;
            
            // Yeni bran≈ü ekleme sekmesi ve i√ßeriƒüi
            tabsHtml += `
                <button class="tab-button" onclick="switchCustomerTab(${newBranchIndex})" style="background: #4CAF50; color: white; font-weight: bold;">
                    ‚ûï Yeni Bran≈ü
                </button>
            `;
            
            // Yeni bran≈ü ekleme formu
            const nonBranchTags = crmTags
                .filter(tag => tag.category !== 'branch')
                .sort((a, b) => (a.order || 999) - (b.order || 999));
            
            tabContentsHtml += `
                <div class="tab-content" id="tab-${newBranchIndex}" style="display: none;">
                    <div class="branch-tab-content">
                        <h4 style="font-size: 16px; color: #666; margin-bottom: 15px;">‚ûï Yeni Bran≈ü Ekle</h4>
                        <form id="addNewBranchForm" onsubmit="handleAddNewBranch(event, '${lead.id}'); return false;">
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                                <div class="form-group">
                                    <label>Bran≈ü *</label>
                                    <select name="branchId" class="form-control" required>
                                        <option value="">Se√ßiniz...</option>
                                        ${branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Ya≈ü Grubu *</label>
                                    <select name="ageGroup" class="form-control" required onchange="handleNewBranchAgeGroupChange(this)">
                                        <option value="">Se√ßiniz...</option>
                                        <option value="adult">üë® Yeti≈ükin</option>
                                        <option value="child">üë∂ √áocuk</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Yeti≈ükin i√ßin -->
                            <div id="new-branch-adult" style="display: none;">
                                <div class="form-group">
                                    <label>Ad Soyad *</label>
                                    <input type="text" name="fullName" class="form-control" placeholder="Ad Soyad">
                                </div>
                                <div class="form-group">
                                    <label>üè∑Ô∏è Etiket</label>
                                    <select name="selectedTag" class="form-control" onchange="handleNewBranchTagChange(this)">
                                        <option value="">Etiket se√ßiniz...</option>
                                        ${nonBranchTags.map(tag => `<option value="${tag.name}">${tag.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div id="new-branch-adult-dates" style="display: none;">
                                    <div id="new-branch-adult-kayit" style="display: none;">
                                        <label>üìÖ Kayƒ±t Olabilir Tarihi</label>
                                        <input type="datetime-local" name="kayitOlabilirDate" class="form-control">
                                    </div>
                                    <div id="new-branch-adult-deneme" style="display: none;">
                                        <label>üìÖ Deneme Dersi Tarihi</label>
                                        <input type="datetime-local" name="denemeDate" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- √áocuk i√ßin -->
                            <div id="new-branch-child" style="display: none;">
                                <div class="form-group">
                                    <label>Veli Ad Soyad *</label>
                                    <input type="text" name="parentName" class="form-control" placeholder="Veli ismi" value="${lead.branches && lead.branches.length > 0 && lead.branches[0].parentName ? lead.branches[0].parentName : ''}">
                                </div>
                                <div class="form-group">
                                    <label>√áocuk Ad Soyad</label>
                                    <input type="text" name="childName" class="form-control" placeholder="√áocuk ismi">
                                </div>
                                <div class="form-group">
                                    <label>√áocuk Ya≈ü</label>
                                    <input type="number" name="childAge" class="form-control" placeholder="Ya≈ü" min="1" max="18">
                                </div>
                                <div class="form-group">
                                    <label>üè∑Ô∏è Etiket</label>
                                    <select name="childTag" class="form-control" onchange="handleNewChildTagChange(this)">
                                        <option value="">Etiket se√ßiniz...</option>
                                        ${nonBranchTags.map(tag => `<option value="${tag.name}">${tag.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div id="new-branch-child-dates" style="display: none;">
                                    <div id="new-branch-child-kayit" style="display: none;">
                                        <label>üìÖ Kayƒ±t Olabilir Tarihi</label>
                                        <input type="datetime-local" name="childKayitDate" class="form-control">
                                    </div>
                                    <div id="new-branch-child-deneme" style="display: none;">
                                        <label>üìÖ Deneme Dersi Tarihi</label>
                                        <input type="datetime-local" name="childDenemeDate" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>üìù A√ßƒ±klama</label>
                                <textarea name="newNote" class="form-control" rows="3" placeholder="Bran≈ü hakkƒ±nda not..."></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="width: 100%;">üíæ Bran≈üƒ± Kaydet</button>
                        </form>
                    </div>
                </div>
            `;
            
            const html = `
                <div id="customerDetailModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <span class="close" onclick="closeModal('customerDetailModal')">&times;</span>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">üë§ ${lead.fullName}</h3>
                            <button class="btn btn-danger btn-sm" onclick="deleteCRMLead('${lead.id}')" style="padding: 6px 12px;">
                                üóëÔ∏è M√º≈üteriyi Sil
                            </button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">üìû Telefon</div>
                                <div style="font-size: 18px; font-weight: bold;">${lead.phone}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">üéØ Bran≈ü Sayƒ±sƒ±</div>
                                <div style="font-size: 18px; font-weight: bold;">${lead.branches ? lead.branches.length : 0}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">üìç Kaynak</div>
                                <div style="font-size: 16px; font-weight: bold;">${getSourceName(lead.source || 'other')}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">üìÖ Olu≈üturma</div>
                                <div style="font-size: 16px; font-weight: bold;">${lead.createdAt ? new Date(lead.createdAt).toLocaleDateString('tr-TR') : '-'}</div>
                            </div>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <h4 style="font-size: 16px; color: #666; margin-bottom: 10px;">üéØ Bran≈ülar ve Bilgiler</h4>
                            <div class="customer-tabs">
                                ${tabsHtml}
                            </div>
                            ${tabContentsHtml}
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
                            <button class="btn btn-primary" onclick="closeModal('customerDetailModal'); editLead('${lead.id}', ${openBranchIndex})">‚úèÔ∏è D√ºzenle</button>
                            <button class="btn btn-success" onclick="closeModal('customerDetailModal'); openWhatsAppWithLead('${lead.id}')">üí¨ WhatsApp</button>
                            <button class="btn btn-secondary" onclick="closeModal('customerDetailModal')">Kapat</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Modal varsa kaldƒ±r
            const existing = document.getElementById('customerDetailModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', html);
            
            // Backdrop'a tƒ±klayƒ±nca modalƒ± kapat
            const modal = document.getElementById('customerDetailModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    // Eƒüer modal'ƒ±n kendisine (backdrop) tƒ±klanmƒ±≈üsa kapat, i√ßeriƒüe tƒ±klanmamƒ±≈üsa kapatma
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
        };
        
        // G√∂r√º≈üme kayƒ±tlarƒ± sekmesi y√ºkleyici
        window.loadCallRecordsTab = async function(leadId, tabId) {
            // Eƒüer zaten y√ºklenmi≈ü ise tekrar y√ºkleme
            const tabElement = document.getElementById(tabId);
            if (!tabElement) return;
            
            const contentDiv = tabElement.querySelector(`#callRecords-${leadId}`);
            if (!contentDiv || contentDiv.dataset.loaded === 'true') return;
            
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) return;
            
            await renderCallRecords(lead.phone, `callRecords-${leadId}`);
            contentDiv.dataset.loaded = 'true';
        };
        
        // M√º≈üteri detay sekmelerini deƒüi≈ütir
        window.switchCustomerTab = function(tabIndex) {
            // Modal i√ßindeki sekmeleri bul
            const modal = document.getElementById('customerDetailModal');
            if (!modal) return;
            
            // T√ºm sekme butonlarƒ±nƒ± pasif yap
            const tabs = modal.querySelectorAll('.tab-button');
            tabs.forEach(btn => btn.classList.remove('active'));
            
            // T√ºm sekme i√ßeriklerini gizle
            const contents = modal.querySelectorAll('.tab-content');
            contents.forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // Se√ßilen sekmeyi aktif yap
            if (tabs[tabIndex]) {
                tabs[tabIndex].classList.add('active');
            }
            if (contents[tabIndex]) {
                contents[tabIndex].classList.add('active');
                contents[tabIndex].style.display = 'block';
            }
        };
        
        // Yeni bran≈ü ya≈ü grubu deƒüi≈üimi
        window.handleNewBranchAgeGroupChange = function(selectElement) {
            const value = selectElement.value;
            const adultDiv = document.getElementById('new-branch-adult');
            const childDiv = document.getElementById('new-branch-child');
            
            if (value === 'adult') {
                adultDiv.style.display = 'block';
                childDiv.style.display = 'none';
                adultDiv.querySelector('[name="fullName"]').required = true;
                childDiv.querySelector('[name="parentName"]').required = false;
            } else if (value === 'child') {
                adultDiv.style.display = 'none';
                childDiv.style.display = 'block';
                childDiv.querySelector('[name="parentName"]').required = true;
                adultDiv.querySelector('[name="fullName"]').required = false;
            } else {
                adultDiv.style.display = 'none';
                childDiv.style.display = 'none';
            }
        };
        
        // Yeni bran≈ü yeti≈ükin etiket deƒüi≈üimi
        window.handleNewBranchTagChange = function(selectElement) {
            const value = selectElement.value;
            const datesDiv = document.getElementById('new-branch-adult-dates');
            const kayitDiv = document.getElementById('new-branch-adult-kayit');
            const denemeDiv = document.getElementById('new-branch-adult-deneme');
            
            if (value === 'Kayƒ±t Olabilir') {
                datesDiv.style.display = 'block';
                kayitDiv.style.display = 'block';
                denemeDiv.style.display = 'none';
            } else if (value === 'Denemeye Gelecek') {
                datesDiv.style.display = 'block';
                kayitDiv.style.display = 'none';
                denemeDiv.style.display = 'block';
                // ‚úÖ JavaScript validasyonu kullanƒ±lƒ±yor, HTML required kaldƒ±rƒ±ldƒ±
            } else {
                datesDiv.style.display = 'none';
                kayitDiv.style.display = 'none';
                denemeDiv.style.display = 'none';
            }

            // Etiket se√ßiminden sonra form sonuna kaydƒ±r
            try {
                const form = selectElement.closest('form');
                if (form) {
                    setTimeout(() => {
                        form.scrollTo({ top: form.scrollHeight, behavior: 'smooth' });
                    }, 50);
                }
            } catch(e) { /* no-op */ }
        };
        
        // Yeni bran≈ü √ßocuk etiket deƒüi≈üimi
        window.handleNewChildTagChange = function(selectElement) {
            const value = selectElement.value;
            const datesDiv = document.getElementById('new-branch-child-dates');
            const kayitDiv = document.getElementById('new-branch-child-kayit');
            const denemeDiv = document.getElementById('new-branch-child-deneme');
            
            if (value === 'Kayƒ±t Olabilir') {
                datesDiv.style.display = 'block';
                kayitDiv.style.display = 'block';
                denemeDiv.style.display = 'none';
            } else if (value === 'Denemeye Gelecek') {
                datesDiv.style.display = 'block';
                kayitDiv.style.display = 'none';
                denemeDiv.style.display = 'block';
                // ‚úÖ JavaScript validasyonu kullanƒ±lƒ±yor, HTML required kaldƒ±rƒ±ldƒ±
            } else {
                datesDiv.style.display = 'none';
                kayitDiv.style.display = 'none';
                denemeDiv.style.display = 'none';
            }
        };
        
        // Yeni bran≈ü ekleme
        window.handleAddNewBranch = async function(event, leadId) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            // Submit butonunu devre dƒ±≈üƒ± bƒ±rak
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '‚è≥ Kaydediliyor...';
            
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) {
                showAlert('‚ùå M√º≈üteri bulunamadƒ±!', 'danger');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                return;
            }
            
            // Yeni bran≈ü verisi
            const newBranch = {
                branchId: formData.get('branchId'),
                ageGroup: formData.get('ageGroup'),
                notesHistory: [],
                createdAt: new Date().toISOString()
            };
            
            // A√ßƒ±klama varsa ekle
            if (formData.get('newNote')) {
                newBranch.notesHistory.push({
                    text: formData.get('newNote'),
                    by: currentUser.fullName || currentUser.email,
                    date: new Date().toLocaleString('tr-TR')
                });
            }
            
            // Ya≈ü grubuna g√∂re veri ekle
            if (newBranch.ageGroup === 'adult') {
                newBranch.fullName = formData.get('fullName');
                newBranch.selectedTag = formData.get('selectedTag') || '';
                newBranch.kayitOlabilirDate = formData.get('kayitOlabilirDate') || '';
                newBranch.denemeDate = formData.get('denemeDate') || '';
            } else if (newBranch.ageGroup === 'child') {
                newBranch.parentName = formData.get('parentName');
                newBranch.children = [];
                
                // √áocuk bilgisi varsa ekle
                if (formData.get('childName')) {
                    newBranch.children.push({
                        name: formData.get('childName'),
                        age: formData.get('childAge') || '',
                        selectedTag: formData.get('childTag') || '',
                        kayitOlabilirDate: formData.get('childKayitDate') || '',
                        denemeDate: formData.get('childDenemeDate') || ''
                    });
                }
            }
            
            try {
                // Mevcut bran≈ülara ekle
                const updatedBranches = [...(lead.branches || []), newBranch];
                
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'crmLeads', leadId), {
                    branches: updatedBranches
                });
                
                showAlert('‚úÖ Yeni bran≈ü ba≈üarƒ±yla eklendi!', 'success');
                
                // Listeyi yenile
                await loadData();
                
                // Modalƒ± kapat ve yeniden a√ß
                closeModal('customerDetailModal');
                setTimeout(() => openCustomerDetail(leadId), 100);
                
            } catch (error) {
                console.error('Bran≈ü eklenirken hata:', error);
                showAlert('‚ùå Bran≈ü eklenirken hata olu≈ütu: ' + error.message, 'danger');
                
                // Hata durumunda butonu tekrar aktif et
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        };
        
        // M√º≈üteriye bran≈ü ekle
        window.addBranchToLead = function(leadId) {
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) return;
            
            // Bran≈ü ekleme butonunu g√∂ster
            setTimeout(() => {
                const addBranchBtn = document.querySelector('#addLeadModal .btn-success[onclick*="addBranchField"]');
                if (addBranchBtn) addBranchBtn.style.display = 'inline-block';
            }, 50);
            
            // Telefon numarasƒ±nƒ± otomatik kontrol ettir
            setTimeout(() => {
                const phoneInput = document.querySelector('#addLeadForm input[name="phone"]');
                if (phoneInput) {
                    phoneInput.value = lead.phone;
                    phoneInput.dispatchEvent(new Event('input'));
                }
            }, 100);
            
            openModal('addLeadModal');
        };
        
        // A√ßƒ±klama ge√ßmi≈üinden bir notu sil
        window.deleteNoteHistory = async function(leadId, noteIndex) {
            if (!confirm('Bu a√ßƒ±klamayƒ± silmek istediƒüinize emin misiniz?')) return;
            
            try {
                const lead = crmLeads.find(l => l.id === leadId);
                if (!lead) return;
                
                const notesHistory = lead.notesHistory || [];
                notesHistory.splice(noteIndex, 1);
                
                await window.firebase.updateDoc(
                    window.firebase.doc(window.db, 'crmLeads', leadId),
                    { notesHistory: notesHistory }
                );
                
                showAlert('‚úÖ A√ßƒ±klama silindi!', 'success');
                await loadData();
                
                // Modal'ƒ± yenile
                closeModal('customerDetailModal');
                openCustomerDetail(leadId);
            } catch (error) {
                console.error('A√ßƒ±klama silme hatasƒ±:', error);
                showAlert('‚ùå Silme i≈ülemi ba≈üarƒ±sƒ±z: ' + error.message, 'danger');
            }
        };
        
        // WhatsApp ile lead'e mesaj at
        window.openWhatsAppWithLead = function(leadId) {
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) return;
            
            // WhatsApp b√∂l√ºm√ºne git
            showSection('whatsapp', document.querySelector('.nav-btn[onclick*="whatsapp"]'));
            
            // Telefon numarasƒ±nƒ± temizle ve formatla
            let phone = lead.phone.replace(/\D/g, '');
            if (phone.startsWith('0')) {
                phone = '90' + phone.substring(1);
            } else if (!phone.startsWith('90')) {
                phone = '90' + phone;
            }
            
            // Chat'i a√ß (bir s√ºre bekle ki sayfa y√ºklensin)
            setTimeout(() => {
                const phoneWithSuffix = phone + '@s.whatsapp.net';
                // WhatsApp chat a√ßma fonksiyonunu √ßaƒüƒ±r
                if (window.openWhatsAppChat) {
                    window.openWhatsAppChat(phoneWithSuffix);
                }
            }, 500);
        };
        
        // Lead Sil
        async function deleteLead(leadId) {
            if (!confirm('Bu potansiyel m√º≈üteriyi silmek istediƒüinize emin misiniz?')) return;
            
            try {
                await window.firebase.deleteDoc(window.firebase.doc(window.db, 'crmLeads', leadId));
                showAlert('‚úÖ M√º≈üteri ba≈üarƒ±yla silindi!', 'success');
                await loadData();
                renderCRMDashboard();
                renderCRMLeads();
            } catch (error) {
                console.error('Lead silme hatasƒ±:', error);
                showAlert('‚ùå Silme i≈ülemi ba≈üarƒ±sƒ±z: ' + error.message, 'danger');
            }
        }
        
        // Lead Kaydet/G√ºncelle
        async function handleAddLead(e) {
            e.preventDefault();
            const form = e.target;
            const leadId = form.dataset.leadId;
            const formData = new FormData(form);
            
            // ‚úÖ Kaydet butonunu devre dƒ±≈üƒ± bƒ±rak ve loading g√∂ster
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '‚è≥ Kaydediliyor...';
            
            const phoneRaw = formData.get('phone');
            // Telefon numarasƒ±nƒ± temizle - bo≈üluklar, tire vb. kaldƒ±r
            const phone = cleanPhoneNumber(phoneRaw);
            
            // Telefon numarasƒ± bo≈ü mu kontrol et
            if (!phone || phone.length < 10) {
                showAlert('‚ö†Ô∏è Ge√ßerli bir telefon numarasƒ± girin!', 'warning');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                return;
            }
            
            // YENƒ∞ EKLEME: Aynƒ± telefon numarasƒ± var mƒ± kontrol et - phonesMatch kullan
            if (!leadId) { // Sadece yeni ekleme yapƒ±lƒ±rken kontrol et
                const existingLead = crmLeads.find(l => phonesMatch(l.phone, phone));
                
                if (existingLead) {
                    const openExisting = confirm(
                        `‚ö†Ô∏è Bu telefon numarasƒ± zaten kayƒ±tlƒ±!\n\n` +
                        `M√º≈üteri: ${existingLead.fullName}\n` +
                        `Telefon: ${existingLead.phone}\n\n` +
                        `Mevcut m√º≈üteriyi a√ßmak ister misiniz?`
                    );
                    
                    if (openExisting) {
                        closeModal('addLeadModal');
                        openCustomerDetail(existingLead.id);
                    }
                    
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    return;
                }
            }
            
            // Bran≈ü verilerini topla
            const branchesData = [];
            const branchInputs = form.querySelectorAll('[name^="branches["]');
            const branchIndices = new Set();
            
            branchInputs.forEach(input => {
                const match = input.name.match(/branches\[(\d+)\]\[(\w+)\]/);
                if (match) {
                    branchIndices.add(parseInt(match[1]));
                }
            });
            
            const now = new Date();
            const dateStr = now.toLocaleString('tr-TR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            const userName = currentUser.fullName || currentUser.email || 'Kullanƒ±cƒ±';
            
            branchIndices.forEach(index => {
                const branchId = formData.get(`branches[${index}][branchId]`);
                if (!branchId) return; // Bran≈ü se√ßilmemi≈üse atla
                
                const ageGroup = formData.get(`branches[${index}][ageGroup]`);
                const selectedTag = formData.get(`branches[${index}][selectedTag]`);
                const newNote = formData.get(`branches[${index}][newNote]`);
                const kayitOlabilirDate = formData.get(`branches[${index}][kayitOlabilirDate]`);
                const denemeDate = formData.get(`branches[${index}][denemeDate]`);
                const notesHistoryStr = formData.get(`branches[${index}][notesHistory]`);
                const childrenStr = formData.get(`branches[${index}][children]`);
                
                let notesHistory = [];
                try {
                    notesHistory = JSON.parse(notesHistoryStr || '[]');
                } catch (e) {
                    notesHistory = [];
                }
                
                let children = [];
                try {
                    children = JSON.parse(childrenStr || '[]');
                } catch (e) {
                    children = [];
                }
                
                // Yeni not ekle
                if (newNote && newNote.trim()) {
                    notesHistory.push({
                        text: newNote.trim(),
                        by: userName,
                        date: dateStr
                    });
                }
                
                const branchData = {
                    branchId,
                    branchName: branches.find(b => b.id === branchId)?.name || '',
                    ageGroup: ageGroup || 'adult',
                    selectedTag: selectedTag || '',
                    notesHistory,
                    kayitOlabilirDate: kayitOlabilirDate || null,
                    denemeDate: denemeDate || null
                };
                
                // Ya≈ü grubuna g√∂re isim bilgisi
                if (ageGroup === 'adult') {
                    branchData.fullName = formData.get(`branches[${index}][fullName]`);
                } else if (ageGroup === 'child') {
                    branchData.parentName = formData.get(`branches[${index}][parentName]`);
                    branchData.children = children.filter(c => c.name && c.name.trim());
                }
                
                branchesData.push(branchData);
            });
            
            // ‚úÖ Validasyon: "Denemeye Gelecek" etiketi se√ßiliyse deneme tarihi zorunlu
            for (const branch of branchesData) {
                if (branch.selectedTag === 'Denemeye Gelecek') {
                    // Yeti≈ükin i√ßin deneme tarihi kontrol√º
                    if (branch.ageGroup === 'adult' && (!branch.denemeDate || branch.denemeDate.trim() === '')) {
                        alert('‚ö†Ô∏è "Denemeye Gelecek" etiketi se√ßildiƒüinde deneme dersi tarihi zorunludur!\n\nL√ºtfen deneme tarihi girin.');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                        return;
                    }
                    // √áocuklar i√ßin her √ßocuƒüun deneme tarihi kontrol√º
                    if (branch.ageGroup === 'child' && branch.children && branch.children.length > 0) {
                        const childrenWithDenemeTag = branch.children.filter(child => child.selectedTag === 'Denemeye Gelecek');
                        for (const child of childrenWithDenemeTag) {
                            if (!child.denemeDate || child.denemeDate.trim() === '') {
                                alert(`‚ö†Ô∏è "${child.name}" i√ßin "Denemeye Gelecek" etiketi se√ßildiƒüinde deneme dersi tarihi zorunludur!\n\nL√ºtfen deneme tarihi girin.`);
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalText;
                                return;
                            }
                        }
                    }
                }
                
                // ‚úÖ Validasyon: "Kayƒ±t Olabilir" etiketi se√ßiliyse kayƒ±t tarihi zorunlu
                if (branch.selectedTag === 'Kayƒ±t Olabilir') {
                    // Yeti≈ükin i√ßin kayƒ±t tarihi kontrol√º
                    if (branch.ageGroup === 'adult' && (!branch.kayitOlabilirDate || branch.kayitOlabilirDate.trim() === '')) {
                        alert('‚ö†Ô∏è "Kayƒ±t Olabilir" etiketi se√ßildiƒüinde kayƒ±t olabilir tarihi zorunludur!\n\nL√ºtfen kayƒ±t olabilir tarihi girin.');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                        return;
                    }
                    // √áocuklar i√ßin her √ßocuƒüun kayƒ±t tarihi kontrol√º
                    if (branch.ageGroup === 'child' && branch.children && branch.children.length > 0) {
                        const childrenWithKayitTag = branch.children.filter(child => child.selectedTag === 'Kayƒ±t Olabilir');
                        for (const child of childrenWithKayitTag) {
                            if (!child.kayitOlabilirDate || child.kayitOlabilirDate.trim() === '') {
                                alert(`‚ö†Ô∏è "${child.name}" i√ßin "Kayƒ±t Olabilir" etiketi se√ßildiƒüinde kayƒ±t olabilir tarihi zorunludur!\n\nL√ºtfen kayƒ±t olabilir tarihi girin.`);
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalText;
                                return;
                            }
                        }
                    }
                }
            }
            
            // fullName belirle - ilk bran≈ütan veya veli isminden
            let fullName = 'M√º≈üteri';
            if (branchesData.length > 0) {
                const firstBranch = branchesData[0];
                if (firstBranch.ageGroup === 'adult') {
                    fullName = firstBranch.fullName || 'M√º≈üteri';
                } else {
                    fullName = firstBranch.parentName || 'Veli';
                }
            }
            
            // Temel veri
            const leadData = {
                fullName: fullName, // Listeleme i√ßin
                phone: phone,
                source: formData.get('source') || 'other',
                branches: branchesData,
                clubId: currentClubId
            };
            
            try {
                if (leadId) {
                    // G√ºncelleme
                    leadData.updatedAt = now.toISOString();
                    leadData.updatedBy = userName;
                    
                    // Eski lead'i bul ve etiket deƒüi≈üikliklerini kontrol et
                    const oldLead = crmLeads.find(l => l.id === leadId);
                    const newHistory = [];
                    
                    if (oldLead && oldLead.branches) {
                        // Her bran≈ü i√ßin etiket deƒüi≈üikliklerini kontrol et
                        branchesData.forEach((newBranch) => {
                            const oldBranch = oldLead.branches.find(b => b.branchId === newBranch.branchId);
                            
                            if (oldBranch) {
                                // Etiket deƒüi≈üti mi?
                                if (oldBranch.selectedTag !== newBranch.selectedTag) {
                                    newHistory.push({
                                        action: 'tag_changed',
                                        by: userName,
                                        date: dateStr,
                                        details: `${newBranch.branchName} - Etiket "${oldBranch.selectedTag || 'Yok'}" ‚Üí "${newBranch.selectedTag || 'Yok'}"`
                                    });
                                }
                            } else {
                                // Yeni bran≈ü eklendi
                                if (newBranch.selectedTag) {
                                    newHistory.push({
                                        action: 'tag_added',
                                        by: userName,
                                        date: dateStr,
                                        details: `${newBranch.branchName} - Etiket: "${newBranch.selectedTag}"`
                                    });
                                }
                            }
                        });
                    }
                    
                    // Varsa yeni history kayƒ±tlarƒ±nƒ± ekle
                    if (newHistory.length > 0) {
                        leadData.history = [...(oldLead?.history || []), ...newHistory];
                    }
                    
                    await window.firebase.updateDoc(
                        window.firebase.doc(window.db, 'crmLeads', leadId),
                        leadData
                    );
                    showAlert('‚úÖ Potansiyel m√º≈üteri ba≈üarƒ±yla g√ºncellendi!', 'success');
                } else {
                    // Yeni ekleme
                    leadData.createdAt = now.toISOString();
                    leadData.createdBy = userName;
                    leadData.status = 'new';
                    
                    // History'e m√º≈üteri olu≈üturma kaydƒ± ekle
                    leadData.history = [{
                        action: 'created',
                        by: userName,
                        date: dateStr,
                        details: `M√º≈üteri olu≈üturuldu - ${fullName} (${phone})`
                    }];
                    
                    // Her bran≈ü i√ßin etiket bilgisi ekle
                    branchesData.forEach((branch, index) => {
                        if (branch.selectedTag) {
                            leadData.history.push({
                                action: 'tag_added',
                                by: userName,
                                date: dateStr,
                                details: `${branch.branchName} - Etiket: "${branch.selectedTag}"`
                            });
                        }
                    });
                    
                    await window.firebase.addDoc(
                        window.firebase.collection(window.db, 'crmLeads'),
                        leadData
                    );
                    showAlert('‚úÖ Potansiyel m√º≈üteri ba≈üarƒ±yla eklendi!', 'success');
                }
                
                // ‚úÖ Veri y√ºkleme tamamlanana kadar bekle
                await loadData();
                
                // ‚úÖ "Kayƒ±t Oldu" etiketi varsa otomatik olarak √ºye sistemine ekle
                await checkAndAddToMembers(leadData, phone, fullName);
                
                // ‚úÖ Ba≈üarƒ±lƒ± - modal'ƒ± kapat
                closeModal('addLeadModal');
                renderCRMDashboard();
                renderCRMLeads();
            } catch (error) {
                console.error('Lead kaydetme hatasƒ±:', error);
                showAlert('‚ùå Kayƒ±t sƒ±rasƒ±nda hata olu≈ütu: ' + error.message, 'danger');
                
                // ‚úÖ Hata durumunda butonu tekrar aktif et
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }
        
        // "Kayƒ±t Oldu" etiketi varsa otomatik √ºye sistemine ekle
        async function checkAndAddToMembers(leadData, phone, fullName) {
            if (!leadData.branches || leadData.branches.length === 0) return;
            
            try {
                // "Kayƒ±t Oldu" etiketi olan bran≈ülarƒ± bul
                const convertedBranches = leadData.branches.filter(b => b.selectedTag === 'Kayƒ±t Oldu');
                
                if (convertedBranches.length === 0) return;
                
                // √úye sisteminde zaten var mƒ± kontrol et
                const existingMember = members.find(m => phonesMatch(m.Telefon, phone));
                
                for (const branch of convertedBranches) {
                    const branchInfo = branches.find(b => b.id === branch.branchId);
                    if (!branchInfo) continue;
                    
                    // √úye verisi olu≈ütur
                    const memberData = {
                        Ad_Soyad: branch.ageGroup === 'adult' ? (branch.fullName || fullName) : (branch.parentName || fullName),
                        Veli_2_Adi_Soyadi: '',
                        Telefon_2: '',
                        Resit_Olmayan_Adi_Soyadi: branch.ageGroup === 'child' && branch.children && branch.children.length > 0 ? branch.children[0].name : '',
                        Telefon: phone,
                        Brans: branchInfo.name, // Bran≈ü ismi olarak kaydet
                        studentBirthDate: '',
                        status: 'pending', // Bekleyen √ºye olarak ekle
                        registrationDate: new Date().toISOString(),
                        clubId: currentClubId,
                        crmSourceLeadId: leadData.id || null, // CRM'den geldiƒüini i≈üaretle
                        notes: `CRM'den otomatik eklendi - Etiket: "Kayƒ±t Oldu"`
                    };
                    
                    if (existingMember) {
                        // √úye zaten varsa, sadece notlarƒ± g√ºncelle
                        console.log(`‚úÖ ${fullName}: Zaten √ºye sisteminde mevcut`);
                        
                        const currentNotes = existingMember.notes || '';
                        const newNotes = currentNotes + `\n[${new Date().toLocaleString('tr-TR')}] CRM'de "Kayƒ±t Oldu" olarak i≈üaretlendi - ${branchInfo.name}`;
                        
                        await window.firebase.updateDoc(
                            window.firebase.doc(window.db, 'members', existingMember.id),
                            { notes: newNotes }
                        );
                    } else {
                        // Yeni √ºye ekle
                        await window.firebase.addDoc(
                            window.firebase.collection(window.db, 'members'),
                            memberData
                        );
                        
                        console.log(`‚úÖ ${fullName}: Bekleyen √ºyelere eklendi (${branchInfo.name})`);
                        
                        // Ba≈üarƒ± mesajƒ±
                        showAlert(`‚úÖ M√º≈üteri "Bekleyen √úyeler" listesine eklendi!\n\n√úyeler b√∂l√ºm√ºnden √∂deme planƒ± ve diƒüer bilgileri girebilirsiniz.`, 'success');
                    }
                }
                
                // √úye listesini yenile
                await loadData();
                
            } catch (error) {
                console.error('√úye sisteme eklenirken hata:', error);
                showAlert(`‚ö†Ô∏è CRM kaydƒ± ba≈üarƒ±lƒ± ancak √ºye sistemine eklenirken hata olu≈ütu: ${error.message}`, 'warning');
            }
        }
        
        // Kaynak adƒ± helper
        function getSourceName(source) {
            const sources = {
                'website': 'üåê Website',
                'phone': 'üìû Telefon',
                'referral': 'üë• Tavsiye',
                'social': 'üì± Sosyal Medya',
                'other': 'üîπ Diƒüer'
            };
            return sources[source] || source;
        }
        
        // ========== ZAMANLANMI≈û MESAJ FONKSƒ∞YONLARI ==========
        
        // Zamanlanmƒ±≈ü mesaj modalƒ±nƒ± a√ß
        function openScheduleMessageModal() {
            const modal = document.getElementById('scheduleMessageModal');
            if (!modal) {
                console.error('‚ùå scheduleMessageModal bulunamadƒ±!');
                return;
            }
            
            const form = document.getElementById('scheduleMessageForm');
            form.reset();
            
            // Minimum zamanƒ± ≈üu andan 5 dakika sonra yap
            const minTime = new Date(Date.now() + 5 * 60 * 1000);
            const year = minTime.getFullYear();
            const month = String(minTime.getMonth() + 1).padStart(2, '0');
            const day = String(minTime.getDate()).padStart(2, '0');
            const hours = String(minTime.getHours()).padStart(2, '0');
            const minutes = String(minTime.getMinutes()).padStart(2, '0');
            form.elements['scheduledTime'].min = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            openModal('scheduleMessageModal');
        }
        
        // Zamanlanmƒ±≈ü mesaj kaydet
        async function handleScheduleMessage(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            try {
                // Default cihazƒ± al
                const device = whatsappDevices.find(d => 
                    d.status === 'connected' && d.instanceName === defaultWhatsAppDevice
                ) || whatsappDevices.find(d => d.status === 'connected');
                
                if (!device) {
                    showAlert('‚ùå Baƒülƒ± WhatsApp cihazƒ± bulunamadƒ±!', 'danger');
                    return;
                }
                
                const phoneNumber = formData.get('phoneNumber');
                const recipientName = formData.get('recipientName') || phoneNumber;
                const messageText = formData.get('messageText');
                const scheduledTime = new Date(formData.get('scheduledTime'));
                const messageType = formData.get('messageType');
                
                // Zamanlama kontrol√º
                if (scheduledTime < new Date()) {
                    showAlert('‚ö†Ô∏è G√∂nderim zamanƒ± ge√ßmi≈üte olamaz!', 'warning');
                    return;
                }
                
                // Firebase'e kaydet
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'scheduledMessages'), 
                    {
                        clubId: currentClubId,
                        deviceId: device.id,
                        recipientName: recipientName,
                        phoneNumber: phoneNumber,
                        messageText: messageText,
                        messageType: messageType,
                        scheduledTime: scheduledTime,
                        status: 'scheduled',
                        createdAt: new Date(),
                        createdBy: currentUser.email || currentUser.fullName,
                        retryCount: 0
                    }
                );
                
                const timeStr = scheduledTime.toLocaleString('tr-TR', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                showAlert(`‚úÖ Mesaj ${timeStr} tarihinde g√∂nderilmek √ºzere zamanlandƒ±!\n\n‚ö†Ô∏è Tarayƒ±cƒ±yƒ± kapatabilirsiniz, mesaj Firebase Cloud Functions √ºzerinden otomatik g√∂nderilecektir.`, 'success');
                
                closeModal('scheduleMessageModal');
                
            } catch (error) {
                console.error('Mesaj zamanlama hatasƒ±:', error);
                showAlert('‚ùå Mesaj zamanlanamadƒ±: ' + error.message, 'danger');
            }
        }
        
        // Global'e ekle
        window.openScheduleMessageModal = openScheduleMessageModal;
        window.handleScheduleMessage = handleScheduleMessage;
        window.openAddLeadModal = openAddLeadModal;
        window.editLead = editLead;
        window.deleteLead = deleteLead;
        window.handleAddLead = handleAddLead;
        window.renderCRMDashboard = renderCRMDashboard;
        
        // Kampanya Sayfasƒ±
        function renderCampaignsPage() {
            // Bran≈ü filtresini doldur
            const branchFilter = document.getElementById('campaign-branch-filter');
            if (branchFilter) {
                branchFilter.innerHTML = '<option value="all">T√ºm Bran≈ülar</option>' + 
                    branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
            }
            
            // Etiket filtresini doldur
            const tagFilter = document.getElementById('campaign-tag-filter');
            if (tagFilter && crmTags) {
                const nonBranchTags = crmTags.filter(tag => tag.category !== 'branch');
                tagFilter.innerHTML = '<option value="all">T√ºm Etiketler</option>' + 
                    nonBranchTags.map(t => `<option value="${t.name}">üè∑Ô∏è ${t.name}</option>`).join('');
            }
            
            // Cihaz listesini doldur
            const deviceSelect = document.getElementById('campaign-device');
            if (deviceSelect && whatsappDevices) {
                deviceSelect.innerHTML = '<option value="">Cihaz se√ßin...</option>' +
                    whatsappDevices
                        .filter(d => d.status === 'connected')
                        .map(d => `<option value="${d.instanceName}">${d.instanceName} (${d.phoneNumber})</option>`).join('');
            }
            
            updateCampaignRecipients();
        }
        
        window.updateCampaignRecipients = function() {
            const branchFilter = document.getElementById('campaign-branch-filter')?.value || 'all';
            const tagFilter = document.getElementById('campaign-tag-filter')?.value || 'all';
            const ageFilter = document.getElementById('campaign-agegroup-filter')?.value || 'all';
            
            let recipients = new Set();
            
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        let match = true;
                        
                        // Bran≈ü filtresi
                        if (branchFilter !== 'all' && br.branchId !== branchFilter) {
                            match = false;
                        }
                        
                        // Ya≈ü grubu filtresi
                        if (ageFilter !== 'all' && br.ageGroup !== ageFilter) {
                            match = false;
                        }
                        
                        // Etiket filtresi
                        if (tagFilter !== 'all' && br.selectedTag !== tagFilter) {
                            match = false;
                        }
                        
                        if (match && lead.phone) {
                            recipients.add(lead.phone);
                        }
                        
                        // √áocuklarƒ± da kontrol et
                        if (match && br.ageGroup === 'child' && br.children) {
                            br.children.forEach(c => {
                                if (tagFilter === 'all' || c.selectedTag === tagFilter) {
                                    if (lead.phone) recipients.add(lead.phone);
                                }
                            });
                        }
                    });
                }
            });
            
            const countEl = document.getElementById('campaign-recipient-count');
            if (countEl) {
                countEl.textContent = recipients.size;
            }
        };
        
        window.sendCampaignMessages = async function() {
            const device = document.getElementById('campaign-device').value;
            const message = document.getElementById('campaign-message').value;
            const sendDelay = document.getElementById('campaign-send-delay').checked;
            
            if (!device || !message.trim()) {
                showAlert('‚ùå L√ºtfen t√ºm alanlarƒ± doldurun!', 'danger');
                return;
            }
            
            if (!confirm('Kampanyayƒ± ba≈ülatmak istediƒüinize emin misiniz?')) {
                return;
            }
            
            const branchFilter = document.getElementById('campaign-branch-filter')?.value || 'all';
            const tagFilter = document.getElementById('campaign-tag-filter')?.value || 'all';
            const ageFilter = document.getElementById('campaign-agegroup-filter')?.value || 'all';
            
            // Alƒ±cƒ±larƒ± topla
            const recipients = [];
            const phoneSet = new Set();
            
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        let match = true;
                        
                        if (branchFilter !== 'all' && br.branchId !== branchFilter) match = false;
                        if (ageFilter !== 'all' && br.ageGroup !== ageFilter) match = false;
                        if (tagFilter !== 'all' && br.selectedTag !== tagFilter) match = false;
                        
                        if (match && lead.phone && !phoneSet.has(lead.phone)) {
                            phoneSet.add(lead.phone);
                            const name = br.ageGroup === 'adult' ? (br.fullName || lead.fullName) : br.parentName;
                            recipients.push({ phone: lead.phone, name: name || 'M√º≈üteri' });
                        }
                        
                        if (match && br.ageGroup === 'child' && br.children) {
                            br.children.forEach(c => {
                                if ((tagFilter === 'all' || c.selectedTag === tagFilter) && lead.phone && !phoneSet.has(lead.phone)) {
                                    phoneSet.add(lead.phone);
                                    recipients.push({ phone: lead.phone, name: br.parentName || 'Veli' });
                                }
                            });
                        }
                    });
                }
            });
            
            if (recipients.length === 0) {
                showAlert('‚ùå Se√ßilen kriterlere uygun m√º≈üteri bulunamadƒ±!', 'danger');
                return;
            }
            
            // G√∂nderim ba≈ülat
            const statusDiv = document.getElementById('campaign-status');
            const progressDiv = document.getElementById('campaign-progress');
            statusDiv.style.display = 'block';
            
            let successCount = 0;
            let failCount = 0;
            
            for (let i = 0; i < recipients.length; i++) {
                const recipient = recipients[i];
                const personalizedMessage = message
                    .replace(/\{ad\}/g, recipient.name)
                    .replace(/\{telefon\}/g, recipient.phone);
                
                progressDiv.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>ƒ∞lerleme:</strong> ${i + 1} / ${recipients.length}
                    </div>
                    <div style="background: #fff; border-radius: 8px; height: 20px; overflow: hidden;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${((i + 1) / recipients.length * 100).toFixed(1)}%; transition: width 0.3s;"></div>
                    </div>
                    <div style="margin-top: 10px; font-size: 14px;">
                        <span style="color: #4caf50;">‚úÖ Ba≈üarƒ±lƒ±: ${successCount}</span> | 
                        <span style="color: #f44336;">‚ùå Ba≈üarƒ±sƒ±z: ${failCount}</span>
                    </div>
                `;
                
                try {
                    const result = await sendWhatsAppMessage(device, recipient.phone, personalizedMessage, recipient.name);
                    if (result.success || result === true) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    failCount++;
                }
                
                if (sendDelay && i < recipients.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            progressDiv.innerHTML += `
                <div style="margin-top: 20px; padding: 15px; background: ${successCount > 0 ? '#e8f5e9' : '#ffebee'}; border-radius: 8px;">
                    <h4>üéâ Kampanya Tamamlandƒ±!</h4>
                    <p><strong>Toplam:</strong> ${recipients.length} | <strong>Ba≈üarƒ±lƒ±:</strong> ${successCount} | <strong>Ba≈üarƒ±sƒ±z:</strong> ${failCount}</p>
                </div>
            `;
        };
        
        // === YENƒ∞ KAMPANYA Sƒ∞STEMƒ∞ FONKSIYONLARI ===
        
        window.openCampaignModal = function() {
            // Etiket dropdown'ƒ±nƒ± doldur
            const tagSelect = document.getElementById('campaign-tag-select');
            if (tagSelect && crmTags) {
                const nonBranchTags = crmTags.filter(tag => tag.category !== 'branch');
                tagSelect.innerHTML = '<option value="">Se√ßiniz...</option>' + 
                    nonBranchTags.map(t => `<option value="${t.name}">üè∑Ô∏è ${t.name}</option>`).join('');
            }
            
            // Bran≈ü dropdown'ƒ±nƒ± doldur
            const branchSelect = document.getElementById('campaign-branch-select');
            if (branchSelect && branches) {
                branchSelect.innerHTML = '<option value="">Se√ßiniz...</option>' +
                    branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
            }
            
            // Modal'ƒ± a√ß
            document.getElementById('campaignModal').style.display = 'block';
        };
        
        window.updateCampaignRecipientCount = function(audienceType) {
            // Etiket ve bran≈ü filtrelerini g√∂ster/gizle
            document.getElementById('campaign-tag-filter').style.display = audienceType === 'crm-by-tag' ? 'block' : 'none';
            document.getElementById('campaign-branch-filter').style.display = audienceType === 'crm-by-branch' ? 'block' : 'none';
            
            // Alƒ±cƒ± sayƒ±sƒ±nƒ± hesapla
            let recipientCount = 0;
            
            switch(audienceType) {
                case 'all-members':
                    recipientCount = members.filter(m => m.Telefon).length;
                    break;
                case 'active-members':
                    recipientCount = members.filter(m => m.Telefon && m.Durum === 'aktif').length;
                    break;
                case 'inactive-members':
                    recipientCount = members.filter(m => m.Telefon && m.Durum !== 'aktif').length;
                    break;
                case 'crm-all':
                    recipientCount = crmLeads.filter(l => l.phone).length;
                    break;
                case 'crm-by-tag':
                case 'crm-by-branch':
                    // Kullanƒ±cƒ± etiketi veya bran≈üƒ± se√ßince hesaplanƒ±r
                    recipientCount = 0;
                    break;
            }
            
            document.getElementById('campaign-recipient-count').textContent = recipientCount;
            
            // Tahmini s√ºreyi hesapla
            const dailyLimit = parseInt(document.querySelector('input[name="dailyLimit"]').value) || 200;
            const estimatedDays = Math.ceil(recipientCount / dailyLimit);
            document.getElementById('campaign-duration').textContent = estimatedDays > 0 ? `${estimatedDays} g√ºn` : '-';
        };
        
        window.handleCreateCampaign = async function(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            const campaignData = {
                name: formData.get('campaignName'),
                targetAudience: formData.get('targetAudience'),
                messageContent: formData.get('messageContent'),
                dailyLimit: parseInt(formData.get('dailyLimit')),
                startTime: formData.get('startTime'),
                status: 'pending',
                createdAt: new Date().toISOString(),
                clubId: currentClubId,
                createdBy: currentUserEmail
            };
            
            // CRM filtreler
            if (campaignData.targetAudience === 'crm-by-tag') {
                campaignData.crmTag = formData.get('crmTag');
            } else if (campaignData.targetAudience === 'crm-by-branch') {
                campaignData.crmBranch = formData.get('crmBranch');
            }
            
            // Alƒ±cƒ±larƒ± belirle
            const recipients = getCampaignRecipients(campaignData);
            campaignData.totalRecipients = recipients.length;
            
            if (recipients.length === 0) {
                showAlert('‚ùå Hedef kitle bo≈ü! L√ºtfen alƒ±cƒ±larƒ± kontrol edin.', 'danger');
                return;
            }
            
            if (!confirm(`${recipients.length} ki≈üiye mesaj g√∂nderilecek. Devam etmek istiyor musunuz?`)) {
                return;
            }
            
            try {
                // Kampanyayƒ± Firebase'e kaydet
                const campaignRef = await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'campaigns'),
                    campaignData
                );
                
                // Alƒ±cƒ±larƒ± par√ßalara b√∂l ve kuyruƒüa ekle
                const startDate = new Date(campaignData.startTime);
                const dailyLimit = campaignData.dailyLimit;
                
                let dayOffset = 0;
                for (let i = 0; i < recipients.length; i += dailyLimit) {
                    const batch = recipients.slice(i, i + dailyLimit);
                    const scheduledDate = new Date(startDate);
                    scheduledDate.setDate(scheduledDate.getDate() + dayOffset);
                    
                    // Her alƒ±cƒ± i√ßin mesaj kuyruƒüuna ekle
                    for (const recipient of batch) {
                        const message = campaignData.messageContent
                            .replace(/{AD_SOYAD}/g, recipient.name || '')
                            .replace(/{AD}/g, (recipient.name || '').split(' ')[0])
                            .replace(/{TELEFON}/g, recipient.phone);
                        
                        await window.firebase.addDoc(
                            window.firebase.collection(window.db, 'messageQueue'),
                            {
                                clubId: currentClubId,
                                campaignId: campaignRef.id,
                                phone: recipient.phone,
                                message: message,
                                scheduledFor: scheduledDate.toISOString(),
                                status: 'pending',
                                createdAt: new Date().toISOString()
                            }
                        );
                    }
                    
                    dayOffset++;
                }
                
                showAlert(`‚úÖ Kampanya olu≈üturuldu! ${recipients.length} mesaj ${dayOffset} g√ºne b√∂l√ºnerek kuyruƒüa eklendi.`, 'success');
                closeModal('campaignModal');
                form.reset();
                loadCampaigns();
            } catch (error) {
                console.error('‚ùå Kampanya olu≈üturma hatasƒ±:', error);
                showAlert('‚ùå Kampanya olu≈üturulamadƒ±: ' + error.message, 'danger');
            }
        };
        
        function getCampaignRecipients(campaignData) {
            const recipients = [];
            const phoneSet = new Set();
            
            switch(campaignData.targetAudience) {
                case 'all-members':
                    members.forEach(m => {
                        if (m.Telefon && !phoneSet.has(m.Telefon)) {
                            phoneSet.add(m.Telefon);
                            recipients.push({
                                phone: m.Telefon,
                                name: m.OgrenciAdiSoyadi || m.VeliAdiSoyadi
                            });
                        }
                    });
                    break;
                case 'active-members':
                    members.filter(m => m.Durum === 'aktif').forEach(m => {
                        if (m.Telefon && !phoneSet.has(m.Telefon)) {
                            phoneSet.add(m.Telefon);
                            recipients.push({
                                phone: m.Telefon,
                                name: m.OgrenciAdiSoyadi || m.VeliAdiSoyadi
                            });
                        }
                    });
                    break;
                case 'inactive-members':
                    members.filter(m => m.Durum !== 'aktif').forEach(m => {
                        if (m.Telefon && !phoneSet.has(m.Telefon)) {
                            phoneSet.add(m.Telefon);
                            recipients.push({
                                phone: m.Telefon,
                                name: m.OgrenciAdiSoyadi || m.VeliAdiSoyadi
                            });
                        }
                    });
                    break;
                case 'crm-all':
                    crmLeads.forEach(lead => {
                        if (lead.phone && !phoneSet.has(lead.phone)) {
                            phoneSet.add(lead.phone);
                            recipients.push({
                                phone: lead.phone,
                                name: lead.fullName
                            });
                        }
                    });
                    break;
                case 'crm-by-tag':
                    crmLeads.forEach(lead => {
                        if (lead.branches) {
                            lead.branches.forEach(br => {
                                if (br.selectedTag === campaignData.crmTag && lead.phone && !phoneSet.has(lead.phone)) {
                                    phoneSet.add(lead.phone);
                                    recipients.push({
                                        phone: lead.phone,
                                        name: lead.fullName
                                    });
                                }
                            });
                        }
                    });
                    break;
                case 'crm-by-branch':
                    crmLeads.forEach(lead => {
                        if (lead.branches) {
                            lead.branches.forEach(br => {
                                if (br.branchId === campaignData.crmBranch && lead.phone && !phoneSet.has(lead.phone)) {
                                    phoneSet.add(lead.phone);
                                    recipients.push({
                                        phone: lead.phone,
                                        name: lead.fullName
                                    });
                                }
                            });
                        }
                    });
                    break;
            }
            
            return recipients;
        }
        
        window.loadCampaigns = async function() {
            const container = document.getElementById('campaigns-list');
            if (!container) return;
            
            try {
                container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Kampanyalar y√ºkleniyor...</span></div>';
                
                const campaignsRef = window.firebase.collection(window.db, 'campaigns');
                const q = window.firebase.query(
                    campaignsRef,
                    window.firebase.where('clubId', '==', currentClubId),
                    window.firebase.orderBy('createdAt', 'desc')
                );
                
                const snapshot = await window.firebase.getDocs(q);
                
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-state"><p>Hen√ºz kampanya olu≈üturulmamƒ±≈ü</p></div>';
                    return;
                }
                
                let html = '<div style="display: grid; gap: 15px;">';
                snapshot.forEach(doc => {
                    const campaign = doc.data();
                    const createdDate = new Date(campaign.createdAt).toLocaleString('tr-TR');
                    const startDate = new Date(campaign.startTime).toLocaleString('tr-TR');
                    
                    const statusColors = {
                        'pending': '#ff9800',
                        'active': '#4CAF50',
                        'completed': '#9e9e9e',
                        'paused': '#f44336'
                    };
                    
                    const statusText = {
                        'pending': '‚è∞ Bekliyor',
                        'active': '‚ñ∂Ô∏è Aktif',
                        'completed': '‚úÖ Tamamlandƒ±',
                        'paused': '‚è∏Ô∏è Duraklatƒ±ldƒ±'
                    };
                    
                    html += `
                        <div style="padding: 15px; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <h4 style="margin: 0 0 5px 0;">${campaign.name}</h4>
                                    <span style="background: ${statusColors[campaign.status]}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px;">
                                        ${statusText[campaign.status]}
                                    </span>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 6px; font-size: 13px;">
                                <div>
                                    <div style="color: #666;">üìä Alƒ±cƒ± Sayƒ±sƒ±</div>
                                    <div style="font-weight: 600;">${campaign.totalRecipients}</div>
                                </div>
                                <div>
                                    <div style="color: #666;">üìÖ G√ºnl√ºk Limit</div>
                                    <div style="font-weight: 600;">${campaign.dailyLimit}</div>
                                </div>
                                <div>
                                    <div style="color: #666;">üïê Ba≈ülangƒ±√ß</div>
                                    <div style="font-weight: 600;">${startDate}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
            } catch (error) {
                console.error('‚ùå Kampanyalar y√ºklenirken hata:', error);
                container.innerHTML = '<div class="empty-state"><p>Kampanyalar y√ºklenemedi</p></div>';
            }
        };
        
        // === KAMPANYA FONKSƒ∞YONLARI SONU ===
        
        window.sendCampaignMessages = async function() {
            
            showAlert(`‚úÖ Kampanya tamamlandƒ±! ${successCount} mesaj g√∂nderildi.`, 'success');
        };
        
        window.resetCampaignForm = function() {
            document.getElementById('campaign-branch-filter').value = 'all';
            document.getElementById('campaign-tag-filter').value = 'all';
            document.getElementById('campaign-agegroup-filter').value = 'all';
            document.getElementById('campaign-message').value = '';
            document.getElementById('campaign-send-delay').checked = false;
            document.getElementById('campaign-status').style.display = 'none';
            updateCampaignRecipients();
        };
        
        window.renderCampaignsPage = renderCampaignsPage;
        window.renderCRMLeads = renderCRMLeads;
        
        // ========== END CRM FUNCTIONS ==========

        function renderTasksPage() {
            const tableBody = document.getElementById('tasksTableBody');
            if (!tableBody) return;
            
            let filteredTasks = tasks;
            if (!currentUser.isSuperAdmin) {
                filteredTasks = tasks.filter(task => task.assignedTo === currentUser.fullName);
            }

            tableBody.innerHTML = filteredTasks.length === 0 
                ? `<tr><td colspan="8" class="empty-state"><h3>Aktif g√∂rev bulunmuyor.</h3></td></tr>`
                : filteredTasks.map(task => {
                    let statusClass = 'pending';
                    if (task.status === 'Tamamlandƒ±') statusClass = 'completed';
                    if (task.status === 'Devam Ediyor') statusClass = 'active';
                    const messageCount = (task.messages || []).length;
                    const unreadCount = (task.messages || []).filter(m => !m.read && m.sender !== currentUser.fullName).length;
                    return `
                    <tr>
                        <td>${task.taskName}</td>
                        <td>${task.assignedTo}</td>
                        <td><span class="status-badge status-${statusClass}">${task.status}</span></td>
                        <td>${task.notes || '-'}</td>
                        <td>${formatDate(task.createdAt)}</td>
                        <td>${task.completedAt ? formatDate(task.completedAt) : '-'}</td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="openTaskMessagesModal('${task.id}')">
                                üí¨ Mesajlar ${unreadCount > 0 ? `<span class="badge">${unreadCount}</span>` : `(${messageCount})`}
                            </button>
                        </td>
                        <td>
                            <div class="actions-cell">
                                <button class="btn btn-warning btn-sm" onclick="sendTaskReminder('${task.id}')" title="WhatsApp ile hatƒ±rlat">üîî Hatƒ±rlat</button>
                                <button class="btn btn-primary btn-sm" onclick="openTaskEditModal('${task.id}')">D√ºzenle</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteItem('tasks', '${task.id}')">Sil</button>
                            </div>
                        </td>
                    </tr>
                `}).join('');
        }
        
        async function sendTaskReminder(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) {
                showAlert('G√∂rev bulunamadƒ±.', 'danger');
                return;
            }
            
            // Find user phone number
            const assignedUser = users.find(u => u.fullName === task.assignedTo);
            if (!assignedUser || !assignedUser.phone) {
                showAlert('Atanan ki≈üinin telefon numarasƒ± bulunamadƒ±.', 'danger');
                return;
            }
            
            // Check WhatsApp connection
            const connectedDevice = whatsappDevices.find(d => d.status === 'connected' && d.instanceName === defaultWhatsAppDevice);
            if (!connectedDevice) {
                showAlert('WhatsApp baƒülantƒ±sƒ± bulunamadƒ±. L√ºtfen bir cihaz baƒülayƒ±n.', 'danger');
                return;
            }
            
            // Check if evolutionUrl exists
            if (!connectedDevice.evolutionUrl || connectedDevice.evolutionUrl === 'undefined') {
                showAlert('‚ö†Ô∏è WhatsApp cihazƒ±nƒ±n Evolution API URL\'si tanƒ±mlanmamƒ±≈ü. L√ºtfen WhatsApp ayarlarƒ±ndan cihazƒ± yeniden yapƒ±landƒ±rƒ±n.', 'danger');
                console.error('Device configuration:', connectedDevice);
                return;
            }
            
            // Format phone number for Evolution API
            let phoneNumber = assignedUser.phone.replace(/\D/g, ''); // Remove all non-digits
            if (phoneNumber.startsWith('0')) {
                phoneNumber = '90' + phoneNumber.substring(1); // Replace leading 0 with 90
            } else if (!phoneNumber.startsWith('90')) {
                phoneNumber = '90' + phoneNumber; // Add 90 prefix if missing
            }
            
            // Prepare message
            const message = `üîî G√∂rev Hatƒ±rlatmasƒ±\n\n` +
                          `G√∂rev: ${task.taskName}\n` +
                          `Durum: ${task.status}\n` +
                          `Notlar: ${task.notes || 'Yok'}\n` +
                          `Olu≈üturulma: ${formatDate(task.createdAt)}\n\n` +
                          `L√ºtfen g√∂revinizi kontrol edin.`;
            
            try {
                console.log(`üì§ Sending task reminder to ${phoneNumber}...`);
                
                // Send WhatsApp message
                const response = await fetch(`${connectedDevice.evolutionUrl}/message/sendText/${connectedDevice.instanceName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': connectedDevice.apiKey
                    },
                    body: JSON.stringify({
                        number: phoneNumber,
                        text: message
                    })
                });
                
                if (response.ok) {
                    showAlert(`‚úÖ Hatƒ±rlatma ${task.assignedTo} adlƒ± ki≈üiye g√∂nderildi.`, 'success');
                    
                    // Log the sent message
                    await window.firebase.addDoc(window.firebase.collection(window.db, 'sentMessages'), {
                        recipientName: task.assignedTo,
                        phone: phoneNumber,
                        message: message,
                        sentAt: new Date().toISOString(),
                        instanceName: connectedDevice.instanceName,
                        status: 'sent',
                        type: 'task-reminder',
                        clubId: currentClubId // ‚úÖ Kul√ºp ID'si eklendi
                    });
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå API Error:', errorText);
                    throw new Error(`Mesaj g√∂nderilemedi (${response.status})`);
                }
            } catch (error) {
                console.error('Error sending task reminder:', error);
                showAlert('Hatƒ±rlatma g√∂nderilirken hata olu≈ütu: ' + error.message, 'danger');
            }
        }
        
        window.sendTaskReminder = sendTaskReminder;
        
        function updateTaskNotificationStatus() {
            const container = document.getElementById('taskNotificationStatus');
            if (!container) return;
            
            const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
            const hasDefaultDevice = defaultWhatsAppDevice && connectedDevices.find(d => d.instanceName === defaultWhatsAppDevice);
            const taskTemplateEnabled = messageTemplates.task && messageTemplates.task.enabled;
            
            let statusHtml = '<div style="display: grid; gap: 15px;">';
            
            // Template Status
            statusHtml += `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">${taskTemplateEnabled ? '‚úÖ' : '‚ùå'}</span>
                    <div>
                        <strong>G√∂rev Bildirimi ≈ûablonu:</strong> 
                        <span style="color: ${taskTemplateEnabled ? 'green' : 'red'};">
                            ${taskTemplateEnabled ? 'Etkin' : 'Devre Dƒ±≈üƒ±'}
                        </span>
                        ${!taskTemplateEnabled ? '<br><small style="color: #666;">Ayarlar ‚Üí Mesaj ≈ûablonlarƒ± ‚Üí G√∂rev Bildirimi</small>' : ''}
                    </div>
                </div>
            `;
            
            // Device Status
            statusHtml += `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">${hasDefaultDevice ? '‚úÖ' : connectedDevices.length > 0 ? '‚ö†Ô∏è' : '‚ùå'}</span>
                    <div>
                        <strong>WhatsApp Cihazƒ±:</strong> 
                        <span style="color: ${hasDefaultDevice ? 'green' : connectedDevices.length > 0 ? 'orange' : 'red'};">
                            ${hasDefaultDevice ? `Ana hat: ${defaultWhatsAppDevice}` : connectedDevices.length > 0 ? `${connectedDevices.length} cihaz baƒülƒ± (Ana hat se√ßilmemi≈ü)` : 'Baƒülƒ± cihaz yok'}
                        </span>
                        ${!hasDefaultDevice ? '<br><small style="color: #666;">Ayarlar ‚Üí WhatsApp Ayarlarƒ± ‚Üí Ana WhatsApp Hattƒ±</small>' : ''}
                    </div>
                </div>
            `;
            
            // User Phone Numbers (check both phoneNumber and phone fields)
            const usersWithoutPhone = users.filter(u => !u.phoneNumber && !u.phone);
            statusHtml += `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">${usersWithoutPhone.length === 0 ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                    <div>
                        <strong>Y√∂netici Telefon Numaralarƒ±:</strong> 
                        <span style="color: ${usersWithoutPhone.length === 0 ? 'green' : 'orange'};">
                            ${users.length - usersWithoutPhone.length}/${users.length} kayƒ±tlƒ±
                        </span>
                        ${usersWithoutPhone.length > 0 ? `<br><small style="color: #666;">Eksik: ${usersWithoutPhone.map(u => u.fullName).join(', ')}</small>` : ''}
                    </div>
                </div>
            `;
            
            // Overall Status
            const canSendNotifications = taskTemplateEnabled && (hasDefaultDevice || connectedDevices.length > 0);
            statusHtml += `
                <div style="padding: 15px; background: ${canSendNotifications ? '#d4edda' : '#f8d7da'}; border-radius: 8px; margin-top: 10px;">
                    <strong style="color: ${canSendNotifications ? '#155724' : '#721c24'};">
                        ${canSendNotifications ? '‚úÖ G√∂rev bildirimleri √ßalƒ±≈üƒ±yor!' : '‚ùå G√∂rev bildirimleri √ßalƒ±≈ümƒ±yor'}
                    </strong>
                    ${!canSendNotifications ? '<br><small>Yukarƒ±daki eksiklikleri tamamlayƒ±n.</small>' : ''}
                </div>
            `;
            
            // Test Button
            if (canSendNotifications && users.length > 0) {
                statusHtml += `
                    <div style="margin-top: 10px;">
                        <button class="btn btn-warning" onclick="testTaskNotification()">üß™ Test Mesajƒ± G√∂nder</button>
                        <small style="color: #666; margin-left: 10px;">Size bir test g√∂revi mesajƒ± g√∂nderilecek</small>
                    </div>
                `;
            }
            
            statusHtml += '</div>';
            container.innerHTML = statusHtml;
        }
        
        window.testTaskNotification = async function() {
            if (!currentUser || !currentUser.phoneNumber) {
                return showAlert('‚ùå Profilinizde telefon numarasƒ± kayƒ±tlƒ± deƒüil!', 'danger');
            }
            
            showAlert('üì§ Test mesajƒ± g√∂nderiliyor...', 'info');
            
            const testTaskData = {
                taskName: 'Test G√∂revi',
                notes: 'Bu bir test mesajƒ±dƒ±r. G√∂rev bildirimleri √ßalƒ±≈üƒ±yor!',
                createdAt: new Date().toISOString(),
                assignedTo: currentUser.email
            };
            
            const success = await sendTaskNotification(testTaskData);
            
            if (success) {
                showAlert('‚úÖ Test mesajƒ± g√∂nderildi! Telefonunuzu kontrol edin.', 'success');
            } else {
                showAlert('‚ùå Test mesajƒ± g√∂nderilemedi. Ayarlarƒ± kontrol edin.', 'danger');
            }
        };
        
        // --- UPDATE & INTERACTION FUNCTIONS ---
        async function updateMemberStatus(memberId, newStatus) {
            const member = members.find(m => m.id === memberId);
            if (!member) return showAlert('√úye bulunamadƒ±.', 'danger');

            const memberGroups = groups.filter(g => g.members && g.members.includes(memberId));
            if (newStatus === 'active' && memberGroups.length === 0) {
                const proceed = confirm('Bu √ºye hen√ºz bir gruba atanmamƒ±≈ü. Yine de aktif yapmak istiyor musunuz?');
                if (!proceed) {
                    await loadData(); // Reload to revert the visual change
                return;
                }
            }

            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'members', memberId), { status: newStatus });
                showAlert('‚úÖ √úye durumu g√ºncellendi: ' + (newStatus === 'active' ? 'Aktif' : newStatus === 'pending' ? 'Bekliyor' : 'Pasif'), 'success');
                member.status = newStatus;
                renderCurrentSection(); // Re-render the current section to reflect changes
            } catch(e) { 
                showAlert('√úye durumu g√ºncellenirken hata.', 'danger'); 
                await loadData();
            }
        }

        async function saveReason(recordId, newReason, cellElement) {
            // Restore the onclick listener so it can be edited again
            cellElement.setAttribute('onclick', `editReason(this, '${recordId}')`);
            
            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'attendance', recordId), { reason: newReason });
                
                // Update local data
                const recordIndex = attendanceRecords.findIndex(rec => rec.id === recordId);
                if (recordIndex > -1) {
                    attendanceRecords[recordIndex].reason = newReason;
                }
                
                // Update UI without full reload
                cellElement.innerHTML = newReason || '<i>Sebep Ekle</i>';

                showAlert('Devamsƒ±zlƒ±k sebebi g√ºncellendi.', 'success');
            } catch (error) {
                console.error("Error updating absence reason:", error);
                showAlert('Sebep g√ºncellenirken bir hata olu≈ütu.', 'danger');
                cellElement.innerHTML = 'Hata olu≈ütu'; // Revert to some text
            }
        }

        async function removeMemberFromGroup(memberId, groupId) {
             showConfirmModal('√úyeyi gruptan √ßƒ±karmak istediƒüinize emin misiniz?', async () => {
                 closeModal('confirmModal');
                 try {
                     await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', groupId), {
                         members: window.firebase.arrayRemove(memberId)
                    });
                    
                    const remainingGroups = groups.filter(g => g.id !== groupId && g.members && g.members.includes(memberId));
                    if (remainingGroups.length === 0) {
                         await window.firebase.updateDoc(window.firebase.doc(window.db, 'members', memberId), { status: 'pending' });
                    }

                     showAlert('√úye gruptan √ßƒ±karƒ±ldƒ±.', 'success');
                     await loadData();
                 } catch (e) { showAlert('√úye gruptan √ßƒ±karƒ±lƒ±rken hata olu≈ütu.', 'danger'); }
             });
        }

        async function confirmGroupAssignment(memberId, newGroupId) {
            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', newGroupId), { members: window.firebase.arrayUnion(memberId) });
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'members', memberId), { status: 'active' });
                showAlert('√úye ba≈üarƒ±yla gruba eklendi.', 'success');
                closeModal('groupAssignModal');
                await loadData();
            } catch (error) { 
                showAlert('Gruba √ºye atanƒ±rken bir hata olu≈ütu.', 'danger'); 
                console.error(error);
            }
        }
        
        function deleteSchedule(event, scheduleId) {
            event.stopPropagation();
            const text = `Bu dersi takvimden kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.`;
            showConfirmModal(text, () => executeDeleteSchedule(scheduleId));
        }

        async function executeDeleteSchedule(scheduleId) {
            closeModal('confirmModal');
            try {
                await window.firebase.deleteDoc(window.firebase.doc(window.db, 'schedules', scheduleId));
                showAlert('Ders takvimden silindi.', 'success');
                await loadData();
            } catch (error) {
                showAlert('Ders silinirken bir hata olu≈ütu.', 'danger');
                console.error("Schedule delete error:", error);
            }
        }
        
        async function deletePaymentFromSchedule(preRegId, paymentNumber) {
            const text = `${paymentNumber}. taksiti kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.`;
            showConfirmModal(text, async () => {
                closeModal('confirmModal');
                try {
                    const preReg = preRegistrations.find(p => p.id === preRegId);
                    if (!preReg) throw new Error("√ñn kayƒ±t bulunamadƒ±.");

                    let updatedSchedule = preReg.paymentSchedule.filter(p => p.paymentNumber !== paymentNumber);

                    // Re-number subsequent payments
                    updatedSchedule.forEach((p, index) => {
                        p.paymentNumber = index + 1;
                    });
                    
                    await window.firebase.updateDoc(window.firebase.doc(window.db, 'preRegistrations', preRegId), { paymentSchedule: updatedSchedule });
                    
                    showAlert('Taksit ba≈üarƒ±yla silindi.', 'success');
                    await loadData();
                    viewPaymentPlan(preRegId);
                } catch (error) {
                    showAlert('Taksit silinirken bir hata olu≈ütu.', 'danger');
                    console.error("Payment delete error:", error);
                }
            });
        }

         async function deleteAttendanceRecord(recordId) {
            showConfirmModal('Bu yoklama kaydƒ±nƒ± kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz?', async () => {
                closeModal('confirmModal');
                try {
                    const record = attendanceRecords.find(r => r.id === recordId);
                    if (!record) throw new Error("Kayƒ±t bulunamadƒ±.");
                    const memberId = record.memberId;
                    
                    await window.firebase.deleteDoc(window.firebase.doc(window.db, 'attendance', recordId));
                    
                    // Remove from local array
                    attendanceRecords = attendanceRecords.filter(r => r.id !== recordId);
                    
                    showAlert('Yoklama kaydƒ± silindi.', 'success');
                    showMemberAttendancePage(memberId); // Refresh the view
                } catch (error) {
                    console.error("Error deleting attendance record:", error);
                    showAlert('Kayƒ±t silinirken bir hata olu≈ütu.', 'danger');
                }
            });
        }

        // --- UI & MODAL FUNCTIONS ---
        function assignToGroup(memberId, groupId = null) {
            const modalContent = document.getElementById('groupAssignContent');
            let contentHtml = '';
            
            if (memberId) { // Assign/Move a specific member
                const member = members.find(m => m.id === memberId);
                if (!member) return;
                
                document.getElementById('groupAssignTitle').textContent = `${member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad} i√ßin Grup Ata/Ta≈üƒ±`;
                
                const renderGroupList = (searchTerm = '') => {
                    const memberGroups = groups.filter(g => g.members && g.members.includes(memberId));
                    const memberGroupIds = memberGroups.map(g => g.id);
                    const availableGroups = groups.filter(g => {
                         const memberCount = members.filter(m => (g.members || []).includes(m.id) && m.status !== 'expired').length;
                         return g.branch === member.Brans && 
                                !memberGroupIds.includes(g.id) &&
                                memberCount < g.maxMembers &&
                                g.groupName.toLowerCase().includes(searchTerm.toLowerCase());
                    });

                    return `<div class="group-selection-list">${availableGroups.map(g => {
                        const memberCount = members.filter(m => (g.members || []).includes(m.id) && m.status !== 'expired').length;
                        return `<div class="group-selection-item" onclick="promptMoveOrAdd('${memberId}', '${g.id}')"><strong>${g.groupName}</strong><span>${memberCount}/${g.maxMembers}</span></div>`
                    }).join('') || '<p class="empty-state">Bu bran≈üta atanacak uygun grup bulunmuyor.</p>'}</div>`;
                }

                contentHtml = `
                    <div class="form-group" style="margin-bottom: 15px;">
                        <input type="search" id="groupAssignSearchInput" class="form-control" placeholder="Grup adƒ± ile ara...">
                    </div>
                    <div id="group-list-container">
                        ${renderGroupList()}
                    </div>
                `;
                 modalContent.innerHTML = contentHtml;
                 modalContent.querySelector('#groupAssignSearchInput').addEventListener('input', (e) => {
                    modalContent.querySelector('#group-list-container').innerHTML = renderGroupList(e.target.value);
                 });


            } else if (groupId) { // Add/remove members from a specific group
                const group = groups.find(g => g.id === groupId);
                if (!group) return;
                document.getElementById('groupAssignTitle').textContent = `${group.groupName} grubuna √ºye ekle/√ßƒ±kar`;
                const unassignedMembers = members.filter(m => m.status !== 'expired' && m.Brans === group.branch && !(group.members || []).includes(m.id));
                const assignedMembers = members.filter(m => (group.members || []).includes(m.id) && m.status !== 'expired');

                contentHtml = '<h4>Gruba Ekle</h4>' + (unassignedMembers.length > 0 ? unassignedMembers.map(m =>
                     `<div class="group-selection-item" onclick="confirmGroupAssignment('${m.id}', '${groupId}')"><strong>${m.Resit_Olmayan_Adi_Soyadi || m.Ad_Soyad}</strong><span>+ Ekle</span></div>`
                ).join('') : '<p>Eklenecek √ºye yok.</p>');

                contentHtml += '<hr style="margin: 20px 0;"><h4>Gruptan √áƒ±kar</h4>' + (assignedMembers.length > 0 ? assignedMembers.map(m =>
                     `<div class="group-selection-item" onclick="removeMemberFromGroup('${m.id}', '${groupId}')"><strong>${m.Resit_Olmayan_Adi_Soyadi || m.Ad_Soyad}</strong><span style="color:red;">- √áƒ±kar</span></div>`
                ).join('') : '<p>√áƒ±karƒ±lacak √ºye yok.</p>');
                 modalContent.innerHTML = contentHtml;
            }
           
            openModal('groupAssignModal');
        }

        function togglePaymentDetails(memberId, forceOpen = false) {
            const detailsDiv = document.getElementById(`payment-details-${memberId}`);
            if (detailsDiv) {
                if(forceOpen) detailsDiv.style.display = 'block';
                else detailsDiv.style.display = detailsDiv.style.display === 'block' ? 'none' : 'block';
            }
        }
        
        function openMemberEditModal(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            // √úye adƒ±nƒ± belirle
            const memberName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad || 'ƒ∞simsiz';
            const parentName = member.Ad_Soyad || '-';
            const parentName2 = member.Veli_2_Adi_Soyadi || '-';
            const phone1 = member.Telefon || '-';
            const phone2 = member.Telefon_2 || '-';
            
            // Grubunu bul
            const memberGroups = groups.filter(g => g.members && g.members.includes(memberId));
            const groupNames = memberGroups.map(g => g.groupName).join(', ') || 'Atanmamƒ±≈ü';
            
            // Bran≈üƒ±nƒ± bul
            const branchName = memberGroups.length > 0 && memberGroups[0].branch 
                ? (branches.find(b => b.id === memberGroups[0].branch)?.name || 'Bilinmiyor')
                : 'Atanmamƒ±≈ü';
            
            const html = `
                <div id="memberDetailModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <span class="close" onclick="closeMemberDetail()">&times;</span>
                        <h3>üë§ ${memberName}</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">üìû Telefon 1</div>
                                <div style="font-size: 16px; font-weight: bold;">${formatPhoneDisplay(phone1)}</div>
                            </div>
                            ${phone2 !== '-' ? `
                            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">üìû Telefon 2</div>
                                <div style="font-size: 16px; font-weight: bold;">${formatPhoneDisplay(phone2)}</div>
                            </div>
                            ` : ''}
                            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">üéØ Bran≈ü</div>
                                <div style="font-size: 16px; font-weight: bold;">${branchName}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">üë• Grup</div>
                                <div style="font-size: 14px; font-weight: bold;">${groupNames}</div>
                            </div>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <div class="customer-tabs">
                                <button class="tab-button active" onclick="switchMemberTab(0)">üìã Genel Bilgiler</button>
                                <button class="tab-button" onclick="switchMemberTab(1); loadMemberCallRecords('${memberId}')">üìû G√∂r√º≈üme Kayƒ±tlarƒ±</button>
                            </div>
                            
                            <div class="tab-content active" style="padding: 20px; background: white; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 8px 8px;">
                                <h4 style="margin-top: 0;">üë§ √úye Bilgileri</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div><strong>√ñƒürenci Adƒ±:</strong> ${member.Resit_Olmayan_Adi_Soyadi || '-'}</div>
                                    <div><strong>Veli 1:</strong> ${parentName}</div>
                                    <div><strong>Veli 2:</strong> ${parentName2}</div>
                                    <div><strong>Durum:</strong> ${member.status === 'active' ? '‚úÖ Aktif' : member.status === 'expired' ? '‚ùå Pasif' : '‚è∏Ô∏è Dondurulmu≈ü'}</div>
                                    ${member.DogumTarihi ? `<div><strong>Doƒüum Tarihi:</strong> ${new Date(member.DogumTarihi).toLocaleDateString('tr-TR')}</div>` : ''}
                                </div>
                            </div>
                            
                            <div class="tab-content" style="padding: 20px; background: white; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 8px 8px; display: none;">
                                <h4 style="margin-top: 0;">üìû G√∂r√º≈üme Kayƒ±tlarƒ±</h4>
                                <div id="memberCallRecords-${memberId}">
                                    <div class="loading"><div class="spinner"></div><span>G√∂r√º≈üme kayƒ±tlarƒ± y√ºkleniyor...</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
                            <button class="btn btn-primary" onclick="closeMemberDetail(); openMemberEditForm('${memberId}')">‚úèÔ∏è D√ºzenle</button>
                            <button class="btn btn-secondary" onclick="closeMemberDetail()">Kapat</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Modal varsa kaldƒ±r
            const existing = document.getElementById('memberDetailModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', html);
            
            // Backdrop'a tƒ±klayƒ±nca modalƒ± kapat
            const modal = document.getElementById('memberDetailModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
        }
        
        // √úye detay modalƒ±nƒ± kapat
        window.closeMemberDetail = function() {
            const modal = document.getElementById('memberDetailModal');
            if (modal) modal.remove();
        };
        
        // √úye detay sekmelerini deƒüi≈ütir
        window.switchMemberTab = function(tabIndex) {
            const modal = document.getElementById('memberDetailModal');
            if (!modal) return;
            
            const tabs = modal.querySelectorAll('.tab-button');
            const contents = modal.querySelectorAll('.tab-content');
            
            tabs.forEach((btn, idx) => {
                if (idx === tabIndex) {
                    btn.classList.add('active');
                    contents[idx].style.display = 'block';
                } else {
                    btn.classList.remove('active');
                    contents[idx].style.display = 'none';
                }
            });
        };
        
        // √úye g√∂r√º≈üme kayƒ±tlarƒ±nƒ± y√ºkle
        window.loadMemberCallRecords = async function(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            const container = document.getElementById(`memberCallRecords-${memberId}`);
            if (!container || container.dataset.loaded === 'true') return;
            
            // Telefon numarasƒ±nƒ± belirle - √ñnce Telefon, sonra Telefon_2
            const phoneNumber = member.Telefon || member.Telefon_2;
            if (!phoneNumber) {
                container.innerHTML = '<p style="color: #999;">Bu √ºye i√ßin telefon numarasƒ± bulunamadƒ±.</p>';
                return;
            }
            
            await renderCallRecords(phoneNumber, `memberCallRecords-${memberId}`);
            container.dataset.loaded = 'true';
        };
        
        // Eski d√ºzenleme formunu a√ß
        window.openMemberEditForm = function(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            const form = document.getElementById('memberEditForm');
            form.memberId.value = memberId;
            form.Ad_Soyad.value = member.Ad_Soyad || '';
            form.Veli_2_Adi_Soyadi.value = member.Veli_2_Adi_Soyadi || '';
            form.Telefon_2.value = member.Telefon_2 || '';
            form.Resit_Olmayan_Adi_Soyadi.value = member.Resit_Olmayan_Adi_Soyadi || '';
            form.Telefon.value = member.Telefon || '';
            openModal('memberEditModal');
        }

        function openPreRegEditModal(preRegId) {
            const reg = preRegistrations.find(p => p.id === preRegId);
            if (!reg) return showAlert('√ñn kayƒ±t bulunamadƒ±.', 'danger');
            
            const member = members.find(m => m.preRegistrationId === preRegId);
            const isAdult = member && !member.Resit_Olmayan_Adi_Soyadi;

            const form = document.getElementById('preRegEditForm');
            form.preRegId.value = preRegId;
            form.parentName.value = reg.parentName || '';
            form.studentName.value = reg.studentName || '';
            form.branch.value = reg.branch || '';
            form.notes.value = reg.notes || '';
            
            toggleParentStudentFieldsForEdit(form, isAdult);

            // --- Group Selector Logic for Edit Modal ---
            const groupSearchInput = form.querySelector('#preRegEditGroupSearch');
            const groupHiddenInput = form.querySelector('#preRegEditGroupId');
            const groupResultsContainer = form.querySelector('#preRegEditGroupResults');
            
            // Only check groups if member exists
            if (member && member.id) {
            const memberGroups = groups.filter(g => g.members && g.members.includes(member.id));
            if(memberGroups.length > 0) {
                // If in multiple groups, just show one for simplicity in this UI or leave blank
                groupSearchInput.value = memberGroups[0].groupName; 
                groupHiddenInput.value = memberGroups[0].id;
                } else {
                     groupSearchInput.value = '';
                     groupHiddenInput.value = '';
                }
            } else {
                 groupSearchInput.value = '';
                 groupHiddenInput.value = '';
            }

            const availableGroups = groups.filter(g => {
                const memberCount = members.filter(m => (g.members || []).includes(m.id) && m.status !== 'expired').length;
                return g.branch === reg.branch && memberCount < g.maxMembers;
            });

            groupSearchInput.oninput = () => {
                const searchTerm = groupSearchInput.value.toLowerCase();
                groupHiddenInput.value = '';
                const filtered = availableGroups.filter(g => g.groupName.toLowerCase().includes(searchTerm));
                
                groupResultsContainer.innerHTML = filtered.length > 0 ? filtered.map(g => {
                    const memberCount = members.filter(m => (g.members || []).includes(m.id) && m.status !== 'expired').length;
                    return `<div class="searchable-select-item" data-id="${g.id}" data-name="${g.groupName}">${g.groupName} - (${memberCount}/${g.maxMembers})</div>`
                }).join('') : '<div class="searchable-select-item disabled">Sonu√ß bulunamadƒ±</div>';
                groupResultsContainer.classList.add('active');
            };

            groupResultsContainer.onclick = (e) => {
                if (e.target.classList.contains('searchable-select-item') && e.target.dataset.id) {
                    groupHiddenInput.value = e.target.dataset.id;
                    groupSearchInput.value = e.target.dataset.name;
                    groupResultsContainer.classList.remove('active');
                    console.log('PreReg Edit - Group selected:', { 
                        groupId: groupHiddenInput.value, 
                        groupName: groupSearchInput.value 
                    });
                }
            };

            openModal('preRegEditModal');
        }
        
        function openGroupEditModal(groupId) {
            const group = groups.find(g => g.id === groupId);
            if(!group) return;
            const form = document.getElementById('groupForm');
            form.reset();
            
            // ‚úÖ Bran≈ü dropdown'unu dinamik olarak g√ºncelle
            const branchSelect = form.querySelector('[name="branch"]');
            branchSelect.innerHTML = '<option value="">Se√ßiniz...</option>' + 
                branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
            
            form.groupId.value = groupId;
            form.groupName.value = group.groupName;
            form.branch.value = group.branch;
            form.instructor.value = group.instructor;
            form.maxMembers.value = group.maxMembers;
            form.description.value = group.description || '';
            
            // Load existing schedule times and days for this group
            const groupSchedules = schedules.filter(s => s.groupId === groupId);
            if (groupSchedules.length > 0) {
                // Get unique days and sort them
                const scheduledDays = [...new Set(groupSchedules.map(s => s.day))];
                const checkboxes = form.querySelectorAll('input[name="days"]');
                checkboxes.forEach(cb => {
                    cb.checked = scheduledDays.includes(cb.value);
                });
                
                // Set time from first schedule (assuming all schedules have same time)
                const firstSchedule = groupSchedules[0];
                const startTimeInput = form.querySelector('[name="startTime"]');
                const endTimeInput = form.querySelector('[name="endTime"]');
                if (startTimeInput) startTimeInput.value = firstSchedule.startTime;
                if (endTimeInput) endTimeInput.value = firstSchedule.endTime;
            }
            
            document.getElementById('groupModalTitle').textContent = 'Grubu D√ºzenle';
            openModal('groupModal');
        }
        
        function openAttendanceModal(groupId) {
            const group = groups.find(g => g.id === groupId);
            if(!group) return;

            const modalTitle = document.getElementById('attendanceModalTitle');
            const attendanceList = document.getElementById('attendanceList');
            const form = document.getElementById('attendanceForm');

            modalTitle.textContent = `üìù ${group.groupName} - Yoklama`;
            form.groupId.value = groupId;
            form.querySelector('[name="attendanceDate"]').value = getTodayString();
            
            const groupMembers = members.filter(m => (group.members || []).includes(m.id) && m.status === 'active');

            if(groupMembers.length === 0) {
                attendanceList.innerHTML = `<p class="empty-state">Bu grupta aktif √ºye bulunmuyor.</p>`;
            } else {
                attendanceList.innerHTML = groupMembers.map(m => `
                    <div class="attendance-item">
                        <label>
                            <input type="checkbox" name="presentMembers" value="${m.id}" onchange="toggleReasonInput(this, '${m.id}')" checked>
                            <span>${m.Resit_Olmayan_Adi_Soyadi || m.Ad_Soyad}</span>
                        </label>
                        <input type="text" name="reason_${m.id}" class="form-control reason-input" placeholder="Devamsƒ±zlƒ±k sebebi..." style="display:none;">
                    </div>
                `).join('');
            }
            openModal('attendanceModal');
        }
        
        function openTaskEditModal(taskId = null) {
            const form = document.getElementById('taskForm');
            form.reset();
            const modalTitle = document.getElementById('taskModalTitle');
            
            const assigneeSelect = form.querySelector('[name="assignedTo"]');
            assigneeSelect.innerHTML = users.map(u => `<option value="${u.fullName}">${u.fullName}</option>`).join('');

            if (taskId) { // Edit mode
                modalTitle.textContent = 'G√∂revi D√ºzenle';
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    form.taskId.value = task.id;
                    form.taskName.value = task.taskName;
                    form.assignedTo.value = task.assignedTo;
                    form.status.value = task.status;
                    form.notes.value = task.notes || '';
                }
            } else { // Add mode
                modalTitle.textContent = 'Yeni G√∂rev Ekle';
                form.taskId.value = '';
            }
            openModal('taskModal');
        }

        function openProfileEditModal() {
            const form = document.getElementById('profileForm');
            form.reset();
            form.fullName.value = currentUser.fullName;
            form.phone.value = currentUser.phone || currentUser.phoneNumber || '';
            openModal('profileModal');
        }
        
        // --- DRAG & DROP FUNCTIONS ---
        function drag(ev, id, isGroup) { 
            ev.dataTransfer.setData("id", id);
            ev.dataTransfer.setData("isGroup", isGroup);
        }
        function allowDrop(ev) { 
            ev.preventDefault();
            ev.currentTarget.classList.add('drag-over');
            ev.currentTarget.addEventListener('dragleave', () => ev.currentTarget.classList.remove('drag-over'), { once: true });
        }
        async function drop(ev, day) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            const id = ev.dataTransfer.getData("id");
            const isGroup = ev.dataTransfer.getData("isGroup") === 'true';
            
            if (isGroup) {
                openScheduleModalForGroup(id, day);
            }
        }

        // ‚úÖ Mevcut schedule'ƒ± d√ºzenle (saha bilgisi ekle/g√ºncelle)
        window.editScheduleCourt = async function(scheduleId) {
            const schedule = schedules.find(s => s.id === scheduleId);
            if (!schedule) return;
            
            const group = groups.find(g => g.id === schedule.groupId);
            if (!group) return;
            
            const branchInfo = branches.find(b => b.id === schedule.branch);
            if (!branchInfo || !branchInfo.courts || branchInfo.courts.length === 0) {
                return showAlert('Bu bran≈üta saha tanƒ±mlƒ± deƒüil.', 'warning');
            }
            
            const courtOptions = branchInfo.courts.map((c, idx) => `${idx + 1}. ${c.name}`).join('\n');
            const currentCourt = schedule.court ? `\n\nMevcut saha: ${schedule.court}` : '';
            const courtChoice = prompt(`Saha se√ßin:${currentCourt}\n\n${courtOptions}\n\nSaha numarasƒ±nƒ± girin (0 = saha kaldƒ±r):`);
            
            if (courtChoice === null) return; // ƒ∞ptal
            
            let newCourt = null;
            if (courtChoice !== '0' && courtChoice !== '') {
                const courtIndex = parseInt(courtChoice) - 1;
                if (courtIndex >= 0 && courtIndex < branchInfo.courts.length) {
                    newCourt = branchInfo.courts[courtIndex].name;
                }
            }
            
            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'schedules', scheduleId), {
                    court: newCourt
                });
                showAlert(`‚úÖ Saha bilgisi ${newCourt ? `"${newCourt}" olarak` : ''} g√ºncellendi`, 'success');
                await loadData();
            } catch (error) {
                console.error('Error updating court:', error);
                showAlert('‚ùå Saha g√ºncellenirken hata olu≈ütu', 'danger');
            }
        }

        function openScheduleModalForGroup(groupId, day = null) {
            const group = groups.find(g => g.id === groupId);
            if (!group) {
                console.log('‚ùå Grup bulunamadƒ±:', groupId);
                return;
            }
            
            console.log('üîµ openScheduleModalForGroup √ßaƒürƒ±ldƒ±:', group.groupName, 'Bran≈ü:', group.branch);
            
            const form = document.getElementById('newScheduleForm');
            if (!form) return;
            
            form.reset();
            
            // Grup bilgilerini doldur
            form.querySelector('[name="groupId"]').value = groupId;
            form.querySelector('[name="groupName"]').value = group.groupName;
            
            // ‚úÖ Bran≈ü bilgisini bul ve saha dropdown'unu hazƒ±rla
            const branchInfo = branches.find(b => b.id === group.branch);
            console.log('üìå Bran≈ü bilgisi:', branchInfo);
            console.log('üìç Sahalar:', branchInfo?.courts);
            
            const courtSelectContainer = document.getElementById('courtSelectContainer');
            const courtSelect = document.getElementById('courtSelect');
            
            if (branchInfo && branchInfo.courts && branchInfo.courts.length > 0) {
                console.log('‚úÖ Sahalar mevcut, dropdown g√∂steriliyor...');
                // Saha dropdown'unu doldur
                courtSelect.innerHTML = '<option value="">Saha Se√ßiniz (opsiyonel)</option>' + 
                    branchInfo.courts.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                
                // ‚úÖ Eƒüer bir saha se√ßiliyse, onu otomatik se√ß
                if (selectedCourtForSchedule) {
                    courtSelect.value = selectedCourtForSchedule;
                }
                
                courtSelectContainer.style.display = 'block';
            } else {
                console.log('‚ö†Ô∏è Bu bran≈üta saha yok');
                courtSelectContainer.style.display = 'none';
            }
            
            // Mevcut schedule'larƒ± kontrol et ve formda g√∂ster
            const groupSchedules = schedules.filter(s => s.groupId === groupId);
            if (groupSchedules.length > 0) {
                // Mevcut g√ºnleri i≈üaretle
                const scheduledDays = [...new Set(groupSchedules.map(s => s.day))];
                const checkboxes = form.querySelectorAll('input[name="days"]');
                checkboxes.forEach(cb => {
                    cb.checked = scheduledDays.includes(cb.value);
                });
                
                // Mevcut saatleri doldur
                const firstSchedule = groupSchedules[0];
                form.querySelector('[name="startTime"]').value = firstSchedule.startTime;
                form.querySelector('[name="endTime"]').value = firstSchedule.endTime;
                
                // Mevcut sahayƒ± se√ß
                if (firstSchedule.court && courtSelect) {
                    courtSelect.value = firstSchedule.court;
                }
            } else if (day) {
                // Belirli bir g√ºne s√ºr√ºklenirse o g√ºn√º i≈üaretle
                const checkboxes = form.querySelectorAll('input[name="days"]');
                checkboxes.forEach(cb => {
                    cb.checked = cb.value === day;
                });
            }

            // Modal'ƒ± a√ß
            openModal('scheduleModal');
        }
        
        function showMembers(event, groupId) {
            const tooltip = document.getElementById('member-tooltip');
            const group = groups.find(g => g.id === groupId);
            if (!group || !group.members || group.members.length === 0) {
                tooltip.innerHTML = 'Bu grupta √ºye yok.';
            } else {
                const memberNames = group.members.map(mid => members.find(m => m.id === mid)?.Ad_Soyad || 'Bilinmeyen √úye');
                tooltip.innerHTML = `<ul><li>${memberNames.join('</li><li>')}</li></ul>`;
            }
            tooltip.style.display = 'block';
            tooltip.style.left = `${event.pageX + 15}px`;
            tooltip.style.top = `${event.pageY + 15}px`;
        }
        function hideMembers() { document.getElementById('member-tooltip').style.display = 'none'; }
        
        // --- OTHER UI FUNCTIONS ---
        function applyRolePermissions() {
             // Ayarlar men√ºs√º artƒ±k t√ºm kul√ºpler i√ßin g√∂r√ºn√ºr
             // SuperAdmin kontrol√º kaldƒ±rƒ±ldƒ±
             
             // ‚úÖ Admin kullanƒ±cƒ±larƒ± t√ºm izinlere sahip
             if (currentUser && currentUser.role === 'admin') {
                 console.log('‚úÖ Admin kullanƒ±cƒ±sƒ± - t√ºm izinler verildi');
                 return; // Adminler i√ßin hi√ßbir kƒ±sƒ±tlama yok
             }
             
             // Permissions kontrol√º - eƒüer permissions yoksa varsayƒ±lan olarak hepsine izin ver
             if (!currentUser || !currentUser.permissions) {
                 console.log('‚ö†Ô∏è User permissions bulunamadƒ±, varsayƒ±lan izinler uygulanƒ±yor');
                 return;
             }

             if (!currentUser.permissions.view_payments) {
                  const paymentsBtn = document.querySelector('.nav-btn[onclick*="payments"]');
                  if (paymentsBtn) paymentsBtn.style.display = 'none';
             }

             if (!currentUser.permissions.view_stats) {
                const paymentStats = document.getElementById('payment-stats');
                if(paymentStats) paymentStats.style.display = 'none';
                
                const monthlyRevenueCard = document.getElementById('monthlyRevenue');
                if(monthlyRevenueCard) monthlyRevenueCard.closest('.stat-card').style.display = 'none';
             }
             
             if (!currentUser.permissions.manage_users) {
                  document.getElementById('user-management-card').style.display = 'none';
             }
        }
        
        function updateDashboard() {
            document.getElementById('totalMembers').textContent = members.length;
            document.getElementById('activeMembers').textContent = members.filter(m => m.status === 'active').length;
            document.getElementById('inactiveMembers').textContent = members.filter(m => m.status === 'expired').length;
            // Bekleyen kayƒ±tlar: pending_contract durumundaki preRegistrations
            // Ama aktif veya pasif olmayan √ºyeleri filtrele
            const pendingPreRegs = preRegistrations.filter(p => {
                if (p.status !== 'pending_contract') return false;
                
                // Bu preReg'e ait member var mƒ± kontrol et
                const member = members.find(m => 
                    m.preRegistrationId === p.id || 
                    (m.Telefon && p.phone && m.Telefon.replace(/\D/g, '').replace(/^0/, '') === p.phone.replace(/\D/g, '').replace(/^0/, ''))
                );
                
                // Eƒüer √ºye aktif veya pasif ise g√∂sterme
                if (member && (member.status === 'active' || member.status === 'expired')) {
                    return false;
                }
                
                return true;
            });
            
            document.getElementById('pendingRegistrations').textContent = pendingPreRegs.length;
            
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const prevMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            
            let currentMonthRevenue = 0, previousMonthRevenue = 0;

            preRegistrations.forEach(preReg => {
                if (preReg.paymentSchedule) {
                    preReg.paymentSchedule.forEach(p => {
                        if (p.status === 'paid' && p.paymentDate) {
                            const paymentDate = new Date(p.paymentDate);
                            if (paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear) {
                                currentMonthRevenue += p.amount;
                            } else if (paymentDate.getMonth() === prevMonth && paymentDate.getFullYear() === prevMonthYear) {
                                previousMonthRevenue += p.amount;
                            }
                        }
                    });
                }
            });

            document.getElementById('monthlyRevenue').textContent = currentMonthRevenue.toLocaleString('tr-TR') + '‚Ç∫';
            const comparisonEl = document.getElementById('revenueComparison');
            if (previousMonthRevenue > 0) {
                const percentChange = ((currentMonthRevenue - previousMonthRevenue) / previousMonthRevenue) * 100;
                comparisonEl.textContent = `${percentChange >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(percentChange).toFixed(1)}% (√ñnceki Ay)`;
                comparisonEl.className = `stat-comparison ${percentChange >= 0 ? 'increase' : 'decrease'}`;
            } else {
                comparisonEl.textContent = '√ñnceki ay veri yok';
                 comparisonEl.className = 'stat-comparison';
            }
            
            // Dashboard tutarlarƒ±nƒ± maskele (eƒüer gizli ise)
            setTimeout(() => applyDashboardAmountsVisibility(), 50);
            
            renderAbsentStudents();
            renderUpcomingBirthdays();
            // renderKayitOlabilirReminders(); // ‚ùå Kaldƒ±rƒ±ldƒ± - CRM Dashboard'da var
            // renderDenemeGelecekReminders(); // ‚ùå Kaldƒ±rƒ±ldƒ± - CRM Dashboard'da var
        }

        function updatePaymentStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            let totalPaidThisMonth = 0;
            let pendingThisMonth = 0;

            const relevantMemberPreRegIds = members
                .filter(m => m.status === 'active' || m.status === 'pending')
                .map(m => m.preRegistrationId)
                .filter(id => id);

            preRegistrations.forEach(reg => {
                 if (relevantMemberPreRegIds.includes(reg.id)) { // Only count active/pending members
                     if (reg.paymentSchedule) {
                         reg.paymentSchedule.forEach(p => {
                             const dueDate = new Date(p.dueDate + 'T00:00:00');

                             // Calculate total paid this month
                             if (p.status === 'paid' && p.paymentDate) {
                                 const paymentDate = new Date(p.paymentDate);
                                 if (paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear) {
                                     totalPaidThisMonth += p.amount;
                                 }
                             }

                             // Calculate expectations for unpaid items
                             if (p.status === 'unpaid') {
                                 const isDueThisMonth = dueDate.getMonth() === currentMonth && dueDate.getFullYear() === currentYear;
                                 if (isDueThisMonth) {
                                     pendingThisMonth += p.amount;
                                 }
                             }
                         });
                     }
                 }
            });

            const totalCiro = totalPaidThisMonth + pendingThisMonth;

            document.getElementById('totalRevenue').textContent = totalCiro.toLocaleString('tr-TR') + '‚Ç∫';
            document.getElementById('totalPaid').textContent = totalPaidThisMonth.toLocaleString('tr-TR') + '‚Ç∫';
            document.getElementById('totalUnpaid').textContent = pendingThisMonth.toLocaleString('tr-TR') + '‚Ç∫';


            const overdueCount = members.filter(m => {
                const preReg = preRegistrations.find(p => p.id === m.preRegistrationId || p.phone === m.Telefon);
                return preReg && preReg.paymentSchedule && preReg.paymentSchedule.some(p => p.status === 'unpaid' && new Date(p.dueDate + 'T00:00:00') < today);
            }).length;
            document.getElementById('overdue-count').textContent = `(${overdueCount})`;
            
            const finishedCount = members.filter(member => {
                const preReg = preRegistrations.find(p => p.id === member.preRegistrationId || p.phone === member.Telefon);
                return preReg && preReg.paymentSchedule && preReg.paymentSchedule.every(p => p.status === 'paid');
            }).length;
            document.getElementById('finished-count').textContent = `(${finishedCount})`;
            
            // √ñdeme tutarlarƒ±nƒ± maskele (eƒüer gizli ise)
            setTimeout(() => applyPaymentVisibility(), 50);
        }

        function renderAbsentStudents() {
            const container = document.getElementById('absentStudentsList');
            if(!container) return;
            
            // ‚úÖ Sadece aktif √ºyelere ait devamsƒ±zlƒ±klarƒ± g√∂ster
            const allAbsences = attendanceRecords
                .filter(rec => {
                    if (rec.status !== 'absent') return false;
                    const member = members.find(m => m.id === rec.memberId);
                    return member && member.status === 'active'; // Sadece aktif √ºyeler
                })
                .sort((a, b) => new Date(b.date) - new Date(a.date));
                
            const displayAbsences = allAbsences.slice(0, 10);

            if (displayAbsences.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>Son zamanlarda devamsƒ±zlƒ±k yapan √∂ƒürenci bulunmuyor.</p></div>`;
                return;
            }
            
            let html = displayAbsences.map(absence => {
                const member = members.find(m => m.id === absence.memberId);
                if (!member) return ''; // G√ºvenlik kontrol√º
                
                const memberName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad || 'ƒ∞simsiz';
                const phone = member.Telefon || 'Telefon yok';
                const dateStr = formatDate(absence.date);
                const reasonText = absence.reason ? absence.reason : '<i style="color: #999;">Sebep belirtilmedi</i>';
                
                return `
                    <div class="absence-item" onclick="showMemberAttendancePage('${member.id}')" style="cursor: pointer;">
                        <div>
                            <strong>${memberName}</strong><br>
                            <small style="color: #666;">üìû ${phone} ‚Ä¢ üìÖ ${dateStr}</small>
                        </div>
                        <div class="absence-reason">
                            ${reasonText}
                        </div>
                    </div>
                `;
            }).filter(html => html !== '').join(''); // Bo≈ü HTML'leri filtrele
            
            if (allAbsences.length > 10) {
                html += `<div style="text-align: center; padding: 15px;">
                    <button class="btn btn-primary btn-sm" onclick="showSection('attendance-tracking', document.querySelector('.nav-btn[onclick*=attendance]'))">T√ºm Devamsƒ±zlƒ±klarƒ± G√∂ster (${allAbsences.length})</button>
                </div>`;
            }
            
            container.innerHTML = html || `<div class="empty-state"><p>Son zamanlarda devamsƒ±zlƒ±k yapan √∂ƒürenci bulunmuyor.</p></div>`;
        }
        
        function renderUpcomingBirthdays() {
            const container = document.getElementById('upcomingBirthdaysList');
            if(!container) return;

            const today = new Date();
            today.setHours(0,0,0,0);
            const upcomingLimit = new Date();
            upcomingLimit.setDate(today.getDate() + 30); // Next 30 days

            let birthdayList = [];
            
            members.forEach(m => {
                // ‚úÖ √ñƒürenci doƒüum g√ºn√º
                if (m.studentBirthDate) {
                    const birthDate = new Date(m.studentBirthDate);
                    let nextBirthday = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());
                    if (nextBirthday < today) {
                        nextBirthday.setFullYear(today.getFullYear() + 1);
                    }
                    if (nextBirthday >= today && nextBirthday <= upcomingLimit) {
                        birthdayList.push({
                            member: m,
                            nextBirthday: nextBirthday,
                            birthDate: m.studentBirthDate,
                            name: m.Resit_Olmayan_Adi_Soyadi || m.Ad_Soyad,
                            type: m.Resit_Olmayan_Adi_Soyadi ? '√ñƒürenci' : '√úye'
                        });
                    }
                }
                
                // ‚úÖ Veli doƒüum g√ºn√º (kayit.html'den gelen Dogum_Tarihi alanƒ±)
                if (m.Dogum_Tarihi && m.Resit_Olmayan_Adi_Soyadi) {
                    // Sadece √ßocuk kaydƒ±ysa veli doƒüum g√ºn√º ekle
                    const birthDate = new Date(m.Dogum_Tarihi);
                    let nextBirthday = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());
                    if (nextBirthday < today) {
                        nextBirthday.setFullYear(today.getFullYear() + 1);
                    }
                    if (nextBirthday >= today && nextBirthday <= upcomingLimit) {
                        birthdayList.push({
                            member: m,
                            nextBirthday: nextBirthday,
                            birthDate: m.Dogum_Tarihi,
                            name: m.Ad_Soyad,
                            studentName: m.Resit_Olmayan_Adi_Soyadi,
                            type: 'Veli'
                        });
                    }
                }
            });

            birthdayList.sort((a, b) => a.nextBirthday - b.nextBirthday);

            if (birthdayList.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>Yakla≈üan doƒüum g√ºn√º bulunmuyor.</p></div>`;
                return;
            }

            container.innerHTML = birthdayList.map(item => {
                const formattedDate = item.nextBirthday.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' });
                const age = calculateAge(item.birthDate) + 1;
                const isToday = item.nextBirthday.getDate() === today.getDate() && item.nextBirthday.getMonth() === today.getMonth();
                const sendButton = isToday ? `<button class="btn btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-left: 10px; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;" onclick="sendBirthdayMessage('${item.member.id}')">üéÇ Mesaj G√∂nder</button>` : '';
                
                // ‚úÖ Veli i√ßin √∂zel badge ve detay
                let typeBadge, nameDisplay;
                if (item.type === 'Veli') {
                    typeBadge = '<span style="background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%); color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 8px;">üë®‚Äçüë©‚Äçüëß VELƒ∞</span>';
                    nameDisplay = `<strong>${item.name}</strong>${typeBadge}<br><small style="color: #888; font-size: 12px;">üë∂ √ñƒürenci: ${item.studentName || 'Belirtilmemi≈ü'}</small>`;
                } else if (item.type === '√ñƒürenci') {
                    typeBadge = '<span style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 8px;">üë∂ √ñƒûRENCƒ∞</span>';
                    nameDisplay = `<strong>${item.name}</strong>${typeBadge}`;
                } else {
                    typeBadge = '<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 8px;">üë§ √úYE</span>';
                    nameDisplay = `<strong>${item.name}</strong>${typeBadge}`;
                }

                return `
                    <div class="birthday-item">
                        <div>
                            ${nameDisplay}${isToday ? ' <span style="color: #667eea; font-weight: bold;">üéÇ BUG√úN!</span>' : ''}<br>
                            <small>${formattedDate} tarihinde ${age}. ya≈üƒ±na girecek.</small>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${sendButton}
                        <div class="birthday-icon">üéâ</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Kayƒ±t Olabilir hatƒ±rlatmalarƒ±nƒ± g√∂ster
        function renderKayitOlabilirReminders() {
            const container = document.getElementById('kayitOlabilirList');
            if (!container) {
                console.log('‚ùå kayitOlabilirList container bulunamadƒ±!');
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const weekLater = new Date(today);
            weekLater.setDate(today.getDate() + 7);
            
            console.log('üìÖ renderKayitOlabilirReminders √ßaƒürƒ±ldƒ±, crmLeads:', crmLeads.length);
            
            // Kayƒ±t Olabilir etiketine sahip ve tarihi yakla≈üan bran≈ülar
            const reminders = [];
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(branchData => {
                        if (branchData.selectedTag === 'Kayƒ±t Olabilir' && branchData.kayitOlabilirDate) {
                            const reminderDate = new Date(branchData.kayitOlabilirDate);
                            if (reminderDate >= today && reminderDate <= weekLater) {
                                reminders.push({
                                    lead,
                                    branchData,
                                    date: reminderDate
                                });
                            }
                        }
                    });
                }
            });
            
            console.log('üìÖ Bulunan Kayƒ±t Olabilir hatƒ±rlatmasƒ±:', reminders.length);
            
            reminders.sort((a, b) => a.date - b.date);
            
            if (reminders.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>Yakla≈üan kayƒ±t hatƒ±rlatmasƒ± yok</p></div>`;
                return;
            }
            
            container.innerHTML = reminders.map(({lead, branchData, date}) => {
                const isToday = date.getDate() === today.getDate() && 
                               date.getMonth() === today.getMonth() && 
                               date.getFullYear() === today.getFullYear();
                
                const formattedDate = date.toLocaleString('tr-TR', {
                    day: 'numeric',
                    month: 'long',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const branch = branches.find(b => b.id === branchData.branchId);
                const branchText = branch ? `${branch.icon} ${branch.name}` : '';
                
                return `
                    <div class="birthday-item" style="cursor: pointer;" onclick="openCustomerDetail('${lead.id}')">
                        <div>
                            <strong>${lead.fullName}</strong>${isToday ? ' <span style="color: #667eea; font-weight: bold;">üìÖ BUG√úN!</span>' : ''}<br>
                            <small>${formattedDate} - ${branchText}</small><br>
                            <small style="color: #666;">üìû ${lead.phone}</small>
                        </div>
                        <div class="birthday-icon">üìû</div>
                    </div>
                `;
            }).join('');
        }
        
        // Denemeye Gelecek hatƒ±rlatmalarƒ±nƒ± g√∂ster
        function renderDenemeGelecekReminders() {
            const container = document.getElementById('denemeGelecekList');
            if (!container) {
                console.log('‚ùå denemeGelecekList container bulunamadƒ±!');
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const weekLater = new Date(today);
            weekLater.setDate(today.getDate() + 7);
            
            console.log('üéæ renderDenemeGelecekReminders √ßaƒürƒ±ldƒ±, crmLeads:', crmLeads.length);
            
            // Denemeye Gelecek etiketine sahip ve tarihi yakla≈üan bran≈ülar
            const reminders = [];
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(branchData => {
                        if (branchData.selectedTag === 'Denemeye Gelecek' && branchData.denemeDate) {
                            const denemeDate = new Date(branchData.denemeDate);
                            if (denemeDate >= today && denemeDate <= weekLater) {
                                reminders.push({
                                    lead,
                                    branchData,
                                    date: denemeDate
                                });
                            }
                        }
                    });
                }
            });
            
            console.log('üéæ Bulunan Denemeye Gelecek hatƒ±rlatmasƒ±:', reminders.length);
            
            reminders.sort((a, b) => a.date - b.date);
            
            if (reminders.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>Yakla≈üan deneme dersi yok</p></div>`;
                return;
            }
            
            container.innerHTML = reminders.map(({lead, branchData, date}) => {
                const isToday = date.getDate() === today.getDate() && 
                               date.getMonth() === today.getMonth() && 
                               date.getFullYear() === today.getFullYear();
                
                const formattedDate = date.toLocaleString('tr-TR', {
                    day: 'numeric',
                    month: 'long',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const branch = branches.find(b => b.id === branchData.branchId);
                const branchText = branch ? `${branch.icon} ${branch.name}` : '';
                
                return `
                    <div class="birthday-item" style="cursor: pointer;" onclick="openCustomerDetail('${lead.id}')">
                        <div>
                            <strong>${lead.fullName}</strong>${isToday ? ' <span style="color: #f093fb; font-weight: bold;">üéæ BUG√úN!</span>' : ''}<br>
                            <small>${formattedDate} - ${branchText}</small><br>
                            <small style="color: #666;">üìû ${lead.phone}</small>
                        </div>
                        <div class="birthday-icon">üéæ</div>
                    </div>
                `;
            }).join('');
        }
        
        function openModal(modalId) { 
            const modal = document.getElementById(modalId);
            modal.style.display = 'block';
            
            // Modal overlay'e tƒ±klama eventi ekle (sadece modal-content dƒ±≈üƒ±)
            modal.onclick = function(event) {
                if (event.target === modal) {
                    closeModal(modalId);
                }
            };
        }
        function openGroupModal() {
            const form = document.getElementById('groupForm');
            form.reset();
            form.groupId.value = ''; // Ensure no old ID is present
            
            // ‚úÖ Bran≈ü dropdown'unu dinamik olarak g√ºncelle
            const branchSelect = form.querySelector('[name="branch"]');
            branchSelect.innerHTML = '<option value="">Se√ßiniz...</option>' + 
                branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
            
            if (selectedBranchForGroups) {
                branchSelect.value = selectedBranchForGroups;
            }
            document.getElementById('groupModalTitle').textContent = '‚ûï Yeni Grup Olu≈ütur';
            openModal('groupModal');
        }
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) {
                modal.style.display = 'none';
                const form = modal.querySelector('form');
                if (form) form.reset();
                
                // addLeadModal kapatƒ±lƒ±rken lastCheckedPhone'u sƒ±fƒ±rla
                if (modalId === 'addLeadModal') {
                    lastCheckedPhone = '';
                    const messageDiv = document.getElementById('phone-check-message');
                    if (messageDiv) messageDiv.innerHTML = '';
                }
            }
        }
        
        function deleteItem(collectionName, id) {
            let itemType = '';
            if (collectionName === 'members') itemType = '√ºyeyi ve ili≈ükili kayƒ±tlarƒ±nƒ±';
            else if (collectionName === 'preRegistrations') itemType = 'kaydƒ± ve ili≈ükili √ºyeyi';
            else if (collectionName === 'groups') itemType = 'grubu (i√ßindeki √ºyeler √ßƒ±karƒ±lacak)';
            else if (collectionName === 'users') itemType = 'kullanƒ±cƒ±yƒ±';
            else if (collectionName === 'tasks') itemType = 'g√∂revi';
            else itemType = '√∂ƒüeyi';
            const text = `Bu ${itemType} kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.`;
            showConfirmModal(text, () => executeDelete(collectionName, id));
        }
        
        async function executeDelete(collectionName, id) {
            closeModal('confirmModal');
            try {
                if (collectionName === 'members') {
                    const memberToDelete = members.find(m => m.id === id);
                    if (memberToDelete) {
                        const group = groups.find(g => g.members && g.members.includes(id));
                        if (group) {
                            await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', group.id), { members: window.firebase.arrayRemove(id) });
                        }
                        if (memberToDelete.preRegistrationId) {
                            await window.firebase.deleteDoc(window.firebase.doc(window.db, 'preRegistrations', memberToDelete.preRegistrationId)).catch(e => {});
                        }
                    }
                } else if (collectionName === 'preRegistrations') {
                    const preRegToDelete = preRegistrations.find(p => p.id === id);
                    if (preRegToDelete) {
                        const memberToDelete = members.find(m => m.preRegistrationId === id || m.Telefon === preRegToDelete.phone);
                        if (memberToDelete) {
                            const group = groups.find(g => g.members && g.members.includes(memberToDelete.id));
                            if (group) {
                                await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', group.id), { members: window.firebase.arrayRemove(memberToDelete.id) });
                            }
                            await window.firebase.deleteDoc(window.firebase.doc(window.db, 'members', memberToDelete.id));
                        }
                    }
                }
                
                await window.firebase.deleteDoc(window.firebase.doc(window.db, collectionName, id));
                
                showAlert('√ñƒüe ve ili≈ükili kayƒ±tlar ba≈üarƒ±yla silindi', 'success');
                await loadData();
            } catch (error) { 
                showAlert('√ñƒüe silinirken hata olu≈ütu', 'danger'); 
                console.error(error); 
            }
        }
        
        function viewMemberPayments(memberId) {
            if (!currentUser.permissions.view_payments) {
                return showAlert('√ñdemeleri g√∂r√ºnt√ºleme yetkiniz yok.', 'warning');
            }
            const member = members.find(m => m.id === memberId);
            const preReg = preRegistrations.find(p => p.id === member.preRegistrationId || p.phone === member.Telefon);
            if (preReg) viewPaymentPlan(preReg.id);
            else showAlert('Bu √ºyeye ait √∂deme planƒ± bulunamadƒ±.', 'warning');
        }

        function viewPaymentPlan(preRegId) {
            const preReg = preRegistrations.find(p => p.id === preRegId);
            if (!preReg) return;
            document.getElementById('paymentPlanTitle').innerHTML = `üìÖ √ñdeme Planƒ± - <strong>${preReg.parentName || preReg.studentName}</strong>`;
            let planHtml = `<div style="background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px;"><p><strong>D√∂nem:</strong> ${formatDate(preReg.periodStart)} - ${formatDate(preReg.periodEnd)}</p></div>`;
            
            // ‚úÖ Yetki kontrol√º ile butonlarƒ± g√∂ster
            if (currentUser.permissions.edit_payments) {
                planHtml += `<div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <button class="btn btn-sm btn-secondary" onclick="selectAllPayments('${preReg.id}', true)">‚úì T√ºm√ºn√º Se√ß</button>
                    <button class="btn btn-sm btn-secondary" onclick="selectAllPayments('${preReg.id}', false)">‚úó Se√ßimi Kaldƒ±r</button>
                    <button class="btn btn-sm btn-success" onclick="markSelectedPaymentsAsPaid('${preReg.id}')">üí∞ Se√ßilenleri √ñdendi Yap</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteSelectedPayments('${preReg.id}')">üóëÔ∏è Se√ßilenleri Sil</button>
                </div>`;
            }
            
            planHtml += renderPaymentDetailsTable(preReg);
            
            if (currentUser.permissions.edit_payments) {
                planHtml += `<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; gap: 10px;">
                    <button class="btn btn-danger" onclick="deleteSelectedPayments('${preReg.id}')">üóëÔ∏è Se√ßilenleri Sil</button>
                    <button class="btn btn-success" onclick="openPaymentEditModal('${preReg.id}', null, true)">‚ûï Yeni Taksit Ekle</button>
                </div>`;
            }
            
            document.getElementById('paymentPlanContent').innerHTML = planHtml;
            openModal('paymentPlanModal');
        }

        function openPaymentEditModal(preRegId, paymentNumber, isNew = false) {
            if (!currentUser.permissions.edit_payments) {
                return showAlert('Bu i≈ülem i√ßin yetkiniz bulunmamaktadƒ±r.', 'warning');
            }
            closeModal('paymentPlanModal');
            const form = document.getElementById('paymentForm');
            form.reset();
            document.getElementById('paymentPeriodInfoStatic').style.display = 'none';

            form.querySelector('button[type="submit"]').style.display = 'block';
            
            const preReg = preRegistrations.find(p => p.id === preRegId);
            if(!preReg) return;

            form.dataset.mode = isNew ? 'new' : 'edit';
            form.paymentPreRegId.value = preRegId;

            // ‚úÖ Ka√ß ay daha aidat eklenecek alanƒ±nƒ± g√∂ster/gizle
            const additionalMonthsField = document.getElementById('additionalMonthsField');
            
            if (isNew) {
                document.getElementById('paymentModalTitle').textContent = `‚ûï Yeni Taksit Ekle`;
                document.getElementById('paymentPeriodInfo').style.display = 'grid';
                additionalMonthsField.style.display = 'block'; // ‚úÖ Yeni aidatta g√∂ster
                form.paymentNumber.value = (preReg.paymentSchedule || []).length + 1;
                form.additionalMonths.value = 0; // Varsayƒ±lan 0
            } else {
                const payment = preReg.paymentSchedule.find(p => p.paymentNumber === paymentNumber);
                if(!payment) return;
                
                document.getElementById('paymentModalTitle').textContent = `‚úèÔ∏è ${paymentNumber}. √ñdemeyi D√ºzenle`;
                document.getElementById('paymentPeriodInfo').style.display = 'grid'; 
                additionalMonthsField.style.display = 'none'; // ‚úÖ D√ºzenlemede gizle

                form.paymentNumber.value = paymentNumber;
                form.paymentDate.value = payment.paymentDate || '';
                form.paymentAmount.value = payment.amount.toLocaleString('tr-TR');
                form.paymentDueDate.value = payment.dueDate;
                form.paymentMethod.value = payment.method || '';
                form.paymentStatus.value = payment.status;
                form.paymentNote.value = payment.note || '';
                form.periodStart.value = payment.period.start;
                form.periodEnd.value = payment.period.end;
                form.lessonCount.value = payment.period.lessonCount;
                
                 const paymentStatusSelect = form.querySelector('[name="paymentStatus"]');
                 const paymentDateInput = form.querySelector('[name="paymentDate"]');
                
                 paymentStatusSelect.onchange = () => {
                    if (paymentStatusSelect.value === 'paid' && !paymentDateInput.value) {
                         paymentDateInput.value = getTodayString();
                    }
                 };
                 paymentStatusSelect.value = payment.status;
            }
            
            openModal('paymentModal');
        }
        
        function renderPaymentDetailsTable(preReg) {
            const paymentSchedule = preReg.paymentSchedule || [];
            if (paymentSchedule.length === 0) return `<p class="empty-state">√ñdeme planƒ± yok.</p>`;
            
            // ‚úÖ Yetki kontrol√º - checkbox kolonunu g√∂ster/gizle
            const hasEditPermission = currentUser.permissions.edit_payments;
            const checkboxHeader = hasEditPermission ? `<th style="width: 40px;"><input type="checkbox" onchange="selectAllPayments('${preReg.id}', this.checked)"></th>` : '';
            const tableHeaders = `<thead><tr>${checkboxHeader}<th>D√∂nem</th><th>Dersler ve Tarih Aralƒ±ƒüƒ±</th><th>Tutar</th><th>Son √ñdeme</th><th>√ñdeme Tarihi</th><th>Durum</th><th style="width: 150px;">ƒ∞≈ülemler</th></tr></thead>`;

            const bodyHtml = paymentSchedule.map(p => {
                const today = new Date();
                today.setHours(0,0,0,0);
                const dueDate = new Date(p.dueDate + 'T00:00:00');
                const isOverdue = dueDate < today && p.status === 'unpaid';
                const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                const isUpcoming = daysUntilDue > 0 && daysUntilDue <= 7 && p.status === 'unpaid';
                const statusClass = isOverdue ? 'overdue' : p.status;
                const lessonCountText = `${p.period.lessonCount} Ders`;
                
                // Build dropdown menu items
                let dropdownItems = [];
                
                // Message button (if unpaid) - t√ºm unpaid √∂demeler i√ßin mesaj g√∂nderilebilsin
                if (p.status === 'unpaid') {
                    if (isOverdue) {
                        dropdownItems.push(`<button onclick="event.stopPropagation(); window.sendPaymentReminderMessage('${preReg.id}', ${p.paymentNumber}, 'overdue')">üí¨ Gecikmi≈ü √ñdeme Mesajƒ±</button>`);
                    } else {
                        // Vadesi gelmeyen √∂demeler i√ßin de "Yakla≈üan √ñdeme" ≈üablonunu kullan
                        dropdownItems.push(`<button onclick="event.stopPropagation(); window.sendPaymentReminderMessage('${preReg.id}', ${p.paymentNumber}, 'upcoming')">üí¨ √ñdeme Hatƒ±rlatmasƒ± G√∂nder</button>`);
                    }
                }
                
                // Edit button (if has permission)
                if(currentUser.permissions.edit_payments){
                    dropdownItems.push(`<button onclick="event.stopPropagation(); window.openPaymentEditModal('${preReg.id}', ${p.paymentNumber})">‚úèÔ∏è D√ºzenle</button>`);
                    dropdownItems.push(`<button class="danger" onclick="event.stopPropagation(); window.deletePaymentFromSchedule('${preReg.id}', ${p.paymentNumber})">üóëÔ∏è Sil</button>`);
                }
                
                const actionsHtml = dropdownItems.length > 0 ? `
                    <div class="actions-dropdown">
                        <button class="actions-dropdown-btn" type="button">
                            ‚öôÔ∏è ƒ∞≈ülemler ‚ñº
                        </button>
                        <div class="actions-dropdown-content">
                            ${dropdownItems.join('')}
                        </div>
                    </div>
                ` : '';

                // ‚úÖ Checkbox kolonunu yetki kontrol√º ile g√∂ster
                const checkboxCell = hasEditPermission ? 
                    `<td><input type="checkbox" class="payment-checkbox" data-prereg-id="${preReg.id}" data-payment-num="${p.paymentNumber}" ${p.status === 'paid' ? 'disabled' : ''}></td>` : '';
                
                return `<tr>
                    ${checkboxCell}
                    <td>${p.paymentNumber}. Aidat</td>
                    <td>${lessonCountText} (${formatDate(p.period.start)} - ${formatDate(p.period.end)})</td>
                    <td>${p.amount.toLocaleString('tr-TR')}‚Ç∫</td>
                    <td>${formatDate(p.dueDate)}</td>
                    <td>${p.paymentDate ? formatDate(p.paymentDate) : '-'}</td>
                    <td><span class="status-badge status-${statusClass}">${getPaymentStatusText(statusClass)}</span></td>
                    <td class="actions-cell">${actionsHtml}</td>
                </tr>`;
            }).join('');

            return `<div class="table-container"><table class="data-table">${tableHeaders}<tbody>${bodyHtml}</tbody></table></div>`;
        }
        
        function selectAllPayments(preRegId, checked) {
            const checkboxes = document.querySelectorAll(`.payment-checkbox[data-prereg-id="${preRegId}"]`);
            checkboxes.forEach(cb => {
                if (!cb.disabled) cb.checked = checked;
            });
        }
        
        async function markSelectedPaymentsAsPaid(preRegId) {
            const selectedCheckboxes = Array.from(document.querySelectorAll(`.payment-checkbox[data-prereg-id="${preRegId}"]:checked`));
            if (selectedCheckboxes.length === 0) {
                return showAlert('L√ºtfen en az bir √∂deme se√ßin.', 'warning');
            }
            
            const paymentNumbers = selectedCheckboxes.map(cb => parseInt(cb.dataset.paymentNum));
            const preReg = preRegistrations.find(p => p.id === preRegId);
            if (!preReg) return showAlert('√ñn kayƒ±t bulunamadƒ±.', 'danger');
            
            const todayString = getTodayString();
            const updatedSchedule = preReg.paymentSchedule.map(p => {
                if (paymentNumbers.includes(p.paymentNumber) && p.status !== 'paid') {
                    return { ...p, status: 'paid', paymentDate: todayString };
                }
                return p;
            });
            
            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'preRegistrations', preRegId), { paymentSchedule: updatedSchedule });
                showAlert('Se√ßili √∂demeler √∂dendi olarak i≈üaretlendi.', 'success');
                await loadData();
                viewPaymentPlan(preRegId); // Refresh
            } catch (error) {
                console.error('Error marking payments as paid:', error);
                showAlert('√ñdemeler g√ºncellenirken hata olu≈ütu.', 'danger');
            }
        }
        
        async function deleteSelectedPayments(preRegId) {
            const selectedCheckboxes = Array.from(document.querySelectorAll(`.payment-checkbox[data-prereg-id="${preRegId}"]:checked`));
            if (selectedCheckboxes.length === 0) {
                return showAlert('L√ºtfen en az bir √∂deme se√ßin.', 'warning');
            }
            
            const paymentNumbers = selectedCheckboxes.map(cb => parseInt(cb.dataset.paymentNum));
            
            if (!confirm(`Se√ßili ${paymentNumbers.length} √∂deme kalƒ±cƒ± olarak silinecek. Emin misiniz?`)) {
                return;
            }
            
            const preReg = preRegistrations.find(p => p.id === preRegId);
            if (!preReg) return showAlert('√ñn kayƒ±t bulunamadƒ±.', 'danger');
            
            // Filter out selected payments
            const updatedSchedule = preReg.paymentSchedule.filter(p => !paymentNumbers.includes(p.paymentNumber));
            
            // Renumber remaining payments
            updatedSchedule.forEach((p, index) => {
                p.paymentNumber = index + 1;
            });
            
            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'preRegistrations', preRegId), { paymentSchedule: updatedSchedule });
                showAlert('Se√ßili √∂demeler silindi.', 'success');
                await loadData();
                viewPaymentPlan(preRegId); // Refresh
            } catch (error) {
                console.error('Error deleting payments:', error);
                showAlert('√ñdemeler silinirken hata olu≈ütu.', 'danger');
            }
        }
        
        // --- HELPER FUNCTIONS ---
        function timeToMinutes(timeStr) {
            if (!timeStr || !timeStr.includes(':')) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTime(totalMinutes) {
            const hours = Math.floor(totalMinutes / 60).toString().padStart(2, '0');
            const mins = (totalMinutes % 60).toString().padStart(2, '0');
            return `${hours}:${mins}`;
        }

        function capitalize(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

         function capitalizeWords(str) {
            if (!str) return '';
            return str.toLowerCase().replace(/(?:^|\s)\S/g, function(a) { return a.toUpperCase(); });
        }


        function calculateAge(birthDateString) {
            if (!birthDateString) return null;
            const birthDate = new Date(birthDateString);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function generatePaymentSchedule(firstStart, firstEnd, firstDueDate, totalInstallments, firstAmount, subsequentAmount, dueDay, firstLessonCount) {
            const payments = [];
            
            payments.push({
                paymentNumber: 1,
                dueDate: new Date(firstDueDate).toISOString().split('T')[0],
                amount: firstAmount,
                status: 'unpaid',
                period: {
                    start: new Date(firstStart).toISOString().split('T')[0],
                    end: new Date(firstEnd).toISOString().split('T')[0],
                    lessonCount: firstLessonCount
                }
            });

            let lastPeriodEnd = new Date(firstEnd);
            let referenceDueDate = new Date(firstDueDate);
            referenceDueDate.setHours(12,0,0,0);

            for (let i = 2; i <= totalInstallments; i++) {
                const newPeriodStart = new Date(lastPeriodEnd);
                newPeriodStart.setDate(newPeriodStart.getDate() + 1);

                const newPeriodEnd = new Date(newPeriodStart);
                newPeriodEnd.setDate(newPeriodEnd.getDate() + 27); // approx 4 weeks
                
                referenceDueDate.setMonth(referenceDueDate.getMonth() + 1);
                let nextDueDate = new Date(referenceDueDate.getFullYear(), referenceDueDate.getMonth(), dueDay, 12, 0, 0);

                payments.push({
                    paymentNumber: i,
                    dueDate: nextDueDate.toISOString().split('T')[0],
                    amount: subsequentAmount,
                    status: 'unpaid',
                    period: {
                        start: newPeriodStart.toISOString().split('T')[0],
                        end: newPeriodEnd.toISOString().split('T')[0],
                        lessonCount: 8 // Assuming subsequent periods are 8 lessons
                    }
                });
                
                lastPeriodEnd = newPeriodEnd;
            }
            return payments;
        }
        
        function autoCalculateLessonCount(form) {
            const start = form.querySelector('[name=firstPeriodStart]').value;
            const end = form.querySelector('[name=firstPeriodEnd]').value;
            const lessonCountInput = form.querySelector('[name=firstLessonCount]');
            if (start && end) {
                const startDate = new Date(start);
                const endDate = new Date(end);
                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                const weeks = Math.round(diffDays / 7);
                lessonCountInput.value = weeks * 2; // Assuming 2 lessons per week
                previewPaymentPlan(form);
            }
        }

        function previewPaymentPlan(form) {
            const data = Object.fromEntries(new FormData(form).entries());
            const previewContainer = form.querySelector('.payment-plan-preview');
            
            if(!data.firstPeriodStart || !data.firstPeriodEnd || !data.firstInstallmentAmount || !data.firstDueDate || !data.installments || !data.subsequentInstallmentAmount || !data.firstLessonCount) {
                previewContainer.innerHTML = ''; 
                return;
            }

            const totalInstallments = parseInt(data.installments) + 1;
            const firstAmount = parseFloat(unformatCurrency(data.firstInstallmentAmount) || '0');
            const subsequentAmount = parseFloat(unformatCurrency(data.subsequentInstallmentAmount) || '0');
            const paymentSchedule = generatePaymentSchedule(
                new Date(data.firstPeriodStart), new Date(data.firstPeriodEnd), new Date(data.firstDueDate),
                totalInstallments, firstAmount, subsequentAmount, parseInt(data.dueDay), parseInt(data.firstLessonCount)
            );
            
            previewContainer.innerHTML = `<h4>√ñdeme Planƒ± √ñnizlemesi</h4>` + renderPaymentDetailsTable({paymentSchedule: paymentSchedule}, true);
        }

        function formatCurrency(input) {
            let value = input.value.replace(/\D/g, ''); // Remove non-digits
            if(value) {
                input.value = new Intl.NumberFormat('tr-TR').format(value);
            } else {
                input.value = '';
            }
        }
        function unformatCurrency(value) {
            return value.replace(/\./g, '');
        }
        
        function setPaymentFilter(filter, element) {
            paymentFilter = filter;
            document.querySelectorAll('#payments .btn-group .btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            renderPaymentsList();
        }
        
        function navigateToSection(sectionId) {
            const button = document.querySelector(`.nav-btn[onclick*="'${sectionId}'"]`);
            if (button) button.click();
        }

        function getStatusText(status) {
            const statuses = { pending: 'Bekliyor', active: 'Aktif', completed: 'Tamamlandƒ±', expired: 'Pasif' };
            return statuses[status] || 'Bilinmiyor';
        }
        function getPaymentStatusText(status) {
            const statuses = { paid: '√ñdendi', unpaid: '√ñdenmedi', overdue: 'Gecikmi≈ü' };
            return statuses[status] || 'Bilinmiyor';
        }
        function formatDate(dateString) {
            if (!dateString) return '';
            // ISO strings (like from toISOString()) can be parsed directly.
            // YYYY-MM-DD strings might be interpreted as UTC, so we help it by adding time.
            if (dateString.length === 10 && dateString.includes('-')) {
                return new Date(dateString + 'T00:00:00').toLocaleDateString('tr-TR');
            }
            return new Date(dateString).toLocaleDateString('tr-TR');
        }
        function getTodayString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function closeAlert() {
            if (window.currentAlertModal && document.body.contains(window.currentAlertModal)) {
                document.body.removeChild(window.currentAlertModal);
                window.currentAlertModal = null;
            }
        }
        
        window.closeAlert = closeAlert;
        
        function showAlert(message, type = 'info') {
            // Check if message contains HTML (for modals)
            const isModal = message.includes('<form') || message.includes('<div style');
            
            if (isModal) {
                // Create modal overlay
                const modalOverlay = document.createElement('div');
                modalOverlay.style.cssText = `
                    position: fixed; 
                    top: 0; 
                    left: 0; 
                    width: 100%; 
                    height: 100%; 
                    background: rgba(0,0,0,0.5); 
                    z-index: 2000; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center;
                    overflow-y: auto;
                    padding: 20px;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.innerHTML = message;
                modalContent.style.cssText = `
                    background: white; 
                    border-radius: 12px; 
                    box-shadow: 0 10px 40px rgba(0,0,0,0.3); 
                    max-width: 600px; 
                    width: 100%; 
                    max-height: 90vh;
                    overflow-y: auto;
                    position: relative;
                `;
                
                modalOverlay.appendChild(modalContent);
                document.body.appendChild(modalOverlay);
                
                // Close on overlay click
                modalOverlay.addEventListener('click', (e) => {
                    if (e.target === modalOverlay) {
                        document.body.removeChild(modalOverlay);
                        window.currentAlertModal = null;
                    }
                });
                
                // Store reference for closeAlert
                window.currentAlertModal = modalOverlay;
                
                return;
            }
            
            // Regular alert notification
            const alertContainer = document.createElement('div');
            alertContainer.innerHTML = message.replace(/\n/g, '<br>');
            alertContainer.style.cssText = `position: fixed; top: 20px; right: 20px; z-index: 2000; padding: 15px; border-radius: 8px; color: white; background-color: ${type === 'success' ? 'var(--success-color)' : type === 'danger' ? 'var(--danger-color)' : 'var(--info-color)'}; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: opacity 0.5s ease; opacity: 1; max-width: 400px;`;
            document.body.appendChild(alertContainer);
            setTimeout(() => {
                alertContainer.style.opacity = '0';
                setTimeout(() => { 
                    if(document.body.contains(alertContainer)) {
                        document.body.removeChild(alertContainer)
                    }
                }, 500);
            }, 6000);
        }

        function toggleParentStudentFields(form) {
            const type = form.querySelector('[name="memberType"]').value;
            const phone1Label = form.querySelector('label[for="preRegPhonePre"]');

            const parentName1Group = document.getElementById('parentName1Group');
            const phone1Group = document.getElementById('phone1Group');
            const parentName2Group = document.getElementById('parentName2Group');
            const phone2Group = document.getElementById('phone2Group');
            const studentsContainer = document.getElementById('studentsContainer');
            const singleStudentContainer = document.getElementById('singleStudentContainer');

            if (type === 'adult') {
                phone1Label.textContent = 'Telefon *';
                
                [parentName1Group, parentName2Group, phone2Group].forEach(el => el.style.display = 'none');
                [parentName1Group, parentName2Group, phone2Group].forEach(el => el.querySelector('input').required = false);
                
                // Tek √∂ƒürenci alanƒ±nƒ± g√∂ster
                studentsContainer.style.display = 'none';
                // ‚úÖ Gizli √ßoklu √∂ƒürenci alanlarƒ±nƒ±n required'ƒ±nƒ± kaldƒ±r
                studentsContainer.querySelectorAll('.student-name').forEach(input => input.required = false);
                
                singleStudentContainer.style.display = 'block';
                document.getElementById('studentNamePre').required = true;
                document.getElementById('studentBirthDatePre').required = false;
                
            } else { // child
                phone1Label.textContent = 'Veli Telefon *';
                
                [parentName1Group, parentName2Group, phone2Group].forEach(el => el.style.display = 'flex');
                parentName1Group.querySelector('input').required = true;
                
                // √áoklu √∂ƒürenci alanlarƒ±nƒ± g√∂ster
                studentsContainer.style.display = 'block';
                // ‚úÖ G√∂r√ºn√ºr √ßoklu √∂ƒürenci alanlarƒ±nƒ±n required'ƒ±nƒ± geri ekle
                studentsContainer.querySelectorAll('.student-name').forEach(input => input.required = true);
                
                singleStudentContainer.style.display = 'none';
                document.getElementById('studentNamePre').required = false;
                document.getElementById('studentBirthDatePre').required = false;
            }
        }
        
        // √ñƒürenci alanƒ± ekle
        window.addStudentField = function() {
            const container = document.getElementById('studentFieldsContainer');
            const studentCount = container.querySelectorAll('.student-field-group').length;
            
            const newStudentField = document.createElement('div');
            newStudentField.className = 'student-field-group';
            newStudentField.setAttribute('data-student-index', studentCount);
            
            const borderColors = ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#F44336'];
            const borderColor = borderColors[studentCount % borderColors.length];
            
            const today = getTodayString();
            
            newStudentField.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; position: relative; border-left: 4px solid ${borderColor};">
                    <h5 style="margin: 0 0 15px 0; color: #333;">√ñƒürenci ${studentCount + 1}</h5>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeStudentField(${studentCount})" style="position: absolute; top: 10px; right: 10px;">üóëÔ∏è</button>
                    <div class="form-grid">
                        <div class="form-group"><label>Ad Soyad *</label><input type="text" class="form-control student-name" name="studentName_${studentCount}" required></div>
                        <div class="form-group"><label>Doƒüum Tarihi</label><input type="date" class="form-control student-birthdate" name="studentBirthDate_${studentCount}" max="${today}"></div>
                    </div>
                </div>
            `;
            container.appendChild(newStudentField);
        };
        
        // √ñƒürenci alanƒ±nƒ± kaldƒ±r
        window.removeStudentField = function(index) {
            const container = document.getElementById('studentFieldsContainer');
            const studentGroups = container.querySelectorAll('.student-field-group');
            
            if (studentGroups.length <= 1) {
                showAlert('En az bir √∂ƒürenci olmalƒ±dƒ±r.', 'warning');
                return;
            }
            
            const fieldToRemove = container.querySelector(`[data-student-index="${index}"]`);
            if (fieldToRemove) {
                fieldToRemove.remove();
            }
        };
        
        function toggleParentStudentFieldsForEdit(form, isAdult) {
            const parentNameGroup = form.querySelector('[name="parentName"]').parentElement;
            const studentNameLabel = form.querySelector('label[for="studentName"]');

            if (isAdult) {
                if(studentNameLabel) studentNameLabel.textContent = 'Ad Soyad *';
                if(parentNameGroup) parentNameGroup.style.display = 'none';
                if(parentNameGroup) parentNameGroup.querySelector('input').required = false;
            } else {
                if(studentNameLabel) studentNameLabel.textContent = '√ñƒürenci Ad Soyad *';
                if(parentNameGroup) parentNameGroup.style.display = 'flex';
                if(parentNameGroup) parentNameGroup.querySelector('input').required = true;
            }
        }


        function filterGroupsByBranch(branch, element) {
            selectedBranchForGroups = branch;
            document.querySelectorAll('#group-branch-filter .btn').forEach(b => b.classList.remove('active'));
            if (element) element.classList.add('active');
            document.getElementById('newGroupBtn').style.display = 'inline-flex';
            renderGroupsList();
        }

        function filterScheduleByBranch(branch, element) {
            selectedBranchForSchedule = branch;
            document.querySelectorAll('#schedule-branch-filter .btn').forEach(b => b.classList.remove('active'));
            if (element) element.classList.add('active');
            renderScheduleGrid();
        }

        function showConfirmModal(text, onConfirm) {
             const confirmModal = document.getElementById('confirmModal');
             document.getElementById('confirmText').textContent = text;
             const confirmYesBtn = document.getElementById('confirmYesBtn');
             
             const newYesBtn = confirmYesBtn.cloneNode(true);
             newYesBtn.textContent = 'Evet, Onayla';
             confirmYesBtn.parentNode.replaceChild(newYesBtn, confirmYesBtn);
             
             newYesBtn.onclick = onConfirm;
             openModal('confirmModal');
        }

        function sortMembersByAge() {
            if (ageSortDirection === 'none') {
                ageSortDirection = 'asc';
            } else if (ageSortDirection === 'asc') {
                ageSortDirection = 'desc';
            } else {
                ageSortDirection = 'none';
            }
            renderMembersTable();
        }
        
        function editReason(cellElement, recordId) {
            const currentReason = cellElement.textContent === 'Sebep Ekle' ? '' : cellElement.textContent;
            cellElement.innerHTML = `<input type="text" class="form-control" value="${currentReason}" onblur="saveReason('${recordId}', this.value, this.parentElement)" onkeypress="if(event.key === 'Enter') this.blur()" autofocus>`;
            cellElement.querySelector('input').focus();
            cellElement.onclick = null; // Prevent re-triggering while editing
        }

        // √úye detayƒ±nƒ± gizle ve listeye d√∂n
        window.hideMemberDetail = function() {
            const contentDiv = document.getElementById('member-detail-content');
            const memberListCard = document.getElementById('members-list-card');
            if (contentDiv) contentDiv.style.display = 'none';
            if (memberListCard) memberListCard.style.display = 'block';
        };
        
        // ‚úÖ Sidebar dropdown toggle
        window.toggleDropdown = function(button) {
            button.classList.toggle('open');
            const dropdown = button.nextElementSibling;
            if (dropdown && dropdown.classList.contains('dropdown-content')) {
                dropdown.classList.toggle('show');
            }
        };
        
        function generatePeriodBasedAttendance(member, preReg, attendanceRecords) {
            if (!preReg || !preReg.paymentSchedule || preReg.paymentSchedule.length === 0) {
                // Aidat d√∂nemi yoksa eski g√∂r√ºn√ºm√º g√∂ster
                return `
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Grup</th>
                                    <th>Durum</th>
                                    <th>Devamsƒ±zlƒ±k Sebebi</th>
                                    <th>ƒ∞≈ülemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${attendanceRecords.length === 0 ? `<tr><td colspan="5" class="empty-state">Bu √ºye i√ßin yoklama kaydƒ± bulunmuyor.</td></tr>` : 
                                attendanceRecords.map(record => {
                                    const group = groups.find(g => g.id === record.groupId);
                                    const statusClass = record.status === 'present' ? 'status-present' : 'status-absent';
                                    const statusText = record.status === 'present' ? 'Katƒ±ldƒ±' : 'Katƒ±lmadƒ±';
                                    const recordDate = new Date(record.date + 'T00:00:00');
                                    const formattedDate = recordDate.toLocaleDateString('tr-TR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                                    const reasonCell = record.status === 'absent'
                                        ? `<td class="editable-reason" onclick="editReason(this, '${record.id}')">${record.reason || '<i>Sebep Ekle</i>'}</td>`
                                        : `<td>-</td>`;
                                    const statusCell = `<td onclick="toggleAttendanceStatus('${record.id}', '${record.status}')" style="cursor:pointer;"><span class="status-badge ${statusClass}">${statusText}</span></td>`;
                                    return `
                                        <tr>
                                            <td class="editable-date">
                                                <span>${formattedDate}</span>
                                                <button class="btn-icon" onclick="editAttendanceDate(this, '${record.id}')">‚úèÔ∏è</button>
                                            </td>
                                            <td>${group ? group.groupName : 'Bilinmiyor'}</td>
                                            ${statusCell}
                                            ${reasonCell}
                                            <td>
                                                <button class="btn-icon danger" onclick="deleteAttendanceRecord('${record.id}')">üóëÔ∏è</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // D√∂nemler i√ßin HTML olu≈ütur
            let periodsHtml = '';
            
            preReg.paymentSchedule.forEach((period, index) => {
                const periodStart = new Date(period.period.start + 'T00:00:00');
                const periodEnd = new Date(period.period.end + 'T00:00:00');
                const lessonCount = period.period.lessonCount || 'N/A';
                
                // Bu d√∂neme ait devamsƒ±zlƒ±k kayƒ±tlarƒ±nƒ± filtrele
                const periodAttendance = attendanceRecords.filter(record => {
                    const recordDate = new Date(record.date + 'T00:00:00');
                    return recordDate >= periodStart && recordDate <= periodEnd;
                }).sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const presentCount = periodAttendance.filter(r => r.status === 'present').length;
                const absentCount = periodAttendance.filter(r => r.status === 'absent').length;
                const attendanceRate = periodAttendance.length > 0 ? ((presentCount / periodAttendance.length) * 100).toFixed(0) : 0;
                
                periodsHtml += `
                    <div class="period-card" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 5px solid var(--primary-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h3 style="margin: 0; color: var(--primary-color); font-size: 1.3em;">
                                    üìÖ ${period.paymentNumber}. D√∂nem
                                </h3>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 0.95em;">
                                    ${formatDate(period.period.start)} - ${formatDate(period.period.end)} 
                                    <span style="background: #e3f2fd; padding: 3px 10px; border-radius: 15px; margin-left: 10px; font-weight: bold;">
                                        ${lessonCount} Ders
                                    </span>
                                </p>
                            </div>
                            <div style="text-align: right;">
                                <div style="display: flex; gap: 15px; align-items: center;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.5em; font-weight: bold; color: var(--success-color);">${presentCount}</div>
                                        <div style="font-size: 0.8em; color: #666;">Katƒ±ldƒ±</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.5em; font-weight: bold; color: var(--danger-color);">${absentCount}</div>
                                        <div style="font-size: 0.8em; color: #666;">Katƒ±lmadƒ±</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.5em; font-weight: bold; color: var(--info-color);">${attendanceRate}%</div>
                                        <div style="font-size: 0.8em; color: #666;">Oran</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${periodAttendance.length === 0 ? 
                            `<div style="text-align: center; padding: 30px; color: #999; background: white; border-radius: 8px;">
                                <p style="margin: 0; font-size: 1.1em;">üìù Bu d√∂nem i√ßin hen√ºz yoklama kaydƒ± bulunmuyor.</p>
                            </div>` 
                            : 
                            `<div class="table-container">
                                <table class="data-table" style="background: white;">
                                    <thead>
                                        <tr>
                                            <th>Tarih</th>
                                            <th>Grup</th>
                                            <th>Durum</th>
                                            <th>Devamsƒ±zlƒ±k Sebebi</th>
                                            <th>ƒ∞≈ülemler</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${periodAttendance.map(record => {
                                            const group = groups.find(g => g.id === record.groupId);
                                            const statusClass = record.status === 'present' ? 'status-present' : 'status-absent';
                                            const statusText = record.status === 'present' ? '‚úÖ Katƒ±ldƒ±' : '‚ùå Katƒ±lmadƒ±';
                                            const recordDate = new Date(record.date + 'T00:00:00');
                                            const formattedDate = recordDate.toLocaleDateString('tr-TR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                                            const reasonCell = record.status === 'absent'
                                                ? `<td class="editable-reason" onclick="editReason(this, '${record.id}')">${record.reason || '<i style="color:#999;">Sebep Ekle</i>'}</td>`
                                                : `<td style="color:#999;">-</td>`;
                                            const statusCell = `<td onclick="toggleAttendanceStatus('${record.id}', '${record.status}')" style="cursor:pointer;"><span class="status-badge ${statusClass}">${statusText}</span></td>`;
                                            return `
                                                <tr>
                                                    <td class="editable-date">
                                                        <span>${formattedDate}</span>
                                                        <button class="btn-icon" onclick="editAttendanceDate(this, '${record.id}')">‚úèÔ∏è</button>
                                                    </td>
                                                    <td>${group ? group.groupName : 'Bilinmiyor'}</td>
                                                    ${statusCell}
                                                    ${reasonCell}
                                                    <td>
                                                        <button class="btn-icon danger" onclick="deleteAttendanceRecord('${record.id}')">üóëÔ∏è</button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>`
                        }
                    </div>
                `;
            });
            
            if (periodsHtml === '') {
                return '<div class="empty-state"><p>Aidat d√∂nemi bilgisi bulunamadƒ±.</p></div>';
            }
            
            return periodsHtml;
        }

        async function showMemberAttendancePage(memberId) {
            showSection('members');
            const contentDiv = document.getElementById('member-detail-content');
            if (!contentDiv) {
                console.error('member-detail-content not found');
                return;
            }
            
            // √úye listesini gizle, detayƒ± g√∂ster
            const memberListCard = document.getElementById('members-list-card');
            if (memberListCard) memberListCard.style.display = 'none';
            contentDiv.style.display = 'block';
            contentDiv.innerHTML = `<div class="loading"><div class="spinner"></div><span>√úye verileri y√ºkleniyor...</span></div>`;

            const member = members.find(m => m.id === memberId);
            if (!member) {
                contentDiv.innerHTML = `<div class="card empty-state"><h3>Hata: √úye bulunamadƒ±.</h3></div>`;
                return;
            }
            
            const memberGroups = groups.filter(g => g.members && g.members.includes(member.id));
            const memberName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad;
            
            // Update header to show member name
            const headerTitle = document.getElementById('header-title-members');
            if (headerTitle) headerTitle.textContent = `üë§ ${memberName}`;
            
            // Debug: Attendance kayƒ±tlarƒ±nƒ± kontrol et
            console.log('üîç Attendance Debug:', {
                memberId: memberId,
                totalAttendanceRecords: attendanceRecords.length,
                memberAttendanceRecords: attendanceRecords.filter(r => r.memberId === memberId).length
            });
            
            const memberAttendanceRecords = attendanceRecords.filter(r => r.memberId === memberId).sort((a, b) => new Date(b.date) - new Date(a.date));

            const totalRecords = memberAttendanceRecords.length;
            const presentCount = memberAttendanceRecords.filter(r => r.status === 'present').length;
            const absentCount = totalRecords - presentCount;
            const attendanceRate = totalRecords > 0 ? ((presentCount / totalRecords) * 100).toFixed(1) : 0;
            const birthDate = member.studentBirthDate ? formatDate(member.studentBirthDate) : 'Belirtilmemi≈ü';
            
            // ‚úÖ √úyenin aidat bilgilerini al - sadece "T√ºm √ñdeme Planƒ±nƒ± G√∂r" butonu i√ßin kontrol
            const preReg = preRegistrations.find(p => p.id === member.preRegistrationId || p.phone === member.Telefon);
            let paymentInfoHtml = '';
            
            if (preReg && preReg.paymentSchedule && preReg.paymentSchedule.length > 0) {
                paymentInfoHtml = `
                    <div class="card" style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 class="card-title" style="margin: 0;">üí∞ √ñdeme Takvimi</h2>
                            <button class="btn btn-primary" onclick="event.stopPropagation(); window.viewPaymentPlan('${preReg.id}')">
                                üìã T√ºm √ñdeme Planƒ±nƒ± G√∂r
                            </button>
                        </div>
                    </div>
                `;
            }
            
            let memberInfoHtml = '';
            const isChild = member.Resit_Olmayan_Adi_Soyadi && member.Resit_Olmayan_Adi_Soyadi.trim() !== '';

            if (isChild) {
                let veli2Html = '';
                if(member.Veli_2_Adi_Soyadi || member.Telefon_2) {
                    veli2Html = `
                        <div class="contact-card">
                            <div class="contact-card-header">Veli 2</div>
                            <div class="contact-card-body">
                                ${member.Veli_2_Adi_Soyadi ? `<p><strong>ƒ∞sim:</strong> <span>${member.Veli_2_Adi_Soyadi}</span></p>` : ''}
                                ${member.Telefon_2 ? `<p><strong>Telefon:</strong> <span>${formatPhoneDisplay(member.Telefon_2)}</span></p>` : ''}
                            </div>
                        </div>`;
                }

                memberInfoHtml = `
                <div class="member-info-container">
                    <div class="member-info-main">
                        <div class="detail-item"><strong>√úye Adƒ± Soyadƒ±:</strong> <span>${memberName}</span></div>
                        <div class="detail-item"><strong>Doƒüum Tarihi:</strong> <span>${birthDate}</span></div>
                        <div class="detail-item"><strong>Bran≈ü:</strong> <span>${capitalize(member.Brans || 'Bilinmiyor')}</span></div>
                        <div class="detail-item"><strong>Gruplar:</strong> <span>${memberGroups.length > 0 ? memberGroups.map(g => g.groupName).join(', ') : 'Atanmamƒ±≈ü'}</span></div>
                    </div>
                    <div class="member-info-contact">
                        <h4>Veli Bilgileri</h4>
                        <div class="contact-card">
                            <div class="contact-card-header">Veli 1</div>
                            <div class="contact-card-body">
                                <p><strong>ƒ∞sim:</strong> <span>${member.Ad_Soyad || 'Belirtilmemi≈ü'}</span></p>
                                <p><strong>Telefon:</strong> <span>${member.Telefon ? formatPhoneDisplay(member.Telefon) : 'Belirtilmemi≈ü'}</span></p>
                            </div>
                        </div>
                        ${veli2Html}
                    </div>
                </div>
                `;
            } else { // Adult member
                 memberInfoHtml = `
                    <div class="member-details-grid">
                        <div class="detail-item"><strong>√úye Adƒ± Soyadƒ±:</strong> <span>${memberName}</span></div>
                        <div class="detail-item"><strong>Telefon:</strong> <span>${member.Telefon ? formatPhoneDisplay(member.Telefon) : 'Belirtilmemi≈ü'}</span></div>
                        <div class="detail-item"><strong>Doƒüum Tarihi:</strong> <span>${birthDate}</span></div>
                        <div class="detail-item"><strong>Bran≈ü:</strong> <span>${capitalize(member.Brans || 'Bilinmiyor')}</span></div>
                        <div class="detail-item"><strong>Gruplar:</strong> <span>${memberGroups.length > 0 ? memberGroups.map(g => g.groupName).join(', ') : 'Atanmamƒ±≈ü'}</span></div>
                    </div>
                 `;
            }


            const detailsHtml = `
                <button class="btn btn-secondary" onclick="hideMemberDetail()" style="margin-bottom: 15px;">
                    ‚Üê √úye Listesine D√∂n
                </button>
                
                <div class="card">
                    <h2 class="card-title">√úye Bilgileri</h2>
                    ${memberInfoHtml}
                </div>

                ${paymentInfoHtml}

                <div class="stats-grid" style="margin-top: 20px;">
                    <div class="stat-card">
                        <div class="stat-number">${totalRecords}</div>
                        <div class="stat-label">Toplam Ders</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--success-color);">
                        <div class="stat-number" style="color: var(--success-color);">${presentCount}</div>
                        <div class="stat-label">Katƒ±ldƒ±ƒüƒ± Ders</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--danger-color);">
                        <div class="stat-number" style="color: var(--danger-color);">${absentCount}</div>
                        <div class="stat-label">Katƒ±lmadƒ±ƒüƒ± Ders</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--info-color);">
                        <div class="stat-number" style="color: var(--info-color);">${attendanceRate}%</div>
                        <div class="stat-label">Katƒ±lƒ±m Oranƒ±</div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">Yoklama Ge√ßmi≈üi (D√∂nem D√∂nem)</h2>
                    ${generatePeriodBasedAttendance(member, preReg, memberAttendanceRecords)}
                </div>

                <div class="card">
                    <h2 class="card-title">üìû G√∂r√º≈üme Kayƒ±tlarƒ±</h2>
                    <div id="member-call-records-${memberId}">
                        <div class="loading"><div class="spinner"></div><span>G√∂r√º≈üme kayƒ±tlarƒ± y√ºkleniyor...</span></div>
                    </div>
                </div>
            `;
            
            contentDiv.innerHTML = detailsHtml;
            
            // G√∂r√º≈üme kayƒ±tlarƒ±nƒ± y√ºkle
            const phoneNumber = member.Telefon || member.Telefon_2;
            if (phoneNumber) {
                await renderCallRecords(phoneNumber, `member-call-records-${memberId}`);
            } else {
                const callRecordsContainer = document.getElementById(`member-call-records-${memberId}`);
                if (callRecordsContainer) {
                    callRecordsContainer.innerHTML = '<p style="color: #999; padding: 15px;">Bu √ºye i√ßin telefon numarasƒ± bulunamadƒ±.</p>';
                }
            }
        }

        async function toggleAttendanceStatus(recordId, currentStatus) {
            const newStatus = currentStatus === 'present' ? 'absent' : 'present';
            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'attendance', recordId), { status: newStatus });
                
                const recordIndex = attendanceRecords.findIndex(rec => rec.id === recordId);
                if (recordIndex > -1) {
                    attendanceRecords[recordIndex].status = newStatus;
                     // Refresh the view for the specific member
                    showMemberAttendancePage(attendanceRecords[recordIndex].memberId);
                }
                showAlert('Yoklama durumu g√ºncellendi.', 'success');
            } catch (error) {
                 console.error("Error toggling attendance status:", error);
                 showAlert('Durum g√ºncellenirken bir hata olu≈ütu.', 'danger');
            }
        }
        
         function editAttendanceDate(buttonEl, recordId) {
            const dateCell = buttonEl.closest('.editable-date');
            const record = attendanceRecords.find(r => r.id === recordId);
            if (!record) return;

            dateCell.innerHTML = `<input type="date" class="form-control" value="${record.date}" onblur="saveAttendanceDate(this, '${record.id}')" onkeypress="if(event.key === 'Enter') this.blur()" autofocus>`;
            dateCell.querySelector('input').focus();
        }

        async function saveAttendanceDate(inputEl, recordId) {
            const newDate = inputEl.value;
            const record = attendanceRecords.find(r => r.id === recordId);
            if (!record || !newDate) {
                if(record) showMemberAttendancePage(record.memberId); // Re-render to cancel edit
                return;
            }

            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'attendance', recordId), { date: newDate });
                
                record.date = newDate; // Update local data
                
                showAlert('Yoklama tarihi g√ºncellendi.', 'success');
                showMemberAttendancePage(record.memberId); // Refresh view
            } catch (error) {
                console.error("Error updating attendance date:", error);
                showAlert('Tarih g√ºncellenirken bir hata olu≈ütu.', 'danger');
                if(record) showMemberAttendancePage(record.memberId); // Re-render on error
            }
        }

        function toggleActionsMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('context-menu');
            const button = event.currentTarget;
            const type = button.dataset.type;
            const memberId = button.dataset.memberId;
            const preRegId = button.dataset.preregId;

            if (type === 'prereg' && !preRegId) {
                return showAlert('Bu kaydƒ±n ili≈ükili √∂n kayƒ±t verisi bulunamadƒ±. L√ºtfen kontrol ediniz.', 'danger');
            }

            const isAlreadyOpen = menu.classList.contains('active');
            const currentActiveId = menu.dataset.activeButtonId;
            const newId = memberId || preRegId;

            // First, always hide the menu to simplify logic
            menu.classList.remove('active');

            // If we clicked the same button that the menu was open for, we're done.
            if (isAlreadyOpen && currentActiveId === newId) {
                return;
            }

            // --- Populate Menu Content ---
            let menuHtml = '';
            if (type === 'prereg') {
                let paymentLink = '';
                if (currentUser.permissions.view_payments) {
                    paymentLink = `<a href="#" onclick="viewPaymentPlan('${preRegId}')">üí∞ √ñdeme Planƒ± G√∂r√ºnt√ºle</a>`;
                }
                menuHtml = `${paymentLink}<a href="#" onclick="openPreRegEditModal('${preRegId}')">‚úèÔ∏è Kaydƒ± D√ºzenle</a><a href="#" class="danger" onclick="deleteItem('preRegistrations', '${preRegId}')">üóëÔ∏è Kaydƒ± Sil</a>`;
            } else if (type === 'member') {
                menuHtml = `<a href="#" onclick="viewMemberPayments('${memberId}')">üí∞ √ñdeme Planƒ± G√∂r√ºnt√ºle</a><a href="#" onclick="assignToGroup('${memberId}', null)">üîÑ Gruba Ata/Ta≈üƒ±</a><a href="#" onclick="openMemberEditModal('${memberId}')">‚úèÔ∏è Bilgileri D√ºzenle</a><a href="#" class="danger" onclick="deleteItem('members', '${memberId}')">üóëÔ∏è √úyeyi Sil</a>`;
            }
            menu.innerHTML = menuHtml;
            document.body.appendChild(menu); // Append to body to avoid clipping issues
            
            const rect = button.getBoundingClientRect();

            // Position menu relative to the viewport
            menu.style.top = `${rect.bottom + window.scrollY + 5}px`;
            
            const menuWidth = menu.offsetWidth;
            const clientWidth = document.documentElement.clientWidth;

            if (rect.left + menuWidth > clientWidth - 10) {
                 menu.style.left = 'auto';
                 menu.style.right = `${clientWidth - rect.right}px`;
            } else {
                 menu.style.left = `${rect.left}px`;
                 menu.style.right = 'auto';
            }

            menu.classList.add('active');
            menu.dataset.activeButtonId = newId;
        }


        function closeAllMenus(event) {
            const contextMenu = document.getElementById('context-menu');
            if (contextMenu && !event.target.closest('.actions-toggle')) {
                contextMenu.classList.remove('active');
            }
            
            const phoneMenu = document.getElementById('phone-context-menu');
            if (phoneMenu && !event.target.closest('.phone-link')) {
                phoneMenu.style.display = 'none';
            }
        }

        function handlePhoneClick(event, phone) {
            event.preventDefault();
            event.stopPropagation();
            if (!phone) return;

            // Close other menus first
            const contextMenu = document.getElementById('context-menu');
            if(contextMenu) {
                contextMenu.classList.remove('active');
            }

            const menu = document.getElementById('phone-context-menu');
            const copyBtn = document.getElementById('phone-copy-btn');
            const callBtn = document.getElementById('phone-call-btn');

            copyBtn.onclick = (e) => {
                e.stopPropagation();
                const tempInput = document.createElement("textarea");
                tempInput.value = phone;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand('copy');
                    showAlert('Telefon numarasƒ± kopyalandƒ±!', 'success');
                } catch (err) {
                     showAlert('Kopyalanamadƒ±.', 'danger');
                }
                document.body.removeChild(tempInput);
                menu.style.display = 'none';
            };
            callBtn.onclick = (e) => {
                e.stopPropagation();
                window.location.href = `tel:${phone}`;
                menu.style.display = 'none';
            };

            const rect = event.target.getBoundingClientRect();
            menu.style.top = `${rect.bottom + 5}px`;
            menu.style.left = `${rect.left}px`;
            menu.style.display = 'block';
        }
        
        function toggleReasonInput(checkbox, memberId) {
            const reasonInput = document.querySelector(`input[name="reason_${memberId}"]`);
            reasonInput.style.display = checkbox.checked ? 'none' : 'block';
        }
        
        function changeMembersPage(direction) {
            membersCurrentPage += direction;
            renderMembersTable();
        }

        function changeMembersItemsPerPage(selectElement) {
            membersItemsPerPage = parseInt(selectElement.value, 10);
            membersCurrentPage = 1;
            renderMembersTable();
        }

        function promptMoveOrAdd(memberId, newGroupId) {
            const member = members.find(m => m.id === memberId);
            const newGroup = groups.find(g => g.id === newGroupId);
            if (!member || !newGroup) return;

            const memberGroups = groups.filter(g => g.members && g.members.includes(memberId));

            if (memberGroups.length === 0) {
                // Member is in no groups, so just add them without asking.
                confirmGroupAssignment(memberId, newGroupId, false);
                return;
            }

            const modal = document.getElementById('choiceModal');
            modal.querySelector('#choiceTitle').textContent = 'Gruba Ekleme Y√∂ntemi';
            modal.querySelector('#choiceText').textContent = `"${member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad}" adlƒ± √ºyeyi "${newGroup.groupName}" grubuna nasƒ±l eklemek istersiniz?`;
            
            const buttonContainer = modal.querySelector('#choiceButtons');
            buttonContainer.innerHTML = `
                <button class="btn btn-primary" onclick="confirmGroupAssignment('${memberId}', '${newGroupId}', false)">Sadece Bu Gruba Ekle</button>
                <button class="btn btn-warning" onclick="confirmGroupAssignment('${memberId}', '${newGroupId}', true)">Ta≈üƒ± (Diƒüer Gruplardan √áƒ±kar)</button>
                <button class="btn btn-secondary" onclick="closeModal('choiceModal')">ƒ∞ptal</button>
            `;
            
            openModal('choiceModal');
        }

        // --- Expose functions to global scope for onclick handlers ---
        window.showSection = showSection;
        window.setPaymentFilter = setPaymentFilter;
        window.filterScheduleByBranch = filterScheduleByBranch;
        window.filterGroupsByBranch = filterGroupsByBranch;
        window.openGroupModal = openGroupModal;
        window.closeModal = closeModal;
        window.deleteItem = deleteItem;
        window.updateMemberStatus = updateMemberStatus;
        window.viewPaymentPlan = viewPaymentPlan;
        window.openPreRegEditModal = openPreRegEditModal;
        window.openMemberEditModal = openMemberEditModal;
        window.assignToGroup = assignToGroup;
        window.viewMemberPayments = viewMemberPayments;
        window.togglePaymentDetails = togglePaymentDetails;
        window.openPaymentEditModal = openPaymentEditModal;
        window.drag = drag;
        window.allowDrop = allowDrop;
        window.drop = drop;
        window.openAttendanceModal = openAttendanceModal;
        window.deleteSchedule = deleteSchedule;
        window.removeMemberFromGroup = removeMemberFromGroup;
        window.confirmGroupAssignment = confirmGroupAssignment;
        window.openGroupEditModal = openGroupEditModal;
        window.navigateToSection = navigateToSection;
        window.showMemberAttendancePage = showMemberAttendancePage;
        window.toggleActionsMenu = toggleActionsMenu;
        window.handlePhoneClick = handlePhoneClick;
        window.toggleReasonInput = toggleReasonInput;
        window.sortMembersByAge = sortMembersByAge;
        window.editReason = editReason;
        window.saveReason = saveReason;
        window.changeMembersPage = changeMembersPage;
        window.changeMembersItemsPerPage = changeMembersItemsPerPage;
        window.deletePaymentFromSchedule = deletePaymentFromSchedule;
        window.recalculateSubsequentPayments = recalculateSubsequentPayments;
        window.toggleAttendanceStatus = toggleAttendanceStatus;
        window.openScheduleModalForGroup = openScheduleModalForGroup;
        window.handleTaskSubmit = handleTaskSubmit;
        window.openTaskEditModal = openTaskEditModal;
        window.openTaskMessagesModal = openTaskMessagesModal;
        window.deleteTaskMessage = deleteTaskMessage;
        window.openProfileEditModal = openProfileEditModal;
        window.deleteAttendanceRecord = deleteAttendanceRecord;
        window.editAttendanceDate = editAttendanceDate;
        window.saveAttendanceDate = saveAttendanceDate;
        window.promptMoveOrAdd = promptMoveOrAdd;
        window.renderAbsentStudents = renderAbsentStudents;
        window.selectAllPayments = selectAllPayments;
        window.markSelectedPaymentsAsPaid = markSelectedPaymentsAsPaid;
        window.deleteSelectedPayments = deleteSelectedPayments;
        window.switchSettingsTab = switchSettingsTab;
        window.showInstanceQR = showInstanceQR;
        window.restartInstance = restartInstance;
        window.deleteInstance = deleteInstance;
        window.checkConnectionStatus = checkConnectionStatus;
        
        // Dropdown toggle with event delegation (works in modals too)
        document.addEventListener('click', function(e) {
            // Toggle dropdown when clicking the button
            if (e.target.closest('.actions-dropdown-btn')) {
                e.stopPropagation();
                const btn = e.target.closest('.actions-dropdown-btn');
                const dropdown = btn.closest('.actions-dropdown');
                const wasActive = dropdown.classList.contains('active');
                
                // Close all other dropdowns
                document.querySelectorAll('.actions-dropdown.active').forEach(d => {
                    if (d !== dropdown) {
                        d.classList.remove('active');
                    }
                });
                
                // Toggle current dropdown
                if (!wasActive) {
                    dropdown.classList.add('active');
                    
                    // Position the dropdown menu
                    const dropdownContent = dropdown.querySelector('.actions-dropdown-content');
                    const btnRect = btn.getBoundingClientRect();
                    
                    // Position below the button, aligned to the right
                    dropdownContent.style.top = (btnRect.bottom + 5) + 'px';
                    dropdownContent.style.left = (btnRect.right - 180) + 'px'; // 180px is min-width
                    
                    // Check if it goes off screen bottom
                    const contentRect = dropdownContent.getBoundingClientRect();
                    if (contentRect.bottom > window.innerHeight) {
                        // Show above the button instead
                        dropdownContent.style.top = (btnRect.top - contentRect.height - 5) + 'px';
                    }
                    
                    // Check if it goes off screen left
                    if (contentRect.left < 0) {
                        dropdownContent.style.left = '10px';
                    }
                } else {
                    dropdown.classList.remove('active');
                }
                return;
            }
            
            // Handle clicks inside dropdown content
            if (e.target.closest('.actions-dropdown-content button')) {
                // Close dropdown after clicking a button
                setTimeout(() => {
                    document.querySelectorAll('.actions-dropdown.active').forEach(d => {
                        d.classList.remove('active');
                    });
                }, 100);
                return;
            }
            
            // Don't close if clicking inside dropdown content (but not a button)
            if (e.target.closest('.actions-dropdown-content')) {
                return;
            }
            
            // Close all dropdowns when clicking outside
            document.querySelectorAll('.actions-dropdown.active').forEach(d => {
                d.classList.remove('active');
            });
        });
        
        // Close dropdowns on scroll
        window.addEventListener('scroll', function() {
            document.querySelectorAll('.actions-dropdown.active').forEach(d => {
                d.classList.remove('active');
            });
        }, true);
        
        // Debug tool for checking payment info by phone
        window.debugPaymentInfo = function(phone) {
            console.log('=== √ñDEME Bƒ∞LGƒ∞Sƒ∞ KONTROL ===');
            console.log('Aranan Telefon:', phone);
            
            // Normalize phone
            let normalizedPhone = phone.replace(/\s/g, '').replace(/\D/g, '');
            if (normalizedPhone.startsWith('0')) {
                normalizedPhone = normalizedPhone.substring(1);
            }
            const phoneFormats = [phone, '0' + normalizedPhone, '90' + normalizedPhone, normalizedPhone];
            
            console.log('Denenen Formatlar:', phoneFormats);
            
            // Find member
            const member = members.find(m => phoneFormats.includes(m.Telefon));
            if (!member) {
                console.error('‚ùå √úye bulunamadƒ±!');
                return;
            }
            
            console.log('‚úÖ √úye Bulundu:', member.Ad_Soyad, member.Resit_Olmayan_Adi_Soyadi);
            console.log('√úye ID:', member.id);
            console.log('PreRegistration ID:', member.preRegistrationId);
            console.log('Telefon:', member.Telefon);
            
            // Find preRegistration by ID
            let preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
            
            if (!preReg) {
                console.warn('‚ö†Ô∏è PreRegistration ID ile bulunamadƒ±, telefon ile aranƒ±yor...');
                preReg = preRegistrations.find(p => phoneFormats.includes(p.phone));
            }
            
            if (!preReg) {
                console.error('‚ùå √ñdeme planƒ± bulunamadƒ±!');
                console.log('T√ºm PreRegistrations:', preRegistrations.map(p => ({ id: p.id, phone: p.phone })));
                return;
            }
            
            console.log('‚úÖ √ñdeme Planƒ± Bulundu:');
            console.log('PreReg ID:', preReg.id);
            console.log('PreReg Telefon:', preReg.phone);
            console.log('Bran≈ü:', preReg.branch);
            console.log('D√∂nem:', formatDate(preReg.periodStart), '-', formatDate(preReg.periodEnd));
            console.log('\n=== √ñDEME PLANI ===');
            
            if (preReg.paymentSchedule && preReg.paymentSchedule.length > 0) {
                console.table(preReg.paymentSchedule.map(p => ({
                    'Taksit': p.paymentNumber,
                    'Tutar': p.amount + ' ‚Ç∫',
                    'D√∂nem Ba≈ülangƒ±√ß': formatDate(p.period?.start),
                    'D√∂nem Biti≈ü': formatDate(p.period?.end),
                    'Ders Sayƒ±sƒ±': p.period?.lessonCount || 'YOK',
                    'Son √ñdeme': formatDate(p.dueDate),
                    'Durum': p.status,
                    '√ñdeme Tarihi': p.paymentDate ? formatDate(p.paymentDate) : '-'
                })));
            } else {
                console.log('‚ùå √ñdeme planƒ± bo≈ü!');
            }
            
            return { member, preReg };
        };
        
        window.manualCheckConnection = async function(instanceName, deviceId) {
            showAlert('üîç Baƒülantƒ± kontrol ediliyor...', 'info');
            
            const isConnected = await checkConnectionStatus(instanceName, deviceId);
            
            if (isConnected) {
                showAlert('‚úÖ WhatsApp baƒülantƒ±sƒ± ba≈üarƒ±lƒ±! Cihaz kullanƒ±ma hazƒ±r.', 'success');
                loadWhatsAppInstances();
            } else {
                showAlert('‚ö†Ô∏è Cihaz hen√ºz baƒülanmadƒ±. QR kodu okuttuƒüunuzdan emin olun.', 'warning');
            }
        };
        
        window.sendTestWhatsAppMessage = async function(event) {
            event.preventDefault();
            
            const form = event.target;
            const instanceName = form.testMessageDevice.value;
            const phone = form.testMessagePhone.value.trim();
            const message = form.testMessageText.value.trim();
            
            console.log('Test mesajƒ± g√∂nderiliyor:', { instanceName, phone, message });
            
            if (!phone || !message) {
                return showAlert('L√ºtfen telefon ve mesaj alanlarƒ±nƒ± doldurun.', 'warning');
            }
            
            if (!instanceName || instanceName === '') {
                return showAlert('L√ºtfen bir WhatsApp cihazƒ± se√ßin. √ñnce cihaz baƒülayƒ±n.', 'warning');
            }
            
            // Check if device exists and is connected
            const device = whatsappDevices.find(d => d.instanceName === instanceName);
            if (!device) {
                return showAlert('Se√ßilen cihaz bulunamadƒ±. L√ºtfen sayfayƒ± yenileyin.', 'danger');
            }
            
            if (device.status !== 'connected') {
                return showAlert(`Cihaz baƒülƒ± deƒüil! Durum: ${device.status}. L√ºtfen QR kodu okutun.`, 'warning');
            }
            
            // Show loading
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '‚è≥ G√∂nderiliyor...';
            
            try {
                // Format phone number for WhatsApp (remove leading 0 if exists, add @s.whatsapp.net)
                let formattedPhone = phone.replace(/\D/g, ''); // Remove non-digits
                if (formattedPhone.startsWith('0')) {
                    formattedPhone = formattedPhone.substring(1); // Remove leading 0
                }
                if (!formattedPhone.startsWith('90')) {
                    formattedPhone = '90' + formattedPhone; // Add country code if missing
                }
                
                const apiUrl = `${EVOLUTION_API_URL}/message/sendText/${instanceName}`;
                const requestBody = {
                    number: `${formattedPhone}@s.whatsapp.net`,
                    text: message
                };
                
                console.log('API ƒ∞steƒüi:', {
                    url: apiUrl,
                    body: requestBody,
                    device: device
                });
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': EVOLUTION_API_KEY
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('API Yanƒ±tƒ± - Status:', response.status, 'OK:', response.ok);
                
                const data = await response.json().catch(err => {
                    console.error('JSON parse hatasƒ±:', err);
                    return null;
                });
                
                console.log('API Yanƒ±t Data:', data);
                
                if (response.ok) {
                    showAlert('‚úÖ Mesaj ba≈üarƒ±yla g√∂nderildi!', 'success');
                    form.testMessageText.value = '';
                } else {
                    console.error('Mesaj g√∂nderme hatasƒ±:', { 
                        status: response.status, 
                        statusText: response.statusText,
                        data: data 
                    });
                    
                    let errorMsg = 'Bilinmeyen hata';
                    if (response.status === 500) {
                        errorMsg = 'Sunucu hatasƒ±. Instance adƒ±nƒ± kontrol edin veya cihazƒ± yeniden ba≈ülatƒ±n.';
                        if (data && data.message) {
                            errorMsg += ` Detay: ${data.message}`;
                        }
                    } else if (response.status === 404) {
                        errorMsg = 'Instance bulunamadƒ±. Cihaz adƒ±nƒ± kontrol edin.';
                    } else if (response.status === 401) {
                        errorMsg = 'API Key hatasƒ±. Yetkisiz eri≈üim.';
                    } else if (data) {
                        errorMsg = data.message || data.error || `HTTP ${response.status}`;
                    }
                    showAlert(`‚ùå Mesaj g√∂nderilemedi: ${errorMsg}`, 'danger');
                }
            } catch (error) {
                console.error('Mesaj g√∂nderme exception:', error);
                showAlert(`‚ùå Mesaj g√∂nderilirken hata olu≈ütu: ${error.message}`, 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        };

        // =====================================================
        // üì• BULK IMPORT FUNCTIONS
        // =====================================================
        
        let importData = []; // Parse edilen veriler
        let validImportRecords = []; // Ge√ßerli kayƒ±tlar
        
        // Modal a√ßma/kapama
        window.openBulkImportModal = function() {
            document.getElementById('bulkImportModal').style.display = 'flex';
            resetImportSteps();
        };
        
        window.closeBulkImportModal = function() {
            document.getElementById('bulkImportModal').style.display = 'none';
            resetImportSteps();
            importData = [];
            validImportRecords = [];
            document.getElementById('csvFileInput').value = '';
        };
        
        function resetImportSteps() {
            document.getElementById('import-step-1').style.display = 'block';
            document.getElementById('import-step-2').style.display = 'none';
            document.getElementById('import-step-3').style.display = 'none';
            document.getElementById('import-step-4').style.display = 'none';
        }
        
        // ≈ûablon indirme - Excel formatƒ±nda dropdown men√ºler ile
        window.downloadImportTemplate = function() {
            if (typeof XLSX === 'undefined') {
                showAlert('‚ùå Excel k√ºt√ºphanesi y√ºklenemedi. L√ºtfen sayfayƒ± yenileyin.', 'danger');
                return;
            }
            
            // Bran≈ü listesi
            const branchNames = branches.map(b => b.name);
            
            // Etiket listesi (bran≈ü etiketleri hari√ß)
            const tagNames = crmTags
                .filter(tag => tag.category !== 'branch')
                .map(tag => tag.name);
            
            // Kaynak listesi
            const sources = ['Telefon', 'WhatsApp', 'Sosyal Medya', 'Referans', 'Web Sitesi', 'Diƒüer'];
            
            // Ya≈ü grubu listesi
            const ageGroups = ['Yeti≈ükin', '√áocuk'];
            
            // Excel workbook olu≈ütur
            const wb = XLSX.utils.book_new();
            
            // Ana veri sayfasƒ±
            const mainSheet = [
                ['Telefon', 'Ad Soyad', 'Kaynak', 'Bran≈ü', 'Ya≈ü Grubu', 'Etiket', 'Veli Adƒ± (√áocuk i√ßin)', '√áocuk Adƒ±', '√áocuk Ya≈üƒ±', 'Not'],
                ['05321234567', 'Ahmet Yƒ±lmaz', 'Telefon', branchNames[0] || 'Tenis', 'Yeti≈ükin', tagNames[0] || 'Aranmadƒ±', '', '', '', 'ƒ∞lk g√∂r√º≈üme yapƒ±ldƒ±'],
                ['05439876543', '', 'WhatsApp', branchNames[0] || 'Tenis', '√áocuk', 'Denemeye Gelecek', 'Ay≈üe Demir', 'Zeynep Demir', '8', 'Cumartesi deneme dersi'],
                ['05551234567', 'Mehmet Kaya', 'Sosyal Medya', branchNames[0] || 'Voleybol', 'Yeti≈ükin', 'Aranmadƒ±', '', '', '', 'Fiyat bilgisi verildi'],
                ['05449876543', '', 'Telefon', branchNames[0] || 'Tenis', '√áocuk', 'Kayƒ±t Olabilir', 'Fatma ≈ûahin', 'Ali ≈ûahin', '10', '2 √ßocuk var'],
                ['05505123456', 'Hakan Yƒ±ldƒ±z', 'Referans', branchNames[0] || 'Tenis', 'Yeti≈ükin', 'Aranmadƒ±', '', '', '', 'Ba≈ülangƒ±√ß seviyesi']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(mainSheet);
            
            // S√ºtun geni≈ülikleri
            ws['!cols'] = [
                {wch: 12}, // Telefon
                {wch: 18}, // Ad Soyad
                {wch: 15}, // Kaynak
                {wch: 15}, // Bran≈ü
                {wch: 12}, // Ya≈ü Grubu
                {wch: 18}, // Etiket
                {wch: 18}, // Veli Adƒ±
                {wch: 18}, // √áocuk Adƒ±
                {wch: 10}, // √áocuk Ya≈üƒ±
                {wch: 25}  // Not
            ];
            
            // Dropdown validasyonlarƒ± ekle - T√ºm aralƒ±k i√ßin tek seferde
            ws['!dataValidation'] = [];
            
            // Kaynak dropdown (C2:C1000)
            ws['!dataValidation'].push({
                type: 'list',
                allowBlank: true,
                sqref: 'C2:C1000',
                formulas: [sources.join(',')]
            });
            
            // Bran≈ü dropdown (D2:D1000) - Bran≈ülar sayfasƒ±ndan referans
            if (branchNames.length > 0) {
                ws['!dataValidation'].push({
                    type: 'list',
                    allowBlank: false,
                    sqref: 'D2:D1000',
                    formulas: [branchNames.join(',')]
                });
            }
            
            // Ya≈ü Grubu dropdown (E2:E1000)
            ws['!dataValidation'].push({
                type: 'list',
                allowBlank: false,
                sqref: 'E2:E1000',
                formulas: [ageGroups.join(',')]
            });
            
            // Etiket dropdown (F2:F1000) - Etiketler sayfasƒ±ndan referans
            if (tagNames.length > 0) {
                ws['!dataValidation'].push({
                    type: 'list',
                    allowBlank: false,
                    sqref: 'F2:F1000',
                    formulas: [tagNames.join(',')]
                });
            }
            
            // Ana sayfayƒ± ekle
            XLSX.utils.book_append_sheet(wb, ws, 'M√º≈üteriler');
            
            // Yardƒ±mcƒ± sayfa - Bran≈ülar
            const branchSheet = [
                ['üìã Mevcut Bran≈ülar'],
                ...branchNames.map(name => [name])
            ];
            const wsBranch = XLSX.utils.aoa_to_sheet(branchSheet);
            XLSX.utils.book_append_sheet(wb, wsBranch, 'Bran≈ülar');
            
            // Yardƒ±mcƒ± sayfa - Etiketler
            const tagSheet = [
                ['üè∑Ô∏è Mevcut Etiketler'],
                ...tagNames.map(name => [name])
            ];
            const wsTag = XLSX.utils.aoa_to_sheet(tagSheet);
            XLSX.utils.book_append_sheet(wb, wsTag, 'Etiketler');
            
            // Yardƒ±mcƒ± sayfa - Talimatlar
            const instructionsSheet = [
                ['üìñ TOPLU M√ú≈ûTERƒ∞ EKLEME TALƒ∞MATLARI'],
                [''],
                ['1. S√úTUN A√áIKLAMALARI:'],
                ['‚Ä¢ Telefon: 05XX XXX XX XX formatƒ±nda (zorunlu)'],
                ['‚Ä¢ Ad Soyad: Yeti≈ükin i√ßin doldurulmalƒ±'],
                ['‚Ä¢ Kaynak: M√º≈üterinin nereden geldiƒüi (Bran≈ülar sayfasƒ±ndan kopyala-yapƒ±≈ütƒ±r)'],
                ['‚Ä¢ Bran≈ü: ƒ∞lgilendikleri bran≈ü (Bran≈ülar sayfasƒ±ndan kopyala-yapƒ±≈ütƒ±r - zorunlu)'],
                ['‚Ä¢ Ya≈ü Grubu: "Yeti≈ükin" veya "√áocuk" (elle yazƒ±n - zorunlu)'],
                ['‚Ä¢ Etiket: M√º≈üterinin durumu (Etiketler sayfasƒ±ndan kopyala-yapƒ±≈ütƒ±r - zorunlu)'],
                ['‚Ä¢ Veli Adƒ±: Sadece √ßocuk m√º≈üteriler i√ßin (zorunlu)'],
                ['‚Ä¢ √áocuk Adƒ±: Sadece √ßocuk m√º≈üteriler i√ßin (zorunlu)'],
                ['‚Ä¢ √áocuk Ya≈üƒ±: √áocuƒüun ya≈üƒ± (opsiyonel)'],
                ['‚Ä¢ Not: Ek a√ßƒ±klamalar (opsiyonel)'],
                [''],
                ['2. √ñNEMLƒ∞ KURALLAR:'],
                ['‚úì Telefon numarasƒ± benzersiz olmalƒ±'],
                ['‚úì Yeti≈ükin se√ßiliyse "Ad Soyad" doldurulmalƒ±'],
                ['‚úì √áocuk se√ßiliyse "Veli Adƒ±" ve "√áocuk Adƒ±" doldurulmalƒ±'],
                ['‚úì Bran≈ü ve Etiket i√ßin "Bran≈ülar" ve "Etiketler" sayfalarƒ±ndaki deƒüerleri kullanƒ±n'],
                ['‚úì Ya≈ü Grubu: "Yeti≈ükin" veya "√áocuk" (tam olarak bu ≈üekilde yazƒ±n)'],
                [''],
                ['3. BRAN≈û VE ETƒ∞KET NASIL SE√áƒ∞Lƒ∞R?'],
                ['Y√∂ntem 1 (√ñnerilen):'],
                ['‚Ä¢ "Bran≈ülar" veya "Etiketler" sekmesine git'],
                ['‚Ä¢ ƒ∞stediƒüin deƒüeri kopyala (Ctrl+C)'],
                ['‚Ä¢ "M√º≈üteriler" sekmesindeki ilgili h√ºcreye yapƒ±≈ütƒ±r (Ctrl+V)'],
                [''],
                ['Y√∂ntem 2 (Manuel Dropdown):'],
                ['‚Ä¢ Excel\'de h√ºcreyi se√ß ‚Üí Veri ‚Üí Veri Doƒürulama'],
                ['‚Ä¢ Liste se√ß ‚Üí Kaynak olarak "Bran≈ülar" veya "Etiketler" sayfasƒ±nƒ± referans et'],
                ['‚Ä¢ √ñrnek: =Bran≈ülar!$A$2:$A$10 (bran≈ülar i√ßin)'],
                [''],
                ['4. √ñRNEK VERƒ∞LER:'],
                ['‚Ä¢ √ñrnek verileri inceleyip silebilir veya deƒüi≈ütirebilirsiniz'],
                ['‚Ä¢ Yeni satƒ±rlar ekleyebilirsiniz'],
                ['‚Ä¢ Bran≈ü/Etiket deƒüerlerini kopyala-yapƒ±≈ütƒ±r ile ekleyin'],
                [''],
                ['5. DOSYA KAYDETME:'],
                ['‚Ä¢ Dosyayƒ± Excel formatƒ±nda (.xlsx) olarak kaydedin'],
                ['‚Ä¢ CSV olarak kaydetmeyin'],
                [''],
                ['6. Y√úKLEME:'],
                ['‚Ä¢ "Toplu ƒ∞√ße Aktar" b√∂l√ºm√ºnden dosyayƒ± y√ºkleyin'],
                ['‚Ä¢ Sistem otomatik kontrol yapacak ve hatalarƒ± g√∂sterecek'],
                [''],
                ['‚ö†Ô∏è √ñNEMLƒ∞ NOT:'],
                ['Bran≈ü ve Etiket isimlerini tam olarak "Bran≈ülar" ve "Etiketler"'],
                ['sayfalarƒ±ndaki gibi yazƒ±n. Yazƒ±m hatasƒ± yaparsanƒ±z sistem'],
                ['bu kayƒ±tlarƒ± kabul etmez!']
            ];
            const wsInstructions = XLSX.utils.aoa_to_sheet(instructionsSheet);
            wsInstructions['!cols'] = [{wch: 70}];
            XLSX.utils.book_append_sheet(wb, wsInstructions, 'Talimatlar');
            
            // Dosyayƒ± indir
            XLSX.writeFile(wb, 'CRM_Toplu_Musteri_Ekleme_Sablonu.xlsx');
            
            showAlert('‚úÖ Excel ≈üablonu indirildi!\n\nüìã "Bran≈ülar" ve "Etiketler" sekmelerinden deƒüerleri kopyalayƒ±p "M√º≈üteriler" sekmesine yapƒ±≈ütƒ±rƒ±n.\n\n‚ö†Ô∏è Yazƒ±m hatasƒ± yapmamak i√ßin mutlaka kopyala-yapƒ±≈ütƒ±r kullanƒ±n!', 'success');
        };
        
        // Dosya se√ßme
        window.handleFileSelect = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('üìÅ Dosya se√ßildi:', file.name, file.type);
            
            try {
                if (file.name.endsWith('.csv')) {
                    await parseCSV(file);
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    await parseExcel(file);
                } else {
                    showAlert('‚ùå Desteklenmeyen dosya formatƒ±! L√ºtfen CSV veya Excel dosyasƒ± y√ºkleyin.', 'danger');
                    return;
                }
            } catch (error) {
                console.error('Dosya parse hatasƒ±:', error);
                showAlert('‚ùå Dosya okunurken hata olu≈ütu: ' + error.message, 'danger');
            }
        };
        
        // Excel Parse (XLSX)
        async function parseExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        if (typeof XLSX === 'undefined') {
                            reject(new Error('Excel k√ºt√ºphanesi y√ºklenemedi'));
                            return;
                        }
                        
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // ƒ∞lk sheet'i al (M√º≈üteriler sayfasƒ±)
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // JSON'a √ßevir (header: 1 ile array of arrays olarak al)
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        if (jsonData.length < 2) {
                            reject(new Error('Dosyada veri bulunamadƒ±'));
                            return;
                        }
                        
                        // ƒ∞lk satƒ±r ba≈ülƒ±k
                        const headers = jsonData[0];
                        
                        // Data satƒ±rlarƒ±
                        importData = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (!row || row.length === 0 || !row[0]) continue; // Bo≈ü satƒ±r
                            
                            const record = {
                                rowNumber: i,
                                phone: row[0] ? String(row[0]) : '',
                                fullName: row[1] ? String(row[1]) : '',
                                source: row[2] ? String(row[2]) : '',
                                branchName: row[3] ? String(row[3]) : '',
                                ageGroup: row[4] ? String(row[4]) : '',
                                tag: row[5] ? String(row[5]) : '',
                                parentName: row[6] ? String(row[6]) : '',
                                childName: row[7] ? String(row[7]) : '',
                                childAge: row[8] ? String(row[8]) : '',
                                note: row[9] ? String(row[9]) : ''
                            };
                            
                            importData.push(record);
                        }
                        
                        console.log('üìä Excel\'den parse edilen kayƒ±t sayƒ±sƒ±:', importData.length);
                        
                        if (importData.length === 0) {
                            reject(new Error('Dosyada i≈ülenebilir veri bulunamadƒ±'));
                            return;
                        }
                        
                        // Validation ve preview
                        validateAndPreview();
                        resolve();
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Dosya okunamadƒ±'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }
        
        // CSV Parse
        async function parseCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        const lines = text.split(/\r?\n/).filter(line => line.trim());
                        
                        if (lines.length < 2) {
                            reject(new Error('Dosya bo≈ü veya sadece ba≈ülƒ±k satƒ±rƒ± var'));
                            return;
                        }
                        
                        // ƒ∞lk satƒ±r header olmalƒ±
                        const headers = lines[0].split(',').map(h => h.trim());
                        console.log('üìã CSV Headers:', headers);
                        
                        // Data satƒ±rlarƒ±
                        importData = [];
                        for (let i = 1; i < lines.length; i++) {
                            const values = parseCSVLine(lines[i]);
                            if (values.length === 0) continue; // Bo≈ü satƒ±r
                            
                            const record = {
                                rowNumber: i,
                                phone: values[0] || '',
                                fullName: values[1] || '', // Yeti≈ükin i√ßin
                                source: values[2] || '',
                                branchName: values[3] || '',
                                ageGroup: values[4] || '',
                                tag: values[5] || '',
                                parentName: values[6] || '', // √áocuk i√ßin veli adƒ±
                                childName: values[7] || '', // √áocuk i√ßin √ßocuk adƒ±
                                childAge: values[8] || '', // √áocuk i√ßin ya≈ü
                                note: values[9] || ''
                            };
                            
                            importData.push(record);
                        }
                        
                        console.log('üìä Parse edilen kayƒ±t sayƒ±sƒ±:', importData.length);
                        
                        if (importData.length === 0) {
                            reject(new Error('Dosyada i≈ülenebilir veri bulunamadƒ±'));
                            return;
                        }
                        
                        // Validation ve preview
                        validateAndPreview();
                        resolve();
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Dosya okunamadƒ±'));
                };
                
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // CSV satƒ±r parse (virg√ºl i√ßindeki virg√ºlleri handle et)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }
        
        // Validation ve Preview
        function validateAndPreview() {
            validImportRecords = [];
            const invalidRecords = [];
            
            importData.forEach(record => {
                const errors = [];
                
                // Telefon kontrol√º
                const cleanPhone = record.phone.replace(/\D/g, '');
                if (!cleanPhone || cleanPhone.length < 10) {
                    errors.push('Ge√ßersiz telefon');
                } else {
                    // Telefon zaten kayƒ±tlƒ± mƒ±?
                    const existing = crmLeads.find(l => 
                        l.phone && phonesMatch(l.phone, cleanPhone)
                    );
                    if (existing) {
                        errors.push('Telefon kayƒ±tlƒ±');
                    }
                }
                
                // Ya≈ü grubuna g√∂re ad kontrol√º
                const isChild = record.ageGroup && record.ageGroup.toLowerCase() === '√ßocuk';
                if (isChild) {
                    // √áocuk ise: Veli Adƒ± ve √áocuk Adƒ± zorunlu
                    if (!record.parentName || record.parentName.trim().length < 2) {
                        errors.push('Veli Adƒ± eksik');
                    }
                    if (!record.childName || record.childName.trim().length < 2) {
                        errors.push('√áocuk Adƒ± eksik');
                    }
                } else {
                    // Yeti≈ükin ise: Ad Soyad zorunlu
                    if (!record.fullName || record.fullName.trim().length < 2) {
                        errors.push('Ad Soyad eksik');
                    }
                }
                
                // Kaynak kontrol√º
                const validSources = ['telefon', 'whatsapp', 'sosyal medya', 'referans', 'web sitesi', 'diƒüer'];
                if (!record.source || !validSources.includes(record.source.toLowerCase())) {
                    errors.push('Ge√ßersiz kaynak');
                }
                
                // Bran≈ü kontrol√º
                const branch = branches.find(b => 
                    b.name && record.branchName && 
                    b.name.toLowerCase().includes(record.branchName.toLowerCase())
                );
                if (!branch) {
                    errors.push('Bran≈ü bulunamadƒ±');
                }
                
                // Ya≈ü grubu kontrol√º
                const validAgeGroups = ['yeti≈ükin', '√ßocuk'];
                if (!record.ageGroup || !validAgeGroups.includes(record.ageGroup.toLowerCase())) {
                    errors.push('Ge√ßersiz ya≈ü grubu');
                }
                
                record.errors = errors;
                record.isValid = errors.length === 0;
                record.cleanPhone = cleanPhone;
                record.branch = branch;
                
                if (record.isValid) {
                    validImportRecords.push(record);
                } else {
                    invalidRecords.push(record);
                }
            });
            
            // Preview'i g√∂ster
            renderImportPreview();
            
            // Adƒ±m 2'ye ge√ß
            document.getElementById('import-step-1').style.display = 'none';
            document.getElementById('import-step-2').style.display = 'block';
        }
        
        // Preview render
        function renderImportPreview() {
            const tbody = document.getElementById('import-preview-body');
            const summaryDiv = document.getElementById('import-summary');
            
            // Summary
            const totalCount = importData.length;
            const validCount = validImportRecords.length;
            const invalidCount = totalCount - validCount;
            
            summaryDiv.innerHTML = `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 600;">${totalCount}</div>
                    <div style="font-size: 12px; color: #666;">Toplam</div>
                </div>
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 600; color: #4caf50;">${validCount}</div>
                    <div style="font-size: 12px; color: #666;">Ge√ßerli</div>
                </div>
                <div style="background: #ffebee; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 600; color: #f44336;">${invalidCount}</div>
                    <div style="font-size: 12px; color: #666;">Hatalƒ±</div>
                </div>
            `;
            
            document.getElementById('valid-count').textContent = validCount;
            
            // Tablo
            tbody.innerHTML = importData.map(record => {
                const statusColor = record.isValid ? '#4caf50' : '#f44336';
                const statusText = record.isValid ? '‚úÖ Ge√ßerli' : '‚ùå ' + record.errors.join(', ');
                const rowStyle = record.isValid ? '' : 'background: #ffebee;';
                
                // Veli/√áocuk bilgisini g√∂ster
                const isChild = record.ageGroup && record.ageGroup.toLowerCase() === '√ßocuk';
                let parentChildInfo = '-';
                if (isChild && (record.parentName || record.childName)) {
                    const parts = [];
                    if (record.parentName) parts.push(`Veli: ${record.parentName}`);
                    if (record.childName) parts.push(`√áocuk: ${record.childName}`);
                    if (record.childAge) parts.push(`Ya≈ü: ${record.childAge}`);
                    parentChildInfo = parts.join('<br>');
                }
                
                return `
                    <tr style="${rowStyle}">
                        <td>${record.rowNumber}</td>
                        <td>${record.phone}</td>
                        <td>${record.fullName || '-'}</td>
                        <td style="font-size: 11px;">${parentChildInfo}</td>
                        <td>${record.source}</td>
                        <td>${record.branchName}</td>
                        <td>${record.ageGroup}</td>
                        <td>${record.tag || '-'}</td>
                        <td style="color: ${statusColor}; font-size: 12px;">${statusText}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Toplu import onaylama
        window.confirmBulkImport = async function() {
            if (validImportRecords.length === 0) {
                showAlert('‚ùå Eklenebilecek ge√ßerli kayƒ±t yok!', 'warning');
                return;
            }
            
            const confirmMsg = `${validImportRecords.length} m√º≈üteri eklenecek. Onaylƒ±yor musunuz?`;
            if (!confirm(confirmMsg)) return;
            
            // Step 3'e ge√ß (progress)
            document.getElementById('import-step-2').style.display = 'none';
            document.getElementById('import-step-3').style.display = 'block';
            
            await processBulkImport();
        };
        
        // Toplu import i≈üleme
        async function processBulkImport() {
            const total = validImportRecords.length;
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            const progressBar = document.getElementById('import-progress-bar');
            const progressText = document.getElementById('import-progress-text');
            
            const now = new Date();
            const dateStr = now.toLocaleString('tr-TR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            const userName = currentUser.fullName || currentUser.email || 'Admin';
            
            for (let i = 0; i < validImportRecords.length; i++) {
                const record = validImportRecords[i];
                
                try {
                    // Kaynak mapping
                    const sourceMap = {
                        'telefon': 'phone',
                        'whatsapp': 'whatsapp',
                        'sosyal medya': 'social',
                        'referans': 'referral',
                        'web sitesi': 'website',
                        'diƒüer': 'other'
                    };
                    const source = sourceMap[record.source.toLowerCase()] || 'other';
                    
                    // Ya≈ü grubu mapping
                    const ageGroup = record.ageGroup.toLowerCase() === 'yeti≈ükin' ? 'adult' : 'child';
                    
                    // Lead verisi - √áocuk/Yeti≈ükin'e g√∂re branch olu≈ütur
                    const branchData = {
                        branchId: record.branch.id,
                        branchName: record.branch.name,
                        ageGroup: ageGroup,
                        selectedTag: record.tag || '',
                        notesHistory: record.note ? [{
                            text: record.note,
                            by: userName,
                            date: dateStr
                        }] : [],
                        kayitOlabilirDate: null,
                        denemeDate: null
                    };
                    
                    if (ageGroup === 'adult') {
                        // Yeti≈ükin
                        branchData.fullName = record.fullName;
                        branchData.parentName = '';
                        branchData.children = [];
                    } else {
                        // √áocuk
                        branchData.fullName = '';
                        branchData.parentName = record.parentName || '';
                        branchData.children = [{
                            name: record.childName || '',
                            age: record.childAge || '',
                            selectedTag: record.tag || '',
                            kayitOlabilirDate: null,
                            denemeDate: null
                        }];
                    }
                    
                    const leadData = {
                        fullName: ageGroup === 'adult' ? record.fullName : record.parentName,
                        phone: record.cleanPhone,
                        source: source,
                        clubId: currentClubId,
                        createdAt: now.toISOString(),
                        createdBy: userName + ' (Toplu Import)',
                        status: 'new',
                        branches: [branchData],
                        history: [
                            {
                                action: 'created',
                                by: userName,
                                date: dateStr,
                                details: ageGroup === 'adult' 
                                    ? `Toplu import ile olu≈üturuldu - ${record.fullName} (${record.cleanPhone})`
                                    : `Toplu import ile olu≈üturuldu - Veli: ${record.parentName}, √áocuk: ${record.childName} (${record.cleanPhone})`
                            }
                        ]
                    };
                    
                    // Etiket varsa history'e ekle
                    if (record.tag) {
                        leadData.history.push({
                            action: 'tag_added',
                            by: userName,
                            date: dateStr,
                            details: `${record.branch.name} - Etiket: "${record.tag}"`
                        });
                    }
                    
                    // Firebase'e ekle
                    await window.firebase.addDoc(
                        window.firebase.collection(window.db, 'crmLeads'),
                        leadData
                    );
                    
                    successCount++;
                    
                } catch (error) {
                    console.error(`Satƒ±r ${record.rowNumber} import hatasƒ±:`, error);
                    errorCount++;
                    errors.push(`Satƒ±r ${record.rowNumber} (${record.fullName}): ${error.message}`);
                }
                
                // Progress g√ºncelle
                const progress = ((i + 1) / total) * 100;
                progressBar.style.width = progress + '%';
                progressText.textContent = `${i + 1} / ${total}`;
                
                // Rate limiting
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            // Step 4'e ge√ß (sonu√ß)
            document.getElementById('import-step-3').style.display = 'none';
            document.getElementById('import-step-4').style.display = 'block';
            
            // Sonu√ß g√∂ster
            const resultDiv = document.getElementById('import-result');
            resultDiv.innerHTML = `
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="font-size: 18px; font-weight: 600; color: #4caf50;">‚úÖ Ba≈üarƒ±lƒ±: ${successCount}</div>
                </div>
                ${errorCount > 0 ? `
                <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="font-size: 18px; font-weight: 600; color: #f44336;">‚ùå Hatalƒ±: ${errorCount}</div>
                    ${errors.length > 0 ? `
                    <div style="margin-top: 10px; font-size: 12px;">
                        <strong>Hatalar:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            ${errors.slice(0, 5).map(err => `<li>${err}</li>`).join('')}
                            ${errors.length > 5 ? `<li>... ve ${errors.length - 5} hata daha</li>` : ''}
                        </ul>
                    </div>
                    ` : ''}
                </div>
                ` : ''}
            `;
            
            // Ba≈üarƒ±lƒ± ise veriyi yeniden y√ºkle
            if (successCount > 0) {
                setTimeout(() => {
                    loadData(false); // Fresh data y√ºkle
                }, 2000);
            }
        }


    </script>
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
            --border-color: #dee2e6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        
        /* Checkbox'larƒ± varsayƒ±lan olarak gizle */
        .incoming-call-checkbox,
        .outgoing-call-checkbox {
            display: none;
        }
        
        .incoming-call-checkbox:checked,
        .outgoing-call-checkbox:checked {
            display: block;
        }

        #password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #password-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            width: 90%;
            max-width: 400px;
        }

        #password-box h2 {
            margin-bottom: 20px;
            color: var(--dark-color);
        }

        #password-box .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        #password-error {
            color: var(--danger-color);
            margin-top: 10px;
            display: none;
        }

        #main-wrapper {
            display: none; /* Initially hidden */
        }

        .current-user-display {
            color: rgba(255,255,255,0.9);
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
            text-align: center;
            word-break: break-word;
        }


        /* ‚úÖ Sidebar Navigation Styles */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: width 0.3s ease;
        }
        
        .sidebar.collapsed {
            width: 60px;
        }
        
        .sidebar.collapsed .nav-text,
        .sidebar.collapsed .dropdown-arrow,
        .sidebar.collapsed .sidebar-header h2 span {
            display: none;
        }
        
        .sidebar.collapsed .nav-btn {
            justify-content: center;
            padding: 12px;
        }
        
        .sidebar.collapsed .dropdown-content {
            display: none !important;
        }
        
        .sidebar.collapsed .nav-dropdown {
            pointer-events: none;
        }
        
        .sidebar.collapsed .nav-icon {
            font-size: 20px;
            margin: 0;
        }
        
        .sidebar.collapsed .sidebar-header {
            padding: 15px 10px;
            text-align: center;
        }
        
        .sidebar.collapsed .sidebar-header h2 {
            font-size: 24px;
        }
        
        .sidebar.collapsed .sidebar-footer {
            padding: 10px 5px;
        }
        
        .sidebar.collapsed .current-user-display {
            display: none;
        }
        
        .sidebar.collapsed #logout-btn-sidebar {
            font-size: 18px;
            padding: 8px 5px !important;
        }
        
        .sidebar.collapsed #logout-btn-sidebar:before {
            content: "üö™";
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .sidebar-header h2 {
            color: white;
            font-size: 18px;
            margin: 0;
            font-weight: 600;
        }

        .sidebar-menu {
            flex: 1;
            padding: 15px 0;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .sidebar-menu::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar-menu::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
        }
        
        .sidebar-menu::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }

        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.3);
            flex-shrink: 0;
        }

        .sidebar .nav-btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 3px solid transparent;
        }

        .sidebar .nav-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
            border-left-color: var(--primary-color);
        }

        .sidebar .nav-btn.active {
            background: rgba(102, 126, 234, 0.2);
            color: white;
            border-left-color: var(--primary-color);
            font-weight: 600;
        }

        .sidebar .nav-icon {
            font-size: 18px;
            min-width: 24px;
        }

        .sidebar .nav-text {
            flex: 1;
            font-size: 14px;
        }

        /* Dropdown Menu */
        .nav-dropdown {
            position: relative;
        }

        .dropdown-toggle {
            position: relative;
        }

        .dropdown-arrow {
            font-size: 10px;
            transition: transform 0.3s ease;
        }

        .dropdown-toggle.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(0,0,0,0.2);
        }

        .dropdown-content.show {
            max-height: 500px;
        }

        .sidebar .nav-btn.sub-item {
            padding-left: 56px;
            font-size: 13px;
            border-left: 3px solid transparent;
        }

        .sidebar .nav-btn.sub-item:hover {
            background: rgba(255,255,255,0.15);
        }
        
        .sidebar .nav-btn.sub-sub-item {
            padding-left: 76px;
            font-size: 12px;
            border-left: 3px solid transparent;
        }
        
        .sidebar .nav-btn.sub-sub-item:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .nav-dropdown.sub-dropdown {
            margin-left: 0;
        }
        
        .nav-dropdown.sub-dropdown .dropdown-content {
            background: rgba(0,0,0,0.3);
        }

        /* Main Content Wrapper */
        .main-content-wrapper {
            flex: 1;
            margin-left: 260px;
            width: calc(100% - 260px);
            min-height: 100vh;
            background: #f5f5f5;
            transition: margin-left 0.3s ease, width 0.3s ease;
        }
        
        .sidebar.collapsed ~ .main-content-wrapper {
            margin-left: 60px;
            width: calc(100% - 60px);
        }
        
        .admin-content {
            padding: 30px;
            width: 100%;
            max-width: 100%;
            margin: 0;
        }

        .section { display: none; }
        .section.active { display: block; }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
        }
        .card > h3.card-subtitle {
            font-size: 1.2em;
            color: var(--dark-color);
            margin-top: 25px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .settings-subsection {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
        
        .settings-subtitle {
            font-size: 1.1em;
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .settings-tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 25px;
        }
        
        .settings-tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            margin-bottom: -2px;
        }
        
        .settings-tab:hover:not(:disabled) {
            color: var(--primary-color);
            background: rgba(255, 149, 0, 0.05);
        }
        
        .settings-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }
        
        .settings-tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .settings-tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .whatsapp-device-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: box-shadow 0.2s;
        }
        
        .whatsapp-device-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .device-info h4 {
            margin: 0 0 10px 0;
            color: var(--dark-color);
        }
        
        .device-info p {
            margin: 5px 0;
        }
        
        .device-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .card-title {
            font-size: 1.4em;
            color: var(--dark-color);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .permissions-group {
             display: flex;
             flex-wrap: wrap;
             gap: 15px;
             background: #f8f9fa;
             padding: 15px;
             border-radius: 8px;
             grid-column: 1 / -1; /* Span full width */
        }
        .permissions-group label {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .form-group label {
            font-weight: 600;
            color: var(--dark-color);
        }

        .form-control {
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .search-input {
            padding: 8px 15px;
            border: 2px solid var(--border-color);
            border-radius: 25px;
            width: 100%;
            max-width: 250px;
            font-size: 0.9em;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            padding: 5px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            transition: background-color 0.2s;
        }
        .btn-icon:hover {
            background-color: #e9ecef;
        }
        .btn-icon.danger:hover {
            background-color: #f8d7da;
            color: var(--danger-color);
        }

        .btn:disabled {
            background-color: #ccc !important;
            box-shadow: none;
            transform: none;
            cursor: not-allowed;
        }
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8em;
        }

        .btn-primary { background: var(--primary-color); color: white; }
        .btn-success { background: var(--success-color); color: white; }
        .btn-warning { background: var(--warning-color); color: #212529; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-info { background: var(--info-color); color: white; }
        .btn-secondary { background: #6c757d; color: white; }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-group .btn.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .btn-group .btn-secondary.active {
            background-color: var(--primary-color) !important;
            color: white !important;
        }

        .table-container {
            overflow: auto;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }
        
        .data-table tbody tr {
            transition: background-color 0.2s;
        }

        .data-table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .data-table tbody tr:hover {
            background: #f8f9ff;
        }
        
        .editable-row:hover {
            cursor: pointer;
            background-color: #f1f3f5 !important;
        }
        .editable-date {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .editable-date .btn-icon {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .data-table tbody tr:hover .editable-date .btn-icon {
            opacity: 1;
        }
        
        td.editable-reason {
            cursor: pointer;
            text-decoration: underline dotted;
        }
        td.editable-reason:hover {
            background-color: #f8f9fa;
        }
        .table-container {
            overflow-x: auto;
            overflow-y: visible;
        }
        
        .actions-cell {
            white-space: nowrap;
            position: relative;
        }
        .actions-cell .btn {
            margin-right: 5px;
        }
        
        /* Dropdown Menu Styles */
        .actions-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .actions-dropdown-btn {
            background: #4f46e5;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        
        .actions-dropdown-btn:hover {
            background: #4338ca;
        }
        
        .actions-dropdown-content {
            display: none;
            position: fixed;
            background: white;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 8px;
            z-index: 10000;
            margin-top: 5px;
            overflow: visible;
            border: 1px solid #e5e7eb;
        }
        
        .actions-dropdown.active .actions-dropdown-content {
            display: block;
        }
        
        .actions-dropdown-content button {
            width: 100%;
            padding: 10px 15px;
            border: none;
            background: white;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #374151;
        }
        
        .actions-dropdown-content button:hover {
            background: #f3f4f6;
        }
        
        .actions-dropdown-content button:not(:last-child) {
            border-bottom: 1px solid #f3f4f6;
        }
        
        .actions-dropdown-content button.danger {
            color: #dc2626;
        }
        
        .actions-dropdown-content button.danger:hover {
            background: #fee2e2;
        }


        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: none;
            cursor: pointer;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-active { background: #d4edda; color: #155724; }
        .status-expired { background: #f8d7da; color: #721c24; }
        .status-paid { background: #d1ecf1; color: #0c5460; }
        .status-unpaid { background: #f5c6cb; color: #721c24; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-overdue { background: #f8d7da; color: #721c24; }
        .status-present { background: #d4edda; color: #155724; }
        .status-absent { background: #f8d7da; color: #721c24; }

        .modal {
            display: none;
            position: fixed;
            z-index: 99999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            overflow-y: auto; /* ‚úÖ Scroll ekle */
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh; /* ‚úÖ Maksimum y√ºkseklik */
            overflow-y: auto; /* ‚úÖ ƒ∞√ßerik overflow olursa scroll */
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover { color: var(--danger-color); }

        /* Tab Styles */
        .customer-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin: 20px 0;
            gap: 5px;
        }
        
        .tab-button {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tab-button:hover {
            color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }
        
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .branch-tab-content {
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .branch-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .branch-info-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
        
        .branch-info-item strong {
            font-size: 11px;
            color: #666;
            display: block;
            margin-bottom: 5px;
        }
        
        .branch-info-item span {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        /* Modern Schedule Styles */
        #unassigned-groups-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            background: var(--light-color);
            border-radius: 10px;
            margin-bottom: 20px;
            min-height: 40px;
        }
        .unassigned-group {
            background: white;
            padding: 5px 12px;
            border-radius: 20px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-weight: 500;
            font-size: 0.9em;
        }
        .unassigned-group:active { cursor: grabbing; }
        
        .schedule-row {
            display: grid;
            gap: 10px;
            margin-top: 10px;
        }
        .schedule-row:first-child {
            margin-top: 0;
        }
        .schedule-row.weekday-row {
             grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }
        .schedule-row.weekend-row {
             grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }

        .schedule-day {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            min-height: 200px;
            transition: background-color 0.2s;
        }
        .schedule-day.drag-over {
             background-color: #e9eefe;
        }
        .schedule-day.is-holiday {
            background-color: #f1f3f5;
            opacity: 0.7;
        }

        .schedule-day h4 {
            text-align: center;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .lesson-block {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 8px 10px;
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 0.85em;
            position: relative;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .lesson-block.trial-lesson {
            background: linear-gradient(135deg, var(--info-color), #148a9b);
        }
        
        .delete-lesson-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: background 0.2s, opacity 0.2s;
            opacity: 0;
        }
        .lesson-block:hover .delete-lesson-btn {
            opacity: 1;
        }
        .delete-lesson-btn:hover {
            background: var(--danger-color);
        }
        .lesson-block.empty-slot .delete-lesson-btn {
            opacity: 1;
            background: rgba(0,0,0,0.1);
        }
        .lesson-block.empty-slot .delete-lesson-btn:hover {
             background: rgba(0,0,0,0.2);
        }

        .lesson-block.empty-slot {
            background: #fffbe6;
            color: #856404;
            border: 1px dashed #ffeeba;
            justify-content: center;
            align-items: center;
            display: flex;
            flex-direction: column;
            cursor: default;
        }
         .lesson-block.empty-slot:hover {
            background: #fff9d7;
        }


        .time-editor {
            font-size: 0.9em;
            cursor: pointer;
        }
        .time-editor input {
            width: 70px;
        }
        .time-editor button {
            padding: 2px 5px;
            font-size: 0.8em;
        }

        #member-tooltip {
            display: none;
            position: absolute;
            background: var(--dark-color);
            color: white;
            padding: 10px;
            border-radius: 8px;
            z-index: 1001;
            pointer-events: none;
            font-size: 0.9em;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #member-tooltip ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        /* Modern Payment List */
        .payment-member-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .payment-member-item {
            background: white;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .payment-member-header {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--light-color);
        }
        .payment-member-header:hover {
            background: #e9ecef;
        }
        .payment-member-info {
            flex-grow: 1;
            cursor: pointer;
        }
        .status-container {
            cursor: pointer;
        }
        .payment-details {
            padding: 20px;
            display: none; /* Collapsed by default */
        }
        .payment-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .payment-details .data-table {
            box-shadow: none;
            border-radius: 0;
        }
        .status-container {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            flex-shrink: 0;
        }
        .sub-status {
            font-size: 0.8em;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }
        .sub-status.pending {
            background-color: var(--warning-color);
            color: #333;
        }
        .sub-status.expired {
            background: #f8d7da;
            color: #721c24;
        }
        .sub-status.group-name {
            background-color: #e9ecef;
            color: #495057;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-top: 4px solid var(--primary-color);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1.1em;
        }

        .stat-comparison {
            font-size: 0.9em;
            font-weight: bold;
        }
        .stat-comparison.increase { color: var(--success-color); }
        .stat-comparison.decrease { color: var(--danger-color); }
        
        #groupsList {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        #groupsList h2.group-category-title {
            font-size: 1.5em;
            color: var(--primary-color);
            margin-top: 20px;
            margin-bottom: 0px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--border-color);
        }
         #groupsList h2.group-category-title:first-of-type {
            margin-top: 0;
        }

        .group-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            border-left: 5px solid var(--primary-color);
            display: flex;
            flex-direction: column;
            transition: all 0.2s ease-in-out;
        }
        .group-card.group-card-trial {
            border-left-color: var(--info-color);
        }
        .group-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .group-card h4 {
            font-size: 1.1em;
            margin-bottom: 8px;
        }
        .group-card p {
            font-size: 0.9em;
            margin-bottom: 5px;
            color: #555;
        }
        .group-members {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
            flex-grow: 1;
        }

        .member-tag {
            background: var(--light-color);
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.85em;
            border: 1px solid var(--border-color);
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .group-card-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            gap: 10px;
        }
        
        .qr-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            gap: 15px;
            text-align: center;
        }
        
        .qr-loading .spinner {
            width: 40px;
            height: 40px;
            border-width: 4px;
        }
        
        .qr-loading p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: #666;
            width: 100%;
        }

        .empty-state h3 {
            margin-bottom: 8px;
            color: var(--primary-color);
            font-size: 16px;
        }
        
        .empty-state p {
            font-size: 13px;
        }

        /* CRM Tags Styles */
        .tags-category-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 50px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .tag-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: white;
            border-radius: 16px;
            border: 1.5px solid #e0e0e0;
            font-size: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .tag-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border-color: var(--primary-color);
        }

        .tag-item .tag-name {
            font-weight: 500;
        }

        .tag-item .tag-count {
            background: rgba(0,0,0,0.05);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
        }

        .tag-item .tag-actions {
            display: flex;
            gap: 4px;
            margin-left: 4px;
        }

        .tag-item .tag-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 13px;
            padding: 2px 4px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .tag-item .tag-actions button:hover {
            opacity: 1;
        }

        .tag-item.status-tag {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%);
        }

        .tag-item.branch-tag {
            border-color: #f093fb;
            background: linear-gradient(135deg, rgba(240, 147, 251, 0.1) 0%, rgba(245, 87, 108, 0.05) 100%);
        }

        .tag-item.custom-tag {
            border-color: #43e97b;
            background: linear-gradient(135deg, rgba(67, 233, 123, 0.1) 0%, rgba(56, 249, 215, 0.05) 100%);
        }

        /* Filtered Customer Item */
        .filtered-customer-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .filtered-customer-item:hover {
            transform: translateX(3px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border-color: var(--primary-color);
        }

        .filtered-customer-item .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .filtered-customer-item .customer-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .filtered-customer-item .customer-status {
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .filtered-customer-item .customer-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 8px;
            margin-top: 8px;
            font-size: 13px;
        }

        .filtered-customer-item .customer-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }

        .filtered-customer-item .customer-tag {
            padding: 2px 8px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            font-size: 10px;
            color: #667eea;
        }

        /* Trial Item */
        .trial-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
            border-left: 3px solid #667eea;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .trial-item:hover {
            transform: translateX(3px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        .trial-item.scheduled {
            border-left-color: #4facfe;
        }

        .trial-item.completed {
            border-left-color: #43e97b;
        }

        .trial-item.cancelled {
            border-left-color: #f5576c;
            opacity: 0.7;
        }

        .trial-item.converted {
            border-left-color: #f093fb;
        }

        .trial-item .trial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .trial-item .trial-customer {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .trial-item .trial-status {
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .trial-item .trial-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            font-size: 12px;
            color: #666;
        }

        /* WhatsApp Styles */
        .whatsapp-contact-item {
            padding: 14px;
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
        }
        
        .whatsapp-contact-item:hover {
            background: rgba(245, 246, 246, 0.95);
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .whatsapp-contact-item.active {
            background: linear-gradient(135deg, rgba(37, 211, 102, 0.15) 0%, rgba(37, 211, 102, 0.05) 100%);
            border-left: 4px solid #25d366;
            box-shadow: 0 2px 12px rgba(37, 211, 102, 0.2);
        }
        
        #whatsapp-messages-area {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            backdrop-filter: blur(10px);
            position: relative;
        }
        
        #whatsapp-messages-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="10" cy="10" r="1" fill="%23ffffff" opacity="0.3"/><circle cx="30" cy="25" r="1" fill="%23ffffff" opacity="0.2"/><circle cx="60" cy="15" r="1" fill="%23ffffff" opacity="0.25"/><circle cx="80" cy="40" r="1" fill="%23ffffff" opacity="0.3"/><circle cx="45" cy="60" r="1" fill="%23ffffff" opacity="0.2"/></svg>');
            opacity: 0.4;
            pointer-events: none;
        }
        
        .whatsapp-message-wrapper {
            display: flex;
            margin-bottom: 8px;
            clear: both;
        }
        
        .whatsapp-message-wrapper.sent {
            justify-content: flex-end;
        }
        
        .whatsapp-message-wrapper.received {
            justify-content: flex-start;
        }
        
        .whatsapp-message {
            max-width: 65%;
            padding: 8px 12px 6px 12px;
            border-radius: 8px;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
            transition: box-shadow 0.2s ease;
        }
        
        .whatsapp-message:hover {
            box-shadow: 0 2px 2px rgba(0,0,0,0.15);
        }
        
        .whatsapp-message.sent {
            background: #D9FDD3;
            border-radius: 8px 8px 0 8px;
        }
        
        .whatsapp-message.received {
            background: #FFFFFF;
            border-radius: 8px 8px 8px 0;
        }
        
        .whatsapp-message .message-content {
            margin-bottom: 2px;
            color: #111;
            font-size: 14.2px;
            line-height: 19px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        
        .whatsapp-message .message-time {
            font-size: 11px;
            color: rgba(0,0,0,0.45);
            text-align: right;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 3px;
        }
        
        .message-check {
            color: #53bdeb;
            font-size: 14px;
        }
        
        .message-date-divider {
            text-align: center;
            margin: 15px auto;
            padding: 6px 12px;
            background: rgba(225, 245, 254, 0.92);
            border-radius: 8px;
            font-size: 12.5px;
            color: #667781;
            display: inline-block;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
            font-weight: 500;
            border-radius: 7.5px;
            font-size: 12.5px;
            color: #54656f;
            position: relative;
            z-index: 1;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
        }
        
        #whatsapp-chat-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        #whatsapp-message-input {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }
        
        #whatsapp-message-text {
            border: 2px solid rgba(100, 100, 100, 0.2);
            border-radius: 24px;
            padding: 12px 18px;
            transition: all 0.3s ease;
        }
        
        #whatsapp-message-text:focus {
            border-color: #25d366;
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
            outline: none;
        }
        
        #whatsapp-message-text {
            border-radius: 21px;
            border: 1px solid #d1d7db;
            padding: 9px 12px;
            font-size: 15px;
        }
        
        .recipient-status-badge {
            float: right;
            margin-top: 5px;
        }
        
        .bulk-recipient-checkbox {
            margin-right: 10px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .actions-container {
            position: relative;
        }
        #context-menu {
            display: none;
            position: fixed;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            z-index: 1001;
            min-width: 200px;
            overflow: hidden;
        }
        #context-menu.active {
            display: block;
        }
        #context-menu a {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            color: var(--dark-color);
            text-decoration: none;
            font-size: 0.9em;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        #context-menu a:hover {
            background-color: #f8f9fa;
        }
        #context-menu a.danger {
            color: var(--danger-color);
        }
        #context-menu a.danger:hover {
            background-color: #fff2f4;
        }

        #phone-context-menu {
            display: none;
            position: fixed;
            z-index: 1002;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        #phone-context-menu button {
            display: block;
            width: 100%;
            padding: 12px 20px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
        }
        #phone-context-menu button:hover {
            background: #f8f9fa;
        }
        
        /* Task Messages Styles */
        .task-message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            max-width: 80%;
        }
        
        .task-message-mine {
            background: var(--primary-color);
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .task-message-other {
            background: white;
            border: 1px solid #e0e0e0;
            margin-right: auto;
        }
        
        .task-message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85em;
        }
        
        .task-message-mine .task-message-header {
            flex-direction: row-reverse;
        }
        
        .task-message-time {
            opacity: 0.7;
            font-size: 0.9em;
        }
        
        .task-message-body {
            word-wrap: break-word;
        }
        
        .task-message-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .task-message-delete:hover {
            background: var(--danger-color);
        }
        
        .task-message {
            position: relative;
        }
        
        .badge {
            background: var(--danger-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            margin-left: 5px;
        }


        .group-selection-list, .group-members-list, .attendance-list {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .group-selection-item {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .group-selection-item:hover {
            background: #f8f9ff;
            border-color: var(--primary-color);
        }
        .member-item, .attendance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--light-color);
            border-radius: 5px;
            gap: 10px;
        }
        .attendance-item label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            flex-grow: 1;
        }
        .reason-input {
            flex-shrink: 1;
            min-width: 150px;
        }

        .holiday-settings-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        .holiday-settings-grid label {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .registration-forms-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }
        .registration-form-wrapper {
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 10px;
        }

        .searchable-select-container {
            position: relative;
        }
        .searchable-select-results {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        .searchable-select-results.active {
            display: block;
        }
        .searchable-select-item {
            padding: 10px 15px;
            cursor: pointer;
        }
        .searchable-select-item:not(.disabled):hover {
            background: #f0f0f0;
        }
        .searchable-select-item.disabled {
            cursor: not-allowed;
            color: #999;
        }

        a.phone-link {
            color: inherit;
            text-decoration: none;
        }
        a.phone-link:hover {
            text-decoration: underline;
        }

        .member-name-link {
            color: var(--dark-color);
            text-decoration: none;
            transition: color 0.2s;
        }
        .member-name-link:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }

        .absence-item, .birthday-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .absence-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .absence-item:hover {
            background-color: var(--light-color);
        }
        .absence-item:last-child, .birthday-item:last-child {
            border-bottom: none;
        }
        .absence-reason {
            color: #555;
            font-size: 0.9em;
            font-style: italic;
        }
        .birthday-icon {
            font-size: 1.5em;
        }
        
        .member-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .detail-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .detail-item strong {
            display: block;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 15px;
        }
        .pagination-controls .btn {
            text-transform: none;
        }
        .pagination-controls .page-info-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .attendance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            padding: 0;
            margin-bottom: 20px;
        }

        .modern-title {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            font-weight: 700;
            display: inline-block;
            font-size: 2.2em;
        }

        .member-info-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        @media (min-width: 768px) {
            .member-info-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        .member-info-main, .member-info-contact {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .member-info-contact h4 {
            font-size: 1.1em;
            color: var(--dark-color);
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--primary-color);
        }

        .contact-card {
            background: var(--light-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .contact-card-header {
            background: #e9ecef;
            padding: 8px 12px;
            font-weight: 600;
            font-size: 0.9em;
            color: #495057;
        }
        .contact-card-body {
            padding: 12px;
        }
        .contact-card-body p {
            margin-bottom: 8px;
            font-size: 1em;
        }
        .contact-card-body p:last-child {
            margin-bottom: 0;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 992px) {
            .current-user-display { display: none; }
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
                transition: width 0.3s ease;
            }
            
            .sidebar:hover {
                width: 260px;
            }
            
            .sidebar-header h2 {
                font-size: 24px;
                text-align: center;
            }
            
            .sidebar:not(:hover) .nav-text {
                display: none;
            }
            
            .sidebar:not(:hover) .dropdown-arrow {
                display: none;
            }
            
            .sidebar:not(:hover) .sidebar-header h2 span {
                display: none;
            }
            
            .sidebar:not(:hover) .current-user-display {
                display: none;
            }
            
            .sidebar:not(:hover) .nav-btn {
                justify-content: center;
            }
            
            .main-content-wrapper {
                margin-left: 70px;
                width: calc(100% - 70px);
            }
            
            .admin-content { 
                padding: 15px;
            }
            
            .form-grid { 
                grid-template-columns: 1fr; 
            }
            
            .modal-content { 
                width: 95%; 
                margin: 10% auto; 
                padding: 20px; 
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .pagination-controls {
                flex-direction: column;
            }
            
            .card-title {
                flex-direction: column;
                gap: 10px;
            }
            
            /* ‚úÖ CRM Mobil Uyumluluk - Geli≈ütirilmi≈ü */
            .crm-grid {
                grid-template-columns: 1fr !important;
            }
            
            .crm-tabs {
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                margin-bottom: 15px;
            }
            
            .crm-tab-button {
                font-size: 12px !important;
                padding: 8px 12px !important;
            }
            
            .crm-card {
                margin-bottom: 15px;
            }
            
            .crm-card-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .crm-card-actions button {
                width: 100%;
            }
            
            /* üì± Tablo -> Kart G√∂r√ºn√ºm√º (T√úM TABLOLAR) */
            .data-table,
            #crm-leads-list table,
            #member-payment-list table,
            table.data-table {
                display: block !important;
                overflow-x: visible !important;
            }
            
            .data-table thead,
            #crm-leads-list thead,
            #member-payment-list thead,
            table.data-table thead {
                display: block !important;
            }
            
            .data-table thead tr,
            #crm-leads-list thead tr,
            #member-payment-list thead tr,
            table.data-table thead tr {
                position: absolute !important;
                top: -9999px !important;
                left: -9999px !important;
            }
            
            .data-table tbody,
            #crm-leads-list tbody,
            #member-payment-list tbody,
            table.data-table tbody {
                display: block !important;
            }
            
            .data-table tr,
            #crm-leads-list tr,
            #member-payment-list tr,
            table.data-table tr {
                display: block !important;
                border: 1px solid #ddd !important;
                margin-bottom: 15px !important;
                border-radius: 8px !important;
                background: white !important;
                padding: 15px !important;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            }
            
            .data-table td,
            #crm-leads-list td,
            #member-payment-list td,
            table.data-table td {
                display: block !important;
                border: none !important;
                position: relative !important;
                padding: 8px 0 !important;
                padding-left: 45% !important;
                text-align: left !important;
                word-wrap: break-word !important;
            }
            
            .data-table td:before,
            #crm-leads-list td:before,
            #member-payment-list td:before,
            table.data-table td:before {
                content: attr(data-label) !important;
                position: absolute !important;
                left: 10px !important;
                width: 40% !important;
                padding-right: 10px !important;
                white-space: nowrap !important;
                font-weight: 600 !important;
                color: #666 !important;
                font-size: 12px !important;
            }
            
            /* CRM Leads √∂zel etiketleri */
            #crm-leads-list td:nth-of-type(1):before { content: "Ad Soyad:" !important; }
            #crm-leads-list td:nth-of-type(2):before { content: "Telefon:" !important; }
            #crm-leads-list td:nth-of-type(3):before { content: "Bran≈ü:" !important; }
            #crm-leads-list td:nth-of-type(4):before { content: "Durum:" !important; }
            #crm-leads-list td:nth-of-type(5):before { content: "Kaynak:" !important; }
            #crm-leads-list td:nth-of-type(6):before { content: "Deneme:" !important; }
            #crm-leads-list td:nth-of-type(7):before { content: "Olu≈üturma:" !important; }
            #crm-leads-list td:nth-of-type(8):before { content: "ƒ∞≈ülemler:" !important; }
            
            /* Son s√ºtun (ƒ∞≈ülemler) √∂zel stil */
            .data-table td:last-child,
            #crm-leads-list td:last-child,
            table.data-table td:last-child {
                padding-left: 10px !important;
                display: flex !important;
                gap: 5px !important;
                flex-wrap: wrap !important;
                margin-top: 10px !important;
                padding-top: 10px !important;
                border-top: 1px solid #eee !important;
            }
            
            .data-table td:last-child button,
            #crm-leads-list td:last-child button,
            table.data-table td:last-child button {
                flex: 1 1 auto !important;
                min-width: 80px !important;
            }
            
            .data-table td:last-child:before,
            #crm-leads-list td:last-child:before,
            table.data-table td:last-child:before {
                display: none !important;
            }
            
            /* Checkbox ve radio h√ºcreler */
            .data-table td:first-child:has(input[type="checkbox"]),
            table.data-table td:first-child:has(input[type="checkbox"]) {
                padding-left: 10px !important;
            }
            
            .data-table td:first-child:has(input[type="checkbox"]):before,
            table.data-table td:first-child:has(input[type="checkbox"]):before {
                display: none !important;
            }
            
            /* üì± CRM Dashboard Stats Grid */
            #crm-dashboard .stats-grid,
            #branch-tag-stats {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            .stat-card {
                padding: 15px !important;
            }
            
            .stat-number {
                font-size: 24px !important;
            }
            
            .stat-label {
                font-size: 13px !important;
            }
            
            /* üì± CRM Filtreler Mobil */
            #crm-filter .form-grid,
            .filter-controls {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            #crm-filter select,
            #crm-filter input {
                font-size: 14px !important;
            }
            
            /* üì± CRM Modal Detay Sayfasƒ± */
            #customer-detail-content {
                padding: 10px !important;
            }
            
            .customer-detail-header {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .customer-detail-tabs {
                overflow-x: auto !important;
                white-space: nowrap !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            .customer-detail-tabs button {
                font-size: 12px !important;
                padding: 8px 12px !important;
            }
            
            /* üì± CRM Notlar ve Ge√ßmi≈ü */
            .note-item,
            .history-item {
                padding: 10px !important;
                font-size: 13px !important;
            }
            
            /* üì± CRM Etiket Y√∂netimi */
            .tag-badge {
                font-size: 11px !important;
                padding: 4px 8px !important;
            }
            
            /* Gelen/Giden Aramalar Grid */
            div[style*="grid-template-columns: repeat(auto-fill"] {
                grid-template-columns: 1fr !important;
            }
            
            /* üì± Gelen Aramalar Kart G√∂r√ºn√ºm√º */
            .call-card {
                padding: 12px !important;
                margin-bottom: 10px !important;
            }
            
            .call-card-header {
                flex-direction: column !important;
                gap: 5px !important;
                align-items: flex-start !important;
            }
            
            .call-card-actions {
                display: flex !important;
                flex-direction: column !important;
                gap: 5px !important;
                width: 100% !important;
                margin-top: 10px !important;
            }
            
            .call-card-actions button {
                width: 100% !important;
                font-size: 12px !important;
            }
            
            /* üì± Arama Sekmeleri */
            .incoming-calls-tabs {
                overflow-x: auto !important;
                white-space: nowrap !important;
                -webkit-overflow-scrolling: touch !important;
                padding-bottom: 5px !important;
            }
            
            .incoming-calls-tabs button {
                font-size: 11px !important;
                padding: 8px 10px !important;
                min-width: auto !important;
            }
            
            /* Dropdown men√ºler mobilde √ºstte g√∂ster */
            div[id^="dropdown-"] {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                width: 90% !important;
                max-width: 300px !important;
                z-index: 999999 !important;
            }
            
            /* Modal i√ßerikleri mobilde scroll */
            .modal-body {
                max-height: 70vh;
                overflow-y: auto;
            }
            
            /* üì± Form Inputlar Mobilde Daha B√ºy√ºk */
            .form-control,
            input[type="text"],
            input[type="tel"],
            input[type="email"],
            input[type="date"],
            input[type="datetime-local"],
            select,
            textarea {
                font-size: 16px !important; /* iOS zoom engellemek i√ßin */
            }
            
            /* üì± Butonlar Mobilde Touch-Friendly */
            .btn {
                min-height: 44px !important;
                padding: 10px 15px !important;
            }
            
            .btn-sm {
                min-height: 36px !important;
                padding: 8px 12px !important;
            }
        }
        
        /* üì± √áok K√º√ß√ºk Ekranlar (Telefonlar) */
        @media (max-width: 480px) {
            .sidebar {
                width: 60px !important;
            }
            
            .sidebar:hover {
                width: 220px !important;
            }
            
            .main-content-wrapper {
                margin-left: 60px !important;
                width: calc(100% - 60px) !important;
            }
            
            .admin-content {
                padding: 10px !important;
            }
            
            /* CRM Leads Kart D√ºzeni */
            #crm-leads-list td {
                padding-left: 50% !important;
                font-size: 13px !important;
            }
            
            #crm-leads-list td:before {
                width: 45% !important;
                font-size: 11px !important;
            }
            
            #crm-leads-list tr {
                padding: 12px !important;
            }
            
            /* Modal Tam Ekran */
            .modal-content {
                width: 100% !important;
                height: 100vh !important;
                margin: 0 !important;
                border-radius: 0 !important;
                max-height: 100vh !important;
            }
            
            .modal-header {
                padding: 12px !important;
            }
            
            .modal-body {
                padding: 12px !important;
                max-height: calc(100vh - 120px) !important;
            }
            
            /* CRM Dashboard */
            .stat-card {
                padding: 12px !important;
            }
            
            .stat-number {
                font-size: 20px !important;
            }
            
            .stat-label {
                font-size: 11px !important;
            }
            
            /* Ba≈ülƒ±klar */
            h2 {
                font-size: 18px !important;
            }
            
            h3 {
                font-size: 16px !important;
            }
            
            /* Sekme Butonlarƒ± */
            .crm-tab-button,
            .customer-detail-tabs button,
            .incoming-calls-tabs button {
                font-size: 10px !important;
                padding: 6px 8px !important;
            }
            
            /* Tablo Butonlarƒ± */
            #crm-leads-list td:last-child button {
                min-width: 70px !important;
                font-size: 11px !important;
                padding: 6px 8px !important;
            }
        }
        
        @media (min-width: 769px) {
            .admin-content {
                max-width: 1600px;
                margin: 0 auto;
            }
        }
        
        /* Settings Subsection Styling */
        .settings-subsection {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2f9 100%);
            border: 1px solid #e0e5f0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.3s ease;
        }
        
        .settings-subsection:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }
        
        .settings-subtitle {
            font-size: 1.3em;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-subsection textarea.form-control {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            transition: all 0.2s ease;
            resize: vertical;
            min-height: 120px;
        }
        
        .settings-subsection textarea.form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: #fafbff;
        }
        
        .settings-subsection small {
            display: inline-block;
            margin-top: 6px;
            padding: 6px 12px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }
        
        .settings-subsection small code {
            background: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
            color: #667eea;
            border: 1px solid #e2e8f0;
        }
    </style>
    <!-- SheetJS for Excel export with dropdowns -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body style="visibility: hidden;">
    <div id="main-wrapper" style="display: flex;">
        <!-- ‚úÖ Sol Sidebar Men√º -->
        <nav class="sidebar">
            <div class="sidebar-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h2>üèÜ <span id="club-title">Sporcum</span></h2>
                <button onclick="toggleSidebar()" style="background: transparent; border: none; color: white; font-size: 20px; cursor: pointer; padding: 5px;" title="Men√ºy√º a√ß/kapat">
                    ‚ò∞
                </button>
            </div>
            
            <div class="sidebar-menu">
                <!-- Ana Sayfa -->
                <button class="nav-btn active" onclick="showSection('dashboard', this)">
                    <span class="nav-icon">üìä</span>
                    <span class="nav-text">Ana Sayfa</span>
                </button>
                
                <!-- Y√∂netim Dropdown -->
                <div class="nav-dropdown">
                    <button class="nav-btn dropdown-toggle" onclick="toggleDropdown(this)">
                        <span class="nav-icon">üõ†Ô∏è</span>
                        <span class="nav-text">Y√∂netim</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </button>
                    <div class="dropdown-content">
                        <button class="nav-btn sub-item" onclick="showSection('registration-procedures', this)">
                            <span class="nav-text">üìë Kayƒ±t ƒ∞≈ülemleri</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('members', this); hideMemberDetail()">
                            <span class="nav-text">üë• √úyeler</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('pending-members', this)">
                            <span class="nav-text">‚è≥ Bekleyen √úyeler</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('inactive-members', this)">
                            <span class="nav-text">‚è∏Ô∏è Pasif √úyeler</span>
                        </button>
                        
                        <!-- Muhasebe Alt Dropdown -->
                        <div class="nav-dropdown sub-dropdown">
                            <button class="nav-btn sub-item dropdown-toggle" onclick="toggleDropdown(this); event.stopPropagation();">
                                <span class="nav-text">üíµ Muhasebe</span>
                                <span class="dropdown-arrow">‚ñº</span>
                            </button>
                            <div class="dropdown-content">
                                <button class="nav-btn sub-sub-item" onclick="showSection('payments', this)">
                                    <span class="nav-text">Aidatlar</span>
                                </button>
                                <button class="nav-btn sub-sub-item" onclick="showSection('expenses', this)">
                                    <span class="nav-text">Giderler</span>
                                </button>
                                <button class="nav-btn sub-sub-item" onclick="showSection('accounting-summary', this)">
                                    <span class="nav-text">Muhasebe √ñzeti</span>
                                </button>
                                <button class="nav-btn sub-sub-item" onclick="showSection('products', this)">
                                    <span class="nav-text">√úr√ºnler</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Eƒüitim/Sportif Faaliyetler Dropdown -->
                <div class="nav-dropdown">
                    <button class="nav-btn dropdown-toggle" onclick="toggleDropdown(this)">
                        <span class="nav-icon">üéæ</span>
                        <span class="nav-text">Eƒüitim/Sportif</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </button>
                    <div class="dropdown-content">
                        <button class="nav-btn sub-item" onclick="showSection('schedule', this)">
                            <span class="nav-text">üìÖ Ders Planƒ±</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('groups', this)">
                            <span class="nav-text">‚≠ê Gruplar</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('tasks', this)">
                            <span class="nav-text">‚úÖ G√∂revlerim</span>
                        </button>
                    </div>
                </div>
                
                <!-- ƒ∞leti≈üim Dropdown -->
                <div class="nav-dropdown">
                    <button class="nav-btn dropdown-toggle" onclick="toggleDropdown(this)">
                        <span class="nav-icon">üìû</span>
                        <span class="nav-text">ƒ∞leti≈üim</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </button>
                    <div class="dropdown-content">
                        <button class="nav-btn sub-item" onclick="showSection('whatsapp', this)">
                            <span class="nav-text">üí¨ WhatsApp</span>
                        </button>
                        
                        <!-- CRM Alt Dropdown -->
                        <div id="crm-menu-dropdown" class="nav-dropdown sub-dropdown">
                            <button class="nav-btn sub-item dropdown-toggle" onclick="toggleDropdown(this); event.stopPropagation();">
                                <span class="nav-text">üë§ CRM</span>
                                <span class="dropdown-arrow">‚ñº</span>
                            </button>
                            <div class="dropdown-content">
                                <button class="nav-btn sub-sub-item" onclick="showSection('crm', this)">
                                    <span class="nav-text">CRM Ana Sayfa</span>
                                </button>
                                <button class="nav-btn sub-sub-item" onclick="showSection('crm-incoming-calls', this)">
                                    <span class="nav-text">Gelen Aramalar</span>
                                </button>
                                <button class="nav-btn sub-sub-item" onclick="showSection('crm-outgoing-calls', this)">
                                    <span class="nav-text">Giden Aramalar</span>
                                </button>
                                <button class="nav-btn sub-sub-item" onclick="showSection('crm-filter', this)">
                                    <span class="nav-text">M√º≈üteri Filtrele</span>
                                </button>
                                <button class="nav-btn sub-sub-item" onclick="showSection('crm-trials', this)">
                                    <span class="nav-text">Denemeler</span>
                                </button>
                                <button class="nav-btn sub-sub-item" onclick="showSection('crm-tags', this)">
                                    <span class="nav-text">Etiketler</span>
                                </button>
                                <button class="nav-btn sub-sub-item" onclick="showSection('crm-templates', this)">
                                    <span class="nav-text">CRM Mesaj ≈ûablonlarƒ±</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ayarlar (En Alt) -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid rgba(255,255,255,0.1);">
                    <button class="nav-btn" onclick="showSection('settings', this)">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span class="nav-text">Ayarlar</span>
                    </button>
                    <button class="nav-btn" onclick="showSection('user-activities', this)">
                        <span class="nav-icon">üìù</span>
                        <span class="nav-text">Kullanƒ±cƒ± Hareketleri</span>
                    </button>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="current-user-display" style="margin-bottom: 10px; font-size: 12px;"></div>
                <button id="logout-btn-sidebar" class="btn btn-danger" style="width: 100%; padding: 10px; font-size: 13px;">
                    üö™ √áƒ±kƒ±≈ü Yap
                </button>
            </div>
        </nav>

        <!-- ‚úÖ Ana ƒ∞√ßerik Alanƒ± -->
        <div class="main-content-wrapper">
            <div class="admin-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                    <h2 class="card-title" style="margin: 0;">Ana Sayfa</h2>
                    <button id="toggle-dashboard-amounts-btn" onclick="toggleDashboardAmounts()" style="background: none; border: none; cursor: pointer; font-size: 20px; padding: 5px; transition: all 0.2s;" title="Tutarlarƒ± Gizle/G√∂ster">
                        üëÅÔ∏è
                    </button>
                </div>
                <div class="stats-grid" id="dashboard-stats-grid">
                    <div class="stat-card" onclick="navigateToSection('members')">
                        <div class="stat-number" id="totalMembers">0</div>
                        <div class="stat-label">Toplam √úye</div>
                    </div>
                    <div class="stat-card" onclick="navigateToSection('members')">
                        <div class="stat-number" id="activeMembers">0</div>
                        <div class="stat-label">Aktif √úye</div>
                    </div>
                    <div class="stat-card" onclick="navigateToSection('registration-procedures')">
                        <div class="stat-number" id="pendingRegistrations">0</div>
                        <div class="stat-label">Bekleyen Kayƒ±tlar</div>
                    </div>
                    <div class="stat-card" onclick="navigateToSection('inactive-members')">
                        <div class="stat-number" id="inactiveMembers">0</div>
                        <div class="stat-label">Pasif √úyeler</div>
                    </div>
                    <div class="stat-card" onclick="navigateToSection('payments')">
                        <div class="stat-number" id="monthlyRevenue">0‚Ç∫</div>
                        <div class="stat-label">Bu Ay Toplam Ciro</div>
                        <div class="stat-comparison" id="revenueComparison"></div>
                    </div>
                </div>
                
                <div class="dashboard-grid">
                    <div class="card">
                        <h3 class="card-title" style="cursor: pointer;" onclick="showSection('attendance-tracking', document.querySelector('.nav-btn[onclick*=attendance]'))">üèÉ‚Äç‚ôÇÔ∏è Son Devamsƒ±zlƒ±klar</h3>
                        <div id="absentStudentsList">
                            <div class="loading">
                                <div class="spinner"></div>
                                <span>Y√ºkleniyor...</span>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">üéÇ Yakla≈üan Doƒüum G√ºnleri</h3>
                        <div id="upcomingBirthdaysList">
                             <div class="loading">
                                <div class="spinner"></div>
                                <span>Y√ºkleniyor...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Registration Procedures Section -->
            <div id="registration-procedures" class="section">
                <div class="card">
                    <h3 class="card-title">Yeni Kayƒ±t Ekle</h3>
                    <div class="registration-forms-container">
                        <div class="registration-form-wrapper">
                             <h4 style="font-size: 1.2em; margin-bottom: 15px;">üìù Yeni Kayƒ±t Olu≈ütur</h4>
                             <form id="preRegistrationForm">
                                 <div class="form-grid">
                                     <div class="form-group"><label for="memberTypePre">Kayƒ±t Tipi *</label><select class="form-control" name="memberType" id="memberTypePre" required><option value="child">√áocuk</option><option value="adult">Yeti≈ükin</option></select></div>
                                     <div class="form-group" id="parentName1Group"><label for="parentNamePre">Veli Adƒ± Soyadƒ± *</label><input type="text" id="parentNamePre" class="form-control" name="parentName"></div>
                                     <div class="form-group" id="phone1Group"><label for="preRegPhonePre">Veli Telefon *</label><input type="tel" id="preRegPhonePre" class="form-control" name="phone" required pattern="0[0-9]{10}" maxlength="11"></div>
                                     <div class="form-group" id="parentName2Group"><label for="parentName2Pre">Veli 2 Adƒ± Soyadƒ± (ƒ∞steƒüe Baƒülƒ±)</label><input type="text" id="parentName2Pre" class="form-control" name="parentName2"></div>
                                     <div class="form-group" id="phone2Group"><label for="preRegPhone2Pre">Veli 2 Telefon</label><input type="tel" id="preRegPhone2Pre" class="form-control" name="phone2" pattern="0[0-9]{10}" maxlength="11"></div>
                                     <div class="form-group"><label for="preRegBranchPre">Bran≈ü *</label><select class="form-control" name="branch" id="preRegBranchPre" required><option value="">Se√ßiniz...</option><option value="tenis">üéæ Tenis</option><option value="yuzme">üèä Y√ºzme</option></select></div>
                                 </div>
                                 
                                 <!-- √ñƒürenci Bilgileri (√áoklu) -->
                                 <div id="studentsContainer" style="display: none; margin-top: 20px;">
                                     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                         <h4 style="margin: 0;">üë∂ √ñƒürenci Bilgileri</h4>
                                         <button type="button" class="btn btn-sm btn-success" onclick="addStudentField()" id="addStudentBtn">‚ûï √ñƒürenci Ekle</button>
                                     </div>
                                     <p style="font-size: 13px; color: #666; margin-bottom: 15px;">‚ÑπÔ∏è Her √∂ƒürenci i√ßin ayrƒ± kayƒ±t ve √∂deme planƒ± olu≈üturulacaktƒ±r.</p>
                                     <div id="studentFieldsContainer">
                                         <div class="student-field-group" data-student-index="0">
                                             <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; position: relative; border-left: 4px solid #4CAF50;">
                                                 <h5 style="margin: 0 0 15px 0; color: #333;">√ñƒürenci 1</h5>
                                                 <div class="form-grid">
                                                    <div class="form-group"><label>Ad Soyad *</label><input type="text" class="form-control student-name" name="studentName_0" required></div>
                                                    <div class="form-group"><label>Doƒüum Tarihi</label><input type="date" class="form-control student-birthdate" name="studentBirthDate_0"></div>
                                                 </div>
                                             </div>
                                         </div>
                                     </div>
                                 </div>
                                 
                                 <!-- Yeti≈ükin i√ßin tek √∂ƒürenci alanƒ± -->
                                 <div id="singleStudentContainer" style="display: none; margin-top: 20px;">
                                    <h4 style="margin-bottom: 15px;">üë® √úye Bilgileri</h4>
                                    <div class="form-grid" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                        <div class="form-group"><label for="studentNamePre">Ad Soyad *</label><input type="text" id="studentNamePre" class="form-control" name="studentName" required></div>
                                        <div class="form-group"><label for="studentBirthDatePre">Doƒüum Tarihi</label><input type="date" id="studentBirthDatePre" class="form-control" name="studentBirthDate"></div>
                                     </div>
                                 </div>
                                 
                                 <div class="form-grid" style="margin-top: 20px;">
                                     <div class="form-group">
                                         <label for="preRegGroupSearch">Grup</label>
                                         <div class="searchable-select-container">
                                             <input type="text" id="preRegGroupSearch" class="form-control" placeholder="√ñnce bran≈ü se√ßin" autocomplete="off" disabled>
                                             <input type="hidden" name="groupId" id="preRegGroupId">
                                             <div class="searchable-select-results" id="preRegGroupResults"></div>
                                         </div>
                                     </div>
                                 </div>
                                 <hr style="margin: 20px 0;">
                                 <h4 style="margin-bottom: 15px;">√ñdeme Planƒ±</h4>
                                 <div class="form-grid">
                                     <div class="form-group"><label>ƒ∞lk D√∂nem Ba≈ülangƒ±√ß *</label><input type="date" class="form-control" name="firstPeriodStart" required></div>
                                     <div class="form-group"><label>ƒ∞lk D√∂nem Biti≈ü *</label><input type="date" class="form-control" name="firstPeriodEnd" required></div>
                                     <div class="form-group"><label>ƒ∞lk D√∂nem Ders Sayƒ±sƒ±</label><input type="number" class="form-control" name="firstLessonCount"></div>
                                     <div class="form-group"><label>ƒ∞lk D√∂nem √úcreti (TL) *</label><input type="text" class="form-control" name="firstInstallmentAmount" required></div>
                                     <div class="form-group"><label>ƒ∞lk D√∂nem Son √ñdeme *</label><input type="date" class="form-control" name="firstDueDate" required></div>
                                     <div class="form-group"><label>Sonraki Taksit Sayƒ±sƒ±</label><input type="number" class="form-control" name="installments" value="6" min="0"></div>
                                     <div class="form-group"><label>Sonraki Taksit √úcreti (TL)</label><input type="text" class="form-control" name="subsequentInstallmentAmount"></div>
                                     <div class="form-group"><label>√ñdeme G√ºn√º</label><input type="number" class="form-control" name="dueDay" value="20" min="1" max="31"></div>
                                 </div>
                                 <div class="form-group"><label>Notlar</label><textarea class="form-control" name="notes" rows="2"></textarea></div>
                                 <div class="payment-plan-preview" style="margin-top: 20px;"></div>
                                 <button type="submit" class="btn btn-primary" style="margin-top: 20px;">üìù Kayƒ±t Olu≈ütur</button>
                               </form>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">üìã Bekleyen Kayƒ±tlar</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ad Soyad</th>
                                    <th>Veli Adƒ±</th>
                                    <th>Telefon</th>
                                    <th>Bran≈ü</th>
                                    <th>Durum</th>
                                    <th>Grup</th>
                                    <th>ƒ∞≈ülemler</th>
                                </tr>
                            </thead>
                            <tbody id="preRegistrationTable"></tbody>
                        </table>
                    </div>
                </div>

            </div>

            <!-- Bekleyen √úyeler Section -->
            <div id="pending-members" class="section">
                <div class="card">
                    <h3 class="card-title">‚è≥ Bekleyen √úyeler</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ad Soyad</th>
                                    <th>Veli Adƒ±</th>
                                    <th>Telefon</th>
                                    <th>Bran≈ü</th>
                                    <th>Durum</th>
                                    <th>ƒ∞≈ülemler</th>
                                </tr>
                            </thead>
                            <tbody id="pendingMembersTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pasif √úyeler Section -->
            <div id="inactive-members" class="section">
                <div class="card">
                    <h3 class="card-title">‚è∏Ô∏è Pasif √úyeler</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ad Soyad</th>
                                    <th>Veli Adƒ±</th>
                                    <th>Telefon</th>
                                    <th>Bran≈ü</th>
                                    <th>Durum</th>
                                    <th>ƒ∞≈ülemler</th>
                                </tr>
                            </thead>
                            <tbody id="inactiveMembersTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Members Section -->
            <div id="members" class="section">
                <!-- √úye Detay Alanƒ± (√úyeye tƒ±klanƒ±nca g√∂sterilecek) -->
                <div id="member-detail-content" style="display: none;"></div>
                
                <div class="card" id="members-list-card">
                    <div class="card-title">
                        <h3>üë• √úyeler</h3>
                        <input type="text" id="memberSearch" class="form-control search-input" placeholder="√úye ara (ƒ∞sim, Telefon)...">
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>√úye</th>
                                    <th>Veli</th>
                                    <th>Telefon</th>
                                    <th onclick="sortMembersByAge()" style="cursor: pointer;">Ya≈ü</th>
                                    <th>Bran≈ü</th>
                                    <th>Durum</th>
                                    <th>Grup</th>
                                    <th>ƒ∞≈ülemler</th>
                                </tr>
                            </thead>
                            <tbody id="membersTable"></tbody>
                        </table>
                    </div>
                    <div class="pagination-controls">
                        <div class="page-info-group">
                             <label for="itemsPerPage">Sayfa ba≈üƒ±na:</label>
                            <select id="itemsPerPage" class="form-control" onchange="changeMembersItemsPerPage(this)">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <div class="page-nav-group">
                            <button id="prevPageBtn" class="btn btn-secondary" onclick="changeMembersPage(-1)">√ñnceki</button>
                            <span id="pageInfo" style="padding: 0 15px; font-weight: 500;">Sayfa 1 / 1</span>
                            <button id="nextPageBtn" class="btn btn-secondary" onclick="changeMembersPage(1)">Sonraki</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payments Section -->
            <div id="payments" class="section">
                <div class="card">
                    <div class="card-title">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <h3 style="margin: 0;">üí∞ √ñdeme Takibi</h3>
                            <button id="toggle-payment-visibility-btn" onclick="togglePaymentVisibility()" style="background: none; border: none; cursor: pointer; font-size: 20px; padding: 5px; transition: all 0.2s;" title="Tutarlarƒ± Gizle/G√∂ster">
                                üëÅÔ∏è
                            </button>
                        </div>
                        <input type="text" id="paymentSearch" class="form-control search-input" placeholder="√úye ara (ƒ∞sim, Telefon)...">
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 15px;">
                        <div class="btn-group">
                             <button class="btn btn-primary btn-sm active" onclick="setPaymentFilter('all', this)">T√ºm √úyeler</button>
                             <button class="btn btn-danger btn-sm" onclick="setPaymentFilter('overdue', this)">Gecikmi≈ü √ñdemeler <span id="overdue-count"></span></button>
                             <button class="btn btn-success btn-sm" onclick="setPaymentFilter('finished', this)">Planƒ± Bitenler <span id="finished-count"></span></button>
                        </div>
                        <!-- ‚úÖ Gecikmi≈ü √∂demelere toplu mesaj butonu -->
                        <button class="btn btn-warning btn-sm" onclick="sendBulkOverdueReminders()" style="margin-left: auto;">
                            üì¢ Gecikmi≈ü √ñdemelere Toplu Mesaj
                        </button>
                    </div>
                    <div class="stats-grid" id="payment-stats" style="margin-top:20px;">
                        <div class="stat-card">
                            <div class="stat-number" id="totalRevenue">0‚Ç∫</div>
                            <div class="stat-label">Bu Ay Toplam Ciro</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalPaid">0‚Ç∫</div>
                            <div class="stat-label">Bu Ay √ñdenen</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalUnpaid">0‚Ç∫</div>
                            <div class="stat-label">Bu Ay Bekleyen</div>
                        </div>
                    </div>
                     <div id="overdue-stats-container" class="stats-grid" style="display: none; margin-top: 20px;">
                        <div class="stat-card" style="border-color: var(--danger-color);">
                            <div class="stat-number" id="overdue-total-amount" style="color: var(--danger-color);">0‚Ç∫</div>
                            <div class="stat-label">Toplam Gecikmi≈ü Tutar</div>
                        </div>
                        <div class="stat-card" style="border-color: var(--danger-color);">
                            <div class="stat-number" id="overdue-member-count" style="color: var(--danger-color);">0</div>
                            <div class="stat-label">Gecikmesi Olan Ki≈üi Sayƒ±sƒ±</div>
                        </div>
                    </div>
                    <div id="member-payment-list" class="payment-member-list">
                         <div class="loading">
                             <div class="spinner"></div>
                             <span>√úyeler y√ºkleniyor...</span>
                         </div>
                    </div>
                </div>
            </div>

            <!-- Expenses Section (Giderler) -->
            <div id="expenses" class="section">
                <div class="card">
                    <h2 class="card-title">üí∏ Giderler</h2>
                    <p style="color: #666; margin-bottom: 20px;">
                        Kul√ºp giderlerinizi buradan takip edebilirsiniz. (Yakƒ±nda aktif olacak)
                    </p>
                    <div class="empty-state">
                        <h3>üöß Bu sayfa yapƒ±m a≈üamasƒ±ndadƒ±r</h3>
                        <p>Yakƒ±nda gider takibi √∂zellikleri eklenecektir.</p>
                    </div>
                </div>
            </div>

            <!-- Accounting Summary Section (Muhasebe √ñzeti) -->
            <div id="accounting-summary" class="section">
                <div class="card">
                    <h2 class="card-title">üìä Muhasebe √ñzeti</h2>
                    <p style="color: #666; margin-bottom: 20px;">
                        Gelir-gider √∂zetini ve detaylƒ± raporlarƒ± buradan g√∂r√ºnt√ºleyebilirsiniz. (Yakƒ±nda aktif olacak)
                    </p>
                    <div class="empty-state">
                        <h3>üöß Bu sayfa yapƒ±m a≈üamasƒ±ndadƒ±r</h3>
                        <p>Yakƒ±nda muhasebe √∂zeti raporlarƒ± eklenecektir.</p>
                    </div>
                </div>
            </div>

            <!-- Products Section (√úr√ºnler) -->
            <div id="products" class="section">
                <div class="card">
                    <h2 class="card-title">üõçÔ∏è √úr√ºnler</h2>
                    <p style="color: #666; margin-bottom: 20px;">
                        Satƒ±≈ü yapƒ±lan √ºr√ºnleri (ekipman, abonelik vb.) buradan y√∂netebilirsiniz. (Yakƒ±nda aktif olacak)
                    </p>
                    <div class="empty-state">
                        <h3>üöß Bu sayfa yapƒ±m a≈üamasƒ±ndadƒ±r</h3>
                        <p>Yakƒ±nda √ºr√ºn y√∂netimi √∂zellikleri eklenecektir.</p>
                    </div>
                </div>
            </div>

            <!-- Schedule Section -->
            <div id="schedule" class="section">
                <div class="card">
                    <div class="card-title">
                        <h3>üìÖ Ders Planƒ± Y√∂netimi</h3>
                        <div id="schedule-branch-buttons" class="btn-group">
                            <!-- ‚úÖ Dinamik bran≈ü butonlarƒ± buraya gelecek -->
                       </div>
                    </div>
                    <div id="unassigned-groups-container"></div>
                    <div id="scheduleGrid">
                        <div class="empty-state" style="grid-column: 1 / -1;"><h3>L√ºtfen bir bran≈ü se√ßin.</h3></div>
                    </div>
                </div>
            </div>

            <!-- Groups Section -->
            <div id="groups" class="section">
                <div class="card">
                    <div class="card-title">
                        <h3>ü§∏ Grup Y√∂netimi</h3>
                        <input type="text" id="groupSearch" class="form-control search-input" placeholder="Grup ara...">
                        <div id="groups-branch-buttons" class="btn-group">
                            <!-- ‚úÖ Dinamik bran≈ü butonlarƒ± buraya gelecek -->
                       </div>
                        <button class="btn btn-primary btn-sm" id="newGroupBtn" style="display:none;" onclick="openGroupModal()">‚ûï Yeni Grup</button>
                    </div>
                    <div id="groupsList">
                        <div class="empty-state"><h3>L√ºtfen bir bran≈ü se√ßin.</h3></div>
                    </div>
                </div>
            </div>
            
            <!-- Tasks Section -->
            <div id="tasks" class="section">
                <div class="card">
                    <div class="card-title">
                        <h3>üéØ G√∂rev Y√∂netimi</h3>
                        <button class="btn btn-primary" onclick="openTaskEditModal()">‚ûï Yeni G√∂rev Ekle</button>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>G√∂rev</th>
                                    <th>Sorumlu Ki≈üi</th>
                                    <th>A≈üama</th>
                                    <th>Notlar</th>
                                    <th>Eklenme Tarihi</th>
                                    <th>Tamamlanma Tarihi</th>
                                    <th>Mesajlar</th>
                                    <th>ƒ∞≈ülemler</th>
                                </tr>
                            </thead>
                            <tbody id="tasksTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="section">
                <!-- Profilim Section -->
                <div class="card">
                    <h3 class="card-title">üîë Profilim</h3>
                    <p>A≈üaƒüƒ±daki butona tƒ±klayarak adƒ±nƒ±zƒ± ve ≈üifrenizi g√ºncelleyebilirsiniz.</p>
                    <button class="btn btn-primary" style="margin-top:15px;" onclick="openProfileEditModal()">Profili D√ºzenle</button>
                </div>
                
                <!-- Settings Tabs -->
                <div class="card">
                    <div class="settings-tabs">
                        <button class="settings-tab active" onclick="switchSettingsTab('club')">üè¢ Kul√ºp Bilgileri</button>
                        <button class="settings-tab" onclick="switchSettingsTab('general')">‚öôÔ∏è Genel Ayarlar</button>
                        <button class="settings-tab" onclick="switchSettingsTab('branches')">üèÉ Bran≈ü Y√∂netimi</button>
                        <button class="settings-tab" onclick="switchSettingsTab('users')">üë• Y√∂netici Y√∂netimi</button>
                        <button class="settings-tab" onclick="switchSettingsTab('contract')">üìÑ S√∂zle≈üme ≈ûablonu</button>
                        <button class="settings-tab" onclick="switchSettingsTab('templates')">üìù √úye Mesaj ≈ûablonlarƒ±</button>
                    </div>
                    
                    <!-- Tab Content: Kul√ºp Bilgileri -->
                    <div id="settings-tab-club" class="settings-tab-content active">
                        <form id="clubInfoForm" onsubmit="saveClubInfo(event)">
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">üè¢ Temel Bilgiler</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="clubInfoName">Kul√ºp Adƒ± *</label>
                                        <input type="text" id="clubInfoName" name="clubName" class="form-control" required placeholder="√ñrn: Atakum Tenis Kul√ºb√º">
                                    </div>
                                    <div class="form-group">
                                        <label for="clubIcon">ƒ∞kon (Emoji)</label>
                                        <input type="text" id="clubIcon" name="clubIcon" class="form-control" maxlength="2" placeholder="üéæ">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="clubDescription">Kul√ºp A√ßƒ±klamasƒ±</label>
                                    <textarea id="clubDescription" name="clubDescription" class="form-control" rows="3" placeholder="Kul√ºb√ºn√ºz hakkƒ±nda kƒ±sa a√ßƒ±klama..."></textarea>
                                </div>
                            </div>

                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">üìç ƒ∞leti≈üim Bilgileri</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="clubAddress">Adres</label>
                                        <input type="text" id="clubAddress" name="clubAddress" class="form-control" placeholder="Kul√ºp adresi">
                                    </div>
                                    <div class="form-group">
                                        <label for="clubCity">≈ûehir</label>
                                        <input type="text" id="clubCity" name="clubCity" class="form-control" placeholder="≈ûehir">
                                    </div>
                                </div>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="clubPhone">Telefon</label>
                                        <input type="tel" id="clubPhone" name="clubPhone" class="form-control" placeholder="05XXXXXXXXX">
                                    </div>
                                    <div class="form-group">
                                        <label for="clubEmail">E-posta</label>
                                        <input type="email" id="clubEmail" name="clubEmail" class="form-control" placeholder="info@kulup.com">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="clubWebsite">Website</label>
                                    <input type="url" id="clubWebsite" name="clubWebsite" class="form-control" placeholder="https://kulup.com">
                                </div>
                            </div>

                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">üì± Sosyal Medya</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="clubInstagram">Instagram</label>
                                        <input type="text" id="clubInstagram" name="clubInstagram" class="form-control" placeholder="@kulup_hesabi">
                                    </div>
                                    <div class="form-group">
                                        <label for="clubFacebook">Facebook</label>
                                        <input type="text" id="clubFacebook" name="clubFacebook" class="form-control" placeholder="facebook.com/kulup">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="clubTwitter">Twitter / X</label>
                                    <input type="text" id="clubTwitter" name="clubTwitter" class="form-control" placeholder="@kulup_hesabi">
                                </div>
                            </div>

                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">üîß Diƒüer Bilgiler</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="clubFounded">Kurulu≈ü Tarihi</label>
                                        <input type="date" id="clubFounded" name="clubFounded" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label for="clubTimezone">Saat Dilimi</label>
                                        <select id="clubTimezone" name="clubTimezone" class="form-control">
                                            <option value="Europe/Istanbul">Europe/Istanbul (GMT+3)</option>
                                            <option value="Europe/London">Europe/London (GMT)</option>
                                            <option value="America/New_York">America/New_York (GMT-5)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="clubCurrency">Para Birimi</label>
                                        <select id="clubCurrency" name="clubCurrency" class="form-control">
                                            <option value="TRY">TRY (‚Ç∫)</option>
                                            <option value="USD">USD ($)</option>
                                            <option value="EUR">EUR (‚Ç¨)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="clubLanguage">Dil</label>
                                        <select id="clubLanguage" name="clubLanguage" class="form-control">
                                            <option value="tr">T√ºrk√ße</option>
                                            <option value="en">English</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="margin-top: 20px;">üíæ Kul√ºp Bilgilerini Kaydet</button>
                        </form>
                    </div>
                    
                    <!-- Tab Content: Genel Ayarlar -->
                    <div id="settings-tab-general" class="settings-tab-content">
                        <form id="settingsForm">
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">üìÖ Haftalƒ±k Tatil G√ºnleri</h4>
                                <div class="form-group">
                                    <div id="holiday-settings" class="holiday-settings-grid"></div>
                                </div>
                            </div>
                            
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">üìû Bulutfon API Entegrasyonu</h4>
                                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                                    Bulutfon API'yi aktif ederek CRM'de g√∂r√º≈üme kayƒ±tlarƒ±nƒ±, cevapsƒ±z √ßaƒürƒ±larƒ± ve arama ge√ßmi≈üini g√∂r√ºnt√ºleyebilirsiniz.
                                </p>
                                
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="bulutfonEnabled" name="bulutfonEnabled" onclick="toggleBulutfonFields()" style="width: 20px; height: 20px;">
                                        <span style="font-weight: 600;">Bulutfon Entegrasyonunu Aktif Et</span>
                                    </label>
                                </div>
                                
                                <div id="bulutfon-api-settings" style="display: none; padding: 15px; background: #f5f5f5; border-radius: 8px; margin-top: 15px;">
                                    <div style="background: #e3f2fd; padding: 15px; border-radius: 6px; border-left: 4px solid #2196F3; margin-bottom: 20px;">
                                        <h5 style="margin: 0 0 10px 0; color: #1976d2; font-size: 14px;">üìã API Bilgileri</h5>
                                        <div style="font-size: 13px; color: #333; line-height: 1.6;">
                                            <p style="margin: 5px 0;"><strong>API URL:</strong> <code>https://api.bulutfon.com</code></p>
                                            <p style="margin: 5px 0;"><strong>Dok√ºmentasyon:</strong> <a href="https://www.bulutfon.com/developers" target="_blank" style="color: #1976d2;">https://www.bulutfon.com/developers</a></p>
                                            <p style="margin: 5px 0;"><strong>Gerekli ƒ∞zinler:</strong> CDR (Call Detail Records) okuma yetkisi</p>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="bulutfonApiKey">Bulutfon API Key *</label>
                                        <input type="text" id="bulutfonApiKey" name="bulutfonApiKey" class="form-control" placeholder="API Key'inizi buraya girin">
                                        <small style="color: #666; display: block; margin-top: 5px;">
                                            üí° Bulutfon panelinden <strong>Ayarlar ‚Üí API</strong> b√∂l√ºm√ºnden API key'inizi alabilirsiniz.
                                        </small>
                                    </div>
                                    
                                    <div style="background: #fff3cd; padding: 12px; border-radius: 6px; border-left: 4px solid #ff9800; margin-top: 15px;">
                                        <p style="margin: 0; font-size: 13px; color: #856404;">
                                            <strong>‚ö†Ô∏è √ñnemli:</strong> Bulutfon hesabƒ±nƒ±zda <strong>CDR (Call Detail Records)</strong> √∂zelliƒüinin aktif olmasƒ± gerekir.
                                            API key'i girdikten sonra "Baƒülantƒ±yƒ± Test Et" butonu ile test edebilirsiniz.
                                        </p>
                                    </div>
                                    
                                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                                        <button type="button" class="btn btn-primary" onclick="saveBulutfonSettings()">
                                            üíæ Kaydet
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="testBulutfonConnection()">
                                            üîå Baƒülantƒ±yƒ± Test Et
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">üîî Webhook Ayarlarƒ± (√úye Kayƒ±t Bildirimleri)</h4>
                                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                                    Kayƒ±t sayfasƒ±ndan √ºye kaydƒ± tamamlandƒ±ƒüƒ±nda belirtilen webhook URL'sine POST isteƒüi g√∂nderilir. Bu sayede kendi sisteminize otomatik bildirim alabilirsiniz.
                                </p>
                                
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="webhookEnabled" name="webhookEnabled" style="width: 20px; height: 20px;">
                                        <span style="font-weight: 600;">Webhook Bildirimi Aktif</span>
                                    </label>
                                </div>
                                
                                <div id="webhook-settings" style="display: none; padding: 15px; background: #f5f5f5; border-radius: 8px; margin-top: 15px;">
                                    <div style="background: #e8f5e9; padding: 15px; border-radius: 6px; border-left: 4px solid #4caf50; margin-bottom: 20px;">
                                        <h5 style="margin: 0 0 10px 0; color: #2e7d32; font-size: 14px;">üìã Webhook Bilgileri</h5>
                                        <div style="font-size: 13px; color: #333; line-height: 1.6;">
                                            <p style="margin: 5px 0;"><strong>Method:</strong> POST</p>
                                            <p style="margin: 5px 0;"><strong>Content-Type:</strong> application/json</p>
                                            <p style="margin: 5px 0;"><strong>Event Type:</strong> contract_signed</p>
                                            <p style="margin: 5px 0;"><strong>Payload ƒ∞√ßeriƒüi:</strong> √úye bilgileri, √∂deme planƒ±, s√∂zle≈üme PDF'i (base64)</p>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="webhookUrl">Webhook URL *</label>
                                        <input type="url" id="webhookUrl" name="webhookUrl" class="form-control" placeholder="https://example.com/webhook/member-registered">
                                        <small style="color: #666; display: block; margin-top: 5px;">
                                            üí° POST isteƒüi g√∂nderilecek URL'yi buraya girin.
                                        </small>
                                    </div>
                                    
                                    <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; border-left: 4px solid #2196f3; margin-top: 15px;">
                                        <p style="margin: 0 0 8px 0; font-size: 13px; color: #1565c0; font-weight: 600;">
                                            üì¶ √ñrnek Webhook Payload:
                                        </p>
                                        <pre style="background: #fff; padding: 10px; border-radius: 4px; font-size: 11px; overflow-x: auto; margin: 0;">{
  "event": "contract_signed",
  "Ad_Soyad": "Ahmet Yƒ±lmaz",
  "Telefon": "05551234567",
  "TC_Kimlik_No": "12345678901",
  "Adres": "...",
  "branch": "tenis",
  "paymentPlan": [...],
  "contractPdfBase64": "data:application/pdf;base64,...",
  "preRegistrationId": "abc123",
  "timestamp": "2025-01-15T10:30:00.000Z"
}</pre>
                                    </div>
                                    
                                    <button type="button" class="btn btn-secondary" onclick="testWebhook()" style="margin-top: 15px;">
                                        üß™ Webhook'u Test Et
                                    </button>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="margin-top: 20px;">üíæ Ayarlarƒ± Kaydet</button>
                        </form>
                    </div>
                    
                    <!-- Tab Content: Bran≈ü Y√∂netimi -->
                    <div id="settings-tab-branches" class="settings-tab-content">
                        <h3 class="card-title">üèÉ Bran≈ü Y√∂netimi</h3>
                        <p style="margin-bottom: 25px; color: #666;">
                            Kul√ºb√ºn√ºzdeki bran≈ülarƒ± buradan y√∂netebilirsiniz. Her bran≈ü i√ßin √∂zel ders ismi belirleyebilirsiniz.
                        </p>
                        
                        <div class="settings-subsection">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 class="settings-subtitle" id="branchFormTitle" style="margin: 0;">‚ûï Yeni Bran≈ü Ekle</h4>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="resetBranchForm()" style="padding: 6px 12px;">üîÑ Formu Temizle</button>
                            </div>
                            <form id="branchForm" onsubmit="addBranch(event)">
                                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 2fr auto;">
                                    <div class="form-group">
                                        <label for="branchId">Bran≈ü ID *</label>
                                        <input type="text" id="branchId" name="branchId" class="form-control" placeholder="ornek: futbol" required>
                                        <small style="color: #666; display: block; margin-top: 4px;">K√º√ß√ºk harf, bo≈üluksuz</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="branchName">Bran≈ü Adƒ± *</label>
                                        <input type="text" id="branchName" name="branchName" class="form-control" placeholder="Futbol" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="branchIcon">ƒ∞kon (opsiyonel)</label>
                                        <input type="text" id="branchIcon" name="branchIcon" class="form-control" placeholder="‚öΩ">
                                        <small style="color: #666; display: block; margin-top: 4px;">Emoji - bo≈ü bƒ±rakƒ±rsanƒ±z varsayƒ±lan ‚öΩ kullanƒ±lƒ±r</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="branchLessonName">Ders Adƒ± *</label>
                                        <input type="text" id="branchLessonName" name="branchLessonName" class="form-control" placeholder="Futbol Antrenmanƒ±" required>
                                        <small style="color: #666; display: block; margin-top: 4px;">Mesajlarda g√∂r√ºnecek</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="branchCourts">Sahalar (opsiyonel)</label>
                                        <input type="text" id="branchCourts" name="branchCourts" class="form-control" placeholder="Saha 1, Saha 2, Merkez Saha">
                                        <small style="color: #666; display: block; margin-top: 4px;">Virg√ºlle ayƒ±rƒ±n. Birden fazla saha varsa ders planƒ±nda saha se√ßimi g√∂r√ºnecek</small>
                                    </div>
                                    <div class="form-group">
                                        <label style="visibility: hidden;">Ekle</label>
                                        <button type="submit" id="branchSubmitBtn" class="btn btn-primary">‚ûï Ekle</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <div class="settings-subsection">
                            <h4 class="settings-subtitle">üìã Mevcut Bran≈ülar</h4>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 60px;">ƒ∞kon</th>
                                            <th>Bran≈ü ID</th>
                                            <th>Bran≈ü Adƒ±</th>
                                            <th>Ders Adƒ±</th>
                                            <th>Sahalar</th>
                                            <th style="width: 120px;">ƒ∞≈ülemler</th>
                                        </tr>
                                    </thead>
                                    <tbody id="branchesTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Content: Y√∂netici Y√∂netimi -->
                    <div id="settings-tab-users" class="settings-tab-content">
                        <div id="user-management-card">
                            <h3 class="card-title">üë• Y√∂netici Y√∂netimi</h3>
                     <form id="userForm">
                         <div class="form-grid">
                             <div class="form-group">
                                 <label for="userFullName">Ad Soyad *</label>
                                 <input type="text" class="form-control" name="fullName" required>
                             </div>
                             <div class="form-group">
                                 <label for="userPhone">Telefon *</label>
                                 <input type="tel" class="form-control" name="phone" required>
                             </div>
                             <div class="form-group">
                                 <label for="userUsername">Kullanƒ±cƒ± Adƒ± (Telefon)</label>
                                 <input type="text" class="form-control" name="username" readonly>
                             </div>
                             <div class="form-group">
                                 <label for="userPassword">≈ûifre *</label>
                                 <input type="password" class="form-control" name="password" autocomplete="new-password" required>
                             </div>
                        </div>
                         <div class="form-group">
                              <label>Yetkiler</label>
                              <div class="permissions-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                                  <strong style="grid-column: 1 / -1; color: #1976d2; margin-bottom: 5px;">üí∞ Finansal Yetkiler</strong>
                                  <label><input type="checkbox" name="permissions" value="view_payments"> √ñdemeleri G√∂r√ºnt√ºleme</label>
                                  <label><input type="checkbox" name="permissions" value="edit_payments"> √ñdemeleri D√ºzenleme</label>
                                  <label><input type="checkbox" name="permissions" value="delete_payments"> √ñdemeleri Silme</label>
                                  <label><input type="checkbox" name="permissions" value="export_payments"> √ñdemeleri Dƒ±≈üa Aktarma</label>
                                  
                                  <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">üë• √úye Yetkileri</strong>
                                  <label><input type="checkbox" name="permissions" value="view_members"> √úyeleri G√∂r√ºnt√ºleme</label>
                                  <label><input type="checkbox" name="permissions" value="add_members"> √úye Ekleme</label>
                                  <label><input type="checkbox" name="permissions" value="edit_members"> √úye D√ºzenleme</label>
                                  <label><input type="checkbox" name="permissions" value="delete_members"> √úye Silme</label>
                                  <label><input type="checkbox" name="permissions" value="export_members"> √úyeleri Dƒ±≈üa Aktarma</label>
                                  
                                  <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">üìû CRM Yetkileri</strong>
                                  <label><input type="checkbox" name="permissions" value="view_crm"> CRM G√∂r√ºnt√ºleme</label>
                                  <label><input type="checkbox" name="permissions" value="add_crm"> CRM'e Ekleme</label>
                                  <label><input type="checkbox" name="permissions" value="edit_crm"> CRM D√ºzenleme</label>
                                  <label><input type="checkbox" name="permissions" value="delete_crm"> CRM'den Silme</label>
                                  <label><input type="checkbox" name="permissions" value="view_calls"> Arama Kayƒ±tlarƒ±nƒ± G√∂r√ºnt√ºleme</label>
                                  
                                  <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">üí¨ ƒ∞leti≈üim Yetkileri</strong>
                                  <label><input type="checkbox" name="permissions" value="send_messages"> Mesaj G√∂nderme</label>
                                  <label><input type="checkbox" name="permissions" value="send_bulk_messages"> Toplu Mesaj G√∂nderme</label>
                                  <label><input type="checkbox" name="permissions" value="view_message_history"> Mesaj Ge√ßmi≈üini G√∂r√ºnt√ºleme</label>
                                  
                                  <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">üìä Raporlar ve ƒ∞statistikler</strong>
                                  <label><input type="checkbox" name="permissions" value="view_stats"> ƒ∞statistikleri G√∂r√ºnt√ºleme</label>
                                  <label><input type="checkbox" name="permissions" value="view_reports"> Raporlarƒ± G√∂r√ºnt√ºleme</label>
                                  <label><input type="checkbox" name="permissions" value="export_reports"> Raporlarƒ± Dƒ±≈üa Aktarma</label>
                                  
                                  <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">‚öôÔ∏è Ayarlar ve Y√∂netim</strong>
                                  <label><input type="checkbox" name="permissions" value="manage_users"> Kullanƒ±cƒ± Y√∂netimi</label>
                                  <label><input type="checkbox" name="permissions" value="manage_settings"> Ayarlarƒ± Y√∂netme</label>
                                  <label><input type="checkbox" name="permissions" value="manage_branches"> Bran≈ü Y√∂netimi</label>
                                  <label><input type="checkbox" name="permissions" value="manage_groups"> Grup Y√∂netimi</label>
                                  
                                  <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">üìã Yoklama ve Takvim</strong>
                                  <label><input type="checkbox" name="permissions" value="view_attendance"> Yoklama G√∂r√ºnt√ºleme</label>
                                  <label><input type="checkbox" name="permissions" value="edit_attendance"> Yoklama D√ºzenleme</label>
                                  <label><input type="checkbox" name="permissions" value="manage_schedule"> Takvim Y√∂netimi</label>
                              </div>
                         </div>
                         <button type="submit" class="btn btn-success">üë§ Kullanƒ±cƒ± Ekle</button>
                     </form>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead><tr><th>Ad Soyad</th><th>Telefon (K. Adƒ±)</th><th>ƒ∞zinler</th><th>ƒ∞≈ülemler</th></tr></thead>
                                    <tbody id="usersTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Content: S√∂zle≈üme ≈ûablonu -->
                    <div id="settings-tab-contract" class="settings-tab-content">
                        <h3 class="card-title">üìÑ Kul√ºp S√∂zle≈üme ≈ûablonu</h3>
                        <p style="margin-bottom: 25px; color: #666;">
                            √ñn kayƒ±t yapan √ºyelerin s√∂zle≈üme onayƒ± sƒ±rasƒ±nda g√∂sterilecek s√∂zle≈üme ≈üablonunu d√ºzenleyin. Bu ≈üablon <strong>kayit.html</strong> sayfasƒ±nda kullanƒ±lƒ±r.
                        </p>
                        
                        <!-- Kul√ºbe √ñzel S√∂zle≈üme Linki -->
                        <div id="contractLinkSection" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; color: white;">
                            <h4 style="margin-top: 0; color: white;">üîó √úyelik Kayƒ±t Linki (kayit.html)</h4>
                            <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                                <strong style="font-size: 16px;">üè¢ Kul√ºp Adƒ±:</strong> <span id="contractClubName" style="font-size: 16px; font-weight: 600;">Y√ºkleniyor...</span>
                            </div>
                            <p style="margin-bottom: 15px; opacity: 0.9;">√ñn kayƒ±tlƒ± √ºyelerinizin s√∂zle≈ümeyi tamamlamasƒ± i√ßin bu linki payla≈üƒ±n:</p>
                            <div style="display: flex; gap: 10px; align-items: center; background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
                                <input 
                                    type="text" 
                                    id="contractLink" 
                                    readonly 
                                    style="flex: 1; padding: 10px; border: none; border-radius: 6px; font-family: monospace; font-size: 14px;"
                                    value="Y√ºkleniyor..."
                                />
                                <button 
                                    onclick="copyContractLink()" 
                                    class="btn btn-success"
                                    style="white-space: nowrap; padding: 10px 20px;">
                                    üìã Kopyala
                                </button>
                                <a 
                                    id="contractLinkOpen"
                                    href="#" 
                                    target="_blank"
                                    class="btn"
                                    style="background: white; color: #667eea; white-space: nowrap; padding: 10px 20px; text-decoration: none;">
                                    üîó A√ß
                                </a>
                            </div>
                        </div>
                        
                        <form id="contractTemplateForm" onsubmit="saveContractTemplate(event)">
                            <!-- Genel Ayarlar -->
                            <div class="settings-subsection">
                                <h4 style="color: #667eea; margin-bottom: 15px;">üé® Sayfa Ba≈ülƒ±klarƒ±</h4>
                                
                                <div class="form-group">
                                    <label for="contract-page-title">Sayfa Ana Ba≈ülƒ±ƒüƒ±</label>
                                    <input type="text" id="contract-page-title" name="pageTitle" class="form-control" placeholder="√ñrn: Spor Kul√ºb√º" value="Spor Kul√ºb√º">
                                    <small style="color: #666;">S√∂zle≈üme sayfasƒ±nƒ±n en √ºst√ºndeki ba≈ülƒ±k</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="contract-page-subtitle">Sayfa Alt Ba≈ülƒ±ƒüƒ±</label>
                                    <input type="text" id="contract-page-subtitle" name="pageSubtitle" class="form-control" placeholder="√ñrn: √úyelik S√∂zle≈ümesi" value="√úyelik S√∂zle≈ümesi">
                                </div>
                            </div>
                            
                            <!-- Onay Checkbox'larƒ± -->
                            <div class="settings-subsection">
                                <h4 style="color: #667eea; margin-bottom: 15px;">‚úÖ Onay Checkbox'larƒ±</h4>
                                <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">
                                    üìå Kayƒ±t formunda g√∂sterilecek onay checkbox'larƒ±nƒ±n metinlerini d√ºzenleyin. Bo≈ü bƒ±rakƒ±rsanƒ±z o checkbox kayƒ±t sayfasƒ±nda g√∂sterilmez.
                                </p>
                                
                                <div class="form-group">
                                    <label for="contract-checkbox1-text">
                                        <strong>1. Checkbox:</strong> S√∂zle≈üme Onayƒ±
                                    </label>
                                    <input 
                                        type="text" 
                                        id="contract-checkbox1-text" 
                                        name="checkbox1Text" 
                                        class="form-control" 
                                        placeholder="√úyelik s√∂zle≈ümesini okudum, anladƒ±m ve kabul ediyorum."
                                        value="√úyelik s√∂zle≈ümesini okudum, anladƒ±m ve kabul ediyorum.">
                                    <small style="color: #666;">
                                        ‚úÖ Zorunlu alan: Kullanƒ±cƒ±nƒ±n s√∂zle≈ümeyi kabul etmesi i√ßin g√∂sterilir
                                    </small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="contract-checkbox2-text">
                                        <strong>2. Checkbox:</strong> ƒ∞ptal ve √úyelik Politikasƒ±
                                    </label>
                                    <textarea 
                                        id="contract-checkbox2-text" 
                                        name="checkbox2Text" 
                                        class="form-control" 
                                        rows="3"
                                        placeholder="√úyeliƒüiniz iptal edilene kadar devam etmektedir..."
                                    >√úyeliƒüiniz iptal edilene kadar devam etmektedir. Her ayƒ±n 14'√º, yeni d√∂nem i√ßin kayƒ±t iptali yapƒ±labilecek son g√ºnd√ºr. Bu tarihe kadar iptal edilmeyen kayƒ±tlar, devam eden d√∂nem i√ßin ge√ßerli sayƒ±lƒ±r.</textarea>
                                    <small style="color: #666;">
                                        ‚öôÔ∏è ƒ∞steƒüe baƒülƒ±: ƒ∞ptal politikasƒ± veya ek bilgilendirme i√ßin. Bo≈ü bƒ±rakƒ±rsanƒ±z g√∂sterilmez.
                                    </small>
                                </div>
                                
                                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-top: 15px;">
                                    <strong>üí° ƒ∞pucu:</strong>
                                    <ul style="margin: 10px 0 0 20px; padding: 0;">
                                        <li>ƒ∞kinci checkbox'u kullanmak istemiyorsanƒ±z alanƒ± <strong>tamamen bo≈ü</strong> bƒ±rakƒ±n</li>
                                        <li>Checkbox metinleri <strong>HTML</strong> destekler (<code>&lt;strong&gt;</code>, <code>&lt;br&gt;</code> vb.)</li>
                                        <li>Deƒüi≈üiklikler hemen <strong>kayit.html</strong> sayfasƒ±na yansƒ±r</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <!-- S√∂zle≈üme ƒ∞√ßeriƒüi -->
                            <div class="settings-subsection">
                                <h4 style="color: #667eea; margin-bottom: 15px;">üìú S√∂zle≈üme ƒ∞√ßeriƒüi</h4>
                                
                                <!-- Placeholder A√ßƒ±klamasƒ± -->
                                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                                    <strong>üìå Kullanƒ±labilir Placeholder'lar:</strong><br>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; font-size: 0.9em;">
                                        <div><code>{KULUP_ADI}</code> - Kul√ºp √ºnvanƒ±</div>
                                        <div><code>{YETKILI_ADI}</code> - Yetkili adƒ±</div>
                                        <div><code>{KULUP_ADRES}</code> - Kul√ºp adresi</div>
                                        <div><code>{VERGI_NO}</code> - Vergi No</div>
                                        <div><code>{KULUP_TELEFON}</code> - Kul√ºp telefonu</div>
                                        <div><code>{KULUP_EMAIL}</code> - Kul√ºp email</div>
                                        <div><code>{UYE_AD_SOYAD}</code> - √úye/Veli adƒ±</div>
                                        <div><code>{UYE_TCKN}</code> - TC Kimlik No</div>
                                        <div><code>{UYE_DOGUM_TARIHI}</code> - Doƒüum tarihi</div>
                                        <div><code>{UYE_TELEFON}</code> - Telefon</div>
                                        <div><code>{UYE_ADRES}</code> - Adres</div>
                                        <div><code>{BRANS}</code> - Bran≈ü</div>
                                        <div><code>{OGRENCI_AD_SOYAD}</code> - √ñƒürenci adƒ±</div>
                                        <div><code>{OGRENCI_DOGUM_TARIHI}</code> - √ñƒürenci doƒüum tarihi</div>
                                        <div><code>{TARIH}</code> - S√∂zle≈üme tarihi</div>
                                        <div style="grid-column: 1 / -1;"><code>{AIDAT_TAKVIMI}</code> - Aidat takvimi tablosu (otomatik olu≈üur)</div>
                                        <div style="grid-column: 1 / -1;"><code>{OGRENCI_BILGILERI}</code> - Re≈üit olmayan √∂ƒürenci bilgileri (√ßocuk kaydƒ±nda otomatik eklenir)</div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="contractTemplate">S√∂zle≈üme Metni (HTML)</label>
                                    <textarea 
                                        id="contractTemplate" 
                                        name="contractText" 
                                        class="form-control" 
                                        rows="20" 
                                        style="font-family: 'Courier New', monospace; font-size: 13px;"
                                        placeholder="Kul√ºp s√∂zle≈üme metnini buraya yazƒ±n...

HTML kullanabilirsiniz. √ñrnek:
<h4>√úYELƒ∞K S√ñZLE≈ûMESƒ∞</h4>
<p><strong>1-) TARAFLAR</strong><br>
<strong>A-KUL√úP</strong><br>
Kul√ºp Adƒ±: {KULUP_ADI}<br>
<strong>B-√úYE/VELƒ∞</strong><br>
Adƒ±-Soyadƒ±: {UYE_AD_SOYAD}<br>
Doƒüum Tarihi: {UYE_DOGUM_TARIHI}<br>
TCKN: {UYE_TCKN}<br>
Telefon: {UYE_TELEFON}<br>
Adres: {UYE_ADRES}<br>
Bran≈ü: {BRANS}<br>
√ñƒürenci Adƒ±: {OGRENCI_AD_SOYAD}<br>
</p>

<p><strong>S√∂zle≈üme Tarihi:</strong> {TARIH}</p>"></textarea>
                                    <small style="color: #666;">
                                        <strong>üí° ƒ∞pucu:</strong> HTML etiketleri kullanabilirsiniz. Yukarƒ±daki placeholder'larƒ± kullanarak √ºye bilgileri otomatik doldurulur.
                                    </small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="contract-enabled" name="contractEnabled" style="width: auto;">
                                    <label for="contract-enabled" style="margin: 0;">Bu s√∂zle≈üme ≈üablonunu etkinle≈ütir</label>
                                </div>
                            </div>
                            
                            <div class="settings-subsection" style="margin-top: 30px; background: #f0f9ff; padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary-color);">
                                <h4 style="margin-bottom: 10px; color: var(--primary-color);">üí≥ Bran≈ü Bazlƒ± √ñdeme Bilgileri</h4>
                                <p style="margin-bottom: 20px; color: #666; font-size: 0.9em;">
                                    Her bran≈ü i√ßin farklƒ± IBAN tanƒ±mlayabilirsiniz. √úye s√∂zle≈ümeyi tamamladƒ±ƒüƒ±nda kendi bran≈üƒ±nƒ±n IBAN bilgilerini g√∂recek.
                                </p>
                                
                                <!-- Tenis Bran≈üƒ± IBAN -->
                                <div style="background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #4CAF50;">
                                    <h5 style="color: #4CAF50; margin-bottom: 15px;">üéæ Tenis Bran≈üƒ± IBAN Bilgileri</h5>
                                    
                                    <div class="form-group">
                                        <label for="iban_tenis_1_name">1. Hesap Adƒ±</label>
                                        <input type="text" id="iban_tenis_1_name" class="form-control" placeholder="√ñrn: √ñmer Bulut">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="iban_tenis_1_number">1. IBAN Numarasƒ±</label>
                                        <input type="text" id="iban_tenis_1_number" class="form-control" placeholder="TR00 0000 0000 0000 0000 0000 00">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="iban_tenis_2_name">2. Hesap Adƒ± (ƒ∞steƒüe Baƒülƒ±)</label>
                                        <input type="text" id="iban_tenis_2_name" class="form-control" placeholder="√ñrn: √ñmer Bulut">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="iban_tenis_2_number">2. IBAN Numarasƒ± (ƒ∞steƒüe Baƒülƒ±)</label>
                                        <input type="text" id="iban_tenis_2_number" class="form-control" placeholder="TR00 0000 0000 0000 0000 0000 00">
                                    </div>
                                </div>
                                
                                <!-- Y√ºzme Bran≈üƒ± IBAN -->
                                <div style="background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #2196F3;">
                                    <h5 style="color: #2196F3; margin-bottom: 15px;">üèä Y√ºzme Bran≈üƒ± IBAN Bilgileri</h5>
                                    
                                    <div class="form-group">
                                        <label for="iban_yuzme_1_name">1. Hesap Adƒ±</label>
                                        <input type="text" id="iban_yuzme_1_name" class="form-control" placeholder="√ñrn: √ñmer Bulut">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="iban_yuzme_1_number">1. IBAN Numarasƒ±</label>
                                        <input type="text" id="iban_yuzme_1_number" class="form-control" placeholder="TR00 0000 0000 0000 0000 0000 00">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="iban_yuzme_2_name">2. Hesap Adƒ± (ƒ∞steƒüe Baƒülƒ±)</label>
                                        <input type="text" id="iban_yuzme_2_name" class="form-control" placeholder="√ñrn: √ñmer Bulut">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="iban_yuzme_2_number">2. IBAN Numarasƒ± (ƒ∞steƒüe Baƒülƒ±)</label>
                                        <input type="text" id="iban_yuzme_2_number" class="form-control" placeholder="TR00 0000 0000 0000 0000 0000 00">
                                    </div>
                                </div>
                                
                                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                                    <strong>üí° ƒ∞pucu:</strong>
                                    <ul style="margin: 10px 0 0 20px; padding: 0;">
                                        <li>Her bran≈ü i√ßin farklƒ± hesap bilgileri tanƒ±mlayabilirsiniz</li>
                                        <li>√úye s√∂zle≈ümeyi tamamladƒ±ƒüƒ±nda sadece kendi bran≈üƒ±nƒ±n IBAN'larƒ±nƒ± g√∂r√ºr</li>
                                        <li>ƒ∞kinci hesap alanƒ± isteƒüe baƒülƒ±dƒ±r, bo≈ü bƒ±rakabilirsiniz</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">üíæ S√∂zle≈üme ≈ûablonunu Kaydet</button>
                        </form>
                    </div>
                    
                    <!-- Tab Content: Mesaj ≈ûablonlarƒ± -->
                    <div id="settings-tab-templates" class="settings-tab-content">
                        <h3 class="card-title">üìù √úye Mesaj ≈ûablonlarƒ±</h3>
                        <p style="margin-bottom: 25px; color: #666;">
                            Bu ≈üablonlar <strong>kayƒ±tlƒ± √ºyeler</strong> i√ßin otomatik mesaj g√∂nderimi i√ßin kullanƒ±lƒ±r. 
                            Doƒüum g√ºn√º, aidat hatƒ±rlatma, devamsƒ±zlƒ±k gibi otomatik mesajlarƒ± buradan d√ºzenleyebilirsiniz.
                            <strong>{UYE_AD_SOYAD}</strong>, <strong>{OGRENCI_AD_SOYAD}</strong>, <strong>{TUTAR}</strong>, <strong>{TARIH}</strong> gibi deƒüi≈ükenleri kullanabilirsiniz.
                        </p>
                        <div style="background: #f0f8ff; padding: 12px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #0066cc;">
                            <strong>üí° Deƒüi≈üken Sistemi:</strong><br>
                            <strong>{UYE_AD_SOYAD}:</strong> Yeti≈ükinde √ºyenin kendisi, √ßocukta veli adƒ±<br>
                            <strong>{OGRENCI_AD_SOYAD}:</strong> Sadece √ßocuk ≈üablonlarƒ±nda kullanƒ±lƒ±r, √∂ƒürencinin adƒ±
                        </div>

                        <form id="templatesForm" onsubmit="saveMessageTemplates(event)">
                            <!-- Doƒüum G√ºn√º ≈ûablonu -->
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">üéÇ Doƒüum G√ºn√º Kutlama ≈ûablonu</h4>
                                
                                <!-- √áocuk √úyeler ƒ∞√ßin -->
                                <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                    <label for="template-birthday-child" style="font-weight: 600; color: #4CAF50;">üë∂ √áocuk √úyeler ƒ∞√ßin (Veliye g√∂nderilir)</label>
                                    <textarea id="template-birthday-child" name="birthdayChild" class="form-control" rows="4" placeholder="√ñrn: Sayƒ±n {UYE_AD_SOYAD}, Velisi olduƒüunuz {OGRENCI_AD_SOYAD}'nƒ±n doƒüum g√ºn√ºn√º kutlarƒ±z! üéâüéÇ"></textarea>
                                    <small style="color: #666;">Kullanƒ±labilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code></small>
                                </div>
                                
                                <!-- Yeti≈ükin √úyeler ƒ∞√ßin -->
                                <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                    <label for="template-birthday-adult" style="font-weight: 600; color: #2196F3;">üë§ Yeti≈ükin √úyeler ƒ∞√ßin</label>
                                    <textarea id="template-birthday-adult" name="birthdayAdult" class="form-control" rows="4" placeholder="√ñrn: Sayƒ±n {UYE_AD_SOYAD}, Doƒüum g√ºn√ºn√ºz√º kutlarƒ±z! üéâüéÇ"></textarea>
                                    <small style="color: #666;">Kullanƒ±labilir: <code>{UYE_AD_SOYAD}</code></small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                    <input type="checkbox" id="birthday-enabled" name="birthdayEnabled" style="width: auto;">
                                    <label for="birthday-enabled" style="margin: 0;">Otomatik doƒüum g√ºn√º mesajlarƒ±nƒ± etkinle≈ütir</label>
                                </div>
                            </div>

                            <!-- Gecikmi≈ü Aidat ≈ûablonu -->
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">üí∞ Gecikmi≈ü Aidat Hatƒ±rlatma ≈ûablonu</h4>
                                
                                <!-- √áocuk √úyeler ƒ∞√ßin -->
                                <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                    <label for="template-payment-child" style="font-weight: 600; color: #4CAF50;">üë∂ √áocuk √úyeler ƒ∞√ßin (Veliye g√∂nderilir)</label>
                                    <textarea id="template-payment-child" name="paymentChild" class="form-control" rows="4" placeholder="√ñrn: Sayƒ±n {UYE_AD_SOYAD}, Velisi olduƒüunuz {OGRENCI_AD_SOYAD} i√ßin {TUTAR} TL √∂demeniz {TARIH} tarihinden beri gecikmi≈ütir."></textarea>
                                    <small style="color: #666;">Kullanƒ±labilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code>, <code>{TUTAR}</code>, <code>{TARIH}</code>, <code>{DONEM_BASLANGIC}</code>, <code>{DONEM_BITIS}</code>, <code>{DERS_SAYISI}</code></small>
                                </div>
                                
                                <!-- Yeti≈ükin √úyeler ƒ∞√ßin -->
                                <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                    <label for="template-payment-adult" style="font-weight: 600; color: #2196F3;">üë§ Yeti≈ükin √úyeler ƒ∞√ßin</label>
                                    <textarea id="template-payment-adult" name="paymentAdult" class="form-control" rows="4" placeholder="√ñrn: Sayƒ±n {UYE_AD_SOYAD}, {TUTAR} TL √∂demeniz {TARIH} tarihinden beri gecikmi≈ütir."></textarea>
                                    <small style="color: #666;">Kullanƒ±labilir: <code>{UYE_AD_SOYAD}</code>, <code>{TUTAR}</code>, <code>{TARIH}</code>, <code>{DONEM_BASLANGIC}</code>, <code>{DONEM_BITIS}</code>, <code>{DERS_SAYISI}</code></small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                    <input type="checkbox" id="payment-enabled" name="paymentEnabled" style="width: auto;">
                                    <label for="payment-enabled" style="margin: 0;">Bu ≈üablonu etkinle≈ütir</label>
                                </div>
                            </div>

                            <!-- Devamsƒ±zlƒ±k ≈ûablonu -->
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">üìÖ Devamsƒ±zlƒ±k Bildirimi ≈ûablonu</h4>
                                
                                <!-- √áocuk √úyeler ƒ∞√ßin -->
                                <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                    <label for="template-absence-child" style="font-weight: 600; color: #4CAF50;">üë∂ √áocuk √úyeler ƒ∞√ßin (Veliye g√∂nderilir)</label>
                                    <textarea id="template-absence-child" name="absenceChild" class="form-control" rows="5" placeholder="√ñrn: Sayƒ±n {UYE_AD_SOYAD}, Velisi olduƒüunuz {OGRENCI_AD_SOYAD}'nƒ±n {TARIH} tarihindeki {DERS} dersine katƒ±lamadƒ±ƒüƒ±nƒ± fark ettik..."></textarea>
                                    <small style="color: #666;">Kullanƒ±labilir: <code>{UYE_AD_SOYAD}</code> (veli adƒ±), <code>{OGRENCI_AD_SOYAD}</code> (√∂ƒürenci adƒ±), <code>{TARIH}</code>, <code>{DERS}</code></small>
                                </div>
                                
                                <!-- Yeti≈ükin √úyeler ƒ∞√ßin -->
                                <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                    <label for="template-absence-adult" style="font-weight: 600; color: #2196F3;">üë§ Yeti≈ükin √úyeler ƒ∞√ßin</label>
                                    <textarea id="template-absence-adult" name="absenceAdult" class="form-control" rows="5" placeholder="√ñrn: Sayƒ±n {UYE_AD_SOYAD}, {TARIH} tarihindeki {DERS} dersine katƒ±lamadƒ±ƒüƒ±nƒ±zƒ± fark ettik..."></textarea>
                                    <small style="color: #666;">Kullanƒ±labilir: <code>{UYE_AD_SOYAD}</code> (√ºye adƒ±), <code>{TARIH}</code>, <code>{DERS}</code></small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                    <input type="checkbox" id="absence-enabled" name="absenceEnabled" style="width: auto;">
                                    <label for="absence-enabled" style="margin: 0;">Bu ≈üablonu etkinle≈ütir</label>
                                </div>
                            </div>

                            <!-- Genel Duyuru ≈ûablonu -->
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">üì¢ Genel Duyuru ≈ûablonu</h4>
                                
                                <!-- √áocuk √úyeler ƒ∞√ßin -->
                                <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                    <label for="template-announcement-child" style="font-weight: 600; color: #4CAF50;">üë∂ √áocuk √úyeler ƒ∞√ßin (Veliye g√∂nderilir)</label>
                                    <textarea id="template-announcement-child" name="announcementChild" class="form-control" rows="4" placeholder="√ñrn: Sayƒ±n {UYE_AD_SOYAD}, Velisi olduƒüunuz {OGRENCI_AD_SOYAD} ile ilgili duyuru: {MESAJ}"></textarea>
                                    <small style="color: #666;">Kullanƒ±labilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code>, <code>{MESAJ}</code></small>
                                </div>
                                
                                <!-- Yeti≈ükin √úyeler ƒ∞√ßin -->
                                <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                    <label for="template-announcement-adult" style="font-weight: 600; color: #2196F3;">üë§ Yeti≈ükin √úyeler ƒ∞√ßin</label>
                                    <textarea id="template-announcement-adult" name="announcementAdult" class="form-control" rows="4" placeholder="√ñrn: Sayƒ±n {UYE_AD_SOYAD}, Kul√ºb√ºm√ºzden duyuru: {MESAJ}"></textarea>
                                    <small style="color: #666;">Kullanƒ±labilir: <code>{UYE_AD_SOYAD}</code>, <code>{MESAJ}</code></small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                    <input type="checkbox" id="announcement-enabled" name="announcementEnabled" style="width: auto;">
                                    <label for="announcement-enabled" style="margin: 0;">Bu ≈üablonu etkinle≈ütir</label>
                                </div>
                            </div>

                            <!-- G√∂rev Bildirimi ≈ûablonu -->
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">üìã G√∂rev Bildirimi ≈ûablonu</h4>
                                <div class="form-group">
                                    <label for="template-task">Mesaj Metni</label>
                                    <textarea id="template-task" name="task" class="form-control" rows="6" placeholder="√ñrn: Sayƒ±n {UYE_AD_SOYAD}, Size yeni bir g√∂rev atandƒ±: {GOREV}. A√ßƒ±klama: {ACIKLAMA}"></textarea>
                                    <small style="color: #666;">Kullanƒ±labilir deƒüi≈ükenler: <code>{UYE_AD_SOYAD}</code>, <code>{GOREV}</code>, <code>{ACIKLAMA}</code>, <code>{TARIH}</code></small>
                                </div>
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="task-enabled" name="taskEnabled" style="width: auto;">
                                    <label for="task-enabled" style="margin: 0;">G√∂rev atandƒ±ƒüƒ±nda otomatik mesaj g√∂nder</label>
                                </div>
                            </div>

                            <!-- Yakla≈üan √ñdeme Hatƒ±rlatma ≈ûablonu -->
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">‚è∞ Yakla≈üan √ñdeme Hatƒ±rlatma ≈ûablonu</h4>
                                
                                <!-- √áocuk √úyeler ƒ∞√ßin -->
                                <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                    <label for="template-upcomingPayment-child" style="font-weight: 600; color: #4CAF50;">üë∂ √áocuk √úyeler ƒ∞√ßin (Veliye g√∂nderilir)</label>
                                    <textarea id="template-upcomingPayment-child" name="upcomingPaymentChild" class="form-control" rows="4" placeholder="√ñrn: Sayƒ±n {UYE_AD_SOYAD}, Velisi olduƒüunuz {OGRENCI_AD_SOYAD} i√ßin {TARIH} tarihinde {TUTAR} TL √∂demeniz bulunmaktadƒ±r."></textarea>
                                    <small style="color: #666;">Kullanƒ±labilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code>, <code>{TUTAR}</code>, <code>{TARIH}</code>, <code>{GUN_KALDI}</code>, <code>{DONEM_BASLANGIC}</code>, <code>{DONEM_BITIS}</code>, <code>{DERS_SAYISI}</code></small>
                                </div>
                                
                                <!-- Yeti≈ükin √úyeler ƒ∞√ßin -->
                                <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                    <label for="template-upcomingPayment-adult" style="font-weight: 600; color: #2196F3;">üë§ Yeti≈ükin √úyeler ƒ∞√ßin</label>
                                    <textarea id="template-upcomingPayment-adult" name="upcomingPaymentAdult" class="form-control" rows="4" placeholder="√ñrn: Sayƒ±n {UYE_AD_SOYAD}, {TARIH} tarihinde {TUTAR} TL √∂demeniz bulunmaktadƒ±r."></textarea>
                                    <small style="color: #666;">Kullanƒ±labilir: <code>{UYE_AD_SOYAD}</code>, <code>{TUTAR}</code>, <code>{TARIH}</code>, <code>{GUN_KALDI}</code>, <code>{DONEM_BASLANGIC}</code>, <code>{DONEM_BITIS}</code>, <code>{DERS_SAYISI}</code></small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                    <input type="checkbox" id="upcomingPayment-enabled" name="upcomingPaymentEnabled" style="width: auto;">
                                    <label for="upcomingPayment-enabled" style="margin: 0;">Bu ≈üablonu etkinle≈ütir</label>
                                </div>
                            </div>

                            <!-- G√∂rev Mesajƒ± Bildirimi ≈ûablonu -->
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">üí¨ G√∂rev Mesajƒ± Bildirimi ≈ûablonu</h4>
                                <div class="form-group">
                                    <label for="template-taskMessage">Mesaj Metni</label>
                                    <textarea id="template-taskMessage" name="taskMessage" class="form-control" rows="7" placeholder="√ñrn: Sayƒ±n {UYE_AD_SOYAD}, {GOREV} g√∂revi i√ßin yeni bir mesaj aldƒ±nƒ±z: {MESAJ}"></textarea>
                                    <small style="color: #666;">Kullanƒ±labilir deƒüi≈ükenler: <code>{UYE_AD_SOYAD}</code>, <code>{GOREV}</code>, <code>{MESAJ}</code>, <code>{GONDEREN}</code>, <code>{TARIH}</code></small>
                                </div>
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="taskMessage-enabled" name="taskMessageEnabled" style="width: auto;">
                                    <label for="taskMessage-enabled" style="margin: 0;">G√∂rev mesajƒ± eklendiƒüinde otomatik bildirim g√∂nder</label>
                                </div>
                            </div>

                            <!-- Bekleyen Kayƒ±t Hatƒ±rlatma ≈ûablonu -->
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">‚è≥ Bekleyen Kayƒ±t Hatƒ±rlatma ≈ûablonu</h4>
                                
                                <!-- √áocuk √úyeler ƒ∞√ßin -->
                                <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                    <label for="template-pendingRegistration-child" style="font-weight: 600; color: #4CAF50;">üë∂ √áocuk √úyeler ƒ∞√ßin (Veliye g√∂nderilir)</label>
                                    <textarea id="template-pendingRegistration-child" name="pendingRegistrationChild" class="form-control" rows="7" placeholder="√ñrn: Sayƒ±n {UYE_AD_SOYAD}, Kul√ºb√ºm√ºze {OGRENCI_AD_SOYAD} i√ßin √∂n kaydƒ±nƒ±z alƒ±nmƒ±≈ütƒ±r ancak kayƒ±t i≈ülemleriniz hen√ºz tamamlanmamƒ±≈ütƒ±r."></textarea>
                                    <small style="color: #666;">Kullanƒ±labilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code>, <code>{LINK}</code>, <code>{TARIH}</code></small>
                                </div>
                                
                                <!-- Yeti≈ükin √úyeler ƒ∞√ßin -->
                                <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                    <label for="template-pendingRegistration-adult" style="font-weight: 600; color: #2196F3;">üë§ Yeti≈ükin √úyeler ƒ∞√ßin</label>
                                    <textarea id="template-pendingRegistration-adult" name="pendingRegistrationAdult" class="form-control" rows="7" placeholder="√ñrn: Sayƒ±n {UYE_AD_SOYAD}, Kul√ºb√ºm√ºze √∂n kaydƒ±nƒ±z alƒ±nmƒ±≈ütƒ±r ancak kayƒ±t i≈ülemleriniz hen√ºz tamamlanmamƒ±≈ütƒ±r."></textarea>
                                    <small style="color: #666;">Kullanƒ±labilir: <code>{UYE_AD_SOYAD}</code>, <code>{LINK}</code>, <code>{TARIH}</code></small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                    <input type="checkbox" id="pendingRegistration-enabled" name="pendingRegistrationEnabled" style="width: auto;">
                                    <label for="pendingRegistration-enabled" style="margin: 0;">Bu ≈üablonu etkinle≈ütir</label>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary">üíæ ≈ûablonlarƒ± Kaydet</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- WhatsApp Section -->
            <div id="whatsapp" class="section">
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>üì± WhatsApp Mesajla≈üma Merkezi</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="openScheduleMessageModal()" title="Tarayƒ±cƒ± kapalƒ± olsa bile g√∂nderilir">
                                ‚è∞ Mesaj Zamanla
                            </button>
                            <button class="btn btn-success" onclick="openCampaignModal()" title="Toplu kampanya mesajƒ± g√∂nder">
                                üì¢ Kampanya Olu≈ütur
                            </button>
                        </div>
                    </div>

                    <!-- Tabs for different sections -->
                    <div class="settings-tabs" style="margin-bottom: 20px;">
                        <button class="settings-tab active" onclick="switchWhatsAppTab('messages')">üí¨ Mesajla≈üma</button>
                        <button class="settings-tab" onclick="switchWhatsAppTab('devices')">üì± Cihazlar</button>
                        <button class="settings-tab" onclick="switchWhatsAppTab('bulk')">üì§ Toplu Mesaj</button>
                        <button class="settings-tab" onclick="switchWhatsAppTab('reports')">üìä Mesaj Raporlarƒ±</button>
                    </div>

                    <!-- Tab Content: Mesajla≈üma -->
                    <div id="whatsapp-tab-messages" class="settings-tab-content active">
                        <!-- Step 1: Cihaz Se√ßimi -->
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0;">üì± 1. WhatsApp Cihazƒ± Se√ßin</h4>
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <select id="whatsapp-active-device" class="form-control" style="flex: 1; max-width: 400px;" onchange="onDeviceSelectionChange()">
                                    <option value="">Bir cihaz se√ßin...</option>
                                </select>
                                <div id="whatsapp-device-info" style="flex: 1; color: #666; font-size: 14px;"></div>
                            </div>
                        </div>

                        <!-- Step 2: Mesajla≈üma Alanƒ± (Cihaz se√ßilince g√∂r√ºn√ºr) -->
                        <div id="whatsapp-messaging-area" style="display: none;">
                            <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: 600px;">
                                <!-- Contacts List -->
                                <div style="border-right: 2px solid #eee; padding-right: 15px; overflow-y: auto;">
                                    <h4 style="margin-bottom: 15px;">üí¨ Konu≈ümalar</h4>
                                    <input type="text" id="contact-search" class="form-control" placeholder="üîç Ki≈üi ara..." style="margin-bottom: 15px;">
                                    <div id="whatsapp-contacts-list">
                                        <p class="empty-state">Y√ºkleniyor...</p>
                                    </div>
                                </div>

                                <!-- Messages Area -->
                                <div style="display: flex; flex-direction: column;">
                                    <div id="whatsapp-chat-header" style="padding: 15px; background: #f8f9fa; border-radius: 8px 8px 0 0; border-bottom: 2px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <h4 id="whatsapp-selected-contact" style="margin: 0;">Bir ki≈üi se√ßin</h4>
                                            <small id="whatsapp-selected-phone" style="color: #666;"></small>
                                        </div>
                                        <button id="refresh-messages-btn" class="btn btn-sm btn-secondary" onclick="refreshCurrentMessages()" style="display: none;">
                                            üîÑ Yenile
                                        </button>
                                    </div>
                                    
                                    <div id="whatsapp-messages-header" style="display: none; padding: 12px 20px; background: linear-gradient(135deg, #075E54 0%, #128C7E 100%); border-radius: 8px 8px 0 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <!-- Left: Profile & Info -->
                                            <div style="display: flex; align-items: center; gap: 12px; flex: 1; cursor: pointer;" onclick="showContactInfo()">
                                                <!-- Profile Picture with Online Status -->
                                                <div style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                                    <span id="chat-contact-initial">U</span>
                                                </div>
                                                
                                                <!-- Name & Status -->
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="display: flex; align-items: center; gap: 6px;">
                                                        <strong id="chat-contact-name" style="color: white; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px;"></strong>
                                                        <!-- Member/CRM Badge -->
                                                        <span id="chat-contact-badge" style="display: none; font-size: 10px; padding: 2px 6px; border-radius: 10px; color: white;"></span>
                                                    </div>
                                                    <div style="display: flex; align-items: center; gap: 4px; font-size: 12px; color: rgba(255,255,255,0.8);">
                                                        <span id="chat-contact-phone"></span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Right: Action Buttons -->
                                            <div style="display: flex; gap: 8px; align-items: center;">
                                                <!-- Search Messages -->
                                                <button onclick="searchInMessages()" title="Mesajlarda Ara" style="background: rgba(255,255,255,0.15); color: white; border: none; padding: 10px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.3s; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                                                    üîç
                                                </button>
                                                
                                                <!-- More Options -->
                                                <button onclick="showMoreOptions()" title="Daha Fazla" style="background: rgba(255,255,255,0.15); color: white; border: none; padding: 10px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.3s; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                                                    ‚ãÆ
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="whatsapp-messages-area" style="flex: 1; overflow-y: auto; padding: 20px; background-color: #E8DED3; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,.05) 10px, rgba(255,255,255,.05) 20px); max-height: calc(100vh - 300px); min-height: 400px;">
                                        <div class="empty-state" style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                            <p style="margin: 0; color: #666; font-size: 15px;">üëà Soldan bir ki≈üi se√ßin ve mesajla≈ümaya ba≈ülayƒ±n</p>
                                        </div>
                                    </div>

                                    <div id="whatsapp-message-input" style="padding: 12px 15px; background: #F0F0F0; border-radius: 0 0 8px 8px; display: none; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);">
                                        <form id="whatsappSendMessageForm" style="display: flex; gap: 10px; align-items: flex-end;">
                                            <input type="hidden" id="whatsapp-selected-number" />
                                            <textarea id="whatsapp-message-text" class="form-control" rows="1" placeholder="Bir mesaj yazƒ±n..." required style="resize: none; border-radius: 20px; border: 1px solid #ddd; padding: 10px 15px; font-size: 14px; max-height: 100px; background: white;" oninput="this.style.height='auto'; this.style.height=Math.min(this.scrollHeight, 100)+'px'" onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); this.closest('form').requestSubmit();}"></textarea>
                                            <button type="submit" class="btn" style="background: #25D366; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.3s; padding: 0;" onmouseover="this.style.background='#128C7E'" onmouseout="this.style.background='#25D366'">
                                                <span style="transform: rotate(-45deg); display: inline-block;">‚úàÔ∏è</span>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Aramalar -->
                    <!-- Tab Content: Cihazlar -->
                    <div id="whatsapp-tab-devices" class="settings-tab-content">
                        <h4 style="margin-bottom: 20px;">üì± WhatsApp Cihaz Y√∂netimi</h4>
                        
                        <!-- Add New Device -->
                        <div class="settings-subsection">
                            <h4 class="settings-subtitle">‚ûï Yeni Cihaz Ekle</h4>
                            <form id="whatsappInstanceForm-new">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="newInstanceName">Cihaz Adƒ± *</label>
                                        <input type="text" id="newInstanceName" name="instanceName" class="form-control" placeholder="√ñrn: Kulup WhatsApp" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="newInstancePhone">Telefon Numarasƒ± *</label>
                                        <input type="tel" id="newInstancePhone" name="phoneNumber" class="form-control" placeholder="905xxxxxxxxx" required>
                                    </div>
                                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 10px 0;">
                                        <p style="margin: 0; font-size: 13px; color: #1976d2;">
                                            ‚ÑπÔ∏è <strong>Evolution API:</strong> ${EVOLUTION_API_URL}<br>
                                            <small>API yapƒ±landƒ±rmasƒ± otomatik olarak yapƒ±lmaktadƒ±r.</small>
                                        </p>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success">üîó Cihaz Olu≈ütur ve QR Kod Al</button>
                            </form>
                        </div>

                        <!-- Ana Hat Se√ßimi -->
                        <div class="settings-subsection" style="background: #fff9e6; border-left: 4px solid #ffc107;">
                            <h4 class="settings-subtitle">‚≠ê Ana WhatsApp Hattƒ±</h4>
                            <p style="margin-bottom: 15px; color: #856404; font-size: 13px;">
                                üì¢ Otomatik bildirimlerde (g√∂rev, √∂deme hatƒ±rlatma vb.) bu hat kullanƒ±lacaktƒ±r.
                            </p>
                            <div class="form-group">
                                <label for="defaultWhatsAppDevice">Varsayƒ±lan Cihaz</label>
                                <select id="defaultWhatsAppDevice" class="form-control" onchange="setDefaultWhatsAppDevice(this.value)">
                                    <option value="">Cihaz se√ßin...</option>
                                </select>
                            </div>
                        </div>

                        <!-- Send Test Message -->
                        <div class="settings-subsection" style="background: #e7f5ff; border-left: 4px solid #1890ff;">
                            <h4 class="settings-subtitle">üì® Test Mesajƒ± G√∂nder</h4>
                            <p style="margin-bottom: 15px; color: #0066cc; font-size: 13px;">
                                üí° Baƒülƒ± bir cihazƒ±nƒ±z varsa buradan test mesajƒ± g√∂nderebilirsiniz.
                            </p>
                            <form id="testMessageForm" onsubmit="window.sendTestWhatsAppMessage(event)">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="testMessageDevice">Cihaz Se√ßin *</label>
                                        <select id="testMessageDevice" class="form-control" required>
                                            <option value="">√ñnce cihaz baƒülayƒ±n...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="testMessagePhone">Alƒ±cƒ± Telefon Numarasƒ± *</label>
                                        <input type="tel" id="testMessagePhone" class="form-control" placeholder="905xxxxxxxxx" required>
                                        <small style="color: #666;">√ñrnek: 905449367543 (90 ile ba≈ülamalƒ±)</small>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="testMessageText">Mesaj Metni *</label>
                                    <textarea id="testMessageText" class="form-control" rows="3" placeholder="Merhaba, bu bir test mesajƒ±dƒ±r." required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">üì§ Mesaj G√∂nder</button>
                            </form>
                        </div>

                        <!-- Connected Devices -->
                        <div class="settings-subsection">
                            <h4 class="settings-subtitle">üìã Baƒülƒ± Cihazlar</h4>
                            <div id="whatsappDevicesList-main">
                                <p class="empty-state">Hen√ºz baƒülƒ± cihaz yok.</p>
                            </div>
                        </div>

                        <!-- ‚úÖ Random Mesaj Bekleme S√ºresi Ayarlarƒ± -->
                        <div class="settings-subsection">
                            <h4 class="settings-subtitle">üì± WhatsApp Mesaj G√∂nderim S√ºreleri</h4>
                            <p style="color: #666; margin-bottom: 15px;">
                                Toplu mesaj g√∂nderimlerinde mesajlar arasƒ±nda random (rastgele) bekleme s√ºreleri kullanƒ±lƒ±r. 
                                Bu sayede mesajlar daha doƒüal g√∂r√ºn√ºr ve WhatsApp limitlerini a≈ümamƒ±≈ü olursunuz.
                            </p>
                            
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                                <div class="form-group">
                                    <label for="minWaitTime">Min Bekleme (sn) *</label>
                                    <input type="number" id="minWaitTime" name="minWaitTime" class="form-control" 
                                           min="5" max="60" value="20">
                                    <small style="color: #666; display: block; margin-top: 4px;">Minimum bekleme s√ºresi</small>
                                </div>
                                <div class="form-group">
                                    <label for="maxWaitTime">Max Bekleme (sn) *</label>
                                    <input type="number" id="maxWaitTime" name="maxWaitTime" class="form-control" 
                                           min="10" max="120" value="50">
                                    <small style="color: #666; display: block; margin-top: 4px;">Maximum bekleme s√ºresi</small>
                                </div>
                            </div>
                            
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                                <div class="form-group">
                                    <label for="longWaitTrigger">Uzun Bekleme Tetikleyicisi *</label>
                                    <input type="number" id="longWaitTrigger" name="longWaitTrigger" class="form-control" 
                                           min="10" max="500" value="100">
                                    <small style="color: #666; display: block; margin-top: 4px;">Her X mesajda bir uzun bekleme</small>
                                </div>
                                <div class="form-group">
                                    <label for="minLongWait">Min Uzun Bekleme (sn) *</label>
                                    <input type="number" id="minLongWait" name="minLongWait" class="form-control" 
                                           min="60" max="600" value="400">
                                    <small style="color: #666; display: block; margin-top: 4px;">Uzun beklemede minimum s√ºre</small>
                                </div>
                                <div class="form-group">
                                    <label for="maxLongWait">Max Uzun Bekleme (sn) *</label>
                                    <input type="number" id="maxLongWait" name="maxLongWait" class="form-control" 
                                           min="120" max="1200" value="800">
                                    <small style="color: #666; display: block; margin-top: 4px;">Uzun beklemede maximum s√ºre</small>
                                </div>
                            </div>
                            
                            <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3; margin-top: 10px;">
                                <strong>‚ÑπÔ∏è √ñrnek:</strong> 100 mesaj g√∂nderildiƒüinde, her mesaj arasƒ±nda 20-50 saniye beklenecek. 
                                Her 100 mesajda bir ise 400-800 saniye uzun bekleme yapƒ±lacak.
                            </div>
                        </div>

                        <!-- ‚úÖ √áalƒ±≈üma Saatleri Ayarlarƒ± -->
                        <div class="settings-subsection">
                            <h4 class="settings-subtitle">üïê Mesaj G√∂nderim √áalƒ±≈üma Saatleri</h4>
                            <p style="color: #666; margin-bottom: 15px;">
                                Belirlediƒüiniz saat aralƒ±ƒüƒ± dƒ±≈üƒ±nda g√∂nderilmeye √ßalƒ±≈üƒ±lan mesajlar otomatik olarak sƒ±raya alƒ±nƒ±r ve uygun saatte g√∂nderilir.
                            </p>
                            
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="workingHoursEnabled" onchange="toggleWorkingHoursFields()">
                                    <strong>√áalƒ±≈üma Saatleri Aktif</strong>
                                </label>
                            </div>
                            
                            <div id="workingHoursFields" style="display: none;">
                                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                                    <div class="form-group">
                                        <label for="workingHoursStart">Ba≈ülangƒ±√ß Saati</label>
                                        <input type="time" id="workingHoursStart" class="form-control" value="09:00">
                                    </div>
                                    <div class="form-group">
                                        <label for="workingHoursEnd">Biti≈ü Saati</label>
                                        <input type="time" id="workingHoursEnd" class="form-control" value="18:00">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>√áalƒ±≈üma G√ºnleri</label>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px;">
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="workDay-1" checked> Pazartesi
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="workDay-2" checked> Salƒ±
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="workDay-3" checked> √áar≈üamba
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="workDay-4" checked> Per≈üembe
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="workDay-5" checked> Cuma
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="workDay-6"> Cumartesi
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="workDay-0"> Pazar
                                        </label>
                                    </div>
                                </div>
                                
                                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-top: 10px;">
                                    <strong>‚ö†Ô∏è √ñnemli:</strong> √áalƒ±≈üma saatleri dƒ±≈üƒ±nda g√∂nderilmeye √ßalƒ±≈üƒ±lan mesajlar sƒ±raya alƒ±nƒ±r ve bir sonraki uygun √ßalƒ±≈üma saatinde otomatik olarak g√∂nderilir.
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-primary" style="margin-top: 15px;" onclick="saveWhatsAppSettings()">üíæ T√ºm Ayarlarƒ± Kaydet</button>
                        </div>

                        <!-- ‚úÖ Mesaj Kuyruƒüu -->
                        <div class="settings-subsection">
                            <h4 class="settings-subtitle">üìã Bekleyen Mesaj Kuyruƒüu</h4>
                            <div id="messageQueueList">
                                <p class="empty-state">Kuyrukta bekleyen mesaj yok.</p>
                            </div>
                        </div>

                        <!-- Son G√∂nderilen Mesajlar -->
                        <div class="settings-subsection">
                            <h4 class="settings-subtitle">üì¨ Son G√∂nderilen Mesajlar (Son 20)</h4>
                            <div id="sentMessagesLog">
                                <p class="empty-state">Hen√ºz mesaj g√∂nderilmedi.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Toplu Mesaj -->
                    <div id="whatsapp-tab-bulk" class="settings-tab-content">
                        <h4 style="margin-bottom: 20px;">üì§ Toplu Mesaj G√∂nderimi</h4>
                        
                        <div class="settings-subsection">
                            <form id="bulkMessageForm">
                                <!-- Step 1: Bran≈ü Se√ßimi -->
                                <div class="form-group">
                                    <label>1Ô∏è‚É£ Bran≈ü Se√ßin *</label>
                                    <select class="form-control" id="bulk-branch-selector" required>
                                        <option value="">Bran≈ü se√ßin...</option>
                                        <!-- Bran≈ülar dinamik olarak y√ºklenecek -->
                                        <option value="all">‚ú® T√ºm Bran≈ülar</option>
                                    </select>
                                </div>
                                
                                <!-- Step 2: Grup Se√ßimi (√áoklu) -->
                                <div class="form-group" id="bulk-groups-container" style="display: none;">
                                    <label>2Ô∏è‚É£ Gruplarƒ± Se√ßin</label>
                                    <div style="margin-bottom: 10px;">
                                        <input type="text" id="bulk-group-search" class="form-control" placeholder="üîç Grup ara..." style="margin-bottom: 10px;" oninput="filterBulkGroups()">
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="selectAllGroups()">‚úì Hepsini ƒ∞≈üaretle</button>
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="deselectAllGroups()">‚úó Temizle</button>
                                        <button type="button" class="btn btn-sm btn-primary" onclick="confirmGroupSelection()">‚úÖ Onayla ve Devam Et</button>
                                    </div>
                                    <div id="bulk-groups-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #f8f9fa;">
                                        <!-- Gruplar buraya y√ºklenecek -->
                                    </div>
                                </div>
                                
                                <!-- Step 3: Se√ßilen Ki≈üiler Listesi -->
                                <div class="form-group" id="bulk-recipients-container" style="display: none;">
                                    <label>3Ô∏è‚É£ Mesaj Alacak Ki≈üiler <span id="bulk-recipient-count-badge" class="badge bg-primary">0</span></label>
                                    <div style="margin-bottom: 10px;">
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="selectAllRecipients()">‚úì Hepsini ƒ∞≈üaretle</button>
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="deselectAllRecipients()">‚úó Temizle</button>
                                        <button type="button" class="btn btn-sm btn-success" onclick="confirmRecipientSelection()">‚úÖ Ki≈üileri Onayla</button>
                                    </div>
                                    <div id="bulk-recipients-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #fff;">
                                        <!-- Ki≈üiler buraya y√ºklenecek -->
                                    </div>
                                </div>

                                <!-- Mesaj Metni -->
                                <div class="form-group">
                                    <label>4Ô∏è‚É£ Mesaj Metni *</label>
                                    <textarea class="form-control" id="bulk-message-text" rows="5" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." required></textarea>
                                    <div style="margin-top: 8px; padding: 10px; background: #f0f8ff; border-radius: 6px; border: 1px solid #b3d9ff;">
                                        <strong style="color: #0066cc;">üí° Kullanƒ±labilecek Deƒüi≈ükenler:</strong>
                                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                                            <code style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{UYE_AD_SOYAD}</code>
                                            <code style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{OGRENCI_AD_SOYAD}</code>
                                            <code style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{TUTAR}</code>
                                            <code style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{TARIH}</code>
                                            <code style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{MESAJ}</code>
                                        </div>
                                        <small style="color: #666; margin-top: 6px; display: block;">
                                            <strong>{UYE_AD_SOYAD}:</strong> Yeti≈ükinde √ºyenin kendisi, √ßocukta veli adƒ± | 
                                            <strong>{OGRENCI_AD_SOYAD}:</strong> Sadece √ßocuk √ºyelerde √∂ƒürenci adƒ±
                                        </small>
                                    </div>
                                </div>

                                <!-- G√∂nderim Bilgisi -->
                                <div style="padding: 15px; background: #e7f3ff; border-radius: 8px; margin-bottom: 15px;">
                                    <strong>üìä G√∂nderim √ñzeti:</strong>
                                    <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                                        <li>Alƒ±cƒ± sayƒ±sƒ±: <strong id="bulk-final-count">0</strong> ki≈üi</li>
                                        <li>Her mesaj arasƒ±: <strong id="bulk-wait-time-display">${clubSettings.minWaitTime || 20}-${clubSettings.maxWaitTime || 50} saniye</strong> (rastgele)</li>
                                        <li>Her <strong id="bulk-long-wait-trigger">${clubSettings.longWaitTrigger || 100}</strong> mesajda bir: <strong id="bulk-long-wait-display">${clubSettings.minLongWait || 400}-${clubSettings.maxLongWait || 800} saniye</strong> uzun bekleme</li>
                                        <li>Tahmini s√ºre: <strong id="bulk-estimated-time">-</strong></li>
                                    </ul>
                                    <small style="color: #666; margin-top: 8px; display: block;">
                                        ‚öôÔ∏è Ayarlarƒ± deƒüi≈ütirmek i√ßin WhatsApp > Cihazlar > Mesaj G√∂nderim Ayarlarƒ± b√∂l√ºm√ºne gidin.
                                    </small>
                                </div>

                                <!-- G√∂nderim Durumu -->
                                <div id="bulk-sending-status" style="display: none; padding: 15px; background: #fff3cd; border-radius: 8px; margin-bottom: 15px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                        <div class="spinner-border spinner-border-sm" role="status"></div>
                                        <strong>Mesajlar g√∂nderiliyor...</strong>
                                    </div>
                                    <div class="progress" style="height: 25px;">
                                        <div id="bulk-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0 / 0</div>
                                    </div>
                                    <div id="bulk-status-log" style="margin-top: 10px; max-height: 150px; overflow-y: auto; font-size: 12px; font-family: monospace; background: #fff; padding: 10px; border-radius: 4px;">
                                        <!-- Log mesajlarƒ± buraya -->
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary btn-lg" id="bulk-send-btn">üì§ Toplu Mesaj G√∂nder</button>
                            </form>
                        </div>
                    </div>

                    <!-- Tab Content: Kampanyalar -->
                    <div id="whatsapp-tab-campaigns" class="settings-tab-content">
                        <h4 style="margin-bottom: 20px;">üì¢ WhatsApp Kampanya Y√∂netimi</h4>
                        
                        <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
                            <strong>‚ÑπÔ∏è Kampanya Nedir?</strong>
                            <p style="margin: 10px 0 0 0; color: #666; font-size: 14px;">
                                Kampanyalar ile binlerce ki≈üiye otomatik olarak mesaj g√∂nderebilirsiniz. Sistem, mesajlarƒ± belirlediƒüiniz s√ºrede ve √ßalƒ±≈üma saatleri i√ßinde par√ßalƒ± olarak g√∂nderir.
                            </p>
                        </div>
                        
                        <!-- Aktif Kampanyalar Listesi -->
                        <div id="campaigns-list" style="margin-top: 20px;">
                            <div class="loading"><div class="spinner"></div><span>Kampanyalar y√ºkleniyor...</span></div>
                        </div>
                    </div>

                    <!-- Tab Content: Mesaj Raporlarƒ± -->
                    <div id="whatsapp-tab-reports" class="settings-tab-content">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <h2 style="color: white; margin: 0 0 10px 0; font-size: 28px; font-weight: 600;">üìä Mesaj Raporlarƒ±</h2>
                            <p style="color: rgba(255,255,255,0.9); margin: 0; font-size: 14px;">WhatsApp mesajlarƒ±nƒ±zƒ±n detaylƒ± raporlarƒ±nƒ± g√∂r√ºnt√ºleyin</p>
                        </div>
                        
                        <!-- Statistics Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); position: relative; overflow: hidden;">
                                <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                                <div style="font-size: 36px; font-weight: 700; color: white; margin-bottom: 8px; position: relative; z-index: 1;" id="report-success-count">0</div>
                                <div style="font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500; position: relative; z-index: 1;">‚úÖ Ba≈üarƒ±yla G√∂nderildi</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(240, 147, 251, 0.3); position: relative; overflow: hidden;">
                                <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                                <div style="font-size: 36px; font-weight: 700; color: white; margin-bottom: 8px; position: relative; z-index: 1;" id="report-failed-count">0</div>
                                <div style="font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500; position: relative; z-index: 1;">‚ùå Ba≈üarƒ±sƒ±z</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #fda085 0%, #f6d365 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(253, 160, 133, 0.3); position: relative; overflow: hidden;">
                                <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                                <div style="font-size: 36px; font-weight: 700; color: white; margin-bottom: 8px; position: relative; z-index: 1;" id="report-pending-count">0</div>
                                <div style="font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500; position: relative; z-index: 1;">‚è≥ Sƒ±rada Bekliyor</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3); position: relative; overflow: hidden;">
                                <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                                <div style="font-size: 36px; font-weight: 700; color: white; margin-bottom: 8px; position: relative; z-index: 1;" id="report-total-count">0</div>
                                <div style="font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500; position: relative; z-index: 1;">üìä Toplam Mesaj</div>
                            </div>
                        </div>
                        
                        <!-- Filter Options -->
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 25px;">
                            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 13px;">Durum Filtresi</label>
                                    <select class="form-control" id="report-filter-status" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;" onchange="filterMessageReports()">
                                <option value="all">T√ºm Durumlar</option>
                                <option value="success">‚úÖ G√∂nderildi</option>
                                <option value="failed">‚ùå Ba≈üarƒ±sƒ±z</option>
                                <option value="pending">‚è≥ Bekliyor</option>
                            </select>
                        </div>
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 13px;">Tarih Filtresi</label>
                                    <input type="date" class="form-control" id="report-filter-date" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;" onchange="filterMessageReports()">
                            </div>
                                <div style="display: flex; gap: 10px; align-items: flex-end;">
                                    <button class="btn btn-secondary" onclick="exportMessageReports()" style="padding: 10px 20px; border-radius: 8px; font-weight: 600;">üì• Excel ƒ∞ndir</button>
                                    <button class="btn btn-danger" onclick="clearMessageReports()" style="padding: 10px 20px; border-radius: 8px; font-weight: 600;">üóëÔ∏è Temizle</button>
                            </div>
                            </div>
                        </div>
                        
                        <!-- Reports Table -->
                        <div style="overflow-x: auto; max-height: 500px; overflow-y: auto;">
                            <table class="modern-table" style="width: 100%; font-size: 14px;">
                                <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                                    <tr>
                                        <th style="width: 140px;">Tarih/Saat</th>
                                        <th style="width: 150px;">Alƒ±cƒ±</th>
                                        <th style="width: 120px;">Telefon</th>
                                        <th style="min-width: 200px;">Mesaj</th>
                                        <th style="width: 120px;">Cihaz</th>
                                        <th style="width: 100px;">Durum</th>
                                        <th style="width: 80px;">ƒ∞≈ülem</th>
                                    </tr>
                                </thead>
                                <tbody id="message-reports-table">
                                    <tr><td colspan="7" class="empty-state">Mesaj raporu y√ºkleniyor...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CRM Section -->
            <div id="crm" class="section">
                <!-- CRM Dashboard - Modern Design -->
                <div style="display: grid; gap: 20px;">
                    <!-- Bran≈ü Etiket ƒ∞statistikleri -->
                    <div class="card">
                        <div class="card-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                            <h3 style="margin: 0;">üìä Bran≈ü Bazlƒ± Etiket Sayƒ±larƒ±</h3>
                                <button id="toggle-branch-stats-btn" onclick="toggleBranchStats()" style="background: none; border: none; cursor: pointer; font-size: 20px; padding: 5px; transition: all 0.2s;" title="ƒ∞statistikleri Gizle/G√∂ster">
                                    üëÅÔ∏è
                                </button>
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="openAddLeadModal()">‚ûï Yeni Potansiyel M√º≈üteri</button>
                                <button class="btn btn-success" onclick="openBulkImportModal()" title="Excel/CSV ile toplu m√º≈üteri ekle">üì• Toplu ƒ∞√ße Aktar</button>
                                <button class="btn btn-info" onclick="importMembersToCRM()" title="Mevcut √ºyeleri CRM'e aktar">üë• √úyeleri CRM'e Aktar</button>
                            </div>
                        </div>
                        <div id="branch-tag-stats" style="display: grid; gap: 15px;">
                            <!-- Branch tag stats will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- G√ºn√ºn Denemeleri & Yakla≈üan Kayƒ±t Olabilirler & Cevapsƒ±z √áaƒürƒ±lar -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                        <div class="card">
                            <div class="card-title">
                                <h3>üéæ Bug√ºn√ºn Denemeleri</h3>
                            </div>
                            <div id="today-trials-list"></div>
                        </div>
                        
                        <div class="card">
                            <div class="card-title">
                                <h3>üìÖ Yakla≈üan Kayƒ±t Olabilirler</h3>
                            </div>
                            <div id="upcoming-registrations-list"></div>
                        </div>
                    </div>
                    
                    <!-- Bran≈ü & Etiket Daƒüƒ±lƒ±mƒ± -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                        <div class="card">
                            <div class="card-title">
                                <h3>üéØ Bran≈ü Daƒüƒ±lƒ±mƒ±</h3>
                            </div>
                            <div id="branch-distribution"></div>
                        </div>
                        
                        <div class="card">
                            <div class="card-title">
                                <h3>üè∑Ô∏è Etiket Daƒüƒ±lƒ±mƒ±</h3>
                            </div>
                            <div id="tag-distribution"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CRM M√º≈üteri Filtrele Section -->
            <div id="crm-filter" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="card-title" style="margin: 0;">üîç M√º≈üteri Filtrele</h2>
                    <button class="btn btn-primary" onclick="openAddLeadModal()">
                        ‚ûï Yeni Potansiyel M√º≈üteri
                    </button>
                </div>
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 16px; margin: 0;">Filtreler</h3>
                        <button class="btn btn-sm btn-secondary" onclick="clearCRMFilters()">üîÑ Temizle</button>
                    </div>

                    <!-- Filtreler -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label>Bran≈ü</label>
                            <select id="filter-branch" class="form-control" onchange="applyCustomerFilters()">
                                <option value="all">T√ºm Bran≈ülar</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Ya≈ü Grubu</label>
                            <select id="filter-age-group" class="form-control" onchange="applyCustomerFilters()">
                                <option value="all">T√ºm√º</option>
                                <option value="child">üë∂ √áocuk</option>
                                <option value="adult">üë® Yeti≈ükin</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Etiket</label>
                            <select id="filter-tag" class="form-control" onchange="applyCustomerFilters()">
                                <option value="all">T√ºm√º</option>
                                <!-- Etiketler buraya y√ºklenecek -->
                            </select>
                        </div>

                    </div>
                    
                    <!-- Son ƒ∞≈ülem Tarihi Filtresi -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label>üìÖ Son ƒ∞≈ülem Ba≈ülangƒ±√ß</label>
                            <input type="date" id="filter-date-start" class="form-control" onchange="applyCustomerFilters()">
                        </div>
                        <div class="form-group">
                            <label>üìÖ Son ƒ∞≈ülem Biti≈ü</label>
                            <input type="date" id="filter-date-end" class="form-control" onchange="applyCustomerFilters()">
                        </div>
                    </div>

                    <!-- Arama -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <input type="text" id="filter-search" class="form-control search-input" placeholder="ƒ∞sim, telefon veya email ile ara..." oninput="applyCustomerFilters()">
                    </div>
                    
                    <!-- Sƒ±ralama -->
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>üîΩ Sƒ±ralama</label>
                        <select id="filter-sort" class="form-control" onchange="applyCustomerFilters()">
                            <option value="date-desc">Son ƒ∞≈ülem Tarihi (Yeni ‚Üí Eski)</option>
                            <option value="date-asc">Son ƒ∞≈ülem Tarihi (Eski ‚Üí Yeni)</option>
                            <option value="age-desc">Ya≈ü (B√ºy√ºkten K√º√ß√ºƒüe)</option>
                            <option value="age-asc">Ya≈ü (K√º√ß√ºkten B√ºy√ºƒüe)</option>
                            <option value="name-asc">ƒ∞sim (A ‚Üí Z)</option>
                            <option value="name-desc">ƒ∞sim (Z ‚Üí A)</option>
                        </select>
                    </div>

                    <!-- ƒ∞statistikler -->
                    <div id="filter-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px; border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 20px; font-weight: bold;" id="total-filtered">0</div>
                            <div style="font-size: 11px; opacity: 0.9;">Toplam</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 12px; border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 20px; font-weight: bold;" id="new-filtered">0</div>
                            <div style="font-size: 11px; opacity: 0.9;">Yeni</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 12px; border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 20px; font-weight: bold;" id="trial-filtered">0</div>
                            <div style="font-size: 11px; opacity: 0.9;">Deneme</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 12px; border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 20px; font-weight: bold;" id="converted-filtered">0</div>
                            <div style="font-size: 11px; opacity: 0.9;">√úye Oldu</div>
                        </div>
                    </div>
                </div>

                <!-- Filtrelenmi≈ü M√º≈üteri Listesi -->
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 16px; margin: 0;">üìã Filtrelenmi≈ü M√º≈üteriler</h3>
                        <button class="btn btn-sm btn-success" onclick="exportFilteredCustomers()">üì• Dƒ±≈üa Aktar</button>
                    </div>
                    <div id="filtered-customers-list">
                        <div class="empty-state">
                            <h3>Filtre uygulayƒ±n</h3>
                            <p>Yukarƒ±daki filtrelerden m√º≈üterileri se√ßin</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CRM Denemeler Section -->
            <div id="crm-trials" class="section">
                <h2 class="card-title" style="margin-bottom: 20px;">üéæ Deneme Dersleri</h2>
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 16px; margin: 0;">ƒ∞statistikler</h3>
                        <button class="btn btn-sm btn-primary" onclick="openAddTrialModal()">‚ûï Deneme Ekle</button>
                    </div>

                    <!-- Deneme ƒ∞statistikleri -->
                    <!-- Filtreler -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <select id="trial-branch-filter" class="form-control" style="width: 150px;" onchange="renderTrials()">
                            <option value="all">T√ºm Bran≈ülar</option>
                        </select>
                        <input type="text" id="trial-search" class="form-control search-input" placeholder="M√º≈üteri ara..." style="flex: 1; min-width: 200px;" oninput="renderTrials()">
                    </div>
                </div>

                <!-- Deneme Listesi -->
                <div class="card">
                    <div class="card-title">
                        <h3 style="font-size: 16px; margin: 0;">üìã Deneme Dersi Listesi</h3>
                    </div>
                    <div id="trials-list">
                        <div class="empty-state">
                            <h3>Hen√ºz deneme dersi kaydƒ± yok</h3>
                            <p>Yeni deneme eklemek i√ßin yukarƒ±daki butonu kullanƒ±n</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kampanya Olu≈ütur Section -->
            <div id="campaigns" class="section">
                <div class="card">
                    <div class="card-title">
                        <h3>üì¢ Kampanya Olu≈ütur</h3>
                    </div>
                    <p style="color: #666; margin-bottom: 20px;">
                        CRM'deki m√º≈üterilere toplu mesaj g√∂nderin. Filtreleme se√ßeneklerini kullanarak hedef kitlenizi belirleyin.
                    </p>
                    
                    <div id="campaign-form">
                        <!-- Filtreler -->
                        <div class="card" style="background: #f8f9fa; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 15px; font-size: 16px;">üéØ Hedef Kitle Se√ßimi</h4>
                            <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                                <div class="form-group">
                                    <label>Bran≈ü Filtrele</label>
                                    <select id="campaign-branch-filter" class="form-control" onchange="updateCampaignRecipients()">
                                        <option value="all">T√ºm Bran≈ülar</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Etiket Filtrele</label>
                                    <select id="campaign-tag-filter" class="form-control" onchange="updateCampaignRecipients()">
                                        <option value="all">T√ºm Etiketler</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Ya≈ü Grubu</label>
                                    <select id="campaign-agegroup-filter" class="form-control" onchange="updateCampaignRecipients()">
                                        <option value="all">Hepsi</option>
                                        <option value="adult">Yeti≈ükin</option>
                                        <option value="child">√áocuk</option>
                                    </select>
                                </div>
                            </div>
                            <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px;">
                                <strong>Se√ßilen M√º≈üteri Sayƒ±sƒ±:</strong> <span id="campaign-recipient-count" style="font-size: 20px; color: #667eea; font-weight: bold;">0</span>
                            </div>
                        </div>
                        
                        <!-- Mesaj Ayarlarƒ± -->
                        <div class="card">
                            <h4 style="margin-bottom: 15px; font-size: 16px;">üí¨ Mesaj Ayarlarƒ±</h4>
                            <div class="form-group">
                                <label>WhatsApp Cihazƒ± *</label>
                                <select id="campaign-device" class="form-control" required>
                                    <option value="">Cihaz se√ßin...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Mesaj ƒ∞√ßeriƒüi *</label>
                                <textarea id="campaign-message" class="form-control" rows="6" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." required></textarea>
                                <small style="color: #666;">üí° ƒ∞pucu: Ki≈üisel mesajlar i√ßin {ad} ve {telefon} deƒüi≈ükenlerini kullanabilirsiniz.</small>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="campaign-send-delay"> Mesajlar arasƒ± gecikme ekle (1 saniye)
                                </label>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-success" onclick="sendCampaignMessages()" style="font-size: 16px; padding: 12px 24px;">
                                üì® Kampanyayƒ± Ba≈ülat
                            </button>
                            <button class="btn btn-secondary" onclick="resetCampaignForm()" style="font-size: 16px; padding: 12px 24px;">
                                üîÑ Formu Sƒ±fƒ±rla
                            </button>
                        </div>
                        
                        <!-- G√∂nderim Durumu -->
                        <div id="campaign-status" style="display: none; margin-top: 20px; padding: 20px; background: #e3f2fd; border-radius: 8px;">
                            <h4 style="margin-bottom: 10px;">üìä G√∂nderim Durumu</h4>
                            <div id="campaign-progress"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CRM Gelen Aramalar Section -->
            <div id="crm-incoming-calls" class="section">
                <h2 class="card-title" style="margin-bottom: 20px;">üìû Gelen Aramalar</h2>
                <div class="card">
                    <div id="incoming-calls-header" class="card-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <h3 style="font-size: 16px; margin: 0;">Son 1 Hafta ƒ∞√ßindeki Gelen Aramalar</h3>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <button class="btn btn-sm btn-secondary" onclick="renderIncomingCallsPage()">üîÑ Yenile</button>
                        </div>
                    </div>
                    
                    <!-- Sekmeler -->
                    <div style="display: flex; gap: 0; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px; margin-top: 15px; flex-wrap: wrap;">
                        <button id="tab-unanswered" class="incoming-call-tab" onclick="switchIncomingCallTab('unanswered')" style="flex: 1; min-width: 200px; padding: 12px 20px; border: none; background: #ffebee; color: #f44336; font-weight: 600; cursor: pointer; border-bottom: 3px solid #f44336; transition: all 0.3s;">
                            <span style="font-size: 16px;">üìµ Cevapsƒ±z Aramalar</span>
                            <span id="count-unanswered" style="display: block; font-size: 20px; margin-top: 5px;">0</span>
                        </button>
                        <button id="tab-callback-unanswered" class="incoming-call-tab" onclick="switchIncomingCallTab('callback-unanswered')" style="flex: 1; min-width: 200px; padding: 12px 20px; border: none; background: #fff; color: #666; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s;">
                            <span style="font-size: 16px;">‚Ü©Ô∏è D√∂n√º≈ü Yapƒ±ldƒ± Ama Cevapsƒ±z</span>
                            <span id="count-callback-unanswered" style="display: block; font-size: 20px; margin-top: 5px;">0</span>
                        </button>
                        <button id="tab-callback" class="incoming-call-tab" onclick="switchIncomingCallTab('callback')" style="flex: 1; min-width: 200px; padding: 12px 20px; border: none; background: #fff; color: #666; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s;">
                            <span style="font-size: 16px;">üìû Giden Aramada Cevaplanmƒ±≈ü</span>
                            <span id="count-callback" style="display: block; font-size: 20px; margin-top: 5px;">0</span>
                        </button>
                        <button id="tab-answered" class="incoming-call-tab" onclick="switchIncomingCallTab('answered')" style="flex: 1; min-width: 200px; padding: 12px 20px; border: none; background: #fff; color: #666; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s;">
                            <span style="font-size: 16px;">‚úÖ Gelen Aramada Cevaplanmƒ±≈ü</span>
                            <span id="count-answered" style="display: block; font-size: 20px; margin-top: 5px;">0</span>
                        </button>
                        <button id="tab-other" class="incoming-call-tab" onclick="switchIncomingCallTab('other')" style="flex: 1; min-width: 200px; padding: 12px 20px; border: none; background: #fff; color: #666; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s;">
                            <span style="font-size: 16px;">üìã Diƒüer</span>
                            <span id="count-other" style="display: block; font-size: 20px; margin-top: 5px;">0</span>
                        </button>
                    </div>
                    
                    <!-- ƒ∞√ßerik -->
                    <div id="incoming-calls-list">
                        <div class="loading"><div class="spinner"></div><span>Gelen aramalar y√ºkleniyor...</span></div>
                    </div>
                </div>
            </div>

            <!-- CRM Giden Aramalar Section -->
            <div id="crm-outgoing-calls" class="section">
                <h2 class="card-title" style="margin-bottom: 20px;">üì± Giden Aramalar</h2>
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 16px; margin: 0;">Son 1 Hafta ƒ∞√ßindeki Giden Aramalar</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label id="selectAllOutgoingLabel" style="display: none; align-items: center; gap: 5px; margin: 0; cursor: pointer;">
                                <input type="checkbox" id="selectAllOutgoing" onchange="toggleSelectAllOutgoing(this)" style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-size: 14px;">T√ºm√ºn√º Se√ß</span>
                            </label>
                            <button id="showDeleteModeOutgoingBtn" class="btn btn-sm btn-warning" onclick="showOutgoingDeleteMode()" title="Silme modunu a√ß">üóëÔ∏è Se√ßilenleri Sil</button>
                            <button id="confirmDeleteOutgoingBtn" class="btn btn-sm btn-danger" onclick="confirmDeleteOutgoingCalls()" title="Se√ßilileri sil" style="display: none;">‚úîÔ∏è Sil</button>
                            <button id="cancelDeleteOutgoingBtn" class="btn btn-sm btn-secondary" onclick="cancelOutgoingDeleteMode()" title="ƒ∞ptal" style="display: none;">‚úñÔ∏è ƒ∞ptal</button>
                            <button class="btn btn-sm btn-secondary" onclick="renderOutgoingCallsPage()">üîÑ Yenile</button>
                    </div>
                    </div>
                    <div id="outgoing-calls-list">
                        <div class="loading"><div class="spinner"></div><span>Giden aramalar y√ºkleniyor...</span></div>
                    </div>
                </div>
            </div>

            <!-- CRM Etiketler Section -->
            <div id="crm-tags" class="section">
                <h2 class="card-title" style="margin-bottom: 20px;">üè∑Ô∏è Etiket Y√∂netimi</h2>
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 16px; margin: 0;">ƒ∞statistikler</h3>
                        <button class="btn btn-sm btn-primary" onclick="openAddTagModal()">‚ûï Yeni Etiket</button>
                    </div>

                    <p style="color: #666; margin-bottom: 15px; font-size: 13px;">
                        M√º≈üterilerinizi kategorize etmek i√ßin etiketler olu≈üturun. Etiketler sayesinde m√º≈üterilerinizi kolayca gruplandƒ±rabilir ve filtreleyebilirsiniz.
                    </p>

                    <!-- Etiket ƒ∞statistikleri -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px; border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 22px; font-weight: bold;" id="total-tags">0</div>
                            <div style="font-size: 11px; opacity: 0.9;">Toplam Etiket</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 12px; border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 22px; font-weight: bold;" id="active-tags">0</div>
                            <div style="font-size: 11px; opacity: 0.9;">Aktif Etiket</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 12px; border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 22px; font-weight: bold;" id="tagged-customers">0</div>
                            <div style="font-size: 11px; opacity: 0.9;">Etiketli M√º≈üteri</div>
                        </div>
                    </div>
                </div>

                <!-- Etiket Kategorileri -->
                <div class="card">
                    <div class="card-title">
                        <h3 style="font-size: 16px; margin: 0;">üìÇ Etiket Kategorileri</h3>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                        <!-- Durum Etiketleri -->
                        <div>
                            <h4 style="color: #667eea; margin-bottom: 12px; font-size: 14px;">üìä Durum Etiketleri</h4>
                            <div id="status-tags-list" class="tags-category-list">
                                <!-- Durum etiketleri buraya y√ºklenecek -->
                            </div>
                        </div>

                        <!-- Bran≈ü Etiketleri -->
                        <div>
                            <h4 style="color: #f093fb; margin-bottom: 12px; font-size: 14px;">üéæ Bran≈ü Etiketleri</h4>
                            <div id="branch-tags-list" class="tags-category-list">
                                <!-- Bran≈ü etiketleri buraya y√ºklenecek -->
                            </div>
                        </div>

                        <!-- √ñzel Etiketler -->
                        <div>
                            <h4 style="color: #43e97b; margin-bottom: 12px; font-size: 14px;">‚≠ê √ñzel Etiketler</h4>
                            <div id="custom-tags-list" class="tags-category-list">
                                <!-- √ñzel etiketler buraya y√ºklenecek -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- T√ºm Etiketler Listesi -->
                <div class="card">
                    <div class="card-title">
                        <h3 style="font-size: 16px; margin: 0;">üìã T√ºm Etiketler</h3>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="tag-search" class="form-control search-input" placeholder="Etiket ara..." style="max-width: 300px;" oninput="renderAllTags()">
                            <select id="tag-category-filter" class="form-control" style="max-width: 200px;" onchange="renderAllTags()">
                                <option value="all">T√ºm Kategoriler</option>
                                <option value="status">Durum</option>
                                <option value="branch">Bran≈ü</option>
                                <option value="custom">√ñzel</option>
                            </select>
                        </div>
                    </div>
                    <div id="all-tags-list">
                        <div class="empty-state">
                            <h3>Hen√ºz etiket yok</h3>
                            <p>Yeni etiket eklemek i√ßin yukarƒ±daki butonu kullanƒ±n</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CRM Mesaj ≈ûablonlarƒ± Section -->
            <div id="crm-templates" class="section">
                <h2 class="card-title" style="margin-bottom: 20px;">üìù Mesaj ≈ûablonlarƒ±</h2>
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 16px; margin: 0;">Hazƒ±r Mesaj ≈ûablonlarƒ±</h3>
                        <button class="btn btn-sm btn-primary" onclick="openAddTemplateModal()">‚ûï Yeni ≈ûablon</button>
                    </div>
                    
                    <p style="color: #666; margin-bottom: 20px; font-size: 13px;">
                        M√º≈üterilerinize g√∂nderilecek mesajlar i√ßin hazƒ±r ≈üablonlar olu≈üturun. ≈ûablonlar sayesinde zaman kazanƒ±n ve tutarlƒ± ileti≈üim kurun.
                    </p>
                    
                    <!-- Varsayƒ±lan ≈ûablonlar -->
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #667eea; margin-bottom: 15px; font-size: 14px;">üíº Varsayƒ±lan ≈ûablonlar</h4>
                        <div id="default-templates-list" style="display: grid; gap: 15px;">
                            <!-- Varsayƒ±lan ≈üablonlar buraya y√ºklenecek -->
                        </div>
                    </div>
                    
                    <!-- √ñzel ≈ûablonlar -->
                    <div>
                        <h4 style="color: #f093fb; margin-bottom: 15px; font-size: 14px;">‚≠ê √ñzel ≈ûablonlar</h4>
                        <div id="custom-templates-list" style="display: grid; gap: 15px;">
                            <!-- √ñzel ≈üablonlar buraya y√ºklenecek -->
                        </div>
                    </div>
                    
                    <!-- Bo≈ü durum -->
                    <div id="no-templates" style="display: none; text-align: center; padding: 60px 20px; color: #999;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üìù</div>
                        <h3>Hen√ºz √∂zel ≈üablon yok</h3>
                        <p>Yeni ≈üablon eklemek i√ßin yukarƒ±daki butonu kullanƒ±n</p>
                    </div>
                </div>
            </div>
            
            <!-- Attendance Tracking Section -->
            <div id="attendance-tracking" class="section">
                <div class="attendance-header">
                    <h1 id="header-title-attendance" class="modern-title"></h1>
                    <a href="#" onclick="event.preventDefault(); showSection('members', document.querySelector('.nav-btn[onclick*=\'members\']'))" class="back-link" style="background: var(--primary-color); color:white;">‚Üê √úyeler Listesine D√∂n</a>
                </div>
                <div id="attendance-content">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>√úye verileri y√ºkleniyor...</span>
                    </div>
                </div>
            </div>

            <!-- User Activities Section -->
            <div id="user-activities" class="section">
                <h2 class="card-title">üìä Kullanƒ±cƒ± Hareketleri</h2>
                <div class="card">
                    <div class="card-title">
                        <h3>üë• √úye Giri≈ü Hareketleri</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="activitySearch" class="form-control search-input" placeholder="√úye ara (ƒ∞sim, Telefon)..." style="max-width: 300px;">
                            <select id="activityBranchFilter" class="form-control" style="max-width: 150px;">
                                <option value="all">T√ºm Bran≈ülar</option>
                                <option value="tenis">üéæ Tenis</option>
                                <option value="yuzme">üèä Y√ºzme</option>
                            </select>
                        </div>
                    </div>
                    <div id="activitiesTableContainer">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span>Hareketler y√ºkleniyor...</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="member-tooltip"></div>
    <div id="context-menu"></div>
    <div id="phone-context-menu">
        <button id="phone-copy-btn">Kopyala</button>
        <button id="phone-call-btn">Ara</button>
    </div>


    <!-- Zamanlanmƒ±≈ü Mesaj Modal -->
    <div id="scheduleMessageModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('scheduleMessageModal')">&times;</span>
            <h3>‚è∞ Mesaj Zamanla</h3>
            <p style="color: #666; margin-bottom: 20px;">
                ‚úÖ Tarayƒ±cƒ± kapalƒ± olsa bile Firebase Cloud Functions √ºzerinden g√∂nderilir
            </p>
            <form id="scheduleMessageForm" onsubmit="handleScheduleMessage(event)">
                <div class="form-group">
                    <label>Alƒ±cƒ± Telefon Numarasƒ± *</label>
                    <input type="tel" name="phoneNumber" class="form-control" placeholder="05xxxxxxxxx" required>
                </div>
                <div class="form-group">
                    <label>Alƒ±cƒ± Adƒ±</label>
                    <input type="text" name="recipientName" class="form-control" placeholder="ƒ∞steƒüe baƒülƒ±">
                </div>
                <div class="form-group">
                    <label>Mesaj ƒ∞√ßeriƒüi *</label>
                    <textarea name="messageText" class="form-control" rows="5" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." required></textarea>
                </div>
                <div class="form-group">
                    <label>G√∂nderim Zamanƒ± *</label>
                    <input type="datetime-local" name="scheduledTime" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Mesaj Tipi</label>
                    <select name="messageType" class="form-control">
                        <option value="custom">√ñzel Mesaj</option>
                        <option value="payment-reminder">√ñdeme Hatƒ±rlatmasƒ±</option>
                        <option value="birthday">Doƒüum G√ºn√º</option>
                        <option value="task">G√∂rev Bildirimi</option>
                        <option value="announcement">Duyuru</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">‚è∞ Zamanla</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('scheduleMessageModal')">ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Kampanya Modal -->
    <div id="campaignModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('campaignModal')">&times;</span>
            <h3>üì¢ Yeni Kampanya Olu≈ütur</h3>
            <p style="color: #666; margin-bottom: 20px;">
                Toplu mesaj g√∂nderin - Sistem, mesajlarƒ± √ßalƒ±≈üma saatleri i√ßinde par√ßalƒ± olarak g√∂nderir
            </p>
            <form id="campaignForm" onsubmit="handleCreateCampaign(event)">
                <div class="form-group">
                    <label>Kampanya Adƒ± *</label>
                    <input type="text" name="campaignName" class="form-control" placeholder="√ñrn: Mayƒ±s 2025 Kampanyasƒ±" required>
                </div>
                
                <div class="form-group">
                    <label>Hedef Kitle *</label>
                    <select name="targetAudience" class="form-control" onchange="updateCampaignRecipientCount(this.value)" required>
                        <option value="">Se√ßiniz...</option>
                        <option value="all-members">üë• T√ºm √úyeler</option>
                        <option value="active-members">‚úÖ Aktif √úyeler</option>
                        <option value="inactive-members">‚è∏Ô∏è Pasif √úyeler</option>
                        <option value="crm-all">üìã T√ºm CRM M√º≈üterileri</option>
                        <option value="crm-by-tag">üè∑Ô∏è CRM - Etikete G√∂re</option>
                        <option value="crm-by-branch">üéØ CRM - Bran≈üa G√∂re</option>
                    </select>
                </div>
                
                <div id="campaign-tag-filter" class="form-group" style="display:none;">
                    <label>Etiket Se√ßin</label>
                    <select name="crmTag" class="form-control" id="campaign-tag-select"></select>
                </div>
                
                <div id="campaign-branch-filter" class="form-group" style="display:none;">
                    <label>Bran≈ü Se√ßin</label>
                    <select name="crmBranch" class="form-control" id="campaign-branch-select"></select>
                </div>
                
                <div class="form-group">
                    <label>Mesaj ƒ∞√ßeriƒüi *</label>
                    <textarea name="messageContent" class="form-control" rows="5" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." required></textarea>
                    <small style="color: #666;">Deƒüi≈ükenler: {AD_SOYAD}, {AD}, {TELEFON}</small>
                </div>
                
                <div style="background: #fff9e6; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ffc107;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px;">üìä Par√ßalƒ± G√∂nderim Ayarlarƒ±</h4>
                    
                    <div class="form-group">
                        <label>G√ºnl√ºk G√∂nderim Limiti</label>
                        <input type="number" name="dailyLimit" class="form-control" value="200" min="10" max="1000" required>
                        <small style="color: #666;">Her g√ºn en fazla ka√ß mesaj g√∂nderilsin?</small>
                    </div>
                    
                    <div class="form-group">
                        <label>G√∂nderim Ba≈ülangƒ±√ß Zamanƒ±</label>
                        <input type="datetime-local" name="startTime" class="form-control" required>
                        <small style="color: #666;">Kampanya ne zaman ba≈ülasƒ±n?</small>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="color: #666;">Toplam Alƒ±cƒ±:</span>
                            <strong id="campaign-recipient-count">0</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #666;">Tahmini S√ºre:</span>
                            <strong id="campaign-duration">-</strong>
                        </div>
                    </div>
                </div>
                
                <div style="background: #e7f3ff; padding: 12px; border-radius: 6px; margin-bottom: 20px;">
                    <strong>‚úÖ √áalƒ±≈üma Saatlerine Uyum:</strong>
                    <p style="margin: 8px 0 0 0; color: #666; font-size: 13px;">
                        Mesajlar, WhatsApp > Ayarlar'da belirlediƒüiniz √ßalƒ±≈üma saatleri i√ßinde g√∂nderilir.
                    </p>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">üì¢ Kampanyayƒ± Ba≈ülat</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('campaignModal')">ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add/Edit Lead Modal -->
    <div id="addLeadModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addLeadModal')">&times;</span>
            <h3>‚ûï Yeni Potansiyel M√º≈üteri</h3>
            <form id="addLeadForm" onsubmit="handleAddLead(event)">
                <div class="form-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="form-group">
                        <label>Telefon *</label>
                        <input type="tel" name="phone" class="form-control" placeholder="05xxxxxxxxx" required oninput="checkExistingPhone(this.value)">
                        <div id="phone-check-message" style="font-size: 12px; margin-top: 5px;"></div>
                    </div>
                    <div class="form-group">
                        <label>Kaynak</label>
                        <select name="source" class="form-control">
                            <option value="website">üåê Website</option>
                            <option value="phone">üìû Telefon</option>
                            <option value="referral">üë• Tavsiye</option>
                            <option value="social">üì± Sosyal Medya</option>
                            <option value="other">üîπ Diƒüer</option>
                        </select>
                    </div>
                </div>
                
                <!-- Bran≈ülar B√∂l√ºm√º -->
                <div style="margin: 20px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; font-size: 16px;">üéØ Bran≈ülar</h4>
                        <button type="button" class="btn btn-sm btn-success" onclick="addBranchField()">+ Bran≈ü Ekle</button>
                    </div>
                    <div id="branches-container">
                        <!-- Bran≈ülar buraya eklenecek -->
                    </div>
                </div>
                
                
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">üíæ Kaydet</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addLeadModal')">‚ùå ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Bulk Import Modal -->
    <div id="bulkImportModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeBulkImportModal()">&times;</span>
            <h3>üì• Toplu M√º≈üteri ƒ∞√ße Aktarma</h3>
            
            <div id="import-step-1" style="display: block;">
                <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #1976d2;">üìã Nasƒ±l Hazƒ±rlanƒ±r?</h4>
                    <p style="margin: 5px 0;">1. <strong>Excel ≈üablonunu</strong> indirin (3 ayrƒ± sayfa: M√º≈üteriler, Bran≈ülar, Etiketler)</p>
                    <p style="margin: 5px 0;">2. <strong>"Bran≈ülar"</strong> ve <strong>"Etiketler"</strong> sekmelerinden deƒüerleri kopyalayƒ±n</p>
                    <p style="margin: 5px 0;">3. <strong>"M√º≈üteriler"</strong> sekmesinde ilgili s√ºtunlara yapƒ±≈ütƒ±rƒ±n</p>
                    <p style="margin: 5px 0;">4. M√º≈üteri bilgilerini doldurun</p>
                    <p style="margin: 5px 0;">5. Dosyayƒ± <strong>Excel (.xlsx)</strong> formatƒ±nda kaydedin</p>
                    <p style="margin: 5px 0;">6. A≈üaƒüƒ±dan dosyayƒ± y√ºkleyin</p>
                    
                    <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #2196f3;">
                        <strong>üìã Nasƒ±l Kullanƒ±lƒ±r:</strong>
                        <br>‚Ä¢ Excel'de <strong>Bran≈ülar</strong> sekmesinden bran≈ü ismi kopyalayƒ±n
                        <br>‚Ä¢ <strong>M√º≈üteriler</strong> sekmesindeki "Bran≈ü" s√ºtununa yapƒ±≈ütƒ±rƒ±n
                        <br>‚Ä¢ Aynƒ± ≈üekilde <strong>Etiketler</strong> sekmesinden etiket kopyalayƒ±n
                        <br>‚Ä¢ Bu y√∂ntemle yazƒ±m hatasƒ± olmaz!
                    </div>
                    
                    <div style="background: #fff3cd; padding: 12px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #ffc107;">
                        <strong>‚ö†Ô∏è √ñnemli:</strong> Bran≈ü ve Etiket isimlerini <strong>tam olarak</strong> diƒüer sayfalardan kopyalayƒ±n.
                        <br>Elle yazarsanƒ±z yazƒ±m hatasƒ± nedeniyle y√ºkleme ba≈üarƒ±sƒ±z olabilir!
                    </div>
                    
                    <button class="btn btn-info" onclick="downloadImportTemplate()" style="margin-top: 10px;">
                        üìÑ Excel ≈ûablon ƒ∞ndir (Bran≈ü & Etiket Listeli)
                    </button>
                    <a href="CRM_TOPLU_EKLEME_TALIMATLARI.md" download class="btn btn-secondary" style="margin-top: 10px; margin-left: 10px;">
                        üìñ Detaylƒ± Talimatlar
                    </a>
                </div>
                
                <div style="border: 2px dashed #ccc; padding: 40px; text-align: center; border-radius: 8px; background: #fafafa; cursor: pointer;" 
                     onclick="document.getElementById('csvFileInput').click()">
                    <input type="file" id="csvFileInput" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleFileSelect(event)">
                    <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                    <p style="margin: 5px 0; font-size: 16px; font-weight: 600;">Excel/CSV Dosyasƒ±nƒ± Se√ßin</p>
                    <p style="margin: 5px 0; color: #666;">veya buraya s√ºr√ºkleyin</p>
                    <p style="margin: 10px 0 0 0; font-size: 12px; color: #999;">Desteklenen formatlar: .csv, .xlsx, .xls</p>
                </div>
            </div>
            
            <div id="import-step-2" style="display: none;">
                <div style="margin-bottom: 20px;">
                    <h4>üìä √ñnizleme ve Kontrol</h4>
                    <div id="import-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 15px 0;">
                        <!-- Summary stats will be here -->
                    </div>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
                    <table class="table" style="margin: 0;">
                        <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                            <tr>
                                <th style="width: 30px;">#</th>
                                <th>Telefon</th>
                                <th>Ad Soyad</th>
                                <th>Veli/√áocuk</th>
                                <th>Kaynak</th>
                                <th>Bran≈ü</th>
                                <th>Ya≈ü Grubu</th>
                                <th>Etiket</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody id="import-preview-body">
                            <!-- Preview rows will be here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="confirmBulkImport()" id="confirmImportBtn">
                        ‚úÖ T√ºm√ºn√º Ekle (<span id="valid-count">0</span> Ge√ßerli)
                    </button>
                    <button class="btn btn-secondary" onclick="closeBulkImportModal()">‚ùå ƒ∞ptal</button>
                </div>
            </div>
            
            <div id="import-step-3" style="display: none;">
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">‚è≥</div>
                    <h4>ƒ∞√ße aktarma yapƒ±lƒ±yor...</h4>
                    <div id="import-progress" style="margin: 20px 0;">
                        <div style="background: #e0e0e0; height: 30px; border-radius: 15px; overflow: hidden;">
                            <div id="import-progress-bar" style="background: linear-gradient(90deg, #4caf50, #8bc34a); height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <p id="import-progress-text" style="margin-top: 10px;">0 / 0</p>
                    </div>
                </div>
            </div>
            
            <div id="import-step-4" style="display: none;">
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">‚úÖ</div>
                    <h4>ƒ∞√ße Aktarma Tamamlandƒ±!</h4>
                    <div id="import-result" style="margin: 20px 0; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
                        <!-- Result summary will be here -->
                    </div>
                    <button class="btn btn-primary" onclick="closeBulkImportModal()">Tamam</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('paymentModal')">&times;</span>
            <h3 id="paymentModalTitle">üí∞ √ñdeme ƒ∞≈ülemi</h3>
            <form id="paymentForm">
                <input type="hidden" name="paymentPreRegId">
                <input type="hidden" name="paymentNumber">
                <div id="paymentPeriodInfoStatic" style="background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; display:none;"></div>
                <div class="form-grid" id="paymentPeriodInfo" style="display:none;">
                     <div class="form-group"><label>D√∂nem Ba≈ülangƒ±√ß</label><input type="date" class="form-control" name="periodStart"></div>
                     <div class="form-group"><label>D√∂nem Biti≈ü</label><input type="date" class="form-control" name="periodEnd"></div>
                     <div class="form-group"><label>Ders Sayƒ±sƒ±</label><input type="number" class="form-control" name="lessonCount"></div>
                </div>
                <!-- ‚úÖ Ka√ß ay daha aidat eklenecek? -->
                <div class="form-group" id="additionalMonthsField" style="display:none; margin-bottom: 20px;">
                    <label style="font-weight: 600;">üìÜ Bu aidattan sonra ka√ß ay daha aidat eklensin?</label>
                    <input type="number" class="form-control" name="additionalMonths" min="0" max="12" value="0" placeholder="√ñrn: 3 ay daha">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        0 girerseniz sadece bu ay eklenir. √ñrnek: 3 girerseniz, bu ay + 3 ay daha (toplam 4 aidat) eklenecektir.
                    </small>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>√ñdeme Tarihi</label>
                        <input type="date" class="form-control" name="paymentDate">
                    </div>
                    <div class="form-group">
                        <label>Tutar *</label>
                        <input type="text" class="form-control" name="paymentAmount" required>
                    </div>
                     <div class="form-group">
                        <label>Son √ñdeme Tarihi *</label>
                        <input type="date" class="form-control" name="paymentDueDate" required>
                    </div>
                    <div class="form-group">
                        <label>√ñdeme Y√∂ntemi</label>
                        <select class="form-control" name="paymentMethod">
                            <option value="">Se√ßiniz...</option>
                            <option value="nakit">üíµ Nakit</option>
                            <option value="kredi_karti">üí≥ Kredi Kartƒ±</option>
                            <option value="banka_havalesi">üè¶ Banka Havalesi</option>
                            <option value="eft">üì± EFT</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label>Durum</label>
                        <select class="form-control" name="paymentStatus">
                            <option value="unpaid">√ñdenmedi</option>
                            <option value="paid">√ñdendi</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Not</label>
                        <textarea class="form-control" name="paymentNote" rows="3" placeholder="Ek bilgiler..."></textarea>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">‚úÖ Kaydet</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('paymentModal')">‚ùå ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Schedule Modal (for new lessons) -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('scheduleModal')">&times;</span>
            <h3>üìÖ Yeni Ders Olu≈ütur</h3>
            <form id="newScheduleForm">
                <input type="hidden" name="groupId">
                <div class="form-grid">
                     <div class="form-group">
                        <label>Grup</label>
                        <input type="text" class="form-control" name="groupName" readonly>
                    </div>
                    <div class="form-group">
                        <label>Ba≈ülangƒ±√ß Saati *</label>
                        <input type="time" class="form-control" name="startTime" required>
                    </div>
                    <div class="form-group">
                        <label>Biti≈ü Saati *</label>
                        <input type="time" class="form-control" name="endTime" required>
                    </div>
                </div>
                <!-- ‚úÖ Saha Se√ßimi (dinamik) -->
                <div class="form-group" id="courtSelectContainer" style="display: none;">
                    <label>Saha (opsiyonel)</label>
                    <select class="form-control" name="court" id="courtSelect">
                        <option value="">Saha Se√ßiniz...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Ders G√ºnleri *</label>
                    <div id="schedule-days-checkboxes" style="display: flex; flex-wrap: wrap; gap: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px;">
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="days" value="pazartesi"> Pazartesi</label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="days" value="salƒ±"> Salƒ±</label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="days" value="√ßar≈üamba"> √áar≈üamba</label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="days" value="per≈üembe"> Per≈üembe</label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="days" value="cuma"> Cuma</label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="days" value="cumartesi"> Cumartesi</label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="days" value="pazar"> Pazar</label>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">‚úÖ Dersi Olu≈ütur</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('scheduleModal')">‚ùå ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Group Modal -->
    <div id="groupModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('groupModal')">&times;</span>
            <h3 id="groupModalTitle">üë• Grup Y√∂netimi</h3>
            <form id="groupForm">
                <input type="hidden" name="groupId">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Grup Adƒ± *</label>
                        <input type="text" class="form-control" name="groupName" placeholder="Ba≈ülangƒ±√ß Grubu" required>
                    </div>
                    <div class="form-group">
                        <label>Bran≈ü *</label>
                        <select class="form-control" name="branch" required>
                            <option value="">Se√ßiniz...</option>
                            <option value="tenis">üéæ Tenis</option>
                            <option value="yuzme">üèä Y√ºzme</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Eƒüitmen *</label>
                        <input type="text" class="form-control" name="instructor" placeholder="Eƒüitmen adƒ±" required>
                    </div>
                    <div class="form-group">
                        <label>Maksimum √úye *</label>
                        <input type="number" class="form-control" name="maxMembers" placeholder="8" required>
                    </div>
                    <div class="form-group">
                        <label>A√ßƒ±klama</label>
                        <textarea class="form-control" name="description" rows="3" placeholder="Grup a√ßƒ±klamasƒ±..."></textarea>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">‚úÖ Kaydet</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('groupModal')">‚ùå ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Payment Plan Modal -->
    <div id="paymentPlanModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('paymentPlanModal')">&times;</span>
            <h3 id="paymentPlanTitle">üìÖ √ñdeme Planƒ±</h3>
            <div id="paymentPlanContent"></div>
        </div>
    </div>

    <!-- Group Assignment Modal -->
    <div id="groupAssignModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('groupAssignModal')">&times;</span>
            <h3 id="groupAssignTitle">üë• Grup ƒ∞≈ülemleri</h3>
            <div id="groupAssignContent"></div>
        </div>
    </div>
    
    <!-- Member Edit Modal -->
    <div id="memberEditModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('memberEditModal')">&times;</span>
            <h3>‚úèÔ∏è √úye Bilgilerini D√ºzenle</h3>
            <form id="memberEditForm">
                <input type="hidden" name="memberId">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Veli Adƒ± Soyadƒ± *</label>
                        <input type="text" class="form-control" name="Ad_Soyad" required>
                    </div>
                     <div class="form-group">
                        <label>Veli 2 Adƒ± Soyadƒ±</label>
                        <input type="text" class="form-control" name="Veli_2_Adi_Soyadi">
                    </div>
                    <div class="form-group">
                        <label>Telefon Numarasƒ± *</label>
                        <input type="tel" class="form-control" name="Telefon" required>
                    </div>
                    <div class="form-group">
                        <label>Veli 2 Telefon Numarasƒ±</label>
                        <input type="tel" class="form-control" name="Telefon_2">
                    </div>
                    <div class="form-group">
                        <label>√ñƒürenci Adƒ± Soyadƒ±</label>
                        <input type="text" class="form-control" name="Resit_Olmayan_Adi_Soyadi">
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">üíæ Kaydet</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('memberEditModal')">‚ùå ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Pre-Registration Edit Modal -->
    <div id="preRegEditModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('preRegEditModal')">&times;</span>
            <h3>‚úèÔ∏è √ñn Kayƒ±t Bilgilerini D√ºzenle</h3>
            <form id="preRegEditForm">
                <input type="hidden" name="preRegId">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Veli Adƒ± Soyadƒ± *</label>
                        <input type="text" class="form-control" name="parentName" required>
                    </div>
                    <div class="form-group">
                        <label id="studentNameLabelEdit">√ñƒürenci Adƒ± Soyadƒ±</label>
                        <input type="text" class="form-control" name="studentName">
                    </div>
                    <div class="form-group">
                        <label>Bran≈ü *</label>
                        <select class="form-control" name="branch" required>
                            <option value="">Se√ßiniz...</option>
                            <option value="tenis">üéæ Tenis</option>
                            <option value="yuzme">üèä Y√ºzme</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label for="preRegEditGroupSearch">Grup</label>
                        <div class="searchable-select-container">
                            <input type="text" id="preRegEditGroupSearch" class="form-control" name="groupSearch" placeholder="Grup ara..." autocomplete="off">
                            <input type="hidden" name="groupId" id="preRegEditGroupId">
                            <div class="searchable-select-results" id="preRegEditGroupResults"></div>
                        </div>
                    </div>
                </div>
                 <div class="form-group">
                    <label>Notlar</label>
                    <textarea class="form-control" name="notes" rows="3"></textarea>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">üíæ Kaydet</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('preRegEditModal')">‚ùå ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>
    
     <!-- Attendance Modal -->
    <div id="attendanceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('attendanceModal')">&times;</span>
            <h3 id="attendanceModalTitle">üìù Yoklama</h3>
            <form id="attendanceForm">
                <input type="hidden" name="groupId">
                <div class="form-group">
                    <label for="attendanceDate">Yoklama Tarihi</label>
                    <input type="date" id="attendanceDate" name="attendanceDate" class="form-control">
                </div>
                <p>Derse katƒ±lmayan √∂ƒürencilerin i≈üaretini l√ºtfen kaldƒ±rƒ±nƒ±z.</p>
                <div id="attendanceList" class="attendance-list"></div>
                <div class="btn-group" style="margin-top:20px;">
                    <button type="submit" class="btn btn-success">‚úÖ Yoklamayƒ± G√∂nder</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('attendanceModal')">‚ùå ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('taskModal')">&times;</span>
            <h3 id="taskModalTitle">Yeni G√∂rev Ekle</h3>
            <form id="taskForm">
                <input type="hidden" name="taskId">
                <div class="form-grid">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="taskName">G√∂rev A√ßƒ±klamasƒ± *</label>
                        <input type="text" id="taskName" class="form-control" name="taskName" required>
                    </div>
                    <div class="form-group">
                        <label for="assignedTo">Sorumlu Ki≈üi *</label>
                        <select id="assignedTo" class="form-control" name="assignedTo" required></select>
                    </div>
                    <div class="form-group">
                        <label for="taskStatus">A≈üama *</label>
                        <select id="taskStatus" class="form-control" name="status" required>
                            <option value="Bekliyor">Bekliyor</option>
                            <option value="Devam Ediyor">Devam Ediyor</option>
                            <option value="Tamamlandƒ±">Tamamlandƒ±</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="taskNotes">Notlar</label>
                        <textarea id="taskNotes" class="form-control" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">‚úÖ Kaydet</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('taskModal')">‚ùå ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Task Messages Modal -->
    <div id="taskMessagesModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 80vh;">
            <span class="close" onclick="closeModal('taskMessagesModal')">&times;</span>
            <h3 id="taskMessagesModalTitle">üí¨ Mesajlar</h3>
            <div id="taskMessagesList" style="max-height: 400px; overflow-y: auto; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;"></div>
            <form id="taskMessageForm">
                <input type="hidden" name="taskId">
                <div class="form-group">
                    <label for="messageText">Mesajƒ±nƒ±z</label>
                    <textarea id="messageText" name="messageText" class="form-control" rows="3" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." required></textarea>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">üì§ G√∂nder</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('taskMessagesModal')">ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Edit Modal -->
    <div id="userEditModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('userEditModal')">&times;</span>
            <h3>üë§ Y√∂netici D√ºzenle</h3>
            <form id="userEditForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editUserFullName">Ad Soyad *</label>
                        <input type="text" class="form-control" name="fullName" required>
                    </div>
                    <div class="form-group">
                        <label for="editUserPhone">Telefon Numarasƒ± *</label>
                        <input type="tel" class="form-control" name="phone" placeholder="5449367543" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editUserPassword">≈ûifre *</label>
                    <input type="password" class="form-control" name="password" autocomplete="current-password" required>
                </div>
                <div class="form-group">
                    <label>Yetkiler</label>
                    <div class="checkbox-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        <strong style="grid-column: 1 / -1; color: #1976d2; margin-bottom: 5px;">üí∞ Finansal Yetkiler</strong>
                        <label><input type="checkbox" name="permissions" value="view_payments"> √ñdemeleri G√∂r√ºnt√ºleme</label>
                        <label><input type="checkbox" name="permissions" value="edit_payments"> √ñdemeleri D√ºzenleme</label>
                        <label><input type="checkbox" name="permissions" value="delete_payments"> √ñdemeleri Silme</label>
                        <label><input type="checkbox" name="permissions" value="export_payments"> √ñdemeleri Dƒ±≈üa Aktarma</label>
                        
                        <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">üë• √úye Yetkileri</strong>
                        <label><input type="checkbox" name="permissions" value="view_members"> √úyeleri G√∂r√ºnt√ºleme</label>
                        <label><input type="checkbox" name="permissions" value="add_members"> √úye Ekleme</label>
                        <label><input type="checkbox" name="permissions" value="edit_members"> √úye D√ºzenleme</label>
                        <label><input type="checkbox" name="permissions" value="delete_members"> √úye Silme</label>
                        <label><input type="checkbox" name="permissions" value="export_members"> √úyeleri Dƒ±≈üa Aktarma</label>
                        
                        <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">üìû CRM Yetkileri</strong>
                        <label><input type="checkbox" name="permissions" value="view_crm"> CRM G√∂r√ºnt√ºleme</label>
                        <label><input type="checkbox" name="permissions" value="add_crm"> CRM'e Ekleme</label>
                        <label><input type="checkbox" name="permissions" value="edit_crm"> CRM D√ºzenleme</label>
                        <label><input type="checkbox" name="permissions" value="delete_crm"> CRM'den Silme</label>
                        <label><input type="checkbox" name="permissions" value="view_calls"> Arama Kayƒ±tlarƒ±nƒ± G√∂r√ºnt√ºleme</label>
                        
                        <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">üí¨ ƒ∞leti≈üim Yetkileri</strong>
                        <label><input type="checkbox" name="permissions" value="send_messages"> Mesaj G√∂nderme</label>
                        <label><input type="checkbox" name="permissions" value="send_bulk_messages"> Toplu Mesaj G√∂nderme</label>
                        <label><input type="checkbox" name="permissions" value="view_message_history"> Mesaj Ge√ßmi≈üini G√∂r√ºnt√ºleme</label>
                        
                        <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">üìä Raporlar ve ƒ∞statistikler</strong>
                        <label><input type="checkbox" name="permissions" value="view_stats"> ƒ∞statistikleri G√∂r√ºnt√ºleme</label>
                        <label><input type="checkbox" name="permissions" value="view_reports"> Raporlarƒ± G√∂r√ºnt√ºleme</label>
                        <label><input type="checkbox" name="permissions" value="export_reports"> Raporlarƒ± Dƒ±≈üa Aktarma</label>
                        
                        <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">‚öôÔ∏è Ayarlar ve Y√∂netim</strong>
                        <label><input type="checkbox" name="permissions" value="manage_users"> Kullanƒ±cƒ± Y√∂netimi</label>
                        <label><input type="checkbox" name="permissions" value="manage_settings"> Ayarlarƒ± Y√∂netme</label>
                        <label><input type="checkbox" name="permissions" value="manage_branches"> Bran≈ü Y√∂netimi</label>
                        <label><input type="checkbox" name="permissions" value="manage_groups"> Grup Y√∂netimi</label>
                        
                        <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">üìã Yoklama ve Takvim</strong>
                        <label><input type="checkbox" name="permissions" value="view_attendance"> Yoklama G√∂r√ºnt√ºleme</label>
                        <label><input type="checkbox" name="permissions" value="edit_attendance"> Yoklama D√ºzenleme</label>
                        <label><input type="checkbox" name="permissions" value="manage_schedule"> Takvim Y√∂netimi</label>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">‚úÖ G√ºncelle</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('userEditModal')">ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeModal('profileModal')">&times;</span>
            <h3>Profilimi D√ºzenle</h3>
            <form id="profileForm">
                <div class="form-group">
                    <label for="profileFullName">Ad Soyad</label>
                    <input type="text" id="profileFullName" name="fullName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="profilePhone">Telefon Numarasƒ±</label>
                    <input type="tel" id="profilePhone" name="phone" class="form-control" placeholder="5449367543">
                    <small style="color: #666;">WhatsApp bildirimleri i√ßin gereklidir</small>
                </div>
                <div class="form-group">
                    <label for="newPassword">Yeni ≈ûifre (deƒüi≈ütirmek istemiyorsanƒ±z bo≈ü bƒ±rakƒ±n)</label>
                    <input type="password" id="newPassword" name="newPassword" class="form-control" autocomplete="new-password">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Yeni ≈ûifre Tekrar</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" autocomplete="new-password">
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">‚úÖ G√ºncelle</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('profileModal')">ƒ∞ptal</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 id="confirmTitle">ƒ∞≈ülemi Onayla</h3>
            <p id="confirmText" style="margin: 20px 0;">Bu i≈ülemi ger√ßekle≈ütirmek istediƒüinizden emin misiniz? Bu geri alƒ±namaz.</p>
            <div class="btn-group">
                <button id="confirmYesBtn" class="btn btn-danger">Evet, Onayla</button>
                <button class="btn btn-secondary" onclick="closeModal('confirmModal')">Hayƒ±r, ƒ∞ptal</button>
            </div>
        </div>
    </div>

    <!-- Choice Modal -->
    <div id="choiceModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeModal('choiceModal')">&times;</span>
            <h3 id="choiceTitle">ƒ∞≈ülemi Se√ßin</h3>
            <p id="choiceText" style="margin: 20px 0;"></p>
            <div class="btn-group" id="choiceButtons" style="flex-direction: row; justify-content: flex-end;">
                <!-- Buttons will be injected here by JS -->
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrCodeModal" class="modal">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <span class="close" onclick="closeModal('qrCodeModal')">&times;</span>
            <h3 id="qrCodeTitle">üì± WhatsApp QR Kod</h3>
            <p style="margin: 20px 0; color: #666;">WhatsApp telefonunuzdan bu QR kodu okutun:</p>
            <img id="qrCodeImage" src="" alt="QR Code" style="max-width: 100%; height: auto; border-radius: 8px; margin: 20px 0;">
            <p style="color: #666; font-size: 0.9em;">WhatsApp > Ayarlar > Baƒülƒ± Cihazlar > Cihaz Baƒüla</p>
            <button class="btn btn-secondary" onclick="closeModal('qrCodeModal')">Kapat</button>
        </div>
            </div> <!-- /admin-content -->
        </div> <!-- /main-content-wrapper -->
    </div> <!-- /main-wrapper -->

    <!-- Message Detail Modal -->
    <div id="messageDetailModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('messageDetailModal')">&times;</span>
            <h3 id="messageDetailTitle">üì© Mesaj Detayƒ±</h3>
            <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
                <div style="margin-bottom: 15px;">
                    <strong>üë§ Alƒ±cƒ±:</strong> <span id="messageDetailRecipient"></span>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>üì± Telefon:</strong> <span id="messageDetailPhone"></span>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>üìÖ Tarih:</strong> <span id="messageDetailDate"></span>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>üì° Cihaz:</strong> <span id="messageDetailInstance"></span>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>‚úÖ Durum:</strong> <span id="messageDetailStatus"></span>
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #ddd;">
                    <strong>üí¨ Mesaj ƒ∞√ßeriƒüi:</strong>
                    <div id="messageDetailText" style="margin-top: 10px; padding: 15px; background: white; border-radius: 8px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; font-family: inherit;"></div>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="closeModal('messageDetailModal')">Kapat</button>
        </div>
    </div>
</body>
</html>










