<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sporcum - SuperAdmin Paneli</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Ccircle cx=%2750%27 cy=%2750%27 r=%2748%27 fill=%27%234f46e5%27/%3E%3Ctext x=%2750%27 y=%2772%27 font-family=%27Arial,sans-serif%27 font-size=%2760%27 font-weight=%27bold%27 fill=%27white%27 text-anchor=%27middle%27%3ES%3C/text%3E%3C/svg%3E">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-helper.js"></script>
    <script type="module">
        // IMPORTANT: Replace with your actual Supabase configuration
        const SUPABASE_URL = 'https://supabase.edu-ai.online';
        const SUPABASE_ANON_KEY = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJzdXBhYmFzZSIsImlhdCI6MTc2MjEwNTMyMCwiZXhwIjo0OTE3Nzc4OTIwLCJyb2xlIjoiYW5vbiJ9.HXUza0GT82-trWkx0WWKe-nY7KsGrIjIHSOJPKsOHjs';
        
        // Initialize Supabase
        const supabase = window.supabaseHelper.initSupabase(SUPABASE_URL, SUPABASE_ANON_KEY);
        const auth = window.supabaseHelper.auth;
        const db = window.supabaseHelper.db;
        
        // Make Supabase accessible globally
        window.db = db;
        window.auth = auth;
        window.supabase = supabase;
        window.firebaseModules = {
            // collection() 1 veya 2 parametre alabilir (Firebase uyumluluÄŸu iÃ§in)
            collection: (dbRefOrName, collectionName) => {
                const tableName = collectionName || dbRefOrName;
                return db.collection(tableName);
            },
            addDoc: (collectionRef, data) => db.addDoc(collectionRef, data),
            // getDocs() queryOptions'Ä± da geÃ§meli
            getDocs: (collectionRef) => db.getDocs(collectionRef, collectionRef.queryOptions),
            getDoc: (docRef) => db.getDoc(docRef),
            updateDoc: (docRef, data) => db.updateDoc(docRef, data),
            deleteDoc: (docRef) => db.deleteDoc(docRef),
            // doc() 2 veya 3 parametre alabilir
            doc: (dbRefOrName, collectionOrId, id) => {
                const tableName = id ? collectionOrId : dbRefOrName;
                const docId = id || collectionOrId;
                return db.doc(tableName, docId);
            },
            setDoc: (docRef, data) => db.setDoc(docRef, data),
            query: (collectionRef, ...conditions) => db.query(collectionRef, ...conditions),
            where: window.supabaseHelper.where
        };

        // --- GLOBAL STATE ---
        let currentSuperAdmin = null;
        let clubs = [];
        let allUsers = [];
        let currentView = 'dashboard'; // 'dashboard', 'clubs', 'club-detail', 'settings'
        let currentClubId = null; // SeÃ§ili kulÃ¼p ID'si

        // --- AUTHENTICATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const sessionUser = sessionStorage.getItem('superAdmin');
            
            if (sessionUser) {
                try {
                    currentSuperAdmin = JSON.parse(sessionUser);
                    console.log('âœ… SuperAdmin session found:', currentSuperAdmin.email);
                    document.body.classList.add('loaded');
                    startApp();
                    return;
                } catch (error) {
                    console.error('Session parse error:', error);
                    sessionStorage.clear();
                }
            }
            
            // No session - redirect to login page
            console.log('âŒ No SuperAdmin session found - redirecting to login');
            alert('SuperAdmin giriÅŸi iÃ§in lÃ¼tfen giriÅŸ sayfasÄ±ndan email ve ÅŸifrenizle giriÅŸ yapÄ±n.');
            window.location.href = 'giris';
        });


        function handleLogout() {
            console.log('ğŸšª Logging out SuperAdmin...');
            sessionStorage.clear();
            localStorage.clear(); // Clear all storage
            currentSuperAdmin = null;
            console.log('âœ… Session cleared, redirecting...');
            window.location.replace('giris');
        }
        
        window.handleLogout = handleLogout;

        async function startApp() {
            document.querySelector('.admin-name').textContent = currentSuperAdmin.name;
            await loadClubs();
            renderDashboard();
            
            // Setup modal backdrop click
            const modal = document.getElementById('modal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
            }
        }

        async function loadClubs() {
            try {
                const { collection, getDocs, query, where } = window.firebaseModules;
                
                // Load from clubs collection
                const clubsSnapshot = await getDocs(collection(window.db, 'clubs'));
                clubs = clubsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Also load from settings collection (club_* documents)
                const settingsSnapshot = await getDocs(collection(window.db, 'settings'));
                settingsSnapshot.docs.forEach(doc => {
                    if (doc.id.startsWith('club_')) {
                        const clubId = doc.id.replace('club_', '');
                        const data = doc.data();
                        
                        // Only add if not already in clubs array
                        if (!clubs.find(c => c.id === clubId)) {
                            clubs.push({
                                id: clubId,
                                name: data.clubName || data.name || 'Ä°simsiz KulÃ¼p',
                                icon: 'ğŸ¢',
                                city: data.city || '-',
                                adminEmail: data.adminEmail || '-',
                                adminPhone: data.adminPhone || '-',
                                adminName: data.adminName || '-',
                                status: 'active',
                                memberCount: 0,
                                createdAt: data.createdAt || new Date().toISOString(),
                                source: 'settings' // Mark as loaded from settings
                            });
                        }
                    }
                });
                
                // Load all users
                const usersSnapshot = await getDocs(collection(window.db, 'users'));
                allUsers = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load all members and calculate member counts per club
                const membersSnapshot = await getDocs(collection(window.db, 'members'));
                const membersByClub = {};
                
                membersSnapshot.docs.forEach(doc => {
                    const memberData = doc.data();
                    const clubId = memberData.clubId;
                    if (clubId) {
                        if (!membersByClub[clubId]) {
                            membersByClub[clubId] = 0;
                        }
                        membersByClub[clubId]++;
                    }
                });
                
                // Update club member counts
                clubs.forEach(club => {
                    club.memberCount = membersByClub[club.id] || 0;
                });
                
                console.log('âœ… Clubs loaded:', clubs.length, '(from clubs:', clubsSnapshot.docs.length, ', from settings:', clubs.filter(c => c.source === 'settings').length + ')', 'Users loaded:', allUsers.length, 'Members loaded:', membersSnapshot.docs.length);
            } catch (error) {
                console.error('âŒ Error loading clubs:', error);
                showAlert('Veri yÃ¼klenirken hata: ' + error.message, 'error');
            }
        }

        // Dashboard'a geri dÃ¶n
        window.showDashboard = function() {
            currentView = 'dashboard';
            currentClubId = null;
            renderDashboard();
        };
        
        function renderDashboard() {
            const container = document.getElementById('content-area');
            const totalClubs = clubs.length;
            const activeClubs = clubs.filter(c => c.status === 'active').length;
            const totalAdmins = allUsers.length;
            
            container.innerHTML = `
                <h2 style="margin-bottom: 30px;">ğŸ“Š Dashboard</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ¢</div>
                        <div class="stat-value">${totalClubs}</div>
                        <div class="stat-label">Toplam KulÃ¼p</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">âœ…</div>
                        <div class="stat-value">${activeClubs}</div>
                        <div class="stat-label">Aktif KulÃ¼p</div>
                    </div>
                    <div class="stat-card" onclick="showAllAdmins()" style="cursor: pointer; transition: transform 0.2s;">
                        <div class="stat-icon">ğŸ‘¥</div>
                        <div class="stat-value">${totalAdmins}</div>
                        <div class="stat-label">Toplam Admin</div>
                        <div style="font-size: 12px; color: #999; margin-top: 10px;">ğŸ‘† TÄ±klayÄ±n</div>
                    </div>
                </div>

                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 20px;">HoÅŸ Geldiniz! ğŸ‰</h3>
                    <p style="color: #666; line-height: 1.6;">
                        SuperAdmin paneline hoÅŸ geldiniz. Bu panelden tÃ¼m spor kulÃ¼plerini yÃ¶netebilir, 
                        yeni kulÃ¼pler ekleyebilir ve kulÃ¼p yÃ¶neticilerini atayabilirsiniz.
                    </p>
                    <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="showSection('clubs')" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ğŸ¢ KulÃ¼pleri YÃ¶net
                        </button>
                        <button onclick="testFirebaseConnection()" style="padding: 12px 24px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            ğŸ” Firebase BaÄŸlantÄ± Testi
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                        <strong>âš ï¸ Ã–nemli:</strong> EÄŸer kulÃ¼p ekleme sÄ±rasÄ±nda hata alÄ±rsanÄ±z, 
                        <strong>FIRESTORE_RULES_SUPERADMIN.md</strong> dosyasÄ±nÄ± kontrol edin ve Firebase Firestore kurallarÄ±nÄ± gÃ¼ncelleyin.
                    </div>
                </div>
            `;
        }

        function renderClubsList() {
            console.log('ğŸ”µ Rendering clubs list with webhook support v2.0');
            const container = document.getElementById('content-area');
            
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2>ğŸ¢ KulÃ¼pler</h2>
                    <button onclick="openAddClubModal()" class="btn btn-primary">â• Yeni KulÃ¼p Ekle</button>
                </div>

                <div class="clubs-grid">
                    ${clubs.length === 0 ? '<p style="text-align: center; color: #999; padding: 40px;">HenÃ¼z kulÃ¼p eklenmemiÅŸ.</p>' : ''}
                    ${clubs.map(club => `
                        <div class="club-card">
                            <div class="club-header">
                                <div class="club-icon">${club.icon || 'ğŸ†'}</div>
                                <div>
                                    <h3>${club.name}</h3>
                                    <span class="status-badge ${club.status === 'active' ? 'active' : 'inactive'}">
                                        ${club.status === 'active' ? 'âœ… Aktif' : 'â¸ï¸ Pasif'}
                                    </span>
                                </div>
                            </div>
                            <div class="club-info">
                                <p><strong>ğŸ“ Åehir:</strong> ${club.city || '-'}</p>
                                <p><strong>ğŸ‘¤ Admin:</strong> ${club.adminName || club.adminEmail || 'AtanmamÄ±ÅŸ'}</p>
                                <p><strong>ğŸ“± Telefon:</strong> ${club.adminPhone || '-'}</p>
                                <p><strong>ğŸ‘¥ Ãœye SayÄ±sÄ±:</strong> ${club.memberCount || 0}</p>
                                <p><strong>ğŸ“… KayÄ±t Tarihi:</strong> ${club.createdAt ? new Date(club.createdAt).toLocaleDateString('tr-TR') : '-'}</p>
                            </div>
                            <div class="club-actions">
                                <button onclick="viewDetailedClubInfo('${club.id}')" class="btn-small" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; flex: 1 1 100%; font-weight: 700; box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3); margin-bottom: 8px;">ğŸ“Š DetaylÄ± Bilgiler</button>
                                <button onclick="manageWebhooks('${club.id}')" class="btn-small" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; flex: 1 1 100%; font-weight: 700; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">ğŸ”— Webhook YÃ¶netimi</button>
                                <button onclick="viewClubDetails('${club.id}')" class="btn-small btn-view" style="flex: 1;">ğŸ” Admin Bilgileri</button>
                                <button onclick="editClub('${club.id}')" class="btn-small btn-edit" style="flex: 1;">âœï¸ DÃ¼zenle</button>
                                <button onclick="deleteClub('${club.id}', '${club.name}')" class="btn-small btn-delete" style="flex: 1;">ğŸ—‘ï¸ Sil</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function openAddClubModal() {
            console.log('ğŸ”µ Opening add club modal...');
            showModal(`
                <h3>â• Yeni KulÃ¼p Ekle</h3>
                <form id="addClubForm" onsubmit="window.handleAddClub(event); return false;">
                    <div class="form-group">
                        <label>ğŸ¢ KulÃ¼p AdÄ± *</label>
                        <input type="text" name="name" required placeholder="Ã–rn: Atakum Tenis KulÃ¼bÃ¼">
                    </div>
                    <div class="form-group">
                        <label>ğŸ·ï¸ Ä°kon (Emoji)</label>
                        <input type="text" name="icon" maxlength="2" placeholder="ğŸ¾">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“ Åehir *</label>
                        <input type="text" name="city" required placeholder="Ã–rn: Samsun">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“§ Admin Email *</label>
                        <input type="email" name="adminEmail" required placeholder="admin@kulup.com">
                        <small style="color: #666;">Admin bu email ile giriÅŸ yapacak</small>
                    </div>
                    <div class="form-group">
                        <label>ğŸ“± Admin Telefon *</label>
                        <input type="tel" name="phone" required placeholder="05XXXXXXXXX" maxlength="11">
                        <small style="color: #666;">Telefon numarasÄ± kullanÄ±cÄ± adÄ± olarak kullanÄ±lacak</small>
                    </div>
                    <div class="form-group">
                        <label>ğŸ” Admin Åifre</label>
                        <input type="text" name="adminPassword" placeholder="BoÅŸ bÄ±rakÄ±rsanÄ±z: Kulup123!" value="Kulup123!">
                        <small style="color: #666;">âš ï¸ Admin bu ÅŸifre ile giriÅŸ yapacak! GÃ¼venli bir ÅŸifre seÃ§in.</small>
                    </div>
                    <div class="form-group">
                        <label>ğŸ‘¤ Admin AdÄ± SoyadÄ± *</label>
                        <input type="text" name="adminName" required placeholder="Ã–rn: Ahmet YÄ±lmaz">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“ AÃ§Ä±klama</label>
                        <textarea name="description" rows="3" placeholder="KulÃ¼p hakkÄ±nda kÄ±sa aÃ§Ä±klama"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">ğŸ’¾ Kaydet ve Admin OluÅŸtur</button>
                        <button type="button" onclick="closeModal()" class="btn btn-secondary" style="flex: 1;">âŒ Ä°ptal</button>
                    </div>
                </form>
            `);
            console.log('âœ… Modal opened');
        }
        
        window.openAddClubModal = openAddClubModal;
        
        // ========== WEBHOOK MANAGEMENT ==========
        
        window.manageWebhooks = async function(clubId) {
            const club = clubs.find(c => c.id === clubId);
            if (!club) {
                showAlert('KulÃ¼p bulunamadÄ±!', 'error');
                return;
            }
            
            // Load contract webhook for this club
            const { doc, getDoc } = window.firebaseModules;
            const webhookDoc = await getDoc(doc(window.db, 'webhooks', `contract_${clubId}`));
            const contractWebhook = webhookDoc.exists() ? webhookDoc.data() : {};
            
            showModal(`
                <h3>ğŸ”— Webhook YÃ¶netimi: ${club.name}</h3>
                <p style="color: #666; margin-bottom: 25px;">KayÄ±t sayfasÄ±ndan doldurulan sÃ¶zleÅŸmelerin webhook'unu buradan yÃ¶netebilirsiniz.</p>
                
                <!-- Contract Form Webhook -->
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; color: white;">
                    <h4 style="margin-top: 0; color: white;">ğŸ“ KayÄ±t Formu & SÃ¶zleÅŸme Webhook</h4>
                    <p style="margin-bottom: 15px; opacity: 0.95; font-size: 14px;">
                        <strong>kayit.html</strong> sayfasÄ±ndan doldurulup imzalanan sÃ¶zleÅŸmeleri bu webhook'a gÃ¶nderir
                    </p>
                    <p style="margin-bottom: 15px; opacity: 0.85; font-size: 13px;">
                        ğŸ“¤ <strong>GÃ¶nderilecek Veri:</strong> PDF (Base64), Form bilgileri (Ad, Soyad, TC, Adres, vb.), Ã–deme planÄ±, Ä°mza (Base64)
                    </p>
                    <div class="form-group">
                        <label style="color: white; margin-bottom: 8px; display: block;">Webhook URL</label>
                        <input 
                            type="url" 
                            id="contractWebhookUrl" 
                            class="form-control" 
                            placeholder="https://your-webhook-url.com/contract"
                            value="${contractWebhook.url || ''}"
                            style="background: rgba(255,255,255,0.9);"
                        />
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 8px;">
                        <input type="checkbox" id="contractWebhookActive" ${contractWebhook.active ? 'checked' : ''} style="width: auto; margin: 0;">
                        <label for="contractWebhookActive" style="margin: 0; opacity: 0.95; cursor: pointer; font-weight: 600;">Webhook'u etkinleÅŸtir</label>
                    </div>
                </div>
                
                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #1e40af; font-size: 13px;">
                    <strong>â„¹ï¸ Not:</strong> Gelen WhatsApp mesajlarÄ± iÃ§in n8n direkt Firebase'e yazacaÄŸÄ± iÃ§in webhook'a gerek yok.
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button onclick="saveClubWebhooks('${clubId}')" class="btn btn-primary" style="flex: 1;">ğŸ’¾ Webhook'u Kaydet</button>
                    <button onclick="closeModal()" class="btn btn-secondary" style="flex: 1;">âŒ Ä°ptal</button>
                </div>
            `);
        };
        
        window.saveClubWebhooks = async function(clubId) {
            const contractUrl = document.getElementById('contractWebhookUrl').value.trim();
            const contractActive = document.getElementById('contractWebhookActive').checked;
            
            try {
                const { setDoc, doc } = window.firebaseModules;
                
                // Save Contract webhook only
                await setDoc(doc(window.db, 'webhooks', `contract_${clubId}`), {
                    url: contractUrl,
                    active: contractActive,
                    eventType: 'contract_signed',
                    clubId: clubId,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentSuperAdmin.email
                });
                
                showAlert('âœ… Webhook baÅŸarÄ±yla kaydedildi!', 'success');
                closeModal();
            } catch (error) {
                console.error('Error saving webhook:', error);
                showAlert('âŒ Webhook kaydedilirken hata oluÅŸtu!', 'error');
            }
        };
        
        // ========== CLUB MANAGEMENT FUNCTIONS ==========
        
        window.viewClubDetails = function(clubId) {
            const club = clubs.find(c => c.id === clubId);
            if (!club) {
                showAlert('KulÃ¼p bulunamadÄ±!', 'error');
                return;
            }
            
            showModal(`
                <h3>ğŸ” Admin Bilgileri: ${club.name}</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin: 20px 0;">
                    <div style="margin-bottom: 15px;">
                        <strong>ğŸ“§ Email:</strong> ${club.adminEmail || '-'}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>ğŸ“± Telefon:</strong> ${club.adminPhone || '-'}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>ğŸ‘¤ Admin AdÄ±:</strong> ${club.adminName || '-'}
                    </div>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <strong>âš ï¸ Not:</strong> Admin bu bilgilerle giriÅŸ yapabilir. Åifre bilgisi gÃ¼venlik nedeniyle gÃ¶sterilmemektedir.
                    </div>
                </div>
                <button onclick="closeModal()" class="btn btn-secondary" style="width: 100%;">Kapat</button>
            `);
        };
        
        // Ä°lk editClub fonksiyonu kaldÄ±rÄ±ldÄ± - Ä°kinci editClub (satÄ±r 668) kullanÄ±lÄ±yor
        
        window.deleteClub = async function(clubId, clubName) {
            const club = clubs.find(c => c.id === clubId);
            const name = club ? club.name : clubName;
            
            if (!confirm(`"${name}" kulÃ¼bÃ¼nÃ¼ silmek istediÄŸinize emin misiniz?\n\nBu iÅŸlem geri alÄ±namaz!`)) {
                return;
            }
            
            try {
                const { deleteDoc, doc } = window.firebaseModules;
                
                // Delete from clubs collection
                try {
                    await deleteDoc(doc(window.db, 'clubs', clubId));
                } catch (error) {
                    console.log('Club not in clubs collection');
                }
                
                // Delete from settings
                try {
                    await deleteDoc(doc(window.db, 'settings', `club_${clubId}`));
                } catch (error) {
                    console.log('Club not in settings collection');
                }
                
                showAlert('âœ… KulÃ¼p baÅŸarÄ±yla silindi!', 'success');
                await loadClubs();
                renderClubsList();
            } catch (error) {
                console.error('Error deleting club:', error);
                showAlert('âŒ KulÃ¼p silinirken hata oluÅŸtu!', 'error');
            }
        };

        window.handleAddClub = async function(e) {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'â³ Kaydediliyor...';
                
                const adminEmail = form.adminEmail.value;
                const adminPhone = form.phone.value;
                const adminPassword = form.adminPassword.value || 'Kulup123!';
                const adminName = form.adminName.value;
                
                // 1. Create club
                const clubData = {
                    name: form.name.value,
                    icon: form.icon.value || 'ğŸ†',
                    city: form.city.value,
                    adminEmail: adminEmail,
                    adminPhone: adminPhone,
                    adminName: adminName,
                    description: form.description.value || '',
                    crmEnabled: true, // âœ… VarsayÄ±lan olarak CRM aktif
                    status: 'active',
                    memberCount: 0,
                    createdAt: new Date().toISOString(),
                    createdBy: currentSuperAdmin.email
                };
                
                console.log('ğŸ“ Step 1: Adding club:', clubData);
                
                const { collection, addDoc, query, where, getDocs } = window.firebaseModules;
                const clubRef = await addDoc(collection(window.db, 'clubs'), clubData);
                
                console.log('âœ… Club added with ID:', clubRef.id);
                
                // 2. Create admin user
                console.log('ğŸ“ Step 2: Creating admin user...');
                
                // Check if user already exists
                const userQuery = query(
                    collection(window.db, 'users'),
                    where('phone', '==', adminPhone)
                );
                const existingUsers = await getDocs(userQuery);
                
                if (!existingUsers.empty) {
                    console.log('âš ï¸ User already exists, updating...');
                    const { doc, updateDoc } = window.firebaseModules;
                    const existingUserId = existingUsers.docs[0].id;
                    await updateDoc(doc(window.db, 'users', existingUserId), {
                        clubId: clubRef.id,
                        clubName: clubData.name,
                        updatedAt: new Date().toISOString()
                    });
                } else {
                    const adminData = {
                        email: adminEmail,
                        phone: adminPhone,
                        password: adminPassword,
                        fullName: adminName,
                        role: 'admin',
                        clubId: clubRef.id,
                        clubName: clubData.name,
                        isSuperAdmin: false,
                        createdAt: new Date().toISOString(),
                        createdBy: currentSuperAdmin.email
                    };
                    
                    const adminRef = await addDoc(collection(window.db, 'users'), adminData);
                    console.log('âœ… Admin user created with ID:', adminRef.id);
                }
                
                // 3. Show success with credentials
                showModal(`
                    <div style="text-align: center;">
                        <div style="font-size: 64px; margin-bottom: 20px;">ğŸ‰</div>
                        <h3 style="color: #4caf50; margin-bottom: 20px;">KulÃ¼p BaÅŸarÄ±yla OluÅŸturuldu!</h3>
                        
                        <div style="background: #f0f8ff; padding: 20px; border-radius: 12px; margin: 20px 0; text-align: left;">
                            <h4 style="margin-bottom: 15px; color: #333;">ğŸ“‹ KulÃ¼p Bilgileri:</h4>
                            <p><strong>ğŸ¢ KulÃ¼p:</strong> ${clubData.name}</p>
                            <p><strong>ğŸ“ Åehir:</strong> ${clubData.city}</p>
                        </div>
                        
                        <div style="background: #fff3cd; padding: 20px; border-radius: 12px; margin: 20px 0; text-align: left; border: 2px solid #ffc107;">
                            <h4 style="margin-bottom: 15px; color: #333;">ğŸ” Admin GiriÅŸ Bilgileri:</h4>
                            <p><strong>ğŸ‘¤ Ad Soyad:</strong> ${adminName}</p>
                            <p><strong>ğŸ“§ Email:</strong> ${adminEmail}</p>
                            <p><strong>ğŸ“± Telefon:</strong> ${adminPhone}</p>
                            <p><strong>ğŸ”‘ Åifre:</strong> <code style="background: #fff; padding: 4px 8px; border-radius: 4px; font-size: 16px;">${adminPassword}</code></p>
                        </div>
                        
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 20px 0;">
                            <p style="margin: 0; color: #2e7d32; font-weight: 600;">
                                âœ… Admin <strong>${adminPhone}</strong> telefon numarasÄ± ve yukarÄ±daki ÅŸifre ile giriÅŸ yapabilir!
                            </p>
                        </div>
                        
                        <button onclick="closeModal(); window.location.reload();" class="btn btn-primary" style="width: 100%; margin-top: 10px;">
                            ğŸ¢ KulÃ¼pler Listesine DÃ¶n
                        </button>
                    </div>
                `);
                
            } catch (error) {
                console.error('âŒ Error adding club:', error);
                
                let errorMessage = error.message;
                if (error.code === 'permission-denied') {
                    errorMessage = 'Firebase izin hatasÄ±! LÃ¼tfen Firestore kurallarÄ±nÄ± kontrol edin. (FIRESTORE_RULES_SUPERADMIN.md dosyasÄ±na bakÄ±n)';
                } else if (error.code === 'unavailable') {
                    errorMessage = 'Firebase baÄŸlantÄ± hatasÄ±! Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.';
                }
                
                showAlert('âŒ ' + errorMessage, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸ’¾ Kaydet ve Admin OluÅŸtur';
            }
        };

        window.editClub = function(clubId) {
            currentView = 'club-edit';
            const club = clubs.find(c => c.id === clubId);
            if (!club) {
                console.error('âŒ Club not found:', clubId);
                showAlert('KulÃ¼p bulunamadÄ±!', 'error');
                return;
            }
            
            console.log('ğŸ”µ Opening edit club page for:', club.name);
            const container = document.getElementById('content-area');
            container.innerHTML = `
                <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
                    <!-- Geri DÃ¶n Butonu -->
                    <button onclick="${currentClubId ? `viewDetailedClubInfo('${currentClubId}')` : 'showDashboard()'}" class="btn btn-secondary" style="margin-bottom: 20px;">
                        â† Geri DÃ¶n
                    </button>
                    
                    <h3>âœï¸ KulÃ¼p DÃ¼zenle: ${club.name}</h3>
                    <form id="editClubForm" onsubmit="window.handleEditClub(event, '${clubId}'); return false;">
                    <div class="form-group">
                        <label>ğŸ¢ KulÃ¼p AdÄ± *</label>
                        <input type="text" name="name" required value="${club.name}">
                    </div>
                    <div class="form-group">
                        <label>ğŸ·ï¸ Ä°kon (Emoji)</label>
                        <input type="text" name="icon" maxlength="2" value="${club.icon || ''}">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“ Åehir *</label>
                        <input type="text" name="city" required value="${club.city || ''}">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“§ Admin Email</label>
                        <input type="email" name="adminEmail" value="${club.adminEmail || ''}">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“± Telefon</label>
                        <input type="tel" name="phone" value="${club.phone || ''}">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“ AÃ§Ä±klama</label>
                        <textarea name="description" rows="3">${club.description || ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label>ğŸ“ CRM Durumu</label>
                        <select name="crmEnabled">
                            <option value="true" ${club.crmEnabled !== false ? 'selected' : ''}>âœ… Aktif</option>
                            <option value="false" ${club.crmEnabled === false ? 'selected' : ''}>âŒ Pasif</option>
                        </select>
                        <small style="color: #666;">CRM modÃ¼lÃ¼nÃ¼ kulÃ¼p iÃ§in aktif/pasif yapabilirsiniz.</small>
                    </div>
                    <div class="form-group">
                        <label>KulÃ¼p Durumu</label>
                        <select name="status">
                            <option value="active" ${club.status === 'active' ? 'selected' : ''}>âœ… Aktif</option>
                            <option value="inactive" ${club.status === 'inactive' ? 'selected' : ''}>â¸ï¸ Pasif</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">ğŸ’¾ GÃ¼ncelle</button>
                        <button type="button" onclick="${currentClubId ? `viewDetailedClubInfo('${currentClubId}')` : 'showDashboard()'}" class="btn btn-secondary" style="flex: 1;">âŒ Ä°ptal</button>
                    </div>
                </form>
                </div>
            `;
        };

        window.handleEditClub = async function(e, clubId) {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'â³ GÃ¼ncelleniyor...';
                
                const clubData = {
                    name: form.name.value,
                    icon: form.icon.value || 'ğŸ†',
                    city: form.city.value,
                    adminEmail: form.adminEmail.value || null,
                    phone: form.phone.value || null,
                    description: form.description.value || '',
                    crmEnabled: form.crmEnabled.value === 'true',
                    status: form.status.value,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentSuperAdmin.email
                };
                
                console.log('ğŸ“ Updating club:', clubId, clubData);
                
                const { doc, updateDoc, setDoc } = window.firebaseModules;
                
                // Update in clubs collection
                try {
                    await updateDoc(doc(window.db, 'clubs', clubId), clubData);
                    console.log('âœ… Updated in clubs collection');
                } catch (error) {
                    console.log('âš ï¸ Not in clubs collection, will try settings...');
                }
                
                // Also update in settings if it exists there
                try {
                    await setDoc(doc(window.db, 'settings', `club_${clubId}`), {
                        clubName: clubData.name,
                        ...clubData
                    }, { merge: true });
                    console.log('âœ… Updated in settings collection');
                } catch (error) {
                    console.log('âš ï¸ Not in settings collection');
                }
                
                console.log('âœ… Club updated');
                showAlert('KulÃ¼p baÅŸarÄ±yla gÃ¼ncellendi! ğŸ‰', 'success');
                
                await loadClubs();
                
                // EÄŸer detay sayfasÄ±ndan geldiyse detaya dÃ¶n, yoksa dashboard'a
                if (currentClubId) {
                    viewDetailedClubInfo(currentClubId);
                } else {
                    showDashboard();
                }
            } catch (error) {
                console.error('âŒ Error updating club:', error);
                showAlert('Hata: ' + error.message, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸ’¾ GÃ¼ncelle';
            }
        };

        window.deleteAdmin = async function(userId, userName, userPhone) {
            const confirmText = `"${userName}" (${userPhone}) kullanÄ±cÄ±sÄ±nÄ± silmek istediÄŸinizden emin misiniz?\n\nâš ï¸ Bu iÅŸlem geri alÄ±namaz!\n\nâœ… Admin silinecek ancak kulÃ¼p verileri korunacaktÄ±r.`;
            
            if (!confirm(confirmText)) {
                return;
            }
            
            try {
                console.log('ğŸ—‘ï¸ Deleting admin:', userId);
                
                const { doc, deleteDoc } = window.firebaseModules;
                await deleteDoc(doc(window.db, 'users', userId));
                
                console.log('âœ… Admin deleted');
                showAlert('Admin baÅŸarÄ±yla silindi! ğŸ—‘ï¸', 'success');
                
                // Reload data and refresh view
                await loadClubs();
                closeModal();
                
                // Re-open the admin list after a short delay
                setTimeout(() => {
                    showAllAdmins();
                }, 300);
                
            } catch (error) {
                console.error('âŒ Error deleting admin:', error);
                showAlert('Hata: ' + error.message, 'error');
            }
        };

        window.showAllAdmins = function() {
            if (allUsers.length === 0) {
                showAlert('HiÃ§ admin kullanÄ±cÄ± bulunamadÄ±!', 'warning');
                return;
            }

            // KulÃ¼plere gÃ¶re grupla
            const clubGroups = {};
            const noClubAdmins = [];
            
            allUsers.forEach(user => {
                if (user.clubId) {
                    if (!clubGroups[user.clubId]) {
                        const club = clubs.find(c => c.id === user.clubId);
                        clubGroups[user.clubId] = {
                            clubName: club ? club.name : (user.clubName || 'Bilinmeyen KulÃ¼p'),
                            clubIcon: club ? club.icon : 'ğŸ¢',
                            clubExists: !!club,
                            admins: []
                        };
                    }
                    clubGroups[user.clubId].admins.push(user);
                } else {
                    noClubAdmins.push(user);
                }
            });

            let modalContent = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">ğŸ‘¥ TÃ¼m Admin KullanÄ±cÄ±larÄ±</h3>
                    <span style="background: #667eea; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 18px;">${allUsers.length}</span>
                </div>
                <div style="max-height: 600px; overflow-y: auto; padding-right: 10px;">
            `;

            // KulÃ¼plere gÃ¶re gÃ¶ster
            Object.keys(clubGroups).forEach((clubId, index) => {
                const group = clubGroups[clubId];
                const bgColor = index % 2 === 0 ? '#f8f9fa' : '#fff';
                
                modalContent += `
                    <div style="background: ${bgColor}; padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 2px solid ${group.clubExists ? '#e9ecef' : '#ff9800'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #667eea; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">${group.clubIcon}</span>
                                <span>${group.clubName}</span>
                                ${!group.clubExists ? '<span style="color: #ff9800; font-size: 14px; font-weight: normal;">(KulÃ¼p silinmiÅŸ)</span>' : ''}
                            </h4>
                            <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">${group.admins.length} admin</span>
                        </div>
                `;
                
                group.admins.forEach((user, userIndex) => {
                    const userId = allUsers.findIndex(u => u.phone === user.phone && u.email === user.email);
                    const actualUserId = allUsers[userId]?.id || user.id;
                    
                    modalContent += `
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: ${userIndex < group.admins.length - 1 ? '10px' : '0'}; border-left: 4px solid #667eea; position: relative;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px; margin-bottom: 10px;">
                                <div><strong>ğŸ†” ID:</strong> <code style="font-size: 11px; background: #f0f0f0; padding: 2px 6px; border-radius: 4px;">${actualUserId || 'N/A'}</code></div>
                                <div><strong>ğŸ‘¤ Ä°sim:</strong> ${user.fullName || user.name || '-'}</div>
                                <div><strong>ğŸ“§ Email:</strong> ${user.email || '-'}</div>
                                <div><strong>ğŸ“± Telefon:</strong> <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 4px;">${user.phone || '-'}</code></div>
                                <div><strong>ğŸ”‘ Åifre:</strong> <code style="background: #fff3cd; padding: 2px 6px; border-radius: 4px; font-weight: bold;">${user.password || 'Kulup123!'}</code></div>
                                <div><strong>ğŸ‘‘ Rol:</strong> <span style="background: #e3f2fd; padding: 2px 8px; border-radius: 8px; font-size: 12px;">${user.role || 'admin'}</span></div>
                                <div><strong>ğŸ¢ KulÃ¼p ID:</strong> <code style="font-size: 11px;">${user.clubId || '-'}</code></div>
                                <div><strong>ğŸ“… KayÄ±t:</strong> ${user.createdAt ? new Date(user.createdAt).toLocaleDateString('tr-TR') : '-'}</div>
                                <div><strong>ğŸ‘¤ OluÅŸturan:</strong> ${user.createdBy || '-'}</div>
                                <div><strong>â­ SuperAdmin:</strong> ${user.isSuperAdmin ? 'âœ… Evet' : 'âŒ HayÄ±r'}</div>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                                <button onclick="navigator.clipboard.writeText('Telefon: ${user.phone}\\nÅifre: ${user.password}'); showAlert('KopyalandÄ±!', 'success')" 
                                    style="flex: 1; padding: 8px 12px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                                    ğŸ“‹ GiriÅŸ Bilgilerini Kopyala
                                </button>
                                <button onclick="window.deleteAdmin('${actualUserId}', '${(user.fullName || user.name || user.email).replace(/'/g, "\\'")}', '${user.phone}')" 
                                    style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                                    ğŸ—‘ï¸ Sil
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                modalContent += `</div>`;
            });

            // KulÃ¼bÃ¼ olmayan adminler
            if (noClubAdmins.length > 0) {
                modalContent += `
                    <div style="background: #fff3cd; padding: 20px; border-radius: 12px; border: 2px solid #ffc107;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #856404;">
                                âš ï¸ KulÃ¼bÃ¼ Olmayan Adminler
                            </h4>
                            <span style="background: #ffc107; color: #000; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">${noClubAdmins.length} admin</span>
                        </div>
                        <p style="color: #856404; font-size: 13px; margin-bottom: 15px;">Bu adminlerin kulÃ¼pleri silinmiÅŸ veya hiÃ§ atanmamÄ±ÅŸ olabilir. Gerekirse silebilirsiniz.</p>
                `;
                
                noClubAdmins.forEach((user, index) => {
                    const userId = allUsers.findIndex(u => u.phone === user.phone && u.email === user.email);
                    const actualUserId = allUsers[userId]?.id || user.id;
                    
                    modalContent += `
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: ${index < noClubAdmins.length - 1 ? '10px' : '0'};">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px; margin-bottom: 10px;">
                                <div><strong>ğŸ†” ID:</strong> <code style="font-size: 11px; background: #f0f0f0; padding: 2px 6px; border-radius: 4px;">${actualUserId || 'N/A'}</code></div>
                                <div><strong>ğŸ‘¤ Ä°sim:</strong> ${user.fullName || user.name || '-'}</div>
                                <div><strong>ğŸ“§ Email:</strong> ${user.email || '-'}</div>
                                <div><strong>ğŸ“± Telefon:</strong> <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 4px;">${user.phone || '-'}</code></div>
                                <div><strong>ğŸ”‘ Åifre:</strong> <code style="background: #fff3cd; padding: 2px 6px; border-radius: 4px;">${user.password || '-'}</code></div>
                                <div><strong>ğŸ“… KayÄ±t:</strong> ${user.createdAt ? new Date(user.createdAt).toLocaleDateString('tr-TR') : '-'}</div>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                                <button onclick="navigator.clipboard.writeText('Telefon: ${user.phone}\\nÅifre: ${user.password || 'Yok'}'); showAlert('KopyalandÄ±!', 'success')" 
                                    style="flex: 1; padding: 8px 12px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                                    ğŸ“‹ Bilgileri Kopyala
                                </button>
                                <button onclick="window.deleteAdmin('${actualUserId}', '${(user.fullName || user.name || user.email).replace(/'/g, "\\'")}', '${user.phone}')" 
                                    style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                                    ğŸ—‘ï¸ Sil
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                modalContent += `</div>`;
            }

            modalContent += `
                </div>
                <button onclick="closeModal()" class="btn btn-primary" style="width: 100%; margin-top: 20px;">Kapat</button>
            `;

            showModal(modalContent);
        };

        window.viewDetailedClubInfo = async function(clubId) {
            currentClubId = clubId;
            currentView = 'club-detail';
            
            const club = clubs.find(c => c.id === clubId);
            if (!club) return;
            
            console.log('ğŸ“Š Loading detailed club info for:', clubId);
            
            // Sayfa iÃ§eriÄŸini temizle ve yÃ¼kle
            const container = document.getElementById('content-area');
            container.innerHTML = '<div style="text-align: center; padding: 60px;"><div class="spinner" style="margin: 0 auto;"></div><p>YÃ¼kleniyor...</p></div>';
            
            try {
                const { collection, getDocs, query, where } = window.firebaseModules;
                
                // KulÃ¼p Ã¼yelerini say
                const membersQuery = query(
                    collection(window.db, 'members'),
                    where('clubId', '==', clubId)
                );
                const membersSnapshot = await getDocs(membersQuery);
                const totalMembers = membersSnapshot.docs.length;
                
                // Aktif Ã¼yeler
                const activeMembers = membersSnapshot.docs.filter(doc => {
                    const data = doc.data();
                    return data.Durum === 'Aktif' || data.durum === 'aktif';
                }).length;
                
                // CRM Leadleri say
                const leadsQuery = query(
                    collection(window.db, 'crmLeads'),
                    where('clubId', '==', clubId)
                );
                const leadsSnapshot = await getDocs(leadsQuery);
                const totalLeads = leadsSnapshot.docs.length;
                
                // Lead durumlarÄ±
                const leadsByStatus = {};
                leadsSnapshot.docs.forEach(doc => {
                    const status = doc.data().status || 'belirsiz';
                    leadsByStatus[status] = (leadsByStatus[status] || 0) + 1;
                });
                
                // BranÅŸlarÄ± say
                const branchesQuery = query(
                    collection(window.db, 'branches'),
                    where('clubId', '==', clubId)
                );
                const branchesSnapshot = await getDocs(branchesQuery);
                const totalBranches = branchesSnapshot.docs.length;
                
                // GruplarÄ± say
                const groupsQuery = query(
                    collection(window.db, 'groups'),
                    where('clubId', '==', clubId)
                );
                const groupsSnapshot = await getDocs(groupsQuery);
                const totalGroups = groupsSnapshot.docs.length;
                
                // Admin bilgisi
                const adminQuery = query(
                    collection(window.db, 'users'),
                    where('clubId', '==', clubId)
                );
                const adminSnapshot = await getDocs(adminQuery);
                const adminInfo = adminSnapshot.empty ? null : adminSnapshot.docs[0].data();
                
                // Muhasebe HesaplamalarÄ±
                let monthlyRevenue = 0;
                let paidCount = 0;
                let newMembersThisMonth = 0;
                let leftMembersThisMonth = 0;
                
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                console.log('ğŸ’° Muhasebe hesaplamalarÄ± baÅŸlÄ±yor...', {
                    totalMembers,
                    activeMembers,
                    currentMonth: currentMonth + 1,
                    currentYear
                });
                
                membersSnapshot.docs.forEach(doc => {
                    const member = doc.data();
                    
                    // Durum kontrolÃ¼ - normalize et
                    const durum = (member.Durum || member.durum || '').toString().toLowerCase();
                    
                    // AylÄ±k Ã¼yelik geliri (aktif Ã¼yeler)
                    if (durum === 'aktif') {
                        // Ãœcret alanlarÄ±nÄ± kontrol et (farklÄ± varyantlar)
                        const ucret = parseFloat(
                            member.Ucret || 
                            member.ucret || 
                            member.Ãœcret || 
                            member.aylÄ±k_ucret ||
                            member.AylÄ±k_Ucret ||
                            member.monthlyFee ||
                            0
                        );
                        
                        if (ucret > 0) {
                            monthlyRevenue += ucret;
                        }
                        
                        // Ã–deme yapanlarÄ± say (son Ã¶deme tarihi bu ay olanlar)
                        const lastPaymentField = 
                            member.Son_Odeme_Tarihi || 
                            member.son_odeme_tarihi || 
                            member.lastPaymentDate ||
                            member.sonOdemeTarihi;
                            
                        if (lastPaymentField) {
                            try {
                                const lastPayment = new Date(lastPaymentField);
                                if (!isNaN(lastPayment.getTime()) && 
                                    lastPayment.getMonth() === currentMonth && 
                                    lastPayment.getFullYear() === currentYear) {
                                    paidCount++;
                                }
                            } catch (e) {
                                console.warn('GeÃ§ersiz Ã¶deme tarihi:', lastPaymentField);
                            }
                        }
                    }
                    
                    // Bu ay kaydolan Ã¼yeler
                    const registerField = 
                        member.Kayit_Tarihi || 
                        member.kayit_tarihi || 
                        member.createdAt ||
                        member.registerDate ||
                        member.kayitTarihi;
                        
                    if (registerField) {
                        try {
                            const registerDate = new Date(registerField);
                            if (!isNaN(registerDate.getTime()) && 
                                registerDate.getMonth() === currentMonth && 
                                registerDate.getFullYear() === currentYear) {
                                newMembersThisMonth++;
                            }
                        } catch (e) {
                            console.warn('GeÃ§ersiz kayÄ±t tarihi:', registerField);
                        }
                    }
                    
                    // Bu ay ayrÄ±lan Ã¼yeler (durum: pasif/ayrÄ±ldÄ± ve gÃ¼ncelleme tarihi bu ay)
                    if (durum === 'pasif' || durum === 'ayrÄ±ldÄ±' || durum === 'iptal' || durum === 'donduruldu') {
                        const updateField = 
                            member.updatedAt || 
                            member.guncellemeTarihi ||
                            member.Guncelleme_Tarihi;
                            
                        if (updateField) {
                            try {
                                const updateDate = new Date(updateField);
                                if (!isNaN(updateDate.getTime()) && 
                                    updateDate.getMonth() === currentMonth && 
                                    updateDate.getFullYear() === currentYear) {
                                    leftMembersThisMonth++;
                                }
                            } catch (e) {
                                console.warn('GeÃ§ersiz gÃ¼ncelleme tarihi:', updateField);
                            }
                        }
                    }
                });
                
                const paymentRate = activeMembers > 0 ? Math.round((paidCount / activeMembers) * 100) : 0;
                
                console.log('ğŸ’° Muhasebe hesaplamalarÄ± tamamlandÄ±:', {
                    monthlyRevenue,
                    paidCount,
                    paymentRate,
                    newMembersThisMonth,
                    leftMembersThisMonth
                });
                
                container.innerHTML = `
                    <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
                        <!-- Geri DÃ¶n Butonu -->
                        <button onclick="showDashboard()" class="btn btn-secondary" style="margin-bottom: 20px;">
                            â† Geri DÃ¶n
                        </button>
                        
                        <h2 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            ${club.icon || 'ğŸ¢'} ${club.name}
                            <span style="font-size: 14px; background: ${club.status === 'active' ? '#4caf50' : '#ff9800'}; color: white; padding: 4px 12px; border-radius: 12px; margin-left: auto;">
                                ${club.status === 'active' ? 'âœ… Aktif' : 'â¸ï¸ Pasif'}
                            </span>
                        </h2>
                        
                        <!-- Ä°statistik KartlarÄ± -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold;">${totalMembers}</div>
                                <div style="font-size: 14px; margin-top: 5px;">Toplam Ãœye</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold;">${activeMembers}</div>
                                <div style="font-size: 14px; margin-top: 5px;">Aktif Ãœye</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold;">${totalLeads}</div>
                                <div style="font-size: 14px; margin-top: 5px;">CRM Lead</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold;">${totalBranches}</div>
                                <div style="font-size: 14px; margin-top: 5px;">BranÅŸ</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 32px; font-weight: bold;">${totalGroups}</div>
                                <div style="font-size: 14px; margin-top: 5px;">Grup</div>
                            </div>
                        </div>
                        
                        <div style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
                            <!-- Genel Bilgiler -->
                            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #e0e0e0;">
                                <h3 style="margin-bottom: 15px; color: #667eea; display: flex; align-items: center; gap: 10px;">
                                    ğŸ“‹ Genel Bilgiler
                                </h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                                    <div><strong>ğŸ†” KulÃ¼p ID:</strong> <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 4px; font-size: 12px;">${clubId}</code></div>
                                    <div><strong>ğŸ“ Åehir:</strong> ${club.city || '-'}</div>
                                    <div><strong>ğŸ“… KayÄ±t Tarihi:</strong> ${club.createdAt ? new Date(club.createdAt).toLocaleDateString('tr-TR', {year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'}) : '-'}</div>
                                    <div><strong>ğŸ”„ Son GÃ¼ncelleme:</strong> ${club.updatedAt ? new Date(club.updatedAt).toLocaleDateString('tr-TR', {year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'}) : '-'}</div>
                                    <div><strong>ğŸ‘¤ OluÅŸturan:</strong> ${club.createdBy || '-'}</div>
                                    <div><strong>ğŸ“ CRM Durumu:</strong> <span style="background: ${club.crmEnabled !== false ? '#4caf50' : '#f44336'}; color: white; padding: 2px 8px; border-radius: 8px; font-size: 12px;">${club.crmEnabled !== false ? 'âœ… Aktif' : 'âŒ Pasif'}</span></div>
                                </div>
                                ${club.description ? `
                                    <div style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                                        <strong>ğŸ“ AÃ§Ä±klama:</strong>
                                        <p style="margin: 5px 0 0 0; color: #666;">${club.description}</p>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Admin Bilgileri -->
                            ${adminInfo ? `
                                <div style="background: #fff3cd; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #ffc107;">
                                    <h3 style="margin-bottom: 15px; color: #856404; display: flex; align-items: center; gap: 10px;">
                                        ğŸ‘¤ Admin Bilgileri
                                    </h3>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                                        <div><strong>ğŸ‘¤ Ä°sim:</strong> ${adminInfo.fullName || club.adminName || '-'}</div>
                                        <div><strong>ğŸ“§ Email:</strong> ${adminInfo.email || club.adminEmail || '-'}</div>
                                        <div><strong>ğŸ“± Telefon:</strong> <code style="background: #fff; padding: 2px 6px; border-radius: 4px;">${adminInfo.phone || club.adminPhone || '-'}</code></div>
                                        <div><strong>ğŸ”‘ Åifre:</strong> <code style="background: #fff; padding: 2px 6px; border-radius: 4px; font-weight: bold;">${adminInfo.password || 'Kulup123!'}</code></div>
                                    </div>
                                    <div style="background: #fff; padding: 12px; border-radius: 8px; margin-top: 15px; font-size: 13px; color: #856404;">
                                        âœ… Admin <strong>sporcum.co/giris</strong> adresinden telefon ve ÅŸifre ile giriÅŸ yapabilir.
                                    </div>
                                </div>
                            ` : `
                                <div style="background: #ffebee; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #f44336;">
                                    <p style="margin: 0; color: #c62828;">
                                        âš ï¸ Bu kulÃ¼p iÃ§in admin kullanÄ±cÄ±sÄ± bulunamadÄ±. LÃ¼tfen kulÃ¼bÃ¼ dÃ¼zenleyerek admin bilgilerini ekleyin.
                                    </p>
                                </div>
                            `}
                            
                            <!-- CRM Lead DetaylarÄ± -->
                            ${totalLeads > 0 ? `
                                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #e0e0e0;">
                                    <h3 style="margin-bottom: 15px; color: #667eea; display: flex; align-items: center; gap: 10px;">
                                        ğŸ“ CRM Lead DurumlarÄ±
                                    </h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                                        ${Object.entries(leadsByStatus).map(([status, count]) => `
                                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center;">
                                                <div style="font-size: 20px; font-weight: bold; color: #667eea;">${count}</div>
                                                <div style="font-size: 12px; color: #666; margin-top: 5px; text-transform: capitalize;">${status}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                             <!-- Muhasebe / Ã–nemli Bilgiler -->
                             <div style="background: linear-gradient(135deg, #e3f2fd 0%, #fff 100%); padding: 20px; border-radius: 12px; border: 2px solid #2196f3;">
                                 <h3 style="margin-bottom: 15px; color: #1976d2; display: flex; align-items: center; gap: 10px;">
                                     ğŸ’° Muhasebe & Ã–nemli Bilgiler
                                 </h3>
                                 <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                                     <div style="background: white; padding: 15px; border-radius: 8px;">
                                         <strong>ğŸ’³ AylÄ±k Ãœyelik Geliri:</strong>
                                         <div style="font-size: 20px; font-weight: bold; color: #4caf50; margin-top: 5px;">
                                             ${monthlyRevenue.toLocaleString('tr-TR')} â‚º
                                         </div>
                                         <small style="color: #666; font-size: 11px;">Aktif Ã¼yelerin aylÄ±k toplam Ã¼creti</small>
                                     </div>
                                     <div style="background: white; padding: 15px; border-radius: 8px;">
                                         <strong>ğŸ“Š Ã–deme OranÄ±:</strong>
                                         <div style="font-size: 20px; font-weight: bold; color: ${paymentRate >= 80 ? '#4caf50' : paymentRate >= 60 ? '#ff9800' : '#f44336'}; margin-top: 5px;">
                                             ${paymentRate}%
                                         </div>
                                         <small style="color: #666; font-size: 11px;">Bu ay Ã¶deme yapan: ${paidCount}/${activeMembers}</small>
                                     </div>
                                     <div style="background: white; padding: 15px; border-radius: 8px;">
                                         <strong>ğŸ‘¥ Ãœye BÃ¼yÃ¼me:</strong>
                                         <div style="font-size: 20px; font-weight: bold; color: #9c27b0; margin-top: 5px;">
                                             +${newMembersThisMonth} Yeni
                                         </div>
                                         <small style="color: #666; font-size: 11px;">Bu ay kaydolan Ã¼ye sayÄ±sÄ±</small>
                                     </div>
                                     <div style="background: white; padding: 15px; border-radius: 8px;">
                                         <strong>ğŸ“‰ AyrÄ±lan Ãœyeler:</strong>
                                         <div style="font-size: 20px; font-weight: bold; color: ${leftMembersThisMonth > 0 ? '#f44336' : '#4caf50'}; margin-top: 5px;">
                                             ${leftMembersThisMonth}
                                         </div>
                                         <small style="color: #666; font-size: 11px;">Bu ay pasif/ayrÄ±lan Ã¼ye sayÄ±sÄ±</small>
                                     </div>
                                 </div>
                                 <div style="background: #fff; padding: 12px; border-radius: 8px; margin-top: 15px; font-size: 13px; color: #666;">
                                     â„¹ï¸ <strong>Not:</strong> Veriler Ã¼ye kayÄ±tlarÄ±ndan otomatik hesaplanmaktadÄ±r. Ã–deme oranÄ±, bu ay Ã¶deme yapan aktif Ã¼ye sayÄ±sÄ±na gÃ¶redir.
                                 </div>
                             </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button onclick="editClub('${clubId}')" class="btn btn-primary" style="flex: 1;">âœï¸ KulÃ¼bÃ¼ DÃ¼zenle</button>
                            <button onclick="showDashboard()" class="btn btn-secondary" style="flex: 1;">â† Geri DÃ¶n</button>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading detailed club info:', error);
                showAlert('DetaylÄ± bilgiler yÃ¼klenirken hata oluÅŸtu: ' + error.message, 'error');
            }
        };

        window.viewClubDetails = async function(clubId) {
            const club = clubs.find(c => c.id === clubId);
            if (!club) return;
            
            // Load WhatsApp balance from Supabase
            let whatsappBalance = 0;
            let balanceLogs = [];
            try {
                const { data: clubData, error: clubError } = await window.supabase
                    .from('clubs')
                    .select('whatsapp_balance')
                    .eq('id', clubId)
                    .single();
                
                if (clubError) throw clubError;
                whatsappBalance = clubData?.whatsapp_balance || 0;
                
                // Load balance logs
                const { data: logs, error: logsError } = await window.supabase
                    .from('whatsapp_balance_logs')
                    .select('*')
                    .eq('club_id', clubId)
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (!logsError && logs) {
                    balanceLogs = logs;
                }
            } catch (error) {
                console.error('Error loading WhatsApp balance:', error);
            }
            
            // Find admin user
            let adminInfo = null;
            try {
                const { data: users, error } = await window.supabase
                    .from('users')
                    .select('*')
                    .eq('club_id', clubId)
                    .eq('role', 'admin')
                    .limit(1);
                
                if (!error && users && users.length > 0) {
                    adminInfo = users[0];
                }
            } catch (error) {
                console.error('Error loading admin info:', error);
            }
            
            showModal(`
                <h3>ğŸ¢ ${club.icon || 'ğŸ†'} ${club.name}</h3>
                <div style="padding: 20px 0;">
                    <h4 style="margin-bottom: 15px; color: #667eea;">ğŸ“‹ KulÃ¼p Bilgileri</h4>
                    <div class="detail-row"><strong>ğŸ“ Åehir:</strong> ${club.city || '-'}</div>
                    <div class="detail-row"><strong>ğŸ‘¥ Ãœye SayÄ±sÄ±:</strong> ${club.memberCount || 0}</div>
                    <div class="detail-row"><strong>ğŸ“ AÃ§Ä±klama:</strong> ${club.description || '-'}</div>
                    <div class="detail-row"><strong>âœ… Durum:</strong> <span class="status-badge ${club.status === 'active' ? 'active' : 'inactive'}">${club.status === 'active' ? 'Aktif' : 'Pasif'}</span></div>
                    <div class="detail-row"><strong>ğŸ“… KayÄ±t Tarihi:</strong> ${club.createdAt ? new Date(club.createdAt).toLocaleDateString('tr-TR', {year: 'numeric', month: 'long', day: 'numeric'}) : '-'}</div>
                    
                    <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">
                    <h4 style="margin-bottom: 15px; color: #667eea;">ğŸ“± WhatsApp Mesaj HakkÄ±</h4>
                    <div style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); padding: 20px; border-radius: 12px; color: white; margin-bottom: 15px;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">Kalan Mesaj HakkÄ±</div>
                        <div style="font-size: 36px; font-weight: 700;">${whatsappBalance.toLocaleString('tr-TR')}</div>
                        <div style="font-size: 13px; opacity: 0.8; margin-top: 5px;">mesaj</div>
                    </div>
                    <button onclick="showAddBalanceModal('${clubId}', '${club.name}')" style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-bottom: 10px;">
                        â• Mesaj HakkÄ± Ekle
                    </button>
                    ${balanceLogs.length > 0 ? `
                        <div style="margin-top: 15px;">
                            <h5 style="margin-bottom: 10px; color: #666; font-size: 14px;">ğŸ“Š Son Ä°ÅŸlemler</h5>
                            <div style="max-height: 200px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; padding: 10px;">
                                ${balanceLogs.map(log => `
                                    <div style="padding: 8px; border-bottom: 1px solid #dee2e6; font-size: 13px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="font-weight: 600; color: ${log.amount > 0 ? '#28a745' : '#dc3545'};">
                                                ${log.amount > 0 ? '+' : ''}${log.amount.toLocaleString('tr-TR')} mesaj
                                            </span>
                                            <span style="color: #6c757d; font-size: 12px;">
                                                ${new Date(log.created_at).toLocaleDateString('tr-TR', {day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'})}
                                            </span>
                                        </div>
                                        <div style="color: #6c757d; font-size: 12px; margin-top: 3px;">
                                            ${log.action_type === 'manual_add' ? 'ğŸ‘¨â€ğŸ’¼ Manuel Ekleme' : 
                                              log.action_type === 'purchase' ? 'ğŸ’³ Paket SatÄ±n Alma' : 
                                              log.action_type === 'send' ? 'ğŸ“¤ Mesaj GÃ¶nderimi' : 
                                              log.action_type === 'add' ? 'â• Ekleme' : log.action_type}
                                            ${log.note ? ' - ' + log.note : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${adminInfo ? `
                        <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">
                        <h4 style="margin-bottom: 15px; color: #667eea;">ğŸ” Admin GiriÅŸ Bilgileri</h4>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 2px solid #ffc107;">
                            <div class="detail-row"><strong>ğŸ‘¤ Ad Soyad:</strong> ${adminInfo.full_name || adminInfo.fullName || club.adminName || '-'}</div>
                            <div class="detail-row"><strong>ğŸ“§ Email:</strong> ${adminInfo.email || club.adminEmail || '-'}</div>
                            <div class="detail-row"><strong>ğŸ“± Telefon:</strong> ${adminInfo.phone || club.adminPhone || '-'}</div>
                            <div class="detail-row"><strong>ğŸ”‘ Åifre:</strong> <code style="background: #fff; padding: 4px 8px; border-radius: 4px; font-size: 14px;">${adminInfo.password || 'Kulup123!'}</code></div>
                        </div>
                        <div style="background: #e8f5e9; padding: 12px; border-radius: 8px; margin-top: 10px;">
                            <p style="margin: 0; color: #2e7d32; font-size: 14px;">
                                âœ… Admin <strong>sporcum.co/giris</strong> adresinden telefon ve ÅŸifre ile giriÅŸ yapabilir.
                            </p>
                        </div>
                    ` : `
                        <hr style="margin: 20px 0; border: none; border-top: 1px solid #e0e0e0;">
                        <div style="background: #ffebee; padding: 15px; border-radius: 8px;">
                            <p style="margin: 0; color: #c62828;">
                                âš ï¸ Bu kulÃ¼p iÃ§in admin kullanÄ±cÄ±sÄ± bulunamadÄ±. LÃ¼tfen kulÃ¼bÃ¼ dÃ¼zenleyerek admin bilgilerini ekleyin.
                            </p>
                        </div>
                    `}
                </div>
                <button onclick="closeModal()" class="btn btn-primary" style="width: 100%; margin-top: 10px;">Kapat</button>
            `);
        };
        
        window.showAddBalanceModal = function(clubId, clubName) {
            closeModal();
            
            setTimeout(() => {
                const modal = document.getElementById('modal');
                const modalContent = document.getElementById('modal-content');
                
                modalContent.innerHTML = `
                    <div style="max-width: 500px; margin: 0 auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                            <h3 style="margin: 0;">â• Mesaj HakkÄ± Ekle</h3>
                            <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">Ã—</button>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <strong>KulÃ¼p:</strong> ${clubName}
                        </div>
                        
                        <form id="add-balance-form" style="display: flex; flex-direction: column; gap: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Eklenecek Mesaj SayÄ±sÄ±</label>
                                <input 
                                    type="number" 
                                    id="balance-amount" 
                                    placeholder="Ã–rn: 500"
                                    min="1"
                                    style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;"
                                    required
                                >
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Not (Opsiyonel)</label>
                                <textarea 
                                    id="balance-note" 
                                    placeholder="Ã–rn: Ãœcretsiz deneme paketi"
                                    rows="3"
                                    style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; resize: vertical;"
                                ></textarea>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px;">
                                <button type="button" onclick="closeModal()" style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Ä°ptal
                                </button>
                                <button type="submit" style="padding: 12px 24px; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    âœ… Mesaj HakkÄ± Ekle
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                modal.style.display = 'flex';
                
                document.getElementById('add-balance-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await handleAddBalance(clubId);
                });
            }, 100);
        };
        
        async function handleAddBalance(clubId) {
            const amount = parseInt(document.getElementById('balance-amount').value);
            const note = document.getElementById('balance-note').value.trim();
            
            if (!amount || amount < 1) {
                showAlert('âŒ LÃ¼tfen geÃ§erli bir miktar girin!', 'error');
                return;
            }
            
            try {
                // Supabase fonksiyonunu Ã§aÄŸÄ±r
                const { data, error } = await window.supabase.rpc('update_whatsapp_balance', {
                    p_club_id: clubId,
                    p_amount: amount,
                    p_action_type: 'manual_add',
                    p_note: note || null,
                    p_created_by: 'superadmin'
                });
                
                if (error) throw error;
                
                showAlert(`âœ… ${amount} mesaj hakkÄ± baÅŸarÄ±yla eklendi!`, 'success');
                closeModal();
                
                // KulÃ¼p detaylarÄ±nÄ± yeniden gÃ¶ster
                setTimeout(() => {
                    window.viewClubDetails(clubId);
                }, 500);
                
            } catch (error) {
                console.error('Error adding balance:', error);
                showAlert('âŒ Mesaj hakkÄ± eklenirken hata oluÅŸtu: ' + error.message, 'error');
            }
        }

        window.showSection = function(section) {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            const clickedBtn = event.target;
            clickedBtn.classList.add('active');
            
            if (section === 'dashboard') {
                renderDashboard();
            } else if (section === 'clubs') {
                renderClubsList();
            } else if (section === 'whatsapp-packages') {
                renderWhatsAppPackages();
            } else if (section === 'settings') {
                renderSettings();
            }
        };
        
        function renderSettings() {
            const container = document.getElementById('content-area');
            container.innerHTML = `
                <h2 style="margin-bottom: 30px;">âš™ï¸ SuperAdmin AyarlarÄ±</h2>
                
                <div style="max-width: 600px; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 20px;">ğŸ” KullanÄ±cÄ± AdÄ± ve Åifre DeÄŸiÅŸtir</h3>
                    
                    <form id="superadmin-settings-form" style="display: flex; flex-direction: column; gap: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Email (KullanÄ±cÄ± AdÄ±)</label>
                            <input 
                                type="email" 
                                id="new-email" 
                                value="superadmin@sporcum.com"
                                style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;"
                                required
                            >
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Mevcut Åifre</label>
                            <input 
                                type="password" 
                                id="current-password"
                                placeholder="Mevcut ÅŸifrenizi girin"
                                style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;"
                                required
                            >
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Yeni Åifre</label>
                            <input 
                                type="password" 
                                id="new-password"
                                placeholder="Yeni ÅŸifrenizi girin (min 8 karakter)"
                                style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;"
                                minlength="8"
                                required
                            >
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Yeni Åifre (Tekrar)</label>
                            <input 
                                type="password" 
                                id="new-password-confirm"
                                placeholder="Yeni ÅŸifrenizi tekrar girin"
                                style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;"
                                minlength="8"
                                required
                            >
                        </div>
                        
                        <button 
                            type="submit" 
                            class="btn btn-primary"
                            style="width: 100%; padding: 15px; font-size: 16px;"
                        >
                            ğŸ’¾ Kaydet
                        </button>
                    </form>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <strong>âš ï¸ UyarÄ±:</strong> Åifrenizi deÄŸiÅŸtirdikten sonra tekrar giriÅŸ yapmanÄ±z gerekecektir.
                    </div>
                </div>
            `;
            
            // Form submit handler
            document.getElementById('superadmin-settings-form').addEventListener('submit', handleSettingsSubmit);
        }
        
        async function handleSettingsSubmit(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current-password').value;
            const newEmail = document.getElementById('new-email').value;
            const newPassword = document.getElementById('new-password').value;
            const newPasswordConfirm = document.getElementById('new-password-confirm').value;
            
            // Validation
            if (newPassword !== newPasswordConfirm) {
                showAlert('Yeni ÅŸifreler eÅŸleÅŸmiyor!', 'error');
                return;
            }
            
            if (newPassword.length < 8) {
                showAlert('Yeni ÅŸifre en az 8 karakter olmalÄ±dÄ±r!', 'error');
                return;
            }
            
            try {
                // Get current credentials from Firebase
                const { doc, getDoc, setDoc } = window.firebaseModules;
                const configRef = doc(window.db, 'superadmin', 'config');
                const configDoc = await getDoc(configRef);
                
                let currentConfig = {
                    email: 'superadmin@sporcum.com',
                    password: 'Sporcum2024!'
                };
                
                if (configDoc.exists()) {
                    currentConfig = configDoc.data();
                }
                
                // Verify current password
                if (currentPassword !== currentConfig.password) {
                    showAlert('Mevcut ÅŸifre yanlÄ±ÅŸ!', 'error');
                    return;
                }
                
                // Save new credentials
                await setDoc(configRef, {
                    email: newEmail,
                    password: newPassword,
                    updatedAt: new Date().toISOString()
                });
                
                showAlert('âœ… KullanÄ±cÄ± adÄ± ve ÅŸifre baÅŸarÄ±yla gÃ¼ncellendi! Yeniden giriÅŸ yapmanÄ±z gerekiyor...', 'success');
                
                // Logout after 2 seconds
                setTimeout(() => {
                    handleLogout();
                }, 2000);
                
            } catch (error) {
                console.error('Settings update error:', error);
                showAlert('Ayarlar gÃ¼ncellenirken hata oluÅŸtu: ' + error.message, 'error');
            }
        }

        function showModal(content) {
            console.log('ğŸ“± Showing modal...');
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');
            
            if (!modal || !modalContent) {
                console.error('âŒ Modal elements not found!');
                return;
            }
            
            modalContent.innerHTML = content;
            modal.style.display = 'flex';
            console.log('âœ… Modal displayed');
        }

        function closeModal() {
            console.log('ğŸ”µ Closing modal...');
            const modal = document.getElementById('modal');
            if (modal) {
                modal.style.display = 'none';
                console.log('âœ… Modal closed');
            }
        }

        window.closeModal = closeModal;

        // ==================== WHATSAPP PACKAGES MANAGEMENT ====================
        
        async function renderWhatsAppPackages() {
            const container = document.getElementById('content-area');
            container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p>YÃ¼kleniyor...</p></div>';
            
            try {
                const { data: packages, error } = await window.supabase
                    .from('whatsapp_packages')
                    .select('*')
                    .order('message_count', { ascending: true });
                
                if (error) throw error;
                
                container.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="margin: 0;">ğŸ“± WhatsApp Mesaj Paketleri</h2>
                        <button onclick="showAddPackageModal()" class="btn-primary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            â• Yeni Paket Ekle
                        </button>
                    </div>
                    
                    <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                        <th style="padding: 15px; text-align: left;">Paket AdÄ±</th>
                                        <th style="padding: 15px; text-align: center;">Mesaj SayÄ±sÄ±</th>
                                        <th style="padding: 15px; text-align: center;">Fiyat</th>
                                        <th style="padding: 15px; text-align: center;">AÃ§Ä±klama</th>
                                        <th style="padding: 15px; text-align: center;">Durum</th>
                                        <th style="padding: 15px; text-align: center;">Ä°ÅŸlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${packages.length === 0 ? `
                                        <tr>
                                            <td colspan="6" style="padding: 40px; text-align: center; color: #6c757d;">
                                                HenÃ¼z paket eklenmemiÅŸ
                                            </td>
                                        </tr>
                                    ` : packages.map(pkg => `
                                        <tr style="border-bottom: 1px solid #dee2e6;">
                                            <td style="padding: 15px; font-weight: 600;">${pkg.name}</td>
                                            <td style="padding: 15px; text-align: center;">${pkg.message_count.toLocaleString('tr-TR')} mesaj</td>
                                            <td style="padding: 15px; text-align: center; font-weight: 600; color: #28a745;">â‚º${parseFloat(pkg.price).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                                            <td style="padding: 15px; text-align: center; color: #6c757d; font-size: 13px; max-width: 200px;">${pkg.description || '-'}</td>
                                            <td style="padding: 15px; text-align: center;">
                                                <span style="padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; ${pkg.is_active ? 'background: #d4edda; color: #155724;' : 'background: #f8d7da; color: #721c24;'}">
                                                    ${pkg.is_active ? 'âœ“ Aktif' : 'âœ— Pasif'}
                                                </span>
                                            </td>
                                            <td style="padding: 15px; text-align: center;">
                                                <button onclick="togglePackageStatus('${pkg.id}', ${!pkg.is_active})" class="btn-sm" style="margin-right: 8px; padding: 6px 12px; background: ${pkg.is_active ? '#ffc107' : '#28a745'}; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                                    ${pkg.is_active ? 'â¸ PasifleÅŸtir' : 'â–¶ AktifleÅŸtir'}
                                                </button>
                                                <button onclick="editPackage('${pkg.id}')" class="btn-sm" style="margin-right: 8px; padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                                    âœï¸ DÃ¼zenle
                                                </button>
                                                <button onclick="deletePackage('${pkg.id}')" class="btn-sm" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                                    ğŸ—‘ï¸ Sil
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading packages:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <h3>âŒ Paketler yÃ¼klenirken hata oluÅŸtu</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        window.showAddPackageModal = function() {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');
            
            modalContent.innerHTML = `
                <div style="max-width: 600px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h3 style="margin: 0;">â• Yeni WhatsApp Paketi Ekle</h3>
                        <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">Ã—</button>
                    </div>
                    
                    <form id="add-package-form" style="display: flex; flex-direction: column; gap: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Paket AdÄ±</label>
                            <input 
                                type="text" 
                                id="package-name" 
                                placeholder="Ã–rn: BaÅŸlangÄ±Ã§ Paketi"
                                style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;"
                                required
                            >
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Mesaj SayÄ±sÄ±</label>
                            <input 
                                type="number" 
                                id="package-count" 
                                placeholder="Ã–rn: 1000"
                                min="1"
                                style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;"
                                required
                            >
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Fiyat (â‚º)</label>
                            <input 
                                type="number" 
                                id="package-price" 
                                placeholder="Ã–rn: 99.00"
                                min="0"
                                step="0.01"
                                style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;"
                                required
                            >
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">AÃ§Ä±klama (Opsiyonel)</label>
                            <textarea 
                                id="package-description" 
                                placeholder="Paket hakkÄ±nda kÄ±sa aÃ§Ä±klama"
                                rows="3"
                                style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; resize: vertical;"
                            ></textarea>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input 
                                type="checkbox" 
                                id="package-active" 
                                checked
                                style="width: 20px; height: 20px; cursor: pointer;"
                            >
                            <label for="package-active" style="cursor: pointer; font-weight: 600;">Paketi Aktif Olarak Ekle</label>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px;">
                            <button type="button" onclick="closeModal()" style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Ä°ptal
                            </button>
                            <button type="submit" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                ğŸ’¾ Paketi Kaydet
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            modal.style.display = 'flex';
            
            document.getElementById('add-package-form').addEventListener('submit', handleAddPackage);
        };
        
        async function handleAddPackage(e) {
            e.preventDefault();
            
            const name = document.getElementById('package-name').value.trim();
            const messageCount = parseInt(document.getElementById('package-count').value);
            const price = parseFloat(document.getElementById('package-price').value);
            const description = document.getElementById('package-description').value.trim();
            const isActive = document.getElementById('package-active').checked;
            
            if (!name || messageCount < 1 || price < 0) {
                showAlert('âŒ LÃ¼tfen tÃ¼m gerekli alanlarÄ± doÄŸru doldurun!', 'error');
                return;
            }
            
            try {
                const { data, error } = await window.supabase
                    .from('whatsapp_packages')
                    .insert([{
                        name: name,
                        message_count: messageCount,
                        price: price,
                        description: description || null,
                        is_active: isActive
                    }])
                    .select();
                
                if (error) throw error;
                
                showAlert('âœ… Paket baÅŸarÄ±yla eklendi!', 'success');
                closeModal();
                renderWhatsAppPackages();
                
            } catch (error) {
                console.error('Error adding package:', error);
                showAlert('âŒ Paket eklenirken hata oluÅŸtu: ' + error.message, 'error');
            }
        }
        
        window.editPackage = async function(packageId) {
            try {
                const { data: pkg, error } = await window.supabase
                    .from('whatsapp_packages')
                    .select('*')
                    .eq('id', packageId)
                    .single();
                
                if (error) throw error;
                
                const modal = document.getElementById('modal');
                const modalContent = document.getElementById('modal-content');
                
                modalContent.innerHTML = `
                    <div style="max-width: 600px; margin: 0 auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                            <h3 style="margin: 0;">âœï¸ Paketi DÃ¼zenle</h3>
                            <button onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">Ã—</button>
                        </div>
                        
                        <form id="edit-package-form" style="display: flex; flex-direction: column; gap: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Paket AdÄ±</label>
                                <input 
                                    type="text" 
                                    id="edit-package-name" 
                                    value="${pkg.name}"
                                    style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;"
                                    required
                                >
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Mesaj SayÄ±sÄ±</label>
                                <input 
                                    type="number" 
                                    id="edit-package-count" 
                                    value="${pkg.message_count}"
                                    min="1"
                                    style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;"
                                    required
                                >
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Fiyat (â‚º)</label>
                                <input 
                                    type="number" 
                                    id="edit-package-price" 
                                    value="${pkg.price}"
                                    min="0"
                                    step="0.01"
                                    style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;"
                                    required
                                >
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">AÃ§Ä±klama</label>
                                <textarea 
                                    id="edit-package-description" 
                                    rows="3"
                                    style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; resize: vertical;"
                                >${pkg.description || ''}</textarea>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input 
                                    type="checkbox" 
                                    id="edit-package-active" 
                                    ${pkg.is_active ? 'checked' : ''}
                                    style="width: 20px; height: 20px; cursor: pointer;"
                                >
                                <label for="edit-package-active" style="cursor: pointer; font-weight: 600;">Paket Aktif</label>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px;">
                                <button type="button" onclick="closeModal()" style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Ä°ptal
                                </button>
                                <button type="submit" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    ğŸ’¾ DeÄŸiÅŸiklikleri Kaydet
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                
                modal.style.display = 'flex';
                
                document.getElementById('edit-package-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await handleEditPackage(packageId);
                });
                
            } catch (error) {
                console.error('Error loading package:', error);
                showAlert('âŒ Paket bilgileri yÃ¼klenirken hata oluÅŸtu: ' + error.message, 'error');
            }
        };
        
        async function handleEditPackage(packageId) {
            const name = document.getElementById('edit-package-name').value.trim();
            const messageCount = parseInt(document.getElementById('edit-package-count').value);
            const price = parseFloat(document.getElementById('edit-package-price').value);
            const description = document.getElementById('edit-package-description').value.trim();
            const isActive = document.getElementById('edit-package-active').checked;
            
            if (!name || messageCount < 1 || price < 0) {
                showAlert('âŒ LÃ¼tfen tÃ¼m gerekli alanlarÄ± doÄŸru doldurun!', 'error');
                return;
            }
            
            try {
                const { data, error } = await window.supabase
                    .from('whatsapp_packages')
                    .update({
                        name: name,
                        message_count: messageCount,
                        price: price,
                        description: description || null,
                        is_active: isActive
                    })
                    .eq('id', packageId)
                    .select();
                
                if (error) throw error;
                
                showAlert('âœ… Paket baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
                closeModal();
                renderWhatsAppPackages();
                
            } catch (error) {
                console.error('Error updating package:', error);
                showAlert('âŒ Paket gÃ¼ncellenirken hata oluÅŸtu: ' + error.message, 'error');
            }
        }
        
        window.togglePackageStatus = async function(packageId, newStatus) {
            try {
                const { data, error } = await window.supabase
                    .from('whatsapp_packages')
                    .update({ is_active: newStatus })
                    .eq('id', packageId)
                    .select();
                
                if (error) throw error;
                
                showAlert(`âœ… Paket ${newStatus ? 'aktifleÅŸtirildi' : 'pasifleÅŸtirildi'}!`, 'success');
                renderWhatsAppPackages();
                
            } catch (error) {
                console.error('Error toggling package status:', error);
                showAlert('âŒ Paket durumu deÄŸiÅŸtirilemedi: ' + error.message, 'error');
            }
        };
        
        window.deletePackage = async function(packageId) {
            if (!confirm('Bu paketi silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!')) {
                return;
            }
            
            try {
                const { data, error } = await window.supabase
                    .from('whatsapp_packages')
                    .delete()
                    .eq('id', packageId);
                
                if (error) throw error;
                
                showAlert('âœ… Paket baÅŸarÄ±yla silindi!', 'success');
                renderWhatsAppPackages();
                
            } catch (error) {
                console.error('Error deleting package:', error);
                showAlert('âŒ Paket silinirken hata oluÅŸtu: ' + error.message, 'error');
            }
        };

        // ==================== END WHATSAPP PACKAGES MANAGEMENT ====================

        async function testFirebaseConnection() {
            console.log('ğŸ” Testing Firebase connection...');
            showAlert('Firebase baÄŸlantÄ± testi baÅŸlatÄ±ldÄ±...', 'success');
            
            try {
                // Test 1: Read clubs
                const { collection, getDocs, addDoc, deleteDoc, doc } = window.firebaseModules;
                const testSnapshot = await getDocs(collection(window.db, 'clubs'));
                console.log('âœ… Test 1: Read clubs - SUCCESS', testSnapshot.size, 'clubs found');
                
                // Test 2: Write test
                const testData = {
                    name: 'TEST_CLUB_DELETE_ME',
                    status: 'test',
                    createdAt: new Date().toISOString(),
                    isTest: true
                };
                
                const testDocRef = await addDoc(collection(window.db, 'clubs'), testData);
                console.log('âœ… Test 2: Write test - SUCCESS, ID:', testDocRef.id);
                
                // Test 3: Delete test
                await deleteDoc(doc(window.db, 'clubs', testDocRef.id));
                console.log('âœ… Test 3: Delete test - SUCCESS');
                
                showAlert('âœ… Firebase baÄŸlantÄ± testi BAÅARILI! TÃ¼m izinler Ã§alÄ±ÅŸÄ±yor.', 'success');
                console.log('ğŸ‰ All Firebase tests passed!');
                
            } catch (error) {
                console.error('âŒ Firebase test failed:', error);
                
                let errorMsg = `Firebase Test BAÅARISIZ!\n\nHata: ${error.message}\n\n`;
                if (error.code === 'permission-denied') {
                    errorMsg += 'âš ï¸ Ä°zin hatasÄ±! Firestore kurallarÄ±nÄ± FIRESTORE_RULES_SUPERADMIN.md dosyasÄ±na gÃ¶re gÃ¼ncelleyin.';
                }
                
                showAlert(errorMsg, 'error');
            }
        }

        window.testFirebaseConnection = testFirebaseConnection;

        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${type === 'success' ? '#4caf50' : '#f44336'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => alertDiv.remove(), 300);
            }, 3000);
        }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            visibility: hidden;
        }
        
        body.loaded {
            visibility: visible;
        }

        /* Main Wrapper */
        #main-wrapper {
            min-height: 100vh;
        }

        .header {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            color: #333;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-name {
            color: #666;
            font-weight: 600;
        }

        .nav {
            background: white;
            padding: 20px 40px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 12px 24px;
            border: none;
            background: #f5f7fa;
            color: #666;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: #e0e5f0;
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .content {
            padding: 40px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card[onclick] {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stat-card[onclick]:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
        }

        .stat-card[onclick]:active {
            transform: translateY(-2px) scale(1);
        }

        .stat-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #999;
            font-size: 14px;
        }

        .clubs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .club-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .club-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .club-header {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: flex-start;
        }

        .club-icon {
            font-size: 48px;
        }

        .club-header h3 {
            margin-bottom: 5px;
            color: #333;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.active {
            background: #e8f5e9;
            color: #4caf50;
        }

        .status-badge.inactive {
            background: #fff3e0;
            color: #ff9800;
        }

        .club-info {
            margin-bottom: 20px;
            line-height: 1.8;
            color: #666;
        }

        .club-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn, .btn-small {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f7fa;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e5f0;
        }

        .btn-edit {
            background: #2196f3;
            color: white;
        }

        .btn-view {
            background: #4caf50;
            color: white;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .btn-logout {
            background: #dc3545;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Modal */
        #modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .detail-row {
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* âœ… Mobil Uyumluluk */
        @media (max-width: 992px) {
            .header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .nav {
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .nav-btn {
                font-size: 13px;
                padding: 10px 15px;
            }
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr !important;
            }
            
            .club-grid {
                grid-template-columns: 1fr !important;
            }
            
            .modal-content {
                width: 95%;
                max-width: none;
                padding: 20px;
                margin: 5% auto;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn-group button {
                width: 100%;
            }
            
            /* KulÃ¼p detay sayfasÄ± grid'leri */
            div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
            
            div[style*="grid-template-columns: repeat(auto-fit"] {
                grid-template-columns: 1fr !important;
            }
            
            /* Stat kartlarÄ± */
            div[style*="display: grid"][style*="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr))"] {
                grid-template-columns: 1fr !important;
            }
            
            /* Buton gruplarÄ± */
            div[style*="display: flex"][style*="gap: 10px"] button {
                flex: 1 1 100% !important;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-value {
                font-size: 24px;
            }
            
            .club-card {
                padding: 15px;
            }
            
            .btn {
                font-size: 13px;
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Main Wrapper -->
    <div id="main-wrapper">
        <div class="header">
            <h1>ğŸ† Sporcum - SuperAdmin Paneli</h1>
            <div class="header-right">
                <span class="admin-name"></span>
                <button onclick="handleLogout()" class="btn-logout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</button>
            </div>
        </div>

        <div class="nav">
            <button class="nav-btn active" onclick="showSection('dashboard')">ğŸ“Š Dashboard</button>
            <button class="nav-btn" onclick="showSection('clubs')">ğŸ¢ KulÃ¼pler</button>
            <button class="nav-btn" onclick="showSection('whatsapp-packages')">ğŸ“± WhatsApp Paketleri</button>
            <button class="nav-btn" onclick="showSection('settings')">âš™ï¸ Ayarlar</button>
        </div>

        <div class="content">
            <div id="content-area"></div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal">
        <div class="modal-content" id="modal-content"></div>
    </div>
</body>
</html>



