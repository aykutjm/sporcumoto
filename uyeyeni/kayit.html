<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spor KulÃ¼bÃ¼ - Ãœyelik SÃ¶zleÅŸmesi</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Ccircle cx=%2750%27 cy=%2750%27 r=%2748%27 fill=%27%234f46e5%27/%3E%3Ctext x=%2750%27 y=%2772%27 font-family=%27Arial,sans-serif%27 font-size=%2760%27 font-weight=%27bold%27 fill=%27white%27 text-anchor=%27middle%27%3ES%3C/text%3E%3C/svg%3E">
    <!-- Gerekli KÃ¼tÃ¼phaneler -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // IMPORTANT: Replace with your actual Supabase configuration
        const SUPABASE_URL = 'https://supabase.edu-ai.online';
        const SUPABASE_ANON_KEY = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJzdXBhYmFzZSIsImlhdCI6MTc2MjEwNTMyMCwiZXhwIjo0OTE3Nzc4OTIwLCJyb2xlIjoiYW5vbiJ9.HXUza0GT82-trWkx0WWKe-nY7KsGrIjIHSOJPKsOHjs';
        
        // Direkt Supabase client oluÅŸtur (helper kullanmadan)
        const { createClient } = supabase;
        window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        console.log('âœ… Supabase initialized:', window.supabase);
    </script>
    
    <style>
        :root {
            --primary-color: #0891b2; /* CanlÄ± CamgÃ¶beÄŸi */
            --secondary-color: #7c3aed; /* CanlÄ± Mor */
            --success-color: #16a34a;
            --danger-color: #dc2626;
            --dark-color: #1f2937;
            --light-color: #f9fafb;
            --border-color: #e5e7eb;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #e0e7ff 100%); /* AÃ§Ä±k ve modern arkaplan */
            min-height: 100vh; 
            padding: 20px; 
            color: #333; 
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }
        .container { 
            max-width: 900px; 
            width: 100%;
            margin: 0 auto; 
            background: white; 
            border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.1); 
            overflow: hidden; 
        }
        .header { 
            background: linear-gradient(45deg, var(--primary-color) 0%, var(--secondary-color) 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        .header h1 { font-size: 2.2em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .form-container { 
            padding: 30px 40px; 
            display: flex;
            flex-direction: column;
        }
        
        #progress-bar { display: flex; justify-content: space-between; margin-bottom: 30px; position: relative; }
        #progress-bar::before { content: ''; position: absolute; top: 50%; left: 0; transform: translateY(-50%); height: 4px; width: 100%; background-color: var(--border-color); z-index: 1; }
        #progress-line { position: absolute; top: 50%; left: 0; transform: translateY(-50%); height: 4px; background-color: var(--primary-color); z-index: 2; width: 0%; transition: width 0.3s ease; }
        .progress-step { position: relative; z-index: 3; width: 30px; height: 30px; background-color: white; border: 3px solid var(--border-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--border-color); transition: all 0.3s ease; }
        .progress-step.active { border-color: var(--primary-color); background-color: var(--primary-color); color: white; }

        .form-step { display: none; }
        .form-step.active { display: block; animation: fadeIn 0.5s ease; flex-grow: 1; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .section-title { font-size: 1.5em; color: var(--dark-color); margin-bottom: 25px; text-align: center; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 8px; font-size: 0.95em; }
        input, select, textarea { padding: 12px 15px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 1em; transition: all 0.3s ease; width: 100%; background-color: var(--light-color); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.2); }
        
        .contract-text { background: white; padding: 25px; border-radius: 10px; border: 2px solid var(--border-color); max-height: 500px; overflow-y: auto; font-size: 0.9em; line-height: 1.8; white-space: pre-line; }
        .contract-text h4 { color: var(--primary-color); margin-top: 20px; margin-bottom: 15px; font-size: 1.3em; }
        .contract-text p { margin-bottom: 12px; text-align: justify; white-space: normal; }
        .contract-text strong { color: var(--secondary-color); }
        .contract-text table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .contract-text table th, .contract-text table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .contract-text table th { background-color: #f2f2f2; font-weight: bold; }
        .signature-section { background: var(--light-color); border-radius: 15px; padding: 30px; text-align: center; }
        .signature-canvas { border: 2px solid var(--border-color); border-radius: 10px; cursor: crosshair; display: block; margin: 20px auto; max-width: 100%; }
        
        .btn { padding: 12px 25px; border: none; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-success { background: var(--success-color); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .form-navigation { display: flex; justify-content: space-between; margin-top: 30px; }
        
        .checkbox-group { display: flex; align-items: flex-start; gap: 15px; margin: 20px 0; }
        .checkbox-group input { width: 20px; height: 20px; margin-top: 3px; flex-shrink: 0;}
        
        .alert { padding: 15px; border-radius: 8px; border: 1px solid transparent; margin-bottom: 20px; text-align: center; }
        .alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
        .alert-success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }

        #pre-reg-not-found { display: none; }
        #paymentPlanContainer { display: none; padding: 25px; border-radius: 15px; background: var(--light-color); border-left: 5px solid var(--primary-color); }
        .payment-schedule { margin-top: 15px; }
        .payment-item-preview { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: white; border-radius: 5px; margin-bottom: 5px; border: 1px solid var(--border-color); }
        
        .admin-link { position: fixed; top: 20px; right: 20px; background: rgba(255,255,255,0.9); padding: 10px 15px; border-radius: 25px; text-decoration: none; color: var(--dark-color); font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: all 0.3s ease; backdrop-filter: blur(10px); z-index: 100; }
        .admin-link:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }

        #step-1 {
            background-color: #f0f5ff; /* AÃ§Ä±k mavi tonu */
            border: 1px solid #dde8ff;
            border-radius: 15px;
            padding: 25px;
        }
        @media (max-width: 576px) {
            #step-1 .form-grid {
                grid-template-columns: 1fr;
            }
        }
        #successMessage {
            padding: 50px 20px;
            min-height: 450px;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            width: 100%;
        }
        #successMessage h3 {
            font-size: 1.8em;
            color: var(--success-color);
        }
        .iban-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
            width: 100%;
            max-width: 700px;
        }
        .iban-info {
            background-color: #f0f5ff;
            border: 1px solid #dde8ff;
            border-radius: 15px;
            padding: 20px;
            flex: 1;
            min-width: 300px;
            text-align: left;
        }
        .iban-info h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        .iban-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 0.95em;
            word-break: break-all;
        }
        .iban-item .iban-text {
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
        }
        .btn-copy {
            padding: 5px 10px;
            font-size: 0.8em;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            flex-shrink: 0;
        }
        .btn-copy:hover {
            background-color: var(--secondary-color);
        }

    </style>
</head>
<body>
    <a href="/uyeyeni/admin" class="admin-link">ğŸ¢ Admin Panel</a>
    
    <div class="container" id="main-container">
        <div class="header">
            <h1 id="clubNameHeader">YÃ¼kleniyor...</h1>
            <p id="clubSubtitleHeader">Online Ãœyelik SÃ¶zleÅŸmesi</p>
        </div>
        <div class="form-container">
            <div id="progress-bar">
                <div class="progress-step active" data-step="1">1</div>
                <div class="progress-step" data-step="2">2</div>
                <div class="progress-step" data-step="3">3</div>
                <div class="progress-step" data-step="4">4</div>
                <div id="progress-line"></div>
            </div>

            <form id="membershipForm">
                <!-- Step 1: Pre-registration Check -->
                <div class="form-step active" id="step-1">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="branchSelection">BranÅŸ SeÃ§imi *</label>
                            <select id="branchSelection" required>
                                <option value="">YÃ¼kleniyor...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="phone">Telefon NumaranÄ±z *</label>
                            <input type="tel" id="phone" required placeholder="Sistemdeki Ã¶n kayÄ±tÄ±nÄ±zÄ± bulmak iÃ§in lÃ¼tfen telefon numarasÄ± giriniz" pattern="0[0-g]{10}" maxlength="11" title="Telefon numarasÄ± 0 ile baÅŸlamalÄ± ve 11 haneli olmalÄ±dÄ±r.">
                        </div>
                    </div>
                    <div id="pre-reg-not-found" class="alert alert-danger" style="margin-top: 20px;">
                        <strong>Ã–n kayÄ±tÄ±nÄ±z bulunmamaktadÄ±r.</strong> LÃ¼tfen iletiÅŸime geÃ§iniz: 0362 363 00 64
                    </div>
                </div>

                <!-- Step 2: Information and Payment Plan -->
                <div class="form-step" id="step-2">
                     <h3 class="section-title">KayÄ±t Bilgileri ve Aidat Bilgileriniz</h3>
                     <div id="paymentPlanContainer"></div>
                </div>
                 <!-- Step 3: Veli / Ãœye Bilgileri -->
                <div class="form-step" id="step-3">
                    <h3 class="section-title" id="step3Title">KiÅŸisel Bilgiler</h3>
                    <div class="form-grid">
                        <div class="form-group"><label for="fullName" id="fullNameLabel">Ad Soyad *</label><input type="text" id="fullName" name="Ad_Soyad" required></div>
                        <div class="form-group"><label for="tcno">T.C. Kimlik No *</label><input type="text" id="tcno" name="TC_Kimlik_No" pattern="[0-9]{11}" maxlength="11" required></div>
                        <div class="form-group"><label for="birthDate" id="birthDateLabel">DoÄŸum Tarihi *</label><input type="date" id="birthDate" name="Dogum_Tarihi" min="1900-01-01" max="" required></div>
                         <div class="form-group"><label for="address">Adres *</label><textarea id="address" name="Adres" rows="3" required></textarea></div>
                    </div>
                    <div id="minorFields" style="margin-top: 20px; display: none;">
                        <h4 class="section-title" style="font-size: 1.2em; margin-bottom: 15px; text-align: left;">Ã–ÄŸrenci Bilgileri</h4>
                        <div class="form-grid">
                            <div class="form-group"><label for="minorFullName">Ã–ÄŸrenci AdÄ± SoyadÄ± *</label><input type="text" id="minorFullName" name="Resit_Olmayan_Adi_Soyadi"></div>
                            <div class="form-group"><label for="minorTc">ğŸ†” Ã–ÄŸrenci TC Kimlik No *</label><input type="text" id="minorTc" name="Resit_Olmayan_TC" pattern="[0-9]{11}" maxlength="11" placeholder="11 haneli TC kimlik numarasÄ±"></div>
                            <div class="form-group"><label for="minorDob">Ã–ÄŸrenci DoÄŸum Tarihi *</label><input type="date" id="minorDob" name="Resit_Olmayan_Dogum_Tarihi" min="1900-01-01" max=""></div>
                        </div>
                        <h4 class="section-title" style="font-size: 1.2em; margin-top: 20px; margin-bottom: 15px; text-align: left;">Ä°kinci Veli Bilgileri (Ä°steÄŸe BaÄŸlÄ±)</h4>
                        <div class="form-grid">
                            <div class="form-group"><label for="parentName2">Veli 2 AdÄ± SoyadÄ±</label><input type="text" id="parentName2" name="Veli_2_Adi_Soyadi"></div>
                            <div class="form-group"><label for="phone2">Veli 2 Telefon NumarasÄ±</label><input type="tel" id="phone2" name="Telefon_2" pattern="0[0-9]{10}" maxlength="11"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Contract and Signature -->
                <div class="form-step" id="step-4">
                     <h3 class="section-title">SÃ¶zleÅŸme ve Ä°mza</h3>
                     <div class="checkbox-group">
                         <input type="checkbox" id="cancellationPolicyNew" name="CancellationPolicyNew" required>
                         <label for="cancellationPolicyNew">ÃœyeliÄŸiniz iptal edilene kadar devam etmektedir. Her ayÄ±n 14â€™Ã¼, yeni dÃ¶nem iÃ§in kayÄ±t iptali yapÄ±labilecek son gÃ¼ndÃ¼r. Bu tarihe kadar iptal edilmeyen kayÄ±tlar, devam eden dÃ¶nem iÃ§in geÃ§erli sayÄ±lÄ±r.</label>
                     </div>
                     <div class="contract-text" id="contractTextArea"></div>
                     <div class="checkbox-group">
                        <input type="checkbox" id="agreeContract" name="Sozlesme_Onayi" value="Kabul Edildi" required>
                        <label for="agreeContract">Ãœyelik sÃ¶zleÅŸmesini okudum, anladÄ±m ve kabul ediyorum. *</label>
                    </div>
                    <div class="signature-section">
                        <p>LÃ¼tfen aÅŸaÄŸÄ±daki alana imzanÄ±zÄ± atÄ±n:</p>
                        <canvas id="signatureCanvas" class="signature-canvas" width="400" height="200"></canvas>
                        <div><button type="button" class="btn btn-secondary" onclick="clearSignature()">Ä°mzayÄ± Temizle</button></div>
                    </div>
                </div>

                <div class="form-navigation">
                    <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">Geri</button>
                    <button type="button" class="btn btn-primary" id="nextBtn">Ä°leri</button>
                    <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">SÃ¶zleÅŸmeyi Onayla</button>
                </div>
                 <!-- BaÅŸarÄ± mesajÄ± formun iÃ§ine taÅŸÄ±ndÄ± -->
                 <div id="successMessage" class="alert alert-success">
                     <h3 id="successTitle">ğŸ‰ KayÄ±t Ä°ÅŸleminiz TamamlandÄ±!</h3>
                     <p id="successMessageText">Ailemize hoÅŸ geldiniz! Ãœyelik sÃ¶zleÅŸmeniz kulÃ¼bÃ¼mÃ¼ze baÅŸarÄ±yla ulaÅŸmÄ±ÅŸtÄ±r. En kÄ±sa sÃ¼rede sizinle iletiÅŸime geÃ§eceÄŸiz.</p>
                     <div class="iban-container" id="iban-container">
                        <!-- IBAN bilgileri dinamik olarak yÃ¼klenecek -->
                    </div>
                 </div>
            </form>
        </div>
    </div>

<script>
    // --- STATE MANAGEMENT ---
    let currentStep = 1;
    let totalSteps = 4;
    let currentPreRegistration = null;
    let allPreRegistrations = []; // Ã‡oklu kayÄ±t desteÄŸi iÃ§in
    let activeWebhooks = [];
    
    // --- DOM ELEMENTS ---
    const steps = document.querySelectorAll(".form-step");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const submitBtn = document.getElementById("submitBtn");
    const form = document.getElementById('membershipForm');

    // --- DYNAMIC CLUB ID & CONTRACT SYSTEM ---
    let realClubId = null; // URL'den Ã§Ã¶zÃ¼mlenecek gerÃ§ek Firebase club ID
    let clubData = null; // Firebase'den yÃ¼klenecek kulÃ¼p bilgisi
    let contractTemplate = ''; // Admin'den yÃ¼klenecek sÃ¶zleÅŸme ÅŸablonu
    let ibanData = null; // IBAN bilgileri
    let clubBranches = []; // KulÃ¼p branÅŸlarÄ±
    let branchPayments = null; // BranÅŸ bazlÄ± Ã¶deme bilgileri
    
    // URL-friendly slug oluÅŸtur
    function createSlug(text) {
        if (!text) return '';
        
        const trMap = {
            'Ã§': 'c', 'Ã‡': 'c',
            'ÄŸ': 'g', 'Ä': 'g',
            'Ä±': 'i', 'Ä°': 'i',
            'Ã¶': 'o', 'Ã–': 'o',
            'ÅŸ': 's', 'Å': 's',
            'Ã¼': 'u', 'Ãœ': 'u'
        };
        
        return text.split('').map(char => trMap[char] || char).join('')
            .toLowerCase()
            .replace(/[^a-z0-9]+/g, '')
            .replace(/^-+|-+$/g, '');
    }
    
    // URL'den club slug'Ä± al ve gerÃ§ek clubId'yi bul
    async function findClubBySlug() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const clubSlug = urlParams.get('club');
            
            if (!clubSlug) {
                throw new Error('URL\'de club parametresi bulunamadÄ±!');
            }
            
            console.log('ğŸ” Club slug:', clubSlug);
            
            // âœ… Supabase clubs tablosundan tÃ¼m kulÃ¼pleri Ã§ek
            const { data: clubsData, error: clubsError } = await window.supabase
                .from('clubs')
                .select('id, name, active');
            
            if (clubsError) {
                console.error('âŒ Clubs tablosu okuma hatasÄ±:', clubsError);
                throw clubsError;
            }
            
            // Active olan veya active kolonu olmayan kulÃ¼pleri filtrele
            const activeClubs = clubsData ? clubsData.filter(c => c.active !== false) : [];
            
            if (!activeClubs || activeClubs.length === 0) {
                throw new Error('HiÃ§ aktif kulÃ¼p bulunamadÄ±!');
            }
            
            // Her kulÃ¼bÃ¼n slug'Ä±nÄ± oluÅŸtur ve karÅŸÄ±laÅŸtÄ±r
            for (const club of activeClubs) {
                const docSlug = createSlug(club.name || '');
                console.log(`KarÅŸÄ±laÅŸtÄ±rma: "${docSlug}" === "${clubSlug}"`);
                
                if (docSlug === clubSlug) {
                    realClubId = club.id;
                    console.log('âœ… Club bulundu! ID:', realClubId, 'Name:', club.name);
                    return;
                }
            }
            
            console.error('âŒ KulÃ¼p bulunamadÄ±! Slug:', clubSlug);
            const availableClubs = activeClubs.map(c => ({ id: c.id, name: c.name, slug: createSlug(c.name) }));
            console.log('Mevcut kulÃ¼pler:', availableClubs);
            
            const clubList = availableClubs.map(c => `${c.name} (slug: ${c.slug})`).join(', ');
            throw new Error(`KulÃ¼p bulunamadÄ±: "${clubSlug}". Mevcut kulÃ¼pler: ${clubList}`);
        } catch (error) {
            console.error('âŒ Club slug Ã§Ã¶zÃ¼mleme hatasÄ±:', error);
            alert('KulÃ¼p bilgisi yÃ¼klenemedi. LÃ¼tfen doÄŸru linki kullandÄ±ÄŸÄ±nÄ±zdan emin olun.');
            throw error;
        }
    }
    
    // Club verilerini yÃ¼kle
    async function loadClubData() {
        if (!realClubId) return;
        
        try {
            // âœ… Supabase clubs tablosundan kulÃ¼p bilgilerini Ã§ek
            const { data: clubInfo, error: clubError } = await window.supabase
                .from('clubs')
                .select('*')
                .eq('id', realClubId)
                .single();
            
            if (clubError) {
                console.error('âŒ Club bilgisi okuma hatasÄ±:', clubError);
                throw clubError;
            }
            
            if (clubInfo) {
                clubData = {
                    name: clubInfo.name || 'Spor KulÃ¼bÃ¼',
                    officialName: clubInfo.name || 'Spor KulÃ¼bÃ¼',
                    contactName: clubInfo.adminName || '',
                    address: clubInfo.description || '',
                    taxNo: '',
                    phone: clubInfo.phone || '',
                    email: clubInfo.adminEmail || ''
                };
                
                // BaÅŸlÄ±ÄŸÄ± gÃ¼ncelle
                // BaÅŸlÄ±ÄŸÄ± burada ayarlama, loadContractTemplate'de ayarlanacak
                // (pageTitle varsa onu, yoksa clubData.name kullanÄ±lacak)
                
                console.log('âœ… Club data yÃ¼klendi:', clubData.name);
            } else {
                throw new Error('KulÃ¼p bulunamadÄ±: ' + realClubId);
            }
        } catch (error) {
            console.error('âŒ Club data yÃ¼kleme hatasÄ±:', error);
            throw error;
        }
    }
    
    // SÃ¶zleÅŸme ÅŸablonunu yÃ¼kle
    async function loadContractTemplate() {
        if (!realClubId) return;
        
        try {
            // âœ… 1) Supabase branches tablosundan bu kulÃ¼bÃ¼n branÅŸlarÄ±nÄ± yÃ¼kle
            console.log('ğŸ“¥ BranÅŸlar yÃ¼kleniyor (Supabase)... clubId:', realClubId);
            
            try {
                // Supabase'den branches tablosunu sorgula
                const { data: branchesData, error: branchesError } = await window.supabase
                    .from('branches')
                    .select('*')
                    .eq('clubId', realClubId)
                    .eq('isActive', true)
                    .order('branchName', { ascending: true });
                
                if (branchesError) {
                    console.error('âŒ Supabase branches yÃ¼kleme hatasÄ±:', branchesError);
                } else if (branchesData && branchesData.length > 0) {
                    clubBranches = branchesData.map(branch => ({
                        id: branch.branchId || branch.id,
                        name: branch.branchName,
                        icon: branch.icon || 'ğŸ†',
                        isActive: branch.isActive !== false,
                        color: branch.color || '#4CAF50'
                    }));
                    console.log('âœ… BranÅŸlar yÃ¼klendi (Supabase branches):', clubBranches);
                } else {
                    console.warn('âš ï¸ Supabase branches tablosunda branÅŸ bulunamadÄ±');
                }
                
                // BranÅŸ seÃ§im dropdown'unu doldur
                if (clubBranches.length > 0) {
                    populateBranchSelection();
                } else {
                    console.warn('âš ï¸ HiÃ§ aktif branÅŸ bulunamadÄ±!');
                }
            } catch (branchError) {
                console.error('âŒ BranÅŸ yÃ¼kleme hatasÄ±:', branchError);
            }
            
            // âœ… 2) Contract template'i yÃ¼kle
            const { data: contractData, error: contractError } = await window.supabase
                .from('settings')
                .select('*')
                .eq('id', `contract_${realClubId}`)
                .single();
            
            if (contractError && contractError.code !== 'PGRST116') {
                console.error('Contract template yÃ¼kleme hatasÄ±:', contractError);
            }
            
            if (contractData && contractData.enabled && contractData.text) {
                const data = contractData;
                window.contractTemplate = data.text;
                
                // Checkbox metinlerini ayarla
                if (data.checkbox1Text) {
                    const checkbox1Label = document.querySelector('label[for="agreeContract"]');
                    if (checkbox1Label) {
                        checkbox1Label.innerHTML = data.checkbox1Text;
                    }
                }
                
                if (data.checkbox2Text && data.checkbox2Text.trim()) {
                    const checkbox2Label = document.querySelector('label[for="cancellationPolicyNew"]');
                    if (checkbox2Label) {
                        checkbox2Label.innerHTML = data.checkbox2Text;
                    }
                } else {
                    // Ä°kinci checkbox boÅŸsa gizle
                    const checkbox2Container = document.querySelector('#cancellationPolicyNew').closest('.checkbox-group');
                    if (checkbox2Container) {
                        checkbox2Container.style.display = 'none';
                        // Required'Ä± kaldÄ±r
                        document.getElementById('cancellationPolicyNew').removeAttribute('required');
                    }
                }
                
                // âœ… Sayfa baÅŸlÄ±ÄŸÄ±nÄ± ayarla
                const clubNameHeader = document.getElementById('clubNameHeader');
                if (clubNameHeader) {
                    // pageTitle varsa onu kullan, yoksa clubData.name kullan
                    if (data.pageTitle && data.pageTitle.trim()) {
                        clubNameHeader.textContent = data.pageTitle;
                        console.log('âœ… Sayfa baÅŸlÄ±ÄŸÄ± ayarlandÄ± (pageTitle):', data.pageTitle);
                    } else if (clubData && clubData.name) {
                        clubNameHeader.textContent = clubData.name;
                        console.log('âœ… Sayfa baÅŸlÄ±ÄŸÄ± ayarlandÄ± (clubData.name):', clubData.name);
                    }
                }
                
                if (data.pageSubtitle && data.pageSubtitle.trim()) {
                    const clubSubtitleHeader = document.getElementById('clubSubtitleHeader');
                    if (clubSubtitleHeader) {
                        clubSubtitleHeader.textContent = data.pageSubtitle;
                    }
                }
                
                console.log('âœ… Contract template yÃ¼klendi:', window.contractTemplate.length, 'karakter');
                
                // âœ… IBAN/Ã–deme bilgilerini contract iÃ§inden yÃ¼kle
                if (data.branchPayments) {
                    ibanData = data.branchPayments;
                    branchPayments = data.branchPayments;
                    console.log('ğŸ’³ BranÅŸ bazlÄ± Ã¶deme bilgileri yÃ¼klendi:', Object.keys(ibanData));
                } else {
                    console.log('â„¹ï¸ Contract iÃ§inde branchPayments yok');
                    ibanData = {};
                }
            } else {
                console.log('â„¹ï¸ Custom contract template yok veya etkin deÄŸil, varsayÄ±lan kullanÄ±lacak');
                window.contractTemplate = null; // VarsayÄ±lan ÅŸablonun kullanÄ±lmasÄ± iÃ§in
                ibanData = {};
                
                // Contract template yoksa da baÅŸlÄ±ÄŸÄ± ayarla
                const clubNameHeader = document.getElementById('clubNameHeader');
                if (clubNameHeader && clubData && clubData.name) {
                    clubNameHeader.textContent = clubData.name;
                    console.log('âœ… Sayfa baÅŸlÄ±ÄŸÄ± ayarlandÄ± (clubData.name - default):', clubData.name);
                }
            }
        } catch (error) {
            console.error('âŒ Contract template yÃ¼kleme hatasÄ±:', error);
            ibanData = {};
            
            // Hata olsa bile baÅŸlÄ±ÄŸÄ± ayarla
            const clubNameHeader = document.getElementById('clubNameHeader');
            if (clubNameHeader && clubData && clubData.name) {
                clubNameHeader.textContent = clubData.name;
                console.log('âœ… Sayfa baÅŸlÄ±ÄŸÄ± ayarlandÄ± (clubData.name - fallback):', clubData.name);
            }
        }
    }
    
    // BranÅŸ seÃ§im dropdown'unu doldur
    function populateBranchSelection() {
        const branchSelect = document.getElementById('branchSelection');
        if (!branchSelect) {
            console.error('âŒ BranÅŸ seÃ§im elemanÄ± bulunamadÄ±!');
            return;
        }
        
        // Aktif branÅŸlarÄ± filtrele
        const activeBranches = clubBranches.filter(branch => branch.isActive !== false);
        
        // Mevcut seÃ§enekleri temizle
        branchSelect.innerHTML = '';
        
        // EÄŸer birden fazla branÅŸ varsa "SeÃ§iniz..." ekle
        if (activeBranches.length > 1) {
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'SeÃ§iniz...';
            branchSelect.appendChild(emptyOption);
        }
        
        // BranÅŸlarÄ± ekle
        if (activeBranches.length > 0) {
            activeBranches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.id;
                option.textContent = `${branch.icon || 'ğŸ†'} ${branch.name}`;
                branchSelect.appendChild(option);
            });
            
            // âœ… EÄŸer tek branÅŸ varsa otomatik seÃ§
            if (activeBranches.length === 1) {
                branchSelect.value = activeBranches[0].id;
                console.log('âœ… Tek branÅŸ otomatik seÃ§ildi:', activeBranches[0].name);
                
                // âœ… BranÅŸ seÃ§ildiÄŸinde attempt advance'i tetikle (telefon varsa)
                setTimeout(() => attemptAdvanceFromStep1(), 100);
            }
            
            console.log('âœ… BranÅŸ seÃ§enekleri eklendi:', activeBranches.length, 'aktif branÅŸ');
        } else {
            console.warn('âš ï¸ Aktif branÅŸ bulunamadÄ±!');
            // BranÅŸ yoksa uyarÄ± gÃ¶ster
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'HenÃ¼z branÅŸ tanÄ±mlanmamÄ±ÅŸ';
            emptyOption.disabled = true;
            branchSelect.appendChild(emptyOption);
        }
    }
    
    // BranÅŸa gÃ¶re IBAN bilgilerini gÃ¶ster
    function displayBranchIban(branchId) {
        console.log('ğŸ“Œ displayBranchIban Ã§aÄŸrÄ±ldÄ±:', {
            branchId: branchId,
            ibanData: ibanData,
            branchPayments: branchPayments,
            containerExists: !!document.getElementById('iban-container')
        });
        
        const container = document.getElementById('iban-container');
        if (!container) {
            console.error('âŒ IBAN container bulunamadÄ±!');
            return;
        }
        
        // BranÅŸ bilgisini bul
        const branch = clubBranches.find(b => b.id === branchId);
        const branchName = branch ? branch.name : branchId;
        const branchEmoji = branch ? branch.icon : 'ğŸ†';
        
        // Ã–deme bilgisini al (Ã¶nce branchPayments, sonra ibanData)
        const branchPayment = (branchPayments && branchPayments[branchId]) || (ibanData && ibanData[branchId]);
        
        console.log('ğŸ“Š Ã–deme Bilgisi Kontrol:', {
            branchId: branchId,
            branchName: branchName,
            ibanDataExists: !!ibanData,
            branchPaymentsExists: !!branchPayments,
            branchPaymentExists: !!branchPayment,
            branchPayment: branchPayment
        });
        
        // Admin panelinden kaydedilen yapÄ±: { name, iban, paymentInstructions }
        const hasIbanData = branchPayment && (branchPayment.iban || branchPayment.name);
        
        if (!hasIbanData) {
            console.warn('âš ï¸ Bu branÅŸ iÃ§in Ã¶deme bilgisi bulunamadÄ±');
            container.innerHTML = '<p style="color: #666; padding: 20px; text-align: center;">Bu branÅŸ iÃ§in Ã¶deme bilgisi tanÄ±mlanmamÄ±ÅŸ.</p>';
            return;
        }
        
        console.log('âœ… Ã–deme bilgileri gÃ¶steriliyor');
        
        let html = `<div class="iban-info" style="display: block; padding: 20px; background: #f8f9fa; border-radius: 8px;">
            <h4 style="color: #0066cc; margin-bottom: 15px;">${branchEmoji} ${branchName} - Ã–deme Bilgileri</h4>`;
        
        // Hesap Sahibi / Banka AdÄ± (admin panelinde "name" olarak kaydediliyor)
        if (branchPayment.name) {
                html += `
            <div class="iban-item" style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e0e0e0;">
                <span><strong>Hesap Sahibi / Banka:</strong> ${branchPayment.name}</span>
                <button type="button" class="btn-copy" onclick="copyToClipboard('${branchPayment.name}')" style="padding: 6px 12px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer;">Kopyala</button>
                </div>`;
            }
            
        // IBAN
        if (branchPayment.iban) {
            const ibanClean = branchPayment.iban.replace(/\s/g, '');
                    html += `
                    <div class="iban-item" style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 2px solid #0066cc;">
                <span class="iban-text" style="font-family: monospace; font-weight: bold; font-size: 15px;"><strong>IBAN:</strong> ${branchPayment.iban}</span>
                        <button type="button" class="btn-copy" onclick="copyToClipboard('${ibanClean}')" style="padding: 6px 12px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer;">Kopyala</button>
                    </div>`;
                }
            
        // Ã–deme TalimatlarÄ±
        if (branchPayment.paymentInstructions) {
                    html += `
            <div style="margin-top: 15px; padding: 12px; background: #e7f3ff; border-left: 3px solid #0066cc; border-radius: 4px;">
                <strong>Ã–deme TalimatlarÄ±:</strong><br>
                <span style="white-space: pre-line;">${branchPayment.paymentInstructions}</span>
                    </div>`;
        }
        
        html += '</div>';
        container.innerHTML = html;
    }
    
    // Placeholder deÄŸiÅŸtirme fonksiyonu
    function replacePlaceholders(template, data = {}, club = {}, paymentSchedule = []) {
        if (!template) return '';
        
        const formatDate = (dateStr) => {
            if (!dateStr) return '[Doldurulacak]';
            const date = new Date(dateStr);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        };
        
        // BugÃ¼nÃ¼n tarihini al
        const today = formatDate(new Date());
        
        let result = template;
        
        // âœ… KulÃ¼p bilgileri artÄ±k statik (placeholder deÄŸil), sadece Ã¼ye bilgileri dinamik
        // Ãœye bilgileri
        result = result.replace(/{UYE_AD_SOYAD}/g, data.Ad_Soyad || '[Doldurulacak]');
        result = result.replace(/{UYE_TCKN}/g, data.TC_Kimlik_No || '[Doldurulacak]');
        result = result.replace(/{UYE_DOGUM_TARIHI}/g, formatDate(data.Dogum_Tarihi));
        result = result.replace(/{UYE_TELEFON}/g, data.Telefon || '[Doldurulacak]');
        result = result.replace(/{UYE_ADRES}/g, data.Adres || '[Doldurulacak]');
        result = result.replace(/{BRANS}/g, data.Brans || '[Doldurulacak]');
        
        // Ã–ÄŸrenci bilgileri (eÄŸer varsa)
        if (data.allStudents && data.allStudents.length > 0) {
            result = result.replace(/{OGRENCI_AD_SOYAD}/g, data.allStudents[0].name || '[Doldurulacak]');
            result = result.replace(/{OGRENCI_DOGUM_TARIHI}/g, formatDate(data.allStudents[0].birthDate));
        } else {
            result = result.replace(/{OGRENCI_AD_SOYAD}/g, data.Ad_Soyad || '[Doldurulacak]');
            result = result.replace(/{OGRENCI_DOGUM_TARIHI}/g, formatDate(data.Dogum_Tarihi));
        }
        
        // Tarih
        result = result.replace(/{TARIH}/g, today);
        
        // Aidat Takvimi
        const paymentTable = generatePaymentTableForPdf(paymentSchedule);
        result = result.replace(/{AIDAT_TAKVIMI}/g, paymentTable);
        
        // Ã–ÄŸrenci Bilgileri (Ã‡ocuk kaydÄ± iÃ§in)
        let studentInfo = '';
        if (data.allStudents && data.allStudents.length > 0) {
            studentInfo = `<p><strong>ReÅŸit Olmayan Ã–ÄŸrenci Bilgileri:</strong><br>`;
            data.allStudents.forEach((student, index) => {
                studentInfo += `<br>${index + 1}. Ã–ÄŸrenci AdÄ± ve SoyadÄ±: ${student.name}<br>`;
                if (student.birthDate) {
                    studentInfo += `&nbsp;&nbsp;&nbsp;DoÄŸum Tarihi: ${formatDate(student.birthDate)}<br>`;
                }
            });
            studentInfo += `<br>Velisinin/Vasisinin AdÄ± ve SoyadÄ±: ${data.Ad_Soyad}`;
            if (data.Dogum_Tarihi) {
                studentInfo += `<br>Velinin DoÄŸum Tarihi: ${formatDate(data.Dogum_Tarihi)}`;
            }
            studentInfo += `</p>`;
        }
        result = result.replace(/{OGRENCI_BILGILERI}/g, studentInfo);
        
        return result;
    }
    
    // Sayfa yÃ¼klendiÄŸinde Ã§alÄ±ÅŸtÄ±r
    async function initializeApp() {
        try {
            console.log('ğŸš€ Uygulama baÅŸlatÄ±lÄ±yor...');
            await findClubBySlug();
            await loadClubData();
            await loadContractTemplate();
            console.log('âœ… Uygulama hazÄ±r!');
        } catch (error) {
            console.error('âŒ Uygulama baÅŸlatma hatasÄ±:', error);
            document.body.innerHTML = `
                <div style="text-align: center; padding: 50px;">
                    <h1 style="color: #dc2626;">âŒ Hata</h1>
                    <p>${error.message}</p>
                    <p>LÃ¼tfen doÄŸru linki kullandÄ±ÄŸÄ±nÄ±zdan emin olun.</p>
                </div>
            `;
        }
    }
    
    // Sayfa yÃ¼klenince baÅŸlat
    window.addEventListener('DOMContentLoaded', initializeApp);

    function generatePaymentTableForPdf(schedule) {
        if (!schedule || schedule.length === 0) return '';
        
        let tableHtml = `
        <p><strong>Aidat Takvimi:</strong></p>
        <table style="width: 100%; border-collapse: collapse; font-size: 8px; margin-top: 10px; page-break-inside: avoid;">
            <thead style="background-color: #f2f2f2;">
                <tr>
                    <th style="border: 1px solid #ddd; padding: 4px; text-align: left;">DÃ¶nem</th>
                    <th style="border: 1px solid #ddd; padding: 4px; text-align: left;">Tarih AralÄ±ÄŸÄ±</th>
                    <th style="border: 1px solid #ddd; padding: 4px; text-align: left;">Tutar</th>
                    <th style="border: 1px solid #ddd; padding: 4px; text-align: left;">Son Ã–deme</th>
                </tr>
            </thead>
            <tbody>
    `;

        schedule.forEach(p => {
            tableHtml += `
                <tr>
                    <td style="border: 1px solid #ddd; padding: 4px;">${p.paymentNumber}. Aidat</td>
                    <td style="border: 1px solid #ddd; padding: 4px;">${formatDate(p.period.start)} - ${formatDate(p.period.end)}</td>
                    <td style="border: 1px solid #ddd; padding: 4px;">${p.amount}â‚º</td>
                    <td style="border: 1px solid #ddd; padding: 4px;">${formatDate(p.dueDate)}</td>
                </tr>
            `;
        });

        tableHtml += `</tbody></table>`;
        return tableHtml;
    }
    
    const getContractSections = (club = {}, data = {}, schedule = []) => {
        // âœ… KulÃ¼p bilgileri iÃ§in default deÄŸerler
        const clubContactName = club.contactName || club.name || 'YÃ¶netici';
        const clubOfficialName = club.officialName || club.name || 'Spor KulÃ¼bÃ¼';
        const clubAddress = club.address || '';
        const clubTaxNo = club.taxNo || '';
        const clubPhone = club.phone || '0362 363 00 64';
        const clubEmail = club.email || '';
        
        const { Ad_Soyad = '[Doldurulacak]', Adres = '[Doldurulacak]', TC_Kimlik_No = '[Doldurulacak]', Telefon = '[Doldurulacak]', Dogum_Tarihi = '', Veli_2_Adi_Soyadi, Telefon_2, allStudents = [] } = data;
        // âœ… Ã‡ocuk kontrolÃ¼ - allStudents boÅŸ deÄŸilse VE ilk Ã¶ÄŸrencinin ismi ana isimden farklÄ±ysa Ã§ocuk
        const isChild = allStudents && allStudents.length > 0 && allStudents[0]?.name && allStudents[0].name !== Ad_Soyad;
        
        console.log('ğŸ“„ SÃ¶zleÅŸme oluÅŸturma:', {
            allStudentsCount: allStudents.length,
            firstStudentName: allStudents[0]?.name,
            mainName: Ad_Soyad,
            isChild: isChild
        });
        
        const veli2Info = Veli_2_Adi_Soyadi ? `
            <br><strong>B-VELÄ° 2</strong><br>
            AdÄ±-SoyadÄ± : ${Veli_2_Adi_Soyadi}<br>
            Telefon : ${Telefon_2 || '[Doldurulacak]'}<br>
        ` : '';
        
        const part1 = `<h4>ÃœYELÄ°K SÃ–ZLEÅMESÄ°</h4>
        <p><strong>1-) TARAFLAR</strong><br>
        <strong>A-KULÃœP</strong><br>
        AdÄ±-SoyadÄ± : ${clubContactName}<br>
        ÃœnvanÄ± : ${clubOfficialName}<br>
        ${clubAddress ? `Adres : ${clubAddress}<br>` : ''}
        ${clubTaxNo ? `Vergi No : ${clubTaxNo}<br>` : ''}
        Telefon : ${clubPhone}<br>
        ${clubEmail ? `E-mail : ${clubEmail}<br>` : ''}
        Bu sÃ¶zleÅŸmede bundan sonra "EÄÄ°TMEN/KULÃœP" olarak anÄ±lacaktÄ±r.<br>
        <strong>B-ÃœYE/VELÄ°</strong><br>
        AdÄ±-SoyadÄ± : ${Ad_Soyad}<br>
        ${Dogum_Tarihi ? `DoÄŸum Tarihi : ${formatDate(Dogum_Tarihi)}<br>` : ''}
        Adres : ${Adres}<br>
        TCKN : ${TC_Kimlik_No}<br>
        Telefon : ${Telefon}<br>
        ${veli2Info}
        Bu sÃ¶zleÅŸmede bundan sonra "ÃœYE/VELÄ°" olarak anÄ±lacaktÄ±r. Ãœye ve varsa veliye ait bilgiler yukarÄ±da yer alan kÄ±sma ayrÄ± ayrÄ± yazÄ±larak doldurulacaktÄ±r.</p>
        <p>Ãœye/Veli iÅŸbu sÃ¶zleÅŸmeyi onaylamasÄ± sÄ±rasÄ±nda EÄŸitmen tarafÄ±ndan kendisinden talep edilen her tÃ¼rlÃ¼ bilgiyi eksiksiz ve doÄŸru olarak EÄŸitmene vermeyi kabul etmektedir. Ãœye/Veli, eÄŸitimler sÄ±rasÄ±nda EÄŸitmene bildirdiÄŸi bilgilerin doÄŸruluÄŸundan bizzat sorumludur.</p>
        <p>Ãœye/Veli, iÅŸbu sÃ¶zleÅŸmeye onayÄ± esnasÄ±nda beyan etmiÅŸ olduÄŸu cep telefonu numarasÄ± ve e-posta adresinin EÄŸitmen tarafÄ±ndan yapÄ±lacak her tÃ¼rlÃ¼ bildirim iÃ§in geÃ§erli tebligat mecralarÄ± sayÄ±lacaÄŸÄ±nÄ±, bu cep telefonu numarasÄ± ve e-posta adresinin kullanÄ±mÄ± ile ilgili her tÃ¼rlÃ¼ yetkinin kendisinde olduÄŸunu, ilgili cep telefonu numarasÄ± ve e-posta adresinin 3. kiÅŸiler tarafÄ±ndan kullanÄ±ldÄ±ÄŸÄ± ÅŸÃ¼phesinin varlÄ±ÄŸÄ± halinde bu durumu ve her halde cep telefonu numarasÄ± ve e-posta adresinde meydana gelen deÄŸiÅŸiklikleri EÄŸitmene bildirmekle yÃ¼kÃ¼mlÃ¼ olduÄŸunu kabul ve taahhÃ¼t eder.</p>`;
        
        const part2 = `<p><strong>2-) KONU</strong><br>
        Ä°ÅŸbu Ã¼yelik sÃ¶zleÅŸmesi, Ã¼yelik iÅŸlemlerinin gerÃ§ekleÅŸtirilmesi ile iÅŸbu sÃ¶zleÅŸmenin onaylanmasÄ± suretiyle, EÄŸitmen tarafÄ±ndan sunulacak hizmetin ÅŸartlarÄ±nÄ± ve taraflarÄ±n karÅŸÄ±lÄ±klÄ± hak ve yÃ¼kÃ¼mlÃ¼lÃ¼klerini dÃ¼zenlemektedir.</p>
        <p><strong>3-) SÃœRE</strong><br>
        SÃ¶zleÅŸme sÃ¼resi aylÄ±k ve 6 aylÄ±k periyotlar halinde dÃ¼zenlenmekte olup; kayÄ±tlar sÃ¶zleÅŸmenin biteceÄŸi ayÄ±n 15'inden Ã¶nce iptal edilmediÄŸi takdirde aylÄ±k veya 6 aylÄ±k olarak uzatÄ±lmÄ±ÅŸ sayÄ±lmaktadÄ±r. KayÄ±t silinmediÄŸi takdirde yeni dÃ¶neme iliÅŸkin Ã¼cret Ãœye/Veli tarafÄ±ndan kulÃ¼be Ã¶denecektir.</p>
        <p><strong>4-) ÃœCRET</strong><br>
        Ãœyelik bedeli, Ãœyelik satÄ±ÅŸ formunda belirtilen Ã¼yelik paketine gÃ¶re .... Ay, aylÄ±k.. TL olup; iÅŸbu bedel Ãœye/Veli tarafÄ±ndan Ã¶denecektir.</p>
        <p><strong>5-) Ã–DEMELER</strong><br>
        Ã–demelerin her ayÄ±n 20'sine kadar belirtilen hesaba yapÄ±lmasÄ± gerekmektedir. DÃ¶nem tarihlerine gÃ¶re eksik ya da fazla Ã¶deme durumu oluÅŸabilir. Ã–demelerin zamanÄ±nda yapÄ±lmamasÄ± durumunda; Ãœye/Veli, yapacaÄŸÄ± Ã¶demenin %25'i tutarÄ±nda cezai ÅŸart Ã¶demeyi kabul ve taahhÃ¼t eder.</p>
        <p>YapÄ±lan Ã¶demeler, derslere katÄ±lÄ±m taahhÃ¼dÃ¼ olarak kabul edilir. Ãœyenin derslere katÄ±lamamasÄ± sebebiyle Ã¼cret iadesi yapÄ±lmaz.</p>
        <p><strong>6-) ÃœYELÄ°K Ä°PTALLERÄ°</strong><br>
        Her ayÄ±n 14'Ã¼ kayÄ±t sildirme iÃ§in son gÃ¼ndÃ¼r. Bu tarihler sonrasÄ±nda yapÄ±lan kayÄ±t sildirmelerde yeni dÃ¶nem Ã¼creti tahsil edilir. KulÃ¼be veya kulÃ¼p tesislerine zarar verici davranÄ±ÅŸlarda bulunulmasÄ± durumunda kulÃ¼p Ã¼yeliÄŸi sonlandÄ±rÄ±labilir.</p>
        ${generatePaymentTableForPdf(schedule)}`;

        const part3 = `<p>1) DaimÃ® HastalÄ±k<br>
        Ãœyenin, Ã¼yelik sÃ¼resi iÃ§erisinde derslere gelmesini veya derslerdeki aktivitelere katÄ±lmasÄ±nÄ± engelleyecek daimÃ® bir hastalÄ±ÄŸa tutulmasÄ± ve bu durumun tam teÅŸekkÃ¼llÃ¼ devlet hastanesinden alÄ±nmÄ±ÅŸ heyet raporu ile belgelenmesi halinde Ã¼yelik iptal edilir. Ãœyenin Ã¼yelik Ã¼cretinin tamamÄ±nÄ± Ã¶demiÅŸ olmasÄ± durumunda, kullanÄ±lmayan sÃ¼reye ait Ã¶denen Ã¼cretten %.10kesinti yapÄ±larak, kalan tutar faizsiz olarak Ãœye/Veliye iade edilir. KullanÄ±lan hizmet sÃ¼resinin bedeli iade olunmaz. Ãœye/Veli, bu madde gereÄŸince iÅŸlem yapÄ±labilmesi iÃ§in, hastalÄ±ÄŸa iliÅŸkin raporunu Ã¼st yazÄ± ile birlikte EÄŸitmene verecektir. HastalÄ±ÄŸa iliÅŸkin raporun, rapor tarihinden itibaren en geÃ§ 10 gÃ¼n iÃ§erisinde verilmesi gerekmektedir. GeÃ§ verilen rapor ve dileÃ§eler iÅŸlem gÃ¶rmeyecek, geÃ§ersiz kabul edilecektir.</p>
        <p>2) EÄŸitmenin Tek TaraflÄ± Fesih HakkÄ±<br>
        EÄŸitmen taraflar arasÄ±ndaki iÅŸbu sÃ¶zleÅŸmeyi her zaman 5 gÃ¼n Ã¶nceden bildirimde bulunmak kaydÄ±yla herhangi bir gerekÃ§e gÃ¶stermeksizin tek taraflÄ± olarak feshedebilir.</p>
        <p>Ãœye/Veli, iÅŸbu sÃ¶zleÅŸmeyi imzalayarak bu maddeyi peÅŸinen kabul etmiÅŸ sayÄ±lÄ±r. Bu durumda EÄŸitmen Ãœyenin kullanÄ±lmayan sÃ¼reye iliÅŸkin Ãœyelik Ã¼cretini Ã¶demiÅŸ olmasÄ± durumunda, Ã¶demiÅŸ olduÄŸu Ã¼creti faizsiz olarak 5 gÃ¼n iÃ§erisinde Ãœye/Veliye iade edecektir.</p>
        <p>AyrÄ±ca EÄŸitmen haklÄ± bir nedenin varlÄ±ÄŸÄ± halinde sÃ¶zleÅŸmeyi herhangi bir sÃ¼re olmaksÄ±zÄ±n derhal tek taraflÄ± olarak da feshedebilir. Bu durumda, Ã¼yenin Ã¼yelik Ã¼cretinin kullanÄ±lmayan kÄ±smÄ± iade edilmez.</p>
        <p><strong>7-) EÄÄ°TÄ°ME Ä°LÄ°ÅKÄ°N KURALLAR</strong><br>
        A) Ãœyelik ÅartlarÄ± ile Ãœye/Velinin Hak ve YÃ¼kÃ¼mlÃ¼lÃ¼kleri<br>
        1) EÄŸitmen, her tÃ¼rlÃ¼ Ã¼yelik talebini hiÃ§bir gerekÃ§e gÃ¶stermeksizin tek taraflÄ± olarak reddetme hakkÄ±na sahiptir.<br>
        2) EÄŸitmenden, suÃ§ iÅŸlememiÅŸ ve herhangi bir yÃ¼z kÄ±zartÄ±cÄ± suÃ§tan sabÄ±ka kaydÄ± bulunmayan T.C. vatandaÅŸlarÄ± ile yabancÄ± uyruklu kiÅŸiler ders alabilir. EÄŸitmenin bu hususa iliÅŸkin adli sicil belgesi (sabÄ±ka kaydÄ±) talep etme ve deÄŸerlendirme hakkÄ± saklÄ±dÄ±r.<br>
        3) EÄŸitmen Ãœye/Veliden, bulaÅŸÄ±cÄ± hastalÄ±klar gibi toplumu veya diÄŸer Ãœye/Velilerin saÄŸlÄ±ÄŸÄ±nÄ± tehlikeye dÃ¼ÅŸÃ¼rebilecek bir hastalÄ±ÄŸÄ±nÄ±n bulunmadÄ±ÄŸÄ±na dair saÄŸlÄ±k raporu ya da tahlil sonucu talep edebilir. SÃ¶z konusu tahliller sonucunda bulaÅŸÄ±cÄ± hastalÄ±k ve benzeri bir bulguya rastlanmasÄ± halinde EÄŸitmen, ÃœyeliÄŸi yapacaÄŸÄ± bir fesih bildirimi ile sona erdirme hakkÄ±na haizdir.</p>
        <p>4) Ãœye/Veli, Ã¼yelik iÃ§in gerekli olan her tÃ¼rlÃ¼ belgeyi eksiksiz ve doÄŸru bir ÅŸekilde temin edecek; Ã¼yelik onayÄ± iÃ§in ve/veya Ã¼yeliÄŸin devamÄ± sÄ±rasÄ±nda EÄŸitmen tarafÄ±ndan talep edilecek her tÃ¼rlÃ¼ bilgi, belge, rapor vb. hususlarÄ± derhal temin ederek EÄŸitmene ibraz edecektir.</p>
        <p>5) Ãœyelerin spor faaliyetine katÄ±lmak iÃ§in gerekli saÄŸlÄ±k ÅŸartlarÄ±nÄ± taÅŸÄ±yÄ±p taÅŸÄ±madÄ±klarÄ±, spor aktivitesine uygun olup olmadÄ±klarÄ±, tÄ±bbi kontrollerini yaptÄ±rÄ±p yaptÄ±rmadÄ±klarÄ± veya saÄŸlÄ±k danÄ±ÅŸmanlarÄ±nÄ±n yaptÄ±ÄŸÄ± tÄ±bbi tavsiyelerden ya da bunlarÄ±n neticelerinden dolayÄ± EÄŸitmenin herhangi bir sorumluluÄŸu bulunmamaktadÄ±r. Ãœye/Veli, Ã¼yelik sÃ¶zleÅŸmesini imzaladÄ±ÄŸÄ± andan itibaren; saÄŸlÄ±k durumunun spor yapmaya elveriÅŸli olduÄŸunu, spor faaliyetine katÄ±lmasÄ±na engel bir Ã¶zrÃ¼ ve rahatsÄ±zlÄ±ÄŸÄ±nÄ±n bulunmadÄ±ÄŸÄ±nÄ±, faaliyete katÄ±lmasÄ±nÄ±n saÄŸlÄ±ÄŸÄ±na ve fiziksel durumuna bir zarar vermeyeceÄŸini beyan ve taahhÃ¼t etmiÅŸtir.</p>`;
        
        const part4 = `<p>6) Ãœyelerin, ders veya aktivitelerden faydalanmamalarÄ± halinde dahi belirlenen bedelleri zamanÄ±nda ve tam olarak Ã¶demeleri zorunludur. Ãœyelerin yapÄ±lacak aktivitelerden veya verilecek derslerden yararlanmamalarÄ± hiÃ§bir ÅŸekil ve ÅŸartta Ãœye/Veliye Ã¼yelik bedelini Ã¶dememe hakkÄ± vermemektedir. Ãœye derslerden yararlanmasa dahi Ãœyelika bedellerini Ã¶demek zorundadÄ±r.</p>
        <p>7) Ãœye/Veli, kendisinin veya misafirlerinin ÅŸahsi kusurlarÄ±, dikkatsizliÄŸi veya ihmalleri ile; kulÃ¼be veya 3. KiÅŸilere ait eÅŸyalar Ã¼zerinde meydana getirecekleri tÃ¼m hasar ve zarardan ve yine diÄŸer Ãœye/Velilerin yahut EÄŸitmen Ã§alÄ±ÅŸanlarÄ±nÄ±n ve 3. kiÅŸilerin uÄŸramÄ±ÅŸ olduÄŸu tÃ¼m zarar ve kayÄ±plardan sorumludur.</p>
        <p>B) KULÃœP KURALLARI<br>
        a) Grup dersleri aylÄ±k 8 derstir.<br>
        b) Grup derslerinde ders bir kez iÅŸlendiÄŸinden, Ã¼yenin katÄ±lamadÄ±ÄŸÄ± dersler iÃ§in telafi yapÄ±lmaz.<br>
        c) Ã–zel ders paketleri 1 aylÄ±k sÃ¼reyle geÃ§erlidir. Bu sÃ¼re iÃ§inde kullanÄ±lmayan ders haklarÄ± bir sonraki aya devredilmez.<br>
        d) Spor branÅŸlarÄ±nda herhangi bir kaza, yaralanma veya saÄŸlÄ±k problemi durumunda sorumluluk tamamen Ãœye/Veliye aittir.<br>
        e) KayÄ±t sildirme iÅŸlemi yapÄ±ldÄ±ÄŸÄ±nda sistem Ã¼zerinden tÃ¼m kiÅŸisel verileriniz ve kayÄ±t bilgileriniz silinir.<br>
        f) Ãœyelerin derse zamanÄ±nda, uygun kÄ±yafetle ve hazÄ±r ÅŸekilde gelmesi Ãœye/Velilerin sorumluluÄŸundadÄ±r.<br>
        g) KayÄ±t silme talebinde bulunan Ã¶ÄŸrencinin kalan dersleri mevcut dÃ¶nem tarihleri iÃ§erisinde yapÄ±lÄ±r.</p>
        <p>C) GENEL KURALLAR<br>
        1) KulÃ¼p bÃ¼nyesinde Ãœye/Veliler genel nezaket kurallarÄ±na uymakla yÃ¼kÃ¼mlÃ¼dÃ¼rler. Kort iÃ§inde veya dÄ±ÅŸÄ±nda nezaket kurallarÄ±na uymayan davranÄ±ÅŸlarda bulunan, huzuru kaÃ§Ä±ran, hakaret, kÃ¼fÃ¼r kullanan Ãœye/Velilerin Ãœye/Velilikleri herhangi bir uyarÄ±ya gerek kalmadan resen iptal edilebilir. Bu takdirde Ãœye/Velilik bedelleri kÄ±smen dahi geri Ã¶denmez.<br>
        2) KayÄ±p eÅŸyalardan KulÃ¼p sorumlu deÄŸildir.<br>
        3) Ãœye/Veli ruhsatlÄ± bile olsa KulÃ¼p'e delici, kesici ve patlayÄ±cÄ± alet veya silahla giremez. Aksi hallerde Ãœye/Veli KulÃ¼p'e giremeyecektir.<br>
        4) Ãœye/Velinin KapalÄ± alanlarda ve KulÃ¼p tarafÄ±ndan yasaklanan alanlarda sigara iÃ§mesi kesinlikle yasaktÄ±r.<br>
        5) KulÃ¼p iÃ§ine dÄ±ÅŸarÄ±dan yiyecek iÃ§ecek getirmek yasaktÄ±r.<br>
        6) Soyunma odalarÄ±ndaki dolaplar gÃ¼nlÃ¼k kullanÄ±m iÃ§indir. Ãœye/Velinin tek dolap kullanÄ±m hakkÄ± vardÄ±r.<br>
        7) Ãœye/Veliler, tÃ¼m eÅŸyalarÄ±nÄ± dolap iÃ§ine koymalÄ±, dolap kapaklarÄ±na ve/veya dÄ±ÅŸÄ±na herhangi bir eÅŸya asmamalÄ± ve dolaplarÄ±nÄ± kilitlemelidirler. Dolaplar kullanÄ±m sonrasÄ± tamamen boÅŸaltÄ±lmalÄ±dÄ±r.<br>
        8) Dolap iÃ§inde cep telefonlarÄ± sessiz konumda bÄ±rakÄ±lmalÄ±dÄ±r.</p>
        <p>9) GÃ¼nlÃ¼k dolaplar kullanÄ±m sonrasÄ± boÅŸ ve aÃ§Ä±k olarak bÄ±rakÄ±lmalÄ±dÄ±r. KulÃ¼p, hijyen ve gÃ¼venlik nedenleri ile gÃ¼n sonunda kilitli dolaplarÄ± gÃ¶revli yÃ¶netici eÅŸliÄŸinde aÃ§ma ve iÃ§indeki eÅŸyalarÄ± boÅŸaltma hakkÄ±na sahiptir. Dolapta bÄ±rakÄ±lan eÅŸyanÄ±n kaybolmasÄ±ndan veya hasarÄ±ndan KulÃ¼p sorumlu tutulamaz.</p>
        <p>10) Soyunma odalarÄ±nda gÃ¶rÃ¼ntÃ¼/ses kaydÄ± yapÄ±lmasÄ± kesinlikle yasaktÄ±r. Aksi davranÄ±ÅŸta bulunanlarÄ±n tespiti halinde, KulÃ¼p tarafÄ±ndan her tÃ¼rlÃ¼ hak saklÄ± tutulmak kaydÄ± ile Ãœye/Velilik feshi hÃ¼kÃ¼mleri uygulanabilecektir. Ãœye/Veli, soyunma odalarÄ±nda gerÃ§ekleÅŸtirilen gÃ¶rÃ¼ntÃ¼/ses kaydÄ±nÄ±n sonuÃ§larÄ±ndan KulÃ¼p'Ã¼n hiÃ§bir sorumluluÄŸu olmadÄ±ÄŸÄ±nÄ± kabul, beyan ve taahhÃ¼t eder.</p>
        <p>11) Soyunma odalarÄ±nda Ã¶zel ve deÄŸerli eÅŸya bÄ±rakÄ±lmamalÄ±dÄ±r. BÄ±rakÄ±lan eÅŸyalarÄ±n kaybolmasÄ±ndan veya hasarÄ±ndan KulÃ¼p sorumlu tutulamaz.</p>`;

        const part5 = `<p>12) KulÃ¼p, sunduÄŸu hizmetler ve Ã§alÄ±ÅŸmalar ile ilgili kurallar ve uygulamalarda, zaman ve ihtiyaca baÄŸlÄ± deÄŸiÅŸiklikler yapabilir, yeni maddeler ilave edebilir. Olabilecek bÃ¼tÃ¼n deÄŸiÅŸiklikler Ãœye/Velilere bildirilir.</p>
        <p>13) Tesisin tÃ¼m alanlarÄ±nda Ãœye/Velilerin hijyeni, saÄŸlÄ±ÄŸÄ± ve gÃ¼venliÄŸi dÃ¼ÅŸÃ¼nÃ¼lerek hazÄ±rlanan prosedÃ¼r ve kullanÄ±m kurallarÄ±na uyulmasÄ± zorunludur.</p>
        <p>14) KulÃ¼p sÄ±nÄ±rlarÄ± iÃ§erisinde (aÃ§Ä±k ve kapalÄ± alan fark etmeksizin) sigara iÃ§mek yasaktÄ±r.</p>
        <p><strong>8- KÄ°ÅÄ°SEL VE Ã–ZEL NÄ°TELÄ°KLÄ° KÄ°ÅÄ°SEL VERÄ°LERÄ°N Ä°ÅLENMESÄ°</strong><br>
        Ãœye/Veli, iÅŸbu sÃ¶zleÅŸmeye taraf olma suretiyle, verdiÄŸi tÃ¼m bilgilerin ve/veya Ãœye/Velilik iliÅŸkisinin devamÄ±na herhangi bir suretle KulÃ¼p'e verdiÄŸi tÃ¼m kiÅŸisel bilgilerinin, saÄŸlÄ±k geÃ§miÅŸi bilgilerinin, Ãœye/Velilik sÃ¼resince elde edilen kiÅŸisel ve Ã¶zel nitelikli kiÅŸisel verilerinin, Ãœye/Velilik bedelinin Ã¶denmesiyle baÄŸlantÄ±lÄ± olarak elektronik ve diÄŸer ortamlarda verilen/verilecek bilgilerin, "Veri Sorumlusu" sÄ±fatÄ±yla KulÃ¼p tarafÄ±ndan ve KulÃ¼p ortaklarÄ±, iÅŸ ortaklarÄ±, halefleri ve/veya bunlarÄ±n belirleyeceÄŸi Ã¼Ã§Ã¼ncÃ¼ kiÅŸiler tarafÄ±ndan, mezkur verilerin gizliliklerinin korunmasÄ± iÃ§in gerekli tedbirleri almak ve kiÅŸisel verilerin iÅŸlenmesine dair kanuni ilkelere uymak suretiyle otomatik olan/olmayan yÃ¶ntemler ile alÄ±nmasÄ±na, devralÄ±nmasÄ±na, yasal sÃ¼reler aÅŸÄ±lmamak Ã¼zere yurt iÃ§inde ve/veya yurt dÄ±ÅŸÄ±nda yazÄ±lÄ±/dijital arÅŸivlere kaydedilmesine, depolanmasÄ±na, muhafaza edilmesine, elde edilebilir hale getirilmesine, kullanÄ±lmasÄ±na, gÃ¼ncellenmesine, deÄŸiÅŸtirilmesine, yeniden dÃ¼zenlenmesine, sÄ±nÄ±flandÄ±rÄ±lmasÄ±na, yurt iÃ§inde veya yurt dÄ±ÅŸÄ±na aktarÄ±lmasÄ±na ve sair kanunlara uygun ÅŸekilde herhangi bir suretle iÅŸlenmesine, bu hususta KulÃ¼p tarafÄ±ndan Ã§eÅŸitli mecralar Ã¼zerinden aydÄ±nlatÄ±lmÄ±ÅŸ ve yasal haklarÄ± hakkÄ±nda bilgilindirilmiÅŸ olarak aÃ§Ä±kÃ§a izin(rÄ±za/onay) verdiÄŸini kabul, beyan ve taahhÃ¼t eder.</p>
        <p>1. Veri Sorumlusu:<br>${clubContactName}<br>${clubAddress || 'Adres bilgisi yok'}<br>${clubPhone}<br>${clubEmail || 'E-posta bilgisi yok'}</p>
        <p>2. KiÅŸisel Verilerin Ä°ÅŸlenme AmaÃ§larÄ±:<br>KiÅŸisel verileriniz; Ãœye/Velilik iÅŸlemleri, spor etkinliklerine katÄ±lÄ±m yÃ¶netimi, iletiÅŸim faaliyetleri, gÃ¼venlik kayÄ±tlarÄ±nÄ±n tutulmasÄ±, kulÃ¼p iÃ§i bilgilendirme ve organizasyon amaÃ§larÄ±yla iÅŸlenmektedir. AyrÄ±ca yasal yÃ¼kÃ¼mlÃ¼lÃ¼klerimizi yerine getirmek, hukuki taleplere yanÄ±t vermek ve sizinle iletiÅŸim kurmak amacÄ±yla da kullanÄ±lmaktadÄ±r.</p>
        <p>3. Toplanan KiÅŸisel Veriler:<br>Ad, soyad, iletiÅŸim bilgileri, doÄŸum tarihi, spor etkinliklerine iliÅŸkin bilgiler gibi kiÅŸisel veriler toplanmaktadÄ±r.</p>
        <p>4. KiÅŸisel Verilerin Ä°ÅŸlenme Hukuki Sebepleri:<br>Verileriniz, KVKK'nÄ±n 5. ve 6. maddeleri kapsamÄ±nda; aÃ§Ä±k rÄ±za, sÃ¶zleÅŸmenin kurulmasÄ± veya ifasÄ±, yasal yÃ¼kÃ¼mlÃ¼lÃ¼klerin yerine getirilmesi, haklarÄ±n tesisi, kullanÄ±lmasÄ± veya korunmasÄ± gibi hukuki sebepler doÄŸrÄŸultusunda iÅŸlenmektedir.</p>
        <p>5. KiÅŸisel Verilerin Saklama SÃ¼resi:<br>KiÅŸisel verileriniz, iÅŸlenme amacÄ±nÄ±n gerektirdiÄŸi sÃ¼re boyunca saklanacak, bu sÃ¼renin sonunda silinecek veya anonim hale getirilecektir.</p>
        <p>6. KiÅŸisel Veri Sahiplerinin HaklarÄ±:<br>KVKK uyarÄ±nca veri sahipleri;<br>â€¢ KiÅŸisel verilerinin iÅŸlenip iÅŸlenmediÄŸini Ã¶ÄŸrenme,<br>â€¢ Ä°ÅŸlenmiÅŸse buna iliÅŸkin bilgi talep etme,<br>â€¢ Ä°ÅŸleme amacÄ±nÄ± ve amaca uygun kullanÄ±lÄ±p kullanÄ±lmadÄ±ÄŸÄ±nÄ± Ã¶ÄŸrenme,<br>â€¢ Verilerin aktarÄ±ldÄ±ÄŸÄ± Ã¼Ã§Ã¼ncÃ¼ kiÅŸileri bilme,<br>â€¢ Eksik veya yanlÄ±ÅŸ iÅŸlenmiÅŸ verilerin dÃ¼zeltilmesini isteme,<br>â€¢ Verilerin silinmesini veya yok edilmesini talep etme,<br>â€¢ Bu iÅŸlemlerin Ã¼Ã§Ã¼ncÃ¼ kiÅŸilere bildirilmesini isteme,<br>â€¢ Otomatik sistemlerle analiz sonucu aleyhe Ã§Ä±kan sonuÃ§lara itraz etme hakkÄ±na sahiptir.</p>`;
        
        const part6 = `<p><strong>9-) SON HÃœKÃœMLER</strong><br>
        1) Bu anlaÅŸmanÄ±n uygulanmasÄ±ndan kaynaklanan tÃ¼m ihtilaflarda Samsun mahkemeleri ve icra daireleri yetkilidir.</p>
        <p>2) TaraflarÄ±n sÃ¶zleÅŸmenin giriÅŸinde unvanlarÄ± altÄ±nda adresler sÃ¶zleÅŸme uyarÄ±nca kanuni tebligat adresleri olarak kabul edilecek ve bu adreslere yapÄ±lan tebligatlar kendilerine yapÄ±lmÄ±ÅŸ sayÄ±lacaktÄ±r. Taraflardan biri adresinde meydana gelen deÄŸiÅŸikliÄŸi 5 (beÅŸ) gÃ¼n iÃ§erisinde diÄŸer tarafa bildirmediÄŸi takdirde yukarÄ±daki yer alan adreslere Tebligat Kanunu hÃ¼kÃ¼mleri dahilinde yapÄ±lacak ihbar ve tebligat muteber olacaktÄ±r.</p>
        <p>3)Ãœye/Veli, cep telefonu ve/veya e-mail adres deÄŸiÅŸikliÄŸini yazÄ±lÄ± olarak EÄŸitmene bildirmediÄŸi takdirde, bildirmiÅŸ olduÄŸu cep telefonu ve/veya e-posta adresine yapÄ±lacak bildirimlerin geÃ§erli olacaÄŸÄ±nÄ± ve kendisine tebligatÄ±n yapÄ±lmÄ±ÅŸ sayÄ±lacaÄŸÄ±nÄ± kabul, beyan ve taahhÃ¼t eder. Ä°ÅŸbu Ã¼yelik nedeniyle yapÄ±lacak her tÃ¼rlÃ¼ bildirim, sÃ¶zleÅŸmenin kabulÃ¼ sÄ±rasÄ±nda, Ã¼ye tarafÄ±ndan bildirilen cep telefonu ve/veya e posta adresine gÃ¶nderilecek mesaj aracÄ±lÄ±ÄŸÄ± ile saÄŸlanacaktÄ±r.</p>
        <p>ÃœYE/VELÄ° EÄÄ°TMEN<br>
        -ReÅŸit olmayan katÄ±lÄ±mcÄ±larÄ±n velileri veya vasileri iÃ§in Ãœye, iÅŸbu belge ile aÅŸaÄŸÄ±da adÄ± geÃ§en katÄ±lÄ±mcÄ±(lar) iÃ§in yasal sorumluluÄŸu olan bir veli/vasi olarak, yukarÄ±da belirtilen ÅŸekilde ÅŸahsÄ±n ibrasÄ±na muvafakat ettiÄŸini ve ibrayÄ± kabul ettiÄŸini beyan eder. YaÅŸÄ± kÃ¼Ã§Ã¼k Ã§ocuÄŸunun/Ã§ocuklarÄ±nÄ±n saÄŸlanan programlara katÄ±lÄ±mÄ± veya programlarla iliÅŸkisi nedeniyle meydana gelen her tÃ¼rlÃ¼ sorumluluk doÄŸuran olaylardan dolayÄ± KulÃ¼p'Ã¼, sahibini, ortaklarÄ±nÄ± ve Ã§alÄ±ÅŸanlarÄ±nÄ± sorumlu tutmayacaÄŸÄ±nÄ± taahhÃ¼t eder.</p>
        ${isChild ? `<p><strong>ReÅŸit Olmayan Ã–ÄŸrenci Bilgileri:</strong><br>
        ${allStudents.map((student, index) => `
            <br>${index + 1}. Ã–ÄŸrenci AdÄ± ve SoyadÄ±: ${student.name}<br>
            ${student.birthDate ? `&nbsp;&nbsp;&nbsp;DoÄŸum Tarihi: ${formatDate(student.birthDate)}<br>` : ''}
        `).join('')}
        <br>Velisinin/Vasisinin AdÄ± ve SoyadÄ±: ${data.Ad_Soyad}
        ${data.Dogum_Tarihi ? `<br>Velinin DoÄŸum Tarihi: ${formatDate(data.Dogum_Tarihi)}` : ''}</p>` : ''}`;

        return [part1, part2, part3, part4, part5, part6];
    };


    // --- FORM NAVIGATION ---
    const updateProgressBar = () => {
        const progressSteps = document.querySelectorAll('.progress-step');
        const progressLine = document.getElementById('progress-line');
        progressSteps.forEach((step, index) => {
            step.classList.toggle('active', index < currentStep);
        });
        progressLine.style.width = `${((currentStep - 1) / (totalSteps - 1)) * 100}%`;
    };

    const showStep = (stepNumber) => {
        steps.forEach(step => step.classList.remove('active'));
        document.getElementById(`step-${stepNumber}`).classList.add('active');
        currentStep = stepNumber;
        updateProgressBar();
        
        prevBtn.style.display = currentStep > 1 ? 'inline-flex' : 'none';
        nextBtn.style.display = currentStep < totalSteps ? 'inline-flex' : 'none';
        submitBtn.style.display = currentStep === totalSteps ? 'inline-flex' : 'none';
    };
    
    // --- ADVANCE LOGIC ---
    async function attemptAdvanceFromStep1() {
        if (nextBtn.disabled) return; 

        const phoneInput = document.getElementById('phone');
        const phone = phoneInput.value;
        const branch = document.getElementById('branchSelection').value;
        
        if (phone.length !== 11 || !branch) {
            return; 
        }
        
        const phoneRegex = /^0[0-9]{10}$/;
        if (!phoneRegex.test(phone)) {
            return showAlert(phoneInput.title, 'danger', 'step-1');
        }

        nextBtn.disabled = true;
        nextBtn.textContent = 'Kontrol ediliyor...';
        try {
            const found = await checkPreRegistration(branch, phone);
            if (found) {
                showStep(currentStep + 1);
            }
        } finally {
            nextBtn.disabled = false;
            nextBtn.textContent = 'Ä°leri';
        }
    }

    document.getElementById('phone').addEventListener('input', function (e) {
        e.target.value = e.target.value.replace(/\D/g, '');
        attemptAdvanceFromStep1();
    });

    document.getElementById('branchSelection').addEventListener('change', attemptAdvanceFromStep1);

    nextBtn.addEventListener("click", async () => {
        if (currentStep === 1) {
            const phoneInput = document.getElementById('phone');
            const phone = phoneInput.value;
            const branch = document.getElementById('branchSelection').value;
            if (!branch || !phone) {
                return showAlert('LÃ¼tfen branÅŸ seÃ§in ve telefon numaranÄ±zÄ± girin.', 'danger', 'step-1');
            }
            await attemptAdvanceFromStep1();
        } else if (currentStep === 3) {
             // TC, Adres ve DoÄŸum Tarihi kontrolÃ¼ (hem Ã§ocuk hem yetiÅŸkin iÃ§in)
             const tcno = document.getElementById('tcno').value.trim();
             const address = document.getElementById('address').value.trim();
             const birthDate = document.getElementById('birthDate').value.trim();
             
             if(!tcno) {
                  return showModalAlert('âš ï¸ T.C. Kimlik NumarasÄ± Gerekli', 'T.C. Kimlik NumarasÄ± alanÄ± zorunludur. LÃ¼tfen doldurun.');
             }
             if(tcno.length !== 11 || !/^\d{11}$/.test(tcno)) {
                  return showModalAlert('âš ï¸ GeÃ§ersiz T.C. Kimlik No', 'T.C. Kimlik NumarasÄ± 11 haneli olmalÄ± ve sadece rakamlardan oluÅŸmalÄ±dÄ±r.');
             }
             if(!birthDate) {
                  return showModalAlert('âš ï¸ DoÄŸum Tarihi Gerekli', 'Ãœye doÄŸum tarihi alanÄ± zorunludur. LÃ¼tfen doldurun.');
             }
             // âœ… DoÄŸum tarihi geÃ§erlilik kontrolÃ¼
             const birthDateObj = new Date(birthDate);
             const today = new Date();
             const minDate = new Date('1900-01-01');
             if (birthDateObj > today || birthDateObj < minDate) {
                  return showModalAlert('âš ï¸ GeÃ§ersiz DoÄŸum Tarihi', 'GeÃ§erli bir doÄŸum tarihi giriniz.');
             }
             if(!address) {
                  return showModalAlert('âš ï¸ Adres Gerekli', 'Adres alanÄ± zorunludur. LÃ¼tfen doldurun.');
             }
             
             // âœ… Ã‡ocuk kaydÄ± ise Ã¶ÄŸrenci TC kontrolÃ¼
             const isChildRegistration = document.getElementById('membership-type').value === 'child';
             if (isChildRegistration) {
                 const minorTc = document.getElementById('minorTc')?.value.trim();
                 if (!minorTc) {
                     return showModalAlert('âš ï¸ Ã–ÄŸrenci TC Gerekli', 'Ã–ÄŸrenci TC Kimlik NumarasÄ± alanÄ± zorunludur. LÃ¼tfen doldurun.');
                 }
                 if (minorTc.length !== 11 || !/^\d{11}$/.test(minorTc)) {
                     return showModalAlert('âš ï¸ GeÃ§ersiz Ã–ÄŸrenci TC', 'Ã–ÄŸrenci TC Kimlik NumarasÄ± 11 haneli olmalÄ± ve sadece rakamlardan oluÅŸmalÄ±dÄ±r.');
                 }
             }
             
             // âœ… Ã‡oklu Ã§ocuk kayÄ±tlarÄ±nda her Ã¶ÄŸrenci iÃ§in TC kontrolÃ¼
             const studentTcFields = document.querySelectorAll('.student-tc-field');
             for (const field of studentTcFields) {
                 const tcValue = field.value.trim();
                 if (!tcValue) {
                     const studentName = field.dataset.studentName || 'Ã–ÄŸrenci';
                     return showModalAlert('âš ï¸ Ã–ÄŸrenci TC Gerekli', `"${studentName}" iÃ§in TC Kimlik NumarasÄ± alanÄ± boÅŸ. LÃ¼tfen doldurun.`);
                 }
                 if (tcValue.length !== 11 || !/^\d{11}$/.test(tcValue)) {
                     const studentName = field.dataset.studentName || 'Ã–ÄŸrenci';
                     return showModalAlert('âš ï¸ GeÃ§ersiz TC Kimlik No', `"${studentName}" iÃ§in TC Kimlik NumarasÄ± 11 haneli olmalÄ± ve sadece rakamlardan oluÅŸmalÄ±dÄ±r.`);
                 }
             }
             
             // âœ… Ã‡ocuk Ã¶ÄŸrenci doÄŸum tarihi kontrolÃ¼
             const studentBirthdateFields = document.querySelectorAll('.student-birthdate-field');
             for (const field of studentBirthdateFields) {
                 if (!field.value || field.value.trim() === '') {
                     const studentName = field.dataset.studentName || 'Ã–ÄŸrenci';
                     return showModalAlert('âš ï¸ Ã–ÄŸrenci DoÄŸum Tarihi Gerekli', `"${studentName}" iÃ§in doÄŸum tarihi alanÄ± boÅŸ. LÃ¼tfen Ã¶ÄŸrencinin doÄŸum tarihini doldurun.`);
                 }
                 // âœ… Ã–ÄŸrenci doÄŸum tarihi geÃ§erlilik kontrolÃ¼
                 const studentBirthDateObj = new Date(field.value);
                 if (studentBirthDateObj > today || studentBirthDateObj < minDate) {
                     const studentName = field.dataset.studentName || 'Ã–ÄŸrenci';
                     return showModalAlert('âš ï¸ GeÃ§ersiz DoÄŸum Tarihi', `"${studentName}" iÃ§in geÃ§erli bir doÄŸum tarihi giriniz.`);
                 }
             }
             
             populateContractText();
             showStep(currentStep + 1);
        } else if (currentStep < totalSteps) {
            showStep(currentStep + 1);
        }
    });

    prevBtn.addEventListener("click", () => {
        if (currentStep > 1) showStep(currentStep - 1);
    });

    // --- PRE-REGISTRATION LOGIC ---
    async function checkPreRegistration(branch, phone) {
        const notFoundDiv = document.getElementById('pre-reg-not-found');
        
        try {
            // Normalize phone number for better matching
            let normalizedPhone = phone.replace(/\s/g, '').replace(/\D/g, '');
            if (normalizedPhone.startsWith('0')) {
                normalizedPhone = normalizedPhone.substring(1);
            }
            if (!normalizedPhone.startsWith('90')) {
                normalizedPhone = '90' + normalizedPhone;
            }
            
            // Try multiple phone formats for compatibility
            const phoneFormats = [phone, normalizedPhone, normalizedPhone.substring(2)];
            
            console.log('AranÄ±yor:', phoneFormats, 'Club ID:', realClubId);
            
            if (!realClubId) {
                alert('KulÃ¼p bilgisi yÃ¼klenemedi. LÃ¼tfen sayfayÄ± yenileyin.');
                return false;
            }
            
            let matchingData = null;
            for (const phoneFormat of phoneFormats) {
                const { data, error } = await window.supabase
                    .from('preRegistrations')
                    .select('*')
                    .eq('clubId', realClubId)
                    .eq('phone', phoneFormat);
                
                if (error) {
                    console.error('Supabase query error:', error);
                    continue;
                }
                
                if (data && data.length > 0) {
                    matchingData = data;
                    console.log('Bulundu:', phoneFormat);
                    break;
                }
            }

            if (!matchingData || matchingData.length === 0) {
                notFoundDiv.style.display = 'block';
                currentPreRegistration = null;
                return false;
            }

            // âœ… TÃ¼m matching kayÄ±tlarÄ± topla (Ã§oklu Ã§ocuk desteÄŸi iÃ§in)
            const matchingRecords = matchingData.filter(record => {
                return record.branch === branch && record.status === 'pending_contract';
            });

            if (matchingRecords.length === 0) {
                // DoÄŸru branÅŸta kayÄ±t bulunamadÄ±, ancak baÅŸka bir branÅŸta kayÄ±t var mÄ± kontrol et
                const otherBranchRecord = matchingData.find(record => record.status === 'pending_contract');
                if (otherBranchRecord) {
                    const correctBranchName = otherBranchRecord.branch === 'tenis' ? 'Tenis' : 'YÃ¼zme';
                    const icon = correctBranchName === 'Tenis' ? 'ğŸ¾' : 'ğŸŠ';
                    showAlert(`Bu telefon numarasÄ± ile ${icon} ${correctBranchName} branÅŸÄ±nda bir Ã¶n kayÄ±t bulundu. LÃ¼tfen doÄŸru branÅŸÄ± seÃ§erek devam edin.`, 'danger', 'step-1');
                } else {
                    // Bu telefon numarasÄ± iÃ§in bekleyen bir sÃ¶zleÅŸme yok.
                    notFoundDiv.style.display = 'block';
                }
                currentPreRegistration = null;
                allPreRegistrations = [];
                return false;
            }
            
            // Force refresh - always get latest data for all registrations
            allPreRegistrations = matchingRecords;
            currentPreRegistration = allPreRegistrations[0]; // Ä°lk kaydÄ± ana kayÄ±t olarak kullan
            
            // Log for debugging
            console.log('âœ… KayÄ±t bulundu:', {
                id: currentPreRegistration.id,
                phone: currentPreRegistration.phone,
                branch: currentPreRegistration.branch,
                paymentCount: currentPreRegistration.paymentSchedule?.length || 0
            });
            
            if (currentPreRegistration.paymentSchedule) {
                console.log('ğŸ“‹ Ã–deme PlanÄ±:', currentPreRegistration.paymentSchedule.length, 'taksit');
            }
            
            // Load webhooks for this club
            if (currentPreRegistration.clubId) {
                await loadActiveWebhooks(currentPreRegistration.clubId);
                
                // âœ… KulÃ¼p bilgilerini yÃ¼kle (PDF ve IBAN iÃ§in gerekli)
                if (!clubData) {
                    try {
                        const { data: club, error: clubError } = await window.supabase
                            .from('clubs')
                            .select('*')
                            .eq('id', currentPreRegistration.clubId)
                            .single();
                        
                        if (clubError) {
                            console.error('KulÃ¼p bilgisi yÃ¼kleme hatasÄ±:', clubError);
                        } else if (club) {
                            clubData = club;
                            console.log('âœ… KulÃ¼p bilgileri yÃ¼klendi:', clubData.name);
                        } else {
                            console.warn('âš ï¸ KulÃ¼p bilgisi bulunamadÄ±');
                        }
                        
                        // âœ… IBAN ve SÃ¶zleÅŸme ÅŸablonunu yÃ¼kle (settings'den)
                        console.log('ğŸ” Settings yÃ¼kleniyor, clubId:', currentPreRegistration.clubId);
                        const { data: settings, error: settingsError } = await window.supabase
                            .from('settings')
                            .select('*')
                            .eq('id', `club_${currentPreRegistration.clubId}`)
                            .single();
                        
                        console.log('ğŸ“„ Settings exists:', !!settings);
                        if (settingsError && settingsError.code !== 'PGRST116') {
                            console.error('Settings yÃ¼kleme hatasÄ±:', settingsError);
                        } else if (settings) {
                            console.log('âš™ï¸ Settings verisi:', settings);
                            if (settings.iban) {
                                ibanData = settings.iban;
                                console.log('âœ… IBAN bilgileri yÃ¼klendi:', ibanData);
                            } else {
                                console.warn('âš ï¸ settings.iban yok');
                            }
                            // âœ… SÃ¶zleÅŸme ÅŸablonunu yÃ¼kle
                            if (settings.contractTemplate) {
                                window.contractTemplate = settings.contractTemplate;
                                console.log('âœ… SÃ¶zleÅŸme ÅŸablonu yÃ¼klendi');
                            } else {
                                console.log('â„¹ï¸ SÃ¶zleÅŸme ÅŸablonu bulunamadÄ±, varsayÄ±lan kullanÄ±lacak');
                            }
                        } else {
                            console.warn('âš ï¸ Settings dokÃ¼manÄ± bulunamadÄ±');
                        }
                    } catch (error) {
                        console.error('âŒ KulÃ¼p/IBAN bilgisi yÃ¼klenirken hata:', error);
                    }
                }
            } else {
                console.warn('âš ï¸ clubId bulunamadÄ±, webhook yÃ¼klenemedi');
            }
            
            notFoundDiv.style.display = 'none';
            populateFormWithPreRegData();
            return true;

        } catch (error) {
            console.error("Error checking pre-registration:", error);
            showAlert("KayÄ±t kontrol edilirken bir hata oluÅŸtu. LÃ¼tfen daha sonra tekrar deneyin.", "danger", "step-1");
            return false;
        }
    }

    function populateFormWithPreRegData() {
        const preReg = currentPreRegistration;
        const club = clubData[preReg.branch] || { name: 'Atakum Tenis KulÃ¼bÃ¼ - Mafen Spor KulÃ¼bÃ¼' };
        document.getElementById('clubNameHeader').textContent = club.name;
        document.getElementById('paymentPlanContainer').style.display = 'block';
        
        // âœ… Ã‡oklu Ã§ocuk desteÄŸi - tÃ¼m kayÄ±tlarÄ± sayfalandÄ±rarak gÃ¶ster
        if (allPreRegistrations.length > 1) {
            document.getElementById('paymentPlanContainer').innerHTML = generateMultiplePaymentPlanHtml(allPreRegistrations);
        } else {
            document.getElementById('paymentPlanContainer').innerHTML = generatePaymentPlanHtml(preReg);
        }
        
        // âœ… Ã‡ocuk kontrolÃ¼ - hem parentName hem studentName olmalÄ±
        const isChild = !!(preReg.parentName && preReg.studentName && preReg.parentName !== preReg.studentName);
        document.getElementById('fullName').value = preReg.parentName || preReg.studentName;
        
        const minorFieldsDiv = document.getElementById('minorFields');
        const parentName2Input = document.getElementById('parentName2');
        const phone2Input = document.getElementById('phone2');
        const step3Title = document.getElementById('step3Title');
        const fullNameLabel = document.getElementById('fullNameLabel');
        
        console.log('ğŸ” KayÄ±t tipi kontrolÃ¼:', {
            parentName: preReg.parentName,
            studentName: preReg.studentName,
            isChild: isChild,
            allPreRegistrationsCount: allPreRegistrations.length
        });
        
        const birthDateLabel = document.getElementById('birthDateLabel');
        
        if (isChild) {
            // Ã‡ocuk kaydÄ± - veli bilgileri
            step3Title.textContent = 'KiÅŸisel Bilgiler (Veli)';
            fullNameLabel.textContent = 'Veli Ad Soyad *';
            birthDateLabel.textContent = 'Veli DoÄŸum Tarihi *';
            minorFieldsDiv.style.display = 'block';
            
            // âœ… Ã‡oklu Ã§ocuk desteÄŸi - tÃ¼m Ã¶ÄŸrencileri gÃ¶ster
            const studentsList = document.createElement('div');
            studentsList.innerHTML = '<h4 class="section-title" style="font-size: 1.2em; margin-bottom: 15px; text-align: left;">ğŸ‘¶ Ã–ÄŸrenci Bilgileri</h4>';
            
            allPreRegistrations.forEach((reg, index) => {
                const studentDiv = document.createElement('div');
                studentDiv.className = 'form-grid';
                studentDiv.style.cssText = 'background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;';
                // âœ… Tarihi yyyy-MM-dd formatÄ±na Ã§evir
                const formattedBirthDate = reg.studentBirthDate ? reg.studentBirthDate.split('T')[0] : '';
                
                studentDiv.innerHTML = `
                    <div class="form-group">
                        <label>Ã–ÄŸrenci ${index + 1} AdÄ± SoyadÄ± *</label>
                        <input type="text" class="form-control" value="${reg.studentName}" readonly>
                    </div>
                    <div class="form-group">
                        <label>ğŸ†” TC Kimlik No *</label>
                        <input type="text" class="form-control student-tc-field" value="${reg.studentTc || ''}" pattern="[0-9]{11}" maxlength="11" placeholder="11 haneli TC" data-student-name="${reg.studentName}">
                    </div>
                    <div class="form-group">
                        <label>DoÄŸum Tarihi *</label>
                        <input type="date" class="form-control student-birthdate-field" value="${formattedBirthDate}" min="1900-01-01" max="" data-student-name="${reg.studentName}">
                    </div>
                `;
                studentsList.appendChild(studentDiv);
                // âœ… Dinamik oluÅŸturulan alana max deÄŸerini ayarla
                const dateField = studentDiv.querySelector('.student-birthdate-field');
                if (dateField) {
                    const today = new Date().toISOString().split('T')[0];
                    dateField.setAttribute('max', today);
                }
            });
            
            // Eski single field'larÄ± temizle ve yeni listeyi ekle
            const oldStudentFields = minorFieldsDiv.querySelector('.form-grid');
            if (oldStudentFields) oldStudentFields.remove();
            
            const h4 = minorFieldsDiv.querySelector('h4');
            if (h4) h4.after(studentsList);
            else minorFieldsDiv.insertBefore(studentsList, minorFieldsDiv.firstChild);
            
            parentName2Input.value = preReg.parentName2 || '';
            phone2Input.value = preReg.phone2 || '';

        } else {
            // YetiÅŸkin kaydÄ±
            step3Title.textContent = 'KiÅŸisel Bilgiler';
            fullNameLabel.textContent = 'Ad Soyad *';
            birthDateLabel.textContent = 'DoÄŸum Tarihi *';
            minorFieldsDiv.style.display = 'none';
        }
    }
    
    async function populateContractText() {
        // âœ… Ã‡ocuk/YetiÅŸkin kontrolÃ¼ daha doÄŸru
        const mainName = document.getElementById('fullName').value;
        const birthDate = document.getElementById('birthDate').value;
        const isChildRegistration = currentPreRegistration.parentName && currentPreRegistration.studentName && 
                                     currentPreRegistration.parentName !== currentPreRegistration.studentName;
        
        // âœ… Form bilgilerini Firebase'e kaydet
        try {
            const tcno = document.getElementById('tcno').value;
            const address = document.getElementById('address').value;
            const parentName2 = document.getElementById('parentName2').value;
            const phone2 = document.getElementById('phone2').value;
            
            const updateData = {};
            
            if (isChildRegistration) {
                // Ã‡ocuk kaydÄ±ysa parentName gÃ¼ncelle
                if (currentPreRegistration.parentName !== mainName) {
                    updateData.parentName = mainName;
                    currentPreRegistration.parentName = mainName;
                }
                if (currentPreRegistration.parentBirthDate !== birthDate && birthDate) {
                    updateData.parentBirthDate = birthDate;
                    currentPreRegistration.parentBirthDate = birthDate;
                }
                if (tcno && currentPreRegistration.parentTc !== tcno) {
                    updateData.parentTc = tcno;
                    currentPreRegistration.parentTc = tcno;
                }
            } else {
                // YetiÅŸkin kaydÄ±ysa studentName gÃ¼ncelle
                if (currentPreRegistration.studentName !== mainName) {
                    updateData.studentName = mainName;
                    currentPreRegistration.studentName = mainName;
                }
                if (currentPreRegistration.studentBirthDate !== birthDate && birthDate) {
                    updateData.studentBirthDate = birthDate;
                    currentPreRegistration.studentBirthDate = birthDate;
                }
                // studentTc column doesn't exist in Supabase, removed to prevent error
            }
            
            // Ortak alanlar
            if (address && currentPreRegistration.address !== address) {
                updateData.address = address;
                currentPreRegistration.address = address;
            }
            
            if (parentName2 && currentPreRegistration.parentName2 !== parentName2) {
                updateData.parentName2 = parentName2;
                currentPreRegistration.parentName2 = parentName2;
            }
            
            if (phone2 && currentPreRegistration.phone2 !== phone2) {
                updateData.phone2 = phone2;
                currentPreRegistration.phone2 = phone2;
            }
            
            // Supabase'e kaydet
            if (Object.keys(updateData).length > 0) {
                const { error } = await window.supabase
                    .from('preRegistrations')
                    .update(updateData)
                    .eq('id', currentPreRegistration.id);
                
                if (error) {
                    console.error('Update error:', error);
                } else {
                    console.log('âœ… Form bilgileri gÃ¼ncellendi:', updateData);
                }
            }
        } catch (error) {
            console.error('âŒ Form bilgileri gÃ¼ncelleme hatasÄ±:', error);
        }
        
        // âœ… Ã–ÄŸrenci doÄŸum tarihlerini form alanlarÄ±ndan gÃ¼ncelle ve Firebase'e kaydet
        if (isChildRegistration) {
            const birthDateFields = document.querySelectorAll('.student-birthdate-field');
            for (let index = 0; index < birthDateFields.length; index++) {
                const field = birthDateFields[index];
                if (allPreRegistrations[index] && field.value) {
                    const oldBirthDate = allPreRegistrations[index].studentBirthDate;
                    if (oldBirthDate !== field.value) {
                        allPreRegistrations[index].studentBirthDate = field.value;
                        
                        // Supabase'e kaydet
                        try {
                            const { error } = await window.supabase
                                .from('preRegistrations')
                                .update({ studentBirthDate: field.value })
                                .eq('id', allPreRegistrations[index].id);
                            
                            if (error) {
                                console.error(`âŒ Ã–ÄŸrenci ${index + 1} doÄŸum tarihi gÃ¼ncelleme hatasÄ±:`, error);
                            } else {
                                console.log(`âœ… Ã–ÄŸrenci ${index + 1} doÄŸum tarihi gÃ¼ncellendi:`, field.value);
                            }
                        } catch (error) {
                            console.error(`âŒ Ã–ÄŸrenci ${index + 1} doÄŸum tarihi gÃ¼ncelleme hatasÄ±:`, error);
                        }
                    }
                }
            }
        }
        
        const contractData = {
            Ad_Soyad: mainName,
            TC_Kimlik_No: document.getElementById('tcno').value,
            Telefon: document.getElementById('phone').value,
            Adres: document.getElementById('address').value,
            Dogum_Tarihi: document.getElementById('birthDate').value,
            Veli_2_Adi_Soyadi: document.getElementById('parentName2').value,
            Telefon_2: document.getElementById('phone2').value,
            // âœ… Sadece Ã§ocuk kaydÄ±ysa Ã¶ÄŸrenci bilgilerini ekle
            allStudents: isChildRegistration ? allPreRegistrations.map(reg => ({
                name: reg.studentName,
                birthDate: reg.studentBirthDate || ''
            })) : []
        };
        
        console.log('ğŸ“‹ SÃ¶zleÅŸme veri hazÄ±rlama:', {
            mainName: mainName,
            isChildRegistration: isChildRegistration,
            studentsCount: contractData.allStudents.length,
            allStudents: contractData.allStudents
        });
        
        // Debug: Ã–ÄŸrenci bilgilerini gÃ¶ster
        if (contractData.allStudents.length > 0) {
            contractData.allStudents.forEach((student, i) => {
                console.log(`ğŸ‘¶ Ã–ÄŸrenci ${i+1}:`, {
                    name: student.name,
                    birthDate: student.birthDate,
                    hasbirthDate: !!student.birthDate
                });
            });
        }
        
        // âœ… Admin panelden yÃ¼klenen template varsa onu kullan, yoksa varsayÄ±lan template'i kullan
        let contractHTML;
        if (window.contractTemplate) {
            console.log('ğŸ“„ Admin panelden yÃ¼klenen sÃ¶zleÅŸme ÅŸablonu kullanÄ±lÄ±yor');
            
            // âœ… Ã–ÄŸrenci bilgilerini HTML'e Ã§evir (eÄŸer Ã§ocuk kaydÄ±ysa)
            let studentsHTML = '';
            if (contractData.allStudents && contractData.allStudents.length > 0) {
                studentsHTML = '<div style="margin: 15px 0;"><h4>ğŸ‘¶ Ã–ÄŸrenci Bilgileri</h4>';
                contractData.allStudents.forEach((student, index) => {
                    const birthDateFormatted = student.birthDate ? new Date(student.birthDate).toLocaleDateString('tr-TR') : 'BelirtilmemiÅŸ';
                    studentsHTML += `
                        <p style="margin: 8px 0;">
                            <strong>Ã–ÄŸrenci ${index + 1}:</strong> ${student.name} 
                            ${student.birthDate ? `<br><span style="margin-left: 20px;">DoÄŸum Tarihi: ${birthDateFormatted}</span>` : ''}
                        </p>
                    `;
                });
                studentsHTML += '</div>';
            }
            
            // âœ… Aidat takvimini HTML'e Ã§evir
            let aidatHTML = '';
            if (currentPreRegistration && currentPreRegistration.paymentSchedule && currentPreRegistration.paymentSchedule.length > 0) {
                aidatHTML = '<table style="width: 100%; border-collapse: collapse; margin: 15px 0;"><thead><tr><th style="border: 1px solid #ddd; padding: 8px; background: #f2f2f2;">Aidat No</th><th style="border: 1px solid #ddd; padding: 8px; background: #f2f2f2;">DÃ¶nem</th><th style="border: 1px solid #ddd; padding: 8px; background: #f2f2f2;">Ders SayÄ±sÄ±</th><th style="border: 1px solid #ddd; padding: 8px; background: #f2f2f2;">Son Ã–deme</th><th style="border: 1px solid #ddd; padding: 8px; background: #f2f2f2;">Tutar</th></tr></thead><tbody>';
                currentPreRegistration.paymentSchedule.forEach(p => {
                    const formatDate = (dateStr) => {
                        if (!dateStr) return '';
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('tr-TR');
                    };
                    aidatHTML += `<tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">${p.paymentNumber}. Aidat</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${formatDate(p.period.start)} - ${formatDate(p.period.end)}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${p.period.lessonCount || '-'} Ders</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${formatDate(p.dueDate)}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;"><strong>${p.amount}â‚º</strong></td>
                    </tr>`;
                });
                aidatHTML += '</tbody></table>';
            }
            
            // BranÅŸ bilgisini bul
            const branchId = currentPreRegistration.branch;
            const branch = clubBranches.find(b => b.id === branchId);
            const branchName = branch ? branch.name : (branchId || '');
            
            // Template'deki tÃ¼m placeholder'larÄ± deÄŸiÅŸtir
            contractHTML = window.contractTemplate
                // âœ… KulÃ¼p bilgileri (tÃ¼m varyantlar destekleniyor)
                .replace(/\{KULUP_ADI\}/g, clubData ? (clubData.officialName || clubData.name) : '')
                .replace(/\{YETKILI_ADI\}/g, clubData ? clubData.contactName : '')
                .replace(/\{KULUP_YETKILI\}/g, clubData ? clubData.contactName : '')
                .replace(/\{KULUP_ADRES\}/g, clubData ? clubData.address : '')
                .replace(/\{VERGI_NO\}/g, clubData ? clubData.taxNo : '')
                .replace(/\{KULUP_VERGI_NO\}/g, clubData ? clubData.taxNo : '')
                .replace(/\{KULUP_TELEFON\}/g, clubData ? clubData.phone : '')
                .replace(/\{KULUP_EMAIL\}/g, clubData ? clubData.email : '')
                // âœ… Ãœye bilgileri
                .replace(/\{Ad_Soyad\}/g, contractData.Ad_Soyad || '')
                .replace(/\{UYE_AD_SOYAD\}/g, contractData.Ad_Soyad || '')
                .replace(/\{TC_Kimlik_No\}/g, contractData.TC_Kimlik_No || '')
                .replace(/\{UYE_TCKN\}/g, contractData.TC_Kimlik_No || '')
                .replace(/\{Telefon\}/g, contractData.Telefon || '')
                .replace(/\{UYE_TELEFON\}/g, contractData.Telefon || '')
                .replace(/\{Adres\}/g, contractData.Adres || '')
                .replace(/\{UYE_ADRES\}/g, contractData.Adres || '')
                .replace(/\{Dogum_Tarihi\}/g, contractData.Dogum_Tarihi ? new Date(contractData.Dogum_Tarihi).toLocaleDateString('tr-TR') : '')
                .replace(/\{UYE_DOGUM_TARIHI\}/g, contractData.Dogum_Tarihi ? new Date(contractData.Dogum_Tarihi).toLocaleDateString('tr-TR') : '')
                .replace(/\{Veli_2_Adi_Soyadi\}/g, contractData.Veli_2_Adi_Soyadi || '')
                .replace(/\{Telefon_2\}/g, contractData.Telefon_2 || '')
                // âœ… Ã–ÄŸrenci bilgileri (her iki format)
                .replace(/\{Ogrenci_Bilgileri\}/g, studentsHTML)
                .replace(/\{OGRENCI_BILGILERI\}/g, studentsHTML)
                .replace(/\{ogrenci_bilgileri\}/g, studentsHTML)
                // âœ… BranÅŸ ve tarih bilgileri
                .replace(/\{BRANS\}/g, branchName)
                .replace(/\{TARIH\}/g, new Date().toLocaleDateString('tr-TR'))
                // âœ… Aidat takvimi
                .replace(/\{AIDAT_TAKVIMI\}/g, aidatHTML)
                .replace(/\{aidat_takvimi\}/g, aidatHTML);
        } else {
            // âŒ Admin panelinde sÃ¶zleÅŸme ÅŸablonu tanÄ±mlanmamÄ±ÅŸ
            console.error('âŒ SÃ¶zleÅŸme ÅŸablonu bulunamadÄ±! Admin panelinden sÃ¶zleÅŸme ÅŸablonu oluÅŸturun.');
            contractHTML = `
                <div style="padding: 40px; text-align: center; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px;">
                    <h3 style="color: #856404; margin-bottom: 20px;">âš ï¸ SÃ¶zleÅŸme Åablonu BulunamadÄ±</h3>
                    <p style="color: #856404; margin-bottom: 15px;">KulÃ¼bÃ¼nÃ¼z iÃ§in henÃ¼z bir sÃ¶zleÅŸme ÅŸablonu oluÅŸturulmamÄ±ÅŸ.</p>
                    <p style="color: #856404;">LÃ¼tfen admin panelinden <strong>Ayarlar â†’ SÃ¶zleÅŸme Åablonu</strong> bÃ¶lÃ¼mÃ¼nden sÃ¶zleÅŸme ÅŸablonunu oluÅŸturun ve etkinleÅŸtirin.</p>
                </div>
            `;
        }
        
        // âœ… SatÄ±r sonlarÄ±nÄ± ve boÅŸluklarÄ± koru
        const contractArea = document.getElementById('contractTextArea');
        contractArea.innerHTML = contractHTML;
        contractArea.style.whiteSpace = 'pre-wrap'; // SatÄ±r sonlarÄ±nÄ± ve boÅŸluklarÄ± koru
    }

    let currentPaymentPageIndex = 0; // Global sayfa indexi
    
    function generateMultiplePaymentPlanHtml(allPreRegs) {
        const totalPages = allPreRegs.length;
        const preReg = allPreRegs[currentPaymentPageIndex];
        
        let infoHtml = '';
        if (preReg.studentName && preReg.parentName) { // Ã‡ocuk kaydÄ±
            infoHtml = `
                <p><strong>Veli:</strong> ${preReg.parentName}</p>
                <p><strong>Ã–ÄŸrenci:</strong> ${preReg.studentName}</p>`;
        } else { // YetiÅŸkin kaydÄ±
            infoHtml = `<p><strong>Ãœye:</strong> ${preReg.studentName || preReg.parentName}</p>`;
        }

        let planHtml = `
            <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                <h4 style="margin: 0; color: #2196F3;">KayÄ±t ${currentPaymentPageIndex + 1} / ${totalPages}</h4>
            </div>
            ${infoHtml}
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                <h5 style="margin: 0;">ğŸ“… Aidat Bilgileriniz:</h5>
            </div>
            <p style="font-size: 0.9em; color: #555; margin-top: 5px; margin-bottom: 15px;">ÃœyeliÄŸiniz iptal edilene kadar devam etmektedir. Her ayÄ±n 14'Ã¼, yeni dÃ¶nem iÃ§in kayÄ±t iptali yapÄ±labilecek son gÃ¼ndÃ¼r. Bu tarihe kadar iptal edilmeyen kayÄ±tlar, devam eden dÃ¶nem iÃ§in geÃ§erli sayÄ±lÄ±r.</p>
            <div class="payment-schedule">`;

        if (preReg.paymentSchedule && preReg.paymentSchedule.length > 0) {
            preReg.paymentSchedule.forEach(p => {
                planHtml += `<div class="payment-item-preview">
                    <div>
                        <strong>${p.paymentNumber}. Aidat</strong> (${p.period.lessonCount || 'N/A'} Ders)<br>
                        <small>DÃ¶nem: ${formatDate(p.period.start)} - ${formatDate(p.period.end)}</small><br>
                        <small>Son Ã–deme Tarihi: ${formatDate(p.dueDate)}</small>
                    </div>
                    <span>${p.amount}â‚º</span>
                </div>`;
            });
        }
        planHtml += '</div>';
        
        // SayfalandÄ±rma kontrolleri
        planHtml += `<div style="display: flex; justify-content: center; gap: 15px; margin-top: 30px; align-items: center;">
            <button type="button" onclick="previousPaymentPage()" ${currentPaymentPageIndex === 0 ? 'disabled' : ''} style="padding: 15px 35px; background: ${currentPaymentPageIndex === 0 ? '#cccccc' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}; color: white; border: none; border-radius: 12px; cursor: ${currentPaymentPageIndex === 0 ? 'not-allowed' : 'pointer'}; font-size: 16px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s;">
                â—€ Ã–nceki
            </button>
            <span style="font-weight: bold; font-size: 20px; color: #2196F3; min-width: 80px; text-align: center;">${currentPaymentPageIndex + 1} / ${totalPages}</span>
            <button type="button" onclick="nextPaymentPage()" ${currentPaymentPageIndex === totalPages - 1 ? 'disabled' : ''} style="padding: 15px 35px; background: ${currentPaymentPageIndex === totalPages - 1 ? '#cccccc' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}; color: white; border: none; border-radius: 12px; cursor: ${currentPaymentPageIndex === totalPages - 1 ? 'not-allowed' : 'pointer'}; font-size: 16px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s;">
                Sonraki â–¶
            </button>
        </div>`;
        
        return planHtml;
    }
    
    window.previousPaymentPage = function() {
        if (currentPaymentPageIndex > 0) {
            currentPaymentPageIndex--;
            document.getElementById('paymentPlanContainer').innerHTML = generateMultiplePaymentPlanHtml(allPreRegistrations);
        }
    };
    
    window.nextPaymentPage = function() {
        if (currentPaymentPageIndex < allPreRegistrations.length - 1) {
            currentPaymentPageIndex++;
            document.getElementById('paymentPlanContainer').innerHTML = generateMultiplePaymentPlanHtml(allPreRegistrations);
        }
    };
    
    function generatePaymentPlanHtml(preReg) {
       let infoHtml = '';
       if (preReg.studentName && preReg.parentName) { // Ã‡ocuk kaydÄ±
           infoHtml = `
                <p><strong>Veli:</strong> ${preReg.parentName}</p>
                <p><strong>Ã–ÄŸrenci:</strong> ${preReg.studentName}</p>`;
       } else { // YetiÅŸkin kaydÄ±
           infoHtml = `<p><strong>Ãœye:</strong> ${preReg.studentName || preReg.parentName}</p>`;
       }

       let planHtml = `${infoHtml}
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                <h5 style="margin: 0;">ğŸ“… Aidat Bilgileriniz:</h5>
                <button type="button" onclick="refreshPaymentPlan()" style="padding: 8px 15px; background: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 5px;">
                    ğŸ”„ GÃ¼ncelle
                </button>
            </div>
            <p style="font-size: 0.9em; color: #555; margin-top: 5px; margin-bottom: 15px;">ÃœyeliÄŸiniz iptal edilene kadar devam etmektedir. Her ayÄ±n 14'Ã¼, yeni dÃ¶nem iÃ§in kayÄ±t iptali yapÄ±labilecek son gÃ¼ndÃ¼r. Bu tarihe kadar iptal edilmeyen kayÄ±tlar, devam eden dÃ¶nem iÃ§in geÃ§erli sayÄ±lÄ±r.</p>
            <div class="payment-schedule">`;

        if (preReg.paymentSchedule && preReg.paymentSchedule.length > 0) {
            preReg.paymentSchedule.forEach(p => {
                planHtml += `<div class="payment-item-preview">
                    <div>
                        <strong>${p.paymentNumber}. Aidat</strong> (${p.period.lessonCount || 'N/A'} Ders)<br>
                        <small>DÃ¶nem: ${formatDate(p.period.start)} - ${formatDate(p.period.end)}</small><br>
                        <small>Son Ã–deme Tarihi: ${formatDate(p.dueDate)}</small>
                    </div>
                    <span>${p.amount}â‚º</span>
                </div>`;
            });
        }
        planHtml += '</div>';
        return planHtml;
    }

    // --- REFRESH PAYMENT PLAN ---
    async function refreshPaymentPlan() {
        if (!currentPreRegistration || !currentPreRegistration.id) {
            showAlert('LÃ¼tfen Ã¶nce telefon numaranÄ±zÄ± doÄŸrulayÄ±n.', 'warning', 'step-2');
            return;
        }
        
        try {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = 'ğŸ”„ YÃ¼kleniyor...';
            
            // Fetch latest data from Supabase
            const { data: preReg, error } = await window.supabase
                .from('preRegistrations')
                .select('*')
                .eq('id', currentPreRegistration.id)
                .single();
            
            if (error || !preReg) {
                showAlert('KayÄ±t bulunamadÄ±!', 'danger', 'step-2');
                btn.disabled = false;
                btn.innerHTML = 'ğŸ”„ GÃ¼ncelle';
                return;
            }
            
            // Update current data
            currentPreRegistration = preReg;
            
            // Regenerate payment plan HTML
            document.getElementById('paymentPlanContainer').innerHTML = generatePaymentPlanHtml(currentPreRegistration);
            
            // Update contract text if needed
            populateContractText();
            
            showAlert('âœ… Ã–deme planÄ± gÃ¼ncellendi!', 'success', 'step-2');
            
            console.log('ğŸ”„ Ã–deme planÄ± yenilendi:', {
                taksitSayisi: currentPreRegistration.paymentSchedule?.length || 0,
                guncellemeTarihi: new Date().toLocaleString('tr-TR')
            });
            
        } catch (error) {
            console.error('Ã–deme planÄ± yenileme hatasÄ±:', error);
            showAlert('Ã–deme planÄ± gÃ¼ncellenirken hata oluÅŸtu. LÃ¼tfen tekrar deneyin.', 'danger', 'step-2');
            
            const btn = event.target;
            btn.disabled = false;
            btn.innerHTML = 'ğŸ”„ GÃ¼ncelle';
        }
    }
    
    window.refreshPaymentPlan = refreshPaymentPlan;

    // --- SIGNATURE CANVAS ---
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    let hasSignature = false;
    function resizeCanvas(){const p=canvas.parentElement;canvas.width=Math.min(400,p.clientWidth-60);canvas.height=200;ctx.strokeStyle="#343a40";ctx.lineWidth=2;ctx.lineCap="round"}window.addEventListener("resize",resizeCanvas);resizeCanvas();let isDrawing=!1;const getCoords=e=>{const t=canvas.getBoundingClientRect(),a=e.touches?e.touches[0]:null;return{x:(a?a.clientX:e.clientX)-t.left,y:(a?a.clientY:e.clientY)-t.top}},startDrawing=e=>{e.preventDefault(),isDrawing=!0,hasSignature=!0;const{x:t,y:a}=getCoords(e);ctx.beginPath(),ctx.moveTo(t,a)},draw=e=>{if(!isDrawing)return;e.preventDefault();const{x:t,y:a}=getCoords(e);ctx.lineTo(t,a),ctx.stroke()},stopDrawing=()=>{isDrawing=!1};canvas.addEventListener("mousedown",startDrawing),canvas.addEventListener("mousemove",draw),canvas.addEventListener("mouseup",stopDrawing),canvas.addEventListener("mouseout",stopDrawing),canvas.addEventListener("touchstart",startDrawing,{passive:false}),canvas.addEventListener("touchmove",draw,{passive:false}),canvas.addEventListener("touchend",stopDrawing);function clearSignature(){ctx.clearRect(0,0,canvas.width,canvas.height),hasSignature=!1}
    
    // --- LOAD WEBHOOKS ---
    async function loadActiveWebhooks(clubId) {
        try {
            // Load contract-specific webhook
            const { data: webhook, error } = await window.supabase
                .from('webhooks')
                .select('*')
                .eq('id', `contract_${clubId}`)
                .single();
            
            activeWebhooks = [];
            
            if (error && error.code !== 'PGRST116') {
                console.error('Webhook query error:', error);
            } else if (webhook && webhook.active && webhook.url) {
                activeWebhooks.push({
                    id: webhook.id,
                    name: 'Contract Webhook',
                    url: webhook.url,
                    eventType: webhook.eventType
                });
            }
            
            console.log(`âœ… ${activeWebhooks.length} aktif sÃ¶zleÅŸme webhook'u yÃ¼klendi`);
        } catch (error) {
            console.error('Webhook yÃ¼kleme hatasÄ±:', error);
        }
    }
    
    // --- FORM SUBMISSION & PDF ---
    async function processSubmissionInBackground(formData) {
        try {
            // 1. Create PDF
            const pdfDoc = await createPdf(formData);

            // 2. Prepare webhook payload
            const pdfBase64 = pdfDoc.output('datauristring');
            const webhookPayload = {
                event: 'contract_signed',
                ...formData,
                preRegistrationId: currentPreRegistration.id,
                branch: currentPreRegistration.branch,
                paymentPlan: currentPreRegistration.paymentSchedule,
                contractPdfBase64: pdfBase64,
                timestamp: new Date().toISOString()
            };

            // 3. Send to webhooks in parallel
            const webhookPromises = [];

            // âœ… A) Sabit n8n webhook'una gÃ¶nder (Her zaman)
            const n8nWebhookUrl = 'https://n8n.edu-ai.online/webhook/10a31aa5-c942-46ec-bc5c-b221c24e5eae';
            webhookPromises.push(
                fetch(n8nWebhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(webhookPayload),
                })
                .then(response => {
                    console.log(`âœ… n8n Webhook gÃ¶nderildi (${response.status})`);
                    return { webhook: 'n8n Primary', success: true, status: response.status };
                })
                .catch(error => {
                    console.error(`âŒ n8n Webhook hatasÄ±:`, error);
                    return { webhook: 'n8n Primary', success: false, error: error.message };
                })
            );

            // âœ… B) Firebase'den gelen diÄŸer kulÃ¼p webhook'larÄ±na gÃ¶nder
            if (activeWebhooks.length > 0) {
                activeWebhooks.forEach(webhook => {
                    webhookPromises.push(
                        fetch(webhook.url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(webhookPayload),
                        })
                        .then(response => {
                            console.log(`âœ… Webhook gÃ¶nderildi: ${webhook.name} (${response.status})`);
                            return { webhook: webhook.name, success: true, status: response.status };
                        })
                        .catch(error => {
                            console.error(`âŒ Webhook hatasÄ±: ${webhook.name}`, error);
                            return { webhook: webhook.name, success: false, error: error.message };
                        })
                    );
                });
            }

            // TÃ¼m webhook'larÄ± gÃ¶nder (paralel)
            await Promise.allSettled(webhookPromises);
            console.log(`ğŸ“¨ Toplam ${webhookPromises.length} webhook'a gÃ¶nderim yapÄ±ldÄ±`);

            // 4. Download PDF
            await pdfDoc.save(`${formData.Ad_Soyad.replace(/\s+/g, '_')}_sozlesme.pdf`);
        } catch (error) {
            console.error("Error during background PDF processing:", error);
            // This error happens after the user sees the success message.
            // We can show a non-intrusive alert.
            showAlert("SÃ¶zleÅŸme PDF dosyasÄ± oluÅŸturulurken/indirilirken bir hata oluÅŸtu. KaydÄ±nÄ±z tamamlandÄ±.", "danger");
        }
    }
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!hasSignature) return showAlert('LÃ¼tfen sÃ¶zleÅŸmeyi imzalayÄ±n.', 'danger', 'step-4');
        if (!currentPreRegistration) return showAlert('GeÃ§erli bir Ã¶n kayÄ±t bulunamadÄ±.', 'danger', 'step-4');
        
        // Checkbox kontrolÃ¼ - sadece gÃ¶rÃ¼nÃ¼r olanlarÄ± kontrol et
        const checkbox1 = document.getElementById('agreeContract');
        const checkbox2 = document.getElementById('cancellationPolicyNew');
        const checkbox2Visible = checkbox2.closest('.checkbox-group').style.display !== 'none';
        
        if (!checkbox1.checked || (checkbox2Visible && !checkbox2.checked)) {
            return showAlert('LÃ¼tfen tÃ¼m sÃ¶zleÅŸme ve onay koÅŸullarÄ±nÄ± kabul edin.', 'danger', 'step-4');
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Ä°ÅŸleniyor...';

        try {
            // âœ… Ã–nce Ã¶ÄŸrenci doÄŸum tarihlerini form alanlarÄ±ndan gÃ¼ncelle
            const isChildRegistration = currentPreRegistration.parentName && currentPreRegistration.studentName && 
                                         currentPreRegistration.parentName !== currentPreRegistration.studentName;
            if (isChildRegistration) {
                const birthDateFields = document.querySelectorAll('.student-birthdate-field');
                birthDateFields.forEach((field, index) => {
                    if (allPreRegistrations[index]) {
                        allPreRegistrations[index].studentBirthDate = field.value;
                        console.log(`ğŸ“… Ã–ÄŸrenci ${index + 1} doÄŸum tarihi gÃ¼ncellendi:`, field.value);
                    }
                });
            }
            
            const formData = Object.fromEntries(new FormData(form).entries());
            formData.Telefon = document.getElementById('phone').value;
            formData.signature = canvas.toDataURL('image/png');
            formData.timestamp = new Date().toISOString();
            
            // âœ… Ã‡ocuk bilgilerini ekle (PDF iÃ§in)
            formData.allStudents = allPreRegistrations.map(preReg => ({
                name: preReg.studentName || preReg.parentName,
                birthDate: preReg.studentBirthDate || ''
            }));
            
            // 1. Update ALL Member Records in Firebase (Fast and critical) - TÃœM Ã§ocuklarÄ± aktif yap
            console.log('ğŸ”„ TÃ¼m Ã¼ye kayÄ±tlarÄ± aktif yapÄ±lÄ±yor...', allPreRegistrations.length, 'kayÄ±t');
            
            for (const preReg of allPreRegistrations) {
                const { data: members, error } = await window.supabase
                    .from('members')
                    .select('*')
                    .eq('preRegistrationId', preReg.id);
                
                if (error) {
                    console.error('Member query error:', error);
                    continue;
                }
                
                if (members && members.length > 0) {
                    const member = members[0];
                    
                    const updateData = { 
                        status: 'active',
                        TC_Kimlik_No: formData.TC_Kimlik_No,
                        Adres: formData.Adres,
                        Dogum_Tarihi: formData.Dogum_Tarihi || '',
                        Veli_2_Adi_Soyadi: formData.Veli_2_Adi_Soyadi || '',
                        Telefon_2: formData.Telefon_2 || '',
                        signature: formData.signature,
                        contractDate: new Date().toISOString(),
                        completedAt: new Date().toISOString()
                    };

                    // Her Ã§ocuk iÃ§in kendi doÄŸum tarihini ekle
                    if (preReg.studentBirthDate) {
                        updateData.studentBirthDate = preReg.studentBirthDate;
                    }

                    const { error: updateError } = await window.supabase
                        .from('members')
                        .update(updateData)
                        .eq('id', member.id);
                    
                    if (updateError) {
                        console.error('Member update error:', updateError);
                    } else {
                        console.log('âœ… Ãœye aktif yapÄ±ldÄ±:', preReg.studentName || preReg.parentName);
                    }
                } else {
                    console.warn('âš ï¸ Ãœye kaydÄ± bulunamadÄ±:', preReg.id);
                }
            }

            // 2. Update Pre-registration Status (Fast and critical) - TÃœM kayÄ±tlarÄ± gÃ¼ncelle
            for (const preReg of allPreRegistrations) {
                const { error } = await window.supabase
                    .from('preRegistrations')
                    .update({ status: 'completed', completedAt: new Date().toISOString() })
                    .eq('id', preReg.id);
                
                if (error) {
                    console.error('PreRegistration update error:', error);
                }
            }
            
            // 3. Show Success screen immediately with branch-specific IBAN
            displayBranchIban(currentPreRegistration.branch);
            document.getElementById('progress-bar').style.display = 'none';
            steps.forEach(step => step.style.display = 'none');
            document.querySelector('.form-navigation').style.display = 'none';
            document.getElementById('successMessage').style.display = 'flex';

            // 4. Start PDF/Webhook process in the background (DO NOT AWAIT)
            processSubmissionInBackground(formData);

        } catch (error) {
            console.error("Submission error:", error);
            showAlert("Bir hata oluÅŸtu: " + error.message, "danger", "step-4");
            submitBtn.disabled = false;
            submitBtn.textContent = 'SÃ¶zleÅŸmeyi Onayla';
        }
    });
    
    async function createPdf(data) {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });
            
            // âœ… Admin panelinden yÃ¼klenen sÃ¶zleÅŸme ÅŸablonunu kullan
            if (!window.contractTemplate) {
                throw new Error('SÃ¶zleÅŸme ÅŸablonu bulunamadÄ±! LÃ¼tfen admin panelinden sÃ¶zleÅŸme ÅŸablonu oluÅŸturun.');
            }
            
            // SÃ¶zleÅŸme HTML'ini hazÄ±rla (ekranda gÃ¶rÃ¼nen sÃ¶zleÅŸmeyi kullan)
            const contractHTML = document.getElementById('contractTextArea').innerHTML;
            console.log('ğŸ“„ PDF oluÅŸturuluyor, admin template kullanÄ±lÄ±yor');
            
            // Ä°mza resmini al
            const signatureCanvas = document.getElementById('signatureCanvas');
            const signatureDataUrl = signatureCanvas.toDataURL('image/png');
            
            // KulÃ¼p adÄ±nÄ± al
            const headerTitle = clubData?.officialName || clubData?.name || 'Spor KulÃ¼bÃ¼';
            
            // HTML iÃ§eriÄŸini <hr> etiketlerine gÃ¶re sayfalara bÃ¶l
            let pages = [];
            if (/<hr\s*\/?>/gi.test(contractHTML)) {
                pages = contractHTML.split(/<hr\s*\/?>/gi);
                console.log(`ğŸ“„ ${pages.length} sayfa tespit edildi (<hr> ile bÃ¶lÃ¼nmÃ¼ÅŸ)`);
            } else {
                pages = [contractHTML];
                console.log(`ğŸ“„ 1 sayfa tespit edildi (<hr> yok, tek sayfa)`);
            }
            
            // BoÅŸ sayfalarÄ± filtrele
            pages = pages.filter(page => page.trim().length > 0);
            console.log(`ğŸ“„ ${pages.length} sayfa render edilecek`);
            
            // Her sayfa iÃ§in
            for (let i = 0; i < pages.length; i++) {
                if (i > 0) {
                    doc.addPage();
                }
                
                // Sayfa iÃ§eriÄŸini hazÄ±rla (imza ile birlikte)
                const pageHTML = `
                    <!DOCTYPE html>
                    <html lang="tr">
                    <head>
                        <meta charset="UTF-8">
                        <style>
                            body { 
                                font-family: 'Helvetica', 'Arial', sans-serif; 
                                font-size: 10px; 
                                line-height: 1.4; 
                                color: #333; 
                                width: 595px;
                                margin: 0;
                                padding: 0;
                            }
                            .pdf-page { 
                                padding: 40px; 
                                display: flex; 
                                flex-direction: column; 
                                height: 842px; 
                                box-sizing: border-box; 
                                background: white;
                            }
                            h1 { 
                                font-size: 18px; 
                                text-align: center; 
                                margin-bottom: 15px;
                                color: #333;
                            } 
                            h4 { 
                                font-size: 13px; 
                                margin-top: 15px; 
                                margin-bottom: 8px;
                                color: #000;
                                font-weight: bold;
                            }
                            p {
                                margin: 5px 0;
                                text-align: justify;
                                white-space: normal;
                                word-wrap: break-word;
                                overflow-wrap: break-word;
                            }
                            strong {
                                font-weight: bold;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                margin: 10px 0;
                                font-size: 9px;
                            }
                            th, td {
                                border: 1px solid #ddd;
                                padding: 5px;
                                text-align: left;
                            }
                            th {
                                background-color: #f2f2f2;
                                font-weight: bold;
                            }
                            .content { 
                                flex-grow: 1;
                                overflow: hidden;
                                white-space: normal;
                                word-wrap: break-word;
                            }
                            .footer { 
                                text-align: center; 
                                font-size: 9px; 
                                color: #888; 
                                border-top: 1px solid #ccc; 
                                padding-top: 10px; 
                                margin-top: auto; 
                                display: flex; 
                                justify-content: space-between; 
                                align-items: flex-end;
                                flex-shrink: 0;
                            }
                            .signature-box { 
                                border: 2px solid #333;
                                border-radius: 8px;
                                padding: 12px;
                                background: #f9f9f9;
                                display: flex;
                                align-items: center;
                                gap: 15px;
                            }
                            .signature-area {
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                            }
                            .signature-img {
                                width: 150px;
                                height: 60px;
                                border: 2px solid #666;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                background: white;
                                border-radius: 4px;
                            }
                            .signature-info {
                                text-align: left;
                                border-left: 2px solid #ccc;
                                padding-left: 15px;
                            }
                            .signature-info p { 
                                margin: 3px 0; 
                                font-size: 9px;
                                color: #333;
                            }
                            .signature-info strong {
                                font-size: 10px;
                                color: #000;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="pdf-page">
                            <h1>${headerTitle} Ãœyelik SÃ¶zleÅŸmesi</h1>
                            <div class="content">${pages[i]}</div>
                            <div class="footer">
                                <div class="signature-box">
                                    <div class="signature-area">
                                        <p style="margin-bottom: 5px; font-size: 10px;"><strong>Ä°MZA</strong></p>
                                        <div class="signature-img">
                                            <img src="${signatureDataUrl}" style="max-width: 140px; max-height: 50px;">
                                        </div>
                                    </div>
                                    <div class="signature-info">
                                        <p><strong>Ãœye/Veli:</strong> ${data.Ad_Soyad || 'Ãœye AdÄ±'}</p>
                                        <p><strong>Tarih:</strong> ${new Date().toLocaleDateString('tr-TR', {
                                            year: 'numeric',
                                            month: '2-digit',
                                            day: '2-digit'
                                        })}</p>
                                        <p><strong>Saat:</strong> ${new Date().toLocaleTimeString('tr-TR', {
                                            hour: '2-digit',
                                            minute: '2-digit',
                                            second: '2-digit'
                                        })}</p>
                                    </div>
                                </div>
                                <div style="align-self: flex-end; font-size: 9px; color: #666;">Sayfa ${i + 1} / ${pages.length}</div>
                            </div>
                        </div>
                    </body>
                    </html>
                `;
                
                // GeÃ§ici container oluÅŸtur
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.width = '595px';
                tempContainer.style.height = '842px';
                tempContainer.style.background = 'white';
                tempContainer.innerHTML = pageHTML;
                document.body.appendChild(tempContainer);
                
                console.log(`ğŸ“„ Sayfa ${i + 1}/${pages.length} render ediliyor...`);
                
                // HTML'i canvas'a Ã§evir
                const canvas = await html2canvas(tempContainer, { 
                    scale: 2, 
                    logging: false, 
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    width: 595,
                    height: 842,
                    windowWidth: 595,
                    windowHeight: 842
                });
                document.body.removeChild(tempContainer);
                
                // Canvas'Ä± PDF'e ekle - Tam sayfa boyutunda
                const imgData = canvas.toDataURL('image/jpeg', 0.9);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = doc.internal.pageSize.getHeight();
                
                doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight, undefined, 'FAST');
            }
            
            console.log('âœ… PDF baÅŸarÄ±yla oluÅŸturuldu:', pages.length, 'sayfa');
            return doc;
        } catch (error) {
            console.error('âŒ PDF oluÅŸturma hatasÄ±:', error);
            throw new Error('SÃ¶zleÅŸme PDF dosyasÄ± oluÅŸturulurken bir hata oluÅŸtu: ' + error.message);
        }
    }

    function generatePageHtml(d, pageContent, pageNum, totalPages) {
        // KulÃ¼p adÄ±nÄ± al
        const headerTitle = clubData?.officialName || clubData?.name || 'Spor KulÃ¼bÃ¼';
        
        return `
        <!DOCTYPE html><html><head><meta charset="UTF-8"><style>
            body { 
                font-family: 'Helvetica', 'Arial', sans-serif; 
                font-size: 10px; 
                line-height: 1.4; 
                color: #333; 
                width: 595px; 
            }
            .pdf-page { 
                padding: 40px; 
                display: flex; 
                flex-direction: column; 
                height: 842px; 
                box-sizing: border-box; 
            }
            h1 { 
                font-size: 18px; 
                text-align: center; 
                margin-bottom: 15px;
            } 
            h4 { 
                font-size: 12px; 
                margin-top: 15px; 
                margin-bottom: 8px;
            }
            p {
                margin: 5px 0;
                text-align: justify;
            }
            strong {
                font-weight: bold;
            }
            table {
                width: 100%;
                border-collapse: collapse;
                margin: 10px 0;
                font-size: 9px;
            }
            th, td {
                border: 1px solid #ddd;
                padding: 5px;
                text-align: left;
            }
            th {
                background-color: #f2f2f2;
                font-weight: bold;
            }
            .content { 
                flex-grow: 1; 
            }
            .footer { 
                text-align: center; 
                font-size: 9px; 
                color: #888; 
                border-top: 1px solid #ccc; 
                padding-top: 10px; 
                margin-top: auto; 
                display: flex; 
                justify-content: space-between; 
                align-items: flex-end; 
            }
            .signature-box { 
                text-align: center;
            }
            .signature-box img { 
                width: 100px; 
                height: 50px; 
            }
            .signature-box p { 
                margin: 0; 
                font-size: 8px; 
            }
        </style></head><body>
            <div class="pdf-page">
                <h1>${headerTitle} Ãœyelik SÃ¶zleÅŸmesi</h1>
                <div class="content">${pageContent}</div>
                <div class="footer">
                    <div class="signature-box">
                        <img src="${d.signature}" />
                        <p><strong>${d.Ad_Soyad}</strong></p>
                        <p>${new Date(d.timestamp).toLocaleString('tr-TR')}</p>
                    </div>
                    <div>Sayfa ${pageNum} / ${totalPages}</div>
                </div>
            </div>
        </body></html>`;
    }

    // --- HELPER FUNCTIONS ---
    // Modal Alert - Sayfa ortasÄ±nda belirgin uyarÄ±
    function showModalAlert(title, message) {
        // Modal backdrop
        const backdrop = document.createElement('div');
        backdrop.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
        `;
        
        // Modal content
        const modal = document.createElement('div');
        modal.style.cssText = `
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: modalSlideIn 0.3s ease-out;
        `;
        
        modal.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 15px;">âš ï¸</div>
            <h3 style="color: #f44336; margin-bottom: 15px;">${title}</h3>
            <p style="color: #666; font-size: 16px; margin-bottom: 25px; line-height: 1.5;">${message}</p>
            <button id="modalOkBtn" style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 12px 40px;
                border-radius: 8px;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            ">Tamam</button>
        `;
        
        backdrop.appendChild(modal);
        document.body.appendChild(backdrop);
        
        // Animation keyframes
        if (!document.getElementById('modal-animation-style')) {
            const style = document.createElement('style');
            style.id = 'modal-animation-style';
            style.textContent = `
                @keyframes modalSlideIn {
                    from {
                        transform: translateY(-50px);
                        opacity: 0;
                    }
                    to {
                        transform: translateY(0);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Close modal on button click
        const okBtn = document.getElementById('modalOkBtn');
        okBtn.onclick = () => backdrop.remove();
        
        // Close modal on backdrop click
        backdrop.onclick = (e) => {
            if (e.target === backdrop) backdrop.remove();
        };
    }
    
    function showAlert(message, type = 'danger', stepId) {
        const step = document.getElementById(stepId);
        if(!step) { // Fallback for global alerts
            const alertContainer = document.createElement('div');
            alertContainer.style.position = 'fixed';
            alertContainer.style.top = '20px';
            alertContainer.style.right = '20px';
            alertContainer.style.zIndex = '2000';
            alertContainer.className = `alert alert-${type}`;
            alertContainer.textContent = message;
            document.body.appendChild(alertContainer);
            setTimeout(() => alertContainer.remove(), 5000);
            return;
        }
        
        const existingAlert = step.querySelector('.alert-temp');
        if (existingAlert) existingAlert.remove();

        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-temp`;
        alertDiv.textContent = message;
        step.insertBefore(alertDiv, step.firstChild);
        setTimeout(() => alertDiv.remove(), 5000);
    }
    function formatDate(dateString) {
        if (!dateString) return '';
        // Add T00:00:00 to handle potential timezone issues
        return new Date(dateString + 'T00:00:00').toLocaleDateString('tr-TR');
    }
    
    function copyToClipboard(text) {
        const textToCopy = text.includes('TR') ? text.replace(/\s/g, '') : text;

        const textArea = document.createElement("textarea");
        textArea.style.position = 'fixed';
        textArea.style.top = '-9999px';
        textArea.style.left = '-9999px';
        textArea.value = textToCopy;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            showAlert(`"${text}" panoya kopyalandÄ±!`, 'success');
        } catch (err) {
            showAlert('KopyalanamadÄ±!', 'danger');
        }
        document.body.removeChild(textArea);
    }

    // Initial setup
    showStep(1);
    
    // âœ… DoÄŸum tarihi alanlarÄ±na max deÄŸeri (bugÃ¼n) ayarla
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('birthDate').setAttribute('max', today);
    const minorDobField = document.getElementById('minorDob');
    if (minorDobField) minorDobField.setAttribute('max', today);
</script>
</body>
</html>


