<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sporcum - Yönetim Paneli</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Ccircle cx=%2750%27 cy=%2750%27 r=%2748%27 fill=%27%234f46e5%27/%3E%3Ctext x=%2750%27 y=%2772%27 font-family=%27Arial,sans-serif%27 font-size=%2760%27 font-weight=%27bold%27 fill=%27white%27 text-anchor=%27middle%27%3ES%3C/text%3E%3C/svg%3E">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- PDF Libraries -->
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ✅ INLINE SUPABASE HELPER - CACHE SORUNU ÇÖZÜMÜ
        console.log('%c🚀 INLINE SUPABASE HELPER YÜKLENDI!', 'background: #00ff00; color: #000; font-size: 20px; font-weight: bold; padding: 10px;');
        
        let supabaseClient = null;
        let currentUser = null;
        let currentClubId = null;

        function initSupabase(url, anonKey) {
            supabaseClient = window.supabase.createClient(url, anonKey);
            return supabaseClient;
        }

        const auth = {
            async signInWithEmailAndPassword(email, password) {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                currentUser = data.user;
                return { user: data.user };
            },
            async signOut() {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                currentUser = null;
            },
            async onAuthStateChanged(callback) {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    callback(session.user);
                }
                const { data: authListener } = supabaseClient.auth.onAuthStateChange((event, session) => {
                    currentUser = session?.user || null;
                    callback(session?.user || null);
                });
                return authListener;
            },
            async getCurrentUser() {
                const { data: { user } } = await supabaseClient.auth.getUser();
                currentUser = user;
                return user;
            }
        };

        const db = {
            collection(tableName) {
                return { tableName, query: supabaseClient.from(tableName) };
            },
            async getDocs(collectionRef, queryOptions = {}) {
                let query = supabaseClient.from(collectionRef.tableName).select('*');
                if (queryOptions.where) {
                    for (const condition of queryOptions.where) {
                        const [field, operator, value] = condition;
                        switch (operator) {
                            case '==': query = query.eq(field, value); break;
                            case '!=': query = query.neq(field, value); break;
                            case '>': query = query.gt(field, value); break;
                            case '>=': query = query.gte(field, value); break;
                            case '<': query = query.lt(field, value); break;
                            case '<=': query = query.lte(field, value); break;
                            case 'in': query = query.in(field, value); break;
                            case 'array-contains': query = query.contains(field, [value]); break;
                        }
                    }
                }
                if (queryOptions.orderBy) {
                    const [field, direction = 'asc'] = queryOptions.orderBy;
                    query = query.order(field, { ascending: direction === 'asc' });
                }
                if (queryOptions.limit) query = query.limit(queryOptions.limit);
                const { data, error } = await query;
                if (error) throw error;
                const docs = data.map(doc => ({ id: doc.id, data: () => doc, exists: () => true }));
                return { docs: docs, size: data.length, empty: data.length === 0, docChanges: () => docs.map(doc => ({ type: 'added', doc: doc })) };
            },
            async getDoc(docRef) {
                const { data, error } = await supabaseClient.from(docRef.tableName).select('*').eq('id', docRef.id).maybeSingle();
                if (error) throw error;
                return { id: docRef.id, data: () => data || {}, exists: () => !!data };
            },
            async addDoc(collectionRef, data) {
                if (currentClubId && !data.clubId) data.clubId = currentClubId;
                if (!data.id) data.id = `${collectionRef.tableName}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const { data: result, error } = await supabaseClient.from(collectionRef.tableName).insert([data]).select().maybeSingle();
                if (error) throw error;
                return { id: result.id, data: () => result };
            },
            async updateDoc(docRef, data) {
                console.log('🔧 updateDoc called:', { table: docRef.tableName, id: docRef.id, dataKeys: Object.keys(data) });
                const processedData = {};
                for (const [key, value] of Object.entries(data)) {
                    if (value && typeof value === 'object' && value._type) {
                        console.log(`🔍 Array operation: ${value._type} on "${key}"`);
                        const { data: currentDoc } = await supabaseClient.from(docRef.tableName).select(key).eq('id', docRef.id).maybeSingle();
                        console.log(`📥 Current ${key}:`, currentDoc?.[key]);
                        let currentArray = currentDoc?.[key] || [];
                        if (!Array.isArray(currentArray)) currentArray = [];
                        if (value._type === 'arrayUnion') {
                            const newElements = value.elements.filter(el => !currentArray.includes(el));
                            processedData[key] = [...currentArray, ...newElements];
                            console.log(`➕ arrayUnion: Adding ${newElements.length} elements to ${key}`);
                        } else if (value._type === 'arrayRemove') {
                            processedData[key] = currentArray.filter(el => !value.elements.includes(el));
                            console.log(`➖ arrayRemove: Removing ${value.elements.length} elements from ${key}`);
                        }
                    } else {
                        processedData[key] = value;
                    }
                }
                console.log('📤 Sending to Supabase:', processedData);
                const { data: result, error } = await supabaseClient.from(docRef.tableName).update(processedData).eq('id', docRef.id).select().maybeSingle();
                if (error) { console.error('❌ Supabase error:', error); throw error; }
                console.log('✅ Update successful:', result);
                return result;
            },
            async deleteDoc(docRef) {
                const { error } = await supabaseClient.from(docRef.tableName).delete().eq('id', docRef.id);
                if (error) throw error;
            },
            async setDoc(docRef, data) {
                data.id = docRef.id;
                const { data: result, error } = await supabaseClient.from(docRef.tableName).upsert([data], { onConflict: 'id' }).select().maybeSingle();
                if (error) throw error;
                return result;
            },
            doc(tableName, id) {
                return { tableName, id };
            },
            query(collectionRef, ...conditions) {
                const queryOptions = { where: [], orderBy: null, limit: null };
                conditions.forEach(condition => {
                    if (condition.type === 'where') queryOptions.where.push([condition.field, condition.operator, condition.value]);
                    else if (condition.type === 'orderBy') queryOptions.orderBy = [condition.field, condition.direction];
                    else if (condition.type === 'limit') queryOptions.limit = condition.value;
                });
                return { ...collectionRef, queryOptions };
            },
            onSnapshot(collectionRef, callback, errorCallback) {
                const tableName = collectionRef.tableName;
                let previousDocs = [];
                const createSnapshot = (docs) => {
                    const changes = [];
                    const previousIds = new Set(previousDocs.map(d => d.id));
                    const currentIds = new Set(docs.map(d => d.id));
                    docs.forEach(doc => {
                        if (!previousIds.has(doc.id)) changes.push({ type: 'added', doc: doc });
                        else {
                            const prev = previousDocs.find(d => d.id === doc.id);
                            if (prev && JSON.stringify(prev.data()) !== JSON.stringify(doc.data())) changes.push({ type: 'modified', doc: doc });
                        }
                    });
                    previousDocs.forEach(doc => { if (!currentIds.has(doc.id)) changes.push({ type: 'removed', doc: doc }); });
                    previousDocs = docs;
                    return { docs: docs, size: docs.length, empty: docs.length === 0, docChanges: () => changes };
                };
                this.getDocs(collectionRef, collectionRef.queryOptions || {}).then(result => callback(createSnapshot(result.docs))).catch(err => errorCallback && errorCallback(err));
                const subscription = supabaseClient.channel(`public:${tableName}`).on('postgres_changes', { event: '*', schema: 'public', table: tableName }, (payload) => {
                    this.getDocs(collectionRef, collectionRef.queryOptions || {}).then(result => callback(createSnapshot(result.docs))).catch(err => errorCallback && errorCallback(err));
                }).subscribe();
                return () => { subscription.unsubscribe(); };
            }
        };

        function where(field, operator, value) { return { type: 'where', field, operator, value }; }
        function orderBy(field, direction = 'asc') { return { type: 'orderBy', field, direction }; }
        function limit(value) { return { type: 'limit', value }; }
        const arrayUnion = (...elements) => ({ _type: 'arrayUnion', elements });
        const arrayRemove = (...elements) => ({ _type: 'arrayRemove', elements });
        function setCurrentClubId(clubId) { currentClubId = clubId; }

        window.supabaseHelper = { initSupabase, auth, db, where, orderBy, limit, arrayUnion, arrayRemove, setCurrentClubId };
    </script>
    <script type="module">
        // IMPORTANT: Replace with your actual Supabase configuration
        const SUPABASE_URL = 'https://supabase.edu-ai.online';
        const SUPABASE_ANON_KEY = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJzdXBhYmFzZSIsImlhdCI6MTc2MjEwNTMyMCwiZXhwIjo0OTE3Nzc4OTIwLCJyb2xlIjoiYW5vbiJ9.HXUza0GT82-trWkx0WWKe-nY7KsGrIjIHSOJPKsOHjs';
        
        // Initialize Supabase
        const supabase = window.supabaseHelper.initSupabase(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Create Firebase-compatible API wrappers (zaten inline helper'da tanımlı, tekrar kullan)
        // const auth = window.supabaseHelper.auth; // Zaten line 28'de tanımlı
        // const db = window.supabaseHelper.db; // Zaten line 59'da tanımlı
        
        // Make available globally (for compatibility with existing code)
        window.db = db;
        window.auth = auth;
        window.supabase = supabase;
        window.firebase = {
            // collection() 1 veya 2 parametre alabilir (Firebase uyumluluğu için)
            collection: (dbRefOrName, collectionName) => {
                const tableName = collectionName || dbRefOrName;
                return db.collection(tableName);
            },
            addDoc: (collectionRef, data) => db.addDoc(collectionRef, data),
            // getDocs() queryOptions'ı da geçmeli
            getDocs: (collectionRef) => db.getDocs(collectionRef, collectionRef.queryOptions),
            getDoc: (docRef) => db.getDoc(docRef),
            updateDoc: (docRef, data) => db.updateDoc(docRef, data),
            deleteDoc: (docRef) => db.deleteDoc(docRef),
            // doc() 2 veya 3 parametre alabilir
            doc: (dbRefOrName, collectionOrId, id) => {
                const tableName = id ? collectionOrId : dbRefOrName;
                const docId = id || collectionOrId;
                return db.doc(tableName, docId);
            },
            onSnapshot: (collectionRef, callback, errorCallback) => db.onSnapshot(collectionRef, callback, errorCallback),
            query: (collectionRef, ...conditions) => db.query(collectionRef, ...conditions),
            where: window.supabaseHelper.where,
            orderBy: window.supabaseHelper.orderBy,
            limit: window.supabaseHelper.limit,
            arrayUnion: window.supabaseHelper.arrayUnion,
            arrayRemove: window.supabaseHelper.arrayRemove,
            setDoc: (docRef, data) => db.setDoc(docRef, data)
        };

        // --- GLOBAL STATE ---
        let currentSection = 'dashboard', preRegistrations = [], members = [], schedules = [], groups = [], holidays = [], users = [], attendanceRecords = [], tasks = [], isLoading = false;
        let clubSettings = { 
            clubName: 'Sporcum',
            // ✅ Random bekleme süresi ayarları
            minWaitTime: 20,
            maxWaitTime: 50,
            longWaitTrigger: 100,
            minLongWait: 400,
            maxLongWait: 800
        };
        let branches = []; // Branşlar listesi (kulüp bazında)
        let paymentFilter = 'all'; // Default payment filter
        let selectedBranchForGroups = null;
        let selectedBranchForSchedule = null;
        // currentUser ve currentClubId zaten inline helper'da tanımlı (line 20-21)
        
        // CRM için global state
        let crmLeads = []; // Potansiyel müşteriler
        
        // ✅ Bildirim gösterilmiş mesaj ID'lerini takip et
        let notifiedMessageIds = new Set();
        let notifiedWhatsAppMessages = new Set();
        let deletedCalls = []; // Silinen çağrılar (localStorage'da saklanıyor - kalıcı)
        let hiddenCalls = []; // Gizlenen çağrılar
        let showDeletedCalls = false; // Silinenleri göster/gizle
        let selectedIncomingCalls = new Set(); // Seçili gelen aramalar
        let selectedOutgoingCalls = new Set(); // Seçili giden aramalar
        
        // Silinen çağrıları localStorage'dan yükle
        function loadDeletedCalls() {
            try {
                const stored = localStorage.getItem(`deletedCalls_${currentClubId}`);
                if (stored) {
                    deletedCalls = JSON.parse(stored);
                }
            } catch (error) {
                console.error('Silinen çağrılar yüklenirken hata:', error);
                deletedCalls = [];
            }
        }
        
        // Silinen çağrıları localStorage'a kaydet
        function saveDeletedCalls() {
            try {
                localStorage.setItem(`deletedCalls_${currentClubId}`, JSON.stringify(deletedCalls));
            } catch (error) {
                console.error('Silinen çağrılar kaydedilirken hata:', error);
            }
        }
        let crmTemplates = []; // CRM mesaj şablonları
        let messageTemplates = {}; // ✅ Mesaj şablonları (birthday, payment, absence, vb.)
        let crmStatuses = [
            { id: 'new', name: 'Yeni', icon: '🆕', color: '#4CAF50' },
            { id: 'contacted', name: 'İletişime Geçildi', icon: '📞', color: '#2196F3' },
            { id: 'trial', name: 'Deneme Randevusu', icon: '🎾', color: '#FF9800' },
            { id: 'negotiating', name: 'Görüşme Aşamasında', icon: '💬', color: '#9C27B0' },
            { id: 'converted', name: 'Üye Oldu', icon: '✅', color: '#4CAF50' },
            { id: 'lost', name: 'Kayıp', icon: '❌', color: '#F44336' }
        ];
        let ageSortDirection = 'none'; // 'none', 'asc', 'desc'
        let membersCurrentPage = 1;
        let membersItemsPerPage = 10;
        let whatsappDevices = []; // WhatsApp devices stored in Firebase
        let defaultWhatsAppDevice = null; // Default device for notifications
        let selectedWhatsAppDevice = null; // Currently selected WhatsApp device
        let sentMessages = []; // Message history
        let userActivities = []; // User activity logs
        let incomingMessages = []; // Incoming WhatsApp messages from webhook
        let autoRefreshInterval = null; // Auto-refresh interval
        let lastMessageSentTime = 0; // ✅ Track last message sent time for rate limiting
        let totalMessagesSent = 0; // ✅ Track total messages sent in session for long wait triggers
        
        // ✅ Cache functions for ultra-fast loading
        function applyDataFromCache(data) {
            preRegistrations = data.preRegistrations || [];
            members = data.members || [];
            schedules = data.schedules || [];
            groups = data.groups || [];
            holidays = data.holidays || [];
            users = data.users || [];
            attendanceRecords = data.attendanceRecords || [];
            clubSettings = data.clubSettings || {};
            tasks = data.tasks || [];
            whatsappDevices = data.whatsappDevices || [];
            defaultWhatsAppDevice = data.defaultWhatsAppDevice || null;
            sentMessages = data.sentMessages || [];
            userActivities = data.userActivities || [];
            branches = data.branches || [];
            incomingMessages = data.incomingMessages || [];
            crmLeads = data.crmLeads || [];
            hiddenCalls = data.hiddenCalls || [];
            
            // UI güncelle
            const clubName = clubSettings.clubName || currentUser.clubName || 'Sporcum';
            document.getElementById('club-title').textContent = clubName;
            const clubTitleHeader = document.getElementById('club-title-header');
            if (clubTitleHeader) clubTitleHeader.textContent = `${clubName} - Yönetim Paneli`;
            document.title = `${clubName} - Yönetim Paneli`;
            
            updateBranchDropdowns();
            updateCRMMenuVisibility();
            renderCurrentSection();
            
            // Dashboard'ı hemen güncelle (cache'ten veri geldiğinde)
            if (currentSection === 'dashboard') {
                updateDashboard();
            }
        }
        
        function updateCRMMenuVisibility() {
            // CRM menüsü her zaman görünür - Erişim kontrolü içerikte yapılacak
            const crmMenuDropdown = document.getElementById('crm-menu-dropdown');
            if (crmMenuDropdown) {
                crmMenuDropdown.style.display = 'block';
            }
        }
        
        function saveDataToCache() {
            const cacheKey = `clubData_${currentClubId}`;
            const data = {
                timestamp: Date.now(),
                preRegistrations,
                members,
                schedules,
                groups,
                holidays,
                users,
                attendanceRecords,
                clubSettings,
                tasks,
                whatsappDevices,
                defaultWhatsAppDevice,
                sentMessages,
                userActivities,
                branches,
                incomingMessages,
                crmLeads,
                hiddenCalls
            };
            
            try {
                localStorage.setItem(cacheKey, JSON.stringify(data));
                console.log('💾 Data cached successfully');
            } catch (e) {
                console.warn('⚠️ Cache save error:', e);
                if (e.name === 'QuotaExceededError') {
                    // Storage full, temizle
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('clubData_') && key !== cacheKey) {
                            localStorage.removeItem(key);
                        }
                    }
                }
            }
        }


        // --- AUTHENTICATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            // ✅ Check if user came from giris.html with valid session
            const sessionUser = sessionStorage.getItem('currentUser');
            const userType = sessionStorage.getItem('userType');
            
            if (sessionUser && userType === 'admin') {
                // User logged in from giris.html, skip login screen
                try {
                    currentUser = JSON.parse(sessionUser);
                    currentClubId = currentUser.clubId; // Set club ID from user data
                    window.supabaseHelper.setCurrentClubId(currentClubId); // ✅ Set for Supabase queries
                    
                    // ✅ Supabase'den branches bilgisini yükle
                    try {
                        const { data: supabaseUser, error } = await supabase
                            .from('users')
                            .select('branches, pageAccess, role, "isSuperAdmin"')
                            .eq('id', currentUser.uid || currentUser.id)
                            .single();
                        
                        if (!error && supabaseUser) {
                            currentUser.branches = supabaseUser.branches;
                            currentUser.pageAccess = supabaseUser.pageAccess;
                            currentUser.role = supabaseUser.role;
                            currentUser.isSuperAdmin = supabaseUser.isSuperAdmin;
                            
                            console.log('✅ User data loaded from Supabase:', {
                                branches: currentUser.branches,
                                pageAccess: currentUser.pageAccess,
                                role: currentUser.role,
                                isSuperAdmin: currentUser.isSuperAdmin
                            });
                        } else if (error) {
                            console.warn('⚠️ Supabase user query error:', error.message);
                        }
                    } catch (branchError) {
                        console.warn('⚠️ Branches yüklenemedi:', branchError);
                    }
                    
                    if (!currentClubId) {
                        alert('❌ Bu kullanıcı bir kulübe atanmamış! Lütfen SuperAdmin ile iletişime geçin.');
                        sessionStorage.clear();
                        window.location.replace('giris');
                        return;
                    }
                    
                    console.log('✅ Session found, auto-login:', currentUser.email || currentUser.fullName);
                    console.log('🏢 Club ID:', currentClubId, '- Club Name:', currentUser.clubName);
                    
                    // ✅ Kulüp ismini hemen set et (Supabase'den gelene kadar geçici)
                    if (currentUser.clubName) {
                        document.getElementById('club-title').textContent = currentUser.clubName;
                    }
                    
                    // ✅ Loading ekranını kaldır
                    const loadingScreen = document.getElementById('loadingScreen');
                    if (loadingScreen) {
                        loadingScreen.classList.add('hide');
                        setTimeout(() => loadingScreen.remove(), 300);
                    }
                    
                    // Start app directly (no login overlay needed)
                    startApp();
                    return;
                } catch (error) {
                    console.error('Session parse error:', error);
                    sessionStorage.clear();
                }
            }
            
            // ❌ No valid session, redirect to login page (sayfayı göstermeden!)
            console.log('❌ No valid admin session found, redirecting to giris...');
            sessionStorage.clear();
            
            // Mevcut sayfayı return URL olarak kaydet
            const returnUrl = window.location.pathname + window.location.search;
            window.location.replace('giris?return=' + encodeURIComponent(returnUrl));
        });


        function handleLogout() {
            console.log('🚪 Logging out...');
            
            // Stop auto-refresh
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('✅ Auto-refresh stopped');
            }
            
            // Clear cache for this club
            if (currentClubId) {
                const cacheKey = `clubData_${currentClubId}`;
                localStorage.removeItem(cacheKey);
                console.log('✅ Cache cleared');
            }
            
            // Clear ALL storage
            sessionStorage.clear();
            console.log('✅ Storage cleared');
            
            currentUser = null;
            currentClubId = null;
            
            // Force redirect to login page
            console.log('✅ Redirecting to login...');
            window.location.replace('giris');
        }

        async function startApp() {
            if (!window.firebase || !window.db) return showAlert('Firebase bağlantısı kurulamadı.', 'danger');
            
            console.log('🚀 Starting app...');
            const appStartTime = performance.now();
            
            // ✅ Kürşat'ı muted listesine ekle (05424096336)
            const mutedPhones = JSON.parse(localStorage.getItem('mutedWhatsAppConversations') || '[]');
            if (!mutedPhones.includes('05424096336')) {
                mutedPhones.push('05424096336');
                localStorage.setItem('mutedWhatsAppConversations', JSON.stringify(mutedPhones));
                console.log('🔇 Kürşat (05424096336) sessiz konuşmalar listesine eklendi');
            }
            
            // Display user name safely
            const displayName = currentUser?.fullName || currentUser?.email || 'Yönetici';
            document.querySelector('.current-user-display').textContent = `Hoşgeldiniz, ${displayName}`;
            
            applyRolePermissions();
            
            // 🚀 HIZLI BAŞLANGIÇ - Sadece minimum veri yükle
            await loadData(true, true); // quickStart mode = true
            
            setupEventListeners();
            // Initial setup for the form
            toggleParentStudentFields(document.getElementById('preRegistrationForm'));
            
            const appEndTime = performance.now();
            const appLoadTime = (appEndTime - appStartTime).toFixed(2);
            console.log(`🎉 App ready in ${appLoadTime}ms`);
            
            // ✅ Loading ekranını kaldır (eğer hala varsa)
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.classList.add('hide');
                setTimeout(() => loadingScreen.remove(), 300);
            }
            
            // 🔄 ARKA PLAN - Diğer her şeyi yükle
            setTimeout(async () => {
                console.log('📦 Arka plan yüklemeleri başlıyor...');
                
                await Promise.all([
                    loadMessageTemplates(),
                    loadClubInfo(),
                    loadWhatsAppBalance() // WhatsApp bakiyesini yükle
                ]);
                
                // Bildirim izni iste ve otomatik kontrolü başlat
                requestNotificationPermission();
                startMissedCallsAutoCheck();
                
                // Dashboard ve CRM istatistik görünürlüğünü kontrol et
                checkDashboardAmountsVisibility();
                checkPaymentVisibility();
                
                console.log('✅ Arka plan yüklemeleri tamamlandı');
            }, 50);
        }
        
        // WhatsApp'ı otomatik başlat (connected cihaz varsa)
        async function autoStartWhatsApp() {
            // Kısa bir gecikme ile Cihazların yüklenmesini bekle
            setTimeout(async () => {
                if (whatsappDevices && whatsappDevices.length > 0) {
                    // ✅ Connected cihaz bul (status veya isConnected)
                    const connectedDevice = whatsappDevices.find(d => 
                        d.status === 'connected' || d.isConnected === true
                    );
                    
                    if (connectedDevice) {
                        console.log('📱 WhatsApp otomatik başlatılıyor:', connectedDevice.instanceName);
                        
                        // Cihazı seç
                        selectedWhatsAppDevice = connectedDevice;
                        
                        // ✅ Dropdown'ı güncelle (varsa) - biraz bekle ki render olsun
                        setTimeout(() => {
                            const deviceSelect = document.getElementById('whatsapp-active-device');
                            if (deviceSelect) {
                                deviceSelect.value = connectedDevice.instanceName;
                                console.log('✅ WhatsApp cihazı dropdown\'da seçildi:', connectedDevice.instanceName);
                                
                                // Cihaz seçimini trigger et (messaging area'yı açmak için)
                                if (window.onDeviceSelectionChange) {
                                    window.onDeviceSelectionChange();
                                }
                            } else {
                                console.warn('⚠️ whatsapp-active-device bulunamadı (WhatsApp sayfası açık değil)');
                            }
                        }, 1500); // 1.5 saniye bekle (WhatsApp sayfası render olsun)
                        
                        // 🔥 Firebase realtime listeners başlat (öncelik - anlık bildirimler)
                        if (window.startWhatsAppRealtimeListeners) {
                            startWhatsAppRealtimeListeners();
                            console.log('🔥 WhatsApp realtime listeners başlatıldı');
                        }
                        
                        // Kontaktları yükle (bu ilk yükleme bildirimi tetikleyecek)
                        await loadWhatsAppContacts();
                        
                        // ⏱️ Fallback polling başlat (5 saniyede bir - daha hızlı)
                        if (window.startWhatsAppAutoRefresh) {
                            startWhatsAppAutoRefresh();
                            console.log('⏱️ WhatsApp fallback polling başlatıldı (5 saniye)');
                        }
                        
                        console.log('✅ WhatsApp otomatik başlatıldı ve bildirimler hazır');
                    } else {
                        console.log('ℹ️ Bağlı WhatsApp cihazı yok, bildirimler devre dışı');
                    }
                } else {
                    console.log('ℹ️ WhatsApp cihazı bulunamadı');
                }
            }, 500);
        }
        
        function setupEventListeners() {
            // ✅ AudioContext'i ilk kullanıcı tıklamasında başlat (tarayıcı izni için)
            document.addEventListener('click', function initAudioContext() {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('🔊 AudioContext kullanıcı tıklaması ile başlatıldı');
                }
                // Bir kez başlatınca listener'ı kaldır
                document.removeEventListener('click', initAudioContext);
            }, { once: true });
            
            // ✅ Çıkış butonu
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
                console.log('✅ Logout button initialized');
            }
            
            // ✅ Sidebar logout button
            const logoutBtnSidebar = document.getElementById('logout-btn-sidebar');
            if (logoutBtnSidebar) {
                logoutBtnSidebar.addEventListener('click', handleLogout);
            }
            
            document.getElementById('preRegistrationForm').addEventListener('submit', (e) => handleRegistration(e, 'pending'));
            
            document.getElementById('paymentForm').addEventListener('submit', handlePayment);
            document.getElementById('newScheduleForm').addEventListener('submit', handleNewSchedule);
            document.getElementById('groupForm').addEventListener('submit', handleGroup);
            document.getElementById('memberEditForm').addEventListener('submit', handleMemberUpdate);
            document.getElementById('preRegEditForm').addEventListener('submit', handlePreRegUpdate);
            document.getElementById('attendanceForm').addEventListener('submit', handleAttendanceSubmit);
            document.getElementById('settingsForm').addEventListener('submit', handleSettingsUpdate);
            document.getElementById('userForm').addEventListener('submit', handleUserSubmit);
            document.getElementById('userEditForm').addEventListener('submit', handleUserUpdate);
            document.getElementById('branchAssignForm').addEventListener('submit', handleBranchAssign);
            document.getElementById('taskForm').addEventListener('submit', handleTaskSubmit);
            document.getElementById('taskMessageForm').addEventListener('submit', sendTaskMessage);
            document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);
            // WhatsApp instance form moved to devices tab
            const whatsappInstanceForm = document.getElementById('whatsappInstanceForm-new');
            if (whatsappInstanceForm) {
                whatsappInstanceForm.addEventListener('submit', handleWhatsAppInstanceCreate);
            }
            
            document.getElementById('memberTypePre').addEventListener('change', () => toggleParentStudentFields(document.getElementById('preRegistrationForm')));
            
            document.getElementById('memberSearch').addEventListener('input', () => {
                membersCurrentPage = 1;
                renderMembersTable();
            });
            document.getElementById('paymentSearch').addEventListener('input', () => renderPaymentsList());
            document.getElementById('groupSearch').addEventListener('input', () => renderGroupsList());

            document.querySelector('#userForm [name="phone"]').addEventListener('input', (e) => {
                const phone = e.target.value.replace(/\D/g, '');
                e.target.value = phone;
                document.querySelector('#userForm [name="username"]').value = phone;
            });
            
            document.querySelector('#userEditForm [name="phone"]').addEventListener('input', (e) => {
                const phone = e.target.value.replace(/\D/g, '');
                e.target.value = phone;
            });
            
            document.querySelector('#profileForm [name="phone"]').addEventListener('input', (e) => {
                const phone = e.target.value.replace(/\D/g, '');
                e.target.value = phone;
            });
            
            // --- Searchable Group Dropdown Logic ---
            const preRegBranchSelect = document.getElementById('preRegBranchPre');
            const groupSearchInput = document.getElementById('preRegGroupSearch');
            const groupHiddenInput = document.getElementById('preRegGroupId');
            const groupResultsContainer = document.getElementById('preRegGroupResults');
            let availableGroupsForSearch = [];

            preRegBranchSelect.addEventListener('change', (e) => {
                const branch = e.target.value;
                groupSearchInput.value = '';
                groupHiddenInput.value = '';
                groupResultsContainer.innerHTML = '';
                if(branch) {
                    const actualGroups = groups.filter(g => {
                         const memberCount = members.filter(m => Array.isArray(g.members) && g.members.includes(m.id) && m.status !== 'expired').length;
                         return g.branch === branch && memberCount < g.maxMembers;
                    });
                    availableGroupsForSearch = actualGroups;
                    groupSearchInput.disabled = false;
                    groupSearchInput.placeholder = "Grup ara...";
                } else {
                    availableGroupsForSearch = [];
                    groupSearchInput.disabled = true;
                    groupSearchInput.placeholder = "Önce branş seçin";
                }
            });

            groupSearchInput.addEventListener('input', () => {
                const searchTerm = groupSearchInput.value.toLowerCase();
                groupHiddenInput.value = ''; // Clear hidden ID if user types again
                const filtered = availableGroupsForSearch.filter(g => g.groupName.toLowerCase().includes(searchTerm));
                
                groupResultsContainer.innerHTML = filtered.length > 0 ? filtered.map(g => {
                    const memberCount = members.filter(m => Array.isArray(g.members) && g.members.includes(m.id) && m.status !== 'expired').length;
                    return `<div class="searchable-select-item" data-id="${g.id}" data-name="${g.groupName}">${g.groupName} - (${memberCount}/${g.maxMembers})</div>`
                }).join('') : '<div class="searchable-select-item disabled">Sonuç bulunamadı</div>';
                groupResultsContainer.classList.add('active');
            });

            groupResultsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('searchable-select-item') && e.target.dataset.id) {
                    groupHiddenInput.value = e.target.dataset.id;
                    groupSearchInput.value = e.target.dataset.name;
                    groupResultsContainer.classList.remove('active');
                }
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.searchable-select-container')) {
                    groupResultsContainer.classList.remove('active');
                }
            });

            // Generic setup for form inputs
            const form = document.getElementById('preRegistrationForm');
            form.querySelector('[name="phone"]').addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '');
            });
            form.querySelector('[name="phone2"]').addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '');
            });
            const previewInputs = ['firstPeriodStart', 'firstPeriodEnd', 'firstInstallmentAmount', 'firstDueDate', 'installments', 'subsequentInstallmentAmount', 'dueDay', 'firstLessonCount'];
            previewInputs.forEach(id => {
                const element = form.querySelector(`[name=${id}]`);
                if(element) element.addEventListener('input', () => previewPaymentPlan(form));
            });
            const dateInputs = ['firstPeriodStart', 'firstPeriodEnd'];
            dateInputs.forEach(id => {
                form.querySelector(`[name=${id}]`).addEventListener('change', () => autoCalculateLessonCount(form));
            });
            const today = getTodayString();
            form.querySelector('[name="firstPeriodStart"]').value = today;
            form.querySelector('[name="firstDueDate"]').value = today;

            // Set max date for birth date fields (today)
            const studentBirthDatePre = document.getElementById('studentBirthDatePre');
            if (studentBirthDatePre) studentBirthDatePre.setAttribute('max', today);
            
            const studentBirthdates = document.querySelectorAll('.student-birthdate');
            studentBirthdates.forEach(field => field.setAttribute('max', today));

            // Currency formatting listeners
            document.querySelector('#preRegistrationForm [name="firstInstallmentAmount"]').addEventListener('input', (e) => formatCurrency(e.target));
            document.querySelector('#preRegistrationForm [name="subsequentInstallmentAmount"]').addEventListener('input', (e) => formatCurrency(e.target));
            document.querySelector('#paymentForm [name="paymentAmount"]').addEventListener('input', (e) => formatCurrency(e.target));


            // Close modal on outside click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });
            
            // Close actions menu on outside click
            document.addEventListener('click', (e) => closeAllMenus(e));
            
            // WhatsApp forms
            const whatsappNewForm = document.getElementById('whatsappInstanceForm-new');
            if (whatsappNewForm) {
                whatsappNewForm.addEventListener('submit', handleWhatsAppInstanceCreate);
            }
            
            const whatsappSendForm = document.getElementById('whatsappSendMessageForm');
            if (whatsappSendForm) {
                whatsappSendForm.addEventListener('submit', handleWhatsAppSendMessage);
            }
            
            const bulkMessageForm = document.getElementById('bulkMessageForm');
            if (bulkMessageForm) {
                bulkMessageForm.addEventListener('submit', handleBulkMessageSend);
            }
            
            const contactSearch = document.getElementById('contact-search');
            if (contactSearch) {
                contactSearch.addEventListener('input', (e) => {
                    renderWhatsAppContactsList(e.target.value);
                });
            }
            
            const bulkBranchSelector = document.getElementById('bulk-branch-selector');
            if (bulkBranchSelector) {
                bulkBranchSelector.addEventListener('change', onBulkBranchChange);
            }
        }

        // ✅ Pasif üyeleri gruplardan otomatik temizle
        async function cleanupExpiredMembersFromGroups() {
            try {
                const expiredMemberIds = members.filter(m => m.status === 'expired').map(m => m.id);
                if (expiredMemberIds.length === 0) return;
                
                let updatedGroupsCount = 0;
                
                for (const group of groups) {
                    if (!group.members || group.members.length === 0) continue;
                
                    const originalMemberCount = group.members.length;
                    const cleanedMembers = group.members.filter(memberId => !expiredMemberIds.includes(memberId));
                    
                    if (cleanedMembers.length < originalMemberCount) {
                        await window.firebase.updateDoc(
                            window.firebase.doc(window.db, 'groups', group.id),
                            { members: cleanedMembers }
                        );
                        updatedGroupsCount++;
                        group.members = cleanedMembers; // Update local cache
                        console.log(`🧹 Grup "${group.groupName}"dan ${originalMemberCount - cleanedMembers.length} pasif üye temizlendi`);
                    }
                }
                
                if (updatedGroupsCount > 0) {
                    console.log(`✅ Toplamda ${updatedGroupsCount} gruptan pasif üyeler temizlendi`);
                }
            } catch (error) {
                console.error('❌ Pasif üyeleri temizlerken hata:', error);
            }
        }

        // Sessiz yenileme - değişiklik varsa yenile
        async function checkAndRefreshIfNeeded() {
            try {
                const currentClubId = window.currentClubId;
                if (!currentClubId) return;
                
                // Mevcut veri sayılarını sakla
                const oldCounts = {
                    members: members.length,
                    preRegistrations: preRegistrations.length,
                    crmLeads: crmLeads.length
                };
                
                // Firestore'dan güncel sayıları al (sessizce)
                const [membersSnapshot, preRegsSnapshot, crmLeadsSnapshot] = await Promise.all([
                    getDocs(query(collection(window.db, 'members'), where('clubId', '==', currentClubId))),
                    getDocs(query(collection(window.db, 'preRegistrations'), where('clubId', '==', currentClubId))),
                    getDocs(query(collection(window.db, 'crmLeads'), where('clubId', '==', currentClubId)))
                ]);
                
                const newCounts = {
                    members: membersSnapshot.size,
                    preRegistrations: preRegsSnapshot.size,
                    crmLeads: crmLeadsSnapshot.size
                };
                
                // Değişiklik var mı kontrol et
                const hasChanges = 
                    oldCounts.members !== newCounts.members ||
                    oldCounts.preRegistrations !== newCounts.preRegistrations ||
                    oldCounts.crmLeads !== newCounts.crmLeads;
                
                if (hasChanges) {
                    console.log('🔄 Veri değişikliği tespit edildi, yenileniyor...');
                    await loadData(false); // Cache kullanmadan yenile
                    
                    // Mesaj Kuyruğunu işle
                    await processMessageQueue();
                    
                    // Mevcut section'ı yenile
                    renderCurrentSection();
                } else {
                    console.log('✓ Veri değişikliği yok');
                }
            } catch (error) {
                console.error('Sessiz yenileme hatası:', error);
            }
        }

        // ✅ Timeout wrapper - API çağrılarını timeout'a karşı korur
        async function withTimeout(promise, timeoutMs = 10000, operationName = 'Operation') {
            return Promise.race([
                promise,
                new Promise((_, reject) => 
                    setTimeout(() => reject(new Error(`${operationName} timeout (${timeoutMs}ms)`)), timeoutMs)
                )
            ]);
        }

        // ✅ Retry wrapper - Başarısız işlemleri tekrar dener
        async function withRetry(fn, retries = 2, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    console.warn(`⚠️ Attempt ${i + 1} failed:`, error.message);
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // ================================
        // 🎯 BRANŞ ERİŞİM KONTROLÜ
        // ================================
        
        /**
         * Kullanıcının belirli bir branşa erişim yetkisi olup olmadığını kontrol eder
         * @param {string} branchName - Kontrol edilecek branş adı (örn: "tenis", "futbol")
         * @returns {boolean} - Erişim varsa true, yoksa false
         */
        function canAccessBranch(branchName) {
            // Superadmin her şeyi görebilir
            if (currentUser.isSuperAdmin || currentUser.role === 'superadmin') {
                return true;
            }
            
            // Kullanıcının atanmış branşları yoksa (null/undefined) → tüm branşlara erişim var
            if (!currentUser.branches || !Array.isArray(currentUser.branches) || currentUser.branches.length === 0) {
                return true;
            }
            
            // Branş bilgisi yoksa erişim yok
            if (!branchName) return false;
            
            // ✅ Branş ID veya isim ile karşılaştır
            const normalizedBranch = branchName.toLowerCase().trim();
            
            const hasAccess = currentUser.branches.some(userBranch => {
                const normalizedUserBranch = userBranch.toLowerCase().trim();
                
                // Direkt eşleşme (isim veya ID)
                if (normalizedUserBranch === normalizedBranch) return true;
                
                // branches array'inde ID varsa, branch nesnesini bul
                const branchObj = branches.find(b => 
                    b.id.toLowerCase() === normalizedBranch || 
                    b.name.toLowerCase() === normalizedBranch
                );
                
                if (branchObj) {
                    // Kullanıcının branşı ile ID veya name eşleşmesi kontrol et
                    return branchObj.id.toLowerCase() === normalizedUserBranch || 
                           branchObj.name.toLowerCase() === normalizedUserBranch;
                }
                
                return false;
            });
            
            // İlk çağrıda debug
            if (!window._branchAccessLogged) {
                console.log('🔍 Branch Access Test:', {
                    branchName,
                    normalizedBranch,
                    userBranches: currentUser.branches,
                    hasAccess,
                    availableBranches: branches.map(b => ({ id: b.id, name: b.name }))
                });
                window._branchAccessLogged = true;
            }
            
            return hasAccess;
        }

        /**
         * Veriyi kullanıcının branş yetkileri ile filtreler
         * @param {Array} dataArray - Filtrelenecek veri dizisi
         * @param {string} branchField - Branş bilgisinin tutulduğu alan adı (örn: "Brans", "branch")
         * @returns {Array} - Filtrelenmiş veri dizisi
         */
        function filterByBranch(dataArray, branchField = 'Brans') {
            // Superadmin veya branş kısıtlaması yok → tüm veriyi göster
            if (currentUser.isSuperAdmin || !currentUser.branches || currentUser.branches.length === 0) {
                return dataArray;
            }
            
            // Debug: İlk çağrıda detaylı log
            if (!window._filterByBranchLogged) {
                console.log('🔍 filterByBranch Debug:', {
                    branchField,
                    totalItems: dataArray.length,
                    userBranches: currentUser.branches,
                    sampleItemBranch: dataArray[0]?.[branchField],
                    sampleItem: dataArray[0]
                });
                window._filterByBranchLogged = true;
            }
            
            // Kullanıcının yetkili olduğu branşlara ait verileri filtrele
            const filtered = dataArray.filter(item => {
                const itemBranch = item[branchField];
                if (!itemBranch) return false; // Branş bilgisi yoksa gösterme
                return canAccessBranch(itemBranch);
            });
            
            // İlk çağrıda sonuç logu
            if (!window._filterResultLogged) {
                console.log('✅ filterByBranch Result:', {
                    input: dataArray.length,
                    output: filtered.length,
                    filtered: filtered.slice(0, 3).map(i => ({ name: i.Ad_Soyad || i.Isim || i.name, branch: i[branchField] }))
                });
                window._filterResultLogged = true;
            }
            
            return filtered;
        }

        async function loadData(useCache = true, quickStart = false) {
            if (isLoading && !quickStart) return;
            if (!quickStart) isLoading = true;
            
            if (!currentClubId) {
                console.error('❌ No club ID found!');
                alert('Kulüp bilgisi bulunamadı! Lütfen tekrar giriş yapın.');
                handleLogout();
                return;
            }
            
            const startTime = performance.now();
            
            // ✅ CACHE CHECK - Anında yükleme!
            if (useCache && !quickStart) {
                const cacheKey = `clubData_${currentClubId}`;
                const cachedData = localStorage.getItem(cacheKey);
                if (cachedData) {
                    try {
                        const data = JSON.parse(cachedData);
                        const cacheAge = Date.now() - (data.timestamp || 0);
                        
                        // Cache 5 dakikadan yeniyse kullan
                        if (cacheAge < 300000) { // 5 minutes
                            console.log('⚡ Loading from cache...');
                            applyDataFromCache(data);
                            
                            const cacheTime = performance.now() - startTime;
                            console.log(`💨 Data loaded from cache in ${cacheTime.toFixed(2)}ms`);
                            
                            isLoading = false;
                            
                            // Arka planda fresh data yükle
                            setTimeout(() => loadData(false), 1000);
                            return;
                        }
                    } catch (e) {
                        console.warn('⚠️ Cache parse error:', e);
                    }
                }
            }
            
            // 🚀 QUICK START MODE - Temel bilgiler + members/preRegistrations'ı hemen yükle
            if (quickStart) {
                console.log('🚀 Quick start mode: Dashboard için kritik veriler yükleniyor...');
                try {
                    const { getDoc, doc } = window.firebase;
                    
                    // ✅ Timeout ile critical data yükle (max 8 saniye) - members ve preRegistrations dahil
                    const [clubSettingsResult, clubDataResult, branchesData, membersData, preRegsData, groupsData] = await withTimeout(
                        Promise.all([
                            supabase.from('settings').select('data').eq('id', `club_${currentClubId}`).maybeSingle(),
                            supabase.from('clubs').select('*').eq('id', currentClubId).single(),
                            supabase.from('branches').select('*').eq('clubId', currentClubId).eq('isActive', true).order('branchName', { ascending: true }),
                            supabase.from('members').select('*').eq('clubId', currentClubId),
                            supabase.from('preRegistrations').select('*').eq('clubId', currentClubId),
                            supabase.from('groups').select('*').eq('clubId', currentClubId)
                        ]),
                        8000,
                        'Quick start data loading'
                    );
                    
                    // Temel ayarlar (Supabase'den)
                    if (clubSettingsResult.data && clubSettingsResult.data.data) {
                        clubSettings = clubSettingsResult.data.data;
                        console.log('✅ Club settings yüklendi (Supabase):', clubSettings);
                        
                        // ✅ Ana WhatsApp hattını hemen set et (geriye dönük uyumluluk için her iki ismi de kontrol et)
                        if (clubSettings.defaultWhatsAppDevice || clubSettings.defaultDevice) {
                            defaultWhatsAppDevice = clubSettings.defaultWhatsAppDevice || clubSettings.defaultDevice;
                            console.log('✅ Ana WhatsApp hattı set edildi:', defaultWhatsAppDevice);
                        }
                    } else {
                        console.log('⚠️ Club settings bulunamadı, varsayılan ayarlar kullanılıyor');
                        clubSettings = {};
                    }
                    
                    // CRM durumu ve kulüp adı (Supabase'den)
                    if (clubDataResult && clubDataResult.data) {
                        const clubData = clubDataResult.data;
                        clubSettings.crmEnabled = clubData.crmEnabled !== false;
                        
                        // ✅ Supabase'den kulüp adını al (eğer settings'de yoksa)
                        if (!clubSettings.clubName && clubData.name) {
                            clubSettings.clubName = clubData.name;
                        }
                    }
                    
                    // Kulüp başlığını ayarla
                    const clubName = clubSettings.clubName || currentUser.clubName || 'Sporcum';
                    document.getElementById('club-title').textContent = clubName;
                    const clubTitleHeader = document.getElementById('club-title-header');
                    if (clubTitleHeader) clubTitleHeader.textContent = `${clubName} - Yönetim Paneli`;
                    document.title = `${clubName} - Yönetim Paneli`;
                    
                    // Branşları yükle
                    if (branchesData && branchesData.data && branchesData.data.length > 0) {
                        branches = branchesData.data.map(b => ({
                            id: b.branchId || b.id,
                            name: b.branchName,
                            icon: b.icon || '⚽',
                            color: b.color || '#4A90E2',
                            lessonName: b.lessonName || b.branchName,
                            courts: b.courts || []
                        }));
                    } else {
                        branches = [];
                    }
                    
                    // ✅ Dashboard için kritik verileri hemen yükle
                    members = membersData?.data || [];
                    preRegistrations = preRegsData?.data || [];
                    groups = groupsData?.data || [];
                    crmLeads = []; // CRM arka planda yüklenecek
                    
                    const quickTime = performance.now() - startTime;
                    console.log(`⚡ Quick start tamamlandı: ${quickTime.toFixed(2)}ms`);
                    console.log('📊 Arka planda diğer veriler yükleniyor...');
                    
                    // HEMEN arka planda tam veriyi yükle (secondary data)
                    setTimeout(() => loadData(false, false), 100);
                    
                    return;
                } catch (error) {
                    console.error('❌ Quick start hatası:', error);
                    
                    // ✅ Kullanıcıya bilgi ver
                    showAlert('⚠️ Bağlantı yavaş, tekrar deneniyor...', 'warning');
                    
                    // ✅ Retry ile normal yüklemeye geç
                    try {
                        await withRetry(() => loadData(false, false), 1, 2000);
                        return;
                    } catch (retryError) {
                        console.error('❌ Retry de başarısız:', retryError);
                        showAlert('❌ Veriler yüklenemedi. Lütfen internet bağlantınızı kontrol edin.', 'danger');
                        return;
                    }
                }
            }
            
            try {
                console.log('📊 Loading fresh data for club:', currentClubId);
                const { getDocs, query, collection, orderBy, doc, getDoc, where, limit: queryLimit } = window.firebase;
                
                // ⚡ KRİTİK VERİLER - Önce bunlar yüklensin (hızlı)
                const queryStartTime = performance.now();
                const criticalQueries = [
                    // ✅ SUPABASE: preRegistrations ve members
                    supabase.from('preRegistrations').select('*').eq('clubId', currentClubId),
                    supabase.from('members').select('*').eq('clubId', currentClubId),
                    supabase.from('groups').select('*').eq('clubId', currentClubId), // ✅ SUPABASE
                    supabase.from('settings').select('data').eq('id', `club_${currentClubId}`).maybeSingle(), // ✅ Supabase
                    supabase.from('clubs').select('*').eq('id', currentClubId).single(), // ✅ SUPABASE
                    supabase.from('branches').select('*').eq('clubId', currentClubId).eq('isActive', true)
                ];
                
                // ✅ Timeout ile yükle (max 15 saniye)
                const criticalResults = await withTimeout(
                    Promise.all(criticalQueries),
                    15000,
                    'Critical data loading'
                );
                const criticalTime = performance.now() - queryStartTime;
                console.log(`⚡ Kritik veriler yüklendi: ${criticalTime.toFixed(0)}ms`);
                
                // 📊 SECONDARY VERİLER - Arka planda yüklensin (daha az kritik)
                const secondaryStartTime = performance.now();
                const secondaryQueries = [
                    supabase.from('schedules').select('*').eq('clubId', currentClubId), // ✅ SUPABASE
                    supabase.from('settings').select('data').eq('id', `holidays_${currentClubId}`).maybeSingle(), // ✅ SUPABASE
                    supabase.from('users').select('*').eq('clubId', currentClubId), // ✅ SUPABASE
                    // ✅ TÜM yoklama kayıtları - uye.html ile aynı (limit yok)
                    supabase.from('attendanceRecords').select('*').eq('clubId', currentClubId), // ✅ SUPABASE
                    supabase.from('tasks').select('*').eq('clubId', currentClubId), // ✅ SUPABASE
                    supabase.from('whatsappDevices').select('*').eq('clubId', currentClubId), // ✅ SUPABASE
                    supabase.from('settings').select('data').eq('id', `whatsapp_${currentClubId}`).maybeSingle(), // ✅ SUPABASE
                    // ⚡ LIMIT: Son 50 mesaj yeterli (zaten slice(50) yapıyoruz)
                    supabase.from('sentMessages').select('*').eq('clubId', currentClubId).order('sentAt', { ascending: false }).limit(50), // ✅ SUPABASE (sentAt kolonu)
                    // ⚡ LIMIT: Son 100 aktivite yeterli
                    supabase.from('userActivities').select('*').eq('clubId', currentClubId).order('timestamp', { ascending: false }).limit(100), // ✅ SUPABASE
                    supabase.from('crmLeads').select('*').eq('clubId', currentClubId) // ✅ SUPABASE
                ];
                
                // ✅ Timeout ile yükle (max 20 saniye) - Secondary veriler daha yavaş olabilir
                const secondaryResults = await withTimeout(
                    Promise.all(secondaryQueries),
                    20000,
                    'Secondary data loading'
                );
                const secondaryTime = performance.now() - secondaryStartTime;
                console.log(`📊 İkincil veriler yüklendi: ${secondaryTime.toFixed(0)}ms`);
                
                // Sonuçları birleştir
                const results = [...criticalResults, ...secondaryResults];

                // === KRİTİK VERİLER (0-5) ===
                // ✅ SUPABASE: preRegistrations (artık .docs değil .data)
                const preRegsData = results[0];
                if (preRegsData && preRegsData.data) {
                    preRegistrations = preRegsData.data;
                    preRegistrations.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
                } else {
                    console.error('PreRegistrations yüklenemedi:', preRegsData?.error);
                    preRegistrations = [];
                }
                
                // ✅ SUPABASE: members (artık .docs değil .data)
                const membersData = results[1];
                if (membersData && membersData.data) {
                    members = membersData.data;
                    members.sort((a, b) => new Date(b.registrationDate || b.createdAt || 0) - new Date(a.registrationDate || a.createdAt || 0));
                } else {
                    console.error('Members yüklenemedi:', membersData?.error);
                    members = [];
                }
                
                // ✅ SUPABASE: groups
                const groupsData = results[2];
                if (groupsData && groupsData.data) {
                    groups = groupsData.data;
                } else {
                    console.error('Groups yüklenemedi:', groupsData?.error);
                    groups = [];
                }
                
                // Kulüp ayarları (Supabase)
                const clubSettingsResult = results[3];
                if (clubSettingsResult && clubSettingsResult.data && clubSettingsResult.data.data) {
                    clubSettings = clubSettingsResult.data.data;
                    console.log('✅ Club settings yüklendi (Supabase - full load):', clubSettings);
                    
                    // ✅ Ana WhatsApp hattını hemen set et (geriye dönük uyumluluk için her iki ismi de kontrol et)
                    if (clubSettings.defaultWhatsAppDevice || clubSettings.defaultDevice) {
                        defaultWhatsAppDevice = clubSettings.defaultWhatsAppDevice || clubSettings.defaultDevice;
                        console.log('✅ Ana WhatsApp hattı set edildi (full load):', defaultWhatsAppDevice);
                    }
                } else {
                    console.log('⚠️ Club settings bulunamadı, yeni kayıt oluşturuluyor...');
                    clubSettings = { clubName: currentUser.clubName || 'Sporcum', clubId: currentClubId };
                    // Yeni kayıt oluştur
                    await supabase.from('settings').upsert({
                        id: `club_${currentClubId}`,
                        clubId: currentClubId,
                        data: clubSettings,
                        updatedAt: new Date().toISOString()
                    });
                }
                
                // ✅ SUPABASE: Kulüp bilgisi (CRM durumu ve kulüp adı)
                const clubDoc = results[4];
                if (clubDoc && clubDoc.data) {
                    clubSettings.crmEnabled = clubDoc.data.crmEnabled !== false;
                    if (clubDoc.data.expenseCategories) clubSettings.expenseCategories = clubDoc.data.expenseCategories;
                    if (clubDoc.data.productCategories) clubSettings.productCategories = clubDoc.data.productCategories;
                    
                    // ✅ Supabase'den kulüp adını al (eğer settings'de yoksa)
                    if (!clubSettings.clubName && clubDoc.data.name) {
                        clubSettings.clubName = clubDoc.data.name;
                    }
                } else {
                    console.log('⚠️ Kulüp bilgisi bulunamadı, varsayılan değerler kullanılacak');
                    clubSettings.crmEnabled = true;
                }
                
                // Branşlar (Supabase)
                const branchesData = results[5];
                if (branchesData && branchesData.data && branchesData.data.length > 0) {
                    branches = branchesData.data.map(b => ({
                        id: b.branchId || b.id,
                        name: b.branchName,
                        icon: b.icon || '⚽',
                        color: b.color || '#4A90E2',
                        lessonName: b.lessonName || b.branchName,
                        courts: b.courts || []
                    }));
                } else {
                    branches = [];
                }
                
                // Kulüp başlığı
                const clubName = clubSettings.clubName || currentUser.clubName || 'Sporcum';
                document.getElementById('club-title').textContent = clubName;
                const clubTitleHeader = document.getElementById('club-title-header');
                if (clubTitleHeader) clubTitleHeader.textContent = `${clubName} - Yönetim Paneli`;
                document.title = `${clubName} - Yönetim Paneli`;
                
                // === SECONDARY VERİLER (6-16) ===
                // ✅ SUPABASE: schedules
                const schedulesData = results[6];
                if (schedulesData && schedulesData.data) {
                    schedules = schedulesData.data;
                } else {
                    console.error('Schedules yüklenemedi:', schedulesData?.error);
                    schedules = [];
                }
                
                // ✅ SUPABASE: Holidays
                const holidaysDoc = results[7];
                if (holidaysDoc && holidaysDoc.data && holidaysDoc.data.data) {
                    holidays = holidaysDoc.data.data.off_days || [];
                } else {
                    holidays = [];
                    await supabase.from('settings').upsert({
                        id: `holidays_${currentClubId}`,
                        clubId: currentClubId,
                        data: { off_days: [] },
                        updatedAt: new Date().toISOString()
                    });
                }
                
                // ✅ SUPABASE: Users
                const usersData = results[8];
                if (usersData && usersData.data) {
                    users = usersData.data;
                    console.log('✅ Users loaded from Supabase:', users.length);
                } else {
                    console.error('Users yüklenemedi:', usersData?.error);
                    users = [];
                }
                
                // ✅ SUPABASE: Attendance Records
                const attendanceData = results[9];
                if (attendanceData && attendanceData.data) {
                    attendanceRecords = attendanceData.data;
                    console.log('Attendance Records loaded:', {
                        total: attendanceRecords.length,
                        sample: attendanceRecords.slice(0, 3),
                        absentCount: attendanceRecords.filter(r => r.status === 'absent').length
                    });
                } else {
                    console.error('AttendanceRecords yüklenemedi:', attendanceData?.error);
                    attendanceRecords = [];
                }
                
                // ✅ SUPABASE: Tasks
                const tasksData = results[10];
                if (tasksData && tasksData.data) {
                    tasks = tasksData.data;
                    // Manuel sıralama
                    tasks.sort((a, b) => {
                        const dateA = new Date(a.createdAt || 0);
                        const dateB = new Date(b.createdAt || 0);
                        return dateB - dateA; // Yeniden eskiye
                    });
                } else {
                    console.error('Tasks yüklenemedi:', tasksData?.error);
                    tasks = [];
                }
                
                // ✅ SUPABASE: WhatsApp Devices
                const devicesData = results[11];
                if (devicesData && devicesData.data) {
                    whatsappDevices = devicesData.data;
                } else {
                    console.error('WhatsApp Devices yüklenemedi:', devicesData?.error);
                    whatsappDevices = [];
                }
                
                // ✅ SUPABASE: WhatsApp config - ARTIK KULLANILMIYOR, clubSettings'ten alınıyor
                // Ana WhatsApp hattı clubSettings.defaultWhatsAppDevice'tan gelir
                // Geriye dönük uyumluluk için whatsappConfig kontrolü kaldırıldı
                
                // ✅ SUPABASE: Sent Messages
                const sentMessagesData = results[13];
                if (sentMessagesData && sentMessagesData.data) {
                    sentMessages = sentMessagesData.data;
                    sentMessages.sort((a, b) => new Date(b.sentAt || 0) - new Date(a.sentAt || 0));
                } else {
                    console.error('SentMessages yüklenemedi:', sentMessagesData?.error);
                    sentMessages = [];
                }
                
                // ✅ SUPABASE: User Activities
                const activitiesData = results[14];
                if (activitiesData && activitiesData.data) {
                    userActivities = activitiesData.data;
                    userActivities.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));
                } else {
                    console.error('UserActivities yüklenemedi:', activitiesData?.error);
                    userActivities = [];
                }
                
                // ✅ SUPABASE: CRM Leads
                const leadsData = results[15];
                if (leadsData && leadsData.data) {
                    crmLeads = leadsData.data;
                    crmLeads.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
                } else {
                    console.error('CRM Leads yüklenemedi:', leadsData?.error);
                    crmLeads = [];
                }
                
                // ✅ CRM Etiketlerini yükle (sayfa açılışında)
                await loadCRMTags();
                
                console.log('✅ Loaded data summary:');
                console.log('  - Members:', members.length);
                console.log('  - Groups:', groups.length);
                console.log('  - Branches:', branches.length);
                console.log('  - Pre-registrations:', preRegistrations.length);
                console.log('  - CRM Leads:', crmLeads.length);
                
                // ✅ Pasif üyeleri gruplardan otomatik temizle
                await cleanupExpiredMembersFromGroups();
                
                // ✅ CRITICAL: Branş dropdown'larını hemen güncelle
                updateBranchDropdowns();
                
                // ✅ CRITICAL: CRM menü görünürlüğünü güncelle
                updateCRMMenuVisibility();
                
                // ✅ CRITICAL: Mevcut sekmeyi render et
                renderCurrentSection();
                
                // ✅ Dashboard aktifse devamsızlıkları güncelle (quick start sonrası)
                if (currentSection === 'dashboard' && attendanceRecords.length > 0) {
                    setTimeout(() => {
                        if (typeof renderRecentAbsences === 'function') {
                            renderRecentAbsences();
                        }
                    }, 100);
                }
                
                // ✅ CACHE: Fresh data'yı cache'e kaydet
                if (!useCache) {
                    saveDataToCache();
                }
                
                // ✅ NON-CRITICAL: Sessiz otomatik yenileme - değişiklik varsa yenile
                if (!autoRefreshInterval) {
                    setTimeout(() => {
                        autoRefreshInterval = setInterval(async () => {
                            await checkAndRefreshIfNeeded();
                        }, 60000); // 60 seconds
                        console.log('✅ Sessiz otomatik yenileme başlatıldı (her 60 saniyede)');
                    }, 5000); // 5 saniye sonra başlat
                }
                
                // ✅ Mesaj Kuyruğunu ilk kez yükle
                setTimeout(() => {
                    renderMessageQueue();
                    processMessageQueue(); // İlk kontrol
                }, 3000);
                
                // ✅ NON-CRITICAL: Doğum günü kontrolünü lazy load
                setTimeout(() => {
                    checkAndSendBirthdayMessages();
                    
                    // Her gün saat 9'da kontrol et
                    setInterval(() => {
                        const now = new Date();
                        if (now.getHours() === 9 && now.getMinutes() === 0) {
                            console.log('🎂 Running daily birthday check...');
                            checkAndSendBirthdayMessages();
                        }
                    }, 60000); // Check every minute
                }, 10000); // 10 saniye sonra başlat
                
            } catch (error) {
                console.error('❌ Veri yüklenirken HATA:', error);
                
                // ✅ Kullanıcı dostu hata mesajı
                if (error.message && error.message.includes('timeout')) {
                    showAlert('⏱️ Bağlantı zaman aşımına uğradı. Lütfen sayfayı yenileyin veya internet bağlantınızı kontrol edin.', 'danger');
                } else if (error.code === 'unavailable') {
                    showAlert('🔌 Sunucu bağlantısı kesildi. Lütfen internet bağlantınızı kontrol edin.', 'danger');
                } else {
                    showAlert('❌ Veri yüklenirken hata oluştu. Sayfayı yenilemeyi deneyin.', 'danger');
                }
                
                // ✅ 5 saniye sonra otomatik yeniden deneme öneri
                setTimeout(() => {
                    if (confirm('Veriler yüklenemedi. Tekrar denemek ister misiniz?')) {
                        window.location.reload();
                    }
                }, 5000);
            } finally { 
                isLoading = false;
                const endTime = performance.now();
                const loadTime = (endTime - startTime).toFixed(2);
                console.log(`⚡ Data loaded in ${loadTime}ms`);
                
                // Yavaş yükleme uyarısı
                if (loadTime > 3000) {
                    console.warn(`⚠️ Slow loading detected: ${loadTime}ms (should be < 3000ms)`);
                }
                
                // ✅ Dashboard'u aktif hale getir (quick start sonrası)
                const dashboardSection = document.getElementById('dashboard');
                if (dashboardSection) {
                    dashboardSection.style.opacity = '1';
                    dashboardSection.style.pointerEvents = 'auto';
                }
                
                // Silinen çağrıları localStorage'dan yükle
                loadDeletedCalls();
                
                // ✅ WhatsApp otomatik başlat (veriler yüklendikten sonra)
                if (!quickStart) {
                    autoStartWhatsApp();
                }
            }
        }
        
        // ✅ Tüm branş dropdown'larını güncelle
        function updateBranchDropdowns() {
            // ✅ Kullanıcının erişebildiği branşları kullan
            const availableBranches = filterByBranch(branches, 'id');
            
            const branchOptions = '<option value="">Seçiniz...</option>' + 
                availableBranches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
            
            // 1. Kayıt formundaki branş dropdown
            const preRegBranchSelect = document.getElementById('preRegBranchPre');
            if (preRegBranchSelect) {
                const currentValue = preRegBranchSelect.value;
                preRegBranchSelect.innerHTML = branchOptions;
                if (currentValue) preRegBranchSelect.value = currentValue;
            }
            
            // 2. Toplu Mesaj branş seçimi (kulüp bazında)
            const bulkBranchSelector = document.getElementById('bulk-branch-selector');
            if (bulkBranchSelector) {
                const currentValue = bulkBranchSelector.value;
                // Sadece bu kulübün ve kullanıcının erişebildiği branşları göster
                const clubBranches = availableBranches.filter(b => !b.clubId || b.clubId === currentClubId);
                bulkBranchSelector.innerHTML = '<option value="">Branş seçin...</option>' + 
                    clubBranches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('') + 
                    '<option value="all">✨ Tüm Branşlar</option>';
                if (currentValue) bulkBranchSelector.value = currentValue;
                console.log('✅ Toplu Mesaj branş dropdown güncellendi:', clubBranches.length, 'branş');
            }
            
            // 3. Aktivite filtresi
            const activityBranchFilter = document.getElementById('activityBranchFilter');
            if (activityBranchFilter) {
                const currentValue = activityBranchFilter.value;
                activityBranchFilter.innerHTML = '<option value="all">Tüm Branşlar</option>' + 
                    availableBranches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
                if (currentValue) activityBranchFilter.value = currentValue;
            }
            
            // 4. Grup formu branş seçimleri (birden fazla olabilir)
            document.querySelectorAll('select[name="branch"]').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = branchOptions;
                if (currentValue) select.value = currentValue;
            });
            
            console.log('✅ Tüm dropdown\'lar güncellendi:', availableBranches.length, 'branş (yetkili)');
        }
        
        function renderCurrentSection() {
            // ✅ Otomatik yenileyicileri durdur
            stopMembersAutoRefresh();
            
            // ✅ CRM Erişim Kontrolü - Önce sections objesini kontrol et
            console.log('🔍 renderCurrentSection:', currentSection, 'CRM Enabled:', clubSettings.crmEnabled);
            
            // CRM aktif değilse ve CRM section'larından birine erişmeye çalışıyorsa
            if ((currentSection === 'crm' || currentSection.startsWith('crm-')) && clubSettings.crmEnabled !== true) {
                console.log('⚠️ CRM aktif değil, bilgilendirme mesajı gösteriliyor');
                
                // Tüm section'ları gizle
                document.querySelectorAll('.section').forEach(sec => sec.style.display = 'none');
                
                // CRM section'ını göster ve mesajı yaz
                let crmSection = document.getElementById('crm');
                if (crmSection) {
                    crmSection.style.display = 'block';
                    crmSection.innerHTML = `
                        <div style="display: flex; justify-content: center; align-items: center; min-height: 400px;">
                            <div style="text-align: center; max-width: 500px; padding: 40px; background: #fff3cd; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                <div style="font-size: 64px; margin-bottom: 20px;">🔒</div>
                                <h2 style="color: #856404; margin-bottom: 15px;">CRM Modülü Aktif Değil</h2>
                                <p style="font-size: 16px; color: #856404; margin-bottom: 20px;">
                                    CRM modülünü kullanmak için lütfen iletişime geçiniz.
                                </p>
                                <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
                                    <a href="tel:03623630063" style="font-size: 24px; color: #007bff; text-decoration: none; font-weight: bold;">
                                        📞 0362 363 00 63
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                }
                return;
            }
            
            const sections = {
                dashboard: () => {
                    updateDashboard(); // ✅ Önce sayıları göster
                    // CRM Dashboard widget'larını gecikmeyle yükle (daha ağır)
                    setTimeout(() => {
                        renderCRMDashboard(); // CRM Dashboard widget'ları (Son Devamsızlıklar dahil)
                    }, 100);
                }, 
                'registration-procedures': () => {
                    renderPreRegistrationTable();
                    renderInactiveMembersTable();
                },
                'pending-members': () => {
                    renderInactiveMembersTable();
                },
                members: renderMembersTable, 
                payments: renderPaymentsList,
                schedule: renderScheduleGrid, 
                groups: renderGroupsList,
                tasks: renderTasksPage,
                whatsapp: renderWhatsAppPage,
                crm: () => {
                    renderCRMDashboard();
                    renderCRMLeads();
                    loadCRMTags();
                },
                'crm-filter': () => {
                    // Branş filtresini doldur
                    const branchFilter = document.getElementById('filter-branch');
                    if (branchFilter) {
                        branchFilter.innerHTML = '<option value="all">Tüm Branşlar</option>' +
                            branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
                    }
                    loadCRMTags();
                    // ❌ İlk açılışta müşterileri gösterme (filtre seçilmediği sürece)
                    // applyCustomerFilters();
                },
                'crm-trials': () => {
                    // Branş filtresini doldur
                    const branchFilter = document.getElementById('trial-branch-filter');
                    if (branchFilter) {
                        branchFilter.innerHTML = '<option value="all">Tüm Branşlar</option>' +
                            branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
                    }
                    renderTrials();
                },
                'crm-tags': () => {
                    loadCRMTags();
                },
                'crm-templates': renderCRMTemplatesPage,
                'crm-incoming-calls': () => {
                    renderIncomingCallsPage();
                    // Gelen aramalar otomatik yenileme başlat
                    if (window.startIncomingCallsAutoRefresh) {
                        startIncomingCallsAutoRefresh();
                    }
                },
                'crm-outgoing-calls': renderOutgoingCallsPage,
                'accounting-summary': renderAccountingSummary,
                'incomes': renderIncomesPage,
                'expenses': renderExpensesPage,
                'products': renderProductsPage,
                settings: renderSettings,
                'attendance-tracking': renderAllAbsences,
                'user-activities': renderUserActivitiesPage,
                'inactive-members': loadInactiveMembers,
                'campaigns': renderCampaignsPage,
                'whatsapp-balance': () => {
                    console.log('🚀 WhatsApp Balance section triggered');
                    window.renderWhatsAppBalancePage();
                },
                'members': () => {
                    renderMembersTable();
                    startMembersAutoRefresh();
                }
            };
            if (sections[currentSection]) {
                if (typeof sections[currentSection] === 'function') {
                    sections[currentSection]();
                }
            }
        }
        
        function renderAllAbsences() {
            const container = document.getElementById('attendance-content');
            const titleEl = document.getElementById('header-title-attendance');
            
            if (!container) return;
            
            titleEl.textContent = '📋 Tüm Devamsızlıklar';
            
            const allAbsences = attendanceRecords.filter(rec => rec.status === 'absent').sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allAbsences.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>Devamsızlık kaydı bulunmuyor.</h3></div>';
                return;
            }
            
            container.innerHTML = `
                <div class="card">
                    <h3 class="card-title">Toplam ${allAbsences.length} Devamsızlık Kaydı</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Öğrenci</th>
                                    <th>Telefon</th>
                                    <th>Tarih</th>
                                    <th>Sebep</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allAbsences.map(absence => {
                                    const member = members.find(m => m.id === absence.memberId);
                                    if (!member) return '';
                                    const memberName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad;
                                    return `
                                        <tr style="cursor: pointer;" onclick="showMemberAttendancePage('${member.id}')">
                                            <td><strong>${memberName}</strong></td>
                                            <td>${member.Telefon}</td>
                                            <td>${formatDate(absence.date)}</td>
                                            <td>${absence.reason || '<i>Sebep belirtilmedi</i>'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // User Activities Page
        function renderUserActivitiesPage() {
            const searchInput = document.getElementById('activitySearch');
            const branchFilter = document.getElementById('activityBranchFilter');
            
            // Setup event listeners
            if (searchInput) {
                searchInput.removeEventListener('input', filterActivities);
                searchInput.addEventListener('input', filterActivities);
            }
            if (branchFilter) {
                branchFilter.removeEventListener('change', filterActivities);
                branchFilter.addEventListener('change', filterActivities);
            }
            
            filterActivities();
        }
        
        function filterActivities() {
            const searchText = document.getElementById('activitySearch')?.value.toLowerCase() || '';
            const selectedBranch = document.getElementById('activityBranchFilter')?.value || 'all';
            
            let filtered = userActivities;
            
            // Filter by search text
            if (searchText) {
                const searchNoSpaces = searchText.replace(/\s/g, '');
                filtered = filtered.filter(activity => 
                    activity.memberName?.toLowerCase().includes(searchText) ||
                    activity.phone?.toLowerCase().includes(searchText) ||
                    activity.phone?.replace(/\s/g, '').includes(searchNoSpaces)
                );
            }
            
            // Filter by branch
            if (selectedBranch !== 'all') {
                filtered = filtered.filter(activity => activity.branch === selectedBranch);
            }
            
            displayActivitiesTable(filtered);
        }
        
        function displayActivitiesTable(activities) {
            const container = document.getElementById('activitiesTableContainer');
            
            if (!activities || activities.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>Kullanıcı hareketi bulunmuyor.</h3></div>';
                return;
            }
            
            const tableHtml = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Tarih/Saat</th>
                                <th>İsim</th>
                                <th>Telefon</th>
                                <th>Branş</th>
                                <th>Tip</th>
                                <th>Hareket</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${activities.map(activity => {
                                const date = new Date(activity.timestamp);
                                const formattedDate = date.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                                const formattedTime = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                                const branchIcon = activity.branch === 'tenis' ? '🎾' : activity.branch === 'yuzme' ? '🏊' : '';
                                const activityType = activity.type === 'staff' ? '👨‍💼 Personel' : '👤 Üye';
                                const displayName = activity.memberName || activity.staffName || 'Bilinmiyor';
                                
                                return `
                                    <tr>
                                        <td>${formattedDate} ${formattedTime}</td>
                                        <td><strong>${displayName}</strong></td>
                                        <td><a href="#" class="phone-link" onclick="handlePhoneClick(event, '${activity.phone}')">${activity.phone || '-'}</a></td>
                                        <td>${branchIcon} ${capitalize(activity.branch || '-')}</td>
                                        <td><span class="status-badge ${activity.type === 'staff' ? 'status-pending' : 'status-active'}">${activityType}</span></td>
                                        <td><span class="status-badge status-active">${activity.activity}</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        }
        
        async function refreshUserActivities() {
            try {
                const { getDocs, query, collection, orderBy } = window.firebase;
                const activitiesSnapshot = await getDocs(query(collection(window.db, 'userActivities'), orderBy('timestamp', 'desc')));
                userActivities = activitiesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filterActivities();
                showAlert('Kullanıcı hareketleri güncellendi.', 'success');
            } catch (error) {
                console.error('Error refreshing activities:', error);
                showAlert('Hareketler yüklenirken hata oluştu.', 'danger');
            }
        }
        
        window.refreshUserActivities = refreshUserActivities;

        // ✅ Sidebar Toggle Function
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            if (sidebar) {
                sidebar.classList.toggle('collapsed');
                const isCollapsed = sidebar.classList.contains('collapsed');
                
                // Overlay'i mobilde göster/gizle
                if (window.innerWidth <= 768) {
                    if (overlay) {
                        overlay.classList.toggle('active', !isCollapsed);
                    }
                }
                
                // Sidebar kapanırken tüm dropdown'ları kapat
                if (isCollapsed) {
                    document.querySelectorAll('.dropdown-content.show').forEach(content => {
                        content.classList.remove('show');
                    });
                    document.querySelectorAll('.dropdown-toggle.open').forEach(toggle => {
                        toggle.classList.remove('open');
                    });
                }
                
                // LocalStorage'a kaydet (sadece desktop için)
                if (window.innerWidth > 768) {
                    localStorage.setItem('sidebarCollapsed', isCollapsed);
                }
            }
        }
        
        window.toggleSidebar = toggleSidebar;
        
        // Sayfa yüklendiğinde sidebar durumunu geri yükle
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.querySelector('.sidebar');
            const isMobile = window.innerWidth <= 768;
            
            // Mobilde varsayılan olarak kapalı
            if (isMobile) {
                sidebar?.classList.add('collapsed');
            } else {
                // Desktop'ta localStorage'dan yükle
                const savedState = localStorage.getItem('sidebarCollapsed');
                if (savedState === 'true') {
                    sidebar?.classList.add('collapsed');
                }
            }
            
            // Overlay oluştur (mobil için)
            if (!document.querySelector('.sidebar-overlay')) {
                const overlay = document.createElement('div');
                overlay.className = 'sidebar-overlay';
                overlay.addEventListener('click', () => {
                    if (sidebar && !sidebar.classList.contains('collapsed')) {
                        toggleSidebar();
                    }
                });
                document.body.appendChild(overlay);
            }
        });
        
        // Dropdown event listener'ları için window.load kullan
        window.addEventListener('load', () => {
            const dropdownButtons = document.querySelectorAll('.dropdown-toggle');
            
            dropdownButtons.forEach((button) => {
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    const sidebar = document.querySelector('.sidebar');
                    const isCollapsed = sidebar && sidebar.classList.contains('collapsed');
                    const dropdown = this.parentElement;
                    const dropdownContent = dropdown.querySelector('.dropdown-content');
                    
                    // Sidebar kapalıysa, sidebar'ı aç VE dropdown'u da aç
                    if (isCollapsed) {
                        sidebar.classList.remove('collapsed');
                        localStorage.setItem('sidebarCollapsed', 'false');
                        
                        // Sidebar açılma animasyonu bittikten sonra dropdown'u aç
                        setTimeout(() => {
                            // Tüm dropdown'ları kapat
                            document.querySelectorAll('.dropdown-content.show').forEach(content => {
                                content.classList.remove('show');
                            });
                            document.querySelectorAll('.dropdown-toggle.open').forEach(toggle => {
                                toggle.classList.remove('open');
                            });
                            
                            // Bu dropdown'u aç
                            if (dropdownContent) {
                                dropdownContent.classList.add('show');
                                this.classList.add('open');
                            }
                        }, 300); // CSS transition süresi kadar bekle
                        return;
                    }
                    
                    // Sidebar açıksa normal dropdown davranışı
                    const isOpen = dropdownContent && dropdownContent.classList.contains('show');
                    
                    // Tüm dropdown'ları kapat
                    document.querySelectorAll('.dropdown-content.show').forEach(content => {
                        content.classList.remove('show');
                    });
                    document.querySelectorAll('.dropdown-toggle.open').forEach(toggle => {
                        toggle.classList.remove('open');
                    });
                    
                    // Bu dropdown'ı aç/kapat
                    if (!isOpen && dropdownContent) {
                        dropdownContent.classList.add('show');
                        this.classList.add('open');
                    }
                });
            });
        });

        async function showSection(sectionId, element) {
            // ✅ SAYFA ERİŞİM KONTROLÜ - Sadece pageAccess kullan
            if (currentUser && !currentUser.isSuperAdmin) {
                const pageAccessMap = {
                    'members': 'members',
                    'registration-procedures': 'preRegistrations',
                    'inactive-members': 'members',
                    'crm': 'crm',
                    'crm-incoming-calls': 'crm',
                    'payments': 'payments',
                    'settings': 'settings',
                    'reports': 'reports',
                    'attendance-tracking': 'attendance',
                    'schedule': 'schedule',
                    'whatsapp-messages': 'messages'
                };
                
                const requiredPage = pageAccessMap[sectionId];
                if (requiredPage) {
                    const hasAccess = currentUser.pageAccess 
                        ? currentUser.pageAccess[requiredPage] 
                        : true; // pageAccess yoksa (NULL) tüm sayfalara erişim var
                    
                    if (!hasAccess) {
                        showAlert(`❌ Bu sayfaya erişim yetkiniz yok: ${requiredPage.toUpperCase()}`, 'danger');
                        return;
                    }
                }
            }

            // Önceki section'dan çıkarken temizlik yap
            if (currentSection === 'crm-incoming-calls' && sectionId !== 'crm-incoming-calls') {
                // Gelen aramalar otomatik yenileme durdur
                if (window.stopIncomingCallsAutoRefresh) {
                    stopIncomingCallsAutoRefresh();
                }
            }

            currentSection = sectionId;
            console.log('📍 Switching to section:', sectionId);
            
            // Tüm section'ları gizle ve nav butonlarını pasif yap
            document.querySelectorAll('.section').forEach(s => {
                s.classList.remove('active');
                s.style.display = 'none';
            });
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            // Gösterilecek section'ı bul ve göster
            const sectionToShow = document.getElementById(sectionId);
            if(sectionToShow) {
                sectionToShow.classList.add('active');
                sectionToShow.style.display = 'block';
            } else {
                console.warn('⚠️ Section not found:', sectionId);
            }
            if (element) element.classList.add('active');
            
            // WhatsApp section'a girildiğinde özel işlem yapma
            // (Bildirimler artık otomatik çalışıyor)
            
            renderCurrentSection();
        }
        
        // Dropdown menü toggle
        function toggleDropdown(button, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const dropdown = button.parentElement;
            const dropdownContent = dropdown.querySelector('.dropdown-content');
            const isOpen = dropdownContent && dropdownContent.classList.contains('show');
            
            // Tüm dropdown'ları kapat
            document.querySelectorAll('.dropdown-content.show').forEach(content => {
                content.classList.remove('show');
            });
            document.querySelectorAll('.dropdown-toggle.open').forEach(toggle => {
                toggle.classList.remove('open');
            });
            
            // Bu dropdown'ı aç/kapat
            if (!isOpen && dropdownContent) {
                dropdownContent.classList.add('show');
                button.classList.add('open');
            }
        }
        
        window.toggleDropdown = toggleDropdown;
        
        function renderBranchesTable() {
            const tbody = document.getElementById('branchesTable');
            if (!tbody) return;
            
            if (branches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Henüz branş eklenmemiş.</td></tr>';
                return;
            }
            
            tbody.innerHTML = branches.map(branch => {
                const courtsList = (branch.courts && branch.courts.length > 0) 
                    ? branch.courts.map(c => c.name).join(', ') 
                    : '<span style="color: #999;">-</span>';
                    
                return `
                    <tr>
                        <td style="font-size: 28px; text-align: center;">${branch.icon}</td>
                        <td><code>${branch.id}</code></td>
                        <td><strong>${branch.name}</strong></td>
                        <td>${branch.lessonName}</td>
                        <td>${courtsList}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editBranch('${branch.id}')" style="margin-right: 5px;">✏️</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteBranch('${branch.id}')">🗑️</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        window.addBranch = async function(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const idInput = form.querySelector('[name="branchId"]');
            const isEditing = idInput.getAttribute('data-editing') === 'true';
            
            console.log('🔵 addBranch çağrıldı, editing mode:', isEditing);
            
            // ✅ Eğer düzenleme modundaysa, saveBranchEdit çağır
            if (isEditing) {
                console.log('➡️ saveBranchEdit çağrılıyor...');
                return await saveBranchEdit(event);
            }
            
            console.log('➡️ Yeni branş ekleme modu');
            const branchId = formData.get('branchId').toLowerCase().trim();
            
            const icon = formData.get('branchIcon').trim();
            
            // ✅ Sahaları al (virgülle ayrılmış)
            const courtsInput = formData.get('branchCourts').trim();
            const courts = courtsInput ? courtsInput.split(',').map((c, idx) => ({
                id: idx + 1,
                name: c.trim()
            })).filter(c => c.name) : [];
            
            const newBranch = {
                id: branchId,
                name: formData.get('branchName').trim(),
                icon: icon || '⚽', // ✅ İkon opsiyonel - varsayılan emoji
                lessonName: formData.get('branchLessonName').trim(),
                courts: courts // ✅ Sahalar
            };
            
            // Check if branch ID already exists (local)
            if (branches.find(b => b.id === newBranch.id)) {
                showAlert('⚠️ Bu branş ID zaten kullanılıyor!', 'warning');
                return;
            }
            
            try {
                // ✅ Composite ID oluştur: clubId_branchId
                const compositeId = `${currentClubId}_${newBranch.id}`;
                
                // ✅ Supabase'de de kontrol et (duplicate check)
                const { data: existingBranch, error: checkError } = await supabase
                    .from('branches')
                    .select('id')
                    .eq('id', compositeId)  // ✅ Composite ID kontrolü
                    .maybeSingle();
                
                if (checkError && checkError.code !== 'PGRST116') {
                    console.error('❌ Branş kontrolü hatası:', checkError);
                }
                
                if (existingBranch) {
                    showAlert('⚠️ Bu branş ID bu kulüpte zaten mevcut!', 'warning');
                    return;
                }
                
                // ✅ Supabase branches tablosuna kaydet
                const insertData = {
                    id: compositeId, // ✅ Benzersiz ID: clubId_branchId
                    clubId: currentClubId,
                    branchId: newBranch.id,
                    branchName: newBranch.name,
                    icon: newBranch.icon || '⚽',
                    color: '#4CAF50', // Varsayılan renk
                    courts: newBranch.courts || [],
                    isActive: true,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // lessonName'i ekle (eğer kolon varsa)
                if (newBranch.lessonName) {
                    insertData.lessonName = newBranch.lessonName;
                }
                
                const { data: supabaseData, error: supabaseError } = await supabase
                    .from('branches')
                    .insert([insertData])
                    .select();
                
                if (supabaseError) {
                    console.error('❌ Supabase branş ekleme hatası:', supabaseError);
                    showAlert(`❌ Branş eklenirken hata: ${supabaseError.message}`, 'danger');
                    return;
                }
                
                console.log('✅ Supabase branş eklendi:', supabaseData);
                
                branches.push(newBranch);
                showAlert('✅ Branş başarıyla eklendi!', 'success');
                form.reset();
                renderBranchesTable();
                
                // ✅ Tüm verileri yeniden yükle ki branşlar her yerde görünsün
                await loadData();
            } catch (error) {
                console.error('Error adding branch:', error);
                showAlert('❌ Branş eklenirken hata oluştu!', 'danger');
            }
        };
        
        // ✅ Formu temizle ve yeni ekleme moduna geç
        window.resetBranchForm = function() {
            const form = document.getElementById('branchForm');
            form.reset();
            
            const idInput = form.querySelector('[name="branchId"]');
            idInput.readOnly = false;
            idInput.style.backgroundColor = '';
            idInput.style.cursor = '';
            idInput.removeAttribute('data-editing');
            
            document.getElementById('branchFormTitle').textContent = '➕ Yeni Branş Ekle';
            document.getElementById('branchSubmitBtn').innerHTML = '➕ Ekle';
        };
        
        window.editBranch = async function(branchId) {
            const branch = branches.find(b => b.id === branchId);
            if (!branch) return;
            
            // ✅ Modal ile düzenleme (daha kullanıcı dostu)
            const form = document.getElementById('branchForm');
            form.reset();
            
            // Form alanlarını doldur
            const idInput = form.querySelector('[name="branchId"]');
            idInput.value = branch.id;
            form.querySelector('[name="branchName"]').value = branch.name;
            form.querySelector('[name="branchIcon"]').value = branch.icon || '';
            form.querySelector('[name="branchLessonName"]').value = branch.lessonName;
            
            // Sahalar (virgülle ayrılmış string)
            const courtsStr = (branch.courts || []).map(c => c.name).join(', ');
            form.querySelector('[name="branchCourts"]').value = courtsStr;
            
            // ✅ ID alanını readonly yap (disabled değil, çünkü disabled form submit'te gelmez)
            idInput.readOnly = true;
            idInput.style.backgroundColor = '#f0f0f0';
            idInput.style.cursor = 'not-allowed';
            idInput.setAttribute('data-editing', 'true'); // ✅ Düzenleme flag'i
            
            // ✅ Başlık ve butonu değiştir
            document.getElementById('branchFormTitle').textContent = '✏️ Branş Düzenle';
            document.getElementById('branchSubmitBtn').innerHTML = '💾 Güncelle';
            
            // Forma scroll yap
            form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // İlk input'a focus
            form.querySelector('[name="branchName"]').focus();
        };
        
        window.saveBranchEdit = async function(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const branchId = formData.get('branchId');
            console.log('💾 saveBranchEdit çağrıldı, branchId:', branchId);
            
            const branch = branches.find(b => b.id === branchId);
            if (!branch) {
                console.error('❌ Branş bulunamadı:', branchId);
                showAlert('Branş bulunamadı!', 'danger');
                return;
            }
            
            console.log('✅ Branş bulundu, güncelleniyor...', branch);
            
            const icon = formData.get('branchIcon').trim();
            const courtsInput = formData.get('branchCourts').trim();
            const courts = courtsInput ? courtsInput.split(',').map((c, idx) => ({
                id: idx + 1,
                name: c.trim()
            })).filter(c => c.name) : [];
            
            try {
                const index = branches.findIndex(b => b.id === branchId);
                const updatedBranch = {
                    ...branches[index],
                    name: formData.get('branchName').trim(),
                    icon: icon || '⚽',
                    lessonName: formData.get('branchLessonName').trim(),
                    courts: courts
                };
                
                // ✅ Supabase'de güncelle
                const updateData = {
                    branchName: updatedBranch.name,
                    icon: updatedBranch.icon,
                    courts: updatedBranch.courts || [],
                    updatedAt: new Date().toISOString()
                };
                
                // lessonName'i ekle (eğer kolon varsa)
                if (updatedBranch.lessonName) {
                    updateData.lessonName = updatedBranch.lessonName;
                }
                
                const { error: supabaseError } = await supabase
                    .from('branches')
                    .update(updateData)
                    .eq('clubId', currentClubId)
                    .eq('branchId', branchId);
                
                if (supabaseError) {
                    console.error('❌ Supabase branş güncelleme hatası:', supabaseError);
                    showAlert('❌ Branş güncellenirken hata oluştu!', 'danger');
                    return;
                }
                
                branches[index] = updatedBranch;
                showAlert('✅ Branş başarıyla güncellendi!', 'success');
                
                // ✅ Formu temizle ve normal moda çevir
                const idInput = form.querySelector('[name="branchId"]');
                idInput.readOnly = false;
                idInput.style.backgroundColor = '';
                idInput.style.cursor = '';
                idInput.removeAttribute('data-editing');
                
                form.reset();
                renderBranchesTable();
                
                // ✅ Başlık ve butonu geri al
                document.getElementById('branchFormTitle').textContent = '➕ Yeni Branş Ekle';
                document.getElementById('branchSubmitBtn').innerHTML = '➕ Ekle';
                
                // ✅ Tüm verileri yeniden yükle
                await loadData();
            } catch (error) {
                console.error('Error updating branch:', error);
                showAlert('❌ Branş güncellenirken hata oluştu!', 'danger');
            }
        };
        
        window.deleteBranch = async function(branchId) {
            if (!confirm(`"${branchId}" branşını silmek istediğinizden emin misiniz?\n\nDikkat: Bu branşa ait gruplar ve üyeler etkilenebilir!`)) {
                return;
            }
            
            try {
                // ✅ Supabase'den sil (soft delete - isActive = false)
                const { error: supabaseError } = await supabase
                    .from('branches')
                    .update({
                        isActive: false,
                        updatedAt: new Date().toISOString()
                    })
                    .eq('clubId', currentClubId)
                    .eq('branchId', branchId);
                
                if (supabaseError) {
                    console.error('❌ Supabase branş silme hatası:', supabaseError);
                    showAlert('❌ Branş silinirken hata oluştu!', 'danger');
                    return;
                }
                
                branches = branches.filter(b => b.id !== branchId);
                showAlert('✅ Branş başarıyla silindi!', 'success');
                renderBranchesTable();
                
                // ✅ Tüm verileri yeniden yükle
                await loadData();
            } catch (error) {
                console.error('Error deleting branch:', error);
                showAlert('❌ Branş silinirken hata oluştu!', 'danger');
            }
        };
        
        async function loadClubInfo() {
            try {
                const { getDoc, doc } = window.firebase;
                const clubInfoDoc = await getDoc(doc(window.db, 'settings', `club_${currentClubId}`));
                
                if (clubInfoDoc.exists()) {
                    const data = clubInfoDoc.data();
                    
                    // Populate form (null check ekleyelim - form sadece settings bölümünde mevcut)
                    const setValueSafe = (id, value) => {
                        const elem = document.getElementById(id);
                        if (elem) elem.value = value || '';
                    };
                    
                    setValueSafe('clubInfoName', data.clubName);
                    setValueSafe('clubIcon', data.clubIcon);
                    setValueSafe('clubDescription', data.clubDescription);
                    setValueSafe('clubAddress', data.clubAddress);
                    setValueSafe('clubCity', data.clubCity);
                    setValueSafe('clubPhone', data.clubPhone);
                    setValueSafe('clubEmail', data.clubEmail);
                    setValueSafe('clubWebsite', data.clubWebsite);
                    setValueSafe('clubInstagram', data.clubInstagram);
                    setValueSafe('clubFacebook', data.clubFacebook);
                    setValueSafe('clubTwitter', data.clubTwitter);
                    setValueSafe('clubFounded', data.clubFounded);
                    setValueSafe('clubTimezone', data.clubTimezone || 'Europe/Istanbul');
                    setValueSafe('clubCurrency', data.clubCurrency || 'TRY');
                    setValueSafe('clubLanguage', data.clubLanguage || 'tr');
                    setValueSafe('contractTemplate', data.contractTemplate);
                    // ✅ IBAN bilgileri
                    if (data.iban) {
                        console.log('📦 IBAN yükleniyor:', data.iban);
                        if (data.iban.tenis) {
                            setValueSafe('ibanTenisName', data.iban.tenis.name);
                            setValueSafe('ibanTenisIban', data.iban.tenis.iban);
                            setValueSafe('ibanTenisBankName', data.iban.tenis.bankName);
                        }
                        if (data.iban.yuzme) {
                            setValueSafe('ibanYuzmeName', data.iban.yuzme.name);
                            setValueSafe('ibanYuzmeIban', data.iban.yuzme.iban);
                            setValueSafe('ibanYuzmeBankName', data.iban.yuzme.bankName);
                        }
                    } else {
                        console.warn('⚠️ IBAN bilgisi yok');
                    }
                    
                    console.log('✅ Club info loaded');
                } else {
                    // İlk kez, kulüpten gelen bilgileri kullan
                    const elem = document.getElementById('clubInfoName');
                    if (elem) elem.value = currentUser.clubName || clubSettings.clubName || '';
                    console.log('ℹ️ No club info found, using defaults');
                }
                // Kayıt linkini oluştur ve göster (setTimeout ile DOM hazır olduğundan emin ol)
                setTimeout(() => {
                    if (typeof generateRegistrationLink === 'function') {
                        generateRegistrationLink();
                    }
                }, 100);
                
                // ✅ Sözleşme şablonu textarea'sını dinamik olarak ekle (eğer yoksa)
                ensureContractTemplateField();
            } catch (error) {
                console.error('Error loading club info:', error);
            }
        }
        
        // ✅ Sözleşme şablonu ve kulüp detay alanlarını dinamik olarak ekle
        function ensureContractTemplateField() {
            // Eğer zaten varsa ekleme
            if (document.getElementById('contractTemplate')) {
                return;
            }
            
            // clubLanguage alanını bul
            const clubLanguageInput = document.getElementById('clubLanguage');
            if (!clubLanguageInput) {
                console.warn('⚠️ clubLanguage input bulunamadı, sözleşme şablonu alanı eklenemiyor');
                return;
            }
            
            // Parent container'ı bul
            const parentDiv = clubLanguageInput.closest('.form-group') || clubLanguageInput.parentElement;
            if (!parentDiv || !parentDiv.parentElement) {
                console.warn('⚠️ Parent container bulunamadı');
                return;
            }
            
            // Yeni textarea container oluştur
            const newFieldContainer = document.createElement('div');
            newFieldContainer.className = 'form-group';
            newFieldContainer.style.gridColumn = '1 / -1'; // Full width
            newFieldContainer.innerHTML = `
                <label for="contractTemplate">
                    📄 Sözleşme Şablonu (HTML)
                    <small style="display: block; color: #666; font-weight: normal; margin-top: 5px;">
                        Kayıt sayfasında müşteriye gösterilecek sözleşme metni. 
                        <br><strong>⚠️ NOT:</strong> Kulüp bilgilerini (yetkili, adres, vergi no vb.) direkt metin olarak yazın, değişken kullanmayın!
                        <br>
                        <br><strong>📄 PDF Sayfalama İpucu:</strong>
                        <br>• Sözleşmenizde manuel sayfa sonları eklemek için <code>&lt;hr&gt;</code> etiketi kullanın
                        <br>• Örnek: <code>&lt;p&gt;Madde 5...&lt;/p&gt;&lt;hr&gt;&lt;h4&gt;6. MADDE&lt;/h4&gt;</code>
                        <br>• <strong>⚠️ 10'dan fazla &lt;hr&gt; kullanmayın!</strong> Her &lt;hr&gt; yeni sayfa başlatır.
                        <br>• Eğer &lt;hr&gt; kullanmazsanız, sistem otomatik sayfalama yapar (4000 karakter/sayfa)
                        <br>
                        <br><strong>Kullanılabilir değişkenler (sadece üye/veli bilgileri için):</strong> 
                        <br>• {UYE_AD_SOYAD} veya {Ad_Soyad} - Veli/üye adı
                        <br>• {UYE_TCKN} veya {TC_Kimlik_No} - TC kimlik numarası
                        <br>• {UYE_TELEFON} veya {Telefon} - Telefon
                        <br>• {UYE_ADRES} veya {Adres} - Adres
                        <br>• {UYE_DOGUM_TARIHI} veya {Dogum_Tarihi} - Doğum tarihi (otomatik formatlanır)
                        <br>• {Veli_2_Adi_Soyadi} - İkinci veli adı
                        <br>• {Telefon_2} - İkinci telefon
                        <br>• {Ogrenci_Bilgileri} - Öğrenci bilgileri (çocuk kayıtlarında otomatik eklenir)
                    </small>
                </label>
                <textarea 
                    id="contractTemplate" 
                    name="contractTemplate" 
                    rows="20" 
                    style="font-family: monospace; font-size: 13px; line-height: 1.6;"
                    placeholder="<h3>ÜYELİK SÖZLEŞMESİ</h3>

<h4>1-) TARAFLAR</h4>

<p><strong>A-KULÜP</strong></p>
<p>Adı-Soyadı : Aykut YILDIRIM</p>
<p>Ünvanı : Atakum Tenis</p>
<p>Adres : Derecik Mahallesi 1444. Sokak No:1 İlkadım/Samsun</p>
<p>Vergi No : 9540639540</p>
<p>Telefon : 0362 363 00 64</p>
<p>E-mail : y.aykut7455@gmail.com</p>
<p>Bu sözleşmede bundan sonra &quot;EĞİTMEN/KULÜP&quot; olarak anılacaktır.</p>

<p><strong>B-ÜYE/VELİ</strong></p>
<p>Adı-Soyadı : {UYE_AD_SOYAD}</p>
<p>Doğum Tarihi : {UYE_DOGUM_TARIHI}</p>
<p>Adres : {UYE_ADRES}</p>
<p>TCKN : {UYE_TCKN}</p>
<p>Telefon : {UYE_TELEFON}</p>
<p>Bu sözleşmede bundan sonra &quot;ÜYE/VELİ&quot; olarak anılacaktır.</p>

{Ogrenci_Bilgileri}

<h4>2-) SÖZLEŞME KONUSU VE KAPSAMI</h4>
<p>...</p>"
                ></textarea>
            `;
            
            // clubLanguage alanından sonra ekle
            parentDiv.parentElement.insertBefore(newFieldContainer, parentDiv.nextSibling);
            console.log('✅ Sözleşme şablonu alanı eklendi');
        }

        // Slug oluştur (kayit.html ile aynı)
        function createSlug(text) {
            if (!text) return '';
            
            const trMap = {
                'ç': 'c', 'Ç': 'c',
                'ğ': 'g', 'Ğ': 'g',
                'ı': 'i', 'İ': 'i',
                'ö': 'o', 'Ö': 'o',
                'ş': 's', 'Ş': 's',
                'ü': 'u', 'Ü': 'u'
            };
            
            return text
                .split('')
                .map(char => trMap[char] || char)
                .join('')
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '')
                .replace(/^-+|-+$/g, '');
        }
        
        // Kayıt linkini oluştur ve göster
        function generateRegistrationLink() {
            const clubName = document.getElementById('clubInfoName').value;
            if (!clubName) return;
            
            const slug = createSlug(clubName);
            
            // Base URL - direkt domain kullan, /uyeyeni/ ekleme
            const baseUrl = window.location.origin;
            const registrationUrl = `${baseUrl}/kayit?club=${slug}`;
            
            document.getElementById('registrationLinkDisplay').value = registrationUrl;
            document.getElementById('registrationLinkSection').style.display = 'block';
            
            return registrationUrl;
        }
        
        // Linki kopyala
        window.copyRegistrationLink = function() {
            const linkInput = document.getElementById('registrationLinkDisplay');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999); // Mobil için
            
            navigator.clipboard.writeText(linkInput.value).then(() => {
                showAlert('✅ Kayıt linki kopyalandı!', 'success');
            }).catch(() => {
                document.execCommand('copy');
                showAlert('✅ Kayıt linki kopyalandı!', 'success');
            });
        };
        
        // Linki yeni sekmede aç
        window.openRegistrationLink = function() {
            const linkInput = document.getElementById('registrationLinkDisplay');
            window.open(linkInput.value, '_blank');
        };
        
        window.saveClubInfo = async function(event) {
            event.preventDefault();
            const form = event.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = '⏳ Kaydediliyor...';
                
                // ✅ IBAN bilgilerini topla
                const ibanData = {};
                const ibanTenisName = document.getElementById('ibanTenisName');
                const ibanTenisIban = document.getElementById('ibanTenisIban');
                const ibanTenisBankName = document.getElementById('ibanTenisBankName');
                const ibanYuzmeName = document.getElementById('ibanYuzmeName');
                const ibanYuzmeIban = document.getElementById('ibanYuzmeIban');
                const ibanYuzmeBankName = document.getElementById('ibanYuzmeBankName');
                
                if (ibanTenisName && ibanTenisIban) {
                    ibanData.tenis = {
                        name: ibanTenisName.value || '',
                        iban: ibanTenisIban.value || '',
                        bankName: ibanTenisBankName ? ibanTenisBankName.value : ''
                    };
                }
                
                if (ibanYuzmeName && ibanYuzmeIban) {
                    ibanData.yuzme = {
                        name: ibanYuzmeName.value || '',
                        iban: ibanYuzmeIban.value || '',
                        bankName: ibanYuzmeBankName ? ibanYuzmeBankName.value : ''
                    };
                }
                
                // ✅ Güvenli element okuma helper
                const getValueSafe = (id) => {
                    const elem = document.getElementById(id);
                    return elem ? elem.value : '';
                };
                
                const clubInfoData = {
                    clubName: getValueSafe('clubInfoName'),
                    clubIcon: getValueSafe('clubIcon'),
                    clubDescription: getValueSafe('clubDescription'),
                    clubAddress: getValueSafe('clubAddress'),
                    clubCity: getValueSafe('clubCity'),
                    clubPhone: getValueSafe('clubPhone'),
                    clubEmail: getValueSafe('clubEmail'),
                    clubWebsite: getValueSafe('clubWebsite'),
                    clubInstagram: getValueSafe('clubInstagram'),
                    clubFacebook: getValueSafe('clubFacebook'),
                    clubTwitter: getValueSafe('clubTwitter'),
                    clubFounded: getValueSafe('clubFounded'),
                    clubTimezone: getValueSafe('clubTimezone'),
                    clubCurrency: getValueSafe('clubCurrency'),
                    clubLanguage: getValueSafe('clubLanguage'),
                    contractTemplate: getValueSafe('contractTemplate'),
                    // ✅ IBAN bilgileri
                    iban: ibanData,
                    clubId: currentClubId,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.email
                };
                
                console.log('💾 Kaydedilecek veri:', clubInfoData);
                console.log('📦 IBAN verisi:', ibanData);
                
                const { setDoc, doc } = window.firebase;
                // Sadece club_${clubId} kullanıyoruz (clubInfo_ yerine)
                await setDoc(doc(window.db, 'settings', `club_${currentClubId}`), clubInfoData);
                
                console.log('✅ Veri Supabase\'e kaydedildi');
                
                // Update global clubSettings
                clubSettings.clubName = clubInfoData.clubName;
                
                // Update title
                document.getElementById('club-title').textContent = clubInfoData.clubName;
                const clubTitleHeader = document.getElementById('club-title-header');
                if (clubTitleHeader) clubTitleHeader.textContent = `${clubInfoData.clubName} - Yönetim Paneli`;
                document.title = `${clubInfoData.clubName} - Yönetim Paneli`;
                
                // Kayıt linkini göster
                generateRegistrationLink();
                
                showAlert('✅ Kulüp bilgileri başarıyla kaydedildi!', 'success');
                console.log('✅ Club info saved');
                
            } catch (error) {
                console.error('Error saving club info:', error);
                showAlert('❌ Kulüp bilgileri kaydedilirken hata oluştu!', 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '💾 Kulüp Bilgilerini Kaydet';
            }
        };
        
        // ✅ Webhook Ayarları Yükleme - REMOVED (Now in SuperAdmin)
        // Webhook management is now handled by SuperAdmin panel
        // OLD WEBHOOK FUNCTIONS - REMOVED (loadWebhookSettings moved to line ~10701)
        async function _oldLoadWebhookSettings() {
            try {
                const webhooksCollection = window.firebase.collection(window.db, 'webhooks');
                const q = window.firebase.query(webhooksCollection, window.firebase.where('clubId', '==', currentClubId));
                const querySnapshot = await window.firebase.getDocs(q);
                
                const webhookList = document.getElementById('webhookList');
                
                if (querySnapshot.empty) {
                    webhookList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p style="font-size: 48px; margin: 0;">🔗</p>
                            <p>Henüz tanımlı webhook bulunmuyor</p>
                            <p style="font-size: 14px;">Yeni webhook eklemek için yukarıdaki butonu kullanın</p>
                        </div>
                    `;
                    return;
                }
                
                let tableHtml = `
                    <table class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Durum</th>
                                <th>Webhook Adı</th>
                                <th>URL</th>
                                <th>Olaylar</th>
                                <th>Güncelleme</th>
                                <th style="width: 150px;">İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                querySnapshot.forEach(doc => {
                    const webhook = doc.data();
                    const statusBadge = webhook.active 
                        ? '<span style="background: #28a745; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px;">✓ Aktif</span>'
                        : '<span style="background: #6c757d; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px;">○ Pasif</span>';
                    
                    const eventIcons = {
                        'whatsapp_message': '💬',
                        'new_member': '👤',
                        'payment': '💰',
                        'attendance': '📋',
                        'contract_signed': '📝'
                    };
                    
                    const eventsHtml = (webhook.eventTypes || [])
                        .map(e => eventIcons[e] || e)
                        .join(' ');
                    
                    const updatedDate = webhook.updatedAt 
                        ? new Date(webhook.updatedAt).toLocaleDateString('tr-TR')
                        : '-';
                    
                    tableHtml += `
                        <tr>
                            <td>${statusBadge}</td>
                            <td><strong>${webhook.name}</strong></td>
                            <td style="font-size: 12px; font-family: monospace; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${webhook.url}">${webhook.url}</td>
                            <td>${eventsHtml || '-'}</td>
                            <td style="font-size: 13px;">${updatedDate}</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="testWebhookById('${doc.id}')" title="Test Et">🧪</button>
                                <button class="btn btn-sm btn-warning" onclick="editWebhook('${doc.id}')" title="Düzenle">✏️</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteWebhook('${doc.id}', '${webhook.name}')" title="Sil">🗑️</button>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                webhookList.innerHTML = tableHtml;
                
                console.log(`✅ ${querySnapshot.size} webhook yüklendi`);
                
            } catch (error) {
                console.error('Error loading webhooks:', error);
                showAlert('Webhook\'lar yüklenirken hata oluştu.', 'danger');
            }
        }
        
        // ✅ Webhook Ekleme/Düzenleme Modalı Göster
        window.showWebhookAddModal = function() {
            document.getElementById('webhookModalTitle').textContent = '➕ Yeni Webhook Ekle';
            document.getElementById('webhookForm').reset();
            document.getElementById('webhookId').value = '';
            document.getElementById('webhookActive').checked = true;
            
            // Default olarak bazı event'leri işaretle
            document.querySelectorAll('input[name="webhookEventTypes"]').forEach(cb => {
                cb.checked = ['whatsapp_message', 'new_member', 'payment', 'contract_signed'].includes(cb.value);
            });
            
            document.getElementById('webhookModal').style.display = 'block';
        };
        
        // ✅ Webhook Düzenleme
        window.editWebhook = async function(webhookId) {
            try {
                const webhookDoc = await window.firebase.getDoc(
                    window.firebase.doc(window.db, 'webhooks', webhookId)
                );
                
                if (!webhookDoc.exists()) {
                    showAlert('Webhook bulunamadı!', 'danger');
                    return;
                }
                
                const webhook = webhookDoc.data();
                
                document.getElementById('webhookModalTitle').textContent = '✏️ Webhook Düzenle';
                document.getElementById('webhookId').value = webhookId;
                document.getElementById('webhookName').value = webhook.name || '';
                document.getElementById('webhookUrl').value = webhook.url || '';
                document.getElementById('webhookActive').checked = webhook.active !== false;
                
                // Event types
                document.querySelectorAll('input[name="webhookEventTypes"]').forEach(cb => {
                    cb.checked = (webhook.eventTypes || []).includes(cb.value);
                });
                
                document.getElementById('webhookModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading webhook:', error);
                showAlert('Webhook yüklenirken hata oluştu!', 'danger');
            }
        };
        
        // ✅ Modal Kapatma
        window.closeWebhookModal = function() {
            document.getElementById('webhookModal').style.display = 'none';
            document.getElementById('webhookForm').reset();
        };
        
        // ✅ Webhook Kaydetme (Yeni veya Güncelleme)
        window.saveWebhook = async function(event) {
            event.preventDefault();
            
            const form = event.target;
            const webhookId = form.webhookId.value;
            const webhookName = form.webhookName.value.trim();
            const webhookUrl = form.webhookUrl.value.trim();
            const active = form.webhookActive.checked;
            
            if (!webhookName || !webhookUrl) {
                showAlert('Lütfen webhook adı ve URL\'ini girin.', 'warning');
                return;
            }
            
            // Get selected event types
            const eventTypes = Array.from(form.querySelectorAll('input[name="webhookEventTypes"]:checked'))
                .map(cb => cb.value);
            
            const webhookData = {
                name: webhookName,
                url: webhookUrl,
                active: active,
                eventTypes: eventTypes,
                clubId: currentClubId,
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser.fullName || currentUser.email
            };
            
            try {
                if (webhookId) {
                    // Update existing
                    await window.firebase.updateDoc(
                        window.firebase.doc(window.db, 'webhooks', webhookId),
                        webhookData
                    );
                    showAlert('✅ Webhook başarıyla güncellendi!', 'success');
                } else {
                    // Create new
                    webhookData.createdAt = new Date().toISOString();
                    await window.firebase.addDoc(
                        window.firebase.collection(window.db, 'webhooks'),
                        webhookData
                    );
                    showAlert('✅ Webhook başarıyla eklendi!', 'success');
                }
                
                closeWebhookModal();
                loadWebhookSettings();
                
            } catch (error) {
                console.error('Error saving webhook:', error);
                showAlert('❌ Webhook kaydedilirken hata oluştu!', 'danger');
            }
        };
        
        // ✅ Webhook Silme
        window.deleteWebhook = async function(webhookId, webhookName) {
            if (!confirm(`"${webhookName}" webhook'unu silmek istediğinize emin misiniz?`)) {
                return;
            }
            
            try {
                await window.firebase.deleteDoc(
                    window.firebase.doc(window.db, 'webhooks', webhookId)
                );
                
                showAlert('✅ Webhook başarıyla silindi!', 'success');
                loadWebhookSettings();
                
            } catch (error) {
                console.error('Error deleting webhook:', error);
                showAlert('❌ Webhook silinirken hata oluştu!', 'danger');
            }
        };
        
        // ✅ Webhook Test (ID ile)
        window.testWebhookById = async function(webhookId) {
            try {
                const webhookDoc = await window.firebase.getDoc(
                    window.firebase.doc(window.db, 'webhooks', webhookId)
                );
                
                if (!webhookDoc.exists()) {
                    showAlert('Webhook bulunamadı!', 'danger');
                    return;
                }
                
                const webhook = webhookDoc.data();
                
                if (!webhook.active) {
                    if (!confirm('Bu webhook pasif durumda. Test etmek istiyor musunuz?')) {
                        return;
                    }
                }
                
                const testPayload = {
                    event: 'test',
                    clubId: currentClubId,
                    clubName: clubInfo.clubName || 'Test Kulübü',
                    timestamp: new Date().toISOString(),
                    message: 'Bu bir test mesajıdır',
                    webhookName: webhook.name
                };
                
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                showAlert('🔄 Test ediliyor...', 'info');
                
                const response = await fetch(webhook.url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(testPayload)
                });
                
                if (response.ok) {
                    const responseText = await response.text();
                    showAlert(`✅ Webhook test başarılı! (${response.status})`, 'success');
                    console.log('Webhook test response:', responseText);
                } else {
                    showAlert(`❌ Webhook test başarısız! (${response.status} ${response.statusText})`, 'danger');
                }
                
            } catch (error) {
                console.error('Webhook test error:', error);
                showAlert(`❌ Webhook test hatası: ${error.message}`, 'danger');
            }
        };
        
        // ✅ Sözleşme Linki Kopyalama
        window.copyContractLink = function() {
            const linkInput = document.getElementById('contractLink');
            linkInput.select();
            document.execCommand('copy');
            showAlert('✅ Sözleşme linki kopyalandı!', 'success');
        };
        
        // ✅ Kayıt tamamlandı mesajı önizlemesini güncelle
        window.updateSuccessPreview = function() {
            const title = document.getElementById('contract-success-title')?.value || 'Kayıt İşleminiz Tamamlandı!';
            const message = document.getElementById('contract-success-message')?.value || 'Teşekkür ederiz! Kayıt işleminiz başarıyla tamamlandı.';
            
            const previewTitle = document.getElementById('preview-title');
            const previewMessage = document.getElementById('preview-message');
            
            if (previewTitle) {
                previewTitle.textContent = title;
            }
            
            if (previewMessage) {
                previewMessage.textContent = message;
            }
        };
        
        // ✅ Dinamik branş IBAN alanlarını oluştur
        function renderDynamicBranchIbanFields() {
            const container = document.getElementById('dynamic-branch-iban-container');
            if (!container || !branches || branches.length === 0) {
                if (container) container.innerHTML = '<p style="color: #999;">Henüz branş eklenmemiş. Lütfen önce branş ekleyin.</p>';
                return;
            }
            
            const colors = ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#F44336', '#00BCD4'];
            
            container.innerHTML = branches.map((branch, index) => {
                const branchId = branch.id;
                const color = colors[index % colors.length];
                
                return `
                    <div style="background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid ${color};">
                        <h5 style="color: ${color}; margin-bottom: 15px;">${branch.icon || '📁'} ${branch.name} Branşı</h5>
                        
                        <div class="form-group">
                            <label for="iban_name_${branchId}">Hesap Sahibi</label>
                            <input type="text" id="iban_name_${branchId}" class="form-control" 
                                   placeholder="Örn: Ömer Bulut">
                            <small style="color: #666;">Üyelere gösterilecek hesap sahibi adı</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="iban_${branchId}">IBAN Numarası</label>
                            <input type="text" id="iban_${branchId}" class="form-control" 
                                   placeholder="TR00 0000 0000 0000 0000 0000 00"
                                   maxlength="32">
                            <small style="color: #666;">Türkiye IBAN formatında giriniz</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="payment_instructions_${branchId}">Ödeme Talimatları (İsteğe Bağlı)</label>
                            <textarea id="payment_instructions_${branchId}" class="form-control" rows="2" 
                                      placeholder="Ödeme yaparken açıklama kısmına üye adınızı yazınız"></textarea>
                            <small style="color: #666;">Üyelere gösterilecek ek ödeme talimatları</small>
                        </div>
                    </div>
                `;
            }).join('');
            
            console.log('✅ Dinamik IBAN alanları oluşturuldu:', branches.length, 'branş');
        }
        
        // ✅ Sözleşme Şablonu Yükleme
        async function loadContractTemplate() {
            try {
                // Kulüp adını al
                const clubName = clubSettings?.clubName || currentUser?.clubName || 'Kulüp';
                
                // URL-friendly slug oluştur
                const clubSlug = createSlug(clubName);
                
                // Kulübe özel linki oluştur ve göster (slug ile)
                // Base URL - direkt domain kullan, /uyeyeni/ ekleme
                const baseUrl = window.location.origin;
                const contractLink = `${baseUrl}/kayit?club=${clubSlug}`;
                document.getElementById('contractLink').value = contractLink;
                document.getElementById('contractLinkOpen').href = contractLink;
                
                // Kulüp adını göster (okunabilir halde)
                const clubNameEl = document.getElementById('contractClubName');
                if (clubNameEl) {
                    clubNameEl.textContent = clubName;
                }
                
                const contractDoc = await window.firebase.getDoc(
                    window.firebase.doc(window.db, 'settings', `contract_${currentClubId}`)
                );
                
                // ✅ Dinamik branş IBAN alanlarını oluştur
                renderDynamicBranchIbanFields();
                
                if (contractDoc.exists()) {
                    const data = contractDoc.data();
                    
                    // ✅ Sözleşme içeriğini olduğu gibi yükle (kulüp bilgileri elle yazılmalı)
                    document.getElementById('contractTemplate').value = data.text || '';
                    document.getElementById('contract-enabled').checked = data.enabled || false;
                    
                    // Sayfa başlıkları
                    document.getElementById('contract-page-title').value = data.pageTitle || 'Spor Kulübü';
                    document.getElementById('contract-page-subtitle').value = data.pageSubtitle || 'Üyelik Sözleşmesi';
                    
                    // Checkbox metinleri
                    document.getElementById('contract-checkbox1-text').value = data.checkbox1Text || 'Üyelik sözleşmesini okudum, anladım ve kabul ediyorum.';
                    document.getElementById('contract-checkbox2-text').value = data.checkbox2Text || 'Üyeliğiniz iptal edilene kadar devam etmektedir. Her ayın 14\'ü, yeni dönem için kayıt iptali yapılabilecek son gündür. Bu tarihe kadar iptal edilmeyen kayıtlar, devam eden dönem için geçerli sayılır.';
                    
                    // Kayıt tamamlandı mesajı
                    document.getElementById('contract-success-title').value = data.successTitle || 'Kayıt İşleminiz Tamamlandı!';
                    document.getElementById('contract-success-message').value = data.successMessage || 'Ailemize hoş geldiniz! Üyelik sözleşmeniz kulübümüze başarıyla ulaşmıştır. En kısa sürede sizinle iletişime geçeceğiz.';
                    
                    // Önizlemeyi güncelle
                    if (typeof window.updateSuccessPreview === 'function') {
                        window.updateSuccessPreview();
                    }
                    
                    // ✅ Dinamik branş IBAN bilgilerini yükle
                    if (data.branchPayments) {
                        console.log('💾 Branş ödeme bilgileri yükleniyor:', data.branchPayments);
                        
                        branches.forEach(branch => {
                            const branchId = branch.id;
                            const branchPayment = data.branchPayments[branchId];
                            
                            if (branchPayment) {
                                const nameInput = document.getElementById(`iban_name_${branchId}`);
                                const ibanInput = document.getElementById(`iban_${branchId}`);
                                const instructionsInput = document.getElementById(`payment_instructions_${branchId}`);
                                
                                if (nameInput) nameInput.value = branchPayment.name || '';
                                if (ibanInput) ibanInput.value = branchPayment.iban || '';
                                if (instructionsInput) instructionsInput.value = branchPayment.paymentInstructions || '';
                                
                                console.log(`✅ ${branch.name} IBAN bilgileri yüklendi`);
                            }
                        });
                    } else {
                        console.log('ℹ️ Branş ödeme bilgisi bulunamadı (yeni kullanıcı)');
                    }
                } else {
                    // Varsayılan şablon - HTML etiketli
                    document.getElementById('contractTemplate').value = `<h4>1. TARAFLAR</h4>

<p><strong>A-KULÜP</strong><br>
Adı-Soyadı: {KULUP_YETKILI}<br>
Ünvanı: {KULUP_ADI}<br>
Adres: {KULUP_ADRES}<br>
Vergi No: {KULUP_VERGI_NO}<br>
Telefon: {KULUP_TELEFON}<br>
E-mail: {KULUP_EMAIL}<br>
Bu sözleşmede bundan sonra "EĞİTMEN/KULÜP" olarak anılacaktır.</p>

<p><strong>B-ÜYE/VELİ</strong><br>
Adı-Soyadı: {UYE_AD_SOYAD}<br>
Doğum Tarihi: {UYE_DOGUM_TARIHI}<br>
Adres: {UYE_ADRES}<br>
TCKN: {UYE_TCKN}<br>
Telefon: {UYE_TELEFON}<br>
Branş: {BRANS}<br>
Bu sözleşmede bundan sonra "ÜYE/VELİ" olarak anılacaktır.</p>

<p>Üye/Veli işbu sözleşmeyi onaylaması sırasında Eğitmen tarafından kendisinden talep edilen her türlü bilgiyi eksiksiz ve doğru olarak Eğitmene vermeyi kabul etmektedir.</p>

<hr>

<h4>2. KONU</h4>
<p>İşbu üyelik sözleşmesi, üyelik işlemlerinin gerçekleştirilmesi ile işbu sözleşmenin onaylanması suretiyle, Eğitmen tarafından sunulacak hizmetin şartlarını ve tarafların karşılıklı hak ve yükümlülüklerini düzenlemektedir.</p>

<hr>

<h4>3. ÖDEME PLANI</h4>
{AIDAT_TAKVIMI}

<p>Ödemelerin her ayın 20'sine kadar belirtilen hesaba yapılması gerekmektedir. Ödemelerin zamanında yapılmaması durumunda; Üye/Veli, yapacağı ödemenin %25'i tutarında cezai şart ödemeyi kabul ve taahhüt eder.</p>

<hr>

<h4>4. ÜYELİK İPTALLERİ</h4>
<p>Her ayın 14'ü kayıt sildirme için son gündür. Bu tarihler sonrasında yapılan kayıt sildirmelerde yeni dönem ücreti tahsil edilir.</p>

<hr>

<h4>5. GENEL HÜKÜMLER</h4>
<p>Kulübe veya kulüp tesislerine zarar verici davranışlarda bulunulması durumunda kulüp üyeliği sonlandırılabilir. Eğitmen, her türlü üyelik talebini hiçbir gerekçe göstermeksizin tek taraflı olarak reddetme hakkına sahiptir.</p><br>
2) Eğitmenden, suç işlememiş ve herhangi bir yüz kızartıcı suçtan sabıka kaydı bulunmayan T.C. vatandaşları ile yabancı uyruklu kişiler ders alabilir.<br>
3) Üye/Veli, üyelik için gerekli olan her türlü belgeyi eksiksiz ve doğru bir şekilde temin edecektir.<br>
4) Üyelerin spor faaliyetine katılmak için gerekli sağlık şartlarını taşıyıp taşımadıkları, tıbbi kontrollerini yaptırıp yaptırmadıkları sorumluluğu Üye/Veliye aittir.<br>
5) Üyelerin, ders veya aktivitelerden faydalanmamaları halinde dahi belirlenen bedelleri zamanında ve tam olarak ödemeleri zorunludur.<br>
6) Üye/Veli, kendisinin veya misafirlerinin şahsi kusurları, dikkatsizliği veya ihmalleri ile kulübe veya 3. kişilere ait eşyalar üzerinde meydana getirecekleri tüm hasar ve zarardan sorumludur.</p>

<p>B) KULÜP KURALLARI<br>
a) Grup dersleri aylık 8 derstir.<br>
b) Grup derslerinde ders bir kez işlendiğinden, üyenin katılamadığı dersler için telafi yapılmaz.<br>
c) Özel ders paketleri 1 aylık süreyle geçerlidir. Bu süre içinde kullanılmayan ders hakları bir sonraki aya devredilmez.<br>
d) Spor branşlarında herhangi bir kaza, yaralanma veya sağlık problemi durumunda sorumluluk tamamen Üye/Veliye aittir.<br>
e) Üyelerin derse zamanında, uygun kıyafetle ve hazır şekilde gelmesi Üye/Velilerin sorumluluğundadır.</p>

<p>C) GENEL KURALLAR<br>
1) Kulüp bünyesinde Üye/Veliler genel nezaket kurallarına uymakla yükümlüdürler. Kort içinde veya dışında nezaket kurallarına uymayan davranışlarda bulunan, huzuru kaçıran, hakaret, küfür kullanan Üye/Velilerin Üye/Velilikleri herhangi bir uyarıya gerek kalmadan resen iptal edilebilir.<br>
2) Kayıp eşyalardan Kulüp sorumlu değildir.<br>
3) Kulüp içine dışarıdan yiyecek içecek getirmek yasaktır.<br>
4) Kulüp sınırları içerisinde sigara içmek yasaktır.</p>

<p><strong>8-) KİŞİSEL VERİLERİN İŞLENMESİ</strong><br>
Üye/Veli, işbu sözleşmeye taraf olma suretiyle, verdiği tüm bilgilerin ve kişisel verilerinin, KVKK kapsamında işlenmesine açıkça rıza gösterdiğini kabul eder.</p>

<p><strong>9-) SON HÜKÜMLER</strong><br>
1) Bu anlaşmanın uygulanmasından kaynaklanan tüm ihtilaflar yerel mahkemeler ve icra dairelerinde çözülecektir.<br>
2) Üye/Veli, adres ve iletişim bilgilerindeki değişiklikleri Eğitmene bildirmekle yükümlüdür.</p>

<p><strong>Sözleşme Tarihi:</strong> {TARIH}</p>

{OGRENCI_BILGILERI}

<p>ÜYE/VELİ (Otomatik Doldurulur)<br>
Adı Soyadı: {UYE_AD_SOYAD}<br>
İmza: _________________</p>

<p>EĞİTMEN/KULÜP<br>
Adı Soyadı: <strong>[Buraya yetkili adı soyadını yazın]</strong><br>
İmza: _________________</p>`;
                    document.getElementById('contract-enabled').checked = false;
                }
                
            } catch (error) {
                console.error('Error loading contract template:', error);
                showAlert('Sözleşme şablonu yüklenirken hata oluştu.', 'danger');
            }
        }
        
        // ✅ Sözleşme Şablonu Kaydetme
        window.saveContractTemplate = async function(event) {
            event.preventDefault();
            
            const form = event.target;
            const contractText = form.contractText.value.trim();
            const enabled = form.contractEnabled.checked;
            
            if (!contractText) {
                showAlert('Lütfen sözleşme metnini girin.', 'warning');
                return;
            }
            
            try {
                const contractData = {
                    text: contractText,
                    enabled: enabled,
                    clubId: currentClubId,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.fullName || currentUser.email,
                    
                    // Sayfa başlıkları
                    pageTitle: form.pageTitle.value.trim(),
                    pageSubtitle: form.pageSubtitle.value.trim(),
                    
                    // Onay checkbox metinleri
                    checkbox1Text: form.checkbox1Text.value.trim(),
                    checkbox2Text: form.checkbox2Text.value.trim(),
                    
                    // Kayıt tamamlandı mesajı
                    successTitle: form.successTitle.value.trim(),
                    successMessage: form.successMessage.value.trim()
                };
                
                
                console.log('💾 saveContractTemplate çalıştı - Form verileri:', contractData);
                console.log('📦 Mevcut branşlar:', branches);
                
                // Dinamik branş bazlı IBAN bilgilerini topla
                contractData.branchPayments = {};
                
                branches.forEach(branch => {
                    const branchId = branch.id;
                    console.log(`🔍 Branş işleniyor: ${branch.name} (ID: ${branchId})`);
                    
                    const ibanInput = document.getElementById(`iban_${branchId}`);
                    const nameInput = document.getElementById(`iban_name_${branchId}`);
                    const instructionsInput = document.getElementById(`payment_instructions_${branchId}`);
                    
                    console.log(`   iban input: ${ibanInput ? 'bulundu ✅' : 'YOK ❌'}`);
                    console.log(`   name input: ${nameInput ? 'bulundu ✅' : 'YOK ❌'}`);
                    console.log(`   instructions input: ${instructionsInput ? 'bulundu ✅' : 'YOK ❌'}`);
                    
                    if (ibanInput || nameInput || instructionsInput) {
                        const ibanValue = ibanInput?.value?.trim() || '';
                        const nameValue = nameInput?.value?.trim() || '';
                        const instructionsValue = instructionsInput?.value?.trim() || '';
                        
                        console.log(`   📝 Değerler - IBAN: "${ibanValue}", Name: "${nameValue}", Instructions: "${instructionsValue}"`);
                        
                        if (ibanValue || nameValue || instructionsValue) {
                            contractData.branchPayments[branchId] = {
                                branchName: branch.name,
                                iban: ibanValue,
                                name: nameValue,
                                paymentInstructions: instructionsValue
                            };
                            console.log(`   ✅ Branş ödeme bilgisi eklendi!`);
                        } else {
                            console.log(`   ⚠️ Tüm alanlar boş, eklenmedi`);
                        }
                    } else {
                        console.log(`   ❌ Hiçbir input bulunamadı!`);
                    }
                });
                
                console.log('💾 Kaydedilecek branchPayments:', contractData.branchPayments);
                console.log('📤 Kaydedilecek TÜM contractData:', contractData);
                
                await window.firebase.setDoc(
                    window.firebase.doc(window.db, 'settings', `contract_${currentClubId}`),
                    contractData
                );
                
                showAlert('✅ Sözleşme şablonu başarıyla kaydedildi! Tüm ayarlarınız güncellendi.', 'success');
            } catch (error) {
                console.error('Error saving contract template:', error);
                showAlert('❌ Sözleşme şablonu kaydedilirken hata oluştu!', 'danger');
            }
        };
        
        
        function switchSettingsTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.settings-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.settings-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(`settings-tab-${tabName}`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Activate button
            event.target.classList.add('active');
            
            // Load data
            switchSettingsTabLoadData(tabName);
        }
        
        // Branş şablon tab switching
        window.switchBranchTemplateTab = function(branchName) {
            // Hide all branch template sections
            document.querySelectorAll('.branch-templates-content').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remove active class from all branch tab buttons
            const templatesTabs = document.getElementById('settings-tab-templates');
            if (templatesTabs) {
                templatesTabs.querySelectorAll('.settings-tab').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to clicked button  
                event.target.classList.add('active');
            }
            
            // Show selected branch template section
            const selectedSection = document.getElementById(`branch-templates-${branchName}`);
            if (selectedSection) {
                selectedSection.style.display = 'block';
            }
        };
        
        // Şablon metnini kopyalama fonksiyonu
        window.copyTemplateText = function(textareaId) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;
            
            // Textarea'yı seç
            textarea.select();
            textarea.setSelectionRange(0, 99999); // Mobil Cihazlar için
            
            // Clipboard'a kopyala
            try {
                document.execCommand('copy');
                
                // Başarılı bildirim göster
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '✓';
                button.style.background = '#4CAF50';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '#667eea';
                }, 1500);
            } catch (err) {
                console.error('Kopyalama hatası:', err);
                alert('Kopyalama başarısız oldu.');
            }
            
            // Seçimi kaldır
            window.getSelection().removeAllRanges();
        };
        
        // Dinamik branş şablonlarını render et
        function renderBranchTemplates() {
            const tabsContainer = document.getElementById('branchTemplateTabsContainer');
            const templatesContainer = document.getElementById('dynamicBranchTemplatesContainer');
            
            if (!tabsContainer || !templatesContainer) return;
            
            // Branş sekmelerini oluştur
            let tabsHtml = '';
            branches.forEach((branch, index) => {
                tabsHtml += `<button type="button" class="settings-tab ${index === 0 ? 'active' : ''}" onclick="switchBranchTemplateTab('${branch.id}')">${branch.icon} ${branch.name}</button>`;
            });
            tabsHtml += `<button type="button" class="settings-tab" onclick="switchBranchTemplateTab('gorev')">📋 Görev Şablonları</button>`;
            tabsContainer.innerHTML = tabsHtml;
            
            // Branş şablonlarını oluştur
            let templatesHtml = '';
            
            branches.forEach((branch, index) => {
                const branchId = branch.id;
                const branchName = branch.name;
                const branchIcon = branch.icon;
                
                templatesHtml += `
                    <div id="branch-templates-${branchId}" class="branch-templates-content" style="display: ${index === 0 ? 'block' : 'none'};">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; color: white;">
                            <strong>${branchIcon} ${branchName} Branşı</strong><br>
                            <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">${branchName} branşındaki üyeler için mesaj şablonları</p>
                        </div>
                        ${generateTemplateTypes(branchId, branchName)}
                    </div>
                `;
            });
            
            // Görev şablonlarını ekle
            templatesHtml += `
                <div id="branch-templates-gorev" class="branch-templates-content" style="display: none;">
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; color: white;">
                        <strong>📋 Görev Şablonları</strong><br>
                        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">Görev yönetimi için mesaj şablonları</p>
                    </div>
                    ${generateTaskTemplates()}
                </div>
            `;
            
            templatesContainer.innerHTML = templatesHtml;
        }
        
        // Şablon türlerini oluştur (yatay layout ile)
        function generateTemplateTypes(branchId, branchName) {
            const sportName = branchName === 'Tenis' ? 'Tenisçimiz' : branchName === 'Yüzme' ? 'Yüzücümüz' : 'Öğrencimiz';
            const templates = [
                {
                    id: 'birthday',
                    icon: '🎂',
                    title: 'Doğum Günü Kutlama',
                    childDefault: `Sevgili {UYE_AD_SOYAD},

${sportName} {OGRENCI_AD_SOYAD}'nın doğum gününü en içten dileklerimizle kutlar, sağlık ve mutluluk dolu nice yıllar dileriz! 🎂🎉

${branchName} ailemizin bir parçası olduğunuz için çok mutluyuz.

İyi ki doğdun! 🎈`,
                    adultDefault: `Sevgili {UYE_AD_SOYAD},

Doğum gününüzü en içten dileklerimizle kutlar, sağlık ve mutluluk dolu nice yıllar dileriz! 🎂🎉

${branchName} ailemizin bir parçası olduğunuz için çok mutluyuz.

İyi ki doğdunuz! 🎈`,
                    variables: '{UYE_AD_SOYAD}, {OGRENCI_AD_SOYAD}'
                },
                {
                    id: 'payment',
                    icon: '💰',
                    title: 'Gecikmiş Aidat Hatırlatma',
                    childDefault: `Sayın {UYE_AD_SOYAD},

Velisi olduğunuz {OGRENCI_AD_SOYAD} için {TUTAR} TL tutarındaki ödemeniz {TARIH} tarihinden beri gecikmiş durumdadır.

📅 Dönem: {DONEM_BASLANGIC} - {DONEM_BITIS}
📚 Ders Sayısı: {DERS_SAYISI}

En kısa sürede ödemenizi yapmanızı rica ederiz.

Teşekkür ederiz.
${branchName}`,
                    adultDefault: `Sayın {UYE_AD_SOYAD},

{TUTAR} TL tutarındaki ödemeniz {TARIH} tarihinden beri gecikmiş durumdadır.

📅 Dönem: {DONEM_BASLANGIC} - {DONEM_BITIS}
📚 Ders Sayısı: {DERS_SAYISI}

En kısa sürede ödemenizi yapmanızı rica ederiz.

Teşekkür ederiz.
${branchName}`,
                    variables: '{UYE_AD_SOYAD}, {OGRENCI_AD_SOYAD}, {TUTAR}, {TARIH}, {DONEM_BASLANGIC}, {DONEM_BITIS}, {DERS_SAYISI}'
                },
                {
                    id: 'absence',
                    icon: '📅',
                    title: 'Devamsızlık Bildirimi',
                    childDefault: `Sayın {UYE_AD_SOYAD},

Velisi olduğunuz {OGRENCI_AD_SOYAD}'nın {TARIH} tarihindeki {DERS} dersine katılamadığını fark ettik.

Umarız her şey yolundadır. Herhangi bir sorun varsa bizimle iletişime geçebilirsiniz.

Geçmiş olsun.
${branchName}`,
                    adultDefault: `Sayın {UYE_AD_SOYAD},

{TARIH} tarihindeki {DERS} dersine katılamadığınızı fark ettik.

Umarız her şey yolundadır. Herhangi bir sorun varsa bizimle iletişime geçebilirsiniz.

Geçmiş olsun.
${branchName}`,
                    variables: '{UYE_AD_SOYAD}, {OGRENCI_AD_SOYAD}, {TARIH}, {DERS}'
                },
                {
                    id: 'announcement',
                    icon: '📢',
                    title: 'Genel Duyuru',
                    childDefault: `Sayın {UYE_AD_SOYAD},

Velisi olduğunuz {OGRENCI_AD_SOYAD} ile ilgili kulübümüzden önemli bir duyuru:

{MESAJ}

Bilgilerinize sunarız.
${branchName}`,
                    adultDefault: `Sayın {UYE_AD_SOYAD},

Kulübümüzden önemli bir duyuru:

{MESAJ}

Bilgilerinize sunarız.
${branchName}`,
                    variables: '{UYE_AD_SOYAD}, {OGRENCI_AD_SOYAD}, {MESAJ}'
                },
                {
                    id: 'upcomingPayment',
                    icon: '⏰',
                    title: 'Yaklaşan Ödeme Hatırlatma',
                    childDefault: `Sayın {UYE_AD_SOYAD},

Velisi olduğunuz {OGRENCI_AD_SOYAD} için {TARIH} tarihinde {TUTAR} TL tutarında ödemeniz bulunmaktadır. ({GUN_KALDI} gün kaldı)

📅 Dönem: {DONEM_BASLANGIC} - {DONEM_BITIS}
📚 Ders Sayısı: {DERS_SAYISI}

Zamanında ödemenizi hatırlatmak isteriz.

Teşekkür ederiz.
${branchName}`,
                    adultDefault: `Sayın {UYE_AD_SOYAD},

{TARIH} tarihinde {TUTAR} TL tutarında ödemeniz bulunmaktadır. ({GUN_KALDI} gün kaldı)

📅 Dönem: {DONEM_BASLANGIC} - {DONEM_BITIS}
📚 Ders Sayısı: {DERS_SAYISI}

Zamanında ödemenizi hatırlatmak isteriz.

Teşekkür ederiz.
${branchName}`,
                    variables: '{UYE_AD_SOYAD}, {OGRENCI_AD_SOYAD}, {TUTAR}, {TARIH}, {GUN_KALDI}, {DONEM_BASLANGIC}, {DONEM_BITIS}, {DERS_SAYISI}'
                },
                {
                    id: 'pendingRegistration',
                    icon: '⏳',
                    title: 'Bekleyen Kayıt Hatırlatma',
                    childDefault: `Sayın {UYE_AD_SOYAD},

Kulübümüze {OGRENCI_AD_SOYAD} için ön kaydınız alınmıştır. 🎉

Ancak kayıt işlemleriniz henüz tamamlanmamıştır. Kayıt formunuz hazırlanmıştır.

Kaydınızı tamamlamak için lütfen aşağıdaki linke tıklayın:
{LINK}

Sorularınız için bize ulaşabilirsiniz.

Teşekkür ederiz.
${branchName}`,
                    adultDefault: `Sayın {UYE_AD_SOYAD},

Kulübümüze ön kaydınız alınmıştır. 🎉

Ancak kayıt işlemleriniz henüz tamamlanmamıştır. Kayıt formunuz hazırlanmıştır.

Kaydınızı tamamlamak için lütfen aşağıdaki linke tıklayın:
{LINK}

Sorularınız için bize ulaşabilirsiniz.

Teşekkür ederiz.
${branchName}`,
                    variables: '{UYE_AD_SOYAD}, {OGRENCI_AD_SOYAD}, {LINK}, {TARIH}'
                },
                {
                    id: 'trialReminder',
                    icon: '🎯',
                    title: 'Deneme Dersi Hatırlatma',
                    childDefault: `Merhaba {UYE_AD_SOYAD},

${branchIcon} ${branchName} deneme dersiniz için sizi bekliyoruz!

📅 Tarih: {TARIH}
🕐 Saat: {SAAT}
📍 Adres: {ADRES}

Yanınızda spor kıyafeti ve içecek getirmeyi unutmayın.

Görüşmek üzere!
{KULUP_ADI}`,
                    adultDefault: `Merhaba {UYE_AD_SOYAD},

${branchIcon} ${branchName} deneme dersiniz için sizi bekliyoruz!

📅 Tarih: {TARIH}
🕐 Saat: {SAAT}
📍 Adres: {ADRES}

Yanınızda spor kıyafeti ve içecek getirmeyi unutmayın.

Görüşmek üzere!
{KULUP_ADI}`,
                    variables: '{UYE_AD_SOYAD}, {TARIH}, {SAAT}, {ADRES}, {KULUP_ADI}'
                }
            ];
            
            let html = '';
            templates.forEach(template => {
                html += `
                    <div class="settings-subsection" style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
                        <h4 class="settings-subtitle">${template.icon} ${template.title}</h4>
                        
                        <!-- Yatay Layout: Çocuk ve Yetişkin Yan Yana -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <!-- Çocuk Üyeler -->
                            <div style="border-left: 4px solid #4CAF50; padding-left: 10px;">
                                <label style="font-weight: 600; color: #4CAF50; margin-bottom: 8px; display: block;">👶 Çocuk Üyeler (Veliye gönderilir)</label>
                                <div style="position: relative;">
                                    <textarea 
                                        id="template-${branchId}-${template.id}-child" 
                                        name="${branchId}_${template.id}Child" 
                                        class="form-control" 
                                        rows="6" 
                                        style="width: 100%; padding: 8px; padding-right: 45px; resize: vertical; min-height: 120px; box-sizing: border-box;"
                                    >${template.childDefault || ''}</textarea>
                                    <button type="button" onclick="copyTemplateText('template-${branchId}-${template.id}-child')" style="position: absolute; top: 8px; right: 8px; padding: 4px 8px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;" title="Kopyala">📋</button>
                                </div>
                            </div>
                            
                            <!-- Yetişkin Üyeler -->
                            <div style="border-left: 4px solid #2196F3; padding-left: 10px;">
                                <label style="font-weight: 600; color: #2196F3; margin-bottom: 8px; display: block;">👤 Yetişkin Üyeler</label>
                                <div style="position: relative;">
                                    <textarea 
                                        id="template-${branchId}-${template.id}-adult" 
                                        name="${branchId}_${template.id}Adult" 
                                        class="form-control" 
                                        rows="6" 
                                        style="width: 100%; padding: 8px; padding-right: 45px; resize: vertical; min-height: 120px; box-sizing: border-box;"
                                    >${template.adultDefault || ''}</textarea>
                                    <button type="button" onclick="copyTemplateText('template-${branchId}-${template.id}-adult')" style="position: absolute; top: 8px; right: 8px; padding: 4px 8px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;" title="Kopyala">📋</button>
                                </div>
                            </div>
                        </div>
                        
                        <small style="color: #666; display: block; margin-bottom: 10px;">Kullanılabilir değişkenler: <code>${template.variables}</code></small>
                        
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <input type="checkbox" id="${branchId}-${template.id}-enabled" name="${branchId}_${template.id}Enabled" style="width: auto;">
                            <label for="${branchId}-${template.id}-enabled" style="margin: 0;">Bu şablonu etkinleştir</label>
                        </div>
                        
                        ${template.id === 'upcomingPayment' ? `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                            <h5 style="font-size: 14px; font-weight: 600; margin-bottom: 10px; color: #495057;">⏰ Gönderim Zamanlaması</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; font-size: 13px; margin-bottom: 5px; color: #6c757d;">Son ödeme tarihinden kaç gün önce?</label>
                                    <input type="number" id="${branchId}-${template.id}-daysBefore" name="${branchId}_${template.id}DaysBefore" 
                                           min="1" max="30" value="2" 
                                           style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 13px; margin-bottom: 5px; color: #6c757d;">Saat (HH:MM)</label>
                                    <input type="time" id="${branchId}-${template.id}-sendTime" name="${branchId}_${template.id}SendTime" 
                                           value="10:00" 
                                           style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                                </div>
                            </div>
                            <small style="color: #6c757d; display: block; margin-top: 8px;">Örnek: 2 gün önce, saat 10:00'da mesaj gönderilir.</small>
                        </div>
                        ` : ''}
                        
                        ${template.id === 'payment' ? `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffc107;">
                            <h5 style="font-size: 14px; font-weight: 600; margin-bottom: 10px; color: #856404;">⏰ Gönderim Zamanlaması</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; font-size: 13px; margin-bottom: 5px; color: #856404;">Son ödeme tarihinden kaç gün sonra?</label>
                                    <input type="number" id="${branchId}-${template.id}-daysAfter" name="${branchId}_${template.id}DaysAfter" 
                                           min="1" max="30" value="2" 
                                           style="width: 100%; padding: 8px; border: 1px solid #ffc107; border-radius: 4px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 13px; margin-bottom: 5px; color: #856404;">Saat (HH:MM)</label>
                                    <input type="time" id="${branchId}-${template.id}-sendTime" name="${branchId}_${template.id}SendTime" 
                                           value="14:00" 
                                           style="width: 100%; padding: 8px; border: 1px solid #ffc107; border-radius: 4px;">
                                </div>
                            </div>
                            <small style="color: #856404; display: block; margin-top: 8px;">Örnek: Son ödeme tarihinden 2 gün sonra, saat 14:00'da mesaj gönderilir.</small>
                        </div>
                        ` : ''}
                        
                        ${template.id === 'trialReminder' ? `
                        <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; border: 1px solid #2196F3;">
                            <h5 style="font-size: 14px; font-weight: 600; margin-bottom: 10px; color: #1565c0;">⏰ Gönderim Zamanlaması</h5>
                            <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; font-size: 13px; margin-bottom: 5px; color: #1565c0;">Deneme dersi günü saat kaçta gönderilsin?</label>
                                    <input type="time" id="${branchId}-${template.id}-sendTime" name="${branchId}_${template.id}SendTime" 
                                           value="09:00" 
                                           style="width: 100%; padding: 8px; border: 1px solid #2196F3; border-radius: 4px;">
                                </div>
                            </div>
                            <small style="color: #1565c0; display: block; margin-top: 8px;">Örnek: Deneme dersi günü saat 09:00'da mesaj gönderilir.</small>
                        </div>
                        ` : ''}
                    </div>
                `;
            });
            
            return html;
        }
        
        // Görev şablonlarını oluştur
        function generateTaskTemplates() {
            return `
                <div class="settings-subsection" style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
                    <h4 class="settings-subtitle">📋 Görev Bildirimi Şablonu</h4>
                    <div style="position: relative; margin-bottom: 15px;">
                        <textarea id="template-task" name="task" class="form-control" rows="6" style="width: 100%; padding: 8px; padding-right: 45px; resize: vertical; min-height: 120px; box-sizing: border-box;">Sayın {UYE_AD_SOYAD},

Size yeni bir görev atandı:

📋 Görev: {GOREV}
📝 Açıklama: {ACIKLAMA}
📅 Tarih: {TARIH}

İyi çalışmalar dileriz.</textarea>
                        <button type="button" onclick="copyTemplateText('template-task')" style="position: absolute; top: 8px; right: 8px; padding: 4px 8px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;" title="Kopyala">📋</button>
                    </div>
                    <small style="color: #666; display: block; margin-bottom: 10px;">Kullanılabilir değişkenler: <code>{UYE_AD_SOYAD}, {GOREV}, {ACIKLAMA}, {TARIH}</code></small>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="task-enabled" name="taskEnabled" style="width: auto;">
                        <label for="task-enabled" style="margin: 0;">Görev atandığında otomatik mesaj gönder</label>
                    </div>
                </div>
                
                <div class="settings-subsection" style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
                    <h4 class="settings-subtitle">⏰ Görev Hatırlatma Şablonu</h4>
                    <div style="position: relative; margin-bottom: 15px;">
                        <textarea id="template-taskReminder" name="taskReminder" class="form-control" rows="6" style="width: 100%; padding: 8px; padding-right: 45px; resize: vertical; min-height: 120px; box-sizing: border-box;">Sayın {UYE_AD_SOYAD},

"{GOREV}" görevi için hatırlatma:

📋 Görev: {GOREV}

📝 Açıklama: {ACIKLAMA}

Görevin tamamlanmasını bekliyoruz.

İyi çalışmalar dileriz.</textarea>
                        <button type="button" onclick="copyTemplateText('template-taskReminder')" style="position: absolute; top: 8px; right: 8px; padding: 4px 8px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;" title="Kopyala">📋</button>
                    </div>
                    <small style="color: #666; display: block; margin-bottom: 10px;">Kullanılabilir değişkenler: <code>{UYE_AD_SOYAD}, {GOREV}, {ACIKLAMA}, {TARIH}, {GUN_KALDI}</code></small>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="taskReminder-enabled" name="taskReminderEnabled" style="width: auto;">
                        <label for="taskReminder-enabled" style="margin: 0;">Görev hatırlatması için otomatik mesaj gönder</label>
                    </div>
                </div>
                
                <div class="settings-subsection" style="margin-bottom: 30px;">
                    <h4 class="settings-subtitle">💬 Görev Mesajı Bildirimi Şablonu</h4>
                    <div style="position: relative; margin-bottom: 15px;">
                        <textarea id="template-taskMessage" name="taskMessage" class="form-control" rows="6" style="width: 100%; padding: 8px; padding-right: 45px; resize: vertical; min-height: 120px; box-sizing: border-box;">Sayın {UYE_AD_SOYAD},

"{GOREV}" görevi için yeni bir mesaj aldınız:

💬 {MESAJ}
📤 Gönderen: {GONDEREN}
📅 Tarih: {TARIH}

Görev detaylarını kontrol ediniz.</textarea>
                        <button type="button" onclick="copyTemplateText('template-taskMessage')" style="position: absolute; top: 8px; right: 8px; padding: 4px 8px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;" title="Kopyala">📋</button>
                    </div>
                    <small style="color: #666; display: block; margin-bottom: 10px;">Kullanılabilir değişkenler: <code>{UYE_AD_SOYAD}, {GOREV}, {MESAJ}, {GONDEREN}, {TARIH}</code></small>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="taskMessage-enabled" name="taskMessageEnabled" style="width: auto;">
                        <label for="taskMessage-enabled" style="margin: 0;">Görev mesajı eklendiğinde otomatik bildirim gönder</label>
                    </div>
                </div>
            `;
        }
        
        function switchSettingsTabLoadData(tabName) {
            // Load data when switching tabs
            if (tabName === 'club') {
                loadClubInfo();
            } else if (tabName === 'contract') {
                loadContractTemplate();
            } else if (tabName === 'templates') {
                // Render dynamic branch templates
                renderBranchTemplates();
                // Load template data
                loadMessageTemplates();
            } else if (tabName === 'webhook') {
                loadWebhookSettings();
            } else if (tabName === 'general') {
                loadWhatsAppSettings(); // Bulutfon ve diğer genel ayarları yükle
            }
            
            // Load WhatsApp instances if switching to WhatsApp tab
            if (tabName === 'whatsapp') {
                loadWhatsAppInstances();
            }
            
            // Load message templates if switching to templates tab
            if (tabName === 'templates') {
                loadMessageTemplates();
            }
            
            // Load branches when switching to branches tab
            if (tabName === 'branches') {
                renderBranchesTable();
            }
            
            // Load users when switching to users tab
            if (tabName === 'users') {
                renderUsersTable();
            }
        }
        
        // --- MESSAGE TEMPLATES FUNCTIONS ---
        // ✅ messageTemplates artık global (satır ~281)
        
        // Varsayılan mesaj şablonlarını döndür
        function getDefaultMessageTemplates() {
            return {
                missedCall: {
                    textWorkingHours: 'Merhaba,\n\nSize ulaşmaya çalıştık ancak ulaşamadık.\n\n{TARIH} tarihinde bizi aramıştınız.\n\nSizinle görüşmek ve sorularınızı yanıtlamak isteriz. Lütfen uygun olduğunuzda bizi tekrar arayabilirsiniz.\n\nTeşekkürler,',
                    textOutsideHours: 'Merhaba,\n\nSize ulaşmaya çalıştık ancak ulaşamadık.\n\n{TARIH} tarihinde bizi aramıştınız.\n\nŞu anda mesai saatlerimiz dışındayız. Mesai saatlerimiz: {MESAI_SAATLERI}\n\nMesai saatlerinde bizi tekrar arayabilir veya size dönüş yapabiliriz.\n\nTeşekkürler,',
                    enabled: true,
                    autoSend: false // Otomatik gönderim kapalı (manuel butonla gönderilecek)
                },
                birthday: {
                    textChild: 'Sayın {UYE_AD_SOYAD},\n\nTenisçimiz {OGRENCI_AD_SOYAD}\'nın doğum gününü en içten dileklerimizle kutlarız! 🎂🎾\n\nNice mutlu, sağlıklı ve başarılı yıllar dileriz.',
                    textAdult: 'Sayın {UYE_AD_SOYAD},\n\nDoğum gününüzü en içten dileklerimizle kutlarız! 🎂🎾\n\nNice mutlu, sağlıklı ve başarılı yıllar dileriz.',
                    enabled: false
                },
                payment: {
                    textChild: 'Sayın {UYE_AD_SOYAD},\n\nVelisi olduğunuz {OGRENCI_AD_SOYAD} için {TUTAR} TL tutarındaki ödemeniz {TARIH} tarihinden beri gecikmiş durumdadır.\n\nEn kısa sürede ödemenizi yapmanızı rica ederiz.\n\nTeşekkür ederiz.',
                    textAdult: 'Sayın {UYE_AD_SOYAD},\n\n{TUTAR} TL tutarındaki ödemeniz {TARIH} tarihinden beri gecikmiş durumdadır.\n\nEn kısa sürede ödemenizi yapmanızı rica ederiz.\n\nTeşekkür ederiz.',
                    enabled: true
                },
                absence: {
                    textChild: 'Sayın {UYE_AD_SOYAD},\n\nVelisi olduğunuz {OGRENCI_AD_SOYAD}\'nın {TARIH} tarihindeki {DERS} dersine katılamadığını fark ettik.\n\nUmarız her şey yolundadır.\n\nGeçmiş olsun.',
                    textAdult: 'Sayın {UYE_AD_SOYAD},\n\n{TARIH} tarihindeki {DERS} dersine katılamadığınızı fark ettik.\n\nUmarız her şey yolundadır.\n\nGeçmiş olsun.',
                    enabled: false
                },
                announcement: {
                    textChild: 'Sayın {UYE_AD_SOYAD},\n\nVelisi olduğunuz {OGRENCI_AD_SOYAD} ile ilgili kulübümüzden önemli bir duyuru:\n\n{MESAJ}\n\nBilgilerinize sunarız.',
                    textAdult: 'Sayın {UYE_AD_SOYAD},\n\nKulübümüzden önemli bir duyuru:\n\n{MESAJ}\n\nBilgilerinize sunarız.',
                    enabled: false
                },
                upcomingPayment: {
                    textChild: 'Sayın {UYE_AD_SOYAD},\n\nVelisi olduğunuz {OGRENCI_AD_SOYAD} için {TARIH} tarihinde {TUTAR} TL tutarında ödemeniz bulunmaktadır.\n\nZamanında ödemenizi hatırlatmak isteriz.\n\nTeşekkür ederiz.',
                    textAdult: 'Sayın {UYE_AD_SOYAD},\n\n{TARIH} tarihinde {TUTAR} TL tutarında ödemeniz bulunmaktadır.\n\nZamanında ödemenizi hatırlatmak isteriz.\n\nTeşekkür ederiz.',
                    enabled: false
                },
                pendingRegistration: {
                    textChild: 'Sayın {UYE_AD_SOYAD},\n\nKulübümüze {OGRENCI_AD_SOYAD} için ön kaydınız alınmıştır. 🎉\n\nKaydınızı tamamlamak için lütfen aşağıdaki linke tıklayın:\n{LINK}\n\nTeşekkür ederiz.',
                    textAdult: 'Sayın {UYE_AD_SOYAD},\n\nKulübümüze ön kaydınız alınmıştır. 🎉\n\nKaydınızı tamamlamak için lütfen aşağıdaki linke tıklayın:\n{LINK}\n\nTeşekkür ederiz.',
                    enabled: false
                },
                trialReminder: {
                    textChild: 'Merhaba {UYE_AD_SOYAD},\n\nDeneme dersiniz için sizi bekliyoruz!\n\n📅 Tarih: {TARIH}\n🕐 Saat: {SAAT}\n📍 Adres: {ADRES}\n\nGörüşmek üzere!',
                    textAdult: 'Merhaba {UYE_AD_SOYAD},\n\nDeneme dersiniz için sizi bekliyoruz!\n\n📅 Tarih: {TARIH}\n🕐 Saat: {SAAT}\n📍 Adres: {ADRES}\n\nGörüşmek üzere!',
                    enabled: false
                },
                registrationComplete: {
                    textChild: 'Sayın {UYE_AD_SOYAD},\n\n{OGRENCI_AD_SOYAD} için kaydınız başarıyla tamamlanmıştır! 🎉\n\nHoş geldiniz!\n\nDerslere başlama tarihi: {TARIH}',
                    textAdult: 'Sayın {UYE_AD_SOYAD},\n\nKaydınız başarıyla tamamlanmıştır! 🎉\n\nHoş geldiniz!\n\nDerslere başlama tarihi: {TARIH}',
                    enabled: false
                }
            };
        }
        
        async function loadMessageTemplates() {
            try {
                // ✅ Supabase'den mesaj şablonlarını yükle
                const { data: settingsData, error } = await supabase
                    .from('settings')
                    .select('data')
                    .eq('id', `messageTemplates_${currentClubId}`)
                    .maybeSingle(); // ✅ single() yerine maybeSingle() - kayıt yoksa null döner
                
                if (error) {
                    console.error('❌ Mesaj şablonları yüklenirken hata:', error);
                    // Varsayılan şablonları kullan
                    messageTemplates = getDefaultMessageTemplates();
                    return;
                }
                
                if (settingsData && settingsData.data) {
                    messageTemplates = settingsData.data;
                    console.log('✅ Mesaj şablonları Supabase\'den yüklendi:', messageTemplates);
                    
                    // ✅ Eğer eski format ise varsayılanları ekle
                    const hasNewFormat = messageTemplates.payment || messageTemplates.birthday || messageTemplates.missedCall;
                    if (!hasNewFormat) {
                        console.log('⚠️ Eski format tespit edildi, varsayılan şablonlar ekleniyor...');
                        const defaults = getDefaultMessageTemplates();
                        messageTemplates = { ...messageTemplates, ...defaults };
                    }
                } else {
                    // Default templates - varsayılan oluştur ve kaydet
                    console.log('⚠️ Mesaj şablonları bulunamadı, varsayılanlar oluşturuluyor...');
                    messageTemplates = getDefaultMessageTemplates();
                    
                    // ✅ Varsayılan şablonları Supabase'e kaydet
                    const { error: insertError } = await supabase
                        .from('settings')
                        .upsert({
                            id: `messageTemplates_${currentClubId}`,
                            clubId: currentClubId,
                            data: messageTemplates
                        });
                    
                    if (insertError) {
                        console.error('❌ Varsayılan şablonlar kaydedilemedi:', insertError);
                    } else {
                        console.log('✅ Varsayılan mesaj şablonları Supabase\'e kaydedildi');
                    }
                }
                
                // ✅ Şablonların durumunu logla (DETAYLI)
                console.log('📋 Yüklenen mesaj şablonları (DETAYLI):', {
                    birthday: messageTemplates.birthday,
                    absence: messageTemplates.absence,
                    payment: messageTemplates.payment,
                    upcomingPayment: messageTemplates.upcomingPayment,
                    'payment.enabled': messageTemplates.payment?.enabled,
                    'messageTemplates nesne tipi': typeof messageTemplates,
                    'messageTemplates keys': Object.keys(messageTemplates)
                });
                
                // Fill form with templates - Dinamik branş şablonları için
                const templateTypes = ['birthday', 'payment', 'absence', 'announcement', 'upcomingPayment', 'pendingRegistration', 'trialReminder', 'registrationComplete'];
                
                branches.forEach(branch => {
                    templateTypes.forEach(templateType => {
                        const branchTemplates = messageTemplates[branch.id];
                        const childElem = document.getElementById(`template-${branch.id}-${templateType}-child`);
                        const adultElem = document.getElementById(`template-${branch.id}-${templateType}-adult`);
                        const enabledElem = document.getElementById(`${branch.id}-${templateType}-enabled`);
                        
                        // Eğer veritabanında kayıtlı değer varsa onu kullan
                        if (childElem && branchTemplates?.[templateType]?.textChild) {
                            childElem.value = branchTemplates[templateType].textChild;
                        }
                        // Değilse default değer zaten textarea içinde var
                        
                        if (adultElem && branchTemplates?.[templateType]?.textAdult) {
                            adultElem.value = branchTemplates[templateType].textAdult;
                        }
                        
                        if (enabledElem) {
                            enabledElem.checked = branchTemplates?.[templateType]?.enabled || false;
                        }
                        
                        // ✅ Zamanlama ayarlarını yükle
                        if (templateType === 'upcomingPayment') {
                            const daysBeforeElem = document.getElementById(`${branch.id}-${templateType}-daysBefore`);
                            const sendTimeElem = document.getElementById(`${branch.id}-${templateType}-sendTime`);
                            if (daysBeforeElem && branchTemplates?.[templateType]?.daysBefore) {
                                daysBeforeElem.value = branchTemplates[templateType].daysBefore;
                            }
                            if (sendTimeElem && branchTemplates?.[templateType]?.sendTime) {
                                sendTimeElem.value = branchTemplates[templateType].sendTime;
                            }
                        } else if (templateType === 'payment') {
                            const daysAfterElem = document.getElementById(`${branch.id}-${templateType}-daysAfter`);
                            const sendTimeElem = document.getElementById(`${branch.id}-${templateType}-sendTime`);
                            if (daysAfterElem && branchTemplates?.[templateType]?.daysAfter) {
                                daysAfterElem.value = branchTemplates[templateType].daysAfter;
                            }
                            if (sendTimeElem && branchTemplates?.[templateType]?.sendTime) {
                                sendTimeElem.value = branchTemplates[templateType].sendTime;
                            }
                        } else if (templateType === 'trialReminder') {
                            const sendTimeElem = document.getElementById(`${branch.id}-${templateType}-sendTime`);
                            if (sendTimeElem && branchTemplates?.[templateType]?.sendTime) {
                                sendTimeElem.value = branchTemplates[templateType].sendTime;
                            }
                        }
                    });
                });
                
                // Görev şablonları (Branş bağımsız)
                const taskElem = document.getElementById('template-task');
                const taskEnabledElem = document.getElementById('task-enabled');
                if (taskElem && messageTemplates.task?.text) {
                    taskElem.value = messageTemplates.task.text;
                }
                if (taskEnabledElem) {
                    taskEnabledElem.checked = messageTemplates.task?.enabled || false;
                }
                
                const taskReminderElem = document.getElementById('template-taskReminder');
                const taskReminderEnabledElem = document.getElementById('taskReminder-enabled');
                if (taskReminderElem && messageTemplates.taskReminder?.text) {
                    taskReminderElem.value = messageTemplates.taskReminder.text;
                }
                if (taskReminderEnabledElem) {
                    taskReminderEnabledElem.checked = messageTemplates.taskReminder?.enabled || false;
                }
                
                const taskMessageElem = document.getElementById('template-taskMessage');
                const taskMessageEnabledElem = document.getElementById('taskMessage-enabled');
                if (taskMessageElem && messageTemplates.taskMessage?.text) {
                    taskMessageElem.value = messageTemplates.taskMessage.text;
                }
                if (taskMessageEnabledElem) {
                    taskMessageEnabledElem.checked = messageTemplates.taskMessage?.enabled || false;
                }
                
                // ✅ Cevapsız çağrı şablonları (Branş bağımsız)
                const missedCallWorkingElem = document.getElementById('template-missedCall-working');
                const missedCallOutsideElem = document.getElementById('template-missedCall-outside');
                const missedCallEnabledElem = document.getElementById('missedCall-enabled');
                const missedCallAutoSendElem = document.getElementById('missedCall-autoSend');
                
                if (missedCallWorkingElem && messageTemplates.missedCall?.textWorkingHours) {
                    missedCallWorkingElem.value = messageTemplates.missedCall.textWorkingHours;
                }
                if (missedCallOutsideElem && messageTemplates.missedCall?.textOutsideHours) {
                    missedCallOutsideElem.value = messageTemplates.missedCall.textOutsideHours;
                }
                if (missedCallEnabledElem) {
                    missedCallEnabledElem.checked = messageTemplates.missedCall?.enabled || false;
                }
                if (missedCallAutoSendElem) {
                    missedCallAutoSendElem.checked = messageTemplates.missedCall?.autoSend || false;
                }
                
            } catch (error) {
                showAlert('Şablonlar yüklenirken hata oluştu.', 'danger');
            }
        }
        
        window.saveMessageTemplates = async function(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            const templates = {
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser?.email || 'admin'
            };
            
            // Her branş için şablonları kaydet
            const templateTypes = ['birthday', 'payment', 'absence', 'announcement', 'upcomingPayment', 'pendingRegistration', 'trialReminder', 'registrationComplete'];
            
            branches.forEach(branch => {
                const branchId = branch.id;
                templates[branchId] = {};
                
                templateTypes.forEach(templateType => {
                    const childKey = `${branchId}_${templateType}Child`;
                    const adultKey = `${branchId}_${templateType}Adult`;
                    const enabledKey = `${branchId}_${templateType}Enabled`;
                    
                    const childValue = formData.get(childKey);
                    const adultValue = formData.get(adultKey);
                    const enabledValue = formData.get(enabledKey);
                    
                    templates[branchId][templateType] = {
                        textChild: childValue ? childValue.trim() : '',
                        textAdult: adultValue ? adultValue.trim() : '',
                        text: childValue ? childValue.trim() : '', // Backward compatibility
                        enabled: enabledValue === 'on'
                    };
                    
                    // ✅ Zamanlama ayarlarını ekle
                    if (templateType === 'upcomingPayment') {
                        const daysBeforeKey = `${branchId}_${templateType}DaysBefore`;
                        const sendTimeKey = `${branchId}_${templateType}SendTime`;
                        templates[branchId][templateType].daysBefore = parseInt(formData.get(daysBeforeKey) || '2');
                        templates[branchId][templateType].sendTime = formData.get(sendTimeKey) || '10:00';
                    } else if (templateType === 'payment') {
                        const daysAfterKey = `${branchId}_${templateType}DaysAfter`;
                        const sendTimeKey = `${branchId}_${templateType}SendTime`;
                        templates[branchId][templateType].daysAfter = parseInt(formData.get(daysAfterKey) || '2');
                        templates[branchId][templateType].sendTime = formData.get(sendTimeKey) || '14:00';
                    } else if (templateType === 'trialReminder') {
                        const sendTimeKey = `${branchId}_${templateType}SendTime`;
                        templates[branchId][templateType].sendTime = formData.get(sendTimeKey) || '09:00';
                    }
                });
            });
            
            // Görev şablonları (branş bağımsız)
            templates.task = {
                text: formData.get('task') ? formData.get('task').trim() : '',
                enabled: formData.get('taskEnabled') === 'on'
            };
            
            templates.taskReminder = {
                text: formData.get('taskReminder') ? formData.get('taskReminder').trim() : '',
                enabled: formData.get('taskReminderEnabled') === 'on'
            };
            
            templates.taskMessage = {
                text: formData.get('taskMessage') ? formData.get('taskMessage').trim() : '',
                enabled: formData.get('taskMessageEnabled') === 'on'
            };
            
            // ✅ Cevapsız çağrı mesaj şablonu (branş bağımsız)
            templates.missedCall = {
                textWorkingHours: formData.get('missedCallWorkingHours') ? formData.get('missedCallWorkingHours').trim() : '',
                textOutsideHours: formData.get('missedCallOutsideHours') ? formData.get('missedCallOutsideHours').trim() : '',
                enabled: formData.get('missedCallEnabled') === 'on',
                autoSend: formData.get('missedCallAutoSend') === 'on'
            };
            
            try {
                // ✅ Supabase'e kaydet
                const { error } = await supabase
                    .from('settings')
                    .upsert({
                        id: `messageTemplates_${currentClubId}`,
                        clubId: currentClubId,
                        data: templates
                    });
                
                if (error) {
                    console.error('Şablon kaydetme hatası:', error);
                    throw error;
                }
                
                messageTemplates = templates;
                showAlert('✅ Şablonlar başarıyla kaydedildi!', 'success');
                console.log('✅ Mesaj şablonları Supabase\'e kaydedildi:', templates);
            } catch (error) {
                console.error('Şablon kaydetme hatası:', error);
                showAlert('❌ Şablonlar kaydedilirken hata oluştu: ' + error.message, 'danger');
            }
        };
        
        // --- WHATSAPP EVOLUTION API FUNCTIONS ---
        const EVOLUTION_API_URL = "https://evo-2.edu-ai.online";
        const EVOLUTION_API_KEY = "iHAF8gWNA1axdRDY9e98UKpork00dBO2";
        
        // WhatsApp Header Actions
        
        window.searchInMessages = function() {
            if (!currentWhatsAppContact) return;
            const searchTerm = prompt('🔍 Mesajlarda ara:', '');
            if (!searchTerm) return;
            
            // TODO: Implement message search
            showAlert(`"${searchTerm}" aranıyor...\n\n(Arama özelliği yakında eklenecek)`, 'info');
        };
        
        window.showContactInfo = function() {
            if (!currentWhatsAppContact) return;
            
            const contact = currentWhatsAppContact;
            const phone = formatPhoneDisplay(contact.phone);
            
            let info = `👤 ${contact.name}\n📱 ${phone}\n`;
            
            if (contact.type === 'member') {
                info += `\n✅ Bu kişi kayıtlı bir üyedir`;
                if (contact.memberId) {
                    setTimeout(() => {
                        showMemberAttendancePage(contact.memberId);
                    }, 500);
                }
            } else if (contact.type === 'crm') {
                info += `\n📋 Bu kişi CRM kaydında`;
                if (contact.leadId) {
                    setTimeout(() => {
                        openCrmLeadDetail(contact.leadId);
                    }, 500);
                }
            } else {
                info += `\n➕ Bu kişi henüz kayıtlı değil`;
            }
            
            showAlert(info, 'info');
        };
        
        window.showMoreOptions = function() {
            if (!currentWhatsAppContact) return;
            
            const options = [
                '📋 Kişi Bilgileri',
                '🔄 Sohbeti Yenile',
                '🗑️ Sohbeti Temizle',
                '🔇 Bildirimleri Kapat',
                '⭐ Favori Olarak İşaretle'
            ];
            
            showAlert('Daha fazla seçenek:\n\n' + options.join('\n') + '\n\n(Özellikler yakında eklenecek)', 'info');
        };
        
        // 🧪 Debug sent messages
        window.debugSentMessages = function(phone) {
            const normalizedPhone = formatPhoneForWhatsApp(phone || currentWhatsAppContact?.phone);
            
            console.log('🔍 DEBUG SENT MESSAGES');
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━');
            console.log('📱 Aranan telefon:', phone || currentWhatsAppContact?.phone);
            console.log('📱 Normalize edilmiş:', normalizedPhone);
            console.log('🔧 Seçili cihaz:', selectedWhatsAppDevice?.instanceName);
            console.log('📦 Toplam sentMessages:', sentMessages.length);
            console.log('');
            
            if (sentMessages.length > 0) {
                console.log('📝 İlk 5 mesaj:');
                sentMessages.slice(0, 5).forEach((m, i) => {
                    const recipientNormalized = formatPhoneForWhatsApp(m.recipientPhone || '');
                    const phoneMatch = recipientNormalized === normalizedPhone;
                    const instanceMatch = m.instanceName === selectedWhatsAppDevice?.instanceName;
                    
                    console.log(`\n${i + 1}. Mesaj:`);
                    console.log('   recipientPhone:', m.recipientPhone);
                    console.log('   normalized:', recipientNormalized);
                    console.log('   instanceName:', m.instanceName);
                    console.log('   message:', m.message?.substring(0, 50));
                    console.log('   sentAt:', m.sentAt);
                    console.log('   ✓ Phone match:', phoneMatch);
                    console.log('   ✓ Instance match:', instanceMatch);
                    console.log('   ✓ WOULD SHOW:', phoneMatch && instanceMatch);
                });
            }
            
            // Şimdi filtrelemeyi test et
            const filtered = sentMessages.filter(m => {
                const recipientNormalized = formatPhoneForWhatsApp(m.recipientPhone || '');
                return recipientNormalized === normalizedPhone && 
                       m.instanceName === selectedWhatsAppDevice?.instanceName;
            });
            
            console.log('\n━━━━━━━━━━━━━━━━━━━━━━━━');
            console.log(`✅ Eşleşen mesaj sayısı: ${filtered.length}`);
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━\n');
            
            return filtered;
        };
        
        
        
        async function handleWhatsAppInstanceCreate(e) {
            e.preventDefault();
            const form = e.target;
            const instanceName = form.instanceName.value.trim();
            const phoneNumber = document.getElementById('newInstancePhone').value.trim();
            
            // ✅ Sabit API değerleri kullanılıyor
            const evolutionUrl = EVOLUTION_API_URL;
            const apiKey = EVOLUTION_API_KEY;
            
            if (!instanceName) {
                return showAlert('Cihaz adı zorunludur.', 'warning');
            }
            
            if (!phoneNumber) {
                return showAlert('Telefon numarası zorunludur.', 'warning');
            }
            
            // Show loading state
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '⏳ Cihaz oluşturuluyor...';
            
            try {
                // 🔍 DEBUG: Request parametrelerini logla
                const hasWebhook = !!clubSettings?.evolutionWebhookUrl;
                console.log('🚀 Evolution API Instance Create Request:');
                console.log('  Instance Name:', instanceName);
                console.log('  Phone:', phoneNumber);
                console.log('  Evolution URL:', evolutionUrl);
                console.log('  API Key:', apiKey?.substring(0, 10) + '...');
                console.log('  Webhook Enabled:', hasWebhook);
                if (hasWebhook) {
                    console.log('  Webhook URL:', clubSettings.evolutionWebhookUrl);
                }
                
                // Create instance via Evolution API (using user-provided URL and API Key)
                const requestBody = {
                    instanceName: instanceName,
                    number: phoneNumber,
                    owner: phoneNumber,
                    qrcode: true,
                    integration: "WHATSAPP-BAILEYS",
                    // 🔧 WEBHOOK DISABLED - 403 hatası düzeltmesi
                    // Firebase'de çalışıyordu çünkü webhook yoktu
                    // Webhook URL olmadan Evolution API 403 verebilir
                    // Webhook'u sadece URL varsa aktif et
                    ...(clubSettings?.evolutionWebhookUrl ? {
                        webhook: {
                            enabled: true,
                            url: clubSettings.evolutionWebhookUrl,
                            events: [
                                "MESSAGES_UPSERT",
                                "MESSAGES_UPDATE",
                                "MESSAGES_DELETE",
                                "SEND_MESSAGE",
                                "CALL_UPSERT",
                                "CALL_OFFER",
                                "CALL_REJECT",
                                "CALL_ACCEPT"
                            ],
                            webhookByEvents: false,
                            webhookBase64: false
                        }
                    } : {})
                };
                
                console.log('  Request Body:', JSON.stringify(requestBody, null, 2));
                
                const response = await fetch(`${evolutionUrl}/instance/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': apiKey
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('  Response Status:', response.status, response.statusText);
                
                const data = await response.json();
                console.log('  Response Data:', data);
                
                // 🔍 Eğer response objesi varsa, detayını da göster
                if (data.response) {
                    console.log('  Response Detail:', data.response);
                    if (data.response.message) {
                        console.log('  → Message:', data.response.message);
                    }
                }
                
                if (response.ok) {
                    // ✅ Save to Supabase (evolutionUrl ve apiKey artık opsiyonel, hardcoded kullanılıyor)
                    const deviceId = `device_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    const deviceData = {
                        id: deviceId,
                        instanceName: instanceName,
                        phoneNumber: phoneNumber,
                        evolutionUrl: evolutionUrl, // Sabit değer
                        apiKey: apiKey, // Sabit değer
                        isConnected: false,
                        status: 'pending',
                        createdBy: currentUser?.email || 'unknown',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        lastUpdated: new Date().toISOString(),
                        clubId: currentClubId
                    };
                    
                    const { data: insertedDevice, error: insertError } = await supabase
                        .from('whatsappDevices')
                        .insert(deviceData)
                        .select()
                        .single();
                    
                    if (insertError) {
                        console.error('❌ Supabase insert error:', insertError);
                        showAlert('Cihaz Supabase\'e kaydedilemedi: ' + insertError.message, 'danger');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                        return;
                    }
                    
                    whatsappDevices.push(insertedDevice);
                    
                    showAlert('✅ Cihaz başarıyla oluşturuldu! QR kodu yükleniyor...', 'success');
                    form.reset();
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    
                    // Show loading modal first
                    showQRLoadingModal(instanceName);
                    
                    // Always fetch QR code from API after creation
                    setTimeout(() => {
                        fetchAndShowQR(instanceName, insertedDevice.id);
                    }, 500);
                    
                    // Reload instances after a delay
                    setTimeout(() => loadWhatsAppInstances(), 800);
                } else {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    
                    let errorMsg = '';
                    if (response.status === 403) {
                        console.error('🔒 EVOLUTION API 403 HATASI!');
                        console.error('Request URL:', `${evolutionUrl}/instance/create`);
                        console.error('API Key:', apiKey);
                        console.error('Response:', data);
                        
                        // Evolution API'nin verdiği detaylı mesajı çıkar
                        const errorDetail = data.response?.message || data.message || JSON.stringify(data);
                        
                        errorMsg = `🔒 Evolution API Erişim Hatası (403)\n\n`;
                        errorMsg += `❌ ${errorDetail}\n\n`;
                        errorMsg += `🔑 API Key: ${apiKey}\n`;
                        errorMsg += `🌐 URL: ${evolutionUrl}\n`;
                        errorMsg += `📱 Instance: ${instanceName}\n\n`;
                        
                        // Olası çözümler
                        if (errorDetail.toLowerCase().includes('already') || errorDetail.toLowerCase().includes('exist')) {
                            errorMsg += `� Çözüm: Bu instance adı zaten mevcut.\n`;
                            errorMsg += `   → Farklı bir instance adı deneyin\n`;
                            errorMsg += `   → Veya mevcut instance'ı kullanın`;
                        } else if (errorDetail.toLowerCase().includes('key') || errorDetail.toLowerCase().includes('auth')) {
                            errorMsg += `💡 Çözüm: API Key sorunu.\n`;
                            errorMsg += `   → Evolution API yöneticinizle iletişime geçin\n`;
                            errorMsg += `   → Yeni API Key isteyin`;
                        } else {
                            errorMsg += `📞 Çözüm: Evolution API yöneticinizle iletişime geçin.`;
                        }
                    } else {
                        errorMsg = `❌ Hata (${response.status}): ${data.message || data.error || 'Cihaz oluşturulamadı.'}`;
                    }
                    
                    showAlert(errorMsg, 'danger');
                }
            } catch (error) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                showAlert(`❌ Cihaz oluşturulurken hata oluştu.`, 'danger');
            }
        }
        
        function showQRLoadingModal(instanceName) {
            const modal = document.getElementById('qrCodeModal');
            if (!modal) return;
            
            const modalContent = modal.querySelector('.modal-content');
            if (!modalContent) return;
            
            document.getElementById('qrCodeTitle').textContent = `📱 ${instanceName} - QR Kod Hazırlanıyor`;
            
            const qrImage = document.getElementById('qrCodeImage');
            if (qrImage) {
                qrImage.src = '';
                qrImage.style.display = 'none';
            }
            
            // Add loading spinner
            const existingLoader = modalContent.querySelector('.qr-loading');
            if (!existingLoader) {
                const loader = document.createElement('div');
                loader.className = 'qr-loading';
                loader.innerHTML = '<div class="spinner"></div><p>QR kod oluşturuluyor, lütfen bekleyin...</p>';
                modalContent.insertBefore(loader, qrImage);
            }
            
            openModal('qrCodeModal');
        }
        
        async function loadWhatsAppInstances() {
            const container = document.getElementById('whatsappDevicesList');
            
            // ✅ Container kontrolü - sessizce çık
            if (!container) {
                return;
            }
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Cihazlar yükleniyor...</span></div>';
            
            try {
                // ✅ Supabase'den WhatsApp cihazlarını çek (message_sending_hours dahil)
                const { data: devices, error } = await supabase
                    .from('whatsappDevices')
                    .select('*')
                    .eq('clubId', currentUser.clubId)
                    .order('createdAt', { ascending: false });
                
                if (error) {
                    console.error('WhatsApp cihazları yüklenirken hata:', error);
                    container.innerHTML = '<p class="empty-state">Cihazlar yüklenirken hata oluştu.</p>';
                    return;
                }
                
                whatsappDevices = devices || []; // Global değişkene kaydet
                
                // ✅ Evolution API'den instance listesi çek ve senkronize et
                try {
                    const instanceResponse = await fetch(`${EVOLUTION_API_URL}/instance/fetchInstances`, {
                        method: 'GET',
                        headers: {
                            'apikey': EVOLUTION_API_KEY
                        }
                    });
                    
                    if (instanceResponse.ok) {
                        const evolutionInstances = await instanceResponse.json();
                        const evolutionInstanceNames = evolutionInstances.map(i => i.instance?.instanceName || i.instanceName).filter(Boolean);
                        
                        console.log('🔍 Evolution API instances:', evolutionInstanceNames);
                        
                        // Supabase'de olan ama Evolution'da olmayan cihazları bul ve sil
                        for (const device of whatsappDevices) {
                            if (!evolutionInstanceNames.includes(device.instanceName)) {
                                console.log(`🗑️ ${device.instanceName} Evolution'da yok, Supabase'den siliniyor...`);
                                
                                await supabase
                                    .from('whatsappDevices')
                                    .delete()
                                    .eq('id', device.id);
                                
                                // Local state'den de kaldır
                                const index = whatsappDevices.findIndex(d => d.id === device.id);
                                if (index !== -1) {
                                    whatsappDevices.splice(index, 1);
                                }
                            }
                        }
                    }
                } catch (syncError) {
                    console.warn('⚠️ Evolution API senkronizasyonu başarısız:', syncError.message);
                }
                
                if (whatsappDevices.length === 0) {
                    container.innerHTML = '<p class="empty-state">Henüz bağlı cihaz yok. Yukarıdan yeni cihaz ekleyebilirsiniz.</p>';
                } else {
                    container.innerHTML = whatsappDevices.map(device => {
                        const statusClass = device.status === 'connected' ? 'status-active' : (device.status === 'disconnected' ? 'status-inactive' : 'status-pending');
                        const statusText = device.status === 'connected' ? '🟢 Bağlı' : (device.status === 'disconnected' ? '🔴 Bağlantı Kesildi' : '🟡 Beklemede');
                        return `
                            <div class="whatsapp-device-card">
                                <div class="device-info">
                                    <h4>${device.instanceName}</h4>
                                    <p><span class="status-badge ${statusClass}">${statusText}</span></p>
                                    <p><small>📱 ${device.phoneNumber}</small></p>
                                    <p><small>📅 ${formatDate(device.createdAt)}</small></p>
                                </div>
                                    <div class="device-actions">
                                        ${device.status !== 'connected' ? `<button class="btn btn-info btn-sm" onclick="window.showInstanceQR('${device.instanceName}')">📷 QR Kod</button>` : ''}
                                        ${device.status === 'pending' ? `<button class="btn btn-success btn-sm" onclick="window.manualCheckConnection('${device.instanceName}', '${device.id}')">✔️ Durumu Kontrol Et</button>` : ''}
                                        <button class="btn btn-warning btn-sm" onclick="window.restartInstance('${device.instanceName}', '${device.id}')">🔄 Yeniden Başlat</button>
                                        <button class="btn btn-danger btn-sm" onclick="window.deleteInstance('${device.instanceName}', '${device.id}')">🗑️ Sil</button>
                                    </div>
                            </div>
                        `;
                    }).join('');
                }
                
                // Update test message device dropdown
                updateTestMessageDeviceDropdown();
                updateDefaultDeviceDropdown();
                loadSentMessagesLog();
            } catch (error) {
                container.innerHTML = '<p class="empty-state">Cihazlar yüklenirken hata oluştu.</p>';
            }
        }
        
        function updateTestMessageDeviceDropdown() {
            const select = document.getElementById('testMessageDevice');
            if (!select) return;
            
            // ✅ whatsappDevices henüz yüklenmediyse çık
            if (!whatsappDevices || whatsappDevices.length === 0) {
                select.innerHTML = '<option value="">Önce cihaz bağlayın...</option>';
                select.disabled = true;
                return;
            }
            
            const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
            
            if (connectedDevices.length === 0) {
                select.innerHTML = '<option value="">Önce cihaz bağlayın...</option>';
                select.disabled = true;
            } else {
                select.disabled = false;
                
                // ✅ Ana cihazı en üste koy, yıldızlı göster (admin2.html gibi)
                const defaultDevice = connectedDevices.find(d => d.instanceName === defaultWhatsAppDevice);
                const otherDevices = connectedDevices.filter(d => d.instanceName !== defaultWhatsAppDevice);
                
                let optionsHtml = '<option value="">Cihaz seçin...</option>';
                
                // Ana cihaz varsa en üste yıldızlı olarak ekle
                if (defaultDevice) {
                    optionsHtml += `<option value="${defaultDevice.instanceName}">⭐ ${defaultDevice.instanceName} (${defaultDevice.phoneNumber})</option>`;
                }
                
                // Diğer cihazları ekle
                otherDevices.forEach(device => {
                    optionsHtml += `<option value="${device.instanceName}">${device.instanceName} (${device.phoneNumber})</option>`;
                });
                
                select.innerHTML = optionsHtml;
            }
        }
        
        function updateDefaultDeviceDropdown() {
            const select = document.getElementById('default-whatsapp-device');
            if (!select) return;
            
            // ✅ whatsappDevices henüz yüklenmediyse çık
            if (!whatsappDevices || whatsappDevices.length === 0) {
                select.innerHTML = '<option value="">Önce cihaz bağlayın...</option>';
                select.disabled = true;
                return;
            }
            
            const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
            
            if (connectedDevices.length === 0) {
                select.innerHTML = '<option value="">Önce cihaz bağlayın...</option>';
                select.disabled = true;
            } else {
                select.disabled = false;
                
                // ✅ Ana cihazı en üste koy, yıldızlı göster (admin2.html gibi)
                const defaultDevice = connectedDevices.find(d => d.instanceName === defaultWhatsAppDevice);
                const otherDevices = connectedDevices.filter(d => d.instanceName !== defaultWhatsAppDevice);
                
                let optionsHtml = '<option value="">Cihaz seçin...</option>';
                
                // Ana cihaz varsa en üste yıldızlı olarak ekle
                if (defaultDevice) {
                    optionsHtml += `<option value="${defaultDevice.instanceName}" selected>⭐ ${defaultDevice.instanceName} (${defaultDevice.phoneNumber})</option>`;
                }
                
                // Diğer cihazları ekle
                otherDevices.forEach(device => {
                    optionsHtml += `<option value="${device.instanceName}">${device.instanceName} (${device.phoneNumber})</option>`;
                });
                
                select.innerHTML = optionsHtml;
            }
        }
        
        window.setDefaultWhatsAppDevice = async function(instanceName) {
            if (!instanceName) return;
            
            try {
                console.log('💾 Ana WhatsApp hattı kaydediliyor:', instanceName);
                
                // ✅ SUPABASE: settings tablosuna kaydet
                const { data, error } = await supabase
                    .from('settings')
                    .upsert({
                        id: `club_${currentClubId}`,
                        clubId: currentClubId,
                        data: {
                            ...clubSettings,
                            defaultWhatsAppDevice: instanceName
                        },
                        updatedAt: new Date().toISOString(),
                        updatedBy: currentUser?.email || 'admin'
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                defaultWhatsAppDevice = instanceName;
                clubSettings.defaultWhatsAppDevice = instanceName; // ✅ Local state güncelle
                
                console.log('✅ Ana WhatsApp hattı Supabase\'e kaydedildi:', instanceName);
                showAlert('✅ Ana WhatsApp hattı ayarlandı!', 'success');
                
                // Dropdown'ları güncelle
                updateDefaultDeviceDropdown();
                updateActiveDeviceDropdown();
            } catch (error) {
                console.error('❌ Ana WhatsApp hattı kaydedilemedi:', error);
                showAlert('❌ Ayar kaydedilemedi: ' + error.message, 'danger');
            }
        };
        
        function loadSentMessagesLog() {
            const container = document.getElementById('sentMessagesLog');
            if (!container) return;
            
            if (sentMessages.length === 0) {
                container.innerHTML = '<p class="empty-state">Henüz mesaj gönderilmedi.</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="table-container">
                    <table class="data-table" style="font-size: 12px;">
                        <thead>
                            <tr>
                                <th>Tarih/Saat</th>
                                <th>Alıcı</th>
                                <th>Mesaj</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sentMessages.map((msg, index) => `
                                <tr style="cursor: pointer;" onclick="showMessageDetail(${index})">
                                    <td style="white-space: nowrap;">${formatDate(msg.sentAt)}</td>
                                    <td>${msg.recipient}</td>
                                    <td style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        ${msg.message.substring(0, 50)}${msg.message.length > 50 ? '...' : ''}
                                    </td>
                                    <td>
                                        ${msg.success ? '<span style="color: green;">✓ Gönderildi</span>' : '<span style="color: red;">✗ Başarısız</span>'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        window.showMessageDetail = function(index) {
            const msg = sentMessages[index];
            if (!msg) return;
            
            const modal = document.getElementById('messageDetailModal');
            document.getElementById('messageDetailTitle').textContent = `📩 Mesaj Detayı - ${msg.recipient}`;
            document.getElementById('messageDetailRecipient').textContent = msg.recipient;
            document.getElementById('messageDetailPhone').textContent = msg.recipientPhone || '-';
            document.getElementById('messageDetailDate').textContent = formatDate(msg.sentAt);
            document.getElementById('messageDetailStatus').innerHTML = msg.success 
                ? '<span style="color: green; font-weight: bold;">✓ Gönderildi</span>' 
                : '<span style="color: red; font-weight: bold;">✗ Başarısız</span>';
            document.getElementById('messageDetailText').textContent = msg.message;
            document.getElementById('messageDetailInstance').textContent = msg.instanceName || '-';
            
            openModal('messageDetailModal');
        }
        
        // ===== WHATSAPP PAGE FUNCTIONS =====
        let currentWhatsAppContact = null;
        let whatsappMessages = {}; // { phoneNumber: [messages] }
        let whatsappContacts = []; // Kişi listesi
        
        let unreadMessagesCount = 0;
        let lastWhatsAppUnreadCount = -1; // İlk yükleme kontrolü için (-1 = henüz yüklenmedı)
        
        // ✅ OKUNDU BİLGİSİNİ KALICI SAKLA
        const STORAGE_KEY_READ_MESSAGES = 'whatsapp_read_messages_';
        
        // Okundu olarak işaretlenmiş konuşmaları yükle
        function loadReadContacts() {
            try {
                const storageKey = STORAGE_KEY_READ_MESSAGES + currentClubId;
                const saved = localStorage.getItem(storageKey);
                return saved ? JSON.parse(saved) : {};
            } catch (error) {
                console.error('❌ Okundu bilgisi yükleme hatası:', error);
                return {};
            }
        }
        
        // Konuşmayı okundu olarak işaretle
        function markContactAsRead(phone) {
            try {
                const storageKey = STORAGE_KEY_READ_MESSAGES + currentClubId;
                const readContacts = loadReadContacts();
                
                // ✅ Şu anki zamanı kaydet (her zaman son mesajdan sonra olacak)
                const now = Date.now();
                readContacts[phone] = now;
                
                localStorage.setItem(storageKey, JSON.stringify(readContacts));
                console.log(`✅ Konuşma okundu olarak işaretlendi: ${phone} (${new Date(now).toLocaleString()})`);
            } catch (error) {
                console.error('❌ Okundu bilgisi kaydetme hatası:', error);
            }
        }
        
        // Son okunma zamanını al (timestamp)
        function getLastReadTime(phone) {
            try {
                const readContacts = loadReadContacts();
                return readContacts[phone] || 0; // 0 = hiç okunmamış
            } catch (error) {
                console.error('❌ Okunma zamanı alınamadı:', error);
                return 0;
            }
        }
        
        // Konuşma okundu mu kontrol et
        function isContactRead(phone, lastMessageTime) {
            const readContacts = loadReadContacts();
            const readTime = readContacts[phone];
            if (!readTime) return false;
            // Eğer son mesaj okunma zamanından daha eskiyse, okundu sayılır
            return lastMessageTime <= readTime;
        }
        
        // selectedWhatsAppDevice zaten yukarıda tanımlandı (satır 118)
        
        function renderWhatsAppPage() {
            loadWhatsAppDevicesMain();
            updateActiveDeviceDropdown();
            updateTestMessageDeviceDropdown();
            updateDefaultDeviceDropdown();
            loadSentMessagesLog();
            updateBulkMessageSettings();
            loadWhatsAppSettings(); // Ayarları inputlara yükle
            renderMessageQueue(); // Mesaj Kuyruğunu göster
            
            // 🔥 Start Firebase realtime listeners (Priority)
            startWhatsAppRealtimeListeners();
            
            // Start auto-refresh for live updates (Fallback)
            startWhatsAppAutoRefresh();
            
            // ✅ Otomatik olarak ana cihazı seç (admin2.html ile aynı)
            if (!selectedWhatsAppDevice && defaultWhatsAppDevice) {
                const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
                const defaultDevice = connectedDevices.find(d => d.instanceName === defaultWhatsAppDevice);
                
                if (defaultDevice) {
                    selectedWhatsAppDevice = defaultDevice;
                    console.log('✅ Ana WhatsApp cihazı otomatik seçildi (renderWhatsAppPage):', defaultWhatsAppDevice);
                    
                    // Dropdown'ı güncelle
                    const deviceSelect = document.getElementById('whatsapp-active-device');
                    if (deviceSelect) {
                        deviceSelect.value = defaultWhatsAppDevice;
                    }
                    
                    // Mesajlaşma alanını göster
                    const messagingArea = document.getElementById('whatsapp-messaging-area');
                    if (messagingArea) {
                        messagingArea.style.display = 'block';
                    }
                    
                    // Kontakları yükle
                    loadWhatsAppContacts();
                }
            } else if (selectedWhatsAppDevice) {
                // Load contacts if device is already selected
                loadWhatsAppContacts();
            }
        }
        
        // Ayarları inputlara yükle
        function loadWhatsAppSettings() {
            console.log('🔄 loadWhatsAppSettings çağrıldı, clubSettings:', clubSettings);
            
            // ✅ Ana WhatsApp Hattı yükle (geriye dönük uyumluluk için her iki ismi de kontrol et)
            if (clubSettings.defaultWhatsAppDevice || clubSettings.defaultDevice) {
                defaultWhatsAppDevice = clubSettings.defaultWhatsAppDevice || clubSettings.defaultDevice;
                console.log('✅ Ana WhatsApp hattı yüklendi:', defaultWhatsAppDevice);
                
                // ✅ Dropdown'ları güncelle (sadece eğer cihazlar yüklenmişse)
                if (whatsappDevices && whatsappDevices.length > 0) {
                    updateDefaultDeviceDropdown();
                    updateActiveDeviceDropdown();
                }
            }
            
            // Çalışma saatleri ayarları
            try {
                if (clubSettings.workingHoursEnabled) {
                    const enabledCheckbox = document.getElementById('workingHoursEnabled');
                    const fieldsDiv = document.getElementById('workingHoursFields');
                    if (enabledCheckbox) enabledCheckbox.checked = true;
                    if (fieldsDiv) fieldsDiv.style.display = 'block';
                }
                
                if (clubSettings.workingHoursStart) {
                    const startInput = document.getElementById('workingHoursStart');
                    if (startInput) startInput.value = clubSettings.workingHoursStart;
                }
                if (clubSettings.workingHoursEnd) {
                    const endInput = document.getElementById('workingHoursEnd');
                    if (endInput) endInput.value = clubSettings.workingHoursEnd;
                }
                
                // Çalışma günleri - önce tüm checkboxları temizle
                for (let i = 0; i <= 6; i++) {
                    const checkbox = document.getElementById(`workDay-${i}`);
                    if (checkbox) checkbox.checked = false;
                }
                
                // Kayıtlı günleri işaretle
                if (clubSettings.workingDays && Array.isArray(clubSettings.workingDays)) {
                    clubSettings.workingDays.forEach(day => {
                        const checkbox = document.getElementById(`workDay-${day}`);
                        if (checkbox) checkbox.checked = true;
                    });
                } else {
                    // Varsayılan: Pazartesi-Cuma (1-5)
                    for (let i = 1; i <= 5; i++) {
                        const checkbox = document.getElementById(`workDay-${i}`);
                        if (checkbox) checkbox.checked = true;
                    }
                }
                
                // Bulutfon ayarları
                console.log('🔍 Bulutfon ayarları kontrol ediliyor:', {
                    bulutfonEnabled: clubSettings.bulutfonEnabled,
                    bulutfonApiKey: clubSettings.bulutfonApiKey
                });
                
                if (clubSettings.bulutfonEnabled) {
                    const bulutfonCheckbox = document.getElementById('bulutfonEnabled');
                    const bulutfonSettings = document.getElementById('bulutfon-api-settings');
                    if (bulutfonCheckbox) {
                        bulutfonCheckbox.checked = true;
                        console.log('✅ Bulutfon checkbox işaretlendi');
                    }
                    if (bulutfonSettings) {
                        bulutfonSettings.style.display = 'block';
                        console.log('✅ Bulutfon ayarlar paneli gösterildi');
                    }
                }
                
                if (clubSettings.bulutfonApiKey) {
                    const apiKeyInput = document.getElementById('bulutfonApiKey');
                    if (apiKeyInput) {
                        apiKeyInput.value = clubSettings.bulutfonApiKey;
                        console.log('✅ Bulutfon API Key yüklendi');
                    }
                }
            } catch (error) {
                console.warn('loadWhatsAppSettings error (non-critical):', error);
            }
        }
        
        // ✅ Toplu Mesaj özetini ayarlara göre güncelle
        function updateBulkMessageSettings() {
            const waitTimeDisplay = document.getElementById('bulk-wait-time-display');
            const longWaitTrigger = document.getElementById('bulk-long-wait-trigger');
            const longWaitDisplay = document.getElementById('bulk-long-wait-display');
            
            if (waitTimeDisplay) {
                waitTimeDisplay.textContent = `${clubSettings.minWaitTime || 20}-${clubSettings.maxWaitTime || 50} saniye`;
            }
            if (longWaitTrigger) {
                longWaitTrigger.textContent = clubSettings.longWaitTrigger || 100;
            }
            if (longWaitDisplay) {
                longWaitDisplay.textContent = `${clubSettings.minLongWait || 400}-${clubSettings.maxLongWait || 800} saniye`;
            }
        }
        
        // Switch WhatsApp Tabs
        function switchWhatsAppTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('#whatsapp .settings-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('#whatsapp .settings-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(`whatsapp-tab-${tabName}`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Set active class on clicked tab
            event.target.classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'devices') {
                loadWhatsAppDevicesMain();
            } else if (tabName === 'campaigns') {
                loadCampaigns();
            } else if (tabName === 'calls') {
                loadWhatsAppCalls();
            } else if (tabName === 'queue') {
                renderMessageQueue();
            }
        }
        
        window.switchWhatsAppTab = switchWhatsAppTab;
        
        // === WHATSAPP BALANCE PAGE ===
        
        // Load WhatsApp balance in background and update sidebar
        async function loadWhatsAppBalance() {
            if (!window.supabase || !currentClubId) return;
            
            try {
                const { data: clubData, error } = await window.supabase
                    .from('clubs')
                    .select('whatsapp_balance')
                    .eq('id', currentClubId)
                    .single();
                
                if (!error && clubData) {
                    const balance = clubData.whatsapp_balance || 0;
                    const sidebarBalance = document.getElementById('sidebar-whatsapp-balance');
                    if (sidebarBalance) {
                        sidebarBalance.textContent = balance.toLocaleString('tr-TR');
                    }
                }
            } catch (error) {
                console.error('Error loading WhatsApp balance:', error);
            }
        }

        window.renderWhatsAppBalancePage = async function renderWhatsAppBalancePage() {
            console.log('🎯 renderWhatsAppBalancePage called!');
            const container = document.getElementById('whatsapp-balance-content');
            if (!container) {
                console.error('❌ WhatsApp balance container not found!');
                return;
            }
            console.log('✅ Container found:', container);
            
            // Check if Supabase is initialized
            if (!window.supabase) {
                console.error('Supabase not initialized!');
                container.innerHTML = `<div class="card"><p style="color: red;">❌ Supabase bağlantısı kurulamadı. Sayfayı yenileyin.</p></div>`;
                return;
            }
            
            // Check if currentClubId exists
            if (!currentClubId) {
                console.error('currentClubId is not defined!');
                container.innerHTML = `<div class="card"><p style="color: red;">❌ Kulüp ID bulunamadı. Lütfen tekrar giriş yapın.</p></div>`;
                return;
            }
            
            console.log('Loading WhatsApp balance for club:', currentClubId);
            container.innerHTML = '<div class="loading" style="text-align: center; padding: 40px;"><div class="spinner"></div><span>Yükleniyor...</span></div>';
            
            try {
                // Load current balance
                console.log('📊 Fetching balance from Supabase...');
                const { data: clubData, error: clubError } = await window.supabase
                    .from('clubs')
                    .select('whatsapp_balance')
                    .eq('id', currentClubId)
                    .single();
                
                console.log('📊 Balance query result:', { clubData, clubError });
                
                if (clubError) {
                    console.error('❌ Balance query error:', clubError);
                    throw clubError;
                }
                
                const currentBalance = clubData?.whatsapp_balance || 0;
                console.log('💰 Current balance:', currentBalance);
                
                // Load available packages
                console.log('📦 Fetching packages...');
                const { data: packages, error: packagesError } = await window.supabase
                    .from('whatsapp_packages')
                    .select('*')
                    .eq('is_active', true)
                    .order('message_count', { ascending: true });
                
                console.log('📦 Packages result:', { count: packages?.length, packagesError });
                
                if (packagesError) {
                    console.error('❌ Packages error:', packagesError);
                    throw packagesError;
                }
                
                // Load recent transactions
                console.log('📋 Fetching logs...');
                const { data: logs, error: logsError } = await window.supabase
                    .from('whatsapp_balance_logs')
                    .select('*')
                    .eq('club_id', currentClubId)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                console.log('📋 Logs result:', { count: logs?.length, logsError });
                
                if (logsError) {
                    console.error('❌ Logs error:', logsError);
                    throw logsError;
                }
                
                // Update sidebar balance display
                const sidebarBalance = document.getElementById('sidebar-whatsapp-balance');
                if (sidebarBalance) {
                    sidebarBalance.textContent = currentBalance.toLocaleString('tr-TR');
                }
                
                console.log('🎨 Rendering page HTML...');
                // Render page
                container.innerHTML = `
                    <!-- Current Balance Card -->
                    <div class="card" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(37, 211, 102, 0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                            <div>
                                <div style="font-size: 16px; opacity: 0.9; margin-bottom: 10px;">Mevcut Mesaj Bakiyeniz</div>
                                <div style="font-size: 48px; font-weight: 700; margin-bottom: 5px;">${currentBalance.toLocaleString('tr-TR')}</div>
                                <div style="font-size: 14px; opacity: 0.8;">WhatsApp mesajı</div>
                            </div>
                            <div style="text-align: right;">
                                ${currentBalance < 100 ? `
                                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 12px; backdrop-filter: blur(10px);">
                                        <div style="font-size: 24px; margin-bottom: 5px;">&#x26A0;&#xFE0F;</div>
                                        <div style="font-size: 13px; opacity: 0.95;">Bakiyeniz düşük!</div>
                                        <div style="font-size: 13px; opacity: 0.95;">Lütfen paket satın alın</div>
                                    </div>
                                ` : `
                                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 12px; backdrop-filter: blur(10px);">
                                        <div style="font-size: 24px; margin-bottom: 5px;">&#x2705;</div>
                                        <div style="font-size: 13px; opacity: 0.95;">Bakiyeniz yeterli</div>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Available Packages -->
                    <div class="card">
                        <h3 class="card-title">&#x1F4E6; Mesaj Paketleri</h3>
                        <p style="color: #666; margin-bottom: 25px;">WhatsApp mesaj hakkınızı artırmak için aşağıdaki paketlerden birini seçebilirsiniz.</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            ${packages.length === 0 ? `
                                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">
                                    Şu anda aktif paket bulunmuyor
                                </div>
                            ` : packages.map(pkg => {
                                const pricePerMessage = (parseFloat(pkg.price) / pkg.message_count).toFixed(4);
                                const isPopular = pkg.is_popular === true; // Veritabanından gelen değer
                                
                                return `
                                    <div class="card" style="position: relative; border: 2px solid ${isPopular ? '#25D366' : '#e0e0e0'}; padding: 25px; border-radius: 12px; transition: all 0.3s; cursor: pointer; background: ${isPopular ? '#f0fdf4' : 'white'};" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                                        ${isPopular ? `
                                            <div style="position: absolute; top: -12px; right: 20px; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: 600; box-shadow: 0 2px 8px rgba(37, 211, 102, 0.4);">
                                                &#x2B50; Popüler
                                            </div>
                                        ` : ''}
                                        
                                        <div style="text-align: center;">
                                            <h4 style="margin: 0 0 10px 0; font-size: 20px; color: #333;">${pkg.name}</h4>
                                            <div style="font-size: 36px; font-weight: 700; color: ${isPopular ? '#25D366' : '#667eea'}; margin: 15px 0;">
                                                ${pkg.message_count.toLocaleString('tr-TR')}
                                            </div>
                                            <div style="font-size: 14px; color: #666; margin-bottom: 15px;">mesaj</div>
                                            
                                            <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin: 15px 0;">
                                                <div style="font-size: 28px; font-weight: 700; color: #28a745;">
                                                    ₺${parseFloat(pkg.price).toLocaleString('tr-TR', {minimumFractionDigits: 2})}
                                                </div>
                                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                                    (Mesaj başına ₺${pricePerMessage})
                                                </div>
                                            </div>
                                            
                                            ${pkg.description ? `
                                                <p style="font-size: 13px; color: #666; margin: 15px 0; min-height: 40px;">${pkg.description}</p>
                                            ` : ''}
                                            
                                            <button onclick="purchasePackage('${pkg.id}', '${pkg.name}', ${pkg.message_count}, ${pkg.price})" class="btn btn-primary" style="width: 100%; margin-top: 10px; background: ${isPopular ? 'linear-gradient(135deg, #25D366 0%, #128C7E 100%)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}; border: none; padding: 12px; font-weight: 600;">
                                                &#x1F4B3; Satın Al
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 25px; border-left: 4px solid #ffc107;">
                            <strong>&#x2139;&#xFE0F; Not:</strong> Paket satın alma işlemleri için lütfen iletişime geçiniz: 
                            <a href="tel:03623630063" style="color: #007bff; text-decoration: none; font-weight: 600;">&#x1F4DE; 0362 363 00 63</a>
                        </div>
                    </div>
                    
                    <!-- Transaction History -->
                    <div class="card">
                        <h3 class="card-title">&#x1F4CA; İşlem Geçmişi</h3>
                        
                        ${logs && logs.length > 0 ? `
                            <div style="overflow-x: auto;">
                                <table class="table" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                            <th style="padding: 12px; text-align: left;">Tarih</th>
                                            <th style="padding: 12px; text-align: left;">İşlem Tipi</th>
                                            <th style="padding: 12px; text-align: center;">Miktar</th>
                                            <th style="padding: 12px; text-align: center;">Önceki Bakiye</th>
                                            <th style="padding: 12px; text-align: center;">Yeni Bakiye</th>
                                            <th style="padding: 12px; text-align: left;">Not</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${logs.map(log => {
                                            const actionTypes = {
                                                'manual_add': '&#x1F468;&#x200D;&#x1F4BC; Manuel Ekleme',
                                                'purchase': '&#x1F4B3; Paket Satın Alma',
                                                'send': '&#x1F4E4; Mesaj Gönderimi',
                                                'add': '&#x2795; Ekleme',
                                                'refund': '&#x21A9;&#xFE0F; İade'
                                            };
                                            
                                            return `
                                                <tr style="border-bottom: 1px solid #dee2e6;">
                                                    <td style="padding: 12px; font-size: 13px;">
                                                        ${new Date(log.created_at).toLocaleDateString('tr-TR', {
                                                            day: '2-digit',
                                                            month: 'short',
                                                            year: 'numeric',
                                                            hour: '2-digit',
                                                            minute: '2-digit'
                                                        })}
                                                    </td>
                                                    <td style="padding: 12px; font-size: 13px;">
                                                        ${actionTypes[log.action_type] || log.action_type}
                                                    </td>
                                                    <td style="padding: 12px; text-align: center; font-weight: 600; color: ${log.amount > 0 ? '#28a745' : '#dc3545'}; font-size: 14px;">
                                                        ${log.amount > 0 ? '+' : ''}${log.amount.toLocaleString('tr-TR')}
                                                    </td>
                                                    <td style="padding: 12px; text-align: center; font-size: 13px; color: #6c757d;">
                                                        ${log.previous_balance.toLocaleString('tr-TR')}
                                                    </td>
                                                    <td style="padding: 12px; text-align: center; font-weight: 600; font-size: 14px;">
                                                        ${log.new_balance.toLocaleString('tr-TR')}
                                                    </td>
                                                    <td style="padding: 12px; font-size: 13px; color: #6c757d;">
                                                        ${log.note || '-'}
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 40px; color: #999;">
                                Henüz işlem geçmişi bulunmuyor
                            </div>
                        `}
                    </div>
                `;
                
                console.log('✅ Page HTML rendered successfully! Container has content:', container.innerHTML.length, 'chars');
                
                // Force section visibility
                const section = document.getElementById('whatsapp-balance');
                if (section) {
                    section.style.display = 'block';
                    section.style.visibility = 'visible';
                    section.style.opacity = '1';
                    section.classList.add('active');
                    console.log('✅ Section visibility forced - styles:', {
                        display: section.style.display,
                        visibility: section.style.visibility,
                        opacity: section.style.opacity,
                        classList: Array.from(section.classList)
                    });
                    
                    // Log container state
                    console.log('📦 Container state:', {
                        innerHTML: container.innerHTML.substring(0, 100) + '...',
                        display: container.style.display,
                        childElementCount: container.childElementCount
                    });
                } else {
                    console.error('❌ Section #whatsapp-balance not found!');
                }
                
            } catch (error) {
                console.error('❌ Error loading WhatsApp balance page:', error);
                
                // Check if tables don't exist
                const isTableMissing = error.message.includes('relation') || 
                                      error.message.includes('does not exist') ||
                                      error.message.includes('whatsapp_packages') ||
                                      error.message.includes('whatsapp_balance');
                
                if (isTableMissing) {
                    container.innerHTML = `
                        <div class="card">
                            <div style="text-align: center; padding: 40px;">
                                <div style="font-size: 60px; margin-bottom: 20px;">⚠️</div>
                                <h3 style="color: #ff9800; margin-bottom: 15px;">WhatsApp Sistemi Henüz Kurulmamış</h3>
                                <p style="color: #666; margin-bottom: 25px; line-height: 1.6;">
                                    WhatsApp mesaj hakkı sistemini kullanabilmek için önce<br>
                                    Supabase veritabanında gerekli tabloları oluşturmalısınız.
                                </p>
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: left; margin-bottom: 20px;">
                                    <h4 style="margin-bottom: 15px; color: #333;">📋 Kurulum Adımları:</h4>
                                    <ol style="line-height: 2; color: #555;">
                                        <li><strong>Supabase Dashboard</strong>'a gidin</li>
                                        <li><strong>SQL Editor</strong> sekmesini açın</li>
                                        <li><code style="background: #fff; padding: 4px 8px; border-radius: 4px;">whatsapp-credit-system.sql</code> dosyasını açın</li>
                                        <li>Tüm SQL kodunu kopyalayın ve <strong>Run</strong> düğmesine basın</li>
                                        <li>Bu sayfayı yenileyin</li>
                                    </ol>
                                </div>
                                <button class="btn btn-primary" onclick="window.open('https://supabase.edu-ai.online/project/default/sql/new', '_blank')" style="margin-right: 10px;">
                                    🚀 Supabase SQL Editor'ı Aç
                                </button>
                                <button class="btn btn-secondary" onclick="renderWhatsAppBalancePage()">
                                    🔄 Tekrar Dene
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="card">
                            <div style="text-align: center; padding: 40px; color: #dc3545;">
                                <h3>❌ Yüklenirken Hata Oluştu</h3>
                                <p style="margin: 15px 0;"><strong>Hata Detayı:</strong> ${error.message}</p>
                                <button class="btn btn-primary" onclick="renderWhatsAppBalancePage()">🔄 Tekrar Dene</button>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        window.purchasePackage = async function(packageId, packageName, messageCount, price) {
            // Şimdilik sadece iletişim bilgisi göster
            showAlert(`
                <div style="text-align: center;">
                    <h3 style="margin-bottom: 15px;">📦 ${packageName}</h3>
                    <p style="font-size: 16px; margin-bottom: 10px;">
                        <strong>${messageCount.toLocaleString('tr-TR')}</strong> mesaj hakkı
                    </p>
                    <p style="font-size: 20px; color: #28a745; font-weight: 700; margin-bottom: 20px;">
                        ₺${parseFloat(price).toLocaleString('tr-TR', {minimumFractionDigits: 2})}
                    </p>
                    <hr style="margin: 20px 0;">
                    <p style="margin-bottom: 15px;">Satın alma işlemi için lütfen bizimle iletişime geçin:</p>
                    <a href="tel:03623630063" style="display: inline-block; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; padding: 15px 30px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 18px; margin-top: 10px;">
                        📞 0362 363 00 63
                    </a>
                </div>
            `, 'info');
        };
        
        // === WHATSAPP CALLS FUNCTIONS ===
        
        async function loadWhatsAppCalls() {
            const container = document.getElementById('whatsapp-calls-list');
            if (!container) return;
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>WhatsApp aramaları yükleniyor...</span></div>';
            
            console.log('📞 WhatsApp aramaları Firebase\'den yükleniyor...');
            console.log('ℹ️ Not: Evolution API\'de direkt call history endpoint\'i yok, webhook ile Firebase\'e kaydediliyor');
            
            try {
                // Firebase'den çekelim
                const callsRef = window.firebase.collection(window.db, 'whatsappIncomingCalls');
                let callsSnapshot;
                
                // Önce index'li sorguyu dene
                try {
                    console.log('🔍 Index\'li sorgu deneniyor (clubId + timestamp)...');
                    const callsQuery = window.firebase.query(
                        callsRef,
                        window.firebase.where('clubId', '==', currentClubId),
                        window.firebase.orderBy('timestamp', 'desc'),
                        window.firebase.limit(100)
                    );
                    callsSnapshot = await window.firebase.getDocs(callsQuery);
                    console.log('✅ Index\'li sorgu başarılı:', callsSnapshot.docs.length, 'arama bulundu');
                } catch (indexError) {
                    // Index yoksa sadece clubId ile filtrele
                    console.warn('⚠️ Index hatası, basit sorgu deneniyor...', indexError.message);
                    const simpleQuery = window.firebase.query(
                        callsRef,
                        window.firebase.where('clubId', '==', currentClubId)
                    );
                    callsSnapshot = await window.firebase.getDocs(simpleQuery);
                    console.log('✅ Basit sorgu başarılı:', callsSnapshot.docs.length, 'arama bulundu');
                }
                
                // Tüm dökümanları da kontrol et (debug için)
                console.log('🔍 Tüm whatsappIncomingCalls dökümanları kontrol ediliyor...');
                const allCallsSnapshot = await window.firebase.getDocs(callsRef);
                console.log(`📊 Toplam ${allCallsSnapshot.docs.length} WhatsApp arama dökümanı var (tüm clublar dahil)`);
                
                if (allCallsSnapshot.docs.length > 0) {
                    console.log('🔍 İlk döküman örneği:', allCallsSnapshot.docs[0].data());
                    
                    // Bu club'a ait kaç tane var?
                    const thisClubCalls = allCallsSnapshot.docs.filter(doc => doc.data().clubId === currentClubId);
                    console.log(`📊 Bu club'a ait ${thisClubCalls.length} arama var`);
                    
                    if (thisClubCalls.length === 0) {
                        console.warn('⚠️ Firebase\'de WhatsApp araması var ama clubId eşleşmiyor!');
                        console.log('Mevcut clubId:', currentClubId);
                        console.log('İlk dökümanın clubId\'si:', allCallsSnapshot.docs[0].data().clubId);
                    }
                }
                
                if (callsSnapshot.empty) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p style="padding: 40px; color: #999;">📞 Bu club için WhatsApp araması bulunmadı</p>
                            <p style="color: #666; font-size: 14px;">Club ID: ${currentClubId}</p>
                            <p style="color: #666; font-size: 14px;">Toplam sistemdeki aramalar: ${allCallsSnapshot.docs.length}</p>
                            <button class="btn btn-secondary" onclick="loadWhatsAppCalls()">🔄 Tekrar Dene</button>
                        </div>
                    `;
                    return;
                }
                
                const calls = [];
                callsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    calls.push({
                        id: doc.id,
                        ...data
                    });
                });
                
                console.log(`📞 ${calls.length} WhatsApp araması yüklendi`);
                
                // İlk aramayı konsola yazdır (debug için)
                if (calls.length > 0) {
                    console.log('🔍 İlk arama detayı:', calls[0]);
                    console.log('  - from:', calls[0].from);
                    console.log('  - caller:', calls[0].caller);
                    console.log('  - timestamp:', calls[0].timestamp);
                    console.log('  - instanceName:', calls[0].instanceName);
                    console.log('  - is_missing_call:', calls[0].is_missing_call);
                    console.log('  - isVideo:', calls[0].isVideo);
                }
                
                // Aramaları tarihe göre sırala (eğer index sorgusu çalışmadıysa)
                calls.sort((a, b) => {
                    const dateA = new Date(a.timestamp);
                    const dateB = new Date(b.timestamp);
                    return dateB - dateA;
                });
                
                // Aramaları render et
                container.innerHTML = calls.map(call => {
                    const caller = call.from || call.caller || 'Bilinmeyen';
                    const formattedCaller = formatPhoneDisplay(caller);
                    const callTime = new Date(call.timestamp);
                    const timeStr = callTime.toLocaleString('tr-TR', { 
                        day: '2-digit', 
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit', 
                        minute: '2-digit'
                    });
                    
                    // Zaman farkı hesapla
                    const now = new Date();
                    const diffMs = now - callTime;
                    const diffMins = Math.floor(diffMs / 60000);
                    let timeSinceStr = '';
                    if (diffMins < 60) {
                        timeSinceStr = `${diffMins} dakika önce`;
                    } else if (diffMins < 1440) {
                        timeSinceStr = `${Math.floor(diffMins / 60)} saat ${diffMins % 60} dakika önce`;
                    } else {
                        timeSinceStr = `${Math.floor(diffMins / 1440)} gün önce`;
                    }
                    
                    // Durum
                    const isMissed = call.is_missing_call === true || call.is_missing_call === 'true';
                    const statusText = isMissed ? 'Cevapsız' : 'Cevaplandı';
                    const statusColor = isMissed ? '#f44336' : '#4caf50';
                    const statusIcon = isMissed ? '📵' : '✅';
                    
                    // Video/Ses
                    const isVideo = call.isVideo === true;
                    const callTypeIcon = isVideo ? '📹' : '📞';
                    const callTypeText = isVideo ? 'Video Arama' : 'Ses Arama';
                    
                    // CRM'de veya üyelerde var mı kontrol et
                    const leadMatch = crmLeads.find(l => phonesMatch(l.phone, caller));
                    const memberMatch = members.find(m => phonesMatch(m.Telefon, caller) || phonesMatch(m.Telefon_2, caller));
                    
                    let personInfo = '';
                    let actionButtons = '';
                    
                    if (memberMatch) {
                        personInfo = `
                            <div style="font-size: 14px; color: #25D366; font-weight: 600; margin-top: 5px;">
                                👤 ${memberMatch.Resit_Olmayan_Adi_Soyadi || memberMatch.Ad_Soyad}
                                <span style="background: #25D366; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px;">ÜYE</span>
                            </div>
                        `;
                        actionButtons = `
                            <button class="btn btn-sm btn-info" onclick="showMemberAttendancePage('${memberMatch.id}')" title="Üye detaylarını görüntüle">
                                👤 Üye Detayı
                            </button>
                        `;
                    } else if (leadMatch) {
                        personInfo = `
                            <div style="font-size: 14px; color: #ff9800; font-weight: 600; margin-top: 5px;">
                                💼 ${leadMatch.fullName}
                                <span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px;">CRM</span>
                            </div>
                        `;
                        actionButtons = `
                            <button class="btn btn-sm btn-warning" onclick="openCustomerDetail('${leadMatch.id}')" title="CRM detaylarını görüntüle">
                                💼 CRM Detayı
                            </button>
                        `;
                    } else {
                        actionButtons = `
                            <button class="btn btn-sm btn-primary" onclick="quickAddToCRM('${caller}')" title="CRM'e ekle">
                                ➕ CRM'e Ekle
                            </button>
                        `;
                    }
                    
                    return `
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid ${statusColor}; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                        <span style="font-size: 24px;">${callTypeIcon}</span>
                                        <div>
                                            <div style="font-size: 16px; font-weight: 600; color: #333;">
                                                ${formattedCaller}
                                            </div>
                                            <div style="font-size: 12px; color: #666;">
                                                ${callTypeText} • ${call.instanceName || 'WhatsApp'}
                                            </div>
                                        </div>
                                    </div>
                                    ${personInfo}
                                    <div style="font-size: 12px; color: #999; margin-top: 8px;">
                                        📅 ${timeStr} (${timeSinceStr})
                                    </div>
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: end; gap: 8px;">
                                    <div style="font-size: 14px; font-weight: 600; color: ${statusColor};">
                                        ${statusIcon} ${statusText}
                                    </div>
                                    ${actionButtons}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('❌ WhatsApp aramaları yüklenirken hata:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="padding: 40px; color: #f44336;">
                            ❌ Aramalar yüklenirken bir hata oluştu
                        </p>
                        <p style="color: #666; font-size: 14px;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        window.loadWhatsAppCalls = loadWhatsAppCalls;
        
        // Debug fonksiyonu - Firebase'deki tüm WhatsApp aramalarını göster
        async function debugWhatsAppCalls() {
            const debugContainer = document.getElementById('whatsapp-calls-debug');
            if (!debugContainer) return;
            
            debugContainer.style.display = 'block';
            debugContainer.innerHTML = '<p>🔍 Firebase kontrol ediliyor...</p>';
            
            try {
                const callsRef = window.firebase.collection(window.db, 'whatsappIncomingCalls');
                const allCallsSnapshot = await window.firebase.getDocs(callsRef);
                
                let debugInfo = `
                    <h4 style="margin-bottom: 10px;">📊 Firebase Debug Bilgileri</h4>
                    <p><strong>Toplam WhatsApp araması:</strong> ${allCallsSnapshot.docs.length}</p>
                    <p><strong>Mevcut Club ID:</strong> ${currentClubId}</p>
                    <hr style="margin: 10px 0;">
                `;
                
                if (allCallsSnapshot.docs.length === 0) {
                    debugInfo += '<p style="color: red;">❌ Firebase\'de hiç WhatsApp araması yok!</p>';
                    debugInfo += '<p>Webhook\'unuzun doğru çalıştığından emin olun.</p>';
                } else {
                    // Bu club'a ait aramaları filtrele
                    const thisClubCalls = allCallsSnapshot.docs.filter(doc => doc.data().clubId === currentClubId);
                    debugInfo += `<p><strong>Bu club'a ait aramalar:</strong> ${thisClubCalls.length}</p>`;
                    
                    // Tüm farklı clubId'leri göster
                    const allClubIds = [...new Set(allCallsSnapshot.docs.map(doc => doc.data().clubId))];
                    debugInfo += `<p><strong>Sistemdeki Club ID'ler:</strong> ${allClubIds.join(', ')}</p>`;
                    
                    debugInfo += '<hr style="margin: 10px 0;">';
                    debugInfo += '<h5>Son 5 Arama Örneği:</h5>';
                    
                    allCallsSnapshot.docs.slice(0, 5).forEach((doc, index) => {
                        const data = doc.data();
                        debugInfo += `
                            <div style="background: white; padding: 10px; margin: 10px 0; border-radius: 4px; border-left: 4px solid ${data.clubId === currentClubId ? '#4caf50' : '#ff9800'};">
                                <p><strong>Arama ${index + 1}:</strong></p>
                                <p style="margin: 5px 0;"><strong>ID:</strong> ${doc.id}</p>
                                <p style="margin: 5px 0;"><strong>from:</strong> ${data.from || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>caller:</strong> ${data.caller || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>instanceName:</strong> ${data.instanceName || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>timestamp:</strong> ${data.timestamp || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>clubId:</strong> ${data.clubId || 'N/A'} ${data.clubId === currentClubId ? '✅ (Eşleşiyor)' : '❌ (Eşleşmiyor)'}</p>
                                <p style="margin: 5px 0;"><strong>is_missing_call:</strong> ${data.is_missing_call}</p>
                                <p style="margin: 5px 0;"><strong>isVideo:</strong> ${data.isVideo}</p>
                            </div>
                        `;
                    });
                    
                    if (thisClubCalls.length === 0 && allCallsSnapshot.docs.length > 0) {
                        debugInfo += `
                            <div style="background: #fff3cd; padding: 15px; margin: 15px 0; border-radius: 4px; border-left: 4px solid #ffc107;">
                                <p style="color: #856404; margin: 0;"><strong>⚠️ UYARI:</strong></p>
                                <p style="color: #856404; margin: 5px 0;">Firebase'de aramalar var ama clubId eşleşmiyor!</p>
                                <p style="color: #856404; margin: 5px 0;">Webhook'unuzda clubId'nin doğru gönderildiğinden emin olun.</p>
                            </div>
                        `;
                    }
                }
                
                debugContainer.innerHTML = debugInfo;
                
            } catch (error) {
                console.error('Debug hatası:', error);
                debugContainer.innerHTML = `
                    <p style="color: red;">❌ Hata oluştu: ${error.message}</p>
                    <pre style="background: white; padding: 10px; border-radius: 4px; overflow-x: auto;">${error.stack}</pre>
                `;
            }
        }
        
        window.debugWhatsAppCalls = debugWhatsAppCalls;
        
        // Mevcut instance'ların webhook ayarlarını güncelle (çağrı event'lerini aktif et)
        async function updateInstanceWebhookEvents(instanceName) {
            try {
                const device = whatsappDevices.find(d => d.instanceName === instanceName);
                if (!device) {
                    throw new Error('Cihaz bulunamadı');
                }
                
                const evolutionUrl = device.evolutionUrl || EVOLUTION_API_URL;
                const apiKey = device.apiKey || EVOLUTION_API_KEY;
                
                console.log(`🔄 ${instanceName} için webhook event'leri güncelleniyor...`);
                
                const webhookUrl = clubSettings?.evolutionWebhookUrl || device.webhookUrl || '';
                
                // Evolution API'de webhook ayarlarını güncelle
                // Önce /webhook/set endpoint'ini dene
                let response = await fetch(`${evolutionUrl}/webhook/set/${instanceName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': apiKey
                    },
                    body: JSON.stringify({
                        enabled: true,
                        url: webhookUrl,
                        webhookByEvents: false,
                        webhookBase64: false,
                        events: [
                            "MESSAGES_UPSERT",
                            "MESSAGES_UPDATE",
                            "MESSAGES_DELETE",
                            "SEND_MESSAGE",
                            "CALL_UPSERT",
                            "CALL_OFFER",
                            "CALL_REJECT",
                            "CALL_ACCEPT"
                        ]
                    })
                });
                
                // Eğer 400 hatası alırsak, alternatif format dene
                if (response.status === 400) {
                    console.log(`⚠️ İlk format başarısız, alternatif format deneniyor...`);
                    response = await fetch(`${evolutionUrl}/webhook/set/${instanceName}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': apiKey
                        },
                        body: JSON.stringify({
                            webhook: {
                                enabled: true,
                                url: webhookUrl,
                                webhookByEvents: false,
                                webhookBase64: false,
                                events: [
                                    "MESSAGES_UPSERT",
                                    "MESSAGES_UPDATE",
                                    "MESSAGES_DELETE",
                                    "SEND_MESSAGE",
                                    "CALL_UPSERT",
                                    "CALL_OFFER",
                                    "CALL_REJECT",
                                    "CALL_ACCEPT"
                                ]
                            }
                        })
                    });
                }
                
                // Hala başarısız olursa instance settings üzerinden dene
                if (response.status === 400 || response.status === 404) {
                    console.log(`⚠️ Webhook endpoint başarısız, instance settings üzerinden deneniyor...`);
                    response = await fetch(`${evolutionUrl}/instance/update/${instanceName}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': apiKey
                        },
                        body: JSON.stringify({
                            webhook: {
                                enabled: true,
                                url: webhookUrl,
                                webhookByEvents: false,
                                webhookBase64: false,
                                events: [
                                    "MESSAGES_UPSERT",
                                    "MESSAGES_UPDATE",
                                    "MESSAGES_DELETE",
                                    "SEND_MESSAGE",
                                    "CALL_UPSERT",
                                    "CALL_OFFER",
                                    "CALL_REJECT",
                                    "CALL_ACCEPT"
                                ]
                            }
                        })
                    });
                }
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(`✅ ${instanceName} webhook event'leri güncellendi:`, result);
                    showAlert(`✅ ${instanceName} için çağrı event'leri aktif edildi`, 'success');
                    return true;
                } else {
                    let errorMessage = 'Bilinmeyen hata';
                    try {
                        const error = await response.json();
                        console.error(`❌ Webhook güncelleme hatası (${response.status}):`, error);
                        errorMessage = error.message || error.error || JSON.stringify(error);
                    } catch (e) {
                        const errorText = await response.text();
                        console.error(`❌ Webhook güncelleme hatası (${response.status}):`, errorText);
                        errorMessage = errorText || `HTTP ${response.status}`;
                    }
                    showAlert(`❌ Webhook güncellenemedi: ${errorMessage}`, 'danger');
                    return false;
                }
            } catch (error) {
                console.error('Webhook güncelleme hatası:', error);
                showAlert(`❌ Hata: ${error.message}`, 'danger');
                return false;
            }
        }
        
        window.updateInstanceWebhookEvents = updateInstanceWebhookEvents;
        
        // Tüm instance'lar için webhook event'lerini güncelle
        async function updateAllInstancesWebhookEvents() {
            if (!confirm('Tüm WhatsApp Cihazlarınız için çağrı event\'lerini aktif etmek istediğinizden emin misiniz?')) {
                return;
            }
            
            const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
            
            if (connectedDevices.length === 0) {
                showAlert('⚠️ Bağlı cihaz bulunamadı', 'warning');
                return;
            }
            
            showAlert(`🔄 ${connectedDevices.length} cihaz güncelleniyor...`, 'info');
            
            let successCount = 0;
            let failCount = 0;
            
            for (const device of connectedDevices) {
                const success = await updateInstanceWebhookEvents(device.instanceName);
                if (success) {
                    successCount++;
                } else {
                    failCount++;
                }
                // API'ye spam yapmamak için kısa bir bekleme
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            showAlert(`✅ Güncelleme tamamlandı: ${successCount} başarılı, ${failCount} başarısız`, successCount > 0 ? 'success' : 'danger');
        }
        
        window.updateAllInstancesWebhookEvents = updateAllInstancesWebhookEvents;
        
        // === INCOMING MESSAGES FUNCTIONS ===
        
        function renderIncomingMessages() {
            const container = document.getElementById('incoming-messages-container');
            if (!container) return;
            
            if (incomingMessages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>📭 Henüz gelen mesaj yok</h3>
                        <p>Webhook'unuzu yapılandırdığınızda, gelen mesajlar burada görünecektir.</p>
                        <p style="margin-top: 15px;">
                            <a href="#" onclick="switchWhatsAppTab('devices'); return false;" class="btn btn-primary">
                                📱 WhatsApp Cihazlarını Yapılandır
                            </a>
                        </p>
                    </div>
                `;
                return;
            }
            
            filterIncomingMessages();
        }
        
        function filterIncomingMessages() {
            const searchTerm = document.getElementById('incoming-search')?.value.toLowerCase() || '';
            const filterType = document.getElementById('incoming-filter')?.value || 'all';
            
            let filtered = [...incomingMessages];
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(msg => 
                    msg.fromName?.toLowerCase().includes(searchTerm) ||
                    msg.from?.includes(searchTerm) ||
                    msg.message?.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply type filter
            if (filterType === 'members') {
                filtered = filtered.filter(msg => msg.memberInfo && msg.memberInfo.id);
            } else if (filterType === 'non-members') {
                filtered = filtered.filter(msg => !msg.memberInfo || !msg.memberInfo.id);
            } else if (filterType === 'unread') {
                filtered = filtered.filter(msg => !msg.processed);
            }
            
            displayIncomingMessages(filtered);
        }
        
        function displayIncomingMessages(messages) {
            const container = document.getElementById('incoming-messages-container');
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>🔍 Aramanıza uygun mesaj bulunamadı</h3></div>';
                return;
            }
            
            const tableHtml = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Tarih/Saat</th>
                                <th>Gönderen</th>
                                <th>Telefon</th>
                                <th>Mesaj</th>
                                <th>Üye Durumu</th>
                                <th>Durum</th>
                                <th>İşlem</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${messages.map(msg => {
                                const date = new Date(msg.timestamp);
                                const formattedDate = date.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                                const formattedTime = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                                const isMember = msg.memberInfo && msg.memberInfo.id;
                                const memberBadge = isMember 
                                    ? `<span class="status-badge status-active" title="${msg.memberInfo.name}">✅ Üye</span>`
                                    : `<span class="status-badge status-pending">❌ Üye Değil</span>`;
                                const processedBadge = msg.processed 
                                    ? `<span class="status-badge status-completed">✓ İşlendi</span>`
                                    : `<span class="status-badge status-pending">⏳ Bekliyor</span>`;
                                
                                return `
                                    <tr>
                                        <td style="white-space: nowrap;">${formattedDate}<br><small>${formattedTime}</small></td>
                                        <td><strong>${msg.fromName || 'Bilinmiyor'}</strong></td>
                                        <td><a href="#" class="phone-link" onclick="handlePhoneClick(event, '${msg.from}')">${msg.from}</a></td>
                                        <td style="max-width: 300px; white-space: normal; word-wrap: break-word;">
                                            <div style="max-height: 60px; overflow: hidden; text-overflow: ellipsis;">
                                                ${msg.message || '<i>Mesaj içeriği yok</i>'}
                                            </div>
                                        </td>
                                        <td>${memberBadge}</td>
                                        <td>${processedBadge}</td>
                                        <td>
                                            <button class="btn btn-info btn-sm" onclick="viewIncomingMessage('${msg.id}')" title="Detayları Gör">
                                                👁️
                                            </button>
                                            ${!msg.processed ? `
                                            <button class="btn btn-success btn-sm" onclick="markMessageProcessed('${msg.id}')" title="İşlendi olarak işaretle">
                                                ✓
                                            </button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        }
        
        async function refreshIncomingMessages() {
            try {
                const { getDocs, query, collection, orderBy } = window.firebase;
                const snapshot = await getDocs(query(collection(window.db, 'whatsappIncomingMessages'), orderBy('timestamp', 'desc')));
                incomingMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                showAlert('✅ Gelen mesajlar güncellendi!', 'success');
                renderIncomingMessages();
            } catch (error) {
                console.error('Error refreshing incoming messages:', error);
                showAlert('Mesajlar yüklenirken hata oluştu: ' + error.message, 'danger');
            }
        }
        
        function viewIncomingMessage(messageId) {
            const msg = incomingMessages.find(m => m.id === messageId);
            if (!msg) return;
            
            const date = new Date(msg.timestamp);
            const formattedDate = date.toLocaleString('tr-TR');
            const isMember = msg.memberInfo && msg.memberInfo.id;
            
            const modalContent = `
                <div style="padding: 20px;">
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="margin: 0 0 10px 0;">📨 Mesaj Detayı</h4>
                        <p style="margin: 5px 0;"><strong>Gönderen:</strong> ${msg.fromName || 'Bilinmiyor'}</p>
                        <p style="margin: 5px 0;"><strong>Telefon:</strong> ${msg.from}</p>
                        <p style="margin: 5px 0;"><strong>Tarih:</strong> ${formattedDate}</p>
                        <p style="margin: 5px 0;"><strong>Üye Durumu:</strong> ${isMember ? `✅ Üye (${msg.memberInfo.name})` : '❌ Üye Değil'}</p>
                    </div>
                    <div style="padding: 20px; background: white; border: 1px solid #ddd; border-radius: 8px; min-height: 100px;">
                        <strong>Mesaj:</strong><br>
                        <p style="margin-top: 10px; white-space: pre-wrap; font-size: 15px;">${msg.message || '<i>Mesaj içeriği yok</i>'}</p>
                    </div>
                </div>
            `;
            
            showAlert(modalContent, 'info');
        }
        
        async function markMessageProcessed(messageId) {
            try {
                await window.firebase.updateDoc(
                    window.firebase.doc(window.db, 'incomingMessages', messageId),
                    { processed: true, processedAt: new Date().toISOString() }
                );
                
                // Update local data
                const msg = incomingMessages.find(m => m.id === messageId);
                if (msg) {
                    msg.processed = true;
                }
                
                showAlert('✅ Mesaj işlendi olarak işaretlendi', 'success');
                filterIncomingMessages();
            } catch (error) {
                console.error('Error marking message:', error);
                showAlert('İşlem başarısız: ' + error.message, 'danger');
            }
        }
        
        window.refreshIncomingMessages = refreshIncomingMessages;
        window.filterIncomingMessages = filterIncomingMessages;
        window.viewIncomingMessage = viewIncomingMessage;
        window.markMessageProcessed = markMessageProcessed;
        
        // Add event listener for search input
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('incoming-search');
            if (searchInput) {
                searchInput.addEventListener('input', filterIncomingMessages);
            }
        });
        
        function updateActiveDeviceDropdown() {
            const dropdown = document.getElementById('whatsapp-active-device');
            if (!dropdown) return;
            
            // ✅ whatsappDevices henüz yüklenmediyse çık
            if (!whatsappDevices || whatsappDevices.length === 0) {
                dropdown.innerHTML = '<option value="">Bir cihaz seçin...</option>';
                return;
            }
            
            const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
            
            // ✅ Ana cihazı en üste koy, yıldızlı göster (admin2.html gibi)
            const defaultDevice = connectedDevices.find(d => d.instanceName === defaultWhatsAppDevice);
            const otherDevices = connectedDevices.filter(d => d.instanceName !== defaultWhatsAppDevice);
            
            let optionsHtml = '<option value="">Bir cihaz seçin...</option>';
            
            // Ana cihaz varsa en üste yıldızlı olarak ekle
            if (defaultDevice) {
                optionsHtml += `<option value="${defaultDevice.instanceName}">⭐ ${defaultDevice.instanceName} (${defaultDevice.phoneNumber})</option>`;
            }
            
            // Diğer cihazları ekle
            otherDevices.forEach(d => {
                optionsHtml += `<option value="${d.instanceName}">${d.instanceName} (${d.phoneNumber})</option>`;
            });
            
            dropdown.innerHTML = optionsHtml;
            
            // ✅ Önce selectedWhatsAppDevice varsa onu kullan
            if (selectedWhatsAppDevice) {
                const instanceName = selectedWhatsAppDevice.instanceName || selectedWhatsAppDevice;
                dropdown.value = instanceName;
                console.log('✅ Mevcut WhatsApp cihazı dropdown\'da gösteriliyor:', instanceName);
                
                // Mesajlaşma alanını göster
                const messagingArea = document.getElementById('whatsapp-messaging-area');
                if (messagingArea) {
                    messagingArea.style.display = 'block';
                }
            }
            // ✅ Eğer seçili cihaz yoksa ve defaultWhatsAppDevice varsa otomatik seç
            else if (defaultWhatsAppDevice && connectedDevices.length > 0) {
                const defaultDevice = connectedDevices.find(d => d.instanceName === defaultWhatsAppDevice);
                if (defaultDevice) {
                    dropdown.value = defaultWhatsAppDevice;
                    selectedWhatsAppDevice = defaultDevice; // ✅ FIX: Obje atanmalı, string değil!
                    
                    // Mesajlaşma alanını göster
                    const messagingArea = document.getElementById('whatsapp-messaging-area');
                    if (messagingArea) {
                        messagingArea.style.display = 'block';
                    }
                    
                    console.log('✅ Ana WhatsApp cihazı dropdown\'da otomatik seçildi:', defaultWhatsAppDevice);
                    
                    // ✅ Kontakları hemen yükle
                    setTimeout(() => {
                        if (selectedWhatsAppDevice && selectedWhatsAppDevice.instanceName) {
                            loadWhatsAppContacts();
                        }
                    }, 100);
                }
            }
        }
        
        window.onDeviceSelectionChange = function() {
            const dropdown = document.getElementById('whatsapp-active-device');
            const deviceInfo = document.getElementById('whatsapp-device-info');
            const messagingArea = document.getElementById('whatsapp-messaging-area');
            
            const selectedInstance = dropdown.value;
            
            if (!selectedInstance) {
                deviceInfo.textContent = '';
                messagingArea.style.display = 'none';
                selectedWhatsAppDevice = null;
                return;
            }
            
            // Find selected device
            const device = whatsappDevices.find(d => d.instanceName === selectedInstance);
            if (!device) return;
            
            selectedWhatsAppDevice = device;
            
            // Update info
            deviceInfo.innerHTML = `
                <span style="color: green; font-weight: 500;">✓ Bağlı</span> | 
                Telefon: <strong>${device.phoneNumber}</strong> | 
                Oluşturulma: ${device.createdBy}
            `;
            
            // Show messaging area
            messagingArea.style.display = 'block';
            
            // Load contacts for this device
            loadWhatsAppContacts();
        };
        
        window.switchWhatsAppTab = function(tabName) {
            // Hide all tabs
            document.querySelectorAll('#whatsapp .settings-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#whatsapp .settings-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`whatsapp-tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
            
            // Load data for tab
            if (tabName === 'devices') {
                loadWhatsAppDevicesMain();
            } else if (tabName === 'bulk') {
                loadBulkMessageForm();
            } else if (tabName === 'queue') {
                renderMessageQueue();
            } else if (tabName === 'reports') {
                loadMessageReports();
            }
        };

        // Yeni mesaj inline form fonksiyonları
        window.toggleNewMessageForm = function() {
            const activeDevice = document.getElementById('whatsapp-active-device')?.value;
            if (!activeDevice) {
                showAlert('⚠️ Önce bir WhatsApp cihazı seçin!', 'warning');
                return;
            }

            const form = document.getElementById('new-message-inline-form');
            const phoneInput = document.getElementById('new-message-phone-inline');
            const textArea = document.getElementById('new-message-text-area');
            const checkBtn = document.getElementById('check-phone-btn');
            const messageTextarea = document.getElementById('new-message-text-inline');

            if (form.style.display === 'none' || !form.style.display) {
                // Formu aç
                form.style.display = 'block';
                phoneInput.value = '';
                messageTextarea.value = '';
                textArea.style.display = 'none';
                checkBtn.style.display = 'block';
                phoneInput.focus();
            } else {
                // Formu kapat
                form.style.display = 'none';
                phoneInput.value = '';
                messageTextarea.value = '';
                textArea.style.display = 'none';
                checkBtn.style.display = 'block';
            }
        };

        window.checkPhoneAndProceed = async function() {
            let phone = document.getElementById('new-message-phone-inline')?.value.trim();
            const checkBtn = document.getElementById('check-phone-btn');
            const originalBtnText = checkBtn?.innerHTML;
            
            if (!phone) {
                showAlert('⚠️ Lütfen telefon numarası girin!', 'warning');
                return;
            }

            // 0 ile başlıyorsa 90 yap
            if (phone.startsWith('0')) {
                phone = '90' + phone.substring(1);
            }

            // Numara formatını kontrol et (90 ile başlamalı, toplam 12 hane)
            if (!/^90\d{10}$/.test(phone)) {
                showAlert('⚠️ Geçersiz telefon numarası formatı! (05xxxxxxxxx veya 905xxxxxxxxx)', 'warning');
                return;
            }

            // ✅ WhatsApp numara doğrulama - Evolution API'ye sor
            try {
                if (checkBtn) {
                    checkBtn.disabled = true;
                    checkBtn.innerHTML = '⏳ Kontrol ediliyor...';
                }

                const apiUrl = selectedWhatsAppDevice?.evolutionUrl || window.EVOLUTION_API_URL;
                const apiKey = selectedWhatsAppDevice?.apiKey || window.EVOLUTION_API_KEY;
                const instanceName = selectedWhatsAppDevice?.instanceName;

                if (!apiUrl || !instanceName) {
                    throw new Error('WhatsApp cihazı seçilmemiş');
                }

                const checkEndpoint = `${apiUrl}/chat/whatsappNumbers/${instanceName}`;
                console.log('🔍 WhatsApp kontrol ediliyor:', { endpoint: checkEndpoint, phone });

                const checkResponse = await fetch(checkEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': apiKey
                    },
                    body: JSON.stringify({
                        numbers: [phone]
                    })
                });

                if (!checkResponse.ok) {
                    throw new Error('WhatsApp kontrolü yapılamadı');
                }

                const checkResult = await checkResponse.json();
                console.log('📱 WhatsApp kontrol sonucu:', checkResult);

                // Evolution API response formatı: [{ jid: "905551234567@s.whatsapp.net", exists: true }]
                const numberCheck = checkResult?.[0];
                
                if (!numberCheck || !numberCheck.exists) {
                    showAlert('❌ Bu numara WhatsApp kullanmıyor!', 'danger');
                    if (checkBtn) {
                        checkBtn.disabled = false;
                        checkBtn.innerHTML = originalBtnText;
                    }
                    return;
                }

                console.log('✅ Numara WhatsApp kullanıyor, devam ediliyor...');
                
            } catch (error) {
                console.error('WhatsApp kontrol hatası:', error);
                showAlert('⚠️ WhatsApp kontrolü yapılamadı, yine de devam ediliyor...', 'warning');
            } finally {
                if (checkBtn) {
                    checkBtn.disabled = false;
                    checkBtn.innerHTML = originalBtnText;
                }
            }

            try {
                // Bu numarayla konuşma var mı kontrol et (global whatsappContacts kullan)
                const existingContact = whatsappContacts?.find(c => c.phone === phone);
                
                if (existingContact) {
                    // Konuşma varsa, o konuşmayı aç
                    
                    // Soldaki listede seçili yapma
                    document.querySelectorAll('.whatsapp-contact-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // İlgili contact item'ı bul ve seçili yap
                    const contactItems = document.querySelectorAll('.whatsapp-contact-item');
                    contactItems.forEach(item => {
                        const itemPhone = item.getAttribute('data-phone');
                        if (itemPhone === existingContact.phone) {
                            item.classList.add('active');
                            item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    });
                    
                    // Global currentWhatsAppContact'ı güncelle
                    currentWhatsAppContact = {
                        phone: existingContact.phone,
                        name: existingContact.name,
                        type: existingContact.type || 'unknown',
                        memberId: existingContact.memberId,
                        leadId: existingContact.leadId
                    };
                    
                    // Header bilgilerini güncelle
                    const displayPhone = existingContact.phone.replace(/^90/, '0').replace(/(\d{4})(\d{3})(\d{2})(\d{2})/, '$1 $2 $3 $4');
                    
                    // Old header
                    const oldHeaderContact = document.getElementById('whatsapp-selected-contact');
                    const oldHeaderPhone = document.getElementById('whatsapp-selected-phone');
                    if (oldHeaderContact) oldHeaderContact.textContent = existingContact.name;
                    if (oldHeaderPhone) oldHeaderPhone.textContent = displayPhone;
                    
                    // New header
                    const newHeader = document.getElementById('whatsapp-messages-header');
                    const chatContactName = document.getElementById('chat-contact-name');
                    const chatContactPhone = document.getElementById('chat-contact-phone');
                    const chatContactInitial = document.getElementById('chat-contact-initial');
                    const chatContactBadge = document.getElementById('chat-contact-badge');
                    
                    if (newHeader) newHeader.style.display = 'block';
                    if (chatContactName) chatContactName.textContent = existingContact.name;
                    if (chatContactPhone) chatContactPhone.textContent = displayPhone;
                    if (chatContactInitial) {
                        const firstLetter = existingContact.name.trim().charAt(0).toUpperCase();
                        chatContactInitial.textContent = firstLetter;
                    }
                    
                    // Badge
                    if (chatContactBadge) {
                        if (existingContact.type === 'member') {
                            chatContactBadge.textContent = 'ÜYE';
                            chatContactBadge.style.background = '#25D366';
                            chatContactBadge.style.display = 'inline';
                        } else if (existingContact.type === 'crm') {
                            chatContactBadge.textContent = 'CRM';
                            chatContactBadge.style.background = '#667eea';
                            chatContactBadge.style.display = 'inline';
                        } else {
                            chatContactBadge.style.display = 'none';
                        }
                    }
                    
                    // Message input görünür yap
                    const messageInput = document.getElementById('whatsapp-message-input');
                    if (messageInput) messageInput.style.display = 'block';
                    
                    // Mesajları yükle
                    await loadMessagesForContact(existingContact.phone);
                    
                    showAlert('✅ Mevcut konuşma açıldı', 'success');
                    toggleNewMessageForm(); // Formu kapat
                } else {
                    // Yeni konuşma - mesaj textarea'sını göster
                    document.getElementById('new-message-text-area').style.display = 'block';
                    document.getElementById('check-phone-btn').style.display = 'none';
                    document.getElementById('new-message-text-inline').focus();
                    showAlert('📝 Yeni konuşma - Mesajınızı yazın', 'info');
                }
            } catch (error) {
                console.error('Konuşma kontrol hatası:', error);
                showAlert('❌ Hata oluştu: ' + error.message, 'danger');
            }
        };

        window.sendNewMessageInline = async function() {
            let phone = document.getElementById('new-message-phone-inline')?.value.trim();
            const messageText = document.getElementById('new-message-text-inline')?.value.trim();

            if (!messageText) {
                showAlert('⚠️ Lütfen mesaj yazın!', 'warning');
                return;
            }

            // 0 ile başlıyorsa 90 yap
            if (phone.startsWith('0')) {
                phone = '90' + phone.substring(1);
            }

            try {
                // selectedWhatsAppDevice kullan (global değişken)
                if (!selectedWhatsAppDevice) {
                    showAlert('❌ Cihaz seçilmemiş', 'danger');
                    return;
                }

                // evolutionUrl veya EVOLUTION_API_URL kullan
                const apiUrl = selectedWhatsAppDevice.evolutionUrl || window.EVOLUTION_API_URL;
                const apiKey = selectedWhatsAppDevice.apiKey || window.EVOLUTION_API_KEY;
                
                if (!apiUrl) {
                    showAlert('❌ API URL tanımlı değil', 'danger');
                    console.error('selectedWhatsAppDevice:', selectedWhatsAppDevice);
                    return;
                }

                const endpoint = `${apiUrl}/message/sendText/${selectedWhatsAppDevice.instanceName}`;
                
                console.log('📤 Mesaj gönderiliyor:', { 
                    endpoint, 
                    phone, 
                    messageText,
                    instanceName: selectedWhatsAppDevice.instanceName,
                    apiUrl 
                });
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'apikey': apiKey 
                    },
                    body: JSON.stringify({ 
                        number: phone + '@s.whatsapp.net',
                        text: messageText 
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Mesaj gönderilemedi');
                }

                const result = await response.json();
                console.log('✅ Mesaj gönderildi:', result);

                // 💰 Bakiyeyi azalt (mesaj başarıyla gönderildiyse)
                try {
                    const { data: balanceResult, error: balanceError } = await supabaseClient.rpc('update_whatsapp_balance', {
                        p_club_id: currentClubId,
                        p_amount: -1, // 1 mesaj = -1 kredi
                        p_action_type: 'send',
                        p_note: `Mesaj gönderildi: ${phone}`,
                        p_created_by: currentUser?.email || 'system'
                    });
                    
                    if (balanceError) {
                        console.error('⚠️ Bakiye güncellenemedi:', balanceError);
                        showAlert('⚠️ Mesaj gönderildi ama bakiye güncellenemedi. Lütfen yöneticiyle iletişime geçin.', 'warning');
                    } else {
                        console.log('💰 Bakiye güncellendi:', balanceResult);
                        // Bakiye göstergesini güncelle
                        loadWhatsAppBalance();
                    }
                } catch (balanceErr) {
                    console.error('⚠️ Bakiye güncelleme hatası:', balanceErr);
                }

                showAlert('✅ Mesaj gönderildi!', 'success');
                toggleNewMessageForm(); // Formu kapat

                // Konuşmalar listesini yenile
                setTimeout(() => {
                    loadWhatsAppContacts();
                }, 1000);
            } catch (error) {
                console.error('Mesaj gönderme hatası:', error);
                showAlert('❌ Mesaj gönderilemedi: ' + error.message, 'danger');
            }
        };
        
        window.filterMessageReports = function() {
            loadMessageReports();
        };
        
        window.exportMessageReports = function() {
            alert('Excel indirme özelliği yakında eklenecek!');
        };
        
        window.clearMessageReports = async function() {
            if (!confirm('Tüm Mesaj Raporları silinecek. Emin misiniz?')) return;
            
            try {
                console.log('Deleting messages:', sentMessages.length);
                
                // Delete all messages from Firebase
                const { getDocs, collection, deleteDoc, doc } = window.firebase;
                const messagesSnapshot = await getDocs(collection(window.db, 'sentMessages'));
                
                const deletePromises = [];
                messagesSnapshot.forEach(docSnapshot => {
                    deletePromises.push(deleteDoc(docSnapshot.ref));
                });
                
                await Promise.all(deletePromises);
                
                // Clear local array
                sentMessages = [];
                
                // Reload reports
                loadMessageReports();
                showAlert(`${deletePromises.length} mesaj raporu silindi!`, 'success');
            } catch (error) {
                console.error('Error clearing reports:', error);
                showAlert('Raporlar temizlenirken hata oluştu: ' + error.message, 'danger');
            }
        };
        
        function loadMessageReports() {
            const statusFilter = document.getElementById('report-filter-status')?.value || 'all';
            const dateFilter = document.getElementById('report-filter-date')?.value;
            
            let filtered = [...sentMessages];
            
            // Filter by status
            if (statusFilter === 'success') {
                filtered = filtered.filter(m => m.success === true);
            } else if (statusFilter === 'failed') {
                filtered = filtered.filter(m => m.success === false);
            } else if (statusFilter === 'pending') {
                filtered = filtered.filter(m => m.success === undefined || m.success === null);
            }
            
            // Filter by date
            if (dateFilter) {
                filtered = filtered.filter(m => m.sentAt?.startsWith(dateFilter));
            }
            
            // Sort by date (newest first)
            filtered.sort((a, b) => new Date(b.sentAt) - new Date(a.sentAt));
            
            // Update statistics
            const successCount = sentMessages.filter(m => m.success === true).length;
            const failedCount = sentMessages.filter(m => m.success === false).length;
            
            // ✅ BEKLEYEN MESAJLARI messageQueue'dan al (sentMessages'ta değil!)
            let pendingCount = 0;
            
            // messageQueue'daki pending mesajları say
            const loadPendingCount = async () => {
                try {
                    const messagesRef = window.firebase.collection(window.db, 'messageQueue');
                    const pendingQuery = window.firebase.query(
                        messagesRef,
                        window.firebase.where('clubId', '==', currentClubId),
                        window.firebase.where('status', '==', 'pending')
                    );
                    const pendingSnapshot = await window.firebase.getDocs(pendingQuery);
                    pendingCount = pendingSnapshot.size;
                    
                    // ✅ Toplam = Başarılı + Başarısız + Bekleyen
                    const totalCount = successCount + failedCount + pendingCount;
                    
                    // Update UI
                    document.getElementById('report-success-count').textContent = successCount;
                    document.getElementById('report-failed-count').textContent = failedCount;
                    document.getElementById('report-pending-count').textContent = pendingCount;
                    document.getElementById('report-total-count').textContent = totalCount;
                } catch (error) {
                    console.error('Bekleyen mesaj sayısı alınamadı:', error);
                    // Hata durumunda bekleyen 0, toplam = başarılı + başarısız
                    const totalCount = successCount + failedCount;
                    document.getElementById('report-success-count').textContent = successCount;
                    document.getElementById('report-failed-count').textContent = failedCount;
                    document.getElementById('report-pending-count').textContent = 0;
                    document.getElementById('report-total-count').textContent = totalCount;
                }
            };
            
            loadPendingCount();
            
            // Render table
            const tbody = document.getElementById('message-reports-table');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Mesaj raporu bulunamadı</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map((msg, index) => {
                const statusBadge = msg.success === true 
                    ? '<span class="badge bg-success">✅ Gönderildi</span>'
                    : msg.success === false
                    ? '<span class="badge bg-danger">❌ Başarısız</span>'
                    : '<span class="badge bg-warning">⏳ Bekliyor</span>';
                
                const shortMessage = msg.message?.length > 50 
                    ? msg.message.substring(0, 50) + '...' 
                    : msg.message;
                
                return `
                    <tr>
                        <td>${formatDate(msg.sentAt)}</td>
                        <td>${msg.recipient || '-'}</td>
                        <td>${msg.recipientPhone || '-'}</td>
                        <td><span style="cursor: pointer;" onclick="showMessageDetail(${sentMessages.indexOf(msg)})" title="${escapeHtml(msg.message)}">${shortMessage}</span></td>
                        <td><small>${msg.instanceName || '-'}</small></td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="showMessageDetail(${sentMessages.indexOf(msg)})">👁️</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        async function loadWhatsAppContacts() {
            whatsappContacts = [];
            
            console.log('📱 Loading WhatsApp contacts from Evolution API...');
            
            // ✅ Otomatik cihaz seçimi (eğer henüz seçilmemişse)
            if (!selectedWhatsAppDevice && defaultWhatsAppDevice && whatsappDevices.length > 0) {
                const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
                const defaultDevice = connectedDevices.find(d => d.instanceName === defaultWhatsAppDevice);
                
                if (defaultDevice) {
                    selectedWhatsAppDevice = defaultDevice; // ✅ FIX: Obje atanmalı, string değil!
                    console.log('✅ Ana WhatsApp cihazı otomatik seçildi:', defaultWhatsAppDevice);
                    
                    // Dropdown'ı güncelle
                    const deviceSelect = document.getElementById('whatsapp-device-selector');
                    if (deviceSelect) {
                        deviceSelect.value = defaultWhatsAppDevice;
                    }
                    
                    // Mesajlaşma alanını göster
                    const messagingArea = document.getElementById('whatsapp-messaging-area');
                    if (messagingArea) {
                        messagingArea.style.display = 'block';
                    }
                }
            }
            
            if (!selectedWhatsAppDevice) {
                console.warn('⚠️ No device selected');
                renderWhatsAppContactsList();
                return;
            }
            
            try {
                // ✅ selectedWhatsAppDevice artık bir obje (device object)
                const device = selectedWhatsAppDevice;
                
                if (!device || !device.instanceName) {
                    console.error('❌ Device not valid:', selectedWhatsAppDevice);
                    renderWhatsAppContactsList();
                    return;
                }
                
                const evolutionUrl = device.evolutionUrl || EVOLUTION_API_URL;
                const apiKey = device.apiKey || EVOLUTION_API_KEY;
                
                // ✅ Evolution API v2 - Chat'leri çek
                let chats = [];
                
                try {
                    console.log('📥 Evolution API\'den chat\'ler çekiliyor...');
                    console.log(`🔗 URL: ${evolutionUrl}/chat/findChats/${device.instanceName}`);
                    
                    // Önce findChats dene
                    const chatResponse = await fetch(`${evolutionUrl}/chat/findChats/${device.instanceName}`, {
                        method: 'POST',
                        headers: {
                            'apikey': apiKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            where: {}
                        })
                    });
                    
                    if (chatResponse.ok) {
                        chats = await chatResponse.json();
                        console.log(`✅ findChats'dan ${chats.length} sohbet yüklendi`);
                        
                        // Eğer boşsa, fetchInstances dene
                        if (chats.length === 0) {
                            console.log('⚠️ findChats boş döndü, /instance/fetchInstances deneniyor...');
                            
                            const instanceResponse = await fetch(`${evolutionUrl}/instance/fetchInstances`, {
                                method: 'GET',
                                headers: {
                                    'apikey': apiKey
                                }
                            });
                            
                            if (instanceResponse.ok) {
                                const instances = await instanceResponse.json();
                                console.log('📱 Instance response:', instances);
                                
                                // Instance'ı bul
                                const instance = instances.find(i => i.instanceName === device.instanceName || i.instance?.instanceName === device.instanceName);
                                console.log('🔍 Bulunan instance:', instance);
                            }
                        }
                    } else {
                        console.log(`❌ Evolution API hatası (${chatResponse.status}):`, await chatResponse.text());
                        chats = [];
                    }
                } catch (fetchError) {
                    console.error('❌ Evolution API fetch hatası:', fetchError);
                    chats = [];
                }
                
                console.log(`🔍 Debug: chats.length = ${chats.length}`);
                
                if (chats.length > 0) {
                    console.log(`✅ Evolution API'den ${chats.length} sohbet yüklendi`);
                    
                    // Debug: Show first chat object structure
                    if (chats.length > 0) {
                    console.log('🔍 İlk chat objesi yapısı:', chats[0]);
                    console.log('🔍 İlk 5 chat ID örneği:', chats.slice(0, 5).map(c => c.id));
                        if (chats[0].lastMessage) {
                            console.log('🔍 İlk lastMessage yapısı:', chats[0].lastMessage);
                            console.log('  - fromMe:', chats[0].lastMessage.key?.fromMe);
                            console.log('  - messageTimestamp:', chats[0].lastMessage.messageTimestamp);
                        }
                    }
                    
                    let skippedGroups = 0;
                    let skippedInvalid = 0;
                    let processedPhones = 0;
                    
                    // ✅ Map kullanarak duplicate'leri otomatik ele al (en son mesajı tut)
                    const contactMap = new Map();
                    
                    // Process each chat
                    for (const chat of chats) {
                        // Use remoteJid instead of id for phone number
                        const remoteJid = chat.remoteJid || chat.id;
                        
                        // Skip groups and broadcasts only
                        if (!remoteJid || remoteJid.includes('@g.us') || remoteJid.includes('@broadcast')) {
                            skippedGroups++;
                            continue;
                        }
                        
                        // Extract phone number from remoteJid (including @lid)
                        let phone = remoteJid.replace('@s.whatsapp.net', '').replace('@c.us', '').replace('@lid', '');
                        let isLinkedDevice = remoteJid.includes('@lid');
                        
                        // Check if this is a phone number (should only contain digits and optional leading +)
                        // Skip if contains letters (newsletters, special IDs, etc.)
                        const originalPhone = phone;
                        if (/[a-zA-Z]/.test(originalPhone)) {
                            // Contains letters, not a phone number - skip silently
                            skippedInvalid++;
                            continue;
                        }
                        
                        // ✅ BOZUK NUMARALARI TEMİZLE VE DÜZELT
                        phone = cleanPhoneNumber(phone);
                        
                        // Skip if too short (not a valid phone)
                        if (phone.length < 10) {
                            skippedInvalid++;
                            continue; // Skip silently
                        }
                        
                        // Fix phone format for Turkish numbers
                        if (phone.startsWith('0') && phone.length === 11) {
                            // 05449367543 → 905449367543
                            phone = '90' + phone.substring(1);
                        } else if (!phone.startsWith('90') && phone.length === 10) {
                            // 5449367543 → 905449367543
                            phone = '90' + phone;
                        } else if (phone.startsWith('90') && phone.length === 12) {
                            // Already correct: 905449367543
                            // Do nothing
                        } else if (phone.length >= 10 && phone.length <= 15) {
                            // International number - clean it
                            phone = cleanPhoneNumber(phone);
                            
                            // Eğer cleanPhoneNumber boş döndürdüyse, geçersiz numara
                            if (!phone || phone.length < 10) {
                                console.log(`⚠️ Geçersiz numara atlandı`);
                                skippedInvalid++;
                                continue;
                            }
                        } else {
                            // Invalid length
                            skippedInvalid++;
                            continue;
                        }
                        
                        // More flexible validation - accept any phone with 10-15 digits
                        if (phone.length < 10 || phone.length > 15) {
                            skippedInvalid++;
                            continue;
                        }
                        
                        processedPhones++;
                        
                        // Get contact name from Evolution API or use phone number
                        let contactName = chat.name || chat.pushName || phone;
                        let type = 'unknown';
                        let extraData = {};
                        
                        // Linked device için özel işaret
                        if (isLinkedDevice) {
                            contactName = `🔗 ${contactName}`;
                            type = 'linked_device';
                        } else {
                            // Check if contact exists in members/CRM
                            const member = members.find(m => {
                                const memberPhone = formatPhoneForWhatsApp(m.Telefon || m.phone || '');
                                const memberPhone2 = formatPhoneForWhatsApp(m.Telefon_2 || m.phone2 || '');
                                return memberPhone === phone || memberPhone2 === phone;
                            });
                            
                            const crmLead = crmLeads.find(l => {
                                const leadPhone = formatPhoneForWhatsApp(l.phone || '');
                                return leadPhone === phone;
                            });
                            
                            // ✅ Yönetici kontrolü ekle
                            const user = users.find(u => {
                                const userPhone = formatPhoneForWhatsApp(u.phone || u.phoneNumber || '');
                                return userPhone === phone;
                            });
                            
                            if (member) {
                                contactName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad || contactName;
                                type = 'member';
                                extraData.memberId = member.id;
                            } else if (user) {
                                contactName = user.fullName || user.email || contactName;
                                type = 'user';
                                extraData.userId = user.id;
                            } else if (crmLead) {
                                contactName = crmLead.name || contactName;
                                type = 'crm';
                                extraData.leadId = crmLead.id;
                            }
                        }
                        
                        // Get last message info
                        const lastMessage = chat.lastMessage || {};
                        const lastMessageTime = lastMessage.messageTimestamp 
                            ? new Date(lastMessage.messageTimestamp * 1000) 
                            : new Date(0);
                        
                        // Extract message text
                        let lastMessageText = '';
                        if (lastMessage.message) {
                            lastMessageText = lastMessage.message?.conversation || 
                                            lastMessage.message?.extendedTextMessage?.text || 
                                            lastMessage.message?.imageMessage?.caption ||
                                            (lastMessage.message?.imageMessage ? '📷 Fotoğraf' : '') ||
                                            (lastMessage.message?.videoMessage ? '🎥 Video' : '') ||
                                            (lastMessage.message?.audioMessage ? '🎵 Ses' : '') ||
                                            (lastMessage.message?.documentMessage ? '📄 Dosya' : '') ||
                                            (lastMessage.message?.stickerMessage ? '🎨 Sticker' : '') ||
                                            '';
                        }
                        
                        // Check if message is from me
                        const fromMe = lastMessage.key?.fromMe === true || lastMessage.fromMe === true;
                        
                        // ✅ Unread count - SADECE yeni mesajları say (son görüntülenenden sonra)
                        let actualUnreadCount = 0;
                        
                        // Evolution API'den gelen unread count'u al
                        const evolutionUnreadCount = chat.unreadCount || 0;
                        
                        // Eğer mesaj bizden DEĞİLSE ve daha önce okunmadıysa sayaç artır
                        if (!fromMe && evolutionUnreadCount > 0) {
                            // localStorage'dan son görüntüleme zamanını al (timestamp milisaniye)
                            const lastReadTime = getLastReadTime(phone);
                            
                            // lastMessageTime bir Date objesi, getTime() ile timestamp'e çevir
                            const lastMessageTimestamp = lastMessageTime.getTime();
                            
                            // Eğer son mesaj, son görüntüleme zamanından sonra geldiyse okunmamış
                            if (lastMessageTimestamp > lastReadTime) {
                                actualUnreadCount = evolutionUnreadCount;
                                console.log(`📬 ${phone}: ${evolutionUnreadCount} okunmamış (son mesaj: ${new Date(lastMessageTimestamp).toLocaleString()}, son okunma: ${new Date(lastReadTime).toLocaleString()})`);
                            } else {
                                // Daha önce okunmuş
                                actualUnreadCount = 0;
                                console.log(`✅ ${phone}: Okunmuş sayıldı (son mesaj: ${new Date(lastMessageTimestamp).toLocaleString()}, son okunma: ${new Date(lastReadTime).toLocaleString()})`);
                            }
                        }
                        
                        // ✅ Map'e ekle veya güncelle (aynı numaradan en son mesajı tut)
                        const existingContact = contactMap.get(phone);
                        if (existingContact) {
                            // Eğer bu chat'in son mesajı daha yeni ise güncelle
                            if (lastMessageTime > existingContact.lastMessageTime) {
                                console.log(`🔄 ${phone} güncellendi (daha yeni mesaj: ${contactName})`);
                                contactMap.set(phone, {
                                    name: contactName,
                                    phone: phone,
                                    type: type,
                                    lastMessage: lastMessageText,
                                    lastMessageFromMe: fromMe,
                                    lastMessageTime: lastMessageTime,
                                    unreadCount: actualUnreadCount,
                                    instanceName: device.instanceName || device.name,
                                    ...extraData
                                });
                            } else {
                                console.log(`⏭️ ${phone} atlandı (daha eski mesaj: ${contactName})`);
                            }
                        } else {
                            // İlk kez ekleniyor
                            contactMap.set(phone, {
                                name: contactName,
                                phone: phone,
                                type: type,
                                lastMessage: lastMessageText,
                                lastMessageFromMe: fromMe,
                                lastMessageTime: lastMessageTime,
                                unreadCount: actualUnreadCount,
                                instanceName: device.instanceName || device.name,
                                ...extraData
                            });
                        }
                    }
                    
                    // ✅ Map'i array'e çevir
                    whatsappContacts = Array.from(contactMap.values());
                    
                    // Sort by last message time (newest first)
                    whatsappContacts.sort((a, b) => b.lastMessageTime - a.lastMessageTime);
                    
                    console.log(`📊 İşlem Özeti: ${chats.length} sohbet yüklendi → ${skippedGroups} grup atlandı, ${skippedInvalid} geçersiz atlandı, ${processedPhones} telefon işlendi`);
                    console.log(`📊 Toplam ${whatsappContacts.length} konuşma (${whatsappContacts.filter(c => c.type === 'member').length} üye, ${whatsappContacts.filter(c => c.type === 'crm').length} CRM, ${whatsappContacts.filter(c => c.type === 'unknown').length} diğer)`);
                } else {
                    console.log('ℹ️ Hiç sohbet bulunamadı - Supabase mesaj geçmişinden yükleniyor...');
                    
                    // ✅ Evolution API'den chat alamadıysak, Supabase whatsappMessages'dan mesajları göster
                    try {
                        const { data: whatsappMessagesData, error: messagesError } = await supabaseClient
                            .from('whatsapp_incoming_messages')
                            .select('*')
                            .eq('club_id', currentClubId)
                            .eq('instance_name', device.instanceName)
                            .order('message_timestamp', { ascending: false })
                            .limit(200);
                        
                        if (!messagesError && whatsappMessagesData && whatsappMessagesData.length > 0) {
                            console.log(`📨 Supabase'den ${whatsappMessagesData.length} WhatsApp mesajı bulundu`);
                            console.log('🔍 İlk mesaj örneği:', whatsappMessagesData[0]);
                            
                            // Her telefon numarası için en son mesajı al
                            const contactMap = new Map();
                            
                            for (const msg of whatsappMessagesData) {
                                // remote_jid'den telefon numarasını al
                                const remoteJid = msg.remote_jid || '';
                                
                                // Grup mesajlarını atla (broadcast dahil)
                                if (remoteJid.includes('@g.us') || remoteJid.includes('@broadcast')) {
                                    continue;
                                }
                                
                                // Phone number extraction (including @lid)
                                let phone = remoteJid.replace('@s.whatsapp.net', '').replace('@c.us', '').replace('@lid', '');
                                let isLinkedDevice = remoteJid.includes('@lid');
                                
                                if (!phone) continue;
                                
                                // İlk mesaj veya daha yeni mesajsa
                                if (!contactMap.has(phone)) {
                                    let contactName = msg.push_name || phone;
                                    let type = 'unknown';
                                    let extraData = {};
                                    
                                    // Linked device için özel işaret
                                    if (isLinkedDevice) {
                                        contactName = `🔗 ${contactName}`;
                                        type = 'linked_device';
                                    } else {
                                        const member = members.find(m => {
                                            const memberPhone = formatPhoneForWhatsApp(m.Telefon || m.phone || '');
                                            const memberPhone2 = formatPhoneForWhatsApp(m.Telefon_2 || m.phone2 || '');
                                            return memberPhone === phone || memberPhone2 === phone;
                                        });
                                        
                                        const crmLead = crmLeads.find(l => {
                                            const leadPhone = formatPhoneForWhatsApp(l.phone || '');
                                            return leadPhone === phone;
                                        });
                                        
                                        if (member) {
                                            contactName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad || contactName;
                                            type = 'member';
                                            extraData.memberId = member.id;
                                        } else if (crmLead) {
                                            contactName = crmLead.name || contactName;
                                            type = 'crm';
                                            extraData.leadId = crmLead.id;
                                        }
                                    }
                                    
                                    // message_content JSONB'den mesaj metnini çıkar
                                    let messageText = '';
                                    if (msg.message_content) {
                                        messageText = msg.message_content.conversation || 
                                                    msg.message_content.extendedTextMessage?.text || 
                                                    '';
                                    }
                                    
                                    contactMap.set(phone, {
                                        name: contactName,
                                        phone: phone,
                                        type: type,
                                        lastMessage: messageText,
                                        lastMessageFromMe: msg.message_key?.fromMe || false,
                                        lastMessageTime: new Date(msg.message_timestamp || msg.created_at),
                                        unreadCount: 0,
                                        instanceName: device.instanceName,
                                        ...extraData
                                    });
                                }
                            }
                            
                            whatsappContacts = Array.from(contactMap.values());
                            whatsappContacts.sort((a, b) => b.lastMessageTime - a.lastMessageTime);
                            console.log(`✅ ${whatsappContacts.length} konuşma Supabase whatsappMessages'dan yüklendi`);
                        } else if (!messagesError) {
                            console.log('ℹ️ whatsapp_incoming_messages tablosu boş, sentMessages deneniyor...');
                            // whatsappMessages boşsa, sentMessages'a bak
                            const { data: sentMessages, error: sentError } = await supabaseClient
                                .from('sentMessages')
                                .select('*')
                                .eq('clubId', currentClubId)
                                .eq('instanceName', device.instanceName)
                                .eq('status', 'sent')
                                .order('sentAt', { ascending: false })
                                .limit(100);
                            
                            if (!sentError && sentMessages && sentMessages.length > 0) {
                                console.log(`📨 Supabase'den ${sentMessages.length} gönderilen mesaj bulundu`);
                            
                                // Her telefon numarası için en son mesajı al
                                const uniquePhones = new Set();
                                
                                for (const msg of sentMessages) {
                                    if (uniquePhones.has(msg.phoneNumber)) continue;
                                    uniquePhones.add(msg.phoneNumber);
                                    
                                    const phone = formatPhoneForWhatsApp(msg.phoneNumber);
                                    
                                    // Üye/CRM kontrolü
                                    const member = members.find(m => {
                                        const memberPhone = formatPhoneForWhatsApp(m.Telefon || m.phone || '');
                                        const memberPhone2 = formatPhoneForWhatsApp(m.Telefon_2 || m.phone2 || '');
                                        return memberPhone === phone || memberPhone2 === phone;
                                    });
                                    
                                    const crmLead = crmLeads.find(l => {
                                        const leadPhone = formatPhoneForWhatsApp(l.phone || '');
                                        return leadPhone === phone;
                                    });
                                    
                                    let contactName = msg.recipientName || phone;
                                    let type = 'unknown';
                                    let extraData = {};
                                    
                                    if (member) {
                                        contactName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad || contactName;
                                        type = 'member';
                                        extraData.memberId = member.id;
                                    } else if (crmLead) {
                                        contactName = crmLead.name || contactName;
                                        type = 'crm';
                                        extraData.leadId = crmLead.id;
                                    }
                                    
                                    whatsappContacts.push({
                                        name: contactName,
                                        phone: phone,
                                        type: type,
                                        lastMessage: msg.message || '',
                                        lastMessageFromMe: true,
                                        lastMessageTime: new Date(msg.sentAt),
                                        unreadCount: 0,
                                        instanceName: device.instanceName,
                                        ...extraData
                                    });
                                }
                                
                                whatsappContacts.sort((a, b) => b.lastMessageTime - a.lastMessageTime);
                                console.log(`✅ ${whatsappContacts.length} konuşma Supabase sentMessages'dan yüklendi`);
                            } else {
                                console.log('💡 İpucu: Henüz hiç mesaj gönderilmemiş. WhatsApp üzerinden mesaj gönderin veya sistemden mesaj gönderin.');
                            }
                        } else {
                            console.log('💡 İpucu: Henüz hiç mesaj gönderilmemiş. WhatsApp üzerinden mesaj gönderin veya sistemden mesaj gönderin.');
                        }
                    } catch (supabaseError) {
                        console.warn('⚠️ Supabase mesaj geçmişi yüklenemedi:', supabaseError.message);
                    }
                }
            } catch (error) {
                console.warn('⚠️ WhatsApp mesajları yüklenirken hata:', error.message);
                console.log('ℹ️ Boş konuşma listesi ile devam ediliyor');
                // Network hatası - sessizce devam et
            }
            
            // ✅ İlk yüklemede okunmamış mesaj varsa bildirim göster
            const currentUnreadCount = whatsappContacts.reduce((sum, c) => sum + (c.unreadCount || 0), 0);
            
            console.log(`📊 loadWhatsAppContacts tamamlandı: ${currentUnreadCount} okunmamış mesaj (lastWhatsAppUnreadCount: ${lastWhatsAppUnreadCount})`);
            
            if (lastWhatsAppUnreadCount === -1) {
                // İlk yükleme - sadece sayacı set et, bildirim gösterme
                lastWhatsAppUnreadCount = currentUnreadCount;
                console.log(`� İlk yükleme: ${currentUnreadCount} okunmamış WhatsApp mesajı (bildirim gösterilmeyecek)`);
            }
            
            renderWhatsAppContactsList();
            
            // ✅ Yeni mesaj kontrolü yap (sadece polling için, ilk yükleme hariç)
            checkForNewWhatsAppMessages();
        }
        
        // ✅ Yeni mesaj kontrolü (polling için)
        function checkForNewWhatsAppMessages() {
            const currentUnreadCount = whatsappContacts.reduce((sum, c) => sum + (c.unreadCount || 0), 0);
            
            console.log(`🔍 Mesaj kontrolü: Önceki=${lastWhatsAppUnreadCount}, Şimdi=${currentUnreadCount}`);
            
            // ✅ SADECE yeni mesajlar için bildirim göster
            if (lastWhatsAppUnreadCount !== -1 && currentUnreadCount > lastWhatsAppUnreadCount) {
                const newMessages = currentUnreadCount - lastWhatsAppUnreadCount;
                console.log(`📬 ${newMessages} YENİ mesaj tespit edildi! (${lastWhatsAppUnreadCount} → ${currentUnreadCount})`);
                
                // Debug: Hangi contact'larda okunmamış var göster
                whatsappContacts.filter(c => c.unreadCount > 0).forEach(c => {
                    console.log(`  - ${c.name} (${c.phone}): ${c.unreadCount} okunmamış`);
                });
                
                // ✅ SADECE YENİ MESAJI OLAN contact'ı bul
                // (son mesaj zamanı en yeni olan - bu muhtemelen yeni mesajdır)
                const latestContact = whatsappContacts
                    .filter(c => c.unreadCount > 0)
                    .sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0))[0];
                
                if (latestContact) {
                    const sender = latestContact.name || formatPhoneDisplay(latestContact.phone);
                    const messagePreview = latestContact.lastMessage || '';
                    
                    // ✅ checkForNewWhatsAppMessages'dan bildirim gönder
                    console.log(`📨 Bildirim gönderiliyor: ${sender} - ${messagePreview}`);
                    showWhatsAppMessageNotification(0, sender, messagePreview, latestContact.instanceName, latestContact.phone);
                }
            }
            
            // ✅ Sayacı güncelle
            lastWhatsAppUnreadCount = currentUnreadCount;
            console.log(`✅ lastWhatsAppUnreadCount güncellendi: ${lastWhatsAppUnreadCount}`);
        }
        
        function renderWhatsAppContactsList(searchTerm = '') {
            const container = document.getElementById('whatsapp-contacts-list');
            
            let filtered = whatsappContacts;
            
            // Arama terimi varsa uygula
            if (searchTerm) {
                const searchNoSpaces = searchTerm.replace(/\s/g, '');
                filtered = filtered.filter(c => 
                    c.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    c.phone.includes(searchTerm) ||
                    c.phone.replace(/\s/g, '').includes(searchNoSpaces)
                );
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p class="empty-state" style="padding: 20px; text-align: center; color: #666;">🔍 Kişi bulunamadı</p>';
                return;
            }
            
            container.innerHTML = filtered.map(contact => {
                const safeName = (contact.name || 'İsimsiz').replace(/'/g, "\\'");
                let displayName = contact.name || 'İsimsiz';
                const displayPhone = formatPhoneDisplay(contact.phone);
                
                // ✅ Üye, CRM müşterileri ve Yöneticiler için Ad - Soyad formatında göster
                if (contact.type === 'member' && contact.memberId) {
                    const member = members.find(m => m.id === contact.memberId);
                    if (member) {
                        const firstName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad || '';
                        const nameParts = firstName.trim().split(/\s+/);
                        if (nameParts.length >= 2) {
                            displayName = `${nameParts[0]} - ${nameParts.slice(1).join(' ')}`;
                        } else {
                            displayName = firstName;
                        }
                    }
                } else if (contact.type === 'user' && contact.userId) {
                    // ✅ Yöneticiler de Ad - Soyad formatında
                    const user = users.find(u => u.id === contact.userId);
                    if (user && user.fullName) {
                        const nameParts = user.fullName.trim().split(/\s+/);
                        if (nameParts.length >= 2) {
                            displayName = `${nameParts[0]} - ${nameParts.slice(1).join(' ')}`;
                        } else {
                            displayName = user.fullName;
                        }
                    }
                } else if (contact.type === 'crm' && contact.leadId) {
                    // ✅ CRM müşterileri de Ad - Soyad formatında
                    const lead = crmLeads.find(l => l.id === contact.leadId);
                    if (lead && lead.fullName) {
                        const nameParts = lead.fullName.trim().split(/\s+/);
                        if (nameParts.length >= 2) {
                            displayName = `${nameParts[0]} - ${nameParts.slice(1).join(' ')}`;
                        } else {
                            displayName = lead.fullName;
                        }
                    }
                }
                
                const firstLetter = displayName.charAt(0).toUpperCase();
                
                // Contact type styling
                let avatarColor = '#25D366'; // Default green
                let statusBadge = '';
                let actionButton = '';
                let crmTagBadge = ''; // ✅ CRM etiketi
                
                if (contact.type === 'member') {
                    avatarColor = '#128C7E';
                    statusBadge = '<span style="font-size: 10px; background: #25D366; color: white; padding: 2px 6px; border-radius: 10px; margin-left: 5px;">Üye</span>';
                    actionButton = `<button onclick="event.stopPropagation(); window.location.hash='members'; setTimeout(() => showMemberAttendancePage('${contact.memberId}'), 100);" style="padding: 4px 8px; font-size: 11px; background: #128C7E; color: white; border: none; border-radius: 4px; cursor: pointer;">Görüntüle</button>`;
                } else if (contact.type === 'crm') {
                    avatarColor = '#FF6B6B';
                    statusBadge = '<span style="font-size: 10px; background: #FF6B6B; color: white; padding: 2px 6px; border-radius: 10px; margin-left: 5px;">CRM</span>';
                    actionButton = `<button onclick="event.stopPropagation(); showCRMLeadDetail('${contact.leadId}');" style="padding: 4px 8px; font-size: 11px; background: #FF6B6B; color: white; border: none; border-radius: 4px; cursor: pointer;">Görüntüle</button>`;
                    
                    // ✅ CRM etiketlerini göster
                    if (contact.tags && contact.tags.length > 0) {
                        crmTagBadge = `<div style="display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px;">${contact.tags.slice(0, 2).map(tag => 
                            `<span style="font-size: 9px; background: #E3F2FD; color: #1976D2; padding: 2px 6px; border-radius: 8px;">${tag}</span>`
                        ).join('')}${contact.tags.length > 2 ? `<span style="font-size: 9px; color: #999;">+${contact.tags.length - 2}</span>` : ''}</div>`;
                    }
                } else if (contact.type === 'user') {
                    avatarColor = '#667eea';
                    statusBadge = '<span style="font-size: 10px; background: #667eea; color: white; padding: 2px 6px; border-radius: 10px; margin-left: 5px;">Yönetici</span>';
                    actionButton = ''; // Yönetici için buton yok
                } else {
                    // ✅ Unknown (CRM'de kayıtlı değil)
                    avatarColor = '#9E9E9E';
                    statusBadge = ''; // Badge yok, buton yeterli
                    actionButton = `<button onclick="event.stopPropagation(); openCRMLeadModalWithPhone('${contact.phone}', '${safeName}');" style="padding: 4px 8px; font-size: 11px; background: #FFA726; color: white; border: none; border-radius: 4px; cursor: pointer;">CRM'e Ekle</button>`;
                }
                
                // Last message preview
                const lastMsg = contact.lastMessage || 'Henüz mesaj yok';
                const lastMsgPreview = `<div style="font-size: 13px; color: ${contact.unreadCount > 0 ? '#111' : '#667781'}; font-weight: ${contact.unreadCount > 0 ? '500' : 'normal'}; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;">${lastMsg.substring(0, 35)}${lastMsg.length > 35 ? '...' : ''}</div>`;
                
                // Time display
                const timeDisplay = contact.lastMessageTime && contact.lastMessageTime.getTime() > 0
                    ? formatTimeAgo(contact.lastMessageTime)
                    : '';
                
                // Unread badge - YEŞIL NOKTA
                const unreadBadge = contact.unreadCount > 0 
                    ? `<div style="width: 10px; height: 10px; background: #25D366; border-radius: 50%; box-shadow: 0 0 0 2px white;"></div>`
                    : '';
                
                return `
                    <div class="whatsapp-contact-item ${currentWhatsAppContact?.phone === contact.phone ? 'active' : ''}" 
                         data-phone="${contact.phone}" 
                         data-unread="${contact.unreadCount || 0}"
                         onclick="selectWhatsAppContact('${contact.phone}', '${safeName}', ${JSON.stringify(contact).replace(/"/g, '&quot;')})"
                         style="padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; position: relative;"
                         onmouseover="this.style.background='#f5f5f5';" 
                         onmouseout="this.style.background=this.classList.contains('active')?'#E8F5E9':'white';">
                        
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 50px; height: 50px; border-radius: 50%; background: ${avatarColor}; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; font-weight: bold; flex-shrink: 0;">
                                ${firstLetter}
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: ${contact.unreadCount > 0 ? '600' : '500'}; color: #111; font-size: 15px;">${displayName} ${statusBadge}</div>
                                        <div style="font-size: 11px; color: #999; margin-top: 1px;">${displayPhone}</div>
                                        ${crmTagBadge}
                                    </div>
                                    <div style="font-size: 11px; color: ${contact.unreadCount > 0 ? '#25D366' : '#667781'}; font-weight: ${contact.unreadCount > 0 ? '600' : 'normal'};">${timeDisplay}</div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                                    <div style="flex: 1; min-width: 0;">${lastMsgPreview}</div>
                                    ${unreadBadge}
                                </div>
                                <div style="margin-top: 6px;">${actionButton}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ✅ CRM Lead detayını göster (WhatsApp'tan)
        window.showCRMLeadDetail = async function(leadId) {
            console.log('📋 CRM Lead detayı açılıyor:', leadId);
            
            // CRM sayfasına git
            window.location.hash = 'crm';
            
            // Lead detayını aç
            setTimeout(() => {
                openCrmLeadDetail(leadId); // ✅ Küçük 'C' ile
            }, 300);
        };
        
        // ✅ Telefon ve isimle CRM modal aç (WhatsApp'tan)
        window.openCRMLeadModalWithPhone = async function(phone, name) {
            console.log('📋 CRM modal açılıyor:', phone, name);
            
            // CRM sayfasına git
            window.location.hash = 'crm';
            
            // Kısa gecikme sonra modal aç
            setTimeout(() => {
                openAddLeadModal(); // ✅ Doğru fonksiyon ismi
                
                // Form alanlarını doldur
                setTimeout(() => {
                    const phoneInput = document.querySelector('#addLeadModal input[name="phone"]');
                    const nameInput = document.querySelector('#addLeadModal input[name="fullName"]');
                    
                    if (phoneInput) {
                        // Telefonu temizle ve formatla
                        let cleanPhone = phone.replace(/\D/g, '');
                        
                        // 90 ile başlıyorsa (905...) başındaki 9'u sil
                        if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                            cleanPhone = cleanPhone.substring(1); // 905... → 05...
                        }
                        // 9 ile başlıyorsa ve 11 haneliyse (905...) başındaki 9'u sil
                        else if (cleanPhone.startsWith('9') && cleanPhone.length === 11) {
                            cleanPhone = '0' + cleanPhone.substring(1); // 905... → 05...
                        }
                        
                        phoneInput.value = cleanPhone;
                        console.log('✅ Telefon dolduruldu:', cleanPhone);
                    } else {
                        console.warn('⚠️ Telefon input bulunamadı');
                    }
                    
                    if (nameInput && name && name !== phone) {
                        nameInput.value = name;
                        console.log('✅ İsim dolduruldu:', nameInput.value);
                    }
                    
                    console.log('✅ CRM formu açıldı ve bilgiler dolduruldu');
                }, 300); // 200ms → 300ms (modal açılması için daha fazla süre)
            }, 400); // 300ms → 400ms (sayfa geçişi için daha fazla süre)
        };
        
        // ✅ Bilinmeyen kontağı CRM'e ekle (ESKİ FONKSİYON - KALDIRILDI)
        window.addUnknownContactToCRM = async function(phone, name) {
            // Yeni fonksiyonu kullan
            openCRMLeadModalWithPhone(phone, name);
        };
        
        // ✅ Evolution API'ye "okundu" bildirimi gönder
        async function sendReadReceiptToEvolution(phone) {
            if (!selectedWhatsAppDevice) {
                console.warn('⚠️ Cihaz seçilmemiş, okundu bildirimi gönderilemedi');
                return;
            }
            
            try {
                const normalizedPhone = phone.replace(/\D/g, '');
                const remoteJid = `${normalizedPhone}@s.whatsapp.net`;
                
                // ✅ Evolution API v2 - UPDATE metodunu kullan (mark as read değil, update chat)
                const url = `${selectedWhatsAppDevice.evolutionUrl}/chat/updateMessage/${selectedWhatsAppDevice.instanceName}`;
                
                console.log('📨 Evolution API\'ye okundu bildirimi gönderiliyor:', {
                    phone: normalizedPhone,
                    remoteJid,
                    instance: selectedWhatsAppDevice.instanceName,
                    url
                });
                
                // Evolution API v2: readMessages endpoint kullan
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'apikey': selectedWhatsAppDevice.apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        remoteJid: remoteJid,
                        readMessages: true
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Evolution API okundu bildirimi başarılı:', result);
                    return true;
                } else {
                    const errorText = await response.text();
                    console.warn('⚠️ Evolution API okundu hatası:', response.status, errorText);
                    
                    // Hata olsa bile localStorage ile devam et
                    return false;
                }
            } catch (err) {
                console.error('❌ Evolution API okundu bildirimi hatası:', err);
                return false;
            }
        }
        
        // ✅ WhatsApp konuşmasını sil
        window.deleteWhatsAppConversation = async function(phone, name) {
            if (!confirm(`${name} (${formatPhoneDisplay(phone)}) ile olan konuşmayı silmek istediğinizden emin misiniz?\n\nBu işlem geri alınamaz!`)) {
                return;
            }
            
            try {
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log('🗑️ KONUŞMA SİLME İŞLEMİ BAŞLADI');
                console.log(`   Telefon: ${phone}`);
                console.log(`   İsim: ${name}`);
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log('   ℹ️ WhatsApp API sohbet silmeyi desteklemiyor');
                console.log('   💡 Mesajlar lokal cache ve Firebase\'den temizlenecek');
                
                // 1. Evolution API'den sil
                if (selectedWhatsAppDevice) {
                    try {
                        // Format phone for Evolution API
                        let formattedPhone = phone.replace(/\D/g, '');
                        if (formattedPhone.startsWith('0') && formattedPhone.length === 11) {
                            formattedPhone = '90' + formattedPhone.substring(1);
                        } else if (!formattedPhone.startsWith('90') && formattedPhone.length === 10) {
                            formattedPhone = '90' + formattedPhone;
                        }
                        
                        const remoteJid = `${formattedPhone}@s.whatsapp.net`;
                        const device = selectedWhatsAppDevice;
                        const evolutionUrl = device.evolutionUrl || EVOLUTION_API_URL;
                        const apiKey = device.apiKey || EVOLUTION_API_KEY;
                        
                        console.log(`   🔗 Evolution API: ${evolutionUrl}`);
                        console.log(`   � Instance: ${device.instanceName}`);
                        console.log(`   📞 Remote JID: ${remoteJid}`);
                        
                        // WhatsApp Web API chat silmeyi desteklemiyor
                        // Mesajlar sadece lokal bellekten temizlenecek
                        console.log('   ℹ️ WhatsApp API mesaj silmeyi desteklemiyor');
                        console.log('   💡 Konuşma lokal cache\'den temizleniyor');
                    } catch (evoError) {
                        console.error('   ❌ Evolution API silme hatası:', evoError.message);
                    }
                } else {
                    console.log('   ℹ️ WhatsApp API sohbet silmeyi desteklemiyor');
                }
                
                // 1. Firebase sentMessages'den sil
                try {
                    const formattedPhone = phone.replace(/\D/g, '');
                    const phoneVariations = [
                        formattedPhone,
                        formattedPhone.startsWith('90') ? formattedPhone : '90' + formattedPhone,
                        formattedPhone.startsWith('90') ? formattedPhone.substring(2) : formattedPhone,
                        formattedPhone.startsWith('0') ? formattedPhone.substring(1) : '0' + formattedPhone
                    ];
                    
                    console.log('   🗑️ Firebase sentMessages temizleniyor:', phoneVariations);
                    
                    // sentMessages tablosundan sil (Supabase)
                    const { error: sentError } = await supabaseClient
                        .from('sentMessages')
                        .delete()
                        .in('recipientPhone', phoneVariations);
                    
                    if (sentError) {
                        console.warn('   ⚠️ sentMessages silme hatası:', sentError);
                    } else {
                        console.log('   ✅ sentMessages silindi');
                    }
                } catch (dbError) {
                    console.error('   ❌ Veritabanı silme hatası:', dbError);
                }
                
                // 3. Bellekten sil
                const index = whatsappContacts.findIndex(c => c.phone === phone);
                if (index !== -1) {
                    whatsappContacts.splice(index, 1);
                    console.log('   ✅ Konuşma bellekten silindi');
                }
                
                // 4. Eğer silinen konuşma şu an açıksa, mesaj alanını temizle
                if (currentWhatsAppContact?.phone === phone) {
                    currentWhatsAppContact = null;
                    const messagesArea = document.getElementById('whatsapp-messages-area');
                    if (messagesArea) {
                        messagesArea.innerHTML = `
                            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999; flex-direction: column; gap: 10px;">
                                <div style="font-size: 48px;">💬</div>
                                <div>Bir konuşma seçin</div>
                            </div>
                        `;
                    }
                }
                
                // 5. Listeyi yenile
                renderWhatsAppContactsList();
                
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                console.log('✅ KONUŞMA SİLME TAMAMLANDI');
                console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
                
                showAlert(`✅ ${name} ile olan konuşma silindi.`, 'success');
            } catch (error) {
                console.error('❌ Konuşma silme hatası:', error);
                showAlert('❌ Konuşma silinirken hata oluştu: ' + error.message, 'danger');
            }
        };
        
        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (seconds < 60) return 'Şimdi';
            if (minutes < 60) return `${minutes} dk`;
            if (hours < 24) return `${hours} sa`;
            if (days < 7) return `${days} gün`;
            return date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
        }
        
        window.addToCRM = async function(phone, name) {
            // Telefonu formatla (05xxx formatına)
            const cleanPhone = phone.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            console.log(`📝 CRM'e ekleniyor: ${name} - Telefon: ${phone} → ${formattedPhone}`);
            
            // Yeni potansiyel müşteri modalını aç
            openAddLeadModal();
            
            // Verileri doldur
            setTimeout(() => {
                const nameInput = document.querySelector('#addLeadModal input[name="name"]');
                const phoneInput = document.querySelector('#addLeadModal input[name="phone"]');
                if (nameInput) nameInput.value = name || '';
                if (phoneInput) {
                    phoneInput.value = formattedPhone;
                    // Telefon kontrolünü tetikle
                    phoneInput.dispatchEvent(new Event('blur'));
                }
                
                showAlert(`📝 CRM formu ${name} için hazırlandı`, 'success');
            }, 300);
        };
        
        // WhatsApp notification sound - Web Audio API ile basit bir bildirim sesi oluştur
        let audioContext = null;
        let whatsappNotificationSound = null;
        
        function createNotificationSound() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                return audioContext;
            } catch (e) {
                console.warn('AudioContext desteklenmiyor:', e);
                return null;
            }
        }
        
        async function playNotificationSound() {
            try {
                const ctx = createNotificationSound();
                if (!ctx) {
                    console.warn('Ses çalınamıyor - AudioContext yok');
                    return;
                }
                
                // AudioContext suspended ise resume et
                if (ctx.state === 'suspended') {
                    await ctx.resume();
                }
                
                // Hala suspended ise ses çalamazsın (kullanıcı etkileşimi gerekli)
                if (ctx.state !== 'running') {
                    console.log('ℹ️ Ses çalmak için kullanıcı etkileşimi gerekli (ilk tıklamadan sonra çalışacak)');
                    return;
                }
                
                // Basit bir bildirim sesi oluştur (beep)
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                // Ses ayarları
                oscillator.frequency.value = 800; // Frekans (Hz)
                oscillator.type = 'sine'; // Sinüs dalgası
                
                // Ses seviyesi
                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                
                // Sesi çal
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.5);
                
                console.log('✅ Bildirim sesi çalındı');
            } catch (e) {
                console.log('ℹ️ Ses çalınamadı (kullanıcı etkileşimi sonrası çalışacak):', e.message);
            }
        }
        
        // Ses izni iste
        let audioPermissionGranted = false;
        
        async function requestAudioPermission() {
            if (audioPermissionGranted) {
                return true; // Zaten verilmiş
            }
            
            try {
                // AudioContext'i başlat
                const ctx = createNotificationSound();
                if (ctx && ctx.state === 'suspended') {
                    await ctx.resume();
                }
                audioPermissionGranted = true;
                console.log('✅ Ses izni verildi');
                showAlert('✅ Ses izni verildi', 'success');
                return true;
            } catch (e) {
                console.warn('⚠️ Ses izni verilmedi:', e);
                audioPermissionGranted = false;
                return false;
            }
        }
        
        // Ses testi fonksiyonu
        window.testWhatsAppSound = async function() {
            try {
                await playNotificationSound();
                audioPermissionGranted = true;
                console.log('✅ WhatsApp bildirim sesi çalındı');
                showAlert('🔔 WhatsApp bildirim sesi çalındı!', 'success', 2000);
            } catch (e) {
                console.error('❌ Ses çalınamadı:', e);
                showAlert('❌ Ses çalınamadı: ' + e.message + '\n\nTarayıcınızın ses ayarlarını kontrol edin.', 'danger', 4000);
                audioPermissionGranted = false;
            }
        };
        
        // Sayfa yüklendiğinde ses izni kontrolü
        window.checkAndRequestAudioPermission = async function() {
            console.log('🔊 Ses izni hazır');
            // İlk kullanıcı etkileşiminde AudioContext başlatılacak
        };
        
        // Bildirim panelini güncelle
        window.updateNotificationPanel = function() {
            const statusText = document.getElementById('notification-status');
            const permissionBtn = document.getElementById('request-permission-btn');
            const panel = document.getElementById('whatsapp-notification-panel');
            
            if (!statusText || !permissionBtn || !panel) return;
            
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    panel.style.borderColor = '#4CAF50';
                    panel.style.background = '#e8f5e9';
                    statusText.innerHTML = '✅ Bildirimler aktif! Yeni mesajlardan haberdar olacaksınız.';
                    statusText.style.color = '#2e7d32';
                    permissionBtn.style.display = 'none'; // İzin butonu gizle
                } else if (Notification.permission === 'denied') {
                    panel.style.borderColor = '#f44336';
                    panel.style.background = '#ffebee';
                    statusText.innerHTML = '❌ Bildirim izni reddedildi. Tarayıcı ayarlarından izin vermeniz gerekiyor.';
                    statusText.style.color = '#c62828';
                    permissionBtn.textContent = '⚙️ Ayarlar';
                    permissionBtn.onclick = () => {
                        alert('Bildirim izni tarayıcı ayarlarından verilmelidir:\n\n1. Tarayıcınızın adres çubuğundaki kilit simgesine tıklayın\n2. "Site ayarları" veya "İzinler" bölümüne gidin\n3. "Bildirimler" iznini "İzin ver" olarak ayarlayın\n4. Sayfayı yenileyin');
                    };
                } else {
                    // default - izin istenmemiş
                    permissionBtn.style.display = 'inline-block';
                }
            } else {
                statusText.innerHTML = '⚠️ Tarayıcınız bildirimleri desteklemiyor.';
                permissionBtn.style.display = 'none';
            }
        };
        
        // Bildirim izni iste
        window.requestNotificationPermission = async function() {
            if (!('Notification' in window)) {
                showAlert('⚠️ Tarayıcınız bildirimları desteklemiyor.', 'warning');
                return false;
            }
            
            if (Notification.permission === 'granted') {
                showAlert('✅ Bildirim izni zaten verilmiş!', 'success', 2000);
                // Paneli güncelle
                if (window.updateNotificationPanel) updateNotificationPanel();
                return true;
            }
            
            if (Notification.permission === 'denied') {
                showAlert('❌ Bildirim izni reddedilmiş. Lütfen tarayıcı ayarlarından izin verin.', 'danger', 5000);
                // Paneli güncelle
                if (window.updateNotificationPanel) updateNotificationPanel();
                return false;
            }
            
            try {
                console.log('🔔 Bildirim izni isteniyor...');
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    console.log('✅ Bildirim izni verildi');
                    showAlert('✅ Bildirim izni başarıyla verildi!', 'success', 2000);
                    // Paneli güncelle
                    if (window.updateNotificationPanel) updateNotificationPanel();
                    return true;
                } else {
                    console.log('❌ Bildirim izni reddedildi');
                    showAlert('❌ Bildirim izni reddedildi', 'warning');
                    // Paneli güncelle
                    if (window.updateNotificationPanel) updateNotificationPanel();
                    return false;
                }
            } catch (error) {
                console.error('Bildirim izni hatası:', error);
                showAlert('❌ Bildirim izni alınamadı: ' + error.message, 'danger');
                return false;
            }
        };
        
        // Global variables for live updates
        let whatsappAutoRefreshInterval = null;
        let lastContactsCount = 0;
        
        // Gelen aramalar otomatik yenileme
        let incomingCallsAutoRefreshInterval = null;
        let lastIncomingCallsData = null;
        
        // Gelen aramalar otomatik yenileme başlat
        function startIncomingCallsAutoRefresh() {
            // Eğer zaten çalışıyorsa durdur
            if (incomingCallsAutoRefreshInterval) {
                clearInterval(incomingCallsAutoRefreshInterval);
            }
            
            console.log('🔄 Gelen aramalar otomatik yenileme başlatıldı (2 dakika)');
            
            incomingCallsAutoRefreshInterval = setInterval(async () => {
                // Sadece gelen aramalar sekmesi açıksa yenile
                const container = document.getElementById('incoming-calls-list');
                if (!container || container.offsetParent === null) {
                    // Sayfa görünür değil, yenileme yapmayalım
                    return;
                }
                
                console.log('📞 Gelen aramalar arka planda yenileniyor...');
                
                try {
                    // Mevcut veriyi kaydet
                    const oldData = window.incomingCallsCategories ? JSON.stringify(window.incomingCallsCategories) : null;
                    
                    // Yenile
                    await renderIncomingCallsPage();
                    
                    // Yeni veriyi kontrol et
                    const newData = window.incomingCallsCategories ? JSON.stringify(window.incomingCallsCategories) : null;
                    
                    // Değişiklik varsa bildir
                    if (oldData && newData && oldData !== newData) {
                        console.log('✅ Gelen aramalarda değişiklik tespit edildi, liste güncellendi');
                        
                        // Kısa bir bildirim göster (opsiyonel)
                        const notification = document.createElement('div');
                        notification.style.cssText = 'position: fixed; top: 70px; right: 20px; background: #4CAF50; color: white; padding: 10px 20px; border-radius: 8px; z-index: 10000; animation: fadeIn 0.3s;';
                        notification.textContent = '🔄 Gelen aramalar güncellendi';
                        document.body.appendChild(notification);
                        
                        setTimeout(() => {
                            notification.style.opacity = '0';
                            notification.style.transition = 'opacity 0.5s';
                            setTimeout(() => notification.remove(), 500);
                        }, 2000);
                    }
                } catch (error) {
                    console.error('❌ Gelen aramalar otomatik yenileme hatası:', error);
                }
            }, 120000); // 2 dakikada bir (120 saniye)
        }
        
        // Gelen aramalar otomatik yenileme durdur
        function stopIncomingCallsAutoRefresh() {
            if (incomingCallsAutoRefreshInterval) {
                clearInterval(incomingCallsAutoRefreshInterval);
                incomingCallsAutoRefreshInterval = null;
                console.log('⏸️ Gelen aramalar otomatik yenileme durduruldu');
            }
        }
        
        window.startIncomingCallsAutoRefresh = startIncomingCallsAutoRefresh;
        window.stopIncomingCallsAutoRefresh = stopIncomingCallsAutoRefresh;
        
        // Start auto-refresh when WhatsApp section is opened
        function startWhatsAppAutoRefresh() {
            if (whatsappAutoRefreshInterval) {
                clearInterval(whatsappAutoRefreshInterval);
            }
            
            whatsappAutoRefreshInterval = setInterval(async () => {
                const oldContacts = [...whatsappContacts];
                const oldContactsCount = whatsappContacts.length;
                
                // Toplam okunmamış mesaj sayısını hesapla (önceki)
                const oldTotalUnread = oldContacts.reduce((sum, c) => sum + (c.unreadCount || 0), 0);
                
                await loadWhatsAppContacts();
                
                // Toplam okunmamış mesaj sayısını hesapla (yeni)
                const newTotalUnread = whatsappContacts.reduce((sum, c) => sum + (c.unreadCount || 0), 0);
                
                // Yeni mesaj geldi mi kontrol et (yeni kişi veya okunmamış artışı)
                const hasNewMessage = whatsappContacts.length > oldContactsCount || newTotalUnread > oldTotalUnread;
                
                // Play notification sound if new messages detected
                if (hasNewMessage) {
                    try {
                        const newMessagesCount = Math.max(1, newTotalUnread - oldTotalUnread);
                        console.log(`🔔 Yeni mesaj bildirimi! (+${newMessagesCount} okunmamış mesaj)`);
                        
                        // En son mesaj gelen contact'ı bul
                        const latestContact = whatsappContacts
                            .filter(c => c.unreadCount > 0)
                            .sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0))[0];
                        
                        // ✅ Eğer kullanıcı o kontakla sohbeti görüntülüyorsa bildirim gösterme
                        let skipNotification = false;
                        if (currentWhatsAppContact && latestContact) {
                            if (formatPhoneForWhatsApp(latestContact.phone) === currentWhatsAppContact.phone) {
                                console.log('👀 Kullanıcı bu kontakla sohbeti görüntülüyor, bildirim atlanıyor (polling)');
                                skipNotification = true;
                            }
                        }
                        
                        if (!skipNotification) {
                            if (latestContact) {
                                const sender = latestContact.name || formatPhoneDisplay(latestContact.phone);
                                const messagePreview = latestContact.lastMessage || '';
                                // ❌ POLLING BILDIRIMINI KALDIR - Sadece checkForNewWhatsAppMessages göndermeli
                                console.log('⏭️ Polling bildirimi atlandı (checkForNewWhatsAppMessages zaten gönderiyor)');
                            }
                        }
                    } catch (e) {
                        console.log('Bildirim sesi çalınamadı:', e);
                    }
                }
                
                // Refresh current chat if open
                if (currentWhatsAppContact) {
                    const currentPhone = currentWhatsAppContact.phone;
                    const updatedContact = whatsappContacts.find(c => c.phone === currentPhone);
                    if (updatedContact && updatedContact.unreadCount > 0) {
                        // Silently reload messages
                        await loadMessagesForContact(currentPhone);
                    }
                }
                
                // ✅ Yeni mesaj kontrolü
                checkForNewWhatsAppMessages();
            }, 5000); // ✅ 5 saniyede bir kontrol et (daha hızlı bildirim)
            
            console.log('✅ WhatsApp fallback polling başlatıldı (5 saniyede bir)');
            
            // ✅ WhatsApp çağrıları için de polling başlat
            startWhatsAppCallsPolling();
            
            // ❌ Mesaj sync kapatıldı - Realtime listener yeterli
            // startWhatsAppMessageSync();
        }
        
        // ✅ Yeni mesajları kontrol et ve Supabase'e kaydet
        let whatsappMessageSyncInterval = null;
        let lastSyncTime = {};
        
        async function startWhatsAppMessageSync() {
            if (!selectedWhatsAppDevice || !currentClubId) return;
            
            // İlk sync
            await syncRecentMessages();
            
            // 30 saniyede bir kontrol
            whatsappMessageSyncInterval = setInterval(async () => {
                await syncRecentMessages();
            }, 30000);
            
            console.log('✅ WhatsApp mesaj senkronizasyonu başlatıldı (30 saniyede bir)');
        }
        
        async function syncRecentMessages() {
            if (!selectedWhatsAppDevice || !currentClubId) return;
            
            try {
                const device = selectedWhatsAppDevice;
                const evolutionUrl = device.evolutionUrl || EVOLUTION_API_URL;
                const apiKey = device.apiKey || EVOLUTION_API_KEY;
                
                // Son 1 dakikalık mesajları al
                const response = await fetch(`${evolutionUrl}/chat/findChats/${device.instanceName}`, {
                    method: 'POST',
                    headers: {
                        'apikey': apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ where: {} })
                });
                
                if (!response.ok) return;
                
                const chats = await response.json();
                let newMessageCount = 0;
                
                for (const chat of chats) {
                    if (!chat.lastMessage || chat.lastMessage.key?.fromMe) continue;
                    
                    const remoteJid = chat.remoteJid || chat.id;
                    if (!remoteJid || remoteJid.includes('@g.us')) continue;
                    
                    const messageTimestamp = chat.lastMessage.messageTimestamp;
                    const messageId = chat.lastMessage.key?.id;
                    
                    if (!messageTimestamp || !messageId) continue;
                    
                    // Son sync zamanını kontrol et
                    const lastSync = lastSyncTime[remoteJid] || 0;
                    if (messageTimestamp <= lastSync) continue;
                    
                    // Yeni mesaj! Supabase'e kaydet
                    let phone = remoteJid.replace('@s.whatsapp.net', '');
                    phone = cleanPhoneNumber(phone);
                    
                    const messageData = {
                        club_id: currentClubId,
                        remote_jid: remoteJid,
                        push_name: chat.lastMessage.pushName || chat.name || 'Bilinmeyen',
                        instance_name: device.instanceName,
                        message_timestamp: new Date(messageTimestamp * 1000).toISOString(),
                        message_timestamp_unix: messageTimestamp,
                        message_content: chat.lastMessage.message || {},
                        message_key: chat.lastMessage.key || {},
                        created_at: new Date().toISOString()
                    };
                    
                    const { error } = await supabase
                        .from('whatsapp_incoming_messages')
                        .insert(messageData);
                    
                    if (!error) {
                        lastSyncTime[remoteJid] = messageTimestamp;
                        newMessageCount++;
                        console.log('✅ Yeni mesaj Supabase e kaydedildi:', phone);
                    }
                }
                
                if (newMessageCount > 0) {
                    console.log(`📨 ${newMessageCount} yeni mesaj senkronize edildi`);
                }
                
            } catch (error) {
                console.error('❌ Mesaj senkronizasyon hatası:', error);
            }
        }
        
        function stopWhatsAppAutoRefresh() {
            if (whatsappAutoRefreshInterval) {
                clearInterval(whatsappAutoRefreshInterval);
                whatsappAutoRefreshInterval = null;
                console.log('⏸️ WhatsApp otomatik yenileme durduruldu');
            }
            
            // Çağrı polling'ini de durdur
            if (whatsappCallsPollingInterval) {
                clearInterval(whatsappCallsPollingInterval);
                whatsappCallsPollingInterval = null;
                console.log('⏸️ WhatsApp çağrı polling durduruldu');
            }
            
            // Mesaj sync'i de durdur
            if (whatsappMessageSyncInterval) {
                clearInterval(whatsappMessageSyncInterval);
                whatsappMessageSyncInterval = null;
                console.log('⏸️ WhatsApp mesaj senkronizasyonu durduruldu');
            }
        }
        
        // ✅ WhatsApp Çağrıları Polling Sistemi
        let whatsappCallsPollingInterval = null;
        let lastProcessedCallId = null;
        
        async function startWhatsAppCallsPolling() {
            console.log('📞 WhatsApp çağrı polling başlatılıyor...');
            
            // İlk kontrolü hemen yap
            await fetchAndSaveWhatsAppCalls();
            
            // Her 20 saniyede bir kontrol et (çağrılar daha az sıklıkta geliyor)
            whatsappCallsPollingInterval = setInterval(async () => {
                await fetchAndSaveWhatsAppCalls();
            }, 20000); // 20 saniye
            
            console.log('✅ WhatsApp çağrı polling başlatıldı (20 saniyede bir)');
        }
        
        async function fetchAndSaveWhatsAppCalls() {
            if (!clubSettings.whatsappDevices || clubSettings.whatsappDevices.length === 0) {
                return;
            }
            
            try {
                // Firebase'den mevcut çağrıları al (tekrar kaydetmemek için)
                const existingCalls = new Set();
                try {
                    const callsRef = window.firebase.collection(window.db, 'whatsappIncomingCalls');
                    const callsQuery = window.firebase.query(
                        callsRef,
                        window.firebase.where('clubId', '==', currentClubId)
                    );
                    const callsSnapshot = await window.firebase.getDocs(callsQuery);
                    callsSnapshot.docs.forEach(doc => {
                        const data = doc.data();
                        const callKey = `${data.from}_${data.timestamp}`;
                        existingCalls.add(callKey);
                    });
                    console.log(`📊 Firebase'de ${existingCalls.size} WhatsApp çağrısı bulundu`);
                } catch (error) {
                    console.warn('⚠️ Mevcut çağrılar kontrol edilemedi:', error);
                }
                
                let newCallsCount = 0;
                const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
                
                // Her cihaz için çağrıları kontrol et
                for (const device of clubSettings.whatsappDevices) {
                    try {
                        // Evolution API'den instance bilgilerini çek (çağrı olayları için)
                        // Not: Evolution API'nin call history endpoint'i yoksa, webhook ile alınmalı
                        // Şimdilik Firebase'e manuel kayıt için hazırlık yapıyoruz
                        
                        console.log(`✅ Cihaz ${device.instanceName} hazır (çağrılar webhook ile gelecek)`);
                        
                        // Alternatif: n8n workflow'undan gelen çağrıları kontrol et
                        // Bu kısım webhook kurulduktan sonra çalışacak
                        
                    } catch (deviceError) {
                        console.error(`❌ Cihaz ${device.instanceName} hatası:`, deviceError);
                    }
                }
                
                if (newCallsCount > 0) {
                    console.log(`✅ ${newCallsCount} yeni WhatsApp çağrısı Firebase'e kaydedildi`);
                    
                    // Gelen aramaları yenile
                    if (document.getElementById('incoming-calls-list')) {
                        await renderIncomingCallsPage();
                    }
                }
                
            } catch (error) {
                console.error('❌ WhatsApp çağrıları polling hatası:', error);
            }
        }
        
        // ✅ Webhook'tan gelen WhatsApp çağrısını Firebase'e kaydet
        window.saveWhatsAppCallToFirebase = async function(callData) {
            try {
                // Telefon numarasını temizle ve formatla
                const from = (callData.from || callData.data?.from || '').replace('@lid', '').replace('@s.whatsapp.net', '');
                const caller = from.startsWith('90') ? '0' + from.substring(2) : from;
                
                // Çağrı verisi - snake_case formatında
                const whatsappCall = {
                    caller_phone: from,
                    caller_name: caller,
                    called_number: callData.instance,
                    instance_name: callData.instance,
                    call_timestamp: callData.data?.date || callData.date_time || new Date().toISOString(),
                    call_status: callData.data?.status || 'unknown',
                    is_video: callData.data?.isVideo || false,
                    call_id: callData.data?.id || Date.now().toString(),
                    is_missing_call: ['ringing', 'missed'].includes(callData.data?.status || ''),
                    club_id: currentClubId,
                    created_at: new Date().toISOString()
                };
                
                // ✅ Supabase'e kaydet
                const { error } = await supabase
                    .from('whatsapp_incoming_calls')
                    .insert(whatsappCall);
                
                if (error) {
                    console.error('❌ WhatsApp çağrısı Supabase\'e kaydedilemedi:', error);
                    return false;
                }
                
                console.log('✅ WhatsApp çağrısı Supabase\'e kaydedildi:', whatsappCall);
                
                // Gelen aramaları yenile (eğer o sayfadaysak)
                if (document.getElementById('incoming-calls-list')) {
                    await renderIncomingCallsPage();
                }
                
                return true;
            } catch (error) {
                console.error('❌ WhatsApp çağrısı kaydedilemedi:', error);
                return false;
            }
        };
        
        // 🔥 Supabase Realtime Listeners (Multi-Tenant)
        let whatsappMessageChannel = null;
        let whatsappCallChannel = null;
        let realtimeListenersStarted = false; // ✅ Flag to prevent multiple subscriptions
        
        function startWhatsAppRealtimeListeners() {
            if (!currentClubId) {
                console.error('❌ Club ID bulunamadı, realtime listeners başlatılamadı');
                return;
            }
            
            // ✅ Eğer zaten başlatıldıysa tekrar başlatma
            if (realtimeListenersStarted) {
                console.log('⚠️ Realtime listeners zaten aktif, tekrar başlatılmadı');
                return;
            }
            
            console.log(`🔥 Supabase realtime listeners başlatılıyor (Club: ${currentClubId})...`);
            
            try {
                // 1. 📨 Mesaj Listener - Supabase Realtime
                whatsappMessageChannel = supabase
                    .channel(`whatsapp-messages-${currentClubId}`)
                    .on(
                        'postgres_changes',
                        {
                            event: 'INSERT',
                            schema: 'public',
                            table: 'whatsapp_incoming_messages',
                            filter: `club_id=eq.${currentClubId}`
                        },
                        async (payload) => {
                            const message = payload.new;
                            console.log('📨 Yeni mesaj geldi (Supabase Realtime):', message);
                            
                            // ✅ BOZUK NUMARA DÜZELTMESİ
                            if (message.remote_jid) {
                                const rawPhone = message.remote_jid.replace('@s.whatsapp.net', '');
                                const cleanedPhone = cleanPhoneNumber(rawPhone);
                                if (rawPhone !== cleanedPhone) {
                                    console.log('🔧 Bozuk numara düzeltildi:', rawPhone, '->', cleanedPhone);
                                    message.remote_jid = cleanedPhone + '@s.whatsapp.net';
                                }
                            }
                            
                            // ✅ Kendi gönderdiğimiz mesajlar için bildirim gösterme
                            if (message.message_key && message.message_key.fromMe) {
                                console.log('⏭️ Kendi mesajımız, bildirim atlanıyor');
                                setTimeout(() => loadWhatsAppContacts(), 50);
                                return;
                            }
                            
                            // ✅ Message ID kontrolü - mesaj ID'si olmalı
                            const messageId = message.message_key?.id || message.id;
                            if (!messageId) {
                                console.warn('⚠️ Mesaj ID yok, benzersiz kontrol yapılamıyor');
                            }
                            
                            // ✅ Bu mesaj için daha önce bildirim gösterildiyse atla
                            if (messageId && notifiedWhatsAppMessages.has(messageId)) {
                                console.log('⏭️ Bu mesaj için zaten bildirim gösterildi, atlanıyor');
                                return;
                            }
                            
                            // ✅ Eğer kullanıcı bu kontakla sohbeti görüntülüyorsa bildirim gösterme
                            let skipNotification = false;
                            if (currentWhatsAppContact && message.remote_jid) {
                                const messagePhone = message.remote_jid.replace('@s.whatsapp.net', '');
                                if (formatPhoneForWhatsApp(messagePhone) === currentWhatsAppContact.phone) {
                                    console.log('👀 Kullanıcı bu kontakla sohbeti görüntülüyor, bildirim atlanıyor');
                                    skipNotification = true;
                                    setTimeout(() => loadMessagesForContact(currentWhatsAppContact.phone), 200);
                                }
                            }
                            
                            // Kontak listesini güncelle
                            setTimeout(() => loadWhatsAppContacts(), 50);
                            
                            // Eğer bildirim atlanacaksa, sadece mesajı işaretle ve çık
                            if (skipNotification) {
                                if (messageId) {
                                    notifiedWhatsAppMessages.add(messageId);
                                }
                                return;
                            }
                            
                            // Bildirim göster
                            const sender = message.push_name || formatPhoneDisplay(message.remote_jid?.replace('@s.whatsapp.net', '')) || 'Bilinmeyen';
                            
                            // ✅ Mesaj içeriğini güvenilir şekilde al
                            let messageText = 'Mesaj';
                            if (message.message_content) {
                                messageText = message.message_content.conversation || 
                                              message.message_content.extendedTextMessage?.text || 
                                              message.message_content.imageMessage?.caption ||
                                              (message.message_content.imageMessage ? '📷 Fotoğraf' : '') ||
                                              (message.message_content.videoMessage ? '🎥 Video' : '') ||
                                              (message.message_content.audioMessage ? '🎵 Ses' : '') ||
                                              (message.message_content.documentMessage ? '📄 Dosya' : '') ||
                                              (message.message_content.stickerMessage ? '🎨 Sticker' : '') ||
                                              (message.message_content.locationMessage ? '📍 Konum' : '') ||
                                              'Mesaj';
                            }
                            
                            console.log('🔔 Bildirim gösteriliyor:', { sender, messageText, instanceName: message.instance_name });
                            
                            // ✅ Bildirimi göster ve mesajı işaretle
                            if (messageId) {
                                notifiedWhatsAppMessages.add(messageId);
                                console.log('✅ Mesaj bildirim setine eklendi:', messageId);
                            }
                            
                            await showWhatsAppMessageNotification(1, sender, messageText, message.instance_name, senderPhone);
                            
                            // ✅ Kontak listesini güncelle (okunmamış sayısını artırmak için)
                            setTimeout(() => loadWhatsAppContacts(), 300);
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            console.log('✅ WhatsApp mesaj realtime listener aktif (Supabase)');
                        }
                    });
                
                // 2. 📞 Çağrı Listener - Supabase Realtime
                whatsappCallChannel = supabase
                    .channel(`whatsapp-calls-${currentClubId}`)
                    .on(
                        'postgres_changes',
                        {
                            event: 'INSERT',
                            schema: 'public',
                            table: 'whatsapp_incoming_calls',
                            filter: `club_id=eq.${currentClubId}`
                        },
                        async (payload) => {
                            const call = payload.new;
                            console.log('� Yeni çağrı geldi (Supabase Realtime):', call);
                            
                            // Bildirim sesi çal
                            try {
                                await playNotificationSound();
                            } catch (e) {
                                console.log('Bildirim sesi çalınamadı:', e);
                            }
                            
                            // Çağrı bildirimi göster
                            const callType = call.is_video ? '📹 Görüntülü' : '📞 Sesli';
                            const callStatus = call.call_status === 'offer' ? 'Gelen Arama' : call.call_status;
                            const caller = call.caller_name || formatPhoneDisplay(call.caller_phone);
                            
                            showAlert(`${callType} ${callStatus}!\n${caller}`, 'warning', 5000);
                            
                            // Kontak listesini güncelle
                            setTimeout(() => loadWhatsAppContacts(), 50);
                            
                            // Gelen aramalar sayfasını güncelle
                            if (document.getElementById('incoming-calls-list')) {
                                await renderIncomingCallsPage();
                            }
                        }
                    )
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            console.log('✅ WhatsApp çağrı realtime listener aktif (Supabase)');
                            realtimeListenersStarted = true; // ✅ Flag'i işaretle
                        }
                    });
                
                console.log('✅ Supabase realtime listeners aktif (Mesajlar + Çağrılar)');
            } catch (error) {
                console.error('❌ Realtime listeners başlatılamadı:', error);
                realtimeListenersStarted = false; // ✅ Hata durumunda flag'i sıfırla

            }
        }
        
        function stopWhatsAppRealtimeListeners() {
            if (whatsappMessageChannel) {
                supabase.removeChannel(whatsappMessageChannel);
                whatsappMessageChannel = null;
            }
            if (whatsappCallChannel) {
                supabase.removeChannel(whatsappCallChannel);
                whatsappCallChannel = null;
            }
            console.log('⏸️ Supabase realtime listeners durduruldu');
        }
        
        window.selectWhatsAppContact = function(phone, name, contactData) {
            // Normalize phone for storage and API calls
            const normalizedPhone = formatPhoneForWhatsApp(phone);
            currentWhatsAppContact = { 
                phone: normalizedPhone, 
                name,
                type: contactData?.type || 'unknown',
                memberId: contactData?.memberId,
                leadId: contactData?.leadId
            };
            
            // Format phone for display (05xxx xxx xxxx)
            const displayPhone = formatPhoneDisplay(normalizedPhone);
            
            // Update old header (keep for backwards compatibility)
            const oldHeaderContact = document.getElementById('whatsapp-selected-contact');
            const oldHeaderPhone = document.getElementById('whatsapp-selected-phone');
            if (oldHeaderContact) oldHeaderContact.textContent = name;
            if (oldHeaderPhone) oldHeaderPhone.textContent = displayPhone;
            document.getElementById('whatsapp-selected-number').value = normalizedPhone;
            
            // Update new header with initial
            const newHeader = document.getElementById('whatsapp-messages-header');
            const chatContactName = document.getElementById('chat-contact-name');
            const chatContactPhone = document.getElementById('chat-contact-phone');
            const chatContactInitial = document.getElementById('chat-contact-initial');
            const chatContactBadge = document.getElementById('chat-contact-badge');
            
            if (newHeader) newHeader.style.display = 'block';
            if (chatContactName) chatContactName.textContent = name;
            if (chatContactPhone) chatContactPhone.textContent = displayPhone;
            if (chatContactInitial) {
                // Get first letter of first name
                const firstLetter = name.trim().charAt(0).toUpperCase();
                chatContactInitial.textContent = firstLetter;
            }
            
            // Set badge based on type
            if (chatContactBadge && contactData) {
                if (contactData.type === 'member') {
                    chatContactBadge.textContent = 'ÜYE';
                    chatContactBadge.style.background = '#25D366';
                    chatContactBadge.style.display = 'inline-block';
                } else if (contactData.type === 'crm') {
                    chatContactBadge.textContent = 'CRM';
                    chatContactBadge.style.background = '#FFA500';
                    chatContactBadge.style.display = 'inline-block';
                } else {
                    chatContactBadge.style.display = 'none';
                }
            }
            
            // ✅ CRM'e Ekle butonunu sadece 'unknown' tipler için göster
            const actionButtonsContainer = document.getElementById('chat-action-buttons');
            if (actionButtonsContainer) {
                // Eski CRM butonunu temizle
                const oldCrmBtn = actionButtonsContainer.querySelector('#add-to-crm-btn');
                if (oldCrmBtn) oldCrmBtn.remove();
                
                // Eğer kişi unknown ise CRM'e Ekle butonunu ekle
                if (contactData?.type === 'unknown') {
                    const crmBtn = document.createElement('button');
                    crmBtn.id = 'add-to-crm-btn';
                    crmBtn.title = 'CRM\'e Ekle';
                    crmBtn.innerHTML = '➕';
                    crmBtn.style.cssText = 'background: rgba(255,255,255,0.15); color: white; border: none; padding: 10px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.3s; cursor: pointer;';
                    crmBtn.onmouseover = function() { this.style.background = 'rgba(255,255,255,0.25)'; };
                    crmBtn.onmouseout = function() { this.style.background = 'rgba(255,255,255,0.15)'; };
                    crmBtn.onclick = function() {
                        addToCRM(normalizedPhone, name);
                    };
                    
                    // İlk çocuk olarak ekle (arama butonundan önce)
                    actionButtonsContainer.insertBefore(crmBtn, actionButtonsContainer.firstChild);
                }
            }
            
            // Show message input
            document.getElementById('whatsapp-message-input').style.display = 'block';
            const refreshBtn = document.getElementById('refresh-messages-btn');
            if (refreshBtn) refreshBtn.style.display = 'none'; // Hide old refresh button
            
            // Highlight selected contact
            document.querySelectorAll('.whatsapp-contact-item').forEach(item => {
                item.classList.remove('active');
            });
            const clickedItem = event.target.closest('.whatsapp-contact-item');
            clickedItem?.classList.add('active');
            
            // ✅ ANINDA OKUNDU OLARAK İŞARETLE - Badge'i sıfırla
            if (clickedItem) {
                const badge = clickedItem.querySelector('[style*="background: #25D366"]');
                if (badge) {
                    badge.style.display = 'none'; // Badge'i gizle
                }
            }
            
            // ✅ Global unread counter'ı güncelle
            const selectedContact = whatsappContacts?.find(c => c.phone === normalizedPhone);
            if (selectedContact && selectedContact.unreadCount > 0) {
                console.log(`📖 Konuşma açıldı: ${selectedContact.name} (${normalizedPhone}) - ${selectedContact.unreadCount} okunmamış → 0`);
                
                selectedContact.unreadCount = 0; // Contact'ın okunmamış sayısını sıfırla
                updateWhatsAppUnreadCount(); // Global sayacı güncelle
                
                // ✅ Evolution API'ye okundu bildirimi gönder
                sendReadReceiptToEvolution(normalizedPhone).catch(err => {
                    console.warn('⚠️ Evolution okundu bildirimi gönderilemedi:', err.message);
                });
            } else {
                console.log(`📖 Konuşma açıldı: ${normalizedPhone} - Zaten okunmuş (unreadCount: ${selectedContact?.unreadCount || 0})`);
            }
            
            // ✅ KALICI OKUNDU BİLGİSİ KAYDET
            markContactAsRead(normalizedPhone);
            
            // Load messages with normalized phone
            loadMessagesForContact(normalizedPhone);
        };
        
        // ✅ WhatsApp okunmamış sayacını güncelle
        window.updateWhatsAppUnreadCount = function() {
            const totalUnread = whatsappContacts?.reduce((sum, c) => sum + (c.unreadCount || 0), 0) || 0;
            console.log('📊 WhatsApp okunmamış mesaj sayısı güncellendi:', totalUnread);
            
            // ✅ BUGFIX: lastWhatsAppUnreadCount'u güncelle ki yeni mesaj kontrolü doğru çalışsın
            lastWhatsAppUnreadCount = totalUnread;
            
            // Sidebar badge'ini bul ve güncelle (eğer varsa)
            const sidebarBadge = document.querySelector('[href*="whatsapp"] .badge, [onclick*="whatsapp"] .badge');
            if (sidebarBadge) {
                if (totalUnread > 0) {
                    sidebarBadge.textContent = totalUnread;
                    sidebarBadge.style.display = 'inline';
                } else {
                    sidebarBadge.style.display = 'none';
                }
            }
            
            // Liste üstündeki toplam sayıyı güncelle (eğer varsa)
            const listHeader = document.querySelector('#whatsapp-messaging-area h4');
            if (listHeader && totalUnread > 0) {
                listHeader.innerHTML = `💬 Konuşmalar <span style="background: #25D366; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px;">${totalUnread}</span>`;
            } else if (listHeader) {
                listHeader.innerHTML = '💬 Konuşmalar';
            }
        };
        
        window.refreshCurrentMessages = async function() {
            if (!currentWhatsAppContact) {
                showAlert('Lütfen bir kişi seçin!', 'warning');
                return;
            }
            
            const btn = document.getElementById('refresh-messages-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '⏳ Yenileniyor...';
            btn.disabled = true;
            
            await loadMessagesForContact(currentWhatsAppContact.phone);
            
            btn.innerHTML = originalText;
            btn.disabled = false;
            showAlert('Mesajlar yenilendi!', 'success');
        };
        
        window.testFetchMessages = async function() {
            if (!currentWhatsAppContact) {
                showAlert('Lütfen bir kişi seçin!', 'warning');
                return;
            }
            
            console.log('═══════════════════════════════════════');
            console.log('🔍 WhatsApp Debug Test Başlatıldı');
            console.log('═══════════════════════════════════════');
            console.log('📞 Telefon:', currentWhatsAppContact.phone);
            console.log('👤 İsim:', currentWhatsAppContact.name);
            console.log('📱 Seçili Cihaz:', selectedWhatsAppDevice?.instanceName);
            console.log('🔗 Evolution URL:', selectedWhatsAppDevice?.evolutionUrl || EVOLUTION_API_URL);
            console.log('🔑 API Key Var mı:', selectedWhatsAppDevice?.apiKey ? 'Evet' : 'Hayır');
            console.log('═══════════════════════════════════════');
            
            showAlert('🔍 Debug bilgileri konsola yazdırılıyor, F12 ile konsolunuzu açın...', 'info');
            
            // Wait a bit so user can open console
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Test fetch
            console.log('📡 Mesajlar çekiliyor...');
            await loadMessagesForContact(currentWhatsAppContact.phone);
            
            console.log('═══════════════════════════════════════');
            console.log('✅ Test Tamamlandı');
            console.log('═══════════════════════════════════════');
            
            showAlert('✅ Test tamamlandı! Konsol çıktılarını kontrol edin (F12)', 'success');
        };
        
        window.syncMessagesToFirebase = async function() {
            if (!currentWhatsAppContact) {
                showAlert('Lütfen bir kişi seçin!', 'warning');
                return;
            }
            
            if (!selectedWhatsAppDevice) {
                showAlert('Lütfen bir cihaz seçin!', 'warning');
                return;
            }
            
            const confirmSync = confirm(`${currentWhatsAppContact.name} ile olan tüm mesajlar Firebase'e kaydedilecek. Devam etmek istiyor musunuz?`);
            if (!confirmSync) return;
            
            try {
                showAlert('📡 Mesajlar Evolution API\'den çekiliyor...', 'info');
                
                // Fetch messages from Evolution API
                const receivedMessages = await fetchReceivedMessages(currentWhatsAppContact.phone);
                
                if (receivedMessages.length === 0) {
                    showAlert('⚠️ Kaydedilecek mesaj bulunamadı.', 'warning');
                    return;
                }
                
                showAlert(`💾 ${receivedMessages.length} mesaj Firebase'e kaydediliyor...`, 'info');
                
                let savedCount = 0;
                let errorCount = 0;
                
                // Save each message to Firebase
                for (const msg of receivedMessages) {
                    try {
                        await window.firebase.addDoc(
                            window.firebase.collection(window.db, 'whatsappMessages'),
                            {
                                phone: currentWhatsAppContact.phone,
                                contactName: currentWhatsAppContact.name,
                                message: msg.message,
                                timestamp: msg.timestamp,
                                messageId: msg.messageId,
                                fromMe: msg.fromMe || false,
                                instanceName: selectedWhatsAppDevice.instanceName,
                                clubId: currentUser.clubId,
                                savedAt: new Date().toISOString(),
                                source: 'evolution_api_sync'
                            }
                        );
                        savedCount++;
                    } catch (saveError) {
                        console.error('Error saving message:', saveError);
                        errorCount++;
                    }
                }
                
                // Also save sent messages if any
                const ourMessages = sentMessages.filter(m => 
                    m.recipientPhone === currentWhatsAppContact.phone && 
                    m.instanceName === selectedWhatsAppDevice.instanceName
                );
                
                for (const msg of ourMessages) {
                    try {
                        // Check if already saved
                        const existingQuery = window.firebase.query(
                            window.firebase.collection(window.db, 'whatsappMessages'),
                            window.firebase.where('timestamp', '==', msg.sentAt),
                            window.firebase.where('fromMe', '==', true),
                            window.firebase.where('phone', '==', currentWhatsAppContact.phone)
                        );
                        const existingDocs = await window.firebase.getDocs(existingQuery);
                        
                        if (existingDocs.empty) {
                            await window.firebase.addDoc(
                                window.firebase.collection(window.db, 'whatsappMessages'),
                                {
                                    phone: currentWhatsAppContact.phone,
                                    contactName: currentWhatsAppContact.name,
                                    message: msg.message,
                                    timestamp: msg.sentAt,
                                    messageId: msg.messageId || null,
                                    fromMe: true,
                                    instanceName: selectedWhatsAppDevice.instanceName,
                                    clubId: currentUser.clubId,
                                    savedAt: new Date().toISOString(),
                                    success: msg.success,
                                    source: 'admin_panel_sent'
                                }
                            );
                            savedCount++;
                        }
                    } catch (saveError) {
                        console.error('Error saving sent message:', saveError);
                        errorCount++;
                    }
                }
                
                showAlert(`✅ Başarılı! ${savedCount} mesaj Firebase'e kaydedildi${errorCount > 0 ? `, ${errorCount} hata` : ''}.`, 'success');
                
                console.log(`📊 Firebase Sync Sonucu: ${savedCount} başarılı, ${errorCount} hata`);
                
            } catch (error) {
                console.error('Sync error:', error);
                showAlert('❌ Mesajlar kaydedilirken hata oluştu: ' + error.message, 'danger');
            }
        };
        
        async function loadMessagesForContact(phone) {
            const messagesArea = document.getElementById('whatsapp-messages-area');
            messagesArea.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #667781;"><div style="text-align: center;"><div class="spinner" style="width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #25D366; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div><p>Mesajlar yükleniyor...</p></div></div>';
            
            if (!selectedWhatsAppDevice) {
                messagesArea.innerHTML = '<div class="empty-state" style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"><p style="margin: 0; color: #666;">Lütfen önce bir cihaz seçin</p></div>';
                return;
            }
            
            try {
                // Normalize phone number for comparison
                const normalizedPhone = formatPhoneForWhatsApp(phone);
                
                console.log(`🔍 Mesaj arama: ${phone} → ${normalizedPhone}`);
                console.log(`📦 sentMessages array'de toplam ${sentMessages.length} mesaj var`);
                
                // ✅ Bu kontak için gösterilen bildirimleri temizle
                // Kullanıcı mesajları görüntülüyor, artık bildirim göstermemeli
                console.log(`🧹 ${normalizedPhone} için eski bildirimler temizleniyor...`);
                
                // Debug: Show first few sent messages
                if (sentMessages.length > 0) {
                    console.log('📝 İlk gönderilen mesaj örneği:', {
                        recipientPhone: sentMessages[0].recipientPhone,
                        normalized: formatPhoneForWhatsApp(sentMessages[0].recipientPhone || ''),
                        instanceName: sentMessages[0].instanceName,
                        currentInstance: selectedWhatsAppDevice.instanceName
                    });
                }
                
                // Get messages from sentMessages (our sent messages)
                const ourMessages = sentMessages.filter(m => {
                    const recipientNormalized = formatPhoneForWhatsApp(m.recipientPhone || '');
                    const matches = recipientNormalized === normalizedPhone && 
                                   m.instanceName === selectedWhatsAppDevice.instanceName;
                    
                    // Debug: Log filtering
                    if (recipientNormalized === normalizedPhone && !matches) {
                        console.log(`⚠️ Telefon eşleşti ama instance farklı: ${m.instanceName} vs ${selectedWhatsAppDevice.instanceName}`);
                    }
                    
                    return matches;
                }).map(m => ({
                    type: 'sent',
                    message: m.message,
                    timestamp: m.sentAt,
                    success: m.success
                }));
                
                console.log(`💬 Gönderilen mesajlar (Firebase): ${ourMessages.length} adet (${normalizedPhone} için)`);
                
                // Get ALL messages from Evolution API (including sent and received)
                const evolutionMessages = await fetchReceivedMessages(phone);
                console.log(`📡 Evolution API mesajları: ${evolutionMessages.length} adet (${evolutionMessages.filter(m => m.fromMe).length} gönderilen, ${evolutionMessages.filter(m => !m.fromMe).length} alınan)`);
                
                // Evolution API'den gelen mesajları kullan (zaten type'ları var)
                const receivedMessages = evolutionMessages.filter(m => !m.fromMe).map(m => ({
                    type: 'received',
                    message: m.message,
                    timestamp: m.timestamp,
                    sender: m.sender
                }));
                
                const sentFromEvolution = evolutionMessages.filter(m => m.fromMe).map(m => ({
                    type: 'sent',
                    message: m.message,
                    timestamp: m.timestamp,
                    success: true
                }));
                
                // Combine and sort all messages by timestamp
                // Evolution API (primary) + Firebase (sent messages fallback)
                const allMessages = [
                    ...sentFromEvolution,      // ← Evolution API'den gelen sent mesajlar (öncelikli)
                    ...ourMessages,            // ← Firebase'den gelen sent mesajlar (fallback)
                    ...receivedMessages        // ← Evolution API'den gelen received mesajlar (güncel)
                ]
                .filter((msg, index, self) => {
                    // Remove duplicates based on timestamp and message
                    return index === self.findIndex(m => 
                        Math.abs(new Date(m.timestamp) - new Date(msg.timestamp)) < 2000 && // 2 saniye tolerans
                        m.message === msg.message
                    );
                })
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                console.log(`📊 Toplam ${allMessages.length} mesaj (Evolution: ${sentFromEvolution.length} sent + ${receivedMessages.length} received, Firebase: ${ourMessages.length} sent)`);
                
                // Debug: Log all message types
                console.log('📝 Mesaj detayları:', {
                    sentFromEvolution: sentFromEvolution.slice(0, 2),
                    ourMessages: ourMessages.slice(0, 2),
                    receivedMessages: receivedMessages.slice(0, 2),
                    allMessages: allMessages.slice(0, 3)
                });
                
                if (allMessages.length === 0) {
                    messagesArea.innerHTML = `
                        <div class="empty-state">
                            <p>Henüz mesaj yok. İlk mesajı gönderin! 👋</p>
                        </div>
                    `;
                    return;
                }
                
                // Group messages by date
                const messagesByDate = {};
                allMessages.forEach(msg => {
                    const date = new Date(msg.timestamp).toLocaleDateString('tr-TR');
                    if (!messagesByDate[date]) messagesByDate[date] = [];
                    messagesByDate[date].push(msg);
                });
                
                // Render messages
                messagesArea.innerHTML = Object.keys(messagesByDate).map(date => {
                    const msgs = messagesByDate[date];
                    return `
                        <div style="text-align: center; margin: 15px 0;">
                            <span class="message-date-divider">${date}</span>
                        </div>
                        ${msgs.map(msg => {
                            const msgDate = new Date(msg.timestamp);
                            const timeStr = formatTime(msg.timestamp);
                            const dateStr = msgDate.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                            const fullDateTime = `${dateStr} ${timeStr}`;
                            
                            if (msg.type === 'sent') {
                                return `
                                    <div class="whatsapp-message-wrapper sent">
                                        <div class="whatsapp-message sent">
                                            <div class="message-content">${escapeHtml(msg.message)}</div>
                                            <div class="message-time">
                                                ${timeStr} ${msg.success ? '<span class="message-check">✓✓</span>' : '✗'}
                                                <span style="font-size: 9px; color: rgba(0,0,0,0.35); margin-left: 6px;">${dateStr}</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else {
                                return `
                                    <div class="whatsapp-message-wrapper received">
                                        <div class="whatsapp-message received">
                                            <div class="message-content">${escapeHtml(msg.message)}</div>
                                            <div class="message-time">
                                                ${timeStr}
                                                <span style="font-size: 9px; color: rgba(0,0,0,0.35); margin-left: 6px;">${dateStr}</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        }).join('')}
                    `;
                }).join('');
                
                // Scroll to bottom
                messagesArea.scrollTop = messagesArea.scrollHeight;
            } catch (error) {
                console.error('Error loading messages:', error);
                messagesArea.innerHTML = `
                    <div class="empty-state">
                        <p style="color: #f44336;">⚠️ Mesajlar yüklenirken hata oluştu.</p>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }
        
        async function fetchReceivedMessages(phone) {
            try {
                // Use the selected device
                if (!selectedWhatsAppDevice) {
                    console.log('❌ No device selected for fetching messages');
                    return [];
                }
                
                const device = selectedWhatsAppDevice;
                const evolutionUrl = device.evolutionUrl || EVOLUTION_API_URL;
                const apiKey = device.apiKey || EVOLUTION_API_KEY;
                
                console.log(`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`);
                console.log(`📱 EVOLUTION API MESAJ ÇEKME`);
                console.log(`   Telefon: ${phone}`);
                console.log(`   Cihaz: ${device.instanceName}`);
                console.log(`   Evolution URL: ${evolutionUrl}`);
                console.log(`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`);
                
                // Format phone number correctly
                let formattedPhone = phone.replace(/\D/g, '');
                
                // Ensure phone starts with country code (12 digits: 905449367543)
                if (formattedPhone.startsWith('0') && formattedPhone.length === 11) {
                    // 05449367543 → 905449367543
                    formattedPhone = '90' + formattedPhone.substring(1);
                } else if (!formattedPhone.startsWith('90') && formattedPhone.length === 10) {
                    // 5449367543 → 905449367543
                    formattedPhone = '90' + formattedPhone;
                } else if (formattedPhone.startsWith('90') && formattedPhone.length === 12) {
                    // Already correct: 905449367543
                    // Do nothing
                } else {
                    console.warn(`⚠️ Geçersiz telefon formatı: ${phone} → ${formattedPhone} (${formattedPhone.length} hane)`);
                }
                
                const remoteJid = `${formattedPhone}@s.whatsapp.net`;
                
                console.log(`📞 Remote JID: ${remoteJid} (${formattedPhone.length} hane)`);
                
                // ✅ Evolution API v2.x endpoints - SIRAYLA DENE
                const endpoints = [
                    // Method 1: Chat messages endpoint (recommended)
                    {
                        name: 'chat/findMessages',
                        url: `${evolutionUrl}/chat/findMessages/${device.instanceName}`,
                        body: {
                            where: {
                                key: {
                                    remoteJid: remoteJid
                                }
                            },
                            limit: 100
                        }
                    },
                    // Method 2: Message fetch endpoint
                    {
                        name: 'message/find',
                        url: `${evolutionUrl}/message/find/${device.instanceName}`,
                        body: {
                            where: {
                                key: {
                                    remoteJid: remoteJid
                                }
                            },
                            limit: 100
                        }
                    },
                    // Method 3: Chat find with messages
                    {
                        name: 'chat/find',
                        url: `${evolutionUrl}/chat/find/${device.instanceName}`,
                        body: {
                            where: {
                                id: remoteJid
                            }
                        }
                    }
                ];
                
                let allMessages = [];
                
                for (const endpoint of endpoints) {
                    try {
                        console.log(`🔍 Endpoint deneniyor: ${endpoint.name}`);
                        console.log(`   URL: ${endpoint.url}`);
                        
                        const response = await fetch(endpoint.url, {
                            method: 'POST',
                            headers: {
                                'apikey': apiKey,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(endpoint.body)
                        });
                        
                        console.log(`   📊 Response: ${response.status} ${response.statusText}`);
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.log(`   ❌ Endpoint failed: ${response.status}`);
                            console.log(`   📄 Error: ${errorText.substring(0, 200)}`);
                            continue; // Try next endpoint
                        }
                        
                        const data = await response.json();
                        console.log(`   ✅ Success! Data keys:`, Object.keys(data));
                        
                        // Parse different response structures
                        let messages = [];
                        
                        // Evolution API v2 Response Formats:
                        
                        // Format 1: Direct array of messages
                        if (Array.isArray(data)) {
                            console.log(`   � Format 1: Direct array (${data.length} items)`);
                            
                            // Check if it's array of chat objects with messages inside
                            if (data.length > 0 && data[0].messages) {
                                console.log(`   � Format 1a: Array of chat objects`);
                                // Merge all messages from all chats
                                data.forEach(chat => {
                                    if (chat.messages && Array.isArray(chat.messages)) {
                                        messages.push(...chat.messages);
                                    }
                                });
                            } else if (data.length > 0 && data[0].key) {
                                // Direct array of message objects
                                console.log(`   � Format 1b: Direct message array`);
                                messages = data;
                            } else {
                                console.log(`   ⚠️ Format 1c: Unknown array structure`);
                            }
                        }
                        // Format 2: data.messages.records array (Evolution API v2 paginated)
                        else if (data.messages && data.messages.records && Array.isArray(data.messages.records)) {
                            console.log(`   � Format 2a: Paginated (${data.messages.total} total)`);
                            messages = data.messages.records;
                        }
                        // Format 2b: data.messages array
                        else if (data.messages && Array.isArray(data.messages)) {
                            console.log(`   � Format 2b: data.messages array`);
                            messages = data.messages;
                        }
                        // Format 3: data.data array
                        else if (data.data && Array.isArray(data.data)) {
                            console.log(`   � Format 3: data.data array`);
                            messages = data.data;
                        }
                        // Format 4: Wrapped response
                        else if (data.response && Array.isArray(data.response)) {
                            console.log(`   � Format 4: data.response array`);
                            messages = data.response;
                        }
                        // Format 5: Single chat object
                        else if (data.id && data.messages) {
                            console.log(`   � Format 5: Single chat object`);
                            messages = data.messages;
                        }
                        
                        console.log(`   📝 Extracted ${messages.length} messages`);
                        
                        if (messages.length === 0) {
                            console.log(`   ⚠️ No messages in response, trying next endpoint...`);
                            continue;
                        }
                        
                        // Extract message content
                        const parsedMessages = messages
                            .map(m => {
                                // Extract message text from various formats
                                let messageText = '';
                                if (m.message) {
                                    messageText = m.message.conversation 
                                        || m.message.extendedTextMessage?.text
                                        || m.message.imageMessage?.caption
                                        || m.message.videoMessage?.caption
                                        || m.message.documentMessage?.caption
                                        || '';
                                }
                                
                                if (!messageText) return null;
                                
                                // Check if this is from us (fromMe: true)
                                const isFromMe = m.key?.fromMe === true;
                                
                                return {
                                    message: messageText,
                                    timestamp: m.messageTimestamp 
                                        ? new Date(m.messageTimestamp * 1000).toISOString() 
                                        : new Date().toISOString(),
                                    sender: phone,
                                    messageId: m.key?.id || Math.random().toString(36),
                                    fromMe: isFromMe,
                                    type: isFromMe ? 'sent' : 'received'
                                };
                            })
                            .filter(m => m !== null);
                        
                        console.log(`   ✅ Parsed ${parsedMessages.length} messages:`);
                        console.log(`      - Sent: ${parsedMessages.filter(m => m.fromMe).length}`);
                        console.log(`      - Received: ${parsedMessages.filter(m => !m.fromMe).length}`);
                        
                        if (parsedMessages.length > 0) {
                            allMessages = parsedMessages;
                            console.log(`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`);
                            console.log(`✅ SUCCESS! ${endpoint.name} çalıştı`);
                            console.log(`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`);
                            break; // Success, stop trying other endpoints
                        }
                    } catch (endpointError) {
                        console.error(`   ❌ Endpoint error:`, endpointError.message);
                    }
                }
                
                if (allMessages.length === 0) {
                    console.log(`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`);
                    console.log(`ℹ️ Evolution API'den mesaj alınamadı (Supabase'den devam ediliyor)`);
                    console.log(`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`);
                }
                
                return allMessages;
            } catch (error) {
                console.error('❌ Error fetching received messages:', error);
                return [];
            }
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function loadWhatsAppDevicesMain() {
            const container = document.getElementById('whatsappDevicesList-main');
            
            const userDevices = currentUser.isSuperAdmin 
                ? whatsappDevices 
                : whatsappDevices.filter(d => d.createdBy === currentUser.email);
            
            if (userDevices.length === 0) {
                container.innerHTML = '<p class="empty-state">Henüz bağlı cihaz yok.</p>';
                return;
            }
            
            container.innerHTML = userDevices.map(device => `
                <div class="settings-subsection" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 5px 0;">${device.instanceName}</h4>
                            <small style="color: #666;">📞 ${device.phoneNumber}</small><br>
                            <small style="color: #666;">🆔 ${device.instanceName}</small><br>
                            <small>Durum: <span class="badge ${device.status === 'connected' ? 'bg-success' : device.status === 'pending' ? 'bg-warning' : 'bg-danger'}">${device.status === 'connected' ? '🟢 Bağlı' : device.status === 'pending' ? '🟡 Beklemede' : '🔴 Bağlı Değil'}</span></small>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                            ${device.status !== 'connected' ? `<button class="btn btn-sm btn-primary" onclick="window.showInstanceQR('${device.instanceName}')">📱 QR Göster</button>` : ''}
                            <button class="btn btn-sm btn-secondary" onclick="window.checkConnectionStatus('${device.instanceName}', '${device.id}')">✔️ Durum</button>
                            <button class="btn btn-sm btn-warning" onclick="window.restartInstance('${device.instanceName}', '${device.id}')">🔄 Yenile</button>
                            <button class="btn btn-sm btn-danger" onclick="window.deleteInstance('${device.instanceName}', '${device.id}')">🗑️ Sil</button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Update webhook device dropdown
            updateWebhookDeviceDropdown();
            
            // ✅ Load WhatsApp settings into form fields
            document.getElementById('minWaitTime').value = clubSettings.minWaitTime || 20;
            document.getElementById('maxWaitTime').value = clubSettings.maxWaitTime || 50;
            document.getElementById('longWaitTrigger').value = clubSettings.longWaitTrigger || 100;
            document.getElementById('minLongWait').value = clubSettings.minLongWait || 400;
            document.getElementById('maxLongWait').value = clubSettings.maxLongWait || 800;
        }
        
        // Edit Device
        function editDevice(deviceId) {
            const device = whatsappDevices.find(d => d.id === deviceId);
            if (!device) {
                showAlert('Cihaz bulunamadı', 'danger');
                return;
            }
            
            const modalHtml = `
                <div style="padding: 20px;">
                    <h3 style="margin-bottom: 20px;">✏️ Cihaz Düzenle: ${device.instanceName}</h3>
                    <form id="editDeviceForm" onsubmit="saveDeviceEdit(event, '${deviceId}')">
                        <div class="form-group">
                            <label>Cihaz Adı</label>
                            <input type="text" id="edit_instanceName" class="form-control" value="${device.instanceName}" readonly>
                            <small style="color: #666;">Cihaz adı değiştirilemez</small>
                        </div>
                        <div class="form-group">
                            <label>Telefon Numarası</label>
                            <input type="tel" id="edit_phoneNumber" class="form-control" value="${device.phoneNumber}" readonly>
                            <small style="color: #666;">Telefon numarası değiştirilemez</small>
                        </div>
                        <div class="form-group">
                            <label>Evolution API URL *</label>
                            <input type="url" id="edit_evolutionUrl" class="form-control" value="${device.evolutionUrl || ''}" placeholder="https://evo.example.com" required>
                            <small style="color: #666;">Evolution API sunucunuzun adresi</small>
                        </div>
                        <div class="form-group">
                            <label>API Key *</label>
                            <input type="text" id="edit_apiKey" class="form-control" value="${device.apiKey || ''}" placeholder="your-api-key" required>
                            <small style="color: #666;">Evolution API anahtarınız</small>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-success">💾 Kaydet</button>
                            <button type="button" class="btn btn-secondary" onclick="closeAlert()">İptal</button>
                        </div>
                    </form>
                </div>
            `;
            
            showAlert(modalHtml, 'info');
        }
        
        async function saveDeviceEdit(event, deviceId) {
            event.preventDefault();
            
            const evolutionUrl = document.getElementById('edit_evolutionUrl').value.trim();
            const apiKey = document.getElementById('edit_apiKey').value.trim();
            
            if (!evolutionUrl || !apiKey) {
                showAlert('Lütfen tüm alanları doldurun', 'danger');
                return;
            }
            
            try {
                const { updateDoc, doc } = window.firebase;
                await updateDoc(doc(window.db, 'whatsappDevices', deviceId), {
                    evolutionUrl: evolutionUrl,
                    apiKey: apiKey,
                    updatedAt: new Date().toISOString()
                });
                
                // Update local data
                const device = whatsappDevices.find(d => d.id === deviceId);
                if (device) {
                    device.evolutionUrl = evolutionUrl;
                    device.apiKey = apiKey;
                }
                
                showAlert('✅ Cihaz bilgileri güncellendi!', 'success');
                loadWhatsAppDevicesMain();
            } catch (error) {
                console.error('Error updating device:', error);
                showAlert('Güncelleme hatası: ' + error.message, 'danger');
            }
        }
        
        window.editDevice = editDevice;
        window.saveDeviceEdit = saveDeviceEdit;
        
        // === WEBHOOK MANAGEMENT FUNCTIONS ===
        
        function updateWebhookDeviceDropdown() {
            const select = document.getElementById('webhookDevice');
            if (!select) return;
            
            const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
            
            if (connectedDevices.length === 0) {
                select.innerHTML = '<option value="">Önce cihaz bağlayın...</option>';
                return;
            }
            
            select.innerHTML = '<option value="">Cihaz seçin...</option>' +
                connectedDevices.map(d => `<option value="${d.instanceName}">${d.instanceName} (${d.phoneNumber})</option>`).join('');
        }
        
        async function loadWebhookForDevice(instanceName) {
            if (!instanceName) {
                document.getElementById('webhookUrl').value = '';
                document.getElementById('webhookEnabled').checked = true;
                document.getElementById('webhookStatus').style.display = 'none';
                return;
            }
            
            const device = whatsappDevices.find(d => d.instanceName === instanceName);
            if (!device) return;
            
            // Check if evolutionUrl exists
            if (!device.evolutionUrl || device.evolutionUrl === 'undefined') {
                showAlert('⚠️ Bu cihazın Evolution API URL\'si tanımlanmamış. Lütfen WhatsApp ayarlarından cihazı düzenleyin ve Evolution API URL\'sini ekleyin.', 'danger');
                console.error('Device missing evolutionUrl:', device);
                return;
            }
            
            try {
                // Fetch current webhook config from Evolution API
                const response = await fetch(`${device.evolutionUrl}/webhook/find/${instanceName}`, {
                    method: 'GET',
                    headers: {
                        'apikey': device.apiKey
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update form fields
                    document.getElementById('webhookUrl').value = data.url || '';
                    document.getElementById('webhookEnabled').checked = data.enabled !== false;
                    
                    // Update event checkboxes
                    document.querySelectorAll('input[name="webhookEvents"]').forEach(cb => {
                        cb.checked = data.events && data.events.includes(cb.value);
                    });
                    
                    // Show webhook status
                    showWebhookStatus(data);
                } else {
                    console.log('No webhook configured for this device yet');
                    document.getElementById('webhookUrl').value = '';
                    document.getElementById('webhookEnabled').checked = true;
                    document.getElementById('webhookStatus').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading webhook:', error);
                showAlert('Webhook bilgileri yüklenirken hata oluştu: ' + error.message, 'danger');
            }
        }
        
        async function saveWebhookConfig(event) {
            event.preventDefault();
            
            const instanceName = document.getElementById('webhookDevice').value;
            const webhookUrl = document.getElementById('webhookUrl').value;
            const enabled = document.getElementById('webhookEnabled').checked;
            
            if (!instanceName) {
                showAlert('Lütfen bir cihaz seçin.', 'danger');
                return;
            }
            
            const device = whatsappDevices.find(d => d.instanceName === instanceName);
            if (!device) {
                showAlert('Cihaz bulunamadı.', 'danger');
                return;
            }
            
            // Check if evolutionUrl exists
            if (!device.evolutionUrl || device.evolutionUrl === 'undefined') {
                showAlert('⚠️ Bu cihazın Evolution API URL\'si tanımlanmamış. Lütfen WhatsApp ayarlarından cihazı düzenleyin ve Evolution API URL\'sini ekleyin.', 'danger');
                console.error('Device missing evolutionUrl:', device);
                return;
            }
            
            // Get selected events
            const selectedEvents = Array.from(document.querySelectorAll('input[name="webhookEvents"]:checked'))
                .map(cb => cb.value);
            
            if (selectedEvents.length === 0) {
                showAlert('En az bir event seçmelisiniz.', 'danger');
                return;
            }
            
            try {
                const response = await fetch(`${device.evolutionUrl}/webhook/set/${instanceName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': device.apiKey
                    },
                    body: JSON.stringify({
                        enabled: enabled,
                        url: webhookUrl,
                        webhookByEvents: false,
                        webhookBase64: true,
                        events: selectedEvents
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showAlert('✅ Webhook başarıyla kaydedildi!', 'success');
                    showWebhookStatus(data.webhook || {
                        enabled: enabled,
                        url: webhookUrl,
                        events: selectedEvents
                    });
                    
                    // Save to Firebase for tracking
                    await window.firebase.updateDoc(
                        window.firebase.doc(window.db, 'whatsappDevices', device.id),
                        {
                            webhookUrl: webhookUrl,
                            webhookEnabled: enabled,
                            webhookEvents: selectedEvents,
                            webhookLastUpdated: new Date().toISOString()
                        }
                    );
                } else {
                    const error = await response.text();
                    throw new Error(error || 'Webhook kaydedilemedi');
                }
            } catch (error) {
                console.error('Error saving webhook:', error);
                showAlert('Webhook kaydedilirken hata oluştu: ' + error.message, 'danger');
            }
        }
        
        function showWebhookStatus(webhookData) {
            const statusDiv = document.getElementById('webhookStatus');
            const contentDiv = document.getElementById('webhookStatusContent');
            
            if (!webhookData || !webhookData.url) {
                statusDiv.style.display = 'none';
                return;
            }
            
            const statusHtml = `
                <div style="display: grid; gap: 10px;">
                    <div>
                        <strong>Webhook URL:</strong><br>
                        <code style="background: #f0f0f0; padding: 5px 10px; border-radius: 4px; display: inline-block; margin-top: 5px; word-break: break-all;">
                            ${webhookData.url}
                        </code>
                    </div>
                    <div>
                        <strong>Durum:</strong> 
                        <span class="badge ${webhookData.enabled ? 'bg-success' : 'bg-secondary'}">
                            ${webhookData.enabled ? '✅ Etkin' : '❌ Devre Dışı'}
                        </span>
                    </div>
                    <div>
                        <strong>İzlenen Event'ler:</strong><br>
                        ${(webhookData.events || []).map(e => `<span class="badge bg-info" style="margin-right: 5px;">${e}</span>`).join('')}
                    </div>
                </div>
            `;
            
            contentDiv.innerHTML = statusHtml;
            statusDiv.style.display = 'block';
        }
        
        async function testWebhook() {
            const instanceName = document.getElementById('webhookDevice').value;
            const webhookUrl = document.getElementById('webhookUrl').value;
            
            if (!instanceName || !webhookUrl) {
                showAlert('Lütfen cihaz ve webhook URL seçin.', 'danger');
                return;
            }
            
            try {
                // Send a test POST request to the webhook URL
                const testData = {
                    event: "webhook_test",
                    instance: instanceName,
                    data: {
                        message: "Bu bir test mesajıdır",
                        timestamp: new Date().toISOString(),
                        from: "Admin Panel"
                    }
                };
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                if (response.ok) {
                    showAlert('✅ Webhook test başarılı! URL\'niz çalışıyor.', 'success');
                } else {
                    showAlert(`⚠️ Webhook yanıt verdi ama hata kodu döndü: ${response.status}`, 'warning');
                }
            } catch (error) {
                console.error('Webhook test error:', error);
                showAlert('❌ Webhook test başarısız. URL erişilebilir değil: ' + error.message, 'danger');
            }
        }
        
        window.loadWebhookForDevice = loadWebhookForDevice;
        window.saveWebhookConfig = saveWebhookConfig;
        window.testWebhook = testWebhook;
        
        function loadBulkMessageForm() {
            // This function is now handled by onBulkBranchChange
            // Groups are loaded dynamically based on selected branch
        }
        
        function formatPhoneForWhatsApp(phone) {
            if (!phone) return '';
            phone = phone.replace(/\D/g, '');
            if (phone.startsWith('0')) {
                phone = '90' + phone.substring(1);
            } else if (!phone.startsWith('90')) {
                phone = '90' + phone;
            }
            return phone;
        }
        
        // Telefon numarasını görsel formatlama (05xx xxx xxxx)
        function formatPhoneDisplay(phone) {
            if (!phone) return '';
            
            // Tüm rakam olmayan karakterleri temizle
            let cleaned = phone.replace(/\D/g, '');
            
            // 90 ile başlıyorsa 0'a çevir
            if (cleaned.startsWith('90') && cleaned.length === 12) {
                cleaned = '0' + cleaned.substring(2);
            }
            
            // 0 ile başlayan 11 haneli Türkiye numarası formatı
            if (cleaned.startsWith('0') && cleaned.length === 11) {
                return `${cleaned.substring(0, 4)} ${cleaned.substring(4, 7)} ${cleaned.substring(7, 9)} ${cleaned.substring(9)}`;
            }
            
            // Diğer formatlar için olduğu gibi döndür
            return phone;
        }
        
        async function handleWhatsAppSendMessage(e) {
            e.preventDefault();
            const form = e.target;
            const phone = form.querySelector('#whatsapp-selected-number').value;
            const message = form.querySelector('#whatsapp-message-text').value.trim();
            
            if (!phone || !message) {
                showAlert('Telefon numarası ve mesaj gerekli!', 'danger');
                return;
            }
            
            // Use the selected device from the main dropdown
            if (!selectedWhatsAppDevice) {
                showAlert('Lütfen önce bir WhatsApp cihazı seçin!', 'danger');
                return;
            }
            
            const device = selectedWhatsAppDevice;
            
            // Send message
            console.log(`📤 Sending message from device: ${device.instanceName} (${device.phoneNumber})`);
            const result = await sendWhatsAppMessage(device.instanceName, phone, message, currentWhatsAppContact.name);
            const success = result?.success || result === true; // Handle both object and boolean return
            
            if (success) {
                const textarea = form.querySelector('#whatsapp-message-text');
                textarea.value = '';
                textarea.style.height = 'auto'; // Reset height
                showAlert(`✅ Mesaj gönderildi!`, 'success');
                
                // Reload sent messages from Firebase first
                console.log('🔄 Reloading sent messages...');
                try {
                    const messagesSnapshot = await window.firebase.getDocs(
                        window.firebase.query(
                            window.firebase.collection(window.db, 'sentMessages'),
                            window.firebase.where('clubId', '==', currentClubId),
                            window.firebase.orderBy('sentAt', 'desc')
                        )
                    );
                    sentMessages = messagesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).slice(0, 50); // Artık 50 mesaj
                    console.log(`✅ Reloaded ${sentMessages.length} sent messages`);
                } catch (e) {
                    console.warn('⚠️ Could not reload sent messages:', e);
                }
                
                // Reload messages and scroll to bottom
                setTimeout(() => {
                    loadMessagesForContact(phone);
                }, 500);
            } else {
                showAlert('❌ Mesaj gönderilemedi!', 'danger');
            }
        }
        
        let selectedBulkGroups = [];
        let currentBranchGroups = []; // Arama için mevcut grupları sakla
        
        function onBulkBranchChange() {
            const branch = document.getElementById('bulk-branch-selector').value;
            selectedBulkGroups = [];
            
            if (!branch) {
                document.getElementById('bulk-groups-container').style.display = 'none';
                document.getElementById('bulk-recipients-container').style.display = 'none';
                return;
            }
            
            // Show groups for selected branch
            const branchGroups = branch === 'all' 
                ? groups 
                : groups.filter(g => g.branch === branch);
            
            currentBranchGroups = branchGroups; // Arama için sakla
            renderBulkGroups(branchGroups);
            
            document.getElementById('bulk-groups-container').style.display = 'block';
            document.getElementById('bulk-group-search').value = ''; // Arama kutusunu temizle
            
            // Hide recipients container until groups are confirmed
            document.getElementById('bulk-recipients-container').style.display = 'none';
        }
        
        function renderBulkGroups(groupsToRender) {
            const groupsListHTML = groupsToRender.map(g => {
                const memberCount = members.filter(m => Array.isArray(g.members) && g.members.includes(m.id) && m.status === 'active').length;
                return `
                    <div class="form-check bulk-group-item" data-group-name="${g.groupName.toLowerCase()}" style="padding: 10px; border-bottom: 1px solid #eee;">
                        <input class="form-check-input bulk-group-checkbox" type="checkbox" value="${g.id}" id="bulkGroup${g.id}" onchange="updateBulkRecipients()">
                        <label class="form-check-label" for="bulkGroup${g.id}" style="cursor: pointer; width: 100%;">
                            <strong>${g.groupName}</strong> <span style="color: #666;">(${memberCount} kişi)</span>
                            <br><small style="color: #999;">${g.branch === 'tenis' ? '🎾' : '🏊'} ${g.branch}</small>
                        </label>
                    </div>
                `;
            }).join('');
            
            document.getElementById('bulk-groups-list').innerHTML = groupsListHTML || '<p class="empty-state">Bu branşta grup bulunamadı</p>';
        }
        
        window.filterBulkGroups = function() {
            const searchTerm = document.getElementById('bulk-group-search').value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderBulkGroups(currentBranchGroups);
                return;
            }
            
            const filteredGroups = currentBranchGroups.filter(g => 
                g.groupName.toLowerCase().includes(searchTerm)
            );
            
            renderBulkGroups(filteredGroups);
        };
        
        window.selectAllGroups = function() {
            document.querySelectorAll('.bulk-group-checkbox').forEach(cb => {
                cb.checked = true;
            });
        };
        
        window.deselectAllGroups = function() {
            document.querySelectorAll('.bulk-group-checkbox').forEach(cb => {
                cb.checked = false;
            });
        };
        
        window.confirmGroupSelection = function() {
            const selectedCheckboxes = document.querySelectorAll('.bulk-group-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                showAlert('Lütfen en az bir grup seçin!', 'warning');
                return;
            }
            
            selectedBulkGroups = Array.from(selectedCheckboxes).map(cb => cb.value);
            showAlert(`${selectedBulkGroups.length} grup seçildi! Şimdi kişileri seçin.`, 'success');
            loadBulkRecipients();
        };
        
        window.selectAllRecipients = function() {
            document.querySelectorAll('.bulk-recipient-checkbox').forEach(cb => {
                cb.checked = true;
            });
            updateRecipientCount();
        };
        
        window.deselectAllRecipients = function() {
            document.querySelectorAll('.bulk-recipient-checkbox').forEach(cb => {
                cb.checked = false;
            });
            updateRecipientCount();
        };
        
        window.confirmRecipientSelection = function() {
            const selectedCheckboxes = document.querySelectorAll('.bulk-recipient-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                showAlert('Lütfen en az bir kişi seçin!', 'warning');
                return;
            }
            
            const count = selectedCheckboxes.length;
            showAlert(`${count} kişi seçildi! Artık mesajınızı yazıp gönderebilirsiniz.`, 'success');
            updateFinalRecipientCount();
        };
        
        function loadBulkRecipients() {
            // Get all members from selected groups
            const recipientMembers = members.filter(m => 
                (m.status === 'active' || m.status === 'pending') &&
                (m.Telefon || m.Telefon_2) &&
                selectedBulkGroups.some(groupId => {
                    const group = groups.find(g => g.id === groupId);
                    return group && Array.isArray(group.members) && group.members.includes(m.id);
                })
            );
            
            // Build recipients list including both parent phones
            const uniqueRecipients = [];
            const seenPhones = new Set();
            
            recipientMembers.forEach(m => {
                const memberName = m.Resit_Olmayan_Adi_Soyadi || m.Ad_Soyad || 'İsimsiz';
                
                // Add first parent (Telefon)
                if (m.Telefon) {
                    const phone1 = formatPhoneForWhatsApp(m.Telefon);
                    if (!seenPhones.has(phone1)) {
                        seenPhones.add(phone1);
                        uniqueRecipients.push({
                            memberId: m.id,
                            memberName: memberName,
                            phone: phone1,
                            parentName: m.Ad_Soyad || memberName,
                            label: '1. Veli',
                            isChild: !!m.Resit_Olmayan_Adi_Soyadi
                        });
                    }
                }
                
                // Add second parent (Telefon_2)
                if (m.Telefon_2 && m.Telefon_2.trim() !== '') {
                    const phone2 = formatPhoneForWhatsApp(m.Telefon_2);
                    if (!seenPhones.has(phone2)) {
                        seenPhones.add(phone2);
                        uniqueRecipients.push({
                            memberId: m.id,
                            memberName: memberName,
                            phone: phone2,
                            parentName: m.Veli_2_Adi_Soyadi || m.Ad_Soyad || memberName,
                            label: '2. Veli',
                            isChild: !!m.Resit_Olmayan_Adi_Soyadi
                        });
                    }
                }
            });
            
            if (uniqueRecipients.length === 0) {
                document.getElementById('bulk-recipients-list').innerHTML = '<p class="empty-state">Seçilen gruplarda telefon numarası olan kişi bulunamadı</p>';
                document.getElementById('bulk-recipients-container').style.display = 'block';
                return;
            }
            
            // Show recipients list with checkboxes
            const recipientsHTML = uniqueRecipients.map((recipient, index) => {
                return `
                <div class="form-check" style="padding: 8px; border-bottom: 1px solid #f0f0f0;">
                    <input class="form-check-input bulk-recipient-checkbox" type="checkbox" value="${recipient.memberId}" data-phone="${recipient.phone}" data-name="${recipient.parentName}" id="bulkRecipient${index}" onchange="updateRecipientCount()">
                    <label class="form-check-label" for="bulkRecipient${index}" style="cursor: pointer; width: 100%;">
                        <span style="color: #666; font-size: 12px;">${index + 1}.</span>
                        <strong>${recipient.parentName}</strong>
                        ${recipient.isChild ? `<span style="color: #999; font-size: 0.85em;">(${recipient.memberName} - ${recipient.label})</span>` : ''}
                        <small style="color: #666; margin-left: 10px;">📞 ${recipient.phone}</small>
                    </label>
                    <span class="badge bg-secondary recipient-status-badge" data-index="${index}">Bekliyor</span>
                </div>
            `}).join('');
            
            document.getElementById('bulk-recipients-list').innerHTML = recipientsHTML;
            document.getElementById('bulk-recipients-container').style.display = 'block';
            document.getElementById('bulk-recipient-count-badge').textContent = uniqueRecipients.length;
            
            // Auto-select all recipients by default
            setTimeout(() => {
                selectAllRecipients();
                updateRecipientCount();
            }, 100);
        }
        
        function updateRecipientCount() {
            const selectedCount = document.querySelectorAll('.bulk-recipient-checkbox:checked').length;
            document.getElementById('bulk-recipient-count-badge').textContent = selectedCount;
        }
        
        function updateFinalRecipientCount() {
            const selectedCount = document.querySelectorAll('.bulk-recipient-checkbox:checked').length;
            document.getElementById('bulk-final-count').textContent = selectedCount;
            
            // Calculate estimated time (5-45 seconds per message, average 25 seconds)
            const avgTime = 25;
            const totalSeconds = selectedCount * avgTime;
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            document.getElementById('bulk-estimated-time').textContent = `~${minutes} dk ${seconds} sn`;
        }
        
        async function handleBulkMessageSend(e) {
            e.preventDefault();
            const form = e.target;
            const messageTemplate = document.getElementById('bulk-message-text').value.trim();
            
            if (!messageTemplate) {
                showAlert('Mesaj metni gerekli!', 'danger');
                return;
            }
            
            // Get selected recipients from checkboxes
            const selectedCheckboxes = document.querySelectorAll('.bulk-recipient-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                showAlert('Lütfen en az bir kişi seçin!', 'danger');
                return;
            }
            
            // Find connected device
            let device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
            if (!device) {
                device = whatsappDevices.find(d => d.status === 'connected');
            }
            
            if (!device) {
                showAlert('Bağlı WhatsApp cihazı bulunamadı!', 'danger');
                return;
            }
            
            // Build recipients list from selected checkboxes
            const uniqueRecipients = Array.from(selectedCheckboxes).map(cb => ({
                name: cb.dataset.name,
                phone: cb.dataset.phone,
                memberId: cb.value
            }));
            
            // Confirm
            if (!confirm(`${uniqueRecipients.length} kişiye mesaj gönderilecek. Devam edilsin mi?`)) {
                return;
            }
            
            // Show status panel
            document.getElementById('bulk-sending-status').style.display = 'block';
            document.getElementById('bulk-send-btn').disabled = true;
            document.getElementById('bulk-status-log').innerHTML = '';
            
            let successCount = 0;
            let failCount = 0;
            
            function addLog(message, type = 'info') {
                const logContainer = document.getElementById('bulk-status-log');
                const timestamp = new Date().toLocaleTimeString('tr-TR');
                const color = type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue';
                logContainer.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            addLog(`🚀 Gönderim başladı! Toplam ${uniqueRecipients.length} kişi`);
            
            // Find which checkbox index corresponds to each recipient
            const checkboxes = Array.from(selectedCheckboxes);
            
            for (let i = 0; i < uniqueRecipients.length; i++) {
                const recipient = uniqueRecipients[i];
                const checkbox = checkboxes[i];
                const checkboxIndex = Array.from(document.querySelectorAll('.bulk-recipient-checkbox')).indexOf(checkbox);
                
                // Update status badge
                const statusBadge = document.querySelector(`.recipient-status-badge[data-index="${checkboxIndex}"]`);
                if (statusBadge) {
                    statusBadge.textContent = '📤 Gönderiliyor...';
                    statusBadge.className = 'badge bg-info recipient-status-badge';
                    statusBadge.dataset.index = checkboxIndex;
                }
                
                // Personalize message
                let personalizedMessage = messageTemplate;
                const uyeName = recipient.isChild ? recipient.parentName : recipient.parentName;
                const ogrenciName = recipient.isChild ? recipient.memberName : '';
                
                personalizedMessage = personalizedMessage.replace(/{UYE_AD_SOYAD}/g, uyeName);
                personalizedMessage = personalizedMessage.replace(/{OGRENCI_AD_SOYAD}/g, ogrenciName);
                // Backward compatibility for old templates
                personalizedMessage = personalizedMessage.replace(/{VELI_AD_SOYAD}/g, recipient.parentName);
                personalizedMessage = personalizedMessage.replace(/{AD_SOYAD}/g, uyeName).replace(/{AD}/g, uyeName);
                
                addLog(`📨 ${i + 1}/${uniqueRecipients.length}: ${recipient.parentName} (${recipient.phone})`);
                
                // Send message
                const result = await sendWhatsAppMessage(device.instanceName, recipient.phone, personalizedMessage, recipient.name);
                const success = result.success || result === true; // Backward compatibility
                
                if (success) {
                    successCount++;
                    if (statusBadge) {
                        statusBadge.textContent = '✅ Gönderildi';
                        statusBadge.className = 'badge bg-success recipient-status-badge';
                        statusBadge.dataset.index = checkboxIndex;
                    }
                    addLog(`✅ Başarılı: ${recipient.name}`, 'success');
                } else {
                    failCount++;
                    const errorMsg = result.errorReason ? ` - ${result.errorReason}` : '';
                    if (statusBadge) {
                        statusBadge.textContent = '❌ Başarısız';
                        statusBadge.className = 'badge bg-danger recipient-status-badge';
                        statusBadge.dataset.index = checkboxIndex;
                        statusBadge.title = errorMsg ? result.errorReason : 'Bilinmeyen hata';
                    }
                    addLog(`❌ Başarısız: ${recipient.name}${errorMsg}`, 'error');
                }
                
                // Update progress bar
                const progress = ((i + 1) / uniqueRecipients.length) * 100;
                const progressBar = document.getElementById('bulk-progress-bar');
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${i + 1} / ${uniqueRecipients.length}`;
                
                // ✅ Random wait time (ayarlardan)
                if (i < uniqueRecipients.length - 1) {
                    const messageCount = i + 1;
                    let waitTime;
                    
                    // Her X mesajda bir uzun bekleme
                    const shouldLongWait = (messageCount % (clubSettings.longWaitTrigger || 100)) === 0;
                    
                    if (shouldLongWait) {
                        const min = clubSettings.minLongWait || 400;
                        const max = clubSettings.maxLongWait || 800;
                        waitTime = Math.floor(Math.random() * (max - min + 1)) + min;
                        addLog(`⏳ UZUN BEKLEME: Sonraki mesaj için ${waitTime} saniye bekleniyor... (Her ${clubSettings.longWaitTrigger} mesajda bir)`, 'info');
                    } else {
                        const min = clubSettings.minWaitTime || 20;
                        const max = clubSettings.maxWaitTime || 50;
                        waitTime = Math.floor(Math.random() * (max - min + 1)) + min;
                        addLog(`⏳ Sonraki mesaj için ${waitTime} saniye bekleniyor...`);
                    }
                    
                    // Show countdown
                    for (let countdown = waitTime; countdown > 0; countdown--) {
                        if (statusBadge) {
                            statusBadge.textContent = `⏳ ${countdown}s`;
                            statusBadge.className = 'badge bg-warning recipient-status-badge';
                            statusBadge.dataset.index = checkboxIndex;
                        }
                        await new Promise(resolve => setTimeout(resolve, 400));
                    }
                }
            }
            
            addLog(`🎉 Gönderim tamamlandı! Başarılı: ${successCount}, Başarısız: ${failCount}`, 'success');
            
            showAlert(`Toplu mesaj gönderimi tamamlandı! ✅ ${successCount} başarılı, ❌ ${failCount} başarısız`, 'success');
            
            document.getElementById('bulk-send-btn').disabled = false;
            
            // Reset form after 5 seconds
            setTimeout(() => {
                document.getElementById('bulk-sending-status').style.display = 'none';
            }, 5000);
        }
        
        async function fetchAndShowQR(instanceName, deviceId) {
            try {
                const response = await fetch(`${EVOLUTION_API_URL}/instance/connect/${instanceName}`, {
                    method: 'GET',
                    headers: {
                        'apikey': EVOLUTION_API_KEY
                    }
                });
                
                if (!response.ok) {
                    console.error('❌ QR kod API hatası:', response.status, response.statusText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Try different response formats
                let qrBase64 = null;
                
                if (data.qrcode && data.qrcode.base64) {
                    qrBase64 = data.qrcode.base64;
                } else if (data.base64) {
                    qrBase64 = data.base64;
                } else if (data.code) {
                    qrBase64 = data.code;
                } else if (typeof data === 'string' && data.startsWith('data:image')) {
                    qrBase64 = data;
                }
                
                if (qrBase64) {
                    showQRCodeModal(instanceName, qrBase64, deviceId);
                } else {
                    closeModal('qrCodeModal');
                    showAlert('⚠️ QR kod alınamadı. Cihaz listesinden "QR Kod" butonuna tıklayın.', 'warning');
                }
            } catch (error) {
                closeModal('qrCodeModal');
                showAlert('⚠️ QR kod yüklenemedi. Lütfen cihaz listesinden tekrar deneyin.', 'danger');
            }
        }
        
        async function showInstanceQR(instanceName) {
            const device = whatsappDevices.find(d => d.instanceName === instanceName);
            const deviceId = device ? device.id : null;
            
            showQRLoadingModal(instanceName);
            await fetchAndShowQR(instanceName, deviceId);
        }
        
        function showQRCodeModal(instanceName, base64QR, deviceId = null) {
            const modal = document.getElementById('qrCodeModal');
            if (!modal) return;
            
            const modalContent = modal.querySelector('.modal-content');
            const qrImage = document.getElementById('qrCodeImage');
            
            // Remove loading spinner if exists
            if (modalContent) {
                const loader = modalContent.querySelector('.qr-loading');
                if (loader) {
                    loader.remove();
                }
            }
            
            // Update title and show QR
            document.getElementById('qrCodeTitle').textContent = `📱 ${instanceName} - QR Kod`;
            
            if (qrImage) {
                qrImage.src = base64QR;
                qrImage.style.display = 'block';
            }
            
            // If modal not already open, open it
            if (!modal.classList.contains('active')) {
                openModal('qrCodeModal');
            }
            
            // Start polling for connection if deviceId is provided
            if (deviceId) {
                startConnectionPolling(instanceName, deviceId);
            }
        }
        
        // Poll Evolution API to check if instance is connected
        let pollingIntervals = {};
        
        async function checkConnectionStatus(instanceName, deviceId) {
            try {
                showAlert('🔍 Bağlantı durumu kontrol ediliyor...', 'info');
                
                // Try multiple endpoints to check connection
                let isConnected = false;
                
                // Method 1: Check connection state
                try {
                    const stateResponse = await fetch(`${EVOLUTION_API_URL}/instance/connectionState/${instanceName}`, {
                        method: 'GET',
                        headers: { 'apikey': EVOLUTION_API_KEY }
                    });
                    const stateData = await stateResponse.json();
                    
                    console.log('📊 Connection state response:', stateData);
                    
                    if (stateData.state === 'open' || stateData.instance?.state === 'open') {
                        isConnected = true;
                    }
                } catch (e) {
                    console.warn('⚠️ Connection state check failed:', e);
                }
                
                // Method 2: Check fetch instances
                if (!isConnected) {
                    try {
                        const instancesResponse = await fetch(`${EVOLUTION_API_URL}/instance/fetchInstances`, {
                            method: 'GET',
                            headers: { 'apikey': EVOLUTION_API_KEY }
                        });
                        const instances = await instancesResponse.json();
                        
                        console.log('📊 Fetch instances response:', instances);
                        
                        if (Array.isArray(instances)) {
                            const instance = instances.find(i => i.instanceName === instanceName);
                            if (instance && instance.state === 'open') {
                                isConnected = true;
                            }
                        }
                    } catch (e) {
                        console.warn('⚠️ Fetch instances check failed:', e);
                    }
                }
                
                if (isConnected) {
                    // ✅ Update Supabase (hem status hem isConnected)
                    await supabase
                        .from('whatsappDevices')
                        .update({
                            status: 'connected',
                            isConnected: true,
                            lastUpdated: new Date().toISOString()
                        })
                        .eq('id', deviceId);
                    
                    // Update local state
                    const deviceIndex = whatsappDevices.findIndex(d => d.id === deviceId);
                    if (deviceIndex !== -1) {
                        whatsappDevices[deviceIndex].status = 'connected';
                        whatsappDevices[deviceIndex].isConnected = true;
                        whatsappDevices[deviceIndex].lastUpdated = new Date().toISOString();
                    }
                    
                    showAlert(`✅ Cihaz "${instanceName}" bağlı ve aktif!`, 'success');
                    
                    // Listeyi yenile
                    if (typeof loadWhatsAppDevicesMain === 'function') {
                        loadWhatsAppDevicesMain();
                    }
                    
                    return true;
                } else {
                    showAlert(`⚠️ Cihaz "${instanceName}" bağlı değil. Lütfen QR kod ile tekrar bağlanın.`, 'warning');
                    return false;
                }
            } catch (error) {
                console.error('❌ Durum kontrolü hatası:', error);
                showAlert('❌ Durum kontrolü sırasında hata oluştu: ' + error.message, 'danger');
                return false;
            }
        }
        
        async function startConnectionPolling(instanceName, deviceId) {
            // Clear existing polling for this instance
            if (pollingIntervals[instanceName]) {
                clearInterval(pollingIntervals[instanceName]);
            }
            
            let attempts = 0;
            const maxAttempts = 60; // Poll for 2 minutes (60 attempts * 2 seconds)
            
            pollingIntervals[instanceName] = setInterval(async () => {
                attempts++;
                
                const isConnected = await checkConnectionStatus(instanceName, deviceId);
                
                if (isConnected) {
                    // Connection successful!
                    clearInterval(pollingIntervals[instanceName]);
                    delete pollingIntervals[instanceName];
                    
                    // Close QR modal and show success
                    closeModal('qrCodeModal');
                    showAlert('✅ WhatsApp bağlantısı başarılı! Cihaz kullanıma hazır.', 'success');
                    
                    // Reload instances
                    loadWhatsAppInstances();
                    
                } else if (attempts >= maxAttempts) {
                    // Timeout
                    clearInterval(pollingIntervals[instanceName]);
                    delete pollingIntervals[instanceName];
                    showAlert('⏱️ QR kod okutma zaman aşımına uğradı. Manuel olarak kontrol edin.', 'warning');
                }
            }, 3000); // Check every 3 seconds
        }
        
        async function restartInstance(instanceName, deviceId) {
            showConfirmModal(`${instanceName} cihazını yeniden başlatmak istediğinizden emin misiniz?`, async () => {
                closeModal('confirmModal');
                try {
                    const response = await fetch(`${EVOLUTION_API_URL}/instance/restart/${instanceName}`, {
                        method: 'PUT',
                        headers: {
                            'apikey': EVOLUTION_API_KEY
                        }
                    });
                    
                    if (response.ok) {
                        // ✅ Update status to pending in Supabase (hem status hem isConnected)
                        await supabase
                            .from('whatsappDevices')
                            .update({
                                status: 'pending',
                                isConnected: false,
                                lastUpdated: new Date().toISOString()
                            })
                            .eq('id', deviceId);
                        
                        // Update local state
                        const deviceIndex = whatsappDevices.findIndex(d => d.id === deviceId);
                        if (deviceIndex !== -1) {
                            whatsappDevices[deviceIndex].status = 'pending';
                            whatsappDevices[deviceIndex].lastUpdated = new Date().toISOString();
                        }
                        
                        showAlert('Cihaz yeniden başlatılıyor...', 'success');
                        setTimeout(() => loadWhatsAppInstances(), 800);
                    } else {
                        showAlert('Cihaz yeniden başlatılamadı.', 'danger');
                    }
                } catch (error) {
                    console.error('Restart instance error:', error);
                    showAlert('İşlem sırasında hata oluştu.', 'danger');
                }
            });
        }
        
        async function deleteInstance(instanceName, deviceId) {
            showConfirmModal(`${instanceName} cihazını kalıcı olarak silmek istediğinizden emin misiniz?`, async () => {
                closeModal('confirmModal');
                try {
                    // Delete from Evolution API
                    const response = await fetch(`${EVOLUTION_API_URL}/instance/delete/${instanceName}`, {
                        method: 'DELETE',
                        headers: {
                            'apikey': EVOLUTION_API_KEY
                        }
                    });
                    
                    const data = await response.json();
                    
                    // ✅ Delete from Supabase regardless of API response
                    await supabase
                        .from('whatsappDevices')
                        .delete()
                        .eq('id', deviceId);
                    
                    // Remove from local state
                    const deviceIndex = whatsappDevices.findIndex(d => d.id === deviceId);
                    if (deviceIndex !== -1) {
                        whatsappDevices.splice(deviceIndex, 1);
                    }
                    
                    // Stop polling if any
                    if (pollingIntervals[instanceName]) {
                        clearInterval(pollingIntervals[instanceName]);
                        delete pollingIntervals[instanceName];
                    }
                    
                    showAlert('✅ Cihaz başarıyla silindi.', 'success');
                    loadWhatsAppInstances();
                } catch (error) {
                    console.error('Delete instance error:', error);
                    showAlert('İşlem sırasında hata oluştu.', 'danger');
                }
            });
        }

        // --- HANDLER FUNCTIONS ---
        async function handleRegistration(e, initialStatus) {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            
            // Butonu devre dışı bırak (çift tıklama önleme)
            if (submitBtn) {
                if (submitBtn.disabled) return; // Zaten işlem yapılıyorsa çık
                submitBtn.disabled = true;
                submitBtn.textContent = '⏳ Kaydediliyor...';
            }
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const memberType = data.memberType;
                let parentName = data.parentName;

                if (memberType === 'child' && !parentName) {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = '📝 Kayıt Oluştur';
                    }
                    return showAlert('Çocuk kayıtları için Veli Adı Soyadı zorunludur.', 'warning');
                }
                if (memberType === 'adult') {
                    parentName = '';
                }

                // ✅ Öğrenci listesini topla
                let students = [];
                if (memberType === 'child') {
                    // Çoklu çocuk desteği
                    const studentFields = form.querySelectorAll('.student-field-group');
                    studentFields.forEach((field, index) => {
                        const studentName = formData.get(`studentName_${index}`);
                        const studentBirthDate = formData.get(`studentBirthDate_${index}`) || null; // ✅ Boş string yerine null
                        if (studentName) {
                            students.push({ studentName, studentBirthDate, index });
                        }
                    });
                    
                    if (students.length === 0) {
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = '📝 Kayıt Oluştur';
                        }
                        return showAlert('En az bir öğrenci eklemelisiniz.', 'warning');
                    }
                } else {
                    // Yetişkin için tek öğrenci
                    students.push({
                        studentName: data.studentName,
                        studentBirthDate: data.studentBirthDate || null // ✅ Boş string yerine null
                    });
                }

                const subsequentInstallments = parseInt(data.installments);
                if (isNaN(subsequentInstallments)) throw new Error("Taksit sayısı geçersiz.");
                const totalInstallments = subsequentInstallments + 1;
                
                const firstAmount = parseFloat(unformatCurrency(data.firstInstallmentAmount) || '0');
                const subsequentAmount = parseFloat(unformatCurrency(data.subsequentInstallmentAmount) || '0');

                const paymentSchedule = generatePaymentSchedule(
                    new Date(data.firstPeriodStart), new Date(data.firstPeriodEnd), new Date(data.firstDueDate),
                    totalInstallments, firstAmount, subsequentAmount,
                    parseInt(data.dueDay), parseInt(data.firstLessonCount)
                );

                if (paymentSchedule.length === 0) {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = '📝 Kayıt Oluştur';
                    }
                    return showAlert('Ödeme planı oluşturulamadı. Lütfen tarihleri ve tutarları kontrol edin.', 'warning');
                }

                const finalEndDate = paymentSchedule[paymentSchedule.length - 1].period.end;
                const isChild = memberType === 'child';

                // ✅ Her öğrenci için kayıt oluştur
                let createdCount = 0;
                for (const student of students) {
                    // ✅ ÇÖZÜM: Her öğrenci için ödeme planının bağımsız bir kopyasını oluştur
                    const independentPaymentSchedule = JSON.parse(JSON.stringify(paymentSchedule));
                    
                    const preRegData = {
                        parentName,
                        parentName2: data.parentName2 || '',
                        phone2: data.phone2 || '',
                        studentName: student.studentName,
                        studentBirthDate: student.studentBirthDate,
                        phone: data.phone,
                        branch: data.branch,
                        periodStart: data.firstPeriodStart,
                        periodEnd: finalEndDate,
                        paymentSchedule: independentPaymentSchedule,
                        status: 'pending_contract',
                        createdAt: new Date().toISOString(),
                        notes: data.notes,
                        clubId: currentClubId
                    };

                    const preRegRef = await window.firebase.addDoc(window.firebase.collection(window.db, 'preRegistrations'), preRegData);
                    
                    const memberData = {
                        Ad_Soyad: isChild ? parentName : student.studentName,
                        Veli_2_Adi_Soyadi: data.parentName2 || '',
                        Telefon_2: data.phone2 || '',
                        Resit_Olmayan_Adi_Soyadi: isChild ? student.studentName : '',
                        Telefon: data.phone,
                        Brans: data.branch,
                        studentBirthDate: student.studentBirthDate,
                        status: initialStatus,
                        registrationDate: new Date().toISOString(),
                        preRegistrationId: preRegRef.id,
                        clubId: currentClubId
                    };
                    
                    let memberIdToAssign = null;
                    const existingMember = members.find(m => m.Telefon === data.phone && (m.Resit_Olmayan_Adi_Soyadi || m.Ad_Soyad) === student.studentName);

                    if(!existingMember) {
                        const memberRef = await window.firebase.addDoc(window.firebase.collection(window.db, 'members'), memberData);
                        memberIdToAssign = memberRef.id;
                    } else {
                        memberIdToAssign = existingMember.id;
                        const { preRegistrationId, ...memberDataWithoutPreRegId } = memberData;
                        await window.firebase.updateDoc(window.firebase.doc(window.db, 'members', existingMember.id), memberDataWithoutPreRegId);
                    }

                    if(data.groupId && memberIdToAssign) {
                         await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', data.groupId), {
                             members: window.firebase.arrayUnion(memberIdToAssign)
                        });
                    }
                    
                    createdCount++;
                }
                
                showAlert(`✅ ${createdCount} öğrenci için kayıt başarılı! "Bekleyen Kayıtlar" listesine eklendi.`, 'success');
                form.reset();
                toggleParentStudentFields(form);
                previewPaymentPlan(form);
                await loadData();
            } catch (error) { 
                console.error(error); 
                showAlert(`Kayıt oluşturulurken hata oluştu: ${error.message}`, 'danger'); 
            } finally {
                // Butonu tekrar aktif et
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '📝 Kayıt Oluştur';
                }
            }
        }

        function recalculateSubsequentPayments(schedule, startIndex) {
            for (let i = startIndex + 1; i < schedule.length; i++) {
                const prevPayment = schedule[i - 1];
                const currentPayment = schedule[i];

                let newStartDate = new Date(prevPayment.period.end);
                newStartDate.setDate(newStartDate.getDate() + 1);
                currentPayment.period.start = newStartDate.toISOString().split('T')[0];

                let newEndDate = new Date(newStartDate);
                newEndDate.setDate(newEndDate.getDate() + 27); 
                currentPayment.period.end = newEndDate.toISOString().split('T')[0];
                
                let newDueDate = new Date(prevPayment.dueDate + 'T12:00:00');
                newDueDate.setMonth(newDueDate.getMonth() + 1);
                currentPayment.dueDate = newDueDate.toISOString().split('T')[0];
            }
            return schedule;
        }

        async function handlePayment(e) {
            e.preventDefault();
            const form = e.target;
            const preRegId = form.paymentPreRegId.value;
            const paymentNumber = parseInt(form.paymentNumber.value);
            const isNewPayment = form.dataset.mode === 'new';
            
            try {
                const preReg = preRegistrations.find(p => p.id === preRegId);
                if (!preReg || !preReg.paymentSchedule) throw new Error("Ödeme planı bulunamadı.");
                
                let updatedSchedule = [...preReg.paymentSchedule];
                let totalPaymentsToAdd = 1; // ✅ Declare outside if block to avoid scope issue

                if (isNewPayment) {
                    // ✅ Kaç ay daha aidat eklenecek?
                    const additionalMonths = parseInt(form.additionalMonths.value) || 0;
                    totalPaymentsToAdd = additionalMonths + 1; // Bu ay + ek aylar
                    
                    const baseAmount = parseFloat(unformatCurrency(form.paymentAmount.value) || '0');
                    const basePeriodStart = new Date(form.periodStart.value);
                    const basePeriodEnd = new Date(form.periodEnd.value);
                    const baseDueDate = new Date(form.paymentDueDate.value);
                    const baseLessonCount = parseInt(form.lessonCount.value) || 8;
                    
                    // ✅ Birden fazla aidat oluştur
                    for (let i = 0; i < totalPaymentsToAdd; i++) {
                        let periodStart, periodEnd, dueDate;
                        
                        if (i === 0) {
                            // İlk aidat - formdan gelen değerler
                            periodStart = new Date(basePeriodStart);
                            periodEnd = new Date(basePeriodEnd);
                            dueDate = new Date(baseDueDate);
                        } else {
                            // Sonraki aidatlar - otomatik hesaplama
                            const prevPayment = updatedSchedule[updatedSchedule.length - 1];
                            periodStart = new Date(prevPayment.period.end);
                            periodStart.setDate(periodStart.getDate() + 1);
                            
                            periodEnd = new Date(periodStart);
                            periodEnd.setDate(periodEnd.getDate() + 27); // ~4 hafta
                            
                            dueDate = new Date(baseDueDate);
                            dueDate.setMonth(dueDate.getMonth() + i);
                        }
                        
                        const newPayment = {
                            paymentNumber: updatedSchedule.length + 1,
                            amount: baseAmount,
                            dueDate: dueDate.toISOString().split('T')[0],
                            status: form.paymentStatus.value,
                            note: i === 0 ? form.paymentNote.value : `Otomatik oluşturuldu (${i + 1}/${totalPaymentsToAdd})`,
                            method: form.paymentMethod.value,
                            paymentDate: form.paymentDate.value || null,
                            period: {
                                start: periodStart.toISOString().split('T')[0],
                                end: periodEnd.toISOString().split('T')[0],
                                lessonCount: baseLessonCount
                            }
                        };
                        updatedSchedule.push(newPayment);
                    }
                    
                    updatedSchedule.sort((a,b) => new Date(a.period.start) - new Date(b.period.start));
                    
                    // Ödeme numaralarını yeniden düzenle
                    updatedSchedule.forEach((p, idx) => {
                        p.paymentNumber = idx + 1;
                    });
                } else {
                    const paymentIndex = updatedSchedule.findIndex(p => p.paymentNumber === paymentNumber);
                    if (paymentIndex === -1) throw new Error("Düzenlenecek ödeme bulunamadı.");

                    const originalPayment = updatedSchedule[paymentIndex];
                    const updatedPaymentData = { ...originalPayment };
                    updatedPaymentData.amount = parseFloat(unformatCurrency(form.paymentAmount.value) || '0');
                    updatedPaymentData.dueDate = form.paymentDueDate.value;
                    updatedPaymentData.status = form.paymentStatus.value;
                    updatedPaymentData.note = form.paymentNote.value;
                    if (form.paymentDate.value) updatedPaymentData.paymentDate = form.paymentDate.value;
                    if (form.paymentMethod.value) updatedPaymentData.method = form.paymentMethod.value;
                     // Update period info only if the fields exist in the form
                    if(form.periodStart && form.periodEnd && form.lessonCount){
                        updatedPaymentData.period = {
                            start: form.periodStart.value,
                            end: form.periodEnd.value,
                            lessonCount: parseInt(form.lessonCount.value) || 0
                        };
                    }


                    updatedSchedule[paymentIndex] = updatedPaymentData;

                    // Recalculate subsequent payments
                    updatedSchedule = recalculateSubsequentPayments(updatedSchedule, paymentIndex);
                }

                // Renumber payments to ensure they are sequential
                updatedSchedule.forEach((p, index) => {
                    p.paymentNumber = index + 1;
                });

                await window.firebase.updateDoc(window.firebase.doc(window.db, 'preRegistrations', preRegId), { paymentSchedule: updatedSchedule });
                
                closeModal('paymentModal');
                
                // ✅ Kaç tane ödeme eklendiğini göster
                const successMessage = isNewPayment 
                    ? (totalPaymentsToAdd > 1 ? `${totalPaymentsToAdd} aidat başarıyla eklendi` : 'Ödeme başarıyla eklendi')
                    : 'Ödeme başarıyla güncellendi';
                showAlert(successMessage, 'success');
                
                await loadData();
                
                // ✅ İstatistikleri ve listeyi güncelle (gecikmiş ödemeler için)
                if (typeof updatePaymentStats === 'function') {
                    updatePaymentStats();
                }
                if (typeof renderPaymentsList === 'function' && currentSection === 'payments') {
                    renderPaymentsList();
                }
                
                viewPaymentPlan(preRegId); 

            } catch (error) { 
                console.error("Payment update error:", error);
                showAlert(`Ödeme ${isNewPayment ? 'eklenirken' : 'güncellenirken'} hata oluştu: ${error.message}`, 'danger'); 
            }
        }


        async function handleNewSchedule(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const selectedDays = formData.getAll('days');

            if (selectedDays.length === 0) {
                return showAlert('Lütfen en az bir ders günü seçin.', 'warning');
            }

            const group = groups.find(g => g.id === data.groupId);
            if (!group) return showAlert('Geçersiz grup.', 'danger');
            
            try {
                const schedulePromises = selectedDays.map(day => {
                    const scheduleData = {
                        groupId: data.groupId, 
                        day: day, 
                        startTime: data.startTime, 
                        endTime: data.endTime,
                        branch: group.branch,
                        court: data.court || null, // ✅ Saha bilgisi
                        clubId: currentClubId
                    };
                    return window.firebase.addDoc(window.firebase.collection(window.db, 'schedules'), scheduleData);
                });

                await Promise.all(schedulePromises);
                showAlert(`${selectedDays.length} ders başarıyla oluşturuldu`, 'success');
                closeModal('scheduleModal');
                await loadData();
            } catch (error) { 
                console.error('Error creating schedules:', error);
                showAlert('Dersler oluşturulurken hata oluştu', 'danger'); 
            }
        }

        async function handleGroup(e) {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());
            const groupId = data.groupId;
            delete data.groupId;

            try {
                if(groupId){
                     await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', groupId), data);
                     showAlert('Grup başarıyla güncellendi', 'success');
                } else {
                    await window.firebase.addDoc(window.firebase.collection(window.db, 'groups'), { 
                        ...data, 
                        members: [], 
                        createdAt: new Date().toISOString(),
                        clubId: currentClubId // ✅ Kulüp ID'si eklendi
                    });
                    showAlert('Grup başarıyla oluşturuldu', 'success');
                }
                closeModal('groupModal');
                form.reset();
                await loadData();
            } catch (error) { showAlert('Grup kaydedilirken hata oluştu', 'danger'); }
        }

        async function handleMemberUpdate(e) {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());
            const memberId = data.memberId;
            
            if (!memberId) {
                showAlert('❌ Üye ID bulunamadı!', 'danger');
                return;
            }
            
            delete data.memberId;
            
            // ✅ Doğum tarihini hem studentBirthDate hem DogumTarihi olarak kaydet
            if (data.studentBirthDate && data.studentBirthDate !== '') {
                data.DogumTarihi = data.studentBirthDate;
            }
            
            // ✅ Boş değerleri null olarak işaretle (silme yerine)
            Object.keys(data).forEach(key => {
                if (data[key] === '' && key !== 'Resit_Olmayan_Adi_Soyadi' && key !== 'Veli_2_Adi_Soyadi' && key !== 'Telefon_2' && key !== 'studentBirthDate' && key !== 'Brans') {
                    // Zorunlu alanlar boş olamaz
                    if (key === 'Ad_Soyad' || key === 'Telefon') {
                        // Bu alanlar form validation ile zaten kontrol ediliyor
                    } else {
                        delete data[key];
                    }
                } else if (data[key] === '') {
                    // Opsiyonel alanları temizle
                    delete data[key];
                }
            });

            console.log('Updating member:', memberId, 'with data:', data);

            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'members', memberId), data);
                showAlert('✅ Üye bilgileri başarıyla güncellendi!', 'success');
                closeModal('memberEditModal');
                await loadData();
                
                // ✅ Eğer member detail modalı açıksa onu kapat
                const memberDetailModal = document.getElementById('memberDetailModal');
                if (memberDetailModal) {
                    closeMemberDetail();
                }
                
                // ✅ Üyeler tablosunu güncelle
                if (typeof renderMembersTable === 'function') {
                    renderMembersTable();
                }
            } catch (error) {
                console.error('Member update error:', error);
                showAlert('❌ Üye bilgileri güncellenirken hata oluştu: ' + error.message, 'danger');
            }
        }

        async function handlePreRegUpdate(e) {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());
            const preRegId = data.preRegId;
            const newGroupId = data.groupId;
            delete data.preRegId;
            delete data.groupId;
            delete data.groupSearch; // remove search text from data
            
            console.log('PreReg Update - Form Data:', { preRegId, newGroupId, data });
            
            const member = members.find(m => m.preRegistrationId === preRegId);
            console.log('PreReg Update - Found member:', member);
            
            // If it's an adult registration, ensure parentName is cleared
            if(member && !member.Resit_Olmayan_Adi_Soyadi) {
                 data.parentName = '';
            }

            try {
                // Update pre-registration text fields
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'preRegistrations', preRegId), data);

                // Handle group change - only if member exists and newGroupId is provided
                if (member && newGroupId && newGroupId.trim() !== '') {
                    console.log('PreReg Update - Adding member to group:', { memberId: member.id, groupId: newGroupId });
                    
                    // Find current groups this member is in
                    const currentGroups = groups.filter(g => Array.isArray(g.members) && g.members.includes(member.id));
                    console.log('PreReg Update - Current groups:', currentGroups.map(g => g.id));
                    
                    // Remove from old groups (except the new one)
                    for (const oldGroup of currentGroups) {
                        if (oldGroup.id !== newGroupId) {
                            console.log('PreReg Update - Removing from old group:', oldGroup.id);
                            await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', oldGroup.id), {
                                members: window.firebase.arrayRemove(member.id)
                            });
                        }
                    }
                    
                    // Add to new group
                    await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', newGroupId), {
                        members: window.firebase.arrayUnion(member.id)
                    });
                    console.log('PreReg Update - Successfully added to group');
                } else {
                    console.log('PreReg Update - Skipping group update:', { 
                        hasMember: !!member, 
                        hasGroupId: !!newGroupId,
                        groupIdValue: newGroupId 
                    });
                }

                showAlert('Ön kayıt bilgileri güncellendi.', 'success');
                closeModal('preRegEditModal');
                await loadData();
            } catch (error) {
                console.error("Pre-registration update error:", error);
                showAlert('Ön kayıt güncellenirken bir hata oluştu.', 'danger');
            }
        }
        
        async function handleAttendanceSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const groupId = formData.get('groupId');
            const presentMemberIds = formData.getAll('presentMembers');
            const attendanceDate = formData.get('attendanceDate'); // NEW: Get date from form
            if (!attendanceDate) {
                return showAlert('Lütfen yoklama tarihini seçin.', 'warning');
            }
            
            const group = groups.find(g => g.id === groupId);
            if(!group) return showAlert('Grup bulunamadı', 'danger');

            const groupMembers = members.filter(m => Array.isArray(group.members) && group.members.includes(m.id) && m.status === 'active');
            
            // ✅ Yoklama tarihinin en az bir üyenin dönemi içinde olup olmadığını kontrol et
            let dateIsValidForAnyMember = false;
            const membersOutsidePeriod = [];
            
            for (const member of groupMembers) {
                const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                
                if (!preReg || !preReg.paymentSchedule || preReg.paymentSchedule.length === 0) {
                    // Dönem tanımlı değilse geç
                    dateIsValidForAnyMember = true;
                    continue;
                }
                
                // Tarihin bu üyenin herhangi bir dönemine girip girmediğini kontrol et
                const attendanceDateObj = new Date(attendanceDate);
                attendanceDateObj.setHours(0, 0, 0, 0);
                
                const isInAnyPeriod = preReg.paymentSchedule.some(period => {
                    const periodStart = new Date(period.period.start);
                    const periodEnd = new Date(period.period.end);
                    periodStart.setHours(0, 0, 0, 0);
                    periodEnd.setHours(23, 59, 59, 999);
                    
                    return attendanceDateObj >= periodStart && attendanceDateObj <= periodEnd;
                });
                
                if (isInAnyPeriod) {
                    dateIsValidForAnyMember = true;
                } else {
                    membersOutsidePeriod.push(member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad);
                }
            }
            
            // ⚠️ Eğer tarih hiçbir üyenin dönemine girmiyorsa uyarı ver
            if (!dateIsValidForAnyMember && membersOutsidePeriod.length > 0) {
                const formattedDate = new Date(attendanceDate).toLocaleDateString('tr-TR', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                return showAlert(
                    `⚠️ ${formattedDate} tarihinde bu gruptaki üyelerin dersi bulunmamaktadır.\n\n` +
                    `Lütfen dönem içindeki bir tarih seçin veya üyelerin ödeme planını kontrol edin.`,
                    'warning'
                );
            }
            
            // ⚠️ Bazı üyeler için dönem dışı ise uyar (ama devam et)
            if (membersOutsidePeriod.length > 0 && dateIsValidForAnyMember) {
                const formattedDate = new Date(attendanceDate).toLocaleDateString('tr-TR', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                const confirm = await showConfirm(
                    `${formattedDate} tarihinde aşağıdaki üyelerin dersi bulunmamaktadır:\n\n` +
                    `${membersOutsidePeriod.join('\n')}\n\n` +
                    `Bu üyeler için yoklama kaydedilse bile dönem görünümünde gösterilmeyecektir.\n\n` +
                    `Devam etmek istiyor musunuz?`,
                    '⚠️ DİKKAT - Dönem Dışı Yoklama'
                );
                if (!confirm) return;
            }
            
            // Array to store all attendance records
            const records = [];

            for (const member of groupMembers) {
                const isPresent = presentMemberIds.includes(member.id);
                const status = isPresent ? 'present' : 'absent';
                const reason = formData.get(`reason_${member.id}`) || '';

                // Check for existing record
                const { data: existingRecords } = await supabase
                    .from('attendanceRecords')
                    .select('id')
                    .eq('memberId', member.id)
                    .eq('groupId', groupId)
                    .eq('date', attendanceDate)
                    .eq('clubId', currentClubId);

                const record = {
                    memberId: member.id,
                    groupId: groupId,
                    date: attendanceDate,
                    status: status,
                    reason: reason,
                    recordedBy: currentUser.fullName || currentUser.username,
                    clubId: currentClubId
                };

                // If existing record found, add its ID for upsert
                if (existingRecords && existingRecords.length > 0) {
                    record.id = existingRecords[0].id;
                }

                records.push(record);
            }

            try {
                // Save records one by one (update if exists, insert if new)
                for (const record of records) {
                    if (record.id) {
                        // Update existing record
                        const { error } = await supabase
                            .from('attendanceRecords')
                            .update({
                                memberId: record.memberId,
                                groupId: record.groupId,
                                date: record.date,
                                status: record.status,
                                reason: record.reason,
                                recordedBy: record.recordedBy,
                                clubId: record.clubId
                            })
                            .eq('id', record.id);
                        if (error) {
                            console.error('Yoklama güncelleme hatası:', error);
                            throw error;
                        }
                    } else {
                        // Insert new record (only specific fields) - Generate UUID for id
                        const newId = generateId(); // Generate unique ID
                        const { error } = await supabase
                            .from('attendanceRecords')
                            .insert({
                                id: newId,
                                memberId: record.memberId,
                                groupId: record.groupId,
                                date: record.date,
                                status: record.status,
                                reason: record.reason,
                                recordedBy: record.recordedBy,
                                clubId: record.clubId
                            });
                        if (error) {
                            console.error('Yoklama ekleme hatası:', error);
                            throw error;
                        }
                    }
                }
                
                // Devamsızlık mesajları gönder (sebep belirtilmemiş olanlar için)
                const absenceMessagesToSend = [];
                for (const member of groupMembers) {
                    const isPresent = presentMemberIds.includes(member.id);
                    const reason = formData.get(`reason_${member.id}`) || '';
                    
                    // Eğer devamsız ve sebep boşsa mesaj gönder
                    if (!isPresent && !reason) {
                        absenceMessagesToSend.push({
                            member: member,
                            date: attendanceDate,
                            groupName: group.groupName
                        });
                    }
                }
                
                // Mesajları arka planda gönder (await etmeden)
                if (absenceMessagesToSend.length > 0) {
                    console.log(`📧 ${absenceMessagesToSend.length} devamsızlık mesajı gönderiliyor...`);
                    sendAbsenceNotifications(absenceMessagesToSend).catch(err => {
                        console.error('Devamsızlık mesajları gönderilirken hata:', err);
                    });
                }
                
                showAlert(`${group.groupName} için yoklama kaydedildi.${absenceMessagesToSend.length > 0 ? ` (${absenceMessagesToSend.length} devamsızlık mesajı gönderiliyor)` : ''}`, 'success');
                closeModal('attendanceModal');
                await loadData();
            } catch(error) {
                console.error("Attendance save error:", error);
                showAlert('Yoklama kaydedilirken bir hata oluştu.', 'danger');
            }
        }
        
        async function handleSettingsUpdate(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const off_days = formData.getAll('holidays');
            const newClubName = formData.get('clubName');
            
            // Bulutfon ayarları
            const bulutfonEnabled = document.getElementById('bulutfonEnabled')?.checked || false;
            const bulutfonApiKey = document.getElementById('bulutfonApiKey')?.value || '';

            // ✅ Webhook ayarları
            const webhookEnabled = document.getElementById('webhookEnabled')?.checked || false;
            const webhookUrl = document.getElementById('webhookUrl')?.value || '';

            try {
                // ✅ SUPABASE: Haftalık tatil günlerini kaydet
                const { error: holidaysError } = await supabase
                    .from('settings')
                    .upsert({
                        id: `holidays_${currentClubId}`,
                        clubId: currentClubId,
                        data: { off_days: off_days }
                    });
                
                if (holidaysError) {
                    console.error('❌ Tatil günleri kaydedilirken hata:', holidaysError);
                    throw holidaysError;
                }
                
                console.log('✅ Tatil günleri Supabase\'e kaydedildi:', off_days);
                
                // ✅ Ayarları Supabase'e kaydet (club settings)
                const updatedSettings = {
                    clubName: newClubName || clubSettings.clubName,
                    bulutfonEnabled: bulutfonEnabled,
                    bulutfonApiKey: bulutfonApiKey,
                    updatedAt: new Date().toISOString()
                };
                
                // ✅ Supabase'e kaydet
                const { error: settingsError } = await supabase
                    .from('settings')
                    .upsert({
                        id: `club_${currentClubId}`,
                        clubId: currentClubId,
                        data: updatedSettings,
                        updatedAt: new Date().toISOString()
                    });
                
                if (settingsError) {
                    console.error('❌ Ayarlar kaydedilemedi:', settingsError);
                    throw settingsError;
                }
                
                console.log('✅ Bulutfon ayarları Supabase\'e kaydedildi:', updatedSettings);
                
                // ✅ Webhook ayarlarını Firebase'e kaydet (webhook sistemi henüz Supabase'e taşınmadı)
                const webhookData = {
                    active: webhookEnabled,
                    url: webhookUrl,
                    eventType: 'contract_signed',
                    clubId: currentClubId,
                    updatedAt: new Date().toISOString()
                };
                
                await window.firebase.setDoc(
                    window.firebase.doc(window.db, 'webhooks', `contract_${currentClubId}`),
                    webhookData,
                    { merge: true }
                );
                
                // ✅ Local state güncelle (clubSettings tüm ayarları içerir)
                clubSettings = { ...clubSettings, ...updatedSettings };
                console.log('✅ Local clubSettings güncellendi:', clubSettings);
                
                showAlert('✅ Ayarlar başarıyla güncellendi.', 'success');
                
                // ✅ Sayfayı yenilemeden ayarları tekrar yükle
                await loadWhatsAppSettings();
            } catch (error) {
                console.error("❌ Ayarlar güncellenirken hata:", error);
                showAlert('Ayarlar güncellenirken bir hata oluştu.', 'danger');
            }
        }
        
        // ✅ WhatsApp Mesaj Gönderim Ayarlarını Kaydet
        window.saveWhatsAppSettings = async function() {
            try {
                // Çalışma saatleri ayarları
                const workingHoursEnabled = document.getElementById('workingHoursEnabled').checked;
                const workingDays = [];
                for (let i = 0; i <= 6; i++) {
                    const checkbox = document.getElementById(`workDay-${i}`);
                    if (checkbox && checkbox.checked) {
                        workingDays.push(i);
                    }
                }
                
                // ✅ Ana WhatsApp Hattı
                const defaultDeviceSelect = document.getElementById('default-whatsapp-device');
                const selectedDefaultDevice = defaultDeviceSelect ? defaultDeviceSelect.value : null;
                
                const settings = {
                    minWaitTime: parseInt(document.getElementById('minWaitTime').value) || 20,
                    maxWaitTime: parseInt(document.getElementById('maxWaitTime').value) || 50,
                    longWaitTrigger: parseInt(document.getElementById('longWaitTrigger').value) || 100,
                    minLongWait: parseInt(document.getElementById('minLongWait').value) || 400,
                    maxLongWait: parseInt(document.getElementById('maxLongWait').value) || 800,
                    workingHoursEnabled: workingHoursEnabled,
                    workingHoursStart: document.getElementById('workingHoursStart').value || '09:00',
                    workingHoursEnd: document.getElementById('workingHoursEnd').value || '18:00',
                    workingDays: workingDays,
                    defaultWhatsAppDevice: selectedDefaultDevice // ✅ Ana WhatsApp hattı kaydet
                };
                
                console.log('💾 WhatsApp ayarları kaydediliyor (Supabase):', settings);
                
                // ✅ SUPABASE: settings tablosuna kaydet
                const { data, error } = await supabase
                    .from('settings')
                    .upsert({
                        id: `club_${currentClubId}`,
                        clubId: currentClubId,
                        data: settings,
                        updatedAt: new Date().toISOString()
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                // ✅ Local state güncelle
                clubSettings = { ...clubSettings, ...settings };
                defaultWhatsAppDevice = selectedDefaultDevice; // ✅ Global değişkeni güncelle
                
                console.log('✅ WhatsApp ayarları başarıyla kaydedildi:', data);
                
                // ✅ Dropdown'ları güncelle
                updateDefaultDeviceDropdown();
                updateActiveDeviceDropdown();
                
                // ✅ Toplu Mesaj özetini güncelle
                updateBulkMessageSettings();
                
                showAlert('✅ WhatsApp ayarları başarıyla güncellendi.', 'success');
            } catch (error) {
                console.error("Error updating WhatsApp settings:", error);
                showAlert('Ayarlar güncellenirken bir hata oluştu: ' + error.message, 'danger');
            }
        };
        
        // Çalışma saatleri toggle
        window.toggleWorkingHoursFields = function() {
            const enabled = document.getElementById('workingHoursEnabled').checked;
            document.getElementById('workingHoursFields').style.display = enabled ? 'block' : 'none';
        };
        
        // Bulutfon toggle
        window.toggleBulutfonFields = function() {
            const enabled = document.getElementById('bulutfonEnabled').checked;
            const settingsDiv = document.getElementById('bulutfon-api-settings');
            if (settingsDiv) {
                settingsDiv.style.display = enabled ? 'block' : 'none';
            }
        };
        
        // Bulutfon ayarlarını kaydet
        window.saveBulutfonSettings = async function() {
            try {
                const enabled = document.getElementById('bulutfonEnabled').checked;
                const apiKey = document.getElementById('bulutfonApiKey').value;
                
                if (enabled && !apiKey) {
                    showAlert('⚠️ Lütfen Bulutfon API Key\'ini girin.', 'warning');
                    return;
                }
                
                const settings = {
                    bulutfonEnabled: enabled,
                    bulutfonApiKey: apiKey,
                    updatedAt: new Date().toISOString()
                };
                
                console.log('💾 Bulutfon ayarları kaydediliyor:', settings);
                
                // ✅ Supabase'e kaydet
                const { error } = await supabase
                    .from('settings')
                    .upsert({
                        id: `club_${currentClubId}`,
                        clubId: currentClubId,
                        data: { ...clubSettings, ...settings },
                        updatedAt: new Date().toISOString()
                    });
                
                if (error) {
                    console.error('❌ Bulutfon ayarları kaydedilemedi:', error);
                    throw error;
                }
                
                // ✅ Local state güncelle
                clubSettings = { ...clubSettings, ...settings };
                console.log('✅ Bulutfon ayarları Supabase\'e kaydedildi ve local state güncellendi:', clubSettings);
                
                showAlert('✅ Bulutfon ayarları başarıyla kaydedildi.', 'success');
            } catch (error) {
                console.error("❌ Bulutfon ayarları kaydedilirken hata:", error);
                showAlert('Bulutfon ayarları kaydedilirken bir hata oluştu.', 'danger');
            }
        };
        
        // Bulutfon API bağlantısını test et
        window.testBulutfonConnection = async function() {
            const apiKey = document.getElementById('bulutfonApiKey').value;
            const resultDiv = document.getElementById('bulutfonTestResult');
            
            if (!apiKey) {
                showAlert('⚠️ Lütfen önce API Key\'i girin.', 'warning');
                return;
            }
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><span>API bağlantısı test ediliyor...</span></div>';
            
            try {
                console.log('🔍 Bulutfon API testi başlatılıyor...');
                
                // Firebase Functions proxy üzerinden çağır (CORS sorunu çözümü)
                // API key query parameter olarak gönderiliyor
                const response = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${apiKey}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('📡 API Response Status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    
                    let errorDetail = '';
                    if (response.status === 401 || response.status === 403) {
                        errorDetail = 'API Key geçersiz veya yetkilendirme hatası.';
                    } else if (response.status === 500) {
                        errorDetail = 'Bulutfon sunucu hatası. Hesabınızda CDR (Arama Kayıtları) yetkisi olmayabilir.';
                    } else {
                        errorDetail = response.statusText;
                    }
                    
                    throw new Error(`API Hatası ${response.status}: ${errorDetail}`);
                }
                
                const data = await response.json();
                console.log('✅ API Response Data:', data);
                console.log('📊 Data Keys:', Object.keys(data));
                console.log('📦 Full Response:', JSON.stringify(data, null, 2));
                
                // Bulutfon v2 API'den gelen data yapısını kontrol et
                const records = Array.isArray(data) ? data : (data.cdrs || data.data || []);
                const recordCount = records.length;
                
                resultDiv.innerHTML = `
                    <div style="padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px;">
                        <div style="color: #155724; font-weight: 600; margin-bottom: 8px;">
                            ✅ Bağlantı başarılı!
                        </div>
                        <div style="color: #155724; font-size: 13px;">
                            📊 Bulutfon API'den ${recordCount} adet görüşme kaydı alındı.<br>
                            🔗 API Key geçerli ve çalışıyor.
                        </div>
                        ${recordCount > 0 ? `
                            <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 6px; font-size: 12px;">
                                <strong>Son görüşme:</strong><br>
                                📞 ${records[0].caller || records[0].src || 'N/A'} → ${records[0].callee || records[0].dst || 'N/A'}<br>
                                📅 ${new Date(records[0].call_Time || records[0].call_date).toLocaleString('tr-TR')}<br>
                                ⏱️ ${records[0].duration ? records[0].duration + ' sn' : (records[0].billsec ? Math.floor(records[0].billsec / 60) + ':' + (records[0].billsec % 60).toString().padStart(2, '0') : '0:00')}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                showAlert('✅ Bulutfon API bağlantısı başarılı!', 'success');
            } catch (error) {
                console.error('❌ Bulutfon API test hatası:', error);
                
                resultDiv.innerHTML = `
                    <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px;">
                        <div style="color: #721c24; font-weight: 600; margin-bottom: 8px;">
                            ❌ Bağlantı başarısız!
                        </div>
                        <div style="color: #721c24; font-size: 13px;">
                            <strong>Hata:</strong> ${error.message}<br><br>
                            <strong>Kontrol listesi:</strong><br>
                            • Bulutfon panelinden aldığınız API Key'i doğru girdikten emin olun<br>
                            • API Key'in aktif olduğundan emin olun<br>
                            • Bulutfon hesabınızda <strong>CDR (Call Detail Records)</strong> yetkisinin olduğunu kontrol edin<br>
                            • İnternet bağlantınızı kontrol edin<br>
                            • Sorun devam ederse Bulutfon destek ekibiyle iletişime geçin
                        </div>
                    </div>
                `;
                
                showAlert('❌ Bulutfon API bağlantısı başarısız: ' + error.message, 'danger');
            }
        };
        
        // ============================================
        // ✅ ÇALIŞMA SAATLERİ VE Mesaj Kuyruğu
        // ============================================
        
        // Mesajı kuyruğa ekle
        async function addMessageToQueue(phone, message, deviceId, recipientName = null, sendImmediately = false) {
            try {
                // ✅ MESAI SAATLERİNDE DİREKT GÖNDER
                if (sendImmediately && isWithinWorkingHours()) {
                    console.log('🚀 Mesai saatlerinde, direkt gönderiliyor...');
                    
                    try {
                        // ✅ Parametreleri doğru sırada gönder: (instanceName, phoneNumber, message, recipientName)
                        await sendWhatsAppMessage(deviceId, phone, message, recipientName || 'Bilinmeyen');
                        console.log('✅ Mesaj direkt gönderildi:', phone);
                        return null; // Kuyruğa eklenmedi, direkt gönderildi
                    } catch (sendError) {
                        console.warn('⚠️ Direkt gönderim başarısız, kuyruğa ekleniyor:', sendError);
                        // Hata durumunda kuyruğa ekle
                    }
                }
                
                const queueItem = {
                    id: `queue_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    phone: phone,
                    message: message,
                    deviceId: deviceId,
                    clubId: currentClubId,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    scheduledFor: getNextWorkingHour(),
                    recipientName: recipientName // ✅ Alıcı adı eklendi
                };
                
                console.log('📝 Kuyruğa eklenecek mesaj:', {
                    phone,
                    recipientName,
                    deviceId,
                    clubId: currentClubId,
                    status: 'pending',
                    scheduledFor: queueItem.scheduledFor
                });
                
                // ✅ SUPABASE: messageQueue tablosuna ekle
                const { data, error } = await supabase
                    .from('messageQueue')
                    .insert([queueItem])
                    .select()
                    .single();
                
                if (error) {
                    console.error('❌ Mesaj kuyruğa eklenirken hata:', error);
                    throw error;
                }
                
                console.log('✅ Mesaj kuyruğa eklendi (Supabase):', { 
                    id: data.id,
                    clubId: currentClubId,
                    data: queueItem 
                });
                return data.id;
            } catch (error) {
                console.error('❌ Mesaj kuyruğa eklenirken hata:', error);
                throw error;
            }
        }
        
        // ✅ Mesai saatleri içinde mi kontrol et
        function isWithinWorkingHours() {
            if (!clubSettings || !clubSettings.workingHoursEnabled) {
                return true; // Mesai saatleri kapalıysa her zaman gönder
            }
            
            const now = new Date();
            const dayOfWeek = now.getDay();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            // Bugün çalışma günü mü?
            if (!clubSettings.workingDays || !clubSettings.workingDays.includes(dayOfWeek)) {
                return false;
            }
            
            // Saat aralığını kontrol et
            const [startHour, startMin] = (clubSettings.workingHoursStart || '09:00').split(':').map(Number);
            const [endHour, endMin] = (clubSettings.workingHoursEnd || '18:00').split(':').map(Number);
            
            const currentTimeInMinutes = currentHour * 60 + currentMinute;
            const startTimeInMinutes = startHour * 60 + startMin;
            const endTimeInMinutes = endHour * 60 + endMin;
            
            return currentTimeInMinutes >= startTimeInMinutes && currentTimeInMinutes <= endTimeInMinutes;
        }
        
        // Bir sonraki çalışma saatini bul
        function getNextWorkingHour() {
            if (!clubSettings || !clubSettings.workingHoursEnabled) {
                return new Date().toISOString();
            }
            
            const now = new Date();
            let checkDate = new Date(now);
            
            // Maksimum 7 gün ileri kontrol et
            for (let i = 0; i < 7; i++) {
                const dayOfWeek = checkDate.getDay();
                
                if (clubSettings.workingDays && clubSettings.workingDays.includes(dayOfWeek)) {
                    const [startHour, startMin] = (clubSettings.workingHoursStart || '09:00').split(':').map(Number);
                    checkDate.setHours(startHour, startMin, 0, 0);
                    
                    // Eğer bu saat gelecekteyse, bu saati döndür
                    if (checkDate > now) {
                        return checkDate.toISOString();
                    }
                }
                
                // Bir sonraki güne geç
                checkDate.setDate(checkDate.getDate() + 1);
                checkDate.setHours(0, 0, 0, 0);
            }
            
            return new Date().toISOString();
        }
        
        // Mesaj Kuyruğunu göster
        async function renderMessageQueue() {
            try {
                console.log('🔄 Mesaj Kuyruğu yükleniyor (Supabase)...', { clubId: currentClubId });
                
                const container = document.getElementById('messageQueueList');
                if (!container) {
                    console.error('❌ messageQueueList container bulunamadı!');
                    return;
                }
                
                container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Kuyruk yükleniyor...</span></div>';
                
                // ✅ SUPABASE: PENDING ve FAILED mesajları çek
                const { data: pendingMessages, error: pendingError } = await supabase
                    .from('messageQueue')
                    .select('*')
                    .eq('clubId', currentClubId)
                    .eq('status', 'pending')
                    .order('scheduledFor', { ascending: true });
                
                const { data: failedMessages, error: failedError } = await supabase
                    .from('messageQueue')
                    .select('*')
                    .eq('clubId', currentClubId)
                    .eq('status', 'failed')
                    .order('createdAt', { ascending: false });
                
                if (pendingError) {
                    console.error('❌ Pending mesajlar yüklenirken hata:', pendingError);
                    throw pendingError;
                }
                
                if (failedError) {
                    console.error('❌ Failed mesajlar yüklenirken hata:', failedError);
                    throw failedError;
                }
                
                console.log('📊 Kuyruk sorgusu tamamlandı (Supabase):', { 
                    pending: pendingMessages?.length || 0,
                    failed: failedMessages?.length || 0
                });
                
                let html = '';
                
                // ✅ BEKLEYEN MESAJLAR
                if (pendingMessages && pendingMessages.length > 0) {
                    html += '<h4 style="color: #f57c00; margin-bottom: 15px;">⏳ Bekleyen Mesajlar (' + pendingMessages.length + ')</h4>';
                    html += '<div style="display: grid; gap: 10px; margin-bottom: 30px;">';
                    
                    pendingMessages.slice(0, 20).forEach(message => {
                        const scheduledDate = new Date(message.scheduledFor);
                        const dateStr = scheduledDate.toLocaleString('tr-TR');
                        
                        // ✅ Eklenme tarihi (saat:dakika formatında)
                        const createdDate = new Date(message.createdAt);
                        const createdTimeStr = createdDate.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                        const createdDateStr = createdDate.toLocaleDateString('tr-TR');
                        
                        // ✅ Önce recipientName varsa onu kullan
                        let contactName = message.recipientName || 'Bilinmeyen Kişi';
                        
                        // Eğer recipientName yoksa CRM'den ara
                        if (!message.recipientName) {
                            // CRM'den isim bul (telefon numarasına göre)
                            const cleanPhone = message.phone.replace(/\D/g, ''); // Sadece rakamlar
                            
                            // Telefon numarasını normalize et (90 veya 0 prefixi kaldır)
                            const normalizePhone = (phone) => {
                                const clean = phone.replace(/\D/g, '');
                                if (clean.startsWith('90')) return clean.substring(2); // 905398585327 -> 5398585327
                                if (clean.startsWith('0')) return clean.substring(1);  // 05398585327 -> 5398585327
                                return clean; // 5398585327
                            };
                            
                            const normalizedMessagePhone = normalizePhone(cleanPhone);
                            
                            let foundContact = null;
                        
                        // Önce members'da ara
                        foundContact = members.find(m => {
                            const memberPhone = normalizePhone(m.Telefon || '');
                            return memberPhone === normalizedMessagePhone || 
                                   memberPhone.endsWith(normalizedMessagePhone) || 
                                   normalizedMessagePhone.endsWith(memberPhone);
                        });
                        
                        if (foundContact) {
                            contactName = foundContact.Ad_Soyad || foundContact.Resit_Olmayan_Adi_Soyadi || 'İsimsiz Üye';
                        } else {
                            // CRM leads'de ara
                            foundContact = crmLeads?.find(lead => {
                                const leadPhone = normalizePhone(lead.phone || '');
                                return leadPhone === normalizedMessagePhone || 
                                       leadPhone.endsWith(normalizedMessagePhone) || 
                                       normalizedMessagePhone.endsWith(leadPhone);
                            });
                            
                            if (foundContact) {
                                contactName = foundContact.name || 'İsimsiz Lead';
                            } else {
                                // preRegistrations'da ara
                                foundContact = preRegistrations.find(pr => {
                                    const prPhone = normalizePhone(pr.phone || '');
                                    return prPhone === normalizedMessagePhone || 
                                           prPhone.endsWith(normalizedMessagePhone) || 
                                           normalizedMessagePhone.endsWith(prPhone);
                                });
                                
                                if (foundContact) {
                                    contactName = foundContact.studentName || foundContact.parentName || 'İsimsiz Ön Kayıt';
                                }
                            }
                        }
                        } // ✅ if (!message.recipientName) bloğunu kapat
                        
                        // Escape HTML ve özel karakterler
                        const escapedMessage = message.message
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&quot;')
                            .replace(/'/g, '&#39;');
                        
                        const escapedContactName = contactName
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&quot;')
                            .replace(/'/g, '&#39;');
                        
                        html += `
                            <div style="padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 4px; color: #333;">
                                            👤 ${escapedContactName}
                                            <span style="font-weight: normal; color: #666; margin-left: 8px;">📞 ${message.phone}</span>
                                        </div>
                                        <div id="msg-${message.id}" onclick="makeMessageEditable('${message.id}')" style="font-size: 13px; color: #555; margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px; white-space: pre-wrap; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">${escapedMessage}</div>
                                        <div style="font-size: 11px; color: #888;">� Eklenme: ${createdDateStr} ${createdTimeStr}</div>
                                        <div style="font-size: 11px; color: #888;">�🕐 Gönderilecek: ${dateStr}</div>
                                    </div>
                                    <div style="display: flex; gap: 5px; margin-left: 10px;">
                                        <button onclick="sendMessageNow('${message.id}', '${message.phone}', \`${escapedMessage.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, '${message.deviceId || ''}', '${escapedContactName}')" class="btn btn-sm" style="background: #4CAF50; color: white;" title="Şimdi Gönder">📤</button>
                                        <button onclick="removeFromQueue('${message.id}')" class="btn btn-sm btn-danger" title="Sil">🗑️</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                // ❌ BAŞARISIZ MESAJLAR
                if (failedMessages && failedMessages.length > 0) {
                    html += '<h4 style="color: #d32f2f; margin-bottom: 15px;">❌ Başarısız Mesajlar (' + failedMessages.length + ')</h4>';
                    html += '<div style="display: grid; gap: 10px;">';
                    
                    failedMessages.slice(0, 20).forEach(message => {
                        const createdDate = new Date(message.createdAt);
                        const dateStr = createdDate.toLocaleString('tr-TR');
                        const errorMsg = message.error || 'Bilinmeyen hata';
                        
                        // ✅ Önce recipientName varsa onu kullan
                        let contactName = message.recipientName || 'Bilinmeyen Kişi';
                        
                        // Eğer recipientName yoksa CRM'den ara
                        if (!message.recipientName) {
                            // CRM'den isim bul
                            const cleanPhone = message.phone.replace(/\D/g, '');
                            
                            // Telefon numarasını normalize et
                            const normalizePhone = (phone) => {
                                const clean = phone.replace(/\D/g, '');
                                if (clean.startsWith('90')) return clean.substring(2);
                                if (clean.startsWith('0')) return clean.substring(1);
                                return clean;
                            };
                            
                            const normalizedMessagePhone = normalizePhone(cleanPhone);
                            
                            let foundContact = null;
                            
                            foundContact = members.find(m => {
                                const memberPhone = normalizePhone(m.Telefon || '');
                                return memberPhone === normalizedMessagePhone || 
                                       memberPhone.endsWith(normalizedMessagePhone) || 
                                       normalizedMessagePhone.endsWith(memberPhone);
                            });
                        
                        if (foundContact) {
                            contactName = foundContact.Ad_Soyad || foundContact.Resit_Olmayan_Adi_Soyadi || 'İsimsiz Üye';
                        } else {
                            foundContact = crmLeads?.find(lead => {
                                const leadPhone = normalizePhone(lead.phone || '');
                                return leadPhone === normalizedMessagePhone || 
                                       leadPhone.endsWith(normalizedMessagePhone) || 
                                       normalizedMessagePhone.endsWith(leadPhone);
                            });
                            
                            if (foundContact) {
                                contactName = foundContact.name || 'İsimsiz Lead';
                            } else {
                                foundContact = preRegistrations.find(pr => {
                                    const prPhone = normalizePhone(pr.phone || '');
                                    return prPhone === normalizedMessagePhone || 
                                           prPhone.endsWith(normalizedMessagePhone) || 
                                           normalizedMessagePhone.endsWith(prPhone);
                                });
                                
                                if (foundContact) {
                                    contactName = foundContact.studentName || foundContact.parentName || 'İsimsiz Ön Kayıt';
                                }
                            }
                        }
                        } // ✅ if (!message.recipientName) bloğunu kapat (başarısız mesajlar)
                        
                        // Escape HTML ve özel karakterler (başarısız mesajlar)
                        const escapedFailedMessage = message.message
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&quot;')
                            .replace(/'/g, '&#39;');
                        
                        const escapedFailedContact = contactName
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&quot;')
                            .replace(/'/g, '&#39;');
                        
                        html += `
                            <div style="padding: 12px; background: #ffebee; border-left: 4px solid #d32f2f; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 4px; color: #333;">
                                            👤 ${escapedFailedContact}
                                            <span style="font-weight: normal; color: #666; margin-left: 8px;">📞 ${message.phone}</span>
                                        </div>
                                        <div id="msg-${message.id}" onclick="makeMessageEditable('${message.id}')" style="font-size: 13px; color: #555; margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px; white-space: pre-wrap; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">${escapedFailedMessage}</div>
                                        <div style="font-size: 11px; color: #d32f2f; margin-bottom: 4px;">⚠️ Hata: ${errorMsg}</div>
                                        <div style="font-size: 11px; color: #888;">🕐 Deneme: ${dateStr}</div>
                                    </div>
                                    <div style="display: flex; gap: 5px; margin-left: 10px;">
                                        <button onclick="retryFailedMessage('${message.id}', '${message.phone}', \`${message.message.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, '${message.deviceId || ''}');" class="btn btn-sm" style="background: #4CAF50; color: white;" title="Tekrar Dene">🔄</button>
                                        <button onclick="removeFromQueue('${message.id}')" class="btn btn-sm btn-danger" title="Sil">🗑️</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                // Hiç mesaj yoksa
                if ((!pendingMessages || pendingMessages.length === 0) && (!failedMessages || failedMessages.length === 0)) {
                    html = '<p class="empty-state">Kuyrukta mesaj yok.</p>';
                }
                
                container.innerHTML = html;
                console.log('✅ Mesaj Kuyruğu başarıyla render edildi (Supabase):', {
                    pending: pendingMessages?.length || 0,
                    failed: failedMessages?.length || 0
                });
            } catch (error) {
                console.error('Mesaj kuyruğu yüklenirken hata:', error);
                const container = document.getElementById('messageQueueList');
                if (container) {
                    container.innerHTML = `<p class="empty-state" style="color: red;">❌ Hata: ${error.message}</p>`;
                }
            }
        }
        
        window.renderMessageQueue = renderMessageQueue;
        
        // Mesaj düzenle
        window.editQueueMessage = async function(queueId, currentMessage, phone, contactName) {
            const newMessage = prompt(`📝 Mesajı düzenleyin:\n\n👤 ${contactName}\n📞 ${phone}\n`, currentMessage);
            
            if (newMessage === null) return; // İptal
            
            if (!newMessage.trim()) {
                return showAlert('Mesaj boş olamaz!', 'warning');
            }
            
            try {
                const { error } = await supabase
                    .from('messageQueue')
                    .update({ message: newMessage.trim() })
                    .eq('id', queueId);
                
                if (error) throw error;
                
                showAlert('✅ Mesaj güncellendi!', 'success');
                await renderMessageQueue();
            } catch (error) {
                console.error('Mesaj güncelleme hatası:', error);
                showAlert('❌ Mesaj güncellenemedi: ' + error.message, 'danger');
            }
        };
        
        // Başarısız mesajı tekrar dene
        window.retryFailedMessage = async function(queueId, phone, message, deviceId) {
            if (!confirm('Bu mesaj tekrar gönderilsin mi?')) return;
            
            try {
                // Önce mesajı pending olarak işaretle
                const { error: updateError } = await supabase
                    .from('messageQueue')
                    .update({
                        status: 'pending',
                        error: null,
                        scheduledFor: new Date().toISOString()
                    })
                    .eq('id', queueId);
                
                if (updateError) throw updateError;
                
                showAlert('✅ Mesaj tekrar kuyruğa eklendi. 1 dakika içinde otomatik gönderilecek.', 'success');
                await renderMessageQueue();
            } catch (error) {
                console.error('Mesaj tekrar deneme hatası:', error);
                showAlert('❌ İşlem başarısız: ' + error.message, 'danger');
            }
        };
        
        // Kuyruktan mesaj sil
        
        // ✅ Mesajı hemen gönder (kuyruktan)
        window.sendMessageNow = async function(queueId, phone, message, deviceId, recipientName) {
            if (!confirm(`"${recipientName}" kişisine mesajı şimdi göndermek istediğinize emin misiniz?`)) return;
            
            try {
                console.log('📤 Mesaj hemen gönderiliyor...', { queueId, phone, deviceId, recipientName });
                
                // WhatsApp cihazını bul
                let device = null;
                if (deviceId) {
                    device = whatsappDevices.find(d => d.id === deviceId || d.instanceName === deviceId);
                }
                
                // Cihaz bulunamazsa varsayılan cihazı kullan
                if (!device && selectedWhatsAppDevice) {
                    device = selectedWhatsAppDevice;
                } else if (!device && whatsappDevices.length > 0) {
                    device = whatsappDevices[0];
                }
                
                if (!device) {
                    throw new Error('Aktif WhatsApp cihazı bulunamadı');
                }
                
                // Mesajı gönder (çalışma saatleri kontrolünü atla - manuel gönderim)
                const result = await sendWhatsAppMessage(device.instanceName, phone, message, recipientName, true);
                
                // Eğer mesaj kuyruğa eklendiyse (çalışma saatleri dışında)
                if (result.queued) {
                    // Eski kuyruk kaydını sil
                    const { error: deleteError } = await supabase
                        .from('messageQueue')
                        .delete()
                        .eq('id', queueId);
                    
                    if (deleteError) {
                        console.error('❌ Kuyruktan silme hatası:', deleteError);
                    }
                    
                    // Listeyi yenile
                    await renderMessageQueue();
                    
                    showAlert('📋 Mesaj çalışma saatleri dışında olduğu için yeniden kuyruğa eklendi.', 'info');
                    return;
                }
                
                if (result.success) {
                    // Kuyruktan sil
                    const { error: deleteError } = await supabase
                        .from('messageQueue')
                        .delete()
                        .eq('id', queueId);
                    
                    if (deleteError) {
                        console.error('❌ Kuyruktan silme hatası:', deleteError);
                    }
                    
                    // Listeyi yenile
                    await renderMessageQueue();
                    
                    showAlert('✅ Mesaj başarıyla gönderildi!', 'success');
                } else {
                    throw new Error(result.errorReason || 'Mesaj gönderilemedi');
                }
            } catch (error) {
                console.error('❌ Mesaj gönderme hatası:', error);
                showAlert('❌ Mesaj gönderirken hata: ' + error.message, 'danger');
            }
        };
        
        window.removeFromQueue = async function(queueId) {
            if (!confirm('Bu mesajı kuyruktan çıkarmak istediğinize emin misiniz?')) return;
            
            try {
                // ✅ SUPABASE: Mesajı sil
                const { error } = await supabase
                    .from('messageQueue')
                    .delete()
                    .eq('id', queueId);
                
                if (error) {
                    console.error('❌ Mesaj silinirken hata:', error);
                    throw error;
                }
                
                // Listeyi yenile (await ile bekle)
                await renderMessageQueue();
                
                // Başarı mesajı
                showAlert('✅ Mesaj kuyruktan çıkarıldı.', 'success');
            } catch (error) {
                console.error('❌ Mesaj silinirken hata:', error);
                showAlert('❌ Mesaj silinirken bir hata oluştu: ' + error.message, 'danger');
            }
        };
        
        // Mesaj kuyruk işleyicisi (her 1 dakikada çalışır)
        async function processMessageQueue() {
            try {
                // ✅ Çalışma saati kontrolü kaldırıldı - scheduledFor zamanı zaten çalışma saatleri içinde ayarlanmış olmalı
                // Böylece mesajlar zamanı geldiğinde gönderilir
                
                const messagesRef = window.firebase.collection(window.db, 'messageQueue');
                // ✅ Index hatası için sadeleştirilmiş query - orderBy kaldırıldı
                const q = window.firebase.query(
                    messagesRef,
                    window.firebase.where('clubId', '==', currentClubId),
                    window.firebase.where('status', '==', 'pending')
                );
                
                const snapshot = await window.firebase.getDocs(q);
                
                if (snapshot.empty) return;
                
                // Sadece zamanı gelmiş mesajları işle ve tarihe göre sırala (client-side)
                const now = new Date().toISOString();
                const pendingMessages = snapshot.docs
                    .filter(doc => {
                        const data = doc.data();
                        return data.scheduledFor <= now;
                    })
                    .sort((a, b) => {
                        const timeA = a.data().scheduledFor;
                        const timeB = b.data().scheduledFor;
                        return timeA.localeCompare(timeB);
                    });
                
                if (pendingMessages.length === 0) return;
                
                // İlk 5 mesajı işle
                let processedCount = 0;
                const maxToProcess = 5;
                
                for (const doc of pendingMessages) {
                    if (processedCount >= maxToProcess) break;
                    processedCount++;
                    
                    const data = doc.data();
                    
                    try {
                        // ✅ Ana WhatsApp hattını kullan
                        let deviceToUse = data.deviceId; // Kuyrukta kaydedilmiş cihaz varsa onu kullan
                        
                        console.log('📋 KUYRUK MESAJI İŞLENİYOR:');
                        console.log('  → Kuyruktaki deviceId:', deviceToUse);
                        console.log('  → Ana WhatsApp hattı:', defaultWhatsAppDevice);
                        
                        // Eğer deviceId boşsa veya o cihaz bağlı değilse, ana WhatsApp hattını kullan
                        if (!deviceToUse) {
                            const defaultDevice = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
                            if (defaultDevice) {
                                deviceToUse = defaultDevice.instanceName;
                                console.log('💼 Ana WhatsApp hattı kullanılıyor:', deviceToUse);
                            } else {
                                // Ana hat bağlı değilse, herhangi bir bağlı cihaz kullan
                                const anyConnected = whatsappDevices.find(d => d.status === 'connected');
                                if (anyConnected) {
                                    deviceToUse = anyConnected.instanceName;
                                    console.log('📱 Alternatif bağlı cihaz kullanılıyor:', deviceToUse);
                                } else {
                                    throw new Error('Bağlı WhatsApp cihazı bulunamadı');
                                }
                            }
                        } else {
                            // Belirtilen cihazın bağlı olup olmadığını kontrol et
                            const specifiedDevice = whatsappDevices.find(d => d.instanceName === deviceToUse);
                            if (!specifiedDevice || specifiedDevice.status !== 'connected') {
                                console.warn('⚠️ Belirtilen cihaz bağlı değil, ana hatta geçiliyor:', deviceToUse);
                                const defaultDevice = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
                                if (defaultDevice) {
                                    deviceToUse = defaultDevice.instanceName;
                                    console.log('💼 Ana WhatsApp hattına geçildi:', deviceToUse);
                                } else {
                                    const anyConnected = whatsappDevices.find(d => d.status === 'connected');
                                    if (anyConnected) {
                                        deviceToUse = anyConnected.instanceName;
                                        console.log('📱 Alternatif cihaza geçildi:', deviceToUse);
                                    } else {
                                        throw new Error('Bağlı WhatsApp cihazı bulunamadı');
                                    }
                                }
                            } else {
                                console.log('✅ Kuyrukta belirtilen cihaz kullanılıyor:', deviceToUse);
                            }
                        }
                        
                        console.log(`📤 Kuyruk mesajı gönderiliyor: ${data.phone} (Cihaz: ${deviceToUse})`);
                        console.log(`   → Alıcı: ${data.recipientName || 'Bilinmeyen'}`);
                        
                        // Mesajı gönder
                        const result = await sendWhatsAppMessage(deviceToUse, data.phone, data.message, data.recipientName || 'Bilinmeyen');
                        
                        // ✅ Gönderim sonucunu kontrol et
                        const isSuccess = result.success === true || result === true;
                        
                        if (isSuccess) {
                            // Durumu güncelle - BAŞARILI
                            await window.firebase.updateDoc(
                                window.firebase.doc(window.db, 'messageQueue', doc.id),
                                {
                                    status: 'sent',
                                    sentAt: new Date().toISOString(),
                                    deviceId: deviceToUse // Hangi cihazdan gönderildiğini kaydet
                                }
                            );
                            
                            console.log('✅ Kuyruktaki mesaj başarıyla gönderildi:', data.phone);
                        } else {
                            throw new Error(result.error || result.errorReason || 'Mesaj gönderilemedi');
                        }
                    } catch (error) {
                        console.error('❌ Kuyruk mesajı gönderilirken hata:', error);
                        
                        // Hata durumunu kaydet
                        await window.firebase.updateDoc(
                            window.firebase.doc(window.db, 'messageQueue', doc.id),
                            {
                                status: 'failed',
                                error: error.message,
                                failedAt: new Date().toISOString()
                            }
                        );
                    }
                }
                
                // Kuyruğu yeniden render et
                renderMessageQueue();
            } catch (error) {
                console.error('Mesaj kuyruğu işlenirken hata:', error);
            }
        }
        
        // ============================================
        // ✅ BULUTFON API ENTEGRASYONU
        // ============================================
        
        // Bulutfon API ile görüşme kayıtlarını çek
        async function fetchBulutfonCallRecords(phoneNumber) {
            if (!clubSettings || !clubSettings.bulutfonEnabled || !clubSettings.bulutfonApiKey) {
                console.log('⚠️ Bulutfon entegrasyonu aktif değil veya API key eksik');
                return [];
            }
            
            try {
                // Telefon numarasını temizle ve farklı formatları hazırla
                let cleanPhone = phoneNumber.replace(/[^\d]/g, '');
                
                // 0 ile başlıyorsa 90 yap
                if (cleanPhone.startsWith('0')) {
                    cleanPhone = '90' + cleanPhone.substring(1);
                } else if (!cleanPhone.startsWith('90') && cleanPhone.length === 10) {
                    cleanPhone = '90' + cleanPhone;
                }
                
                console.log('📞 Bulutfon API çağrısı yapılıyor...', cleanPhone);
                
                // Firebase Functions proxy üzerinden CDR listesini çek (CORS sorunu çözümü)
                // API key query parameter olarak gönderiliyor
                const response = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${clubSettings.bulutfonApiKey}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ Bulutfon API hatası:', response.status, response.statusText, errorText);
                    
                    let errorMsg = 'Bulutfon API bağlantı hatası: ';
                    if (response.status === 401 || response.status === 403) {
                        errorMsg += 'API key geçersiz veya yetkilendirme hatası. Lütfen API key\'inizi kontrol edin.';
                    } else if (response.status === 500) {
                        errorMsg += 'Bulutfon sunucu hatası. Bulutfon panelinde CDR (Arama Kayıtları) erişiminizin aktif olduğundan emin olun.';
                    } else {
                        errorMsg += `Hata kodu ${response.status}. Lütfen Bulutfon hesabınızı ve API ayarlarınızı kontrol edin.`;
                    }
                    
                    showAlert(errorMsg, 'danger');
                    return { error: errorMsg };
                }
                
                const data = await response.json();
                console.log('✅ Bulutfon API response:', data);
                
                // Bulutfon v2 API'den gelen data yapısını kontrol et
                const allRecords = Array.isArray(data) ? data : (data.cdrs || data.data || []);
                
                if (allRecords.length === 0) {
                    console.log('⚠️ Bulutfon\'dan kayıt gelmedi');
                    return [];
                }
                
                // Müşteri numarasıyla eşleşen kayıtları filtrele - phonesMatch kullan
                // Hem caller/src (kaynak) hem callee/dst (hedef) alanlarına bak
                const matchingRecords = allRecords.filter(record => {
                    const caller = record.caller || record.src || '';
                    const callee = record.callee || record.dst || '';
                    
                    // phonesMatch ile güçlü eşleştirme (boşluk, tire, +90 vs fark etmez)
                    return phonesMatch(caller, phoneNumber) || phonesMatch(callee, phoneNumber);
                });
                
                console.log(`📊 ${matchingRecords.length} adet görüşme kaydı bulundu`);
                
                // DEBUG: İlk kaydın detaylarını göster
                if (matchingRecords.length > 0) {
                    console.log('🔍 İlk kayıt detayı:', matchingRecords[0]);
                    console.log('🔍 İlk kayıtta bulunan field\'lar:', Object.keys(matchingRecords[0]));
                    console.log('🔍 call_record:', matchingRecords[0].call_record);
                    console.log('🔍 uuid:', matchingRecords[0].uuid);
                    console.log('🔍 direction:', matchingRecords[0].direction);
                    console.log('🔍 hangup_state:', matchingRecords[0].hangup_state);
                    console.log('🔍 hangup_cause:', matchingRecords[0].hangup_cause, '(ANSWERED=cevaplanan)');
                    console.log('🔍 is_missing_call:', matchingRecords[0].is_missing_call, `(type: ${typeof matchingRecords[0].is_missing_call}, true=cevapsız, false=cevaplanan)`);
                    console.log('🔍 answer_time:', matchingRecords[0].answer_time);
                }
                
                return matchingRecords;
            } catch (error) {
                console.error('❌ Bulutfon görüşme kayıtları alınırken hata:', error);
                showAlert('Bulutfon görüşme kayıtları alınırken hata oluştu: ' + error.message, 'danger');
                return [];
            }
        }
        
        // Görüşme kayıtlarını göster
        async function renderCallRecords(phoneNumber, containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error('❌ Container bulunamadı:', containerId);
                return;
            }
            
            console.log('📞 Görüşme kayıtları yükleniyor:', phoneNumber);
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Görüşme kayıtları yükleniyor...</span></div>';
            
            // Bulutfon aktif değilse bilgi göster
            if (!clubSettings || !clubSettings.bulutfonEnabled) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; background: #f5f5f5; border-radius: 8px;">
                        <p style="color: #666; margin-bottom: 10px;">📞 Bulutfon entegrasyonu aktif değil</p>
                        <p style="color: #999; font-size: 12px;">Görüşme kayıtlarını görmek için WhatsApp > Ayarlar > Bulutfon API Entegrasyonu bölümünden aktif edin.</p>
                    </div>
                `;
                return;
            }
            
            const records = await fetchBulutfonCallRecords(phoneNumber);
            
            // Hata durumunu kontrol et
            if (records && records.error) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; background: #ffebee; border-radius: 8px; border-left: 4px solid #f44336;">
                        <p style="color: #c62828; margin-bottom: 10px; font-weight: 600;">❌ Bulutfon API Bağlantı Hatası</p>
                        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">${records.error}</p>
                        <div style="background: white; padding: 15px; border-radius: 6px; margin-top: 15px; text-align: left;">
                            <p style="font-weight: 600; color: #333; margin-bottom: 10px;">🔧 Çözüm Önerileri:</p>
                            <ul style="margin: 0; padding-left: 20px; color: #666; font-size: 12px;">
                                <li>Bulutfon panelinden aldığınız API key'i doğru girdiğinizden emin olun</li>
                                <li>Bulutfon hesabınızda <strong>CDR (Call Detail Records - Arama Kayıtları)</strong> özelliğinin aktif olması gerekiyor</li>
                                <li>"API Bağlantısını Test Et" butonuna basarak bağlantıyı test edin</li>
                                <li>API key'i yeni oluşturduysanız, birkaç dakika bekleyip tekrar deneyin</li>
                                <li>Bulutfon hesap yöneticinizle iletişime geçerek API erişim yetkilerinizi kontrol edin</li>
                            </ul>
                        </div>
                    </div>
                `;
                return;
            }
            
            if (!records || records.length === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <p style="color: #666; margin-bottom: 10px;">📋 Bu numara için görüşme kaydı bulunamadı</p>
                        <p style="color: #888; font-size: 12px;">Aranan numara: ${phoneNumber}</p>
                        <p style="color: #999; font-size: 11px; margin-top: 10px;">
                            💡 Bulutfon sisteminde bu numarayla yapılmış bir görüşme yoksa veya kayıtlar silinmiş olabilir.
                        </p>
                    </div>
                `;
                return;
            }
            
            // Kayıtları gelen ve giden olarak ayır
            const incomingCalls = records.filter(r => r.direction === 'IN');
            const outgoingCalls = records.filter(r => r.direction === 'OUT');
            
            const uniqueId = container.id; // Her container için benzersiz ID
            
            let html = `
                <div>
                    <div class="customer-tabs">
                        <button class="tab-button active" onclick="switchCallTab(0, '${uniqueId}')">📞 Gelen Aramalar (${incomingCalls.length})</button>
                        <button class="tab-button" onclick="switchCallTab(1, '${uniqueId}')">📱 Giden Aramalar (${outgoingCalls.length})</button>
                    </div>
                    
                    <div class="call-tab-content active" style="padding: 15px; background: white; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 8px 8px;">
                        <div style="display: grid; gap: 10px;">
            `;
            
            // Gelen Aramalar
            incomingCalls.forEach((record, idx) => {
                html += renderCallRecord(record, 'in-' + idx);
            });
            
            html += `
                        </div>
                    </div>
                    
                    <div class="call-tab-content" style="padding: 15px; background: white; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 8px 8px; display: none;">
                        <div style="display: grid; gap: 10px;">
            `;
            
            // Giden Aramalar
            outgoingCalls.forEach((record, idx) => {
                html += renderCallRecord(record, 'out-' + idx);
            });
            
            html += `
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Görüşme kayıtları sekmelerini değiştir
        window.switchCallTab = function(tabIndex, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const tabs = container.querySelectorAll('.tab-button');
            const contents = container.querySelectorAll('.call-tab-content');
            
            tabs.forEach((btn, idx) => {
                if (idx === tabIndex) {
                    btn.classList.add('active');
                    contents[idx].style.display = 'block';
                } else {
                    btn.classList.remove('active');
                    contents[idx].style.display = 'none';
                }
            });
        };
        
        // Tek bir görüşme kaydını render et
        function renderCallRecord(record, idx) {
            // Bulutfon v2 API field'ları (call_time, caller, callee, duration, call_record)
            const callTime = record.call_time || record.call_Time || record.call_date;
            const date = new Date(callTime);
            date.setHours(date.getHours() - 3); // ✅ UTC'den Türkiye saatine çevir
            const dateStr = date.toLocaleString('tr-TR');
            
            // Süre hesaplama - duration (saniye) veya billsec
            let duration = '00:00';
            if (record.duration) {
                duration = `${record.duration} sn`;
            } else if (record.billsec) {
                duration = `${Math.floor(record.billsec / 60)}:${(record.billsec % 60).toString().padStart(2, '0')}`;
            }
            
            // Yön belirleme
            const directionIcon = record.direction === 'IN' ? '📞 Gelen' : '📱 Giden';
            
            // ✅ Durum belirleme - Gelen ve Giden aramalar için farklı kontrol
            let isAnswered = false;
            let isMissed = false;
            
            if (record.direction === 'IN') {
                // GELEN ARAMALAR: is_missing_call parametresi kullan
                if (record.is_missing_call !== undefined && record.is_missing_call !== null) {
                    const isMissingCall = record.is_missing_call === true || record.is_missing_call === "true" || record.is_missing_call === 1;
                    isMissed = isMissingCall;
                    isAnswered = !isMissingCall;
                } else {
                    const hangupCause = (record.hangup_cause || '').toUpperCase();
                    isAnswered = hangupCause === 'ANSWERED';
                    isMissed = !isAnswered;
                }
            } else {
                // GİDEN ARAMALAR: answer_time kontrolü (öncelikli)
                if (record.answer_time !== undefined) {
                    isAnswered = record.answer_time && record.answer_time !== null && record.answer_time !== '';
                    isMissed = !isAnswered;
                } else {
                    // Fallback: hangup_cause veya talking_seconds
                    const hangupCause = (record.hangup_cause || '').toUpperCase();
                    if (hangupCause) {
                        isAnswered = hangupCause === 'ANSWERED';
                    } else {
                        const talkingSeconds = parseInt(record.talking_seconds) || 0;
                        isAnswered = talkingSeconds > 0;
                    }
                    isMissed = !isAnswered;
                }
            }
            
            const statusColor = isAnswered ? '#4CAF50' : '#f44336';
            const statusText = isAnswered ? 'Cevaplandı' : 'Cevaplanmadı';
            
            // Arayan ve aranan numaralar - Formatla
            const caller = formatPhoneDisplay(record.caller || record.src || 'N/A');
            const callee = formatPhoneDisplay(record.callee || record.dst || 'N/A');
            
            // Ses kaydı kontrolü - call_record field'ı veya UUID
            const recordingUrl = record.call_record; // Eğer doğrudan URL ise
            const hasRecordingUrl = recordingUrl && recordingUrl !== null && recordingUrl !== '';
            const hasUuid = record.uuid || record.call_uuid;
            const canPlayRecording = hasRecordingUrl || (hasUuid && isAnswered);
            
            // ✅ Ses kaydı bölümünü her zaman göster (cevaplanan aramalar için)
            let recordingSection = '';
            if (isAnswered) {
                if (hasRecordingUrl) {
                    // Direkt URL varsa audio player göster
                    recordingSection = `
                        <div style="margin-top: 12px; padding: 10px; background: #e3f2fd; border-radius: 6px; border-left: 3px solid #2196f3;">
                            <div style="font-size: 12px; font-weight: 600; color: #1976d2; margin-bottom: 8px;">🎧 Ses Kaydı</div>
                            <audio controls style="width: 100%; height: 32px;">
                                <source src="${recordingUrl}" type="audio/mpeg">
                                Tarayıcınız ses oynatmayı desteklemiyor.
                            </audio>
                        </div>
                    `;
                } else if (hasUuid) {
                    // UUID varsa dinle butonu göster
                    recordingSection = `
                        <div style="margin-top: 12px; padding: 10px; background: #e3f2fd; border-radius: 6px; border-left: 3px solid #2196f3;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-size: 12px; font-weight: 600; color: #1976d2;">🎧 Ses Kaydı</span>
                                <button onclick="playRecording('${hasUuid}', 'audio-${idx}')" class="btn btn-sm btn-primary" style="font-size: 11px; padding: 4px 8px;">
                                    ▶️ Dinle
                                </button>
                            </div>
                            <div id="audio-container-${idx}" style="display: none; margin-top: 8px;">
                                <audio id="audio-${idx}" controls style="width: 100%; height: 32px;">
                                    <source id="audio-source-${idx}" type="audio/mpeg">
                                    Tarayıcınız ses oynatmayı desteklemiyor.
                                </audio>
                                <div style="font-size: 10px; color: #1976d2; margin-top: 4px; text-align: center;">
                                    💡 Ses kaydı yükleniyor... Birkaç saniye sürebilir
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Ne URL ne UUID var - bilgilendirme göster
                    recordingSection = `
                        <div style="margin-top: 12px; padding: 8px; background: #fff3e0; border-radius: 6px; border-left: 3px solid #ff9800;">
                            <div style="font-size: 11px; color: #f57c00;">
                                🎧 Ses kaydı bulunamadı (UUID eksik)
                            </div>
                        </div>
                    `;
                }
            } else {
                // Cevaplanmamış aramalar için bilgi göster
                recordingSection = `
                    <div style="margin-top: 12px; padding: 8px; background: #ffebee; border-radius: 6px; border-left: 3px solid #f44336;">
                        <div style="font-size: 11px; color: #c62828;">
                            📵 Cevapsız arama - Ses kaydı yok
                        </div>
                    </div>
                `;
            }
            
            return `
                    <div style="padding: 12px; background: white; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <div style="font-weight: 600;">${directionIcon}</div>
                            <div style="font-size: 11px; color: #888;">${dateStr}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 12px;">
                                <span style="color: #666;">📞</span> <strong>${caller}</strong> → <strong>${callee}</strong>
                            </div>
                            <div style="font-size: 12px;">
                                <span style="color: #666;">⏱️</span> <strong>${duration}</strong>
                            </div>
                        </div>
                        ${statusText ? `
                            <div style="margin-top: 6px; font-size: 11px;">
                                <span style="padding: 2px 8px; background: ${statusColor}; color: white; border-radius: 4px;">${statusText}</span>
                            </div>
                        ` : ''}
                        
                        ${recordingSection}
                    </div>
                `;
        }
        
        // Ses kaydını çal
        window.playRecording = async function(recordingId, audioElementId) {
            try {
                const audioContainer = document.getElementById(`audio-container-${audioElementId.split('-')[1]}`);
                const audioElement = document.getElementById(audioElementId);
                const audioSource = document.getElementById(`audio-source-${audioElementId.split('-')[1]}`);
                
                if (!clubSettings || !clubSettings.bulutfonApiKey) {
                    showAlert('⚠️ Bulutfon API Key tanımlı değil!', 'warning');
                    return;
                }
                
                console.log('🎧 Ses kaydı yükleniyor, UUID:', recordingId);
                
                // Audio elementi göster
                audioContainer.style.display = 'block';
                
                // Loading göster
                const buttonIdx = audioElementId.split('-')[1];
                const button = document.querySelector(`button[onclick*="audio-${buttonIdx}"]`);
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '⏳ Yükleniyor...';
                }
                
                // Ses dosyasını yükle
                try {
                    // Firebase Functions proxy üzerinden ses kaydını al (CORS sorunu çözümü)
                    const recordingUrl = `https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonRecordingProxy?apikey=${clubSettings.bulutfonApiKey}&uuid=${recordingId}`;
                    
                    const response = await fetch(recordingUrl, {
                        method: 'GET'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'Bilinmeyen hata' }));
                        console.error('❌ Ses kaydı API hatası:', response.status, errorData);
                        
                        if (response.status === 404) {
                            throw new Error('Bu görüşme için ses kaydı bulunamadı. Kayıt edilmemiş olabilir.');
                        } else {
                            throw new Error(errorData.message || 'Ses kaydı alınamadı');
                        }
                    }
                    
                    // Blob olarak al ve object URL oluştur
                    const blob = await response.blob();
                    const blobUrl = URL.createObjectURL(blob);
                    
                    console.log('✅ Ses kaydı yüklendi, boyut:', blob.size, 'bytes');
                    
                    // Audio source'a ata ve oynat
                    audioSource.src = blobUrl;
                    audioElement.load();
                    await audioElement.play();
                    
                    showAlert('🎧 Ses kaydı başarıyla yüklendi', 'success');
                    
                    // Butonu gizle
                    if (button) {
                        button.style.display = 'none';
                    }
                    
                } catch (error) {
                    console.error('Ses kaydı yüklenirken hata:', error);
                    showAlert(`❌ ${error.message}`, 'danger');
                    audioContainer.style.display = 'none';
                    
                    // Butonu eski haline getir
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = '▶️ Dinle';
                    }
                }
            } catch (error) {
                console.error('Ses oynatma hatası:', error);
                showAlert('Ses kaydı oynatılırken bir hata oluştu.', 'danger');
            }
        };
         async function handleUserSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const selectedPermissions = formData.getAll('permissions');

            const userData = {
                fullName: data.fullName,
                phone: data.phone,
                phoneNumber: data.phone, // For WhatsApp notifications
                username: data.phone,
                password: data.password, 
                email: data.phone + '@kulup.local', // For task assignment
                permissions: {
                    // Finansal Yetkiler
                    view_payments: selectedPermissions.includes('view_payments'),
                    edit_payments: selectedPermissions.includes('edit_payments'),
                    delete_payments: selectedPermissions.includes('delete_payments'),
                    export_payments: selectedPermissions.includes('export_payments'),
                    
                    // Üye Yetkiler
                    view_members: selectedPermissions.includes('view_members'),
                    add_members: selectedPermissions.includes('add_members'),
                    edit_members: selectedPermissions.includes('edit_members'),
                    delete_members: selectedPermissions.includes('delete_members'),
                    export_members: selectedPermissions.includes('export_members'),
                    
                    // CRM Yetkileri
                    view_crm: selectedPermissions.includes('view_crm'),
                    add_crm: selectedPermissions.includes('add_crm'),
                    edit_crm: selectedPermissions.includes('edit_crm'),
                    delete_crm: selectedPermissions.includes('delete_crm'),
                    view_calls: selectedPermissions.includes('view_calls'),
                    
                    // İletişim Yetkileri
                    send_messages: selectedPermissions.includes('send_messages'),
                    send_bulk_messages: selectedPermissions.includes('send_bulk_messages'),
                    view_message_history: selectedPermissions.includes('view_message_history'),
                    
                    // Raporlar ve İstatistikler
                    view_stats: selectedPermissions.includes('view_stats'),
                    view_reports: selectedPermissions.includes('view_reports'),
                    export_reports: selectedPermissions.includes('export_reports'),
                    
                    // Ayarlar ve Yönetim
                    manage_users: selectedPermissions.includes('manage_users'),
                    manage_settings: selectedPermissions.includes('manage_settings'),
                    manage_branches: selectedPermissions.includes('manage_branches'),
                    manage_groups: selectedPermissions.includes('manage_groups'),
                    
                    // Yoklama ve Takvim
                    view_attendance: selectedPermissions.includes('view_attendance'),
                    edit_attendance: selectedPermissions.includes('edit_attendance'),
                    manage_schedule: selectedPermissions.includes('manage_schedule')
                },
                clubId: currentClubId, // ✅ Kulüp ID'si eklendi
                role: 'admin',
                branches: null // ✅ Yeni admin'ler tüm branşlara erişebilir (NULL = Tüm branşlar)
            };

            try {
                // Firebase'e ekle
                const docRef = await window.firebase.addDoc(window.firebase.collection(window.db, 'users'), userData);
                
                // Supabase'e de ekle (branches kolonu için)
                try {
                    await supabase.from('users').insert({
                        id: docRef.id,
                        ...userData,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    });
                    console.log('✅ User synced to Supabase');
                } catch (supabaseError) {
                    console.warn('⚠️ Supabase sync hatası (normal):', supabaseError);
                }
                
                showAlert('✅ Yeni yönetici başarıyla eklendi. (Tüm branşlara erişim var)', 'success');
                form.reset();
                await loadData();
            } catch (error) {
                console.error('Error adding user:', error);
                showAlert('Yönetici eklenirken bir hata oluştu.', 'danger');
            }
        }

        async function openTaskMessagesModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return showAlert('Görev bulunamadı.', 'danger');
            
            const modal = document.getElementById('taskMessagesModal');
            const modalTitle = document.getElementById('taskMessagesModalTitle');
            const messagesList = document.getElementById('taskMessagesList');
            const messageForm = document.getElementById('taskMessageForm');
            
            modalTitle.textContent = `💬 Mesajlar - ${task.taskName}`;
            messageForm.taskId.value = taskId;
            
            // Mark messages as read
            const unreadMessages = (task.messages || []).filter(m => !m.read && m.sender !== currentUser.fullName);
            if (unreadMessages.length > 0) {
                const updatedMessages = (task.messages || []).map(m => {
                    if (!m.read && m.sender !== currentUser.fullName) {
                        return { ...m, read: true };
                    }
                    return m;
                });
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'tasks', taskId), { messages: updatedMessages });
                task.messages = updatedMessages;
            }
            
            // Render messages
            const messages = task.messages || [];
            messagesList.innerHTML = messages.length === 0 
                ? '<p class="empty-state">Henüz mesaj yok.</p>'
                : messages.map((msg, index) => {
                    const isMine = msg.sender === currentUser.fullName;
                    const canDelete = currentUser.isSuperAdmin;
                    const deleteBtn = canDelete ? `<button class="task-message-delete" onclick="deleteTaskMessage('${taskId}', ${index})" title="Mesajı Sil">×</button>` : '';
                    return `
                        <div class="task-message ${isMine ? 'task-message-mine' : 'task-message-other'}">
                            ${deleteBtn}
                            <div class="task-message-header">
                                <strong>${msg.sender}</strong>
                                <span class="task-message-time">${formatDate(msg.timestamp)}</span>
                            </div>
                            <div class="task-message-body">${msg.message}</div>
                        </div>
                    `;
                }).join('');
            
            // Scroll to bottom
            setTimeout(() => {
                messagesList.scrollTop = messagesList.scrollHeight;
            }, 50);
            
            openModal('taskMessagesModal');
        }
        
        async function sendTaskMessage(e) {
            e.preventDefault();
            const form = e.target;
            const taskId = form.taskId.value;
            const messageText = form.messageText.value.trim();
            
            if (!messageText) return showAlert('Mesaj boş olamaz.', 'warning');
            
            const task = tasks.find(t => t.id === taskId);
            if (!task) return showAlert('Görev bulunamadı.', 'danger');
            
            const newMessage = {
                sender: currentUser.fullName,
                message: messageText,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            const updatedMessages = [...(task.messages || []), newMessage];
            
            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'tasks', taskId), { messages: updatedMessages });
                task.messages = updatedMessages;
                form.messageText.value = '';
                openTaskMessagesModal(taskId); // Refresh messages
                showAlert('Mesaj gönderildi.', 'success');
                
                // Send WhatsApp notification
                const notificationSent = await sendTaskMessageNotification(task, messageText, currentUser.fullName);
                if (notificationSent) {
                    console.log('✅ WhatsApp bildirimi gönderildi');
                } else {
                    console.log('⚠️ WhatsApp bildirimi gönderilemedi (şablon kapalı veya ayarlar eksik olabilir)');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showAlert('Mesaj gönderilirken hata oluştu.', 'danger');
            }
        }
        
        // Send WhatsApp notification when a task message is added
        async function sendTaskMessageNotification(task, messageText, sender) {
            try {
                // Check if template is enabled
                if (!messageTemplates.taskMessage || !messageTemplates.taskMessage.enabled) {
                    console.log('Task message notification: Template not enabled');
                    return false;
                }
                
                // Find the user assigned to this task
                let assignedUser = users.find(u => u.email === task.assignedTo);
                if (!assignedUser) {
                    assignedUser = users.find(u => u.fullName === task.assignedTo);
                }
                
                if (!assignedUser) {
                    console.log('Task message notification: Assigned user not found', task.assignedTo);
                    return false;
                }
                
                // Don't send notification to the sender
                if (assignedUser.fullName === sender) {
                    console.log('Task message notification: Skipping - user is sender');
                    return false;
                }
                
                // Check if user has phone number
                let phoneNumber = assignedUser.phoneNumber || assignedUser.phone;
                if (!phoneNumber) {
                    console.log('Task message notification: User has no phone number', assignedUser.fullName);
                    return false;
                }
                
                // Format phone number to 905xxxxxxxxx
                phoneNumber = phoneNumber.replace(/\D/g, '');
                if (phoneNumber.startsWith('0')) {
                    phoneNumber = '90' + phoneNumber.substring(1);
                } else if (!phoneNumber.startsWith('90')) {
                    phoneNumber = '90' + phoneNumber;
                }
                
                // Get connected WhatsApp device
                let connectedDevice;
                if (defaultWhatsAppDevice) {
                    connectedDevice = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
                }
                if (!connectedDevice) {
                    connectedDevice = whatsappDevices.find(d => d.status === 'connected');
                }
                if (!connectedDevice) {
                    console.log('Task message notification: No connected device');
                    return false;
                }
                
                // Prepare message from template
                let message = messageTemplates.taskMessage.text || '';
                if (!message || message.trim() === '') {
                    message = `Sayın {VELI_AD_SOYAD},\n\n"{GOREV}" görevi için yeni bir mesaj aldınız:\n\n💬 {MESAJ}\n📤 Gönderen: {GONDEREN}\n📅 Tarih: {TARIH}\n\nGörev detaylarını kontrol ediniz.`;
                }
                
                const userName = assignedUser.fullName || assignedUser.email;
                message = message.replace(/{UYE_AD_SOYAD}/g, userName);
                message = message.replace(/{OGRENCI_AD_SOYAD}/g, '');
                // Backward compatibility
                message = message.replace(/{VELI_AD_SOYAD}/g, userName);
                message = message.replace(/{AD_SOYAD}/g, userName).replace(/{AD}/g, userName);
                
                message = message.replace(/{GOREV}/g, task.taskName);
                message = message.replace(/{MESAJ}/g, messageText.substring(0, 100) + (messageText.length > 100 ? '...' : ''));
                message = message.replace(/{GONDEREN}/g, sender);
                message = message.replace(/{TARIH}/g, formatDate(new Date().toISOString()));
                
                console.log('Task message notification: Sending to', assignedUser.fullName, phoneNumber);
                
                // Send message
                const result = await sendWhatsAppMessage(connectedDevice.instanceName, phoneNumber, message, assignedUser.fullName || assignedUser.email);
                const success = result.success || result === true;
                console.log('Task message notification sent:', success);
                
                return success;
            } catch (error) {
                console.error('Task message notification error:', error);
                return false;
            }
        }
        
        async function deleteTaskMessage(taskId, messageIndex) {
            if (!currentUser.isSuperAdmin) {
                return showAlert('Bu işlem için yetkiniz yok.', 'danger');
            }
            
            showConfirmModal('Bu mesajı silmek istediğinizden emin misiniz?', async () => {
                closeModal('confirmModal');
                try {
                    const task = tasks.find(t => t.id === taskId);
                    if (!task) return showAlert('Görev bulunamadı.', 'danger');
                    
                    const updatedMessages = [...(task.messages || [])];
                    updatedMessages.splice(messageIndex, 1);
                    
                    await window.firebase.updateDoc(window.firebase.doc(window.db, 'tasks', taskId), { messages: updatedMessages });
                    task.messages = updatedMessages;
                    openTaskMessagesModal(taskId); // Refresh
                    showAlert('Mesaj silindi.', 'success');
                } catch (error) {
                    console.error('Error deleting message:', error);
                    showAlert('Mesaj silinirken hata oluştu.', 'danger');
                }
            });
        }

        async function handleTaskSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const taskId = data.taskId;
            delete data.taskId;

            const taskData = {
                taskName: data.taskName,
                assignedTo: data.assignedTo,
                status: data.status,
                notes: data.notes || '',
                clubId: currentClubId // ✅ Kulüp ID'si eklendi
            };

            try {
                if (taskId) { // Editing existing task
                    // ✅ Eski görevi bul (atama değişikliğini kontrol etmek için)
                    const oldTask = tasks.find(t => t.id === taskId);
                    const assigneeChanged = oldTask && oldTask.assignedTo !== taskData.assignedTo;
                    
                    if (taskData.status === 'Tamamlandı') {
                        taskData.completedAt = new Date().toISOString();
                    } else {
                        taskData.completedAt = null;
                    }
                    await window.firebase.updateDoc(window.firebase.doc(window.db, 'tasks', taskId), taskData);
                    showAlert('Görev güncellendi.', 'success');
                    
                    // ✅ Atanan kişi değiştiyse yeni kişiye bildirim gönder
                    if (assigneeChanged) {
                        console.log('📢 Görev ataması değişti:', oldTask.assignedTo, '→', taskData.assignedTo);
                        sendTaskNotification(taskData).catch(err => {
                            console.error('Task notification failed:', err);
                        });
                    }
                } else { // Creating new task
                    taskData.createdAt = new Date().toISOString();
                    taskData.completedAt = null;
                    if (taskData.status === 'Tamamlandı') {
                       taskData.completedAt = new Date().toISOString();
                    }
                    await window.firebase.addDoc(window.firebase.collection(window.db, 'tasks'), taskData);
                    showAlert('Yeni görev eklendi.', 'success');
                    
                    // Send WhatsApp notification in background (don't wait)
                    sendTaskNotification(taskData).catch(err => {
                        console.error('Task notification failed:', err);
                    });
                }
                closeModal('taskModal');
                await loadData();
            } catch (error) {
                showAlert('Görev kaydedilirken hata oluştu.', 'danger');
            }
        }
        
        // --- WHATSAPP NOTIFICATION FUNCTIONS ---
        async function sendTaskNotification(taskData) {
            try {
                // Check if template is enabled
                if (!messageTemplates.task || !messageTemplates.task.enabled) {
                    console.log('Task notification: Template not enabled');
                    return false;
                }
                
                // Find assigned user by email or fullName
                let assignedUser = users.find(u => u.email === taskData.assignedTo);
                if (!assignedUser) {
                    // Try finding by fullName
                    assignedUser = users.find(u => u.fullName === taskData.assignedTo);
                }
                
                if (!assignedUser) {
                    console.log('Task notification: User not found', taskData.assignedTo);
                    return false;
                }
                
                // Check if user has phone number
                let phoneNumber = assignedUser.phoneNumber || assignedUser.phone;
                if (!phoneNumber) {
                    console.log('Task notification: User has no phone number', assignedUser.fullName);
                    return false;
                }
                
                // Format phone number to 905xxxxxxxxx
                phoneNumber = phoneNumber.replace(/\D/g, ''); // Remove non-digits
                if (phoneNumber.startsWith('0')) {
                    phoneNumber = '90' + phoneNumber.substring(1); // Replace leading 0 with 90
                } else if (!phoneNumber.startsWith('90')) {
                    phoneNumber = '90' + phoneNumber; // Add 90 prefix
                }
                
                // Get default WhatsApp device
                let connectedDevice;
                
                // First try to use default device
                if (defaultWhatsAppDevice) {
                    connectedDevice = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
                }
                
                // If no default or default not connected, use any connected device
                if (!connectedDevice) {
                    connectedDevice = whatsappDevices.find(d => d.status === 'connected');
                }
                
                if (!connectedDevice) {
                    console.log('Task notification: No connected device');
                    return false;
                }
                
                console.log('Task notification: Sending to', assignedUser.fullName, phoneNumber);
                console.log('Message templates:', messageTemplates);
                console.log('Task template:', messageTemplates.task);
                
                // Prepare message from template
                let message = messageTemplates.task?.text || '';
                
                // If no template text, use default
                if (!message || message.trim() === '') {
                    message = `Sayın {VELI_AD_SOYAD}, Size yeni bir görev atandı:\n\n📋 Görev: {GOREV}\n📝 Açıklama: {ACIKLAMA}\n📅 Tarih: {TARIH}\n\nİyi çalışmalar dileriz.`;
                    console.warn('Using default task template as saved template is empty');
                }
                
                const userName = assignedUser.fullName || assignedUser.email;
                message = message.replace(/{UYE_AD_SOYAD}/g, userName);
                message = message.replace(/{OGRENCI_AD_SOYAD}/g, '');
                // Backward compatibility
                message = message.replace(/{VELI_AD_SOYAD}/g, userName);
                message = message.replace(/{AD_SOYAD}/g, userName).replace(/{AD}/g, userName);
                
                message = message.replace(/{GOREV}/g, taskData.taskName);
                message = message.replace(/{ACIKLAMA}/g, taskData.notes || 'Açıklama bulunmamaktadır');
                message = message.replace(/{TARIH}/g, formatDate(taskData.createdAt));
                
                console.log('Final message to send:', message);
                
                // Send message
                const result = await sendWhatsAppMessage(connectedDevice.instanceName, phoneNumber, message, assignedUser.fullName || assignedUser.email);
                const success = result.success || result === true;
                console.log('Task notification sent:', success);
                
                // Show notification to user
                if (success) {
                    setTimeout(() => {
                        showAlert(`📨 WhatsApp bildirimi ${assignedUser.fullName}'a gönderildi`, 'success');
                    }, 200);
                } else {
                    setTimeout(() => {
                        const errorMsg = result.errorReason ? ` (${result.errorReason})` : '';
                        showAlert(`⚠️ WhatsApp bildirimi gönderilemedi${errorMsg}`, 'warning');
                    }, 200);
                }
                
                return success;
                
            } catch (error) {
                console.error('Task notification error:', error);
                setTimeout(() => {
                    showAlert(`⚠️ WhatsApp bildirimi gönderilemedi: ${error.message}`, 'warning');
                }, 200);
                return false;
            }
        }
        
        async function sendWhatsAppMessage(instanceName, phoneNumber, message, logRecipient = 'Bilinmeyen', skipWorkingHoursCheck = false) {
            let success = false;
            let formattedPhone = '';
            let errorReason = '';
            
            try {
                // 💰 Bakiye kontrolü (mesaj göndermeden önce)
                try {
                    const { data: balanceCheck, error: checkError } = await supabaseClient.rpc('check_whatsapp_balance', {
                        p_club_id: currentClubId,
                        p_message_count: 1
                    });
                    
                    if (checkError) {
                        console.error('⚠️ Bakiye kontrol edilemedi:', checkError);
                    } else if (balanceCheck && !balanceCheck.has_enough) {
                        console.error('❌ Yetersiz bakiye!', balanceCheck);
                        showAlert(`❌ Mesaj bakiyeniz tükendi! Mevcut: ${balanceCheck.current_balance || 0}`, 'danger');
                        return { success: false, errorReason: 'Yetersiz bakiye' };
                    } else if (balanceCheck && balanceCheck.low_balance_warning) {
                        console.warn('⚠️ Düşük bakiye uyarısı:', balanceCheck);
                        showAlert(`⚠️ Bakiyeniz düşük! Kalan: ${balanceCheck.current_balance}`, 'warning');
                    }
                } catch (balanceCheckErr) {
                    console.error('⚠️ Bakiye kontrol hatası:', balanceCheckErr);
                    // Kontrol başarısız olsa bile mesajı göndermeye devam et
                }
                
                // ✅ Çalışma saatleri kontrolü (skipWorkingHoursCheck true ise atla)
                if (!skipWorkingHoursCheck && !isWithinWorkingHours()) {
                    console.log('⏰ Çalışma saatleri dışında, mesaj kuyruğa ekleniyor...');
                    await addMessageToQueue(phoneNumber, message, instanceName, logRecipient);
                    showAlert(`📋 Mesaj çalışma saatleri dışında olduğu için kuyruğa eklendi. ${getNextWorkingHour().split('T')[0]} tarihinde gönderilecek.`, 'info');
                    return { success: false, queued: true }; // Kuyruklandığını belirt
                }
                
                // ✅ Apply rate limiting with random delays for all messages
                const now = Date.now();
                const timeSinceLastMessage = now - lastMessageSentTime;
                
                // Calculate required wait time based on message count
                const shouldLongWait = (totalMessagesSent % (clubSettings.longWaitTrigger || 100)) === 0 && totalMessagesSent > 0;
                let requiredWaitTime;
                
                if (shouldLongWait) {
                    const min = (clubSettings.minLongWait || 400) * 1000;
                    const max = (clubSettings.maxLongWait || 800) * 1000;
                    requiredWaitTime = Math.floor(Math.random() * (max - min + 1)) + min;
                    console.log(`⏳ UZUN BEKLEME: ${(requiredWaitTime / 1000).toFixed(1)}s (Her ${clubSettings.longWaitTrigger} mesajda bir)`);
                } else {
                    const min = (clubSettings.minWaitTime || 20) * 1000;
                    const max = (clubSettings.maxWaitTime || 50) * 1000;
                    requiredWaitTime = Math.floor(Math.random() * (max - min + 1)) + min;
                    if (totalMessagesSent > 0) {
                        console.log(`⏳ Mesaj arası bekleme: ${(requiredWaitTime / 1000).toFixed(1)}s`);
                    }
                }
                
                // If not enough time has passed, wait
                if (timeSinceLastMessage < requiredWaitTime) {
                    const remainingWait = requiredWaitTime - timeSinceLastMessage;
                    await new Promise(resolve => setTimeout(resolve, remainingWait));
                }
                
                // Update tracking
                lastMessageSentTime = Date.now();
                totalMessagesSent++;
                
                // Format phone number for WhatsApp
                formattedPhone = phoneNumber.replace(/\D/g, '');
                if (formattedPhone.startsWith('0') && formattedPhone.length === 11) {
                    // 05449367543 → 905449367543
                    formattedPhone = '90' + formattedPhone.substring(1);
                } else if (formattedPhone.startsWith('0')) {
                    formattedPhone = formattedPhone.substring(1);
                }
                if (!formattedPhone.startsWith('90')) {
                    formattedPhone = '90' + formattedPhone;
                }
                
                console.log(`📤 Sending WhatsApp message to: ${formattedPhone}@s.whatsapp.net via ${instanceName}`);
                
                // Try multiple formats for compatibility
                const formats = [
                    // Format 1: With @s.whatsapp.net (most common)
                    {
                        number: `${formattedPhone}@s.whatsapp.net`,
                        text: message
                    },
                    // Format 2: Without @s.whatsapp.net
                    {
                        number: formattedPhone,
                        text: message
                    }
                ];
                
                let response = null;
                let responseData = null;
                let lastError = null;
                
                // Try each format until one works
                for (let i = 0; i < formats.length && !success; i++) {
                    console.log(`Trying format ${i + 1}:`, JSON.stringify(formats[i]));
                    
                    try {
                        // Create AbortController for timeout
                        const controller = new AbortController();
                        // 2 dakika timeout - API'nin cevap vermesi için yeterli süre
                        const timeoutId = setTimeout(() => controller.abort(), 120000);
                        
                        response = await fetch(`${EVOLUTION_API_URL}/message/sendText/${instanceName}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': EVOLUTION_API_KEY
                            },
                            body: JSON.stringify(formats[i]),
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        responseData = await response.json().catch(() => ({}));
                        console.log('WhatsApp API response:', response.status, responseData);
                        
                        if (response.ok) {
                            success = true;
                            console.log('✅ Message sent successfully with format', i + 1);
                            
                            // 💰 Bakiye azalt (mesaj başarıyla gönderildiyse)
                            try {
                                const { data: balanceResult, error: balanceError } = await supabaseClient.rpc('update_whatsapp_balance', {
                                    p_club_id: currentClubId,
                                    p_amount: -1, // 1 mesaj = -1 kredi
                                    p_action_type: 'send',
                                    p_note: `WhatsApp mesajı gönderildi: ${logRecipient} (${formattedPhone})`,
                                    p_created_by: currentUser?.email || 'system'
                                });
                                
                                if (balanceError) {
                                    console.error('⚠️ Bakiye güncellenemedi:', balanceError);
                                } else {
                                    console.log('💰 Bakiye güncellendi:', balanceResult);
                                    // Bakiye göstergesini arka planda güncelle
                                    loadWhatsAppBalance().catch(() => {});
                                }
                            } catch (balanceErr) {
                                console.error('⚠️ Bakiye güncelleme hatası:', balanceErr);
                            }
                            
                            break;
                        } else {
                            console.warn(`Format ${i + 1} failed (HTTP ${response.status}), trying next...`);
                            lastError = responseData;
                            if (responseData.response) {
                                console.error('Error details:', JSON.stringify(responseData.response, null, 2));
                            }
                            // Eğer HTTP hatası varsa (404, 401, 500 vs) bir sonraki formatı dene
                            // Timeout değilse devam et
                        }
                    } catch (fetchError) {
                        console.log(`Format ${i + 1} fetch error:`, fetchError.message);
                        if (fetchError.name === 'AbortError') {
                            console.warn('⏱️ Request timeout (2 dakika), trying next format...');
                            errorReason = 'İstek zaman aşımına uğradı (2 dakika)';
                        } else {
                            errorReason = `Bağlantı hatası: ${fetchError.message}`;
                        }
                        lastError = { message: fetchError.message };
                    }
                }
                
                // If all formats failed, set error reason
                if (!success && response) {
                    if (response.status === 500) {
                        errorReason = 'Sunucu hatası (500)';
                    } else if (response.status === 404) {
                        errorReason = 'Instance bulunamadı (404)';
                    } else if (response.status === 401 || response.status === 403) {
                        errorReason = 'Yetki hatası (401/403)';
                    } else if (lastError && lastError.message) {
                        errorReason = lastError.message;
                    } else if (lastError && lastError.error) {
                        errorReason = lastError.error;
                    } else {
                        errorReason = `HTTP ${response.status}`;
                    }
                }
            } catch (error) {
                console.error('WhatsApp message error:', error);
                success = false;
                errorReason = `İstek hatası: ${error.message}`;
            }
            
            // Log message to Firebase
            try {
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'sentMessages'),
                    {
                        recipient: logRecipient,
                        recipientPhone: formattedPhone,
                        message: message,
                        instanceName: instanceName,
                        success: success,
                        sentAt: new Date().toISOString(),
                        sentBy: currentUser?.email || 'system',
                        clubId: currentClubId // ✅ Kulüp ID'si eklendi
                    }
                );
                
                // Reload messages in background
                const messagesSnapshot = await window.firebase.getDocs(
                    window.firebase.query(
                        window.firebase.collection(window.db, 'sentMessages'),
                        window.firebase.where('clubId', '==', currentClubId),
                        window.firebase.orderBy('sentAt', 'desc')
                    )
                );
                sentMessages = messagesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).slice(0, 50);
                loadSentMessagesLog();
            } catch (error) {
                // Ignore log errors
            }
            
            return { success, errorReason, formattedPhone };
        }

        window.sendBirthdayMessage = async function(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) {
                showAlert('Üye bulunamadı!', 'danger');
                return;
            }
            
            // Get member's branch template
            const memberBranch = member.Brans?.toLowerCase() || 'tenis';
            const branchTemplates = messageTemplates[memberBranch];
            
            if (!branchTemplates?.birthday || !branchTemplates.birthday.enabled) {
                showAlert(`Doğum günü şablonu ${memberBranch} branşında etkinleştirilmemiş! Lütfen ayarlardan etkinleştirin.`, 'warning');
                return;
            }

            if (!member.Telefon) {
                showAlert('Üye telefon numarası bulunamadı!', 'danger');
                return;
            }

            // Find connected device
            let device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
            if (!device) {
                device = whatsappDevices.find(d => d.status === 'connected');
            }
            
            if (!device) {
                showAlert('Bağlı WhatsApp cihazı bulunamadı!', 'danger');
                return;
            }

            console.log('🎂 DOĞUM GÜNÜ MESAJI - Kullanılacak cihaz:', device.instanceName);
            console.log('🎂 Ana WhatsApp hattı:', defaultWhatsAppDevice);

            try {
                const isChild = !!member.Resit_Olmayan_Adi_Soyadi;
                
                // Get template text based on member type from branch templates
                let message = '';
                if (isChild) {
                    message = branchTemplates.birthday.textChild || branchTemplates.birthday.text || '';
                } else {
                    message = branchTemplates.birthday.textAdult || branchTemplates.birthday.text || '';
                }
                
                if (!message || message.trim() === '') {
                    showAlert('Mesaj şablonu boş! Lütfen ayarlardan düzenleyin.', 'warning');
                    return;
                }

                // Replace template variables
                const studentName = member.Resit_Olmayan_Adi_Soyadi || '';
                const parentName = member.Ad_Soyad || 'Değerli Üyemiz';
                const uyeName = isChild ? parentName : parentName;
                
                message = message.replace(/{UYE_AD_SOYAD}/g, uyeName);
                message = message.replace(/{OGRENCI_AD_SOYAD}/g, studentName);
                // Backward compatibility
                message = message.replace(/{VELI_AD_SOYAD}/g, parentName);
                message = message.replace(/{AD_SOYAD}/g, uyeName).replace(/{AD}/g, uyeName);

                // Confirm before sending
                const memberName = isChild ? studentName : parentName;
                if (!confirm(`${memberName} için doğum günü mesajı gönderilsin mi?\n\nCihaz: ${device.instanceName}\n\nMesaj:\n${message}`)) {
                    return;
                }

                // Send message
                const result = await sendWhatsAppMessage(device.instanceName, member.Telefon, message, memberName, 'birthday');
                
                if (result.queued) {
                    // Mesaj kuyruğa eklendi, zaten bildirim gösterildi
                    return;
                } else if (result.success || result === true) {
                    showAlert('🎂 Doğum günü mesajı başarıyla gönderildi!', 'success');
                } else {
                    showAlert('❌ Mesaj gönderilemedi!', 'danger');
                }
            } catch (error) {
                console.error('Error sending birthday message:', error);
                showAlert('Hata: ' + error.message, 'danger');
            }
        };

        async function checkAndSendBirthdayMessages() {
            // Check if ANY branch has birthday template enabled
            const hasBirthdayEnabled = Object.keys(messageTemplates).some(branchKey => {
                return messageTemplates[branchKey]?.birthday?.enabled === true;
            });
            
            if (!hasBirthdayEnabled) {
                console.log('🎂 Doğum günü şablonu hiçbir branşta etkin değil');
                return;
            }

            // Find connected device
            let device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
            if (!device) {
                device = whatsappDevices.find(d => d.status === 'connected');
            }
            
            if (!device) {
                console.log('⚠️ Bağlı WhatsApp cihazı yok, doğum günü mesajları gönderilemedi.');
                return;
            }

            // Get today's date (day and month)
            const today = new Date();
            const todayDay = today.getDate();
            const todayMonth = today.getMonth() + 1; // 0-indexed

            let birthdayCount = 0;

            // Check all members
            for (const member of members) {
                if (!member.Telefon || member.status !== 'active') continue;

                // Get member's branch template
                const memberBranch = member.Brans?.toLowerCase() || 'tenis'; // Default to tenis
                const branchTemplates = messageTemplates[memberBranch];
                
                // Check if branch has birthday template enabled
                if (!branchTemplates?.birthday?.enabled) continue;

                // Check if member has birthday
                const birthdayField = member.Dogum_Tarihi || member.dogumTarihi || member.birthday;
                if (!birthdayField) continue;

                // Parse birthday
                const birthday = new Date(birthdayField);
                const birthdayDay = birthday.getDate();
                const birthdayMonth = birthday.getMonth() + 1;

                // Check if today is birthday
                if (birthdayDay === todayDay && birthdayMonth === todayMonth) {
                    // Check if message already sent today
                    const sentToday = sentMessages.some(msg => {
                        const msgDate = new Date(msg.sentAt);
                        return msg.recipientPhone === member.Telefon && 
                               msg.type === 'birthday' &&
                               msgDate.getDate() === todayDay &&
                               msgDate.getMonth() === todayMonth &&
                               msgDate.getFullYear() === today.getFullYear();
                    });

                    if (sentToday) {
                        console.log(`🎂 ${member.Ad_Soyad || member.Resit_Olmayan_Adi_Soyadi}: Bugün zaten mesaj gönderilmiş`);
                        continue;
                    }

                    // Send birthday message
                    try {
                        const isChild = !!member.Resit_Olmayan_Adi_Soyadi;
                        
                        // Get template text based on member type from branch templates
                        let message = '';
                        if (isChild) {
                            message = branchTemplates.birthday.textChild || branchTemplates.birthday.text || '';
                        } else {
                            message = branchTemplates.birthday.textAdult || branchTemplates.birthday.text || '';
                        }
                        
                        if (!message || message.trim() === '') {
                            console.log('⚠️ Doğum günü mesaj şablonu boş!');
                            continue;
                        }

                        // Replace template variables
                        const studentName = member.Resit_Olmayan_Adi_Soyadi || '';
                        const parentName = member.Ad_Soyad || 'Değerli Üyemiz';
                        const uyeName = isChild ? parentName : parentName;
                        
                        message = message.replace(/{UYE_AD_SOYAD}/g, uyeName);
                        message = message.replace(/{OGRENCI_AD_SOYAD}/g, studentName);
                        // Backward compatibility
                        message = message.replace(/{VELI_AD_SOYAD}/g, parentName);
                        message = message.replace(/{AD_SOYAD}/g, uyeName).replace(/{AD}/g, uyeName);

                        // Send message
                        const memberName = isChild ? studentName : parentName;
                        const result = await sendWhatsAppMessage(device.instanceName, member.Telefon, message, memberName, 'birthday');
                        
                        if (result.queued) {
                            console.log(`🎂📋 Doğum günü mesajı kuyruğa eklendi: ${memberName}`);
                            // Kuyruk bildirimi zaten gösterildi
                        } else if (result.success || result === true) {
                            console.log(`🎂✅ Doğum günü mesajı gönderildi: ${memberName}`);
                            birthdayCount++;
                        } else {
                            console.log(`🎂❌ Doğum günü mesajı gönderilemedi: ${memberName}`);
                        }

                        // Small delay between messages
                        await new Promise(resolve => setTimeout(resolve, 500));

                    } catch (error) {
                        console.error('Doğum günü mesajı gönderme hatası:', error);
                    }
                }
            }

            if (birthdayCount > 0) {
                console.log(`🎉 ${birthdayCount} doğum günü mesajı gönderildi!`);
                showAlert(`🎂 ${birthdayCount} doğum günü mesajı başarıyla gönderildi!`, 'success');
            } else {
                console.log('🎂 Bugün doğum günü olan üye yok');
            }
        }

        async function sendAbsenceNotifications(absenceList) {
            if (absenceList.length === 0) {
                console.log('📭 Devamsızlık listesi boş');
                return;
            }
            
            console.log('🔍 Devamsızlık kontrolü:', {
                totalAbsences: absenceList.length,
                messageTemplates: Object.keys(messageTemplates)
            });

            // Find connected device
            let device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
            if (!device) {
                device = whatsappDevices.find(d => d.status === 'connected');
            }
            
            if (!device) {
                console.log('⚠️ Bağlı WhatsApp cihazı yok, devamsızlık mesajları gönderilemedi.');
                showAlert('⚠️ Devamsızlık mesajları gönderilemedi: WhatsApp bağlantısı yok!', 'warning');
                return;
            }

            let successCount = 0;
            let failCount = 0;

            for (const absence of absenceList) {
                try {
                    const member = absence.member;
                    
                    // Get group and branch
                    const group = groups.find(g => g.groupName === absence.groupName);
                    const branchId = group ? group.branch : null;
                    
                    if (!branchId) {
                        console.log(`⚠️ ${member.Ad_Soyad || member.Resit_Olmayan_Adi_Soyadi}: Branş bulunamadı`);
                        failCount++;
                        continue;
                    }
                    
                    // Get branch-specific template
                    const branchTemplates = messageTemplates[branchId];
                    
                    if (!branchTemplates || !branchTemplates.absence || !branchTemplates.absence.enabled) {
                        console.log(`⚠️ Branş "${branchId}" için devamsızlık şablonu aktif değil`);
                        failCount++;
                        continue;
                    }
                    
                    // Check if member has phone
                    if (!member.Telefon) {
                        console.log(`⚠️ ${member.Ad_Soyad || member.Resit_Olmayan_Adi_Soyadi}: Telefon numarası yok`);
                        failCount++;
                        continue;
                    }

                    // Check if member is a child
                    const isChild = !!member.Resit_Olmayan_Adi_Soyadi;
                    
                    // Get template text based on member type
                    let message = '';
                    if (isChild) {
                        message = branchTemplates.absence.textChild || branchTemplates.absence.text || '';
                    } else {
                        message = branchTemplates.absence.textAdult || branchTemplates.absence.text || '';
                    }
                    
                    if (!message || message.trim() === '') {
                        console.log('⚠️ Devamsızlık mesaj şablonu boş!');
                        failCount++;
                        continue;
                    }

                    // Replace template variables
                    const studentName = member.Resit_Olmayan_Adi_Soyadi || '';
                    const parentName = member.Ad_Soyad || 'Değerli Üyemiz';
                    const uyeName = isChild ? parentName : parentName;
                    
                    // Get lesson name from branch
                    const branch = branches.find(b => b.id === branchId);
                    const lessonName = branch ? branch.lessonName : absence.groupName;
                    
                    message = message.replace(/{UYE_AD_SOYAD}/g, uyeName);
                    message = message.replace(/{OGRENCI_AD_SOYAD}/g, studentName);
                    message = message.replace(/{TARIH}/g, formatDate(absence.date));
                    message = message.replace(/{DERS}/g, lessonName);
                    // Backward compatibility
                    message = message.replace(/{VELI_AD_SOYAD}/g, parentName);
                    message = message.replace(/{AD_SOYAD}/g, uyeName).replace(/{AD}/g, uyeName);

                    // ✅ Add message to queue instead of sending directly
                    const memberName = isChild ? studentName : parentName;
                    const queueResult = await addMessageToQueue(member.Telefon, message, device.instanceName, memberName);
                    
                    if (queueResult) {
                        console.log(`✅ Devamsızlık mesajı kuyruğa eklendi: ${memberName}`);
                        successCount++;
                    } else {
                        console.log(`❌ Devamsızlık mesajı kuyruğa eklenemedi: ${memberName}`);
                        failCount++;
                    }

                    // Small delay between queue additions
                    await new Promise(resolve => setTimeout(resolve, 200));

                } catch (error) {
                    console.error('Devamsızlık mesajı kuyruğa ekleme hatası:', error);
                    failCount++;
                }
            }

            console.log(`📊 Devamsızlık Mesajları Kuyruğa Eklendi: ${successCount} başarılı, ${failCount} başarısız`);
            
            if (successCount > 0) {
                setTimeout(() => {
                    showAlert(`✅ ${successCount} devamsızlık mesajı kuyruğa eklendi!`, 'success');
                    renderMessageQueue(); // Kuyruğu yenile
                }, 500);
            }
        }

        window.sendPendingRegistrationReminder = async function(preRegId) {
            try {
                // Find the preRegistration
                const preReg = preRegistrations.find(p => p.id === preRegId);
                if (!preReg) {
                    showAlert('Kayıt bulunamadı!', 'danger');
                    return;
                }

                if (!preReg.phone) {
                    showAlert('Telefon numarası bulunamadı!', 'danger');
                    return;
                }
                
                // ✅ Branş bilgisini al (member'dan veya preReg'den)
                const member = members.find(m => m.preRegistrationId === preRegId);
                const branchId = (member?.Brans || preReg.branch || 'tenis').toLowerCase();
                
                // ✅ Branşa göre şablonu kontrol et
                const branchTemplates = messageTemplates[branchId];
                if (!branchTemplates?.pendingRegistration || !branchTemplates.pendingRegistration.enabled) {
                    showAlert('Bekleyen kayıt hatırlatma şablonu etkinleştirilmemiş! Lütfen ayarlardan etkinleştirin.', 'warning');
                    return;
                }

                // ✅ Determine if child or adult - daha doğru kontrol
                const isChild = !!(preReg.parentName && preReg.studentName && preReg.parentName !== preReg.studentName);
                
                // Get template text based on type
                let message = '';
                if (isChild) {
                    message = branchTemplates.pendingRegistration.textChild || branchTemplates.pendingRegistration.text || '';
                } else {
                    message = branchTemplates.pendingRegistration.textAdult || branchTemplates.pendingRegistration.text || '';
                }
                
                if (!message || message.trim() === '') {
                    showAlert('Mesaj şablonu boş! Lütfen ayarlardan düzenleyin.', 'warning');
                    return;
                }

                // ✅ Replace template variables - yetişkin için studentName kullan
                const parentName = preReg.parentName || 'Değerli Velimiz';
                const studentName = preReg.studentName || '';
                const uyeName = isChild ? parentName : studentName; // Yetişkin için studentName
                
                // ✅ Kulüp adını link'e ekle (URL-friendly slug)
                const clubName = clubSettings?.clubName || currentUser?.clubName || 'Kulüp';
                const clubSlug = createSlug(clubName);
                const registrationLink = window.location.origin + '/uyeyeni/kayit?club=' + clubSlug;
                
                message = message.replace(/{UYE_AD_SOYAD}/g, uyeName);
                message = message.replace(/{OGRENCI_AD_SOYAD}/g, studentName);
                message = message.replace(/{LINK}/g, registrationLink);
                message = message.replace(/{TARIH}/g, formatDate(new Date().toISOString()));
                // Backward compatibility
                message = message.replace(/{VELI_AD_SOYAD}/g, parentName);
                message = message.replace(/{AD_SOYAD}/g, uyeName);

                // Find connected device
                let device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
                if (!device) {
                    device = whatsappDevices.find(d => d.status === 'connected');
                }
                
                if (!device) {
                    showAlert('Bağlı WhatsApp cihazı bulunamadı!', 'danger');
                    return;
                }

                // Confirm before sending - doğru ismi göster
                const displayName = isChild ? `${parentName} (Veli - ${studentName})` : studentName;
                if (!confirm(`${displayName} için kayıt hatırlatma mesajı gönderilsin mi?\n\nMesaj:\n${message}`)) {
                    return;
                }

                // Send message
                const result = await sendWhatsAppMessage(device.instanceName, preReg.phone, message, displayName);
                const success = result.success || result === true;

                if (success) {
                    showAlert('✅ Kayıt hatırlatma mesajı başarıyla gönderildi!', 'success');
                } else {
                    showAlert('❌ Mesaj gönderilemedi!', 'danger');
                }
            } catch (error) {
                console.error('Error sending registration reminder:', error);
                showAlert('Hata: ' + error.message, 'danger');
            }
        };

        window.sendPaymentReminderMessage = async function(preRegId, paymentNumber, reminderType) {
            try {
                console.log('🔍 ÖDEME HATİRLATMA BAŞLADI');
                console.log('  → defaultWhatsAppDevice:', defaultWhatsAppDevice);
                console.log('  → Mevcut cihazlar:', whatsappDevices.map(d => `${d.instanceName} (${d.status})`));
                
                // Find the preRegistration
                const preReg = preRegistrations.find(p => p.id === preRegId);
                if (!preReg) {
                    showAlert('Ödeme planı bulunamadı!', 'danger');
                    return;
                }

                // Find the specific payment
                const payment = preReg.paymentSchedule.find(p => p.paymentNumber === paymentNumber);
                if (!payment) {
                    showAlert('Ödeme bulunamadı!', 'danger');
                    return;
                }

                // Find the member
                const member = members.find(m => m.preRegistrationId === preRegId || m.Telefon === preReg.phone);
                if (!member || !member.Telefon) {
                    showAlert('Üye telefon numarası bulunamadı!', 'danger');
                    return;
                }

                // ✅ BRANŞ BAZLI ŞABLON KONTROLÜ (Diğer mesajlar gibi)
                const branchId = member.Brans || 'tenis'; // Varsayılan tenis
                const templateKey = reminderType === 'overdue' ? 'payment' : 'upcomingPayment';
                
                // Branş şablonunu kontrol et
                const branchTemplates = messageTemplates[branchId];
                if (!branchTemplates || !branchTemplates[templateKey] || !branchTemplates[templateKey].enabled) {
                    showAlert(`${reminderType === 'overdue' ? 'Gecikmiş' : 'Yaklaşan'} ödeme şablonu "${branchId}" branşı için etkinleştirilmemiş! Lütfen ayarlardan etkinleştirin.`, 'warning');
                    return;
                }

                // Check if member is a child
                const isChild = !!member.Resit_Olmayan_Adi_Soyadi;
                
                console.log('=== ÖDEME HATİRLATMA DEBUG ===');
                console.log('Member:', member);
                console.log('Branch ID:', branchId);
                console.log('isChild:', isChild);
                console.log('Resit_Olmayan_Adi_Soyadi:', member.Resit_Olmayan_Adi_Soyadi);
                console.log('Ad_Soyad:', member.Ad_Soyad);
                console.log('Template Key:', templateKey);
                console.log('Branch Templates:', branchTemplates[templateKey]);
                
                // ✅ Branş şablonundan mesaj al
                let message = '';
                if (isChild) {
                    message = branchTemplates[templateKey].textChild || branchTemplates[templateKey].text || '';
                    console.log('Using CHILD template from branch:', branchId);
                } else {
                    message = branchTemplates[templateKey].textAdult || branchTemplates[templateKey].text || '';
                    console.log('Using ADULT template from branch:', branchId);
                }
                
                console.log('Message template:', message.substring(0, 100));
                
                if (!message || message.trim() === '') {
                    showAlert('Mesaj şablonu boş! Lütfen ayarlardan düzenleyin.', 'warning');
                    return;
                }

                // Calculate days until/since due date
                const today = new Date();
                today.setHours(0,0,0,0);
                const dueDate = new Date(payment.dueDate + 'T00:00:00');
                const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

                // Replace template variables
                const studentName = member.Resit_Olmayan_Adi_Soyadi || '';
                const parentName = member.Ad_Soyad || 'Değerli Üyemiz';
                const uyeName = isChild ? parentName : parentName; // Yetişkinde kendisi, çocukta veli
                const memberName = isChild ? studentName : parentName; // Görünen isim
                
                message = message.replace(/{UYE_AD_SOYAD}/g, uyeName);
                message = message.replace(/{OGRENCI_AD_SOYAD}/g, studentName);
                // Backward compatibility
                message = message.replace(/{VELI_AD_SOYAD}/g, parentName);
                message = message.replace(/{AD_SOYAD}/g, uyeName).replace(/{AD}/g, uyeName);
                
                message = message.replace(/{TUTAR}/g, payment.amount.toLocaleString('tr-TR'));
                message = message.replace(/{TARIH}/g, formatDate(payment.dueDate));
                message = message.replace(/{VADE_TARIHI}/g, formatDate(payment.dueDate));
                message = message.replace(/{GUN_KALDI}/g, Math.abs(daysDiff).toString());
                message = message.replace(/{DONEM_BASLANGIC}/g, formatDate(payment.period.start));
                message = message.replace(/{DONEM_BITIS}/g, formatDate(payment.period.end));
                message = message.replace(/{DERS_SAYISI}/g, payment.period.lessonCount.toString());

                // Find connected device
                let device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
                console.log('  → Ana hatta eşleşen cihaz:', device ? device.instanceName : 'BULUNAMADI');
                
                if (!device) {
                    device = whatsappDevices.find(d => d.status === 'connected');
                    console.log('  → Fallback: İlk bağlı cihaz:', device ? device.instanceName : 'BULUNAMADI');
                }
                
                if (!device) {
                    showAlert('Bağlı WhatsApp cihazı bulunamadı!', 'danger');
                    return;
                }

                console.log('📱 ÖDEME HATİRLATMA - Kullanılacak cihaz:', device.instanceName);
                console.log('📱 Ana WhatsApp hattı:', defaultWhatsAppDevice);
                console.log('📱 SEÇİLEN CİHAZ DETAY:', device);

                // Confirm before sending
                if (!confirm(`${memberName} için ${reminderType === 'overdue' ? 'gecikmiş' : 'yaklaşan'} ödeme hatırlatma mesajı gönderilsin mi?\n\nCihaz: ${device.instanceName}\n\nMesaj:\n${message}`)) {
                    return;
                }

                // Send message
                const result = await sendWhatsAppMessage(device.instanceName, member.Telefon, message, memberName);
                const success = result.success || result === true;
                
                if (success) {
                    showAlert('Mesaj başarıyla gönderildi! ✅', 'success');
                } else {
                    const errorMsg = result.errorReason ? ` Neden: ${result.errorReason}` : '';
                    showAlert(`Mesaj gönderilemedi.${errorMsg}`, 'danger');
                }
            } catch (error) {
                console.error('Error sending payment reminder:', error);
                showAlert('Mesaj gönderilirken hata oluştu: ' + error.message, 'danger');
            }
        };

        // ✅ Gecikmiş ödemelere Toplu Mesaj gönderme
        window.sendBulkOverdueReminders = async function() {
            try {
                // Find connected device
                let device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
                if (!device) {
                    device = whatsappDevices.find(d => d.status === 'connected');
                }
                
                if (!device) {
                    showAlert('Bağlı WhatsApp cihazı bulunamadı!', 'danger');
                    return;
                }

                console.log('💰 TOPLU GECİKMİŞ AİDAT - Kullanılacak cihaz:', device.instanceName);
                console.log('💰 Ana WhatsApp hattı:', defaultWhatsAppDevice);

                // Find all members with overdue payments
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const overdueList = [];
                
                for (const member of members) {
                    const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                    if (!preReg || !preReg.paymentSchedule || !member.Telefon) continue;
                    
                    const overduePayments = preReg.paymentSchedule.filter(p => {
                        const dueDate = new Date(p.dueDate + 'T00:00:00');
                        return p.status === 'unpaid' && dueDate < today;
                    });
                    
                    if (overduePayments.length > 0) {
                        // ✅ Branş bazlı şablon kontrolü
                        const branchId = member.Brans || 'tenis';
                        const branchTemplates = messageTemplates[branchId];
                        
                        // Şablon aktif mi kontrol et
                        if (branchTemplates && branchTemplates.payment && branchTemplates.payment.enabled) {
                            overdueList.push({
                                member,
                                preReg,
                                payments: overduePayments,
                                oldestPayment: overduePayments[0], // En eski gecikmiş ödeme
                                branchId // Branş ID'yi ekle
                            });
                        }
                    }
                }
                
                if (overdueList.length === 0) {
                    showAlert('Gecikmiş ödemesi olan ve şablonu aktif üye bulunamadı. Lütfen ayarlardan ilgili branşın gecikmiş ödeme şablonunu etkinleştirin.', 'info');
                    return;
                }
                
                // Calculate total overdue amount
                const totalOverdueAmount = overdueList.reduce((sum, item) => {
                    return sum + item.payments.reduce((paymentSum, p) => paymentSum + p.amount, 0);
                }, 0);
                
                // Confirm before sending
                const confirmMsg = `${overdueList.length} üyeye gecikmiş ödeme hatırlatması gönderilecek.\n\nToplam gecikmiş tutar: ${totalOverdueAmount.toLocaleString('tr-TR')}₺\n\nDevam etmek istiyor musunuz?`;
                if (!confirm(confirmMsg)) {
                    return;
                }
                
                // Show progress
                showAlert(`${overdueList.length} üyeye mesaj gönderiliyor...`, 'info');
                
                let successCount = 0;
                let failCount = 0;
                
                // ✅ Helper function - Random bekleme süresi hesaplama
                const getRandomWaitTime = (messageCount) => {
                    const shouldLongWait = (messageCount % clubSettings.longWaitTrigger) === 0 && messageCount > 0;
                    
                    if (shouldLongWait) {
                        // Uzun bekleme
                        const min = clubSettings.minLongWait * 1000;
                        const max = clubSettings.maxLongWait * 1000;
                        return Math.floor(Math.random() * (max - min + 1)) + min;
                    } else {
                        // Normal bekleme
                        const min = clubSettings.minWaitTime * 1000;
                        const max = clubSettings.maxWaitTime * 1000;
                        return Math.floor(Math.random() * (max - min + 1)) + min;
                    }
                };
                
                // Send messages
                let messageCount = 0;
                for (const item of overdueList) {
                    try {
                        const { member, preReg, oldestPayment, branchId } = item;
                        const isChild = !!member.Resit_Olmayan_Adi_Soyadi;
                        
                        // ✅ Branş şablonunu kullan
                        const branchTemplates = messageTemplates[branchId];
                        let message = isChild 
                            ? (branchTemplates.payment.textChild || branchTemplates.payment.text || '')
                            : (branchTemplates.payment.textAdult || branchTemplates.payment.text || '');
                        
                        if (!message || message.trim() === '') {
                            failCount++;
                            continue;
                        }
                        
                        // Calculate days overdue
                        const dueDate = new Date(oldestPayment.dueDate + 'T00:00:00');
                        const daysDiff = Math.ceil((today - dueDate) / (1000 * 60 * 60 * 24));
                        
                        // Replace template variables
                        const studentName = member.Resit_Olmayan_Adi_Soyadi || '';
                        const parentName = member.Ad_Soyad || 'Değerli Üyemiz';
                        const uyeName = isChild ? parentName : parentName;
                        const memberName = isChild ? studentName : parentName;
                        
                        message = message.replace(/{UYE_AD_SOYAD}/g, uyeName);
                        message = message.replace(/{OGRENCI_AD_SOYAD}/g, studentName);
                        message = message.replace(/{VELI_AD_SOYAD}/g, parentName);
                        message = message.replace(/{AD_SOYAD}/g, uyeName).replace(/{AD}/g, uyeName);
                        message = message.replace(/{TUTAR}/g, oldestPayment.amount.toLocaleString('tr-TR'));
                        message = message.replace(/{TARIH}/g, formatDate(oldestPayment.dueDate));
                        message = message.replace(/{VADE_TARIHI}/g, formatDate(oldestPayment.dueDate));
                        message = message.replace(/{GUN_KALDI}/g, daysDiff.toString());
                        message = message.replace(/{DONEM_BASLANGIC}/g, formatDate(oldestPayment.period.start));
                        message = message.replace(/{DONEM_BITIS}/g, formatDate(oldestPayment.period.end));
                        message = message.replace(/{DERS_SAYISI}/g, oldestPayment.period.lessonCount.toString());
                        
                        // Send message
                        const result = await sendWhatsAppMessage(device.instanceName, member.Telefon, message, memberName);
                        const success = result.success || result === true;
                        
                        if (success) {
                            successCount++;
                            messageCount++;
                        } else {
                            failCount++;
                        }
                        
                        // ✅ Random bekleme süresi (ayarlardan)
                        if (messageCount < overdueList.length) {
                            const waitTime = getRandomWaitTime(messageCount);
                            const waitSeconds = (waitTime / 1000).toFixed(1);
                            console.log(`⏳ ${waitSeconds} saniye bekleniyor... (${messageCount}/${overdueList.length})`);
                            await new Promise(resolve => setTimeout(resolve, waitTime));
                        }
                        
                    } catch (error) {
                        console.error('Error sending message to member:', item.member.id, error);
                        failCount++;
                    }
                }
                
                // Show results
                const resultMsg = `Toplu mesaj gönderimi tamamlandı!\n\n✅ Başarılı: ${successCount}\n❌ Başarısız: ${failCount}`;
                showAlert(resultMsg, successCount > 0 ? 'success' : 'warning');
                
            } catch (error) {
                console.error('Error in bulk overdue reminders:', error);
                showAlert('Toplu mesaj gönderilirken hata oluştu: ' + error.message, 'danger');
            }
        };

        async function handleProfileUpdate(e) {
            e.preventDefault();
            const form = e.target;
            const fullName = form.fullName.value;
            const phone = form.phone.value.replace(/\D/g, ''); // Remove non-digits
            const newPassword = form.newPassword.value;
            const confirmPassword = form.confirmPassword.value;

            if (newPassword && newPassword !== confirmPassword) {
                return showAlert('Şifreler eşleşmiyor.', 'warning');
            }
            
            const updateData = { 
                fullName,
                phone: phone,
                phoneNumber: phone, // For WhatsApp notifications
                username: phone || currentUser.username
            };
            
            if (newPassword) {
                updateData.password = newPassword;
            }

            try {
                const userDoc = users.find(u => u.username === currentUser.username);
                if (!userDoc) throw new Error("Current user document not found.");

                await window.firebase.updateDoc(window.firebase.doc(window.db, 'users', userDoc.id), updateData);
                
                // Update local current user object
                currentUser.fullName = fullName;
                currentUser.phone = phone;
                currentUser.phoneNumber = phone;
                if(newPassword) currentUser.password = newPassword;
                document.querySelector('.current-user-display').textContent = `Hoşgeldiniz, ${currentUser.fullName}`;

                showAlert('Profiliniz başarıyla güncellendi.', 'success');
                closeModal('profileModal');
                await loadData(); // Reload all users data
            } catch (error) {
                console.error("Profile update error:", error);
                showAlert('Profil güncellenirken bir hata oluştu.', 'danger');
            }
        }
        
        // --- RENDER FUNCTIONS ---
        function renderPreRegistrationTable() {
            const tbody = document.getElementById('preRegistrationTable');
            if (!tbody) return;
            
            // SADECE pending_contract durumundaki preRegistration kayıtlarını göster
            let pendingPreRegs = preRegistrations.filter(p => p.status === 'pending_contract');

            // Uygun branşlara göre filtrele
            pendingPreRegs = filterByBranch(pendingPreRegs, 'branch');
            
            if (pendingPreRegs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="empty-state"><h3>Beklemede olan kayıt bulunmuyor.</h3></td></tr>`;
                return;
            }
            
            // ✅ PERFORMANCE: Member'ları preRegId ve phone'a göre indexle (O(1) lookup)
            const normalizePhone = (phone) => phone ? phone.replace(/\D/g, '').replace(/^0/, '').replace(/^90/, '') : '';
            const memberByPreRegId = new Map();
            const memberByPhone = new Map();
            members.forEach(m => {
                if (m.preRegistrationId) memberByPreRegId.set(m.preRegistrationId, m);
                if (m.Telefon) memberByPhone.set(normalizePhone(m.Telefon), m);
            });
            
            // ✅ PERFORMANCE: Groups'ları member ID'sine göre indexle (O(1) lookup)
            const groupsByMemberId = new Map();
            groups.forEach(g => {
                if (g.members && Array.isArray(g.members)) {
                    g.members.forEach(memberId => {
                        if (!groupsByMemberId.has(memberId)) groupsByMemberId.set(memberId, []);
                        groupsByMemberId.get(memberId).push(g);
                    });
                }
            });
            
            tbody.innerHTML = '';
            pendingPreRegs.forEach(preReg => {
                // ✅ PERFORMANCE: O(1) member lookup
                const member = memberByPreRegId.get(preReg.id) || 
                               (preReg.phone ? memberByPhone.get(normalizePhone(preReg.phone)) : null);
                
                // ✅ Sadece aktif veya pasif üyeleri atla, bekliyor durumundakileri göster
                if (member && member.status === 'active') {
                    return; // Aktif üyeleri atla
                }
                if (member && member.status === 'expired') {
                    return; // Pasif üyeleri atla
                }
                // member.status === 'pending' olanlar veya member olmayan ön kayıtlar gösterilecek
                
                // ✅ PERFORMANCE: O(1) groups lookup
                const memberGroups = member && member.id ? (groupsByMemberId.get(member.id) || []) : [];
                
                const row = document.createElement('tr');
                const dropdownItems = [];
                
                if (member && member.id) {
                    dropdownItems.push(`<button onclick="event.stopPropagation(); window.assignToGroup('${member.id}')">👥 Grup Ata</button>`);
                    dropdownItems.push(`<button onclick="event.stopPropagation(); window.openMemberEditForm('${member.id}')">✏️ Üye Düzenle</button>`);
                }
                dropdownItems.push(`<button onclick="event.stopPropagation(); window.openPreRegEditModal('${preReg.id}')">✏️ Ön Kayıt Düzenle</button>`);
                dropdownItems.push(`<button onclick="event.stopPropagation(); window.viewPaymentPlan('${preReg.id}')">💰 Ödeme Planı</button>`);
                // Kayıt hatırlatma butonu
                if (preReg.phone) {
                    dropdownItems.push(`<button style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="event.stopPropagation(); window.sendPendingRegistrationReminder('${preReg.id}')">📧 Kayıt Hatırlat</button>`);
                }
                if (member && member.id) {
                    dropdownItems.push(`<button class="danger" onclick="event.stopPropagation(); window.deleteItem('members', '${member.id}')">🗑️ Üyeyi Sil</button>`);
                }
                dropdownItems.push(`<button class="danger" onclick="event.stopPropagation(); window.deleteItem('preRegistrations', '${preReg.id}')">🗑️ Ön Kaydı Sil</button>`);
                
                const displayName = preReg.studentName || preReg.parentName || 'İsimsiz';
                const parentName = preReg.studentName && preReg.parentName ? preReg.parentName : '-';
                const phone = preReg.phone || (member ? member.Telefon : '-');
                const branch = preReg.branch || (member ? member.Brans : '-');
                const statusValue = member ? member.status : 'pending';
                
                row.innerHTML = `
                    <td>${displayName}</td>
                    <td>${parentName}</td>
                    <td><a href="#" class="phone-link">${formatPhoneDisplay(phone)}</a></td>
                    <td>${branch === 'tenis' ? '🎾' : '🏊'} ${capitalize(branch)}</td>
                    <td>
                        ${member ? `<select class="status-badge status-${statusValue} member-status-select" data-member-id="${member.id}">
                            <option value="pending" ${statusValue === 'pending' ? 'selected' : ''}>Bekliyor</option>
                            <option value="active" ${statusValue === 'active' ? 'selected' : ''}>Aktif</option>
                            <option value="expired" ${statusValue === 'expired' ? 'selected' : ''}>Pasif</option>
                        </select>` : `<span class="status-badge status-pending">Üye Oluşturulmamış</span>`}
                    </td>
                    <td>${memberGroups.length > 0 ? memberGroups.map(g => g.groupName).join('<br>') : '❌ Atanmamış'}</td>
                    <td class="actions-cell">
                        <div class="actions-dropdown">
                            <button class="actions-dropdown-btn" type="button">⚙️ İşlemler ▼</button>
                            <div class="actions-dropdown-content">
                                ${dropdownItems.join('')}
                            </div>
                        </div>
                    </td>
                `;
                
                // Event listeners
                const phoneLink = row.querySelector('.phone-link');
                if (phoneLink && phone !== '-') {
                    phoneLink.addEventListener('click', (e) => handlePhoneClick(e, phone));
                }
                
                const statusSelect = row.querySelector('.member-status-select');
                if (statusSelect && member) {
                    statusSelect.addEventListener('change', function(e) {
                        e.stopPropagation();
                        const memberId = this.dataset.memberId || member.id;
                        const newStatus = this.value;
                        console.log('Durum değiştiriliyor:', memberId, newStatus);
                        updateMemberStatus(memberId, newStatus);
                    });
                }
                
                tbody.appendChild(row);
            });
        }

        function loadInactiveMembers() {
            renderInactiveMembersTable();
        }
        
        window.loadInactiveMembers = loadInactiveMembers;
        
        function renderInactiveMembersTable() {
            // Render Bekleyen Üyeler (pending)
            const pendingTbody = document.getElementById('pendingMembersTable');
            if (pendingTbody) {
                let pendingMembers = members.filter(m => m.status === 'pending');
                // ✅ BRANŞ FİLTRESİ: Sadece yetkili branşları göster
                pendingMembers = filterByBranch(pendingMembers, 'Brans');
                
                pendingTbody.innerHTML = pendingMembers.length === 0
                    ? `<tr><td colspan="6" class="empty-state"><h3>Bekleyen üye bulunmuyor.</h3></td></tr>`
                    : pendingMembers.map(member => {
                        const dropdownItems = [];
                        dropdownItems.push(`<button onclick="event.stopPropagation(); window.openMemberEditForm('${member.id}')">✏️ Üye Düzenle</button>`);
                        dropdownItems.push(`<button onclick="event.stopPropagation(); window.showMemberAttendancePage('${member.id}')">📋 Yoklama Kayıtları</button>`);
                        const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                        if (preReg && preReg.id) {
                            dropdownItems.push(`<button onclick="event.stopPropagation(); window.viewPaymentPlan('${preReg.id}')">💰 Ödeme Planı</button>`);
                            // Kayıt hatırlatma butonu
                            if (member.Telefon) {
                                dropdownItems.push(`<button style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="event.stopPropagation(); window.sendPendingRegistrationReminder('${preReg.id}')">📧 Kayıt Hatırlat</button>`);
                            }
                        }
                        dropdownItems.push(`<button class="danger" onclick="event.stopPropagation(); window.deleteItem('members', '${member.id}')">🗑️ Sil</button>`);
                        
                        return `
                        <tr>
                            <td>${member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad}</td>
                            <td>${member.Ad_Soyad && member.Resit_Olmayan_Adi_Soyadi ? member.Ad_Soyad : '-'}</td>
                            <td><a href="#" class="phone-link" onclick="window.handlePhoneClick(event, '${member.Telefon}')">${member.Telefon}</a></td>
                            <td>${member.Brans === 'tenis' ? '🎾' : '🏊'} ${capitalize(member.Brans)}</td>
                            <td>
                                <select class="status-badge status-pending" onchange="window.updateMemberStatus('${member.id}', this.value)">
                                    <option value="pending" selected>Bekliyor</option>
                                    <option value="active">Aktif</option>
                                    <option value="expired">Pasif</option>
                                </select>
                            </td>
                            <td class="actions-cell">
                                <div class="actions-dropdown">
                                    <button class="actions-dropdown-btn" type="button">⚙️ İşlemler ▼</button>
                                    <div class="actions-dropdown-content">
                                        ${dropdownItems.join('')}
                                    </div>
                                </div>
                            </td>
                        </tr>`}).join('');
            }
            
            // Render Pasif Üyeler (expired)
            const inactiveTbody = document.getElementById('inactiveMembersTable');
            if (inactiveTbody) {
                let inactiveMembers = members.filter(m => m.status === 'expired');
                // ✅ BRANŞ FİLTRESİ: Sadece yetkili branşları göster
                inactiveMembers = filterByBranch(inactiveMembers, 'Brans');
                
                inactiveTbody.innerHTML = inactiveMembers.length === 0
                    ? `<tr><td colspan="6" class="empty-state"><h3>Pasif üye bulunmuyor.</h3></td></tr>`
                    : inactiveMembers.map(member => {
                        const dropdownItems = [];
                        dropdownItems.push(`<button onclick="event.stopPropagation(); window.openMemberEditForm('${member.id}')">✏️ Üye Düzenle</button>`);
                        dropdownItems.push(`<button onclick="event.stopPropagation(); window.showMemberAttendancePage('${member.id}')">📋 Yoklama Kayıtları</button>`);
                        const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                        if (preReg && preReg.id) {
                            dropdownItems.push(`<button onclick="event.stopPropagation(); window.viewPaymentPlan('${preReg.id}')">💰 Ödeme Planı</button>`);
                        }
                        dropdownItems.push(`<button class="danger" onclick="event.stopPropagation(); window.deleteItem('members', '${member.id}')">🗑️ Sil</button>`);
                        
                        return `
                        <tr>
                            <td>${member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad}</td>
                            <td>${member.Ad_Soyad && member.Resit_Olmayan_Adi_Soyadi ? member.Ad_Soyad : '-'}</td>
                            <td><a href="#" class="phone-link" onclick="window.handlePhoneClick(event, '${member.Telefon}')">${member.Telefon}</a></td>
                            <td>${member.Brans === 'tenis' ? '🎾' : '🏊'} ${capitalize(member.Brans)}</td>
                            <td>
                                <select class="status-badge status-expired" onchange="window.updateMemberStatus('${member.id}', this.value)">
                                    <option value="pending">Bekliyor</option>
                                    <option value="active">Aktif</option>
                                    <option value="expired" selected>Pasif</option>
                                </select>
                            </td>
                            <td class="actions-cell">
                                <div class="actions-dropdown">
                                    <button class="actions-dropdown-btn" type="button">⚙️ İşlemler ▼</button>
                                    <div class="actions-dropdown-content">
                                        ${dropdownItems.join('')}
                                    </div>
                                </div>
                            </td>
                        </tr>`}).join('');
            }
        }
        
        // ✅ Üye listesi otomatik yenileme ve bildirim
        let membersAutoRefreshInterval = null;
        let lastMemberCount = 0;
        
        function startMembersAutoRefresh() {
            if (membersAutoRefreshInterval) return;
            
            lastMemberCount = members.length;
            console.log('🔄 Üye listesi otomatik yenileme başlatıldı');
            
            membersAutoRefreshInterval = setInterval(async () => {
                if (currentSection !== 'members') return;
                
                const oldCount = members.length;
                await loadData(false); // Cache kullanma, fresh data al
                const newCount = members.length;
                
                if (newCount > oldCount) {
                    const diff = newCount - oldCount;
                    console.log(`🆕 ${diff} yeni üye eklendi!`);
                    
                    // Bildirim göster
                    showAlert(`🎉 ${diff} yeni üye eklendi!`, 'success');
                    
                    // Listeyi yenile
                    renderMembersTable();
                }
            }, 30000); // 30 saniyede bir
        }
        
        function stopMembersAutoRefresh() {
            if (membersAutoRefreshInterval) {
                clearInterval(membersAutoRefreshInterval);
                membersAutoRefreshInterval = null;
                console.log('⏹️ Üye listesi otomatik yenileme durduruldu');
            }
        }
        
        function renderMembersTable() {
            const tbody = document.getElementById('membersTable');
            const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
            if (!tbody) return;

            // Combine members and pending preRegistrations
            // Create pseudo-members from pending preRegistrations
            const pendingPreRegs = preRegistrations.filter(p => {
                if (p.status !== 'pending_contract') return false;
                
                // Eğer bu preReg için zaten member varsa ekleme
                const existingMember = members.find(m => 
                    m.preRegistrationId === p.id || 
                    (m.Telefon && p.phone && m.Telefon.replace(/\D/g, '').replace(/^0/, '') === p.phone.replace(/\D/g, '').replace(/^0/, ''))
                );
                
                return !existingMember;
            }).map(p => ({
                id: 'prereg_' + p.id,
                preRegistrationId: p.id,
                Ad_Soyad: p.parentName || 'Belirtilmemiş',
                Resit_Olmayan_Adi_Soyadi: p.studentName || '',
                Telefon: p.phone || '',
                Telefon_2: '',
                Brans: p.branch || '',
                status: 'pending',
                studentBirthDate: null,
                isPseudoMember: true // Flag to identify pseudo-members
            }));
            
            // Combine actual members with pseudo-members from preRegs
            let combinedMembers = [...members, ...pendingPreRegs];

            // Apply branch-level filtering so users see only authorized branches
            combinedMembers = filterByBranch(combinedMembers, 'Brans');

            // 1. Filtering (Search) - Happens first on the entire dataset
            let filteredMembers = combinedMembers.filter(member => {
                const name = member.Ad_Soyad || '';
                const studentName = member.Resit_Olmayan_Adi_Soyadi || '';
                const phone = member.Telefon || '';
                return name.toLowerCase().includes(searchTerm) || 
                       studentName.toLowerCase().includes(searchTerm) ||
                       phone.includes(searchTerm);
            });

            // Separate passive members
            const passiveMembers = filteredMembers.filter(m => m.status === 'expired');
            let activeAndPendingMembers = filteredMembers.filter(m => m.status !== 'expired');

            // 2. Sorting (apply only to non-passive members)
            const ageHeader = document.querySelector('#membersTable thead th[onclick*="sortMembersByAge"]');
            if (ageHeader) {
                ageHeader.innerHTML = 'Yaş'; // Reset header
                if (ageSortDirection === 'asc') {
                    ageHeader.innerHTML += ' ▲';
                    activeAndPendingMembers.sort((a, b) => {
                        const ageA = a.studentBirthDate ? calculateAge(a.studentBirthDate) : Infinity;
                        const ageB = b.studentBirthDate ? calculateAge(b.studentBirthDate) : Infinity;
                        return ageA - ageB;
                    });
                } else if (ageSortDirection === 'desc') {
                    ageHeader.innerHTML += ' ▼';
                    activeAndPendingMembers.sort((a, b) => {
                        const ageA = a.studentBirthDate ? calculateAge(a.studentBirthDate) : -Infinity;
                        const ageB = b.studentBirthDate ? calculateAge(b.studentBirthDate) : -Infinity;
                        return ageB - ageA;
                    });
                }
            }
            
            // Re-combine the lists with passive members at the end
            const sortedMembers = [...activeAndPendingMembers, ...passiveMembers];

            // 3. Pagination
            const totalPages = Math.ceil(sortedMembers.length / membersItemsPerPage);
            const startIndex = (membersCurrentPage - 1) * membersItemsPerPage;
            const endIndex = startIndex + membersItemsPerPage;
            const paginatedMembers = sortedMembers.slice(startIndex, endIndex);


            // Update pagination controls UI
            document.getElementById('pageInfo').textContent = `Sayfa ${membersCurrentPage} / ${totalPages > 0 ? totalPages : 1}`;
            document.getElementById('prevPageBtn').disabled = membersCurrentPage === 1;
            document.getElementById('nextPageBtn').disabled = membersCurrentPage >= totalPages;


            tbody.innerHTML = paginatedMembers.length === 0 
                ? `<tr><td colspan="8" class="empty-state"><h3>Üye bulunamadı.</h3></td></tr>`
                : paginatedMembers.map(member => {
                    const memberGroups = groups.filter(g => Array.isArray(g.members) && g.members.includes(member.id));
                    
                    let nameCell, parentCell, ageCell;
                    let phoneHtml = `<div style="white-space: nowrap;"><a href="#" class="phone-link" onclick="handlePhoneClick(event, '${member.Telefon}')">${formatPhoneDisplay(member.Telefon)}</a></div>`;
                    if(member.Telefon_2) {
                        phoneHtml += `<div style="white-space: nowrap; margin-top: 4px;"><a href="#" class="phone-link" onclick="handlePhoneClick(event, '${member.Telefon_2}')">${formatPhoneDisplay(member.Telefon_2)}</a></div>`;
                    }


                    if (member.Resit_Olmayan_Adi_Soyadi && member.Resit_Olmayan_Adi_Soyadi.trim() !== '') { // It's a child
                        let veliHtml = capitalizeWords(member.Ad_Soyad);
                        if (member.Veli_2_Adi_Soyadi) {
                            veliHtml += `<br>${capitalizeWords(member.Veli_2_Adi_Soyadi)}`;
                        }
                        // Pseudo-member için tıklanabilir link olmasın
                        if (member.isPseudoMember) {
                            nameCell = `<td><strong>${capitalizeWords(member.Resit_Olmayan_Adi_Soyadi)}</strong></td>`;
                        } else {
                            nameCell = `<td><a href="#" class="member-name-link" onclick="event.preventDefault(); showMemberAttendancePage('${member.id}')"><strong>${capitalizeWords(member.Resit_Olmayan_Adi_Soyadi)}</strong></a></td>`;
                        }
                        parentCell = `<td>${veliHtml}</td>`;
                        const birthDate = member.studentBirthDate;
                        const age = birthDate ? calculateAge(birthDate) : null; 
                        ageCell = `<td>${age !== null ? age : 'Çocuk'}</td>`;
                    } else { // It's an adult
                        // Pseudo-member için tıklanabilir link olmasın
                        if (member.isPseudoMember) {
                            nameCell = `<td><strong>${capitalizeWords(member.Ad_Soyad)}</strong></td>`;
                        } else {
                            nameCell = `<td><a href="#" class="member-name-link" onclick="event.preventDefault(); showMemberAttendancePage('${member.id}')"><strong>${capitalizeWords(member.Ad_Soyad)}</strong></a></td>`;
                        }
                        parentCell = `<td>-</td>`;
                        ageCell = `<td>Yetişkin</td>`;
                    }
                    
                    // Pseudo-member (pending preRegistration) için farklı UI
                    const statusCell = member.isPseudoMember 
                        ? `<td><span class="status-badge status-pending">⏳ Bekleyen Kayıt</span></td>`
                        : `<td><select class="status-badge status-${member.status || 'pending'}" onchange="updateMemberStatus('${member.id}', this.value)">
                                <option value="pending" ${member.status === 'pending' ? 'selected' : ''}>Bekliyor</option>
                                <option value="active" ${member.status === 'active' ? 'selected' : ''}>Aktif</option>
                                <option value="expired" ${member.status === 'expired' ? 'selected' : ''}>Pasif</option>
                            </select></td>`;
                    
                    const actionsCell = member.isPseudoMember
                        ? `<td>
                            <div class="actions-dropdown">
                                <button class="actions-dropdown-btn" onclick="event.stopPropagation();">⚙️ İşlemler</button>
                                <div class="actions-dropdown-content">
                                    <button onclick="event.stopPropagation(); window.openPreRegEditModal('${member.preRegistrationId}'); setTimeout(() => { document.querySelector('.actions-dropdown-content').style.display = 'none'; }, 100);">✏️ Ön Kayıt Düzenle</button>
                                    <button onclick="event.stopPropagation(); window.deleteItem('preRegistration', '${member.preRegistrationId}'); setTimeout(() => { document.querySelector('.actions-dropdown-content').style.display = 'none'; }, 100);">🗑️ Sil</button>
                                </div>
                            </div>
                        </td>`
                        : `<td>
                            <div class="actions-container">
                                <button class="btn btn-secondary btn-sm actions-toggle"
                                    data-type="member"
                                    data-member-id="${member.id}"
                                    onclick="toggleActionsMenu(event)">•••</button>
                            </div>
                        </td>`;
                    
                    return `
                        <tr>
                            ${nameCell}
                            ${parentCell}
                            <td>${phoneHtml}</td>
                             ${ageCell}
                            <td>${member.Brans === 'tenis' ? '🎾' : '🏊'} ${capitalize(member.Brans)}</td>
                            ${statusCell}
                            <td>${memberGroups.length > 0 ? memberGroups.map(g => g.groupName).join('<br>') : '❌ Atanmamış'}</td>
                            ${actionsCell}
                        </tr>`;
                }).join('');
        }

        function renderPaymentsList() {
            const container = document.getElementById('member-payment-list');
            const searchTerm = document.getElementById('paymentSearch').value.toLowerCase();
            if (!container) return;
            
            // ✅ KARDEŞ KORUMALI SYNC CHECK
            // Sadece preRegistrationId yok veya geçersiz olan üyeler için çalışır
            // Mevcut geçerli preRegistrationId'lere ASLA dokunmaz (kardeş koruması)
            const syncLog = { protected: 0, assigned: 0, skipped: 0 };
            
            members.forEach(member => {
                if (!member.Telefon) return;
                
                // ⭐ KARDEŞ KORUMASI: Mevcut preReg geçerli mi kontrol et
                if (member.preRegistrationId) {
                    const existingPreReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                    if (existingPreReg) {
                        // Geçerli preReg var, DOKUNMA!
                        syncLog.protected++;
                        return;
                    }
                    // preReg bulunamadı (silinmiş), aşağıda yenisini bul
                }
                
                // Buraya kadar geldiysek: preRegistrationId yok VEYA silinmiş
                // Telefona göre uygun preReg bul
                const normalizedPhone = member.Telefon.replace(/\D/g, '');
                const matchingPreRegs = preRegistrations.filter(p => {
                    if (!p.phone) return false;
                    const pPhone = p.phone.replace(/\D/g, '');
                    return pPhone === normalizedPhone || 
                           pPhone === '90' + normalizedPhone ||
                           pPhone === normalizedPhone.replace(/^90/, '') ||
                           pPhone === normalizedPhone.replace(/^0/, '');
                });
                
                if (matchingPreRegs.length === 0) {
                    syncLog.skipped++;
                    return; // Eşleşme yok
                }
                
                // Tek eşleşme varsa, direkt ata
                if (matchingPreRegs.length === 1) {
                    member.preRegistrationId = matchingPreRegs[0].id;
                    syncLog.assigned++;
                } 
                // Birden fazla eşleşme (KARDEŞLER) - isim eşleşmesine göre bul
                else {
                    const memberName = (member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad || '').toLowerCase().trim();
                    const bestMatch = matchingPreRegs.find(p => {
                        const studentName = (p.studentName || '').toLowerCase().trim();
                        const parentName = (p.parentName || p.name || '').toLowerCase().trim();
                        return studentName === memberName || parentName === memberName;
                    });
                    
                    if (bestMatch) {
                        member.preRegistrationId = bestMatch.id;
                        syncLog.assigned++;
                    } else {
                        syncLog.skipped++;
                    }
                    // İsim eşleşmesi yoksa, mevcut preReg'i koru (hiçbir şey yapma)
                }
            });
            
            console.log('🛡️ Sync Check Özeti:', {
                'Korunan (değiştirilmedi)': syncLog.protected,
                'Yeni atanan': syncLog.assigned,
                'Atlanadı': syncLog.skipped
            });
            
            // ✅ Sync check sonrası istatistik hesapla (doğru verilerle)
            updatePaymentStats();
            
            // ✅ İSTATİSTİK İLE AYNI LİSTE: activeMembers kullan (istatistik hesaplama ile tutarlılık için)
            // SADECE aktif/pending üyeleri ve preReg'i olanları göster
            let activeMembersForFilter = members.filter(member => {
                // Silinen, olmayan veya pasif üyeleri gösterme
                if (!member || !member.id) return false;
                if (member.status !== 'active' && member.status !== 'pending') return false;
                
                // PreReg kontrolü - preReg'i olmayan üyeleri gösterme
                if (!member.preRegistrationId) return false;
                const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                // ✅ İSTATİSTİK İLE AYNI FİLTRE: paymentSchedule.length > 0 kontrolü
                if (!preReg || !preReg.paymentSchedule || preReg.paymentSchedule.length === 0) return false;
                return true;
            });
            
            // ✅ BRANŞ FİLTRESİ: Sadece yetkili branşların ödemelerini göster
            activeMembersForFilter = filterByBranch(activeMembersForFilter, 'Brans');
            
            // Arama filtresini ayrıca uygula
            let allMembers = activeMembersForFilter.filter(member => {
                // Arama filtresi - boş ise tümünü göster
                if (!searchTerm || searchTerm === '') return true;
                
                const name = (member.Ad_Soyad || '').toLowerCase();
                const studentName = (member.Resit_Olmayan_Adi_Soyadi || '').toLowerCase();
                const phone = (member.Telefon || '').toLowerCase();
                const searchLower = searchTerm.toLowerCase();
                
                return name.includes(searchLower) || 
                       studentName.includes(searchLower) ||
                       phone.includes(searchLower);
            });


            let filteredMembers = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const memberHasRelevantPayment = (member, condition) => {
                const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                return preReg && preReg.paymentSchedule && preReg.paymentSchedule.some(condition);
            };

            if (paymentFilter === 'overdue') {
                // ✅ İSTATİSTİK İLE AYNI MANTIK: activeMembersForFilter kullan (arama filtresi olmadan)
                // Önce arama filtresi olmadan gecikmiş ödemesi olanları bul
                const overdueMembers = activeMembersForFilter.filter(m => {
                    const preReg = preRegistrations.find(p => p.id === m.preRegistrationId);
                    if (!preReg || !preReg.paymentSchedule) return false;
                    return preReg.paymentSchedule.some(p => p.status === 'unpaid' && new Date(p.dueDate + 'T00:00:00') < today);
                });
                
                // Sonra arama filtresini uygula
                filteredMembers = overdueMembers.filter(member => {
                    // Arama filtresi - boş ise tümünü göster
                    if (!searchTerm || searchTerm === '') return true;
                    
                    const name = (member.Ad_Soyad || '').toLowerCase();
                    const studentName = (member.Resit_Olmayan_Adi_Soyadi || '').toLowerCase();
                    const phone = (member.Telefon || '').toLowerCase();
                    const searchLower = searchTerm.toLowerCase();
                    
                    return name.includes(searchLower) || 
                           studentName.includes(searchLower) ||
                           phone.includes(searchLower);
                });
                
                // Debug için
                const debugOverdue = [];
                activeMembersForFilter.forEach(m => {
                    const preReg = preRegistrations.find(p => p.id === m.preRegistrationId);
                    if (preReg && preReg.paymentSchedule) {
                        const hasOverdue = preReg.paymentSchedule.some(p => p.status === 'unpaid' && new Date(p.dueDate + 'T00:00:00') < today);
                        debugOverdue.push({
                            name: m.Ad_Soyad,
                            hasOverdue: hasOverdue,
                            preRegId: m.preRegistrationId,
                            scheduleLength: preReg.paymentSchedule.length
                        });
                    }
                });
                
                console.log('🔍 [LİSTE] Gecikmiş ödeme filtresi:', {
                    'Toplam aktif üye (arama filtresi olmadan)': activeMembersForFilter.length,
                    'Gecikmiş ödemesi olan üye sayısı (arama filtresi olmadan)': overdueMembers.length,
                    'Arama filtresi sonrası gösterilen üye sayısı': filteredMembers.length,
                    'Üye isimleri': filteredMembers.map(m => m.Ad_Soyad),
                    'Üye ID\'leri': filteredMembers.map(m => m.id),
                    'Debug - Tüm üyeler': debugOverdue
                });
            } else if (paymentFilter === 'finished') {
                filteredMembers = allMembers.filter(m => {
                    const preReg = preRegistrations.find(p => p.id === m.preRegistrationId);
                    return preReg && preReg.paymentSchedule && preReg.paymentSchedule.every(p => p.status === 'paid');
                });
            } else if (paymentFilter === 'paidThisMonth') {
                // Bu ay ödeme yapan üyeleri göster (paymentDate bu ayda olanlar)
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                filteredMembers = allMembers.filter(m => {
                    const preReg = preRegistrations.find(p => p.id === m.preRegistrationId);
                    if (!preReg || !preReg.paymentSchedule) return false;
                    return preReg.paymentSchedule.some(p => {
                        if (p.status === 'paid' && p.paymentDate) {
                            const paymentDate = new Date(p.paymentDate);
                            return paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear;
                        }
                        return false;
                    });
                });
            } else { // 'all'
                filteredMembers = allMembers;
            }

            // Gecikmiş ödemeler istatistikleri updatePaymentStats'da hesaplanıyor, burada tekrar hesaplamaya gerek yok
            
            container.innerHTML = filteredMembers.length === 0 
                ? `<div class="empty-state"><h3>Filtreye uygun üye bulunamadı.</h3></div>`
                : filteredMembers.map(member => {
                    const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                    const group = groups.find(g => Array.isArray(g.members) && g.members.includes(member.id));
                    let statusHtml = '<span class="status-badge status-pending">Plan Yok</span>';
                    let subStatusHtml = '';

                    if (group) {
                        subStatusHtml += `<div class="sub-status group-name">${group.groupName}</div>`;
                    }
                    if (member.status === 'pending') {
                         subStatusHtml += `<div class="sub-status pending">Beklemede</div>`;
                    }
                     if (member.status === 'expired') {
                        subStatusHtml += `<div class="sub-status expired">Pasif</div>`;
                    }
                    

                    if (preReg && preReg.paymentSchedule) {
                        const overdueCount = preReg.paymentSchedule.filter(p => p.status === 'unpaid' && new Date(p.dueDate + 'T00:00:00') < today).length;
                        if (overdueCount > 0) {
                            statusHtml = `<span class="status-badge status-overdue">${overdueCount} Gecikmiş</span>`;
                        } else {
                            const unpaidCount = preReg.paymentSchedule.filter(p => p.status === 'unpaid').length;
                            if (unpaidCount === 0) {
                                statusHtml = `<span class="status-badge status-completed">Tümü Ödendi</span>`;
                            } else {
                                statusHtml = ``;
                            }
                        }
                    }
                    return `
                        <div class="payment-member-item">
                            <div class="payment-member-header">
                                <div class="payment-member-info" onclick="togglePaymentDetails('${member.id}')">
                                    <strong>${member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad} ${member.Resit_Olmayan_Adi_Soyadi ? `(${member.Ad_Soyad})` : ''}</strong>
                                    <div style="font-size: 0.9em; color: #555;">📞 <a href="#" class="phone-link" onclick="handlePhoneClick(event, '${member.Telefon || ''}')">${member.Telefon || 'Numara Yok'}</a></div>
                                </div>
                                 <div class="status-container" onclick="togglePaymentDetails('${member.id}')">
                                     ${statusHtml}
                                     ${subStatusHtml}
                                </div>
                            </div>
                            <div class="payment-details" id="payment-details-${member.id}">
                                 ${preReg ? `
                                    <div class="payment-details-header">
                                        <h4>Ödeme Planı</h4>
                                        <div style="display: flex; gap: 8px;">
                                            ${currentUser?.permissions?.edit_payments ? `
                                                <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteSelectedPayments('${preReg.id}')">🗑️ Seçilenleri Sil</button>
                                                <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); openPaymentEditModal('${preReg.id}', null, true)">+ Yeni Taksit Ekle</button>
                                            ` : ''}
                                        </div>
                                    </div>
                                    ${renderPaymentDetailsTable(preReg)}
                                 ` : '<p class="empty-state">Bu üyeye ait ödeme planı bulunamadı.</p>'}
                            </div>
                        </div>`;
                }).join('');
            
            // Ödeme tutarlarını maskele (eğer gizli ise) - titreme önleme için hemen uygula
            requestAnimationFrame(() => applyPaymentVisibility());
        }
        
        // ✅ Ders planı için branş ve saha seçimi
        let selectedCourtForSchedule = null; // Yeni: Seçili saha
        
        window.selectBranchForSchedule = function(branchId) {
            selectedBranchForSchedule = branchId;
            selectedCourtForSchedule = null; // Branş değişince sahayı sıfırla
            renderScheduleGrid();
        };
        
        window.selectCourtForSchedule = function(courtName) {
            selectedCourtForSchedule = courtName;
            renderScheduleGrid();
        };
        
        function renderScheduleGrid() {
            const grid = document.getElementById('scheduleGrid');
            const unassignedContainer = document.getElementById('unassigned-groups-container');
            if(!grid || !unassignedContainer) return;
            
            // ✅ İlk açılışta otomatik olarak ilk branşı seç
            if (!selectedBranchForSchedule && branches.length > 0) {
                // ✅ BRANŞ YETKİSİ: Sadece yetkili branşlardan birini seç
                const availableBranches = filterByBranch(branches, 'id');
                if (availableBranches.length > 0) {
                    selectedBranchForSchedule = availableBranches[0].id;
                }
            }
            
            // ✅ Branş seçim butonlarını render et - sadece yetkili branşları göster
            const branchButtonsContainer = document.getElementById('schedule-branch-buttons');
            if (branchButtonsContainer) {
                const availableBranches = filterByBranch(branches, 'id');
                let buttonsHtml = availableBranches.map(b => {
                    const isActive = selectedBranchForSchedule === b.id;
                    const btnStyle = isActive 
                        ? 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: 2px solid #667eea;'
                        : 'background: #f8f9fa; color: #333; border: 1px solid #ddd;';
                    return `<button class="btn btn-sm" 
                             style="${btnStyle} margin: 3px; padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer; transition: all 0.3s;"
                             onmouseover="if('${isActive}' === 'false') this.style.background='#e9ecef'"
                             onmouseout="if('${isActive}' === 'false') this.style.background='#f8f9fa'"
                             onclick="selectBranchForSchedule('${b.id}')">
                        ${b.icon} ${b.name}
                    </button>`;
                }).join('');
                
                // ✅ Seçili branşın sahaları varsa, saha butonlarını ekle
                if (selectedBranchForSchedule) {
                    const selectedBranch = branches.find(b => b.id === selectedBranchForSchedule);
                    if (selectedBranch && selectedBranch.courts && selectedBranch.courts.length > 0) {
                        // Otomatik ilk sahayı seç
                        if (!selectedCourtForSchedule) {
                            selectedCourtForSchedule = selectedBranch.courts[0].name;
                        }
                        
                        buttonsHtml += '<div style="width: 100%; height: 1px; background: #ddd; margin: 10px 0;"></div>';
                        buttonsHtml += selectedBranch.courts.map(c => {
                            const isActive = selectedCourtForSchedule === c.name;
                            const btnStyle = isActive 
                                ? 'background: linear-gradient(135deg, #FF6B6B 0%, #EE5A6F 100%); color: white; border: 2px solid #FF6B6B;'
                                : 'background: #fff; color: #666; border: 1px solid #ccc;';
                            return `<button class="btn btn-sm" 
                                     style="${btnStyle} margin: 3px; padding: 6px 14px; border-radius: 15px; font-weight: 500; cursor: pointer; transition: all 0.3s; font-size: 0.9em;"
                                     onmouseover="if('${isActive}' === 'false') this.style.background='#f5f5f5'"
                                     onmouseout="if('${isActive}' === 'false') this.style.background='#fff'"
                                     onclick="selectCourtForSchedule('${c.name}')">
                                📍 ${c.name}
                            </button>`;
                        }).join('');
                    }
                }
                
                branchButtonsContainer.innerHTML = buttonsHtml;
            }

            // ✅ Branş yoksa uyarı göster
            if (branches.length === 0) {
                 grid.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;"><h3>Henüz branş tanımlanmamış. Ayarlar > Branşlar'dan ekleyebilirsiniz.</h3></div>`;
                 unassignedContainer.innerHTML = '';
                 return;
            }
            
            if (!selectedBranchForSchedule) {
                 grid.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;"><h3>Lütfen bir branş seçin.</h3></div>`;
                 unassignedContainer.innerHTML = '';
                 return;
            }

            const filteredUnassignedGroups = groups.filter(g => g.branch === selectedBranchForSchedule);
            let filteredSchedules = schedules.filter(s => s.branch === selectedBranchForSchedule);
            
            // ✅ Saha seçiliyse, sadece o sahaya ait dersleri göster
            if (selectedCourtForSchedule) {
                filteredSchedules = filteredSchedules.filter(s => s.court === selectedCourtForSchedule);
            }

            const allDays = ['pazartesi', 'salı', 'çarşamba', 'perşembe', 'cuma', 'cumartesi', 'pazar'];
            const weekdays = allDays.slice(0, 5);
            const weekends = allDays.slice(5, 7);

            const visibleWeekdays = weekdays.filter(day => !holidays.includes(day));
            const visibleWeekends = weekends.filter(day => !holidays.includes(day));
            
            // ✅ Dinamik branş ikonu
            unassignedContainer.innerHTML = filteredUnassignedGroups.length > 0 
                ? filteredUnassignedGroups.map(g => {
                    const branchInfo = branches.find(b => b.id === g.branch);
                    const branchIcon = branchInfo ? branchInfo.icon : '⚽';
                    return `<div class="unassigned-group" draggable="true" ondragstart="drag(event, '${g.id}', true)" onclick="openScheduleModalForGroup('${g.id}')">${branchIcon} ${g.groupName}</div>`;
                }).join('')
                : '<p class="empty-state" style="padding:0;font-size:0.9em;">Bu branşta atanacak grup bulunmuyor.</p>';

            grid.innerHTML = ''; // Clear previous content

            const createLessonBlock = (schedule, group) => {
                const isTrial = group.groupName.toLowerCase().includes('deneme');
                const blockClass = `lesson-block ${isTrial ? 'trial-lesson' : ''}`;
                
                // ✅ Branşın sahaları var mı kontrol et
                const branchInfo = branches.find(b => b.id === group.branch);
                const hasCourts = branchInfo && branchInfo.courts && branchInfo.courts.length > 0;
                
                // ✅ Saha bilgisi: Sadece branşın sahaları varsa göster
                let courtInfo = '';
                if (hasCourts) {
                    if (schedule.court) {
                        courtInfo = `<div style="font-size: 0.85em; color: #666; cursor: pointer;" onclick="event.stopPropagation(); editScheduleCourt('${schedule.id}')" title="Sahayı değiştir">📍 ${schedule.court}</div>`;
                    } else {
                        courtInfo = `<div style="font-size: 0.75em; color: #999; cursor: pointer; font-style: italic;" onclick="event.stopPropagation(); editScheduleCourt('${schedule.id}')" title="Saha ekle">+ Saha ekle</div>`;
                    }
                }
                
                return `
                <div class="${blockClass}">
                    <button class="delete-lesson-btn" onclick="event.stopPropagation(); deleteSchedule(event, '${schedule.id}')" title="Dersi sil">&times;</button>
                    <button class="delete-lesson-btn" onclick="event.stopPropagation(); openScheduleModalForGroup('${group.id}')" title="Dersi düzenle" style="right: 30px; background: #4CAF50;">✏️</button>
                    <div onclick="openAttendanceModal('${group.id}')" style="cursor: pointer;">
                        <div><strong>${schedule.startTime} - ${schedule.endTime}</strong></div>
                        <div>${group.groupName}</div>
                        ${courtInfo}
                    </div>
                </div>`;
            }

            const createEmptySlotBlock = (start, end, day) => `
                <div class="lesson-block empty-slot" ondrop="drop(event, '${day}', '${start}')" ondragover="allowDrop(event)">
                    <div><strong>${start} - ${end}</strong></div>
                    <div>Boş</div>
                </div>`;

            const generateDayHtml = (day) => {
                // Only include schedules where the group still exists
                const daySchedules = filteredSchedules
                    .filter(s => s.day === day && groups.find(g => g.id === s.groupId))
                    .sort((a, b) => a.startTime.localeCompare(b.startTime));
                
                let allBlocksHtml = '';

                if (daySchedules.length > 0) {
                    // Add first lesson
                    const firstGroup = groups.find(g => g.id === daySchedules[0].groupId);
                    allBlocksHtml += createLessonBlock(daySchedules[0], firstGroup);

                    // Add gaps ONLY between consecutive lessons
                    for (let i = 1; i < daySchedules.length; i++) {
                        const prevSchedule = daySchedules[i - 1];
                        const currentSchedule = daySchedules[i];
                        const currentGroup = groups.find(g => g.id === currentSchedule.groupId);

                        // Calculate gap between lessons
                        const prevEndMinutes = timeToMinutes(prevSchedule.endTime);
                        const currentStartMinutes = timeToMinutes(currentSchedule.startTime);

                        // Add empty slot ONLY if there's a gap between two actual lessons
                        if (currentStartMinutes > prevEndMinutes) {
                            const gapStart = minutesToTime(prevEndMinutes);
                            const gapEnd = minutesToTime(currentStartMinutes);
                            allBlocksHtml += createEmptySlotBlock(gapStart, gapEnd, day);
                        }
                        
                        // Add current lesson
                        allBlocksHtml += createLessonBlock(currentSchedule, currentGroup);
                    }
                }

                return `<div class="schedule-day" ondrop="drop(event, '${day}')" ondragover="allowDrop(event)"><h4>${capitalize(day)}</h4>${allBlocksHtml}</div>`;
            };

            if (visibleWeekdays.length > 0) {
                const weekdayContainer = document.createElement('div');
                weekdayContainer.className = 'schedule-row weekday-row';
                weekdayContainer.innerHTML = visibleWeekdays.map(generateDayHtml).join('');
                grid.appendChild(weekdayContainer);
            }

            if (visibleWeekends.length > 0) {
                const weekendContainer = document.createElement('div');
                weekendContainer.className = 'schedule-row weekend-row';
                weekendContainer.innerHTML = visibleWeekends.map(generateDayHtml).join('');
                grid.appendChild(weekendContainer);
            }
        }

        // ✅ Grup yönetimi için branş seçimi
        window.selectBranchForGroups = function(branchId) {
            selectedBranchForGroups = branchId;
            renderGroupsList();
            
            // Yeni grup butonunu göster/gizle
            const newGroupBtn = document.getElementById('newGroupBtn');
            if (newGroupBtn) {
                newGroupBtn.style.display = branchId ? 'inline-block' : 'none';
            }
        };

        function renderGroupsList() {
            const container = document.getElementById('groupsList');
            const searchTerm = document.getElementById('groupSearch')?.value.toLowerCase() || '';
            if (!container) return;
            
            // ✅ İlk açılışta otomatik olarak ilk branşı seç
            if (!selectedBranchForGroups && branches.length > 0) {
                // ✅ BRANŞ YETKİSİ: Sadece yetkili branşlardan birini seç
                const availableBranches = filterByBranch(branches, 'id');
                if (availableBranches.length > 0) {
                    selectedBranchForGroups = availableBranches[0].id;
                }
                // Yeni grup butonunu göster
                const newGroupBtn = document.getElementById('newGroupBtn');
                if (newGroupBtn) newGroupBtn.style.display = 'inline-block';
            }
            
            // ✅ Branş seçim butonlarını render et - sadece yetkili branşları göster
            const branchButtonsContainer = document.getElementById('groups-branch-buttons');
            if (branchButtonsContainer) {
                const availableBranches = filterByBranch(branches, 'id');
                branchButtonsContainer.innerHTML = availableBranches.map(b => {
                    const isActive = selectedBranchForGroups === b.id;
                    const btnStyle = isActive 
                        ? 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: 2px solid #667eea;'
                        : 'background: #f8f9fa; color: #333; border: 1px solid #ddd;';
                    return `<button class="btn btn-sm" 
                             style="${btnStyle} margin: 3px; padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer; transition: all 0.3s;"
                             onmouseover="if('${isActive}' === 'false') this.style.background='#e9ecef'"
                             onmouseout="if('${isActive}' === 'false') this.style.background='#f8f9fa'"
                             onclick="selectBranchForGroups('${b.id}')">
                        ${b.icon} ${b.name}
                    </button>`;
                }).join('');
            }

            // ✅ Branş yoksa uyarı göster
            if (branches.length === 0) {
                container.innerHTML = `<div class="empty-state"><h3>Henüz branş tanımlanmamış. Ayarlar > Branşlar'dan ekleyebilirsiniz.</h3></div>`;
                return;
            }

            if (!selectedBranchForGroups) {
                container.innerHTML = `<div class="empty-state"><h3>Lütfen bir branş seçin.</h3></div>`;
                return;
            }

            const filteredGroups = groups.filter(g => g.branch === selectedBranchForGroups && g.groupName.toLowerCase().includes(searchTerm));

            const childGroups = [];
            const adultGroups = [];
            const emptyGroups = [];

            filteredGroups.forEach(group => {
                // ✅ Güvenli kontrol: members yoksa boş array kabul et
                const memberIds = Array.isArray(group.members) ? group.members : [];
                const groupMembers = members.filter(m => memberIds.includes(m.id) && m.status !== 'expired');
                if (groupMembers.length === 0) {
                    emptyGroups.push(group);
                    return;
                }

                const isChildGroup = groupMembers.some(m => m.Resit_Olmayan_Adi_Soyadi && m.Resit_Olmayan_Adi_Soyadi.trim() !== '');
                if (isChildGroup) {
                    childGroups.push(group);
                } else {
                    adultGroups.push(group);
                }
            });

            let finalHtml = '';
            
            if (childGroups.length > 0) {
                finalHtml += `<h2 class="group-category-title">Çocuk Grupları</h2>`;
                finalHtml += childGroups.map(renderGroupCard).join('');
            }
            if (adultGroups.length > 0) {
                finalHtml += `<h2 class="group-category-title">Yetişkin Grupları</h2>`;
                finalHtml += adultGroups.map(renderGroupCard).join('');
            }
            if (emptyGroups.length > 0) {
                finalHtml += `<h2 class="group-category-title">Boş Gruplar</h2>`;
                finalHtml += emptyGroups.map(renderGroupCard).join('');
            }

            if (finalHtml === '') {
                container.innerHTML = `<div class="empty-state"><h3>Grup bulunamadı.</h3></div>`;
            } else {
                container.innerHTML = finalHtml;
            }
        }

        function renderGroupCard(group) {
             const isTrial = group.groupName.toLowerCase().includes('deneme');
             const cardClass = `group-card ${isTrial ? 'group-card-trial' : ''}`;
             // ✅ Güvenli kontrol: members yoksa boş array kabul et
             const groupMembers = group.members || [];
             const memberIds = Array.isArray(groupMembers) ? groupMembers : [];
             
             // 🔍 Debug: Grup üyelik bilgisini göster
             console.log(`🔍 Grup Kartı: ${group.groupName}`, {
                 groupId: group.id,
                 membersField: group.members,
                 isArray: Array.isArray(group.members),
                 memberIds: memberIds,
                 memberCount: memberIds.length,
                 allMembers: members.length
             });
             
             const activeMembers = members.filter(m => memberIds.includes(m.id) && m.status !== 'expired');
             
             // 🔍 Debug: Filtrelenmiş üyeleri göster
             if (memberIds.length > 0) {
                 console.log(`  → ${memberIds.length} member ID, ${activeMembers.length} aktif üye`);
                 if (memberIds.length !== activeMembers.length) {
                     const missingIds = memberIds.filter(id => !members.find(m => m.id === id));
                     const expiredMembers = memberIds.filter(id => {
                         const m = members.find(mem => mem.id === id);
                         return m && m.status === 'expired';
                     });
                     console.log(`  ⚠️ ${missingIds.length} üye bulunamadı, ${expiredMembers.length} üye expired`);
                 }
             }
             
             const memberCount = activeMembers.length;

            return `
                <div class="${cardClass}" onclick="openGroupEditModal('${group.id}')" style="cursor: pointer;">
                    <div>
                        <h4>${group.groupName}</h4>
                        <p><strong>Branş:</strong> ${group.branch === 'tenis' ? '🎾' : '🏊'} ${capitalize(group.branch)}</p>
                        <p><strong>Eğitmen:</strong> 👨‍🏫 ${group.instructor}</p>
                        <p><strong>Üye Sayısı:</strong> 👥 ${memberCount}/${group.maxMembers}</p>
                    </div>
                    <div class="group-members">${activeMembers.map(member => {
                        return `<span class="member-tag">${member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad}</span>`
                    }).join('') || '<span class="member-tag">Aktif üye yok</span>'}</div>
                    <div class="group-card-actions">
                        <button class="btn btn-warning btn-sm" onclick="event.stopPropagation(); assignToGroup(null, '${group.id}')">👥 Üye Ekle/Çıkar</button>
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteItem('groups', '${group.id}')">🗑️ Sil</button>
                    </div>
                </div>`;
        }
        
        function renderSettings() {
            const holidayContainer = document.getElementById('holiday-settings');
            const allDays = ['pazartesi', 'salı', 'çarşamba', 'perşembe', 'cuma', 'cumartesi', 'pazar'];
            holidayContainer.innerHTML = allDays.map(day => `
                <label>
                    <input type="checkbox" name="holidays" value="${day}" ${holidays.includes(day) ? 'checked' : ''}>
                    ${capitalize(day)}
                </label>
            `).join('');

            const clubNameInput = document.querySelector('#settingsForm [name="clubName"]');
            if(clubNameInput) {
                clubNameInput.value = clubSettings.clubName;
            }
            
            // ✅ Random bekleme süresi ayarlarını formda göster
            const minWaitInput = document.getElementById('minWaitTime');
            const maxWaitInput = document.getElementById('maxWaitTime');
            const longWaitTriggerInput = document.getElementById('longWaitTrigger');
            const minLongWaitInput = document.getElementById('minLongWait');
            const maxLongWaitInput = document.getElementById('maxLongWait');
            
            if (minWaitInput) minWaitInput.value = clubSettings.minWaitTime || 20;
            if (maxWaitInput) maxWaitInput.value = clubSettings.maxWaitTime || 50;
            if (longWaitTriggerInput) longWaitTriggerInput.value = clubSettings.longWaitTrigger || 100;
            if (minLongWaitInput) minLongWaitInput.value = clubSettings.minLongWait || 400;
            if (maxLongWaitInput) maxLongWaitInput.value = clubSettings.maxLongWait || 800;
            
            loadExpenseCategories();
            renderUsersTable();
        }
        
        // Gider kategorileri yönetimi
        window.addExpenseCategory = async function(event) {
            event.preventDefault();
            
            const nameInput = document.getElementById('newExpenseCategoryName');
            const iconInput = document.getElementById('newExpenseCategoryIcon');
            
            const name = nameInput.value.trim();
            const icon = iconInput.value.trim() || '📦';
            
            if (!name) {
                showAlert('❌ Kategori adı gerekli', 'danger');
                return;
            }
            
            // Kulüp ayarlarına ekle
            if (!clubSettings.expenseCategories) {
                clubSettings.expenseCategories = [];
            }
            
            // Aynı isimde kategori var mı kontrol et
            if (clubSettings.expenseCategories.find(cat => cat.name === name)) {
                showAlert('❌ Bu kategori zaten mevcut', 'danger');
                return;
            }
            
            clubSettings.expenseCategories.push({ name, icon });
            
            // Firebase'e kaydet
            try {
                await window.firebase.updateDoc(
                    window.firebase.doc(window.db, 'clubs', currentClubId),
                    { expenseCategories: clubSettings.expenseCategories }
                );
                
                showAlert('✅ Kategori başarıyla eklendi', 'success');
                nameInput.value = '';
                iconInput.value = '';
                loadExpenseCategories();
            } catch (error) {
                console.error('Kategori eklenirken hata:', error);
                showAlert('❌ Kategori eklenirken bir hata oluştu', 'danger');
            }
        };
        
        async function loadExpenseCategories() {
            const container = document.getElementById('expenseCategoriesContainer');
            if (!container) return;
            
            const customCategories = clubSettings.expenseCategories || [];
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">';
            
            // Varsayılan kategoriler
            const defaults = [
                { name: 'Kira', icon: '🏠' },
                { name: 'Maaş', icon: '💰' },
                { name: 'Fatura', icon: '📄' },
                { name: 'Malzeme', icon: '🔧' },
                { name: 'Diğer', icon: '📦' }
            ];
            
            defaults.forEach(cat => {
                html += `
                    <div class="expense-category-card" data-category="${cat.name}">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">${cat.icon}</span>
                            <span style="font-weight: 600;">${cat.name}</span>
                        </div>
                        <span style="font-size: 11px; color: #666; margin-top: 5px;">Varsayılan</span>
                    </div>
                `;
            });
            
            // Özel kategoriler
            customCategories.forEach(cat => {
                html += `
                    <div class="expense-category-card" data-category="${cat.name}">
                        <button class="delete-category-btn" onclick="deleteExpenseCategory('${cat.name}')" title="Sil">×</button>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">${cat.icon}</span>
                            <span style="font-weight: 600;">${cat.name}</span>
                        </div>
                        <span style="font-size: 11px; color: #4caf50; margin-top: 5px;">Özel</span>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        window.deleteExpenseCategory = async function(categoryName) {
            if (!confirm(`"${categoryName}" kategorisini silmek istediğinize emin misiniz?`)) return;
            
            clubSettings.expenseCategories = clubSettings.expenseCategories.filter(cat => cat.name !== categoryName);
            
            try {
                await window.firebase.updateDoc(
                    window.firebase.doc(window.db, 'clubs', currentClubId),
                    { expenseCategories: clubSettings.expenseCategories }
                );
                
                showAlert('✅ Kategori silindi', 'success');
                loadExpenseCategories();
                loadExpenseCategoriesModal();
            } catch (error) {
                console.error('Kategori silinirken hata:', error);
                showAlert('❌ Kategori silinirken bir hata oluştu', 'danger');
            }
        };
        
        // Gider kategorisi yönetimi modal'ı aç
        window.openExpenseCategoryManager = function() {
            loadExpenseCategoriesModal();
            openModal('expenseCategoryManagerModal');
            
            // Formu sıfırla
            const form = document.getElementById('expenseCategoryQuickForm');
            if (form) form.reset();
            
            // Seçili ikonu varsayılana çevir
            const selectedIconDisplay = document.getElementById('expenseSelectedIcon');
            if (selectedIconDisplay) selectedIconDisplay.textContent = '📦';
            
            // Tüm ikon seçimlerini temizle
            document.querySelectorAll('#expenseIconPicker .icon-option').forEach(btn => {
                btn.style.border = '2px solid transparent';
                btn.style.background = 'white';
            });
            
            // Event listener'ları başlat
            setTimeout(initExpenseIconListeners, 100);
        };
        
        // Modal içinde kategorileri yükle
        function loadExpenseCategoriesModal() {
            const container = document.getElementById('expenseCategoriesModalContainer');
            if (!container) return;
            
            const customCategories = clubSettings.expenseCategories || [];
            const defaults = [
                { name: 'Kira', icon: '🏠' },
                { name: 'Maaş', icon: '💰' },
                { name: 'Fatura', icon: '📄' },
                { name: 'Malzeme', icon: '🔧' },
                { name: 'Diğer', icon: '📦' }
            ];
            
            let html = '';
            
            // Varsayılan kategoriler
            defaults.forEach(cat => {
                html += `
                    <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">${cat.icon}</span>
                        <span style="font-weight: 600; flex: 1;">${cat.name}</span>
                        <span style="font-size: 10px; color: #666;">Varsayılan</span>
                    </div>
                `;
            });
            
            // Özel kategoriler
            customCategories.forEach(cat => {
                html += `
                    <div style="background: white; border: 2px solid #4caf50; padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">${cat.icon}</span>
                        <span style="font-weight: 600; flex: 1;">${cat.name}</span>
                        <button onclick="deleteExpenseCategory('${cat.name}')" style="background: #f44336; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">Sil</button>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p style="text-align: center; color: #666;">Henüz özel kategori yok</p>';
        }
        
        // Hızlı kategori ekleme (modal içinden)
        window.addExpenseCategoryQuick = async function(event) {
            event.preventDefault();
            
            const nameInput = document.getElementById('quickExpenseCategoryName');
            const iconInput = document.getElementById('quickExpenseCategoryIcon');
            
            const name = nameInput.value.trim();
            const icon = iconInput.value.trim() || '📦';
            
            if (!name) {
                showAlert('❌ Kategori adı gerekli', 'danger');
                return;
            }
            
            if (!clubSettings.expenseCategories) {
                clubSettings.expenseCategories = [];
            }
            
            if (clubSettings.expenseCategories.find(cat => cat.name === name)) {
                showAlert('❌ Bu kategori zaten mevcut', 'danger');
                return;
            }
            
            clubSettings.expenseCategories.push({ name, icon });
            
            try {
                await window.firebase.updateDoc(
                    window.firebase.doc(window.db, 'clubs', currentClubId),
                    { expenseCategories: clubSettings.expenseCategories }
                );
                
                showAlert('✅ Kategori eklendi', 'success');
                
                // Modal'ı kapat
                closeModal('expenseCategoryManagerModal');
                
                // Kategorileri yeniden yükle
                loadExpenseCategories();
            } catch (error) {
                console.error('Kategori eklenirken hata:', error);
                showAlert('❌ Kategori eklenirken bir hata oluştu', 'danger');
            }
        };
        
        // İkon seçme fonksiyonları
        window.selectExpenseIcon = function(icon) {
            const iconInput = document.getElementById('quickExpenseCategoryIcon');
            const selectedIconDisplay = document.getElementById('expenseSelectedIcon');
            
            if (iconInput) iconInput.value = icon;
            if (selectedIconDisplay) selectedIconDisplay.textContent = icon;
            
            // Tüm ikon butonlarından seçili stilini kaldır
            document.querySelectorAll('#expenseIconPicker .icon-option').forEach(btn => {
                btn.style.border = '2px solid transparent';
                btn.style.background = 'white';
            });
            
            // Seçilen ikona stil ekle
            const selectedBtn = document.querySelector(`#expenseIconPicker .icon-option[data-icon="${icon}"]`);
            if (selectedBtn) {
                selectedBtn.style.border = '2px solid #2196f3';
                selectedBtn.style.background = '#e3f2fd';
            }
        };
        
        // İkon input event listener'ları
        function initExpenseIconListeners() {
            const expenseIconInput = document.getElementById('quickExpenseCategoryIcon');
            if (expenseIconInput) {
                // Remove existing listeners by replacing element
                const newInput = expenseIconInput.cloneNode(true);
                expenseIconInput.parentNode.replaceChild(newInput, expenseIconInput);
                
                newInput.addEventListener('input', function(e) {
                    const selectedIconDisplay = document.getElementById('expenseSelectedIcon');
                    if (selectedIconDisplay) {
                        selectedIconDisplay.textContent = e.target.value || '📦';
                    }
                    
                    // Tüm ikon butonlarından seçili stilini kaldır
                    document.querySelectorAll('#expenseIconPicker .icon-option').forEach(btn => {
                        btn.style.border = '2px solid transparent';
                        btn.style.background = 'white';
                    });
                });
            }
        }
        
        // Ürün kategorisi yönetimi modal'ı aç
        window.openProductCategoryManager = function() {
            loadProductCategoriesModal();
            openModal('productCategoryManagerModal');
            
            // Formu sıfırla
            const form = document.getElementById('productCategoryQuickForm');
            if (form) form.reset();
            
            // Seçili ikonu varsayılana çevir
            const selectedIconDisplay = document.getElementById('productSelectedIcon');
            if (selectedIconDisplay) selectedIconDisplay.textContent = '📦';
            
            // Tüm ikon seçimlerini temizle
            document.querySelectorAll('#productIconPicker .icon-option').forEach(btn => {
                btn.style.border = '2px solid transparent';
                btn.style.background = 'white';
            });
            
            // Event listener'ları başlat
            setTimeout(initProductIconListeners, 100);
        };
        
        // Ürün kategorileri modal'da yükle
        function loadProductCategoriesModal() {
            const container = document.getElementById('productCategoriesModalContainer');
            if (!container) return;
            
            const customCategories = clubSettings.productCategories || [];
            const defaults = [
                { name: 'Ekipman', icon: '⚽' },
                { name: 'Kıyafet', icon: '👕' },
                { name: 'Abonelik', icon: '💳' },
                { name: 'Diğer', icon: '📦' }
            ];
            
            let html = '';
            
            // Varsayılan kategoriler
            defaults.forEach(cat => {
                html += `
                    <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">${cat.icon}</span>
                        <span style="font-weight: 600; flex: 1;">${cat.name}</span>
                        <span style="font-size: 10px; color: #666;">Varsayılan</span>
                    </div>
                `;
            });
            
            // Özel kategoriler
            customCategories.forEach(cat => {
                html += `
                    <div style="background: white; border: 2px solid #ff9800; padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">${cat.icon}</span>
                        <span style="font-weight: 600; flex: 1;">${cat.name}</span>
                        <button onclick="deleteProductCategory('${cat.name}')" style="background: #f44336; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">Sil</button>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p style="text-align: center; color: #666;">Henüz özel kategori yok</p>';
        }
        
        // Hızlı ürün kategorisi ekleme
        window.addProductCategoryQuick = async function(event) {
            event.preventDefault();
            
            const nameInput = document.getElementById('quickProductCategoryName');
            const iconInput = document.getElementById('quickProductCategoryIcon');
            
            const name = nameInput.value.trim();
            const icon = iconInput.value.trim() || '📦';
            
            if (!name) {
                showAlert('❌ Kategori adı gerekli', 'danger');
                return;
            }
            
            if (!clubSettings.productCategories) {
                clubSettings.productCategories = [];
            }
            
            if (clubSettings.productCategories.find(cat => cat.name === name)) {
                showAlert('❌ Bu kategori zaten mevcut', 'danger');
                return;
            }
            
            clubSettings.productCategories.push({ name, icon });
            
            try {
                await window.firebase.updateDoc(
                    window.firebase.doc(window.db, 'clubs', currentClubId),
                    { productCategories: clubSettings.productCategories }
                );
                
                showAlert('✅ Kategori eklendi', 'success');
                
                // Modal'ı kapat
                closeModal('productCategoryManagerModal');
            } catch (error) {
                console.error('Kategori eklenirken hata:', error);
                showAlert('❌ Kategori eklenirken bir hata oluştu', 'danger');
            }
        };
        
        // Ürün için ikon seçme fonksiyonu
        window.selectProductIcon = function(icon) {
            const iconInput = document.getElementById('quickProductCategoryIcon');
            const selectedIconDisplay = document.getElementById('productSelectedIcon');
            
            if (iconInput) iconInput.value = icon;
            if (selectedIconDisplay) selectedIconDisplay.textContent = icon;
            
            // Tüm ikon butonlarından seçili stilini kaldır
            document.querySelectorAll('#productIconPicker .icon-option').forEach(btn => {
                btn.style.border = '2px solid transparent';
                btn.style.background = 'white';
            });
            
            // Seçilen ikona stil ekle
            const selectedBtn = document.querySelector(`#productIconPicker .icon-option[data-icon="${icon}"]`);
            if (selectedBtn) {
                selectedBtn.style.border = '2px solid #ff9800';
                selectedBtn.style.background = '#fff3e0';
            }
        };
        
        // Ürün ikon input event listener'ları
        function initProductIconListeners() {
            const productIconInput = document.getElementById('quickProductCategoryIcon');
            if (productIconInput) {
                // Remove existing listeners by replacing element
                const newInput = productIconInput.cloneNode(true);
                productIconInput.parentNode.replaceChild(newInput, productIconInput);
                
                newInput.addEventListener('input', function(e) {
                    const selectedIconDisplay = document.getElementById('productSelectedIcon');
                    if (selectedIconDisplay) {
                        selectedIconDisplay.textContent = e.target.value || '📦';
                    }
                    
                    // Tüm ikon butonlarından seçili stilini kaldır
                    document.querySelectorAll('#productIconPicker .icon-option').forEach(btn => {
                        btn.style.border = '2px solid transparent';
                        btn.style.background = 'white';
                    });
                });
            }
        }
        
        // Ürün kategorisi silme
        window.deleteProductCategory = async function(categoryName) {
            if (!confirm(`"${categoryName}" kategorisini silmek istediğinize emin misiniz?`)) return;
            
            clubSettings.productCategories = clubSettings.productCategories.filter(cat => cat.name !== categoryName);
            
            try {
                await window.firebase.updateDoc(
                    window.firebase.doc(window.db, 'clubs', currentClubId),
                    { productCategories: clubSettings.productCategories }
                );
                
                showAlert('✅ Kategori silindi', 'success');
                loadProductCategoriesModal();
            } catch (error) {
                console.error('Kategori silinirken hata:', error);
                showAlert('❌ Kategori silinirken bir hata oluştu', 'danger');
            }
        };

        function renderUsersTable() {
            const tbody = document.getElementById('usersTable');
            if (!tbody) return;
            tbody.innerHTML = users.map(user => {
                const permissionLabels = {
                    // Finansal
                    'view_payments': 'Ödemeleri Görüntüleme',
                    'edit_payments': 'Ödemeleri Düzenleme',
                    'delete_payments': 'Ödemeleri Silme',
                    'export_payments': 'Ödemeleri Dışa Aktarma',
                    // Üye
                    'view_members': 'Üyeleri Görüntüleme',
                    'add_members': 'Üye Ekleme',
                    'edit_members': 'Üye Düzenleme',
                    'delete_members': 'Üye Silme',
                    'export_members': 'Üyeleri Dışa Aktarma',
                    // CRM
                    'view_crm': 'CRM Görüntüleme',
                    'add_crm': 'CRM\'e Ekleme',
                    'edit_crm': 'CRM Düzenleme',
                    'delete_crm': 'CRM\'den Silme',
                    'view_calls': 'Aramaları Görüntüleme',
                    // İletişim
                    'send_messages': 'Mesaj Gönderme',
                    'send_bulk_messages': 'Toplu Mesaj',
                    'view_message_history': 'Mesaj Geçmişi',
                    // Raporlar
                    'view_stats': 'İstatistikler',
                    'view_reports': 'Raporlar',
                    'export_reports': 'Rapor Dışa Aktarma',
                    // Ayarlar
                    'manage_users': 'Kullanıcı Yönetimi',
                    'manage_settings': 'Ayarlar',
                    'manage_branches': 'Branş Yönetimi',
                    'manage_groups': 'Grup Yönetimi',
                    // Yoklama
                    'view_attendance': 'Yoklama Görüntüleme',
                    'edit_attendance': 'Yoklama Düzenleme',
                    'manage_schedule': 'Takvim Yönetimi'
                };
                
                const permissionsText = Object.entries(user.permissions || {})
                    .filter(([key, value]) => value)
                    .map(([key]) => permissionLabels[key] || key)
                    .join(', ') || 'Yok';
                
                // Branş bilgisi gösterimi
                let branchesText = '🌍 Tümü';
                if (user.branches && Array.isArray(user.branches) && user.branches.length > 0) {
                    branchesText = user.branches.map(b => `🎯 ${b.charAt(0).toUpperCase() + b.slice(1)}`).join(', ');
                }
                
                const editButton = `<button class="btn btn-primary btn-sm" onclick="openUserEditModal('${user.id}')">✏️ Düzenle</button>`;
                const branchButton = user.isSuperAdmin 
                    ? '' 
                    : `<button class="btn btn-warning btn-sm" onclick="openBranchAssignModal('${user.id}')" style="background: #ff9800;">🎯 Branş</button>`;
                const deleteButton = user.isSuperAdmin 
                    ? '' 
                    : `<button class="btn btn-danger btn-sm" onclick="deleteItem('users', '${user.id}')">🗑️ Sil</button>`;

                return `<tr>
                    <td>${user.fullName || 'N/A'}</td>
                    <td><a href="#" class="phone-link" onclick="handlePhoneClick(event, '${user.phone || ''}')">${user.phone || user.username}</a></td>
                    <td style="font-size: 12px;">${branchesText}</td>
                    <td>${permissionsText}</td>
                    <td>
                        ${editButton}
                        ${branchButton}
                        ${deleteButton}
                    </td>
                </tr>`;
            }).join('');
        }

        function openUserEditModal(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            const modal = document.getElementById('userEditModal');
            const form = document.getElementById('userEditForm');
            
            form.elements['fullName'].value = user.fullName || '';
            form.elements['phone'].value = user.phone || '';
            form.elements['password'].value = user.password || '';
            
            // Set role (if present) and role templates handler
            const roleSelect = form.querySelector('select[name="role"]');
            if (roleSelect) {
                roleSelect.value = user.role || '';
            }

            // Role templates - predefined permission sets
            const roleTemplates = {
                '': {},
                'muhasebe': {
                    permissions: ['view_payments','edit_payments','export_payments','view_reports','export_reports'],
                    pageAccess: ['payments','reports']
                },
                'antrenor': {
                    permissions: ['view_members','edit_members','view_attendance','manage_schedule'],
                    pageAccess: ['members','attendance','schedule']
                },
                'crm': {
                    permissions: ['view_crm','add_crm','edit_crm','view_calls','send_messages'],
                    pageAccess: ['crm','messages']
                }
            };

            // When role changes, prefill permissions/pageAccess (but keep editable)
            if (roleSelect) {
                roleSelect.onchange = () => {
                    const tpl = roleTemplates[roleSelect.value] || {};
                    const perms = tpl.permissions || [];
                    const pages = tpl.pageAccess || [];
                    // set permissions
                    const permissionsCheckboxesLocal = form.querySelectorAll('input[name="permissions"]');
                    permissionsCheckboxesLocal.forEach(cb => cb.checked = perms.includes(cb.value));
                    // set pageAccess
                    const pageAccessCheckboxes = form.querySelectorAll('input[name="pageAccess"]');
                    pageAccessCheckboxes.forEach(cb => cb.checked = pages.includes(cb.value));
                };
            }

            // Set permissions checkboxes
            const permissionsCheckboxes = form.querySelectorAll('input[name="permissions"]');
            permissionsCheckboxes.forEach(checkbox => {
                checkbox.checked = user.permissions && user.permissions[checkbox.value];
            });

            // Set page-access checkboxes
            const pageAccessCheckboxes = form.querySelectorAll('input[name="pageAccess"]');
            pageAccessCheckboxes.forEach(cb => {
                cb.checked = user.pageAccess && user.pageAccess[cb.value];
            });

            // Populate branch checkboxes inside edit modal (if present)
            const editBranchContainer = document.getElementById('userEditBranchCheckboxes');
            if (editBranchContainer) {
                let availableBranches = [];
                if (branches && branches.length > 0) {
                    availableBranches = branches.map(b => b.id || b.branchId || b.name).filter(Boolean);
                } else {
                    availableBranches = ['tenis','yüzme','futbol','basketbol'];
                }
                editBranchContainer.innerHTML = availableBranches.map(branchId => {
                    const isChecked = user.branches && Array.isArray(user.branches) && user.branches.includes(branchId);
                    const branchInfo = branches.find(b => (b.id || b.branchId) === branchId) || {};
                    const branchName = branchInfo.branchName || branchInfo.name || branchId;
                    const branchIcon = branchInfo.icon || '🎯';
                    return `
                        <label style="display:flex; gap:10px; align-items:center; padding:6px; border-radius:6px; background:#fff;">
                            <input type="checkbox" name="branches" value="${branchId}" ${isChecked ? 'checked' : ''}>
                            <span>${branchIcon} ${branchName}</span>
                        </label>
                    `;
                }).join('');
            }
            
            form.dataset.userId = userId;
            modal.style.display = 'block';
        }

        window.openBranchAssignModal = async function(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            const modal = document.getElementById('branchAssignModal');
            const form = document.getElementById('branchAssignForm');
            const checkboxContainer = document.getElementById('branchCheckboxes');
            
            // Kullanıcı bilgilerini göster
            document.getElementById('branchAssignUserName').textContent = user.fullName || 'N/A';
            document.getElementById('branchAssignUserEmail').textContent = user.phone || user.email || '-';
            
            // Global branches array'inden branşları al
            let availableBranches = [];
            if (branches && branches.length > 0) {
                availableBranches = branches.map(b => b.id || b.branchId || b.name).filter(Boolean);
                console.log('✅ Branşlar yüklendi:', availableBranches);
            } else {
                console.warn('⚠️ Branş bulunamadı, varsayılan liste kullanılıyor');
                availableBranches = ['tenis', 'futbol', 'basketbol', 'yüzme'];
            }
            
            // Branş checkboxları oluştur
            checkboxContainer.innerHTML = availableBranches.map(branchId => {
                const isChecked = user.branches && Array.isArray(user.branches) && user.branches.includes(branchId);
                
                // Branş bilgisini bul
                const branchInfo = branches.find(b => (b.id || b.branchId) === branchId);
                const branchName = branchInfo ? branchInfo.name : branchId;
                const branchIcon = branchInfo ? branchInfo.icon : '🎯';
                
                return `
                    <label style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                        <input type="checkbox" name="branches" value="${branchId}" ${isChecked ? 'checked' : ''} style="width: 18px; height: 18px;">
                        <span style="font-weight: 500;">${branchIcon} ${branchName}</span>
                    </label>
                `;
            }).join('');
            
            form.elements['userId'].value = userId;
            modal.style.display = 'block';
        }

        window.handleBranchAssign = async function(e) {
            e.preventDefault();
            const form = e.target;
            const userId = form.elements['userId'].value;
            const formData = new FormData(form);
            const selectedBranches = formData.getAll('branches');
            
            try {
                // Branş dizisini hazırla (boşsa null)
                const branchesData = selectedBranches.length > 0 ? selectedBranches : null;
                
                // Supabase'de güncelle
                const { error } = await supabase
                    .from('users')
                    .update({ branches: branchesData })
                    .eq('id', userId);
                
                if (error) throw error;
                
                // Yerel state'i güncelle
                const userIndex = users.findIndex(u => u.id === userId);
                if (userIndex !== -1) {
                    users[userIndex].branches = branchesData;
                }
                
                showAlert('✅ Branş ataması başarıyla güncellendi!', 'success');
                closeModal('branchAssignModal');
                renderUsersTable();
                
                // Eğer giriş yapan kullanıcının kendi branşları güncellendiyse sayfayı yenile
                if (userId === currentUser.uid) {
                    showAlert('⚠️ Kendi branşlarınızı güncellediniz. Sayfa yeniden yüklenecek...', 'warning');
                    setTimeout(() => location.reload(), 2000);
                }
                
            } catch (error) {
                console.error('Branş atama hatası:', error);
                showAlert('❌ Branş ataması güncellenemedi: ' + error.message, 'danger');
            }
        }

        async function handleUserUpdate(e) {
            e.preventDefault();
            const form = e.target;
            const userId = form.dataset.userId;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const selectedPermissions = formData.getAll('permissions');
            const selectedBranches = formData.getAll('branches');
            const selectedPageAccess = formData.getAll('pageAccess');
            const roleValue = formData.get('role');

            const userData = {
                fullName: data.fullName,
                phone: data.phone,
                phoneNumber: data.phone, // For WhatsApp notifications
                username: data.phone,
                password: data.password, 
                email: data.phone + '@kulup.local', // For task assignment
                permissions: {
                    // Finansal Yetkiler
                    view_payments: selectedPermissions.includes('view_payments'),
                    edit_payments: selectedPermissions.includes('edit_payments'),
                    delete_payments: selectedPermissions.includes('delete_payments'),
                    export_payments: selectedPermissions.includes('export_payments'),
                    
                    // Üye Yetkiler
                    view_members: selectedPermissions.includes('view_members'),
                    add_members: selectedPermissions.includes('add_members'),
                    edit_members: selectedPermissions.includes('edit_members'),
                    delete_members: selectedPermissions.includes('delete_members'),
                    export_members: selectedPermissions.includes('export_members'),
                    
                    // CRM Yetkileri
                    view_crm: selectedPermissions.includes('view_crm'),
                    add_crm: selectedPermissions.includes('add_crm'),
                    edit_crm: selectedPermissions.includes('edit_crm'),
                    delete_crm: selectedPermissions.includes('delete_crm'),
                    view_calls: selectedPermissions.includes('view_calls'),
                    
                    // İletişim Yetkileri
                    send_messages: selectedPermissions.includes('send_messages'),
                    send_bulk_messages: selectedPermissions.includes('send_bulk_messages'),
                    view_message_history: selectedPermissions.includes('view_message_history'),
                    
                    // Raporlar ve İstatistikler
                    view_stats: selectedPermissions.includes('view_stats'),
                    view_reports: selectedPermissions.includes('view_reports'),
                    export_reports: selectedPermissions.includes('export_reports'),
                    
                    // Ayarlar ve Yönetim
                    manage_users: selectedPermissions.includes('manage_users'),
                    manage_settings: selectedPermissions.includes('manage_settings'),
                    manage_branches: selectedPermissions.includes('manage_branches'),
                    manage_groups: selectedPermissions.includes('manage_groups'),
                    
                    // Yoklama ve Takvim
                    view_attendance: selectedPermissions.includes('view_attendance'),
                    edit_attendance: selectedPermissions.includes('edit_attendance'),
                    manage_schedule: selectedPermissions.includes('manage_schedule')
                }
            };

            // Build pageAccess object
            const pageAccessObj = {
                members: selectedPageAccess.includes('members'),
                preRegistrations: selectedPageAccess.includes('preRegistrations'),
                crm: selectedPageAccess.includes('crm'),
                messages: selectedPageAccess.includes('messages'),
                payments: selectedPageAccess.includes('payments'),
                settings: selectedPageAccess.includes('settings'),
                reports: selectedPageAccess.includes('reports'),
                attendance: selectedPageAccess.includes('attendance'),
                schedule: selectedPageAccess.includes('schedule')
            };

            // Branches: null means all branches
            const branchesData = selectedBranches.length > 0 ? selectedBranches : null;

            // Attach role/branches/pageAccess to firebase payload
            userData.role = roleValue || null;
            userData.branches = branchesData;
            userData.pageAccess = pageAccessObj;

            try {
                // Update Firebase (primary source in app)
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'users', userId), userData);

                // Also update Supabase users table if available (so server-side checks can use branches/pageAccess)
                try {
                    const { error } = await supabase
                        .from('users')
                        .update({
                            fullName: userData.fullName,
                            phone: userData.phone,
                            username: userData.username,
                            email: userData.email,
                            password: userData.password,
                            permissions: userData.permissions,
                            role: userData.role,
                            branches: branchesData,
                            pageAccess: pageAccessObj
                        })
                        .eq('id', userId);
                    if (error) console.warn('Supabase user update warning:', error.message || error);
                } catch (supErr) {
                    console.warn('Supabase update failed (non-blocking):', supErr.message || supErr);
                }

                showAlert('Yönetici başarıyla güncellendi.', 'success');
                closeModal('userEditModal');
                await loadData();
                renderUsersTable();
            } catch (error) {
                console.error('Error updating user:', error);
                showAlert('Yönetici güncellenirken bir hata oluştu.', 'danger');
            }
        }

        window.openUserEditModal = openUserEditModal;

        // ========== CRM FUNCTIONS ==========
        
        // CRM Dashboard İstatistikleri
        function renderCRMDashboard() {
            // 🚀 HIZLI BAŞLANGIÇ - İlk yüklemede verileri bekle, sonra render et
            // Not: Yeni kulüplerde veri olmasa bile widget'ları göster (boş mesajlarıyla)
            
            renderCRMStats();
            renderTodayTrials();
            renderUpcomingRegistrations();
            renderMissedCalls();
            renderBranchDistribution();
            renderTagDistribution();
            renderAccumulationAnalysis();
        }
        
        function renderBranchTagStats() {
            const statsContainer = document.getElementById('branch-tag-stats');
            if (!statsContainer) return;
            
            // ✅ CRM etiketlerini dinamik olarak al (tüm etiketler dahil)
            const tagsList = crmTags
                .filter(tag => tag.isActive !== false) // Sadece aktif etiketler
                .sort((a, b) => (a.order || 999) - (b.order || 999)) // Sıraya göre
                .map(tag => tag.name); // Sadece isimleri al
            
            // Eğer hiç etiket yoksa, varsayılan liste kullan
            if (tagsList.length === 0) {
                tagsList.push('Aranmadı', 'Mesaj Atılacak', 'Denemeye Gelecek', 'Kayıt Olabilir', 'Kayıt Oldu');
            }
            
            // Her branş için etiket sayılarını hesapla
            const branchStats = {};
            branches.forEach(branch => {
                branchStats[branch.id] = {
                    name: branch.name,
                    icon: branch.icon,
                    ageGroups: {
                        child: {},
                        adult: {}
                    }
                };
                
                // Her etiket için sayaçları başlat
                tagsList.forEach(tag => {
                    branchStats[branch.id].ageGroups.child[tag] = 0;
                    branchStats[branch.id].ageGroups.adult[tag] = 0;
                });
            });
            
            // CRM leads üzerinden etiket sayılarını hesapla
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        if (branchStats[br.branchId]) {
                            if (br.ageGroup === 'adult' && br.selectedTag) {
                                branchStats[br.branchId].ageGroups.adult[br.selectedTag] = 
                                    (branchStats[br.branchId].ageGroups.adult[br.selectedTag] || 0) + 1;
                            }
                            
                            if (br.ageGroup === 'child' && br.children) {
                                br.children.forEach(child => {
                                    if (child.selectedTag) {
                                        branchStats[br.branchId].ageGroups.child[child.selectedTag] = 
                                            (branchStats[br.branchId].ageGroups.child[child.selectedTag] || 0) + 1;
                                    }
                                });
                            }
                        }
                    });
                }
            });
            
            // Modern görünüm ile render et
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';
            
            branches.forEach(branch => {
                const stats = branchStats[branch.id];
                
                html += `
                    <div style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 15px 0; font-size: 18px; color: #333;">${branch.icon} ${branch.name}</h4>
                        
                        <!-- Çocuk Grubu -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 12px;">
                            <div style="font-weight: 600; color: #667eea; margin-bottom: 10px; font-size: 14px;">👶 Çocuk</div>
                            <div style="display: flex; flex-direction: column; gap: 6px;">
                `;
                
                // Aranmadı her zaman en üstte
                const childAranmadiCount = stats.ageGroups.child['Aranmadı'] || 0;
                if (childAranmadiCount > 0) {
                    html += `
                        <div onclick="filterByBranchAndTag('${branch.id}', 'child', 'Aranmadı')" style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: #fff3cd; border-radius: 6px; border-left: 3px solid #ffc107; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#ffe4a3'" onmouseout="this.style.background='#fff3cd'">
                            <span style="font-size: 13px; color: #555; font-weight: 600;">Aranmadı</span>
                            <span style="font-weight: 700; color: #ff9800; font-size: 14px;">${childAranmadiCount}</span>
                        </div>
                    `;
                }
                
                // Diğer etiketler
                tagsList.forEach(tag => {
                    if (tag === 'Aranmadı') return; // Aranmadı'yı atla, zaten üstte gösterildi
                    const count = stats.ageGroups.child[tag] || 0;
                    if (count > 0) {
                        html += `
                            <div onclick="filterByBranchAndTag('${branch.id}', 'child', '${tag}')" style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: #f8f9fa; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                <span style="font-size: 13px; color: #555;">${tag}</span>
                                <span style="font-weight: 700; color: #667eea; font-size: 14px;">${count}</span>
                            </div>
                        `;
                    }
                });
                
                html += `
                            </div>
                        </div>
                        
                        <!-- Yetişkin Grubu -->
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-weight: 600; color: #f093fb; margin-bottom: 10px; font-size: 14px;">👨 Yetişkin</div>
                            <div style="display: flex; flex-direction: column; gap: 6px;">
                `;
                
                // Aranmadı her zaman en üstte
                const adultAranmadiCount = stats.ageGroups.adult['Aranmadı'] || 0;
                if (adultAranmadiCount > 0) {
                    html += `
                        <div onclick="filterByBranchAndTag('${branch.id}', 'adult', 'Aranmadı')" style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: #fff3cd; border-radius: 6px; border-left: 3px solid #ffc107; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#ffe4a3'" onmouseout="this.style.background='#fff3cd'">
                            <span style="font-size: 13px; color: #555; font-weight: 600;">Aranmadı</span>
                            <span style="font-weight: 700; color: #ff9800; font-size: 14px;">${adultAranmadiCount}</span>
                        </div>
                    `;
                }
                
                // Diğer etiketler
                tagsList.forEach(tag => {
                    if (tag === 'Aranmadı') return; // Aranmadı'yı atla, zaten üstte gösterildi
                    const count = stats.ageGroups.adult[tag] || 0;
                    if (count > 0) {
                        html += `
                            <div onclick="filterByBranchAndTag('${branch.id}', 'adult', '${tag}')" style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: #f8f9fa; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                <span style="font-size: 13px; color: #555;">${tag}</span>
                                <span style="font-weight: 700; color: #f093fb; font-size: 14px;">${count}</span>
                            </div>
                        `;
                    }
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            statsContainer.innerHTML = html;
            
            // CRM branş filtresi dropdown'unu güncelle
            const crmBranchFilter = document.getElementById('crm-branch-filter');
            if (crmBranchFilter) {
                const currentValue = crmBranchFilter.value;
                crmBranchFilter.innerHTML = '<option value="all">Tüm Branşlar</option>' + 
                    branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
                if (currentValue) crmBranchFilter.value = currentValue;
            }
        }
        
        // Backward compatibility - renderCRMStats artık renderBranchTagStats'ı çağıracak
        function renderCRMStats() {
            renderBranchTagStats();
            // İstatistik görünürlüğünü kontrol et
            checkBranchStatsVisibility();
        }
        
        // İstatistikleri gizle/göster fonksiyonu
        window.toggleBranchStats = function() {
            const statsContainer = document.getElementById('branch-tag-stats');
            const toggleBtn = document.getElementById('toggle-branch-stats-btn');
            if (!statsContainer || !toggleBtn) return;
            
            const isHidden = statsContainer.style.display === 'none';
            
            if (isHidden) {
                // Göster
                statsContainer.style.display = 'grid';
                toggleBtn.innerHTML = '👁️';
                toggleBtn.title = 'İstatistikleri Gizle/Göster';
                localStorage.setItem('branchStatsHidden', 'false');
            } else {
                // Gizle
                statsContainer.style.display = 'none';
                toggleBtn.innerHTML = '👁️‍🗨️';
                toggleBtn.title = 'İstatistikleri Göster';
                localStorage.setItem('branchStatsHidden', 'true');
            }
        };
        
        // Sayfa yüklendiğinde istatistik görünürlüğünü kontrol et
        function checkBranchStatsVisibility() {
            const statsContainer = document.getElementById('branch-tag-stats');
            const toggleBtn = document.getElementById('toggle-branch-stats-btn');
            if (!statsContainer || !toggleBtn) return;
            
            const isHidden = localStorage.getItem('branchStatsHidden') === 'true';
            
            if (isHidden) {
                statsContainer.style.display = 'none';
                toggleBtn.innerHTML = '👁️‍🗨️';
                toggleBtn.title = 'İstatistikleri Göster';
            } else {
                statsContainer.style.display = 'grid';
                toggleBtn.innerHTML = '👁️';
                toggleBtn.title = 'İstatistikleri Gizle/Göster';
            }
        }
        
        // Dashboard istatistiklerini gizle/göster fonksiyonu
        window.toggleDashboardStats = function() {
            const statsContainer = document.getElementById('dashboard-stats-grid');
            const toggleBtn = document.getElementById('toggle-dashboard-stats-btn');
            if (!statsContainer || !toggleBtn) return;
            
            const isHidden = statsContainer.style.display === 'none';
            
            if (isHidden) {
                // Göster
                statsContainer.style.display = 'grid';
                toggleBtn.innerHTML = '👁️';
                toggleBtn.title = 'İstatistikleri Gizle/Göster';
                localStorage.setItem('dashboardStatsHidden', 'false');
            } else {
                // Gizle
                statsContainer.style.display = 'none';
                toggleBtn.innerHTML = '👁️‍🗨️';
                toggleBtn.title = 'İstatistikleri Göster';
                localStorage.setItem('dashboardStatsHidden', 'true');
            }
        };
        
        // Sayfa yüklendiğinde dashboard istatistik görünürlüğünü kontrol et
        function checkDashboardStatsVisibility() {
            const statsContainer = document.getElementById('dashboard-stats-grid');
            const toggleBtn = document.getElementById('toggle-dashboard-stats-btn');
            if (!statsContainer || !toggleBtn) return;
            
            const isHidden = localStorage.getItem('dashboardStatsHidden') === 'true';
            
            if (isHidden) {
                statsContainer.style.display = 'none';
                toggleBtn.innerHTML = '👁️‍🗨️';
                toggleBtn.title = 'İstatistikleri Göster';
            } else {
                statsContainer.style.display = 'grid';
                toggleBtn.innerHTML = '👁️';
                toggleBtn.title = 'İstatistikleri Gizle/Göster';
            }
        }
        
        // Dashboard ana sayfa istatistiklerini gizle/göster fonksiyonu
        let dashboardAmountsHidden = false;
        
        window.toggleDashboardAmounts = function() {
            dashboardAmountsHidden = !dashboardAmountsHidden;
            const toggleBtn = document.getElementById('toggle-dashboard-amounts-btn');
            
            if (dashboardAmountsHidden) {
                // Gizle
                toggleBtn.innerHTML = '👁️‍🗨️';
                toggleBtn.title = 'Tutarları Göster';
                localStorage.setItem('dashboardAmountsHidden', 'true');
            } else {
                // Göster
                toggleBtn.innerHTML = '👁️';
                toggleBtn.title = 'Tutarları Gizle/Göster';
                localStorage.setItem('dashboardAmountsHidden', 'false');
            }
            
            // Tutarları güncelle
            applyDashboardAmountsVisibility();
        };
        
        // Dashboard tutarlarına maskeleme uygula
        function applyDashboardAmountsVisibility() {
            const statNumbers = document.querySelectorAll('#dashboard .stat-number');
            statNumbers.forEach(el => {
                // Orijinal değeri sakla
                if (el.dataset.originalValue === undefined) {
                    el.dataset.originalValue = el.textContent;
                }
                
                if (dashboardAmountsHidden) {
                    // Gizle - Sadece sayıları içeriyorsa maskele
                    if (el.dataset.originalValue.match(/\d/)) {
                        const currencyMatch = el.dataset.originalValue.match(/[₺$€]/);
                        el.textContent = '****' + (currencyMatch ? currencyMatch[0] : '');
                    }
                } else {
                    // Göster - Orijinal değeri geri yükle
                    el.textContent = el.dataset.originalValue;
                }
            });
        }
        
        // Sayfa yüklendiğinde dashboard tutar görünürlüğünü kontrol et
        function checkDashboardAmountsVisibility() {
            const toggleBtn = document.getElementById('toggle-dashboard-amounts-btn');
            if (!toggleBtn) return;
            
            const isHidden = localStorage.getItem('dashboardAmountsHidden') === 'true';
            dashboardAmountsHidden = isHidden;
            
            if (isHidden) {
                toggleBtn.innerHTML = '👁️‍🗨️';
                toggleBtn.title = 'Tutarları Göster';
                applyDashboardAmountsVisibility();
            } else {
                toggleBtn.innerHTML = '👁️';
                toggleBtn.title = 'Tutarları Gizle/Göster';
            }
        }
        
        // Ödeme tutarlarını gizle/göster fonksiyonu
        let paymentAmountsHidden = false;
        
        window.togglePaymentVisibility = function() {
            paymentAmountsHidden = !paymentAmountsHidden;
            const toggleBtn = document.getElementById('toggle-payment-visibility-btn');
            
            if (paymentAmountsHidden) {
                // Gizle
                toggleBtn.innerHTML = '👁️‍🗨️';
                toggleBtn.title = 'Tutarları Göster';
                localStorage.setItem('paymentAmountsHidden', 'true');
            } else {
                // Göster
                toggleBtn.innerHTML = '👁️';
                toggleBtn.title = 'Tutarları Gizle/Göster';
                localStorage.setItem('paymentAmountsHidden', 'false');
            }
            
            // Tutarları güncelle
            applyPaymentVisibility();
        };
        
        // Ödeme tutarlarına maskeleme uygula
        function applyPaymentVisibility() {
            // İstatistik kartlarındaki tutarları maskele/göster
            const statNumbers = document.querySelectorAll('#payments .stat-number');
            statNumbers.forEach(el => {
                // Orijinal değeri sakla
                if (el.dataset.originalValue === undefined) {
                    el.dataset.originalValue = el.textContent;
                }
                
                if (paymentAmountsHidden) {
                    // Gizle - Sadece sayıları içeriyorsa maskele
                    if (el.dataset.originalValue.match(/\d/)) {
                        const currencyMatch = el.dataset.originalValue.match(/[₺$€]/);
                        el.textContent = '****' + (currencyMatch ? currencyMatch[0] : '');
                    }
                } else {
                    // Göster - Orijinal değeri geri yükle
                    el.textContent = el.dataset.originalValue;
                }
            });
            
            // Tablodaki tüm tutarları bul ve maskele/göster
            const paymentElements = document.querySelectorAll('#member-payment-list [style*="font-weight: bold"]');
            paymentElements.forEach(el => {
                const text = el.textContent.trim();
                // Sadece TL içeren elementleri işle
                if (text.includes('₺') || text.includes('TL')) {
                    // Orijinal değeri sakla
                    if (el.dataset.originalValue === undefined) {
                        el.dataset.originalValue = el.textContent;
                    }
                    
                    if (paymentAmountsHidden) {
                        // Gizle
                        if (el.dataset.originalValue.match(/\d/)) {
                            el.textContent = '****₺';
                        }
                    } else {
                        // Göster - Orijinal değeri geri yükle
                        el.textContent = el.dataset.originalValue;
                    }
                }
            });
        }
        
        // Sayfa yüklendiğinde ödeme görünürlüğünü kontrol et
        function checkPaymentVisibility() {
            const toggleBtn = document.getElementById('toggle-payment-visibility-btn');
            if (!toggleBtn) return;
            
            const isHidden = localStorage.getItem('paymentAmountsHidden') === 'true';
            paymentAmountsHidden = isHidden;
            
            if (isHidden) {
                toggleBtn.innerHTML = '👁️‍🗨️';
                toggleBtn.title = 'Tutarları Göster';
            } else {
                toggleBtn.innerHTML = '👁️';
                toggleBtn.title = 'Tutarları Gizle/Göster';
            }
        }
        
        // Branş ve etikete göre filtreleme yap
        window.filterByBranchAndTag = function(branchId, ageGroup, tag) {
            // CRM filtre sayfasına git
            showSection('crm-filter');
            
            // Filtre değerlerini ayarla
            setTimeout(() => {
                const branchFilter = document.getElementById('filter-branch');
                const ageGroupFilter = document.getElementById('filter-age-group');
                const tagFilter = document.getElementById('filter-tag');
                
                if (branchFilter) branchFilter.value = branchId;
                if (ageGroupFilter) ageGroupFilter.value = ageGroup;
                if (tagFilter) tagFilter.value = tag;
                
                // Filtrelemeyi çalıştır
                applyCustomerFilters();
            }, 100);
        };
        
        // Panoya kopyala fonksiyonu
        window.copyToClipboard = function(text, message = 'Kopyalandı!') {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showAlert(message, 'success');
                }).catch(err => {
                    console.error('Kopyalama hatası:', err);
                    fallbackCopyToClipboard(text, message);
                });
            } else {
                fallbackCopyToClipboard(text, message);
            }
        };
        
        // Eski tarayıcılar için alternatif kopyalama
        function fallbackCopyToClipboard(text, message) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showAlert(message, 'success');
            } catch (err) {
                console.error('Kopyalama hatası:', err);
                showAlert('Kopyalama başarısız oldu', 'error');
            }
            document.body.removeChild(textArea);
        }
        
        function renderRecentAbsences() {
            const container = document.getElementById('recent-absences-list');
            if (!container) return;
            
            // ✅ Veriler boşsa bilgi mesajı göster (yeni kulüpte veri olmayabilir)
            if (!attendanceRecords || attendanceRecords.length === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">Henüz devamsızlık kaydı yok ✅</p></div>';
                return;
            }
            
            // Seçili gün sayısını al
            const periodSelect = document.getElementById('absence-period-filter');
            const dayCount = periodSelect ? parseInt(periodSelect.value) : 30;
            
            // Son X günün devamsızlıklarını al - basitçe filter ve sort
            const targetDate = new Date();
            targetDate.setDate(targetDate.getDate() - dayCount);
            targetDate.setHours(0, 0, 0, 0);
            
            const recentAbsences = attendanceRecords
                .filter(rec => {
                    if (rec.status !== 'absent') return false;
                    if (!rec.date) return false;
                    const recordDate = new Date(rec.date);
                    recordDate.setHours(0, 0, 0, 0);
                    return recordDate >= targetDate;
                })
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 20);
            
            if (recentAbsences.length === 0) {
                container.innerHTML = `<div class="empty-state"><p style="padding: 20px; color: #999;">Son ${dayCount} günde devamsızlık yok ✅</p></div>`;
                return;
            }
            
            container.innerHTML = recentAbsences.map(record => {
                const member = members.find(m => m.id === record.memberId);
                if (!member) return '';
                
                const memberName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad || 'İsimsiz';
                const dateStr = new Date(record.date).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
                const reason = record.reason || 'Belirtilmemiş';
                
                return `
                    <div style="padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border-left: 4px solid #f44336; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 13px; color: #333; margin-bottom: 2px;">${memberName}</div>
                                <div style="font-size: 11px; color: #666; margin-bottom: 4px;">
                                    <span style="background: #fff; padding: 2px 8px; border-radius: 4px; margin-right: 5px;">📅 ${dateStr}</span>
                                    ${member.Brans ? `<span style="background: #fff; padding: 2px 8px; border-radius: 4px;">${member.Brans}</span>` : ''}
                                </div>
                                <div style="font-size: 11px; color: #d32f2f; font-style: italic;">Sebep: ${reason}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Global olarak erişilebilir yap
        window.renderRecentAbsences = renderRecentAbsences;
        
        function renderTodayTrials() {
            // Son devamsızlıkları render et
            renderRecentAbsences();
            
            const container = document.getElementById('today-trials-list');
            if (!container) return;
            
            // ✅ crmLeads verisi yoksa veya boşsa uygun mesaj göster
            // Not: Yeni kulüpte crmLeads boş olabilir, bu normal bir durumdur
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            let todayTrials = [];
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        if (br.ageGroup === 'adult' && br.denemeDate) {
                            const trialDate = new Date(br.denemeDate);
                            if (trialDate >= today && trialDate < tomorrow) {
                                todayTrials.push({ lead, branch: br, type: 'adult', date: trialDate });
                            }
                        }
                        if (br.ageGroup === 'child' && br.children) {
                            br.children.forEach(c => {
                                if (c.denemeDate) {
                                    const trialDate = new Date(c.denemeDate);
                                    if (trialDate >= today && trialDate < tomorrow) {
                                        todayTrials.push({ lead, branch: br, child: c, type: 'child', date: trialDate });
                                    }
                                }
                            });
                        }
                    });
                }
            });
            
            todayTrials.sort((a, b) => a.date - b.date);
            
            if (todayTrials.length === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">Bugün deneme dersi yok</p></div>';
                return;
            }
            
            container.innerHTML = todayTrials.map(trial => {
                const branch = branches.find(b => b.id === trial.branch.branchId);
                const timeStr = trial.date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                const name = trial.type === 'child' ? trial.child.name : trial.branch.fullName || trial.lead.fullName;
                const parentInfo = trial.type === 'child' ? `<div style="font-size: 11px; color: #888;">Veli: ${trial.branch.parentName || '-'}</div>` : '';
                
                // ✅ Branşa göre renk paleti
                const branchColors = {
                    'tenis': { bg: 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)', border: '#4caf50', text: '#2e7d32', icon: '🎾' },
                    'yuzme': { bg: 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)', border: '#2196f3', text: '#1565c0', icon: '🏊' },
                    'default': { bg: 'linear-gradient(135deg, #fff9e6 0%, #fff3cc 100%)', border: '#ffc107', text: '#ff9800', icon: '🎯' }
                };
                
                const branchStyle = branchColors[branch?.id] || branchColors['default'];
                
                return `
                    <div style="padding: 15px; margin-bottom: 10px; background: ${branchStyle.bg}; border-left: 4px solid ${branchStyle.border}; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onclick="openCustomerDetail('${trial.lead.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 14px; color: #333; margin-bottom: 4px;">${name}</div>
                                ${parentInfo}
                                <div style="font-size: 12px; color: #666;">📞 <a href="#" class="phone-link" onclick="event.stopPropagation(); handlePhoneClick(event, '${trial.lead.phone}')">${trial.lead.phone}</a></div>
                                <div style="font-size: 12px; color: ${branchStyle.text}; margin-top: 4px; font-weight: 600;">${branch ? branch.icon + ' ' + branch.name : 'Branş'}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 18px; font-weight: 700; color: ${branchStyle.text};">${timeStr}</div>
                                <div style="font-size: 11px; color: #888;">${branchStyle.icon} Deneme</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderUpcomingRegistrations() {
            const container = document.getElementById('upcoming-registrations-list');
            if (!container) return;
            
            // ✅ crmLeads verisi yoksa veya boşsa devam et (aşağıda zaten boş mesajı var)
            // Not: Yeni kulüpte crmLeads boş olabilir, bu normal bir durumdur
            
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);
            
            let upcomingRegs = [];
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        if (br.selectedTag === 'Kayıt Olabilir' && br.kayitOlabilirDate) {
                            const regDate = new Date(br.kayitOlabilirDate);
                            if (regDate >= today && regDate <= nextWeek) {
                                upcomingRegs.push({ lead, branch: br, type: 'adult', date: regDate });
                            }
                        }
                        if (br.ageGroup === 'child' && br.children) {
                            br.children.forEach(c => {
                                if (c.selectedTag === 'Kayıt Olabilir' && c.kayitOlabilirDate) {
                                    const regDate = new Date(c.kayitOlabilirDate);
                                    if (regDate >= today && regDate <= nextWeek) {
                                        upcomingRegs.push({ lead, branch: br, child: c, type: 'child', date: regDate });
                                    }
                                }
                            });
                        }
                    });
                }
            });
            
            upcomingRegs.sort((a, b) => a.date - b.date);
            
            if (upcomingRegs.length === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">Yaklaşan kayıt olabilir yok</p></div>';
                return;
            }
            
            container.innerHTML = upcomingRegs.map(reg => {
                const branch = branches.find(b => b.id === reg.branch.branchId);
                const dateStr = reg.date.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' });
                const name = reg.type === 'child' ? reg.child.name : reg.branch.fullName || reg.lead.fullName;
                const parentInfo = reg.type === 'child' ? `<div style="font-size: 11px; color: #888;">Veli: ${reg.branch.parentName || '-'}</div>` : '';
                
                // ✅ Branşa göre renk paleti  
                const branchColors = {
                    'tenis': { bg: 'linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%)', border: '#9c27b0', text: '#6a1b9a', icon: '🎾' },
                    'yuzme': { bg: 'linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%)', border: '#00acc1', text: '#00838f', icon: '🏊' },
                    'default': { bg: 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)', border: '#4caf50', text: '#2e7d32', icon: '📝' }
                };
                
                const branchStyle = branchColors[branch?.id] || branchColors['default'];
                
                return `
                    <div style="padding: 15px; margin-bottom: 10px; background: ${branchStyle.bg}; border-left: 4px solid ${branchStyle.border}; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onclick="openCustomerDetail('${reg.lead.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 14px; color: #333; margin-bottom: 4px;">${name}</div>
                                ${parentInfo}
                                <div style="font-size: 12px; color: #666;">📞 <a href="#" class="phone-link" onclick="event.stopPropagation(); handlePhoneClick(event, '${reg.lead.phone}')">${reg.lead.phone}</a></div>
                                <div style="font-size: 12px; color: ${branchStyle.text}; margin-top: 4px; font-weight: 600;">${branch ? branch.icon + ' ' + branch.name : 'Branş'}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 16px; font-weight: 700; color: ${branchStyle.text};">${dateStr}</div>
                                <div style="font-size: 11px; color: #888;">${branchStyle.icon} Kayıt</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Cevapsız çağrıları render et
        async function renderMissedCalls() {
            const container = document.getElementById('missed-calls-list');
            if (!container) return;
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Cevapsız çağrılar yükleniyor...</span></div>';
            
            let missedCalls = await fetchBulutfonMissedCalls();
            
            // ✅ Cevaplandı olarak işaretlenenleri filtrele
            const answeredCalls = JSON.parse(localStorage.getItem('answeredMissedCalls') || '[]');
            missedCalls = missedCalls.filter(call => {
                const caller = call.caller || '';
                // Telefon numarasını normalize et
                const cleanCaller = caller.replace(/\D/g, '');
                let formattedCaller = cleanCaller;
                if (cleanCaller.startsWith('90') && cleanCaller.length === 12) {
                    formattedCaller = '0' + cleanCaller.slice(2);
                } else if (!cleanCaller.startsWith('0') && cleanCaller.length === 10) {
                    formattedCaller = '0' + cleanCaller;
                }
                
                // Cevaplandı listesinde olup olmadığını kontrol et
                const isMarked = answeredCalls.some(item => {
                    // Eski format desteği (string)
                    if (typeof item === 'string') {
                        return item === formattedCaller;
                    }
                    // Yeni format (object)
                    return item.phone === formattedCaller;
                });
                
                // ✅ "Diğer"e atılmışsa FAKAT son arama "diğer"e atılma tarihinden SONRAYSA → göster
                if (isMarked) {
                    const markedEntry = answeredCalls.find(item => {
                        if (typeof item === 'string') return item === formattedCaller;
                        return item.phone === formattedCaller;
                    });
                    
                    // Tarih kontrolü - eğer bu arama "diğer"e atılma tarihinden sonraysa göster
                    if (typeof markedEntry === 'object' && markedEntry.markedDate) {
                        const markedDate = new Date(markedEntry.markedDate);
                        const callDate = new Date(call.call_time);
                        
                        if (callDate > markedDate) {
                            return true; // Göster - yeni arama
                        }
                    }
                    
                    return false; // Gösterme - "diğer"e atılmış
                }
                
                return true; // Göster - hiç işaretlenmemiş
            });
            
            // Silinenleri filtrele (showDeletedCalls false ise)
            if (!showDeletedCalls) {
                missedCalls = missedCalls.filter(call => !isCallDeleted(call.caller, 'incoming', call.call_time));
            }
            
            if (!missedCalls || missedCalls.length === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">Cevapsız çağrı yok</p></div>';
                return;
            }
            
            container.innerHTML = missedCalls.map(call => {
                const caller = call.caller || 'Bilinmeyen';
                const formattedCaller = formatPhoneDisplay(caller);
                const callee = call.callee || 'Bilinmeyen';
                const formattedCallee = formatPhoneDisplay(callee);
                // Bulutfon API UTC formatında veriyor, 3 saat çıkarmalıyız
                const callTime = new Date(call.lastCall.call_time);
                callTime.setHours(callTime.getHours() - 3); // UTC'den Türkiye saatine çevir
                const timeStr = callTime.toLocaleString('tr-TR', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit'
                });
                
                // ✅ Mesaj şablonu için tam tarih formatı (saniye olmadan)
                const messageTimeStr = callTime.toLocaleString('tr-TR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Dönüş yapılmama süresi
                const minutesSince = call.minutesSinceMissed || 0;
                let timeSinceStr = '';
                if (minutesSince < 60) {
                    timeSinceStr = `${minutesSince} dakika önce`;
                } else if (minutesSince < 1440) {
                    timeSinceStr = `${Math.floor(minutesSince / 60)} saat ${minutesSince % 60} dakika önce`;
                } else {
                    timeSinceStr = `${Math.floor(minutesSince / 1440)} gün önce`;
                }
                
                // Kaç kere aradı
                const callCount = call.callCount || 1;
                const callCountStr = callCount > 1 ? `<div style="font-size: 12px; color: #d32f2f; font-weight: 600; margin-top: 4px;">🔁 ${callCount} kere aradı</div>` : '';
                
                // Tüm arama tarihlerini listele (en fazla 5 tane)
                let allCallTimesStr = '';
                if (call.allCallTimes && call.allCallTimes.length > 1) {
                    const times = call.allCallTimes.slice(0, 5).map((t, idx) => {
                        const time = new Date(t);
                        time.setHours(time.getHours() - 3); // UTC'den Türkiye saatine çevir
                        const today = new Date();
                        const isToday = time.getDate() === today.getDate() && 
                                       time.getMonth() === today.getMonth() && 
                                       time.getFullYear() === today.getFullYear();
                        
                        if (isToday) {
                            return `${idx + 1}. Bugün ${time.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}`;
                        } else {
                            return `${idx + 1}. ${time.toLocaleDateString('tr-TR', { day: '2-digit', month: 'short' })} ${time.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}`;
                        }
                    });
                    allCallTimesStr = `<div style="font-size: 10px; color: #666; margin-top: 6px; background: rgba(0,0,0,0.05); padding: 6px; border-radius: 4px;">📅 ${times.join(' • ')}</div>`;
                }
                
                // CRM'de veya üyelerde var mı kontrol et - GÜÇLENDİRİLMİŞ EŞLEŞTME
                const leadMatch = crmLeads.find(l => phonesMatch(l.phone, caller));
                const memberMatch = members.find(m => phonesMatch(m.Telefon, caller) || phonesMatch(m.Telefon_2, caller));
                
                let personInfo = '';
                let clickAction = '';
                let actionButtons = '';
                let backgroundColor = '#fff3e0'; // Default: cevapsız çağrı rengi
                let borderColor = '#ff9800';
                
                // İkili durum: Hem CRM'de hem cevapsız çağrı
                const isInCRM = !!leadMatch;
                const isMissedCall = true; // Bu zaten cevapsız çağrılar sayfası
                
                // İkili renk sistemi
                if (isInCRM && isMissedCall) {
                    // Gradient: yarı CRM (mavi), yarı cevapsız (turuncu)
                    backgroundColor = 'linear-gradient(90deg, #e3f2fd 0%, #e3f2fd 50%, #fff3e0 50%, #fff3e0 100%)';
                    borderColor = '#ff9800';
                }
                
                if (leadMatch) {
                    personInfo = `<div style="font-weight: 600; color: #1976d2; margin-bottom: 4px;">👤 ${leadMatch.fullName} <span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">CRM'de</span> <span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">Cevapsız</span></div>`;
                    clickAction = `onclick="openCustomerDetail('${leadMatch.id}')"`;
                    actionButtons = `
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1);">
                            <div class="dropdown" style="display: inline-block; position: relative; z-index: 1000;">
                                <button class="btn btn-sm btn-primary dropdown-toggle" type="button" onclick="event.stopPropagation();" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="font-size: 11px; padding: 4px 8px;">
                                    ⚡ İşlemler
                            </button>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); openCustomerDetail('${leadMatch.id}');">📋 Görüntüle</a>
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); updateCRMFromMissedCall('${leadMatch.id}');">✏️ Güncelle</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); markAsUnreachableWithMessage('${caller}', '${messageTimeStr}');">🚫 Ulaşılamadı + Mesaj</a>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (memberMatch) {
                    const memberName = memberMatch.Resit_Olmayan_Adi_Soyadi || memberMatch.Ad_Soyad;
                    personInfo = `<div style="font-weight: 600; color: #388e3c; margin-bottom: 4px;">✅ Üye: ${memberName}</div>`;
                    clickAction = `onclick="showMemberAttendancePage('${memberMatch.id}')"`;
                    actionButtons = `
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1);">
                            <div class="dropdown" style="display: inline-block; position: relative; z-index: 1000;">
                                <button class="btn btn-sm btn-success dropdown-toggle" type="button" onclick="event.stopPropagation();" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="font-size: 11px; padding: 4px 8px;">
                                    ⚡ İşlemler
                            </button>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); showMemberAttendancePage('${memberMatch.id}');">📋 Üye Bilgileri</a>
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); sendMissedCallMessage('${memberMatch.Telefon || caller}', '${messageTimeStr}');">💬 Mesaj Gönder</a>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Sistemde yok - CRM'e ekle, Ulaşılamadı ve Manuel Cevaplandı butonları
                    actionButtons = `
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1);">
                            <div class="dropdown" style="display: inline-block; position: relative; z-index: 1000;">
                                <button class="btn btn-sm btn-primary dropdown-toggle" type="button" onclick="event.stopPropagation();" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="font-size: 11px; padding: 4px 8px;">
                                    ⚡ İşlemler
                            </button>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); addToCRMFromMissedCall('${caller}');">➕ CRM'e Ekle</a>
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); markMissedCallAsAnswered('${caller}', '${timeStr}');">✅ Cevaplandı</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); markAsUnreachableWithMessage('${caller}', '${messageTimeStr}');">🚫 Ulaşılamadı + Mesaj</a>
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); sendMissedCallMessage('${caller}', '${messageTimeStr}');">💬 Mesaj Gönder</a>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div style="position: relative; padding: 12px; margin-bottom: 10px; background: ${backgroundColor}; border-left: 4px solid ${borderColor}; border-radius: 6px; cursor: ${clickAction ? 'pointer' : 'default'};" ${clickAction} onmouseover="this.style.zIndex='100';" onmouseout="this.style.zIndex='1';">
                        ${personInfo}
                        <div style="font-size: 13px; color: #666;">📞 Arayan: ${formattedCaller}</div>
                        <div style="font-size: 12px; color: #888; margin-top: 2px;">📱 Aranan: ${formattedCallee}</div>
                        ${callCountStr}
                        <div style="font-size: 11px; color: #999; margin-top: 4px;">🕐 Son arama: ${timeStr}</div>
                        ${allCallTimesStr}
                        <div style="font-size: 11px; color: #ff5722; margin-top: 4px; font-weight: 600;">⏰ Dönüş yapılmadı: ${timeSinceStr}</div>
                        ${!personInfo ? '<div style="font-size: 11px; color: #d32f2f; margin-top: 4px;">⚠️ CRM\'de kayıtlı değil</div>' : ''}
                        ${actionButtons}
                    </div>
                `;
            }).join('');
        }
        
        // Bulutfon'dan cevapsız çağrıları çek
        async function fetchBulutfonMissedCalls() {
            if (!clubSettings || !clubSettings.bulutfonEnabled || !clubSettings.bulutfonApiKey) {
                console.log('⚠️ Bulutfon entegrasyonu aktif değil');
                return [];
            }
            
            try {
                console.log('📞 Cevapsız çağrılar yükleniyor...');
                
                const response = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${clubSettings.bulutfonApiKey}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    console.error('❌ Bulutfon API hatası:', response.status);
                    return [];
                }
                
                const data = await response.json();
                const allRecords = Array.isArray(data) ? data : (data.cdrs || data.data || []);
                
                if (allRecords.length === 0) {
                    return [];
                }
                
                // ✅ Cevapsız çağrıları filtrele (is_missing_call kullan - API dokümantasyonuna göre)
                let missedCalls = allRecords.filter(record => {
                    if (record.direction !== 'IN') return false;
                    
                    // API'den gelen is_missing_call parametresini kullan
                    // is_missing_call: true → Kaçan/cevapsız çağrı
                    // is_missing_call: false → Cevaplanan çağrı
                    if (record.is_missing_call !== undefined && record.is_missing_call !== null) {
                        // Boolean veya string olabilir ("true"/"false")
                        const isMissing = record.is_missing_call === true || record.is_missing_call === "true" || record.is_missing_call === 1;
                        return isMissing;
                    }
                    
                    // Fallback: is_missing_call yoksa hangup_cause kontrol et
                    // API dokümantasyonuna göre: ANSWERED = Cevaplandı
                    const hangupCause = (record.hangup_cause || '').toUpperCase();
                    const isAnswered = hangupCause === 'ANSWERED';
                    
                    return !isAnswered; // Cevapsız olanları al
                });
                
                // Son 72 saat içindeki çağrıları al
                const threeDaysAgo = new Date();
                threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
                missedCalls = missedCalls.filter(record => {
                    const callTime = new Date(record.call_time);
                    return callTime >= threeDaysAgo;
                });
                
                // Aynı numaradan gelen tüm cevapsız çağrıları grupla
                const callsByNumber = {};
                
                for (const missedCall of missedCalls) {
                    const caller = missedCall.caller?.replace(/\D/g, '');
                    if (!caller) continue;
                    
                    if (!callsByNumber[caller]) {
                        callsByNumber[caller] = [];
                    }
                    callsByNumber[caller].push(missedCall);
                }
                
                // Her numara için sonraki gelen veya giden aramayı kontrol et
                const filteredMissedCalls = [];
                
                for (const [caller, calls] of Object.entries(callsByNumber)) {
                    // En son arama zamanını al (UTC olarak)
                    const lastCallTime = new Date(Math.max(...calls.map(c => new Date(c.call_time))));
                    
                    // Debug için özel numara kontrolü
                    const isDebugNumber = caller.includes('5321646303');
                    if (isDebugNumber) {
                        console.log(`🔍 DEBUG - ${caller} için kontrol başlıyor:`, {
                            missedCallsCount: calls.length,
                            lastCallTime: lastCallTime.toISOString()
                        });
                    }
                    
                    // Bu numaradan sonraki aramalar var mı kontrol et (is_missing_call veya hangup_cause kullan)
                    const hasFollowUp = allRecords.some(record => {
                        const recordTime = new Date(record.call_time);
                        const recordCaller = (record.caller || '').replace(/\D/g, '');
                        const recordCallee = (record.callee || '').replace(/\D/g, '');
                        
                        // Aynı numara ve en son cevapsız çağrıdan sonra (UTC bazında karşılaştır)
                        if (recordTime > lastCallTime) {
                            const sameNumber = (recordCaller === caller) || (recordCallee === caller);
                            
                            // Cevaplanan arama mı kontrol et
                            let wasAnswered = false;
                            
                            // 1. Önce is_missing_call kontrol et
                            if (record.is_missing_call !== undefined && record.is_missing_call !== null) {
                                const isMissing = record.is_missing_call === true || record.is_missing_call === "true" || record.is_missing_call === 1;
                                wasAnswered = !isMissing; // is_missing_call false ise cevaplandı demektir
                            } 
                            // 2. is_missing_call yoksa hangup_cause kontrol et
                            else {
                                const hangupCause = (record.hangup_cause || '').toUpperCase();
                                wasAnswered = hangupCause === 'ANSWERED';
                            }
                            
                            // Debug log
                            if (isDebugNumber && sameNumber) {
                                console.log(`  ✓ Sonraki arama bulundu: time=${recordTime.toISOString()}, direction=${record.direction}, is_missing_call=${record.is_missing_call}, wasAnswered=${wasAnswered}`);
                            }
                            
                            return sameNumber && wasAnswered;
                        }
                        return false;
                    });
                    
                    // Debug log
                    if (isDebugNumber) {
                        console.log(`  → hasFollowUp: ${hasFollowUp} (true ise listeden çıkar, false ise listede kalır)`);
                    }
                    
                    // Eğer sonrasında cevaplanan bir arama yoksa listeye ekle
                    if (!hasFollowUp) {
                        // Tüm aramaları tarihe göre sırala
                        calls.sort((a, b) => new Date(b.call_time) - new Date(a.call_time));
                        
                        // Şu ana kadar geçen süreyi hesapla (en son aramadan)
                        // Bulutfon UTC veriyor, 3 saat çıkarmalıyız
                        const now = new Date();
                        const adjustedLastCallTime = new Date(lastCallTime);
                        adjustedLastCallTime.setHours(adjustedLastCallTime.getHours() - 3);
                        const timeDiff = Math.floor((now - adjustedLastCallTime) / 1000 / 60); // dakika
                        
                        // İlk (en son) aramayı al ve ek bilgiler ekle
                        const mainCall = calls[0];
                        mainCall.minutesSinceMissed = timeDiff;
                        mainCall.callCount = calls.length; // Kaç kere aradı
                        mainCall.allCallTimes = calls.map(c => c.call_time); // Tüm arama zamanları
                        
                        filteredMissedCalls.push(mainCall);
                    }
                }
                
                // En yeniden eskiye sırala
                filteredMissedCalls.sort((a, b) => new Date(b.call_time) - new Date(a.call_time));
                
                console.log(`📵 ${filteredMissedCalls.length} cevapsız çağrı bulundu (is_missing_call ve hangup_cause kontrolleri yapıldı)`);
                
                // Debug: Tüm kayıtların detaylı kontrolü
                if (allRecords.length > 0) {
                    const incomingCalls = allRecords.filter(r => r.direction === 'IN');
                    console.log(`🔍 Toplam ${allRecords.length} kayıt, ${incomingCalls.length} tanesi gelen arama (IN)`);
                    
                    const answeredCalls = incomingCalls.filter(r => 
                        (r.is_missing_call === false || r.is_missing_call === "false" || r.is_missing_call === 0) ||
                        (r.hangup_cause && r.hangup_cause.toUpperCase() === 'ANSWERED')
                    );
                    const missedCallsDebug = incomingCalls.filter(r => 
                        (r.is_missing_call === true || r.is_missing_call === "true" || r.is_missing_call === 1)
                    );
                    
                    console.log(`📊 Gelen aramalardan: ${answeredCalls.length} cevaplanan, ${missedCallsDebug.length} cevapsız`);
                    
                    // İlk 5 gelen aramayı detaylı göster
                    console.log('🔍 İlk 5 gelen arama detayı:');
                    incomingCalls.slice(0, 5).forEach((record, idx) => {
                        console.log(`  ${idx + 1}. is_missing_call: ${record.is_missing_call}, hangup_cause: ${record.hangup_cause}, caller: ${record.caller}, call_time: ${record.call_time}`);
                    });
                    
                    // Eğer cevaplanan arama varsa, ilkini göster
                    if (answeredCalls.length > 0) {
                        console.log('✅ Örnek cevaplanan arama:', answeredCalls[0]);
                    }
                    
                    // DEBUG: Belirli numaraların tüm aramalarını göster
                    const debugNumbers = ['905321646303', '5321646303']; // 0532 164 63 03
                    debugNumbers.forEach(debugNum => {
                        const debugCalls = allRecords.filter(r => {
                            const caller = (r.caller || '').replace(/\D/g, '');
                            const callee = (r.callee || '').replace(/\D/g, '');
                            return caller.includes(debugNum) || callee.includes(debugNum) || 
                                   caller === debugNum || callee === debugNum;
                        });
                        if (debugCalls.length > 0) {
                            console.log(`🔍 Debug: ${debugNum} numaralı tüm aramalar (${debugCalls.length} adet):`);
                            debugCalls.forEach((call, idx) => {
                                console.log(`  ${idx + 1}. direction: ${call.direction}, is_missing_call: ${call.is_missing_call}, hangup_cause: ${call.hangup_cause}, call_time: ${call.call_time}`);
                            });
                        }
                    });
                }
                
                return filteredMissedCalls.slice(0, 20); // En fazla 20 tane göster
                
            } catch (error) {
                console.error('❌ Cevapsız çağrılar alınırken hata:', error);
                return [];
            }
        }
        
        // ═══════════════════════════════════════════════════════════════
        // CEVAPSız ÇAĞRI MESAJ GÖNDERİM FONKSİYONLARI
        // ═══════════════════════════════════════════════════════════════
        
        // Cevapsız çağrı için WhatsApp mesajı gönder
        async function sendMissedCallMessage(phoneNumber, callDateTime) {
            try {
                console.log('📤 Cevapsız çağrı mesajı gönderiliyor:', phoneNumber);
                
                // Mesaj şablonlarını kontrol et
                if (!messageTemplates || !messageTemplates.missedCall) {
                    throw new Error('Mesaj şablonları yüklenmemiş');
                }
                
                if (!messageTemplates.missedCall.enabled) {
                    throw new Error('Cevapsız çağrı mesaj şablonu devre dışı');
                }
                
                // Telefon numarasını temizle
                const cleanPhone = phoneNumber.replace(/\D/g, '');
                let formattedPhone = cleanPhone;
                if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                    formattedPhone = cleanPhone; // 905551234567
                } else if (cleanPhone.startsWith('0') && cleanPhone.length === 11) {
                    formattedPhone = '90' + cleanPhone.slice(1); // 05551234567 → 905551234567
                } else if (cleanPhone.length === 10) {
                    formattedPhone = '90' + cleanPhone; // 5551234567 → 905551234567
                }
                
                // Mesai saatleri içinde mi kontrol et
                const now = new Date();
                const hour = now.getHours();
                const workingHoursStart = clubSettings?.whatsappWorkingHoursStart || 9;
                const workingHoursEnd = clubSettings?.whatsappWorkingHoursEnd || 18;
                const isWorkingHours = hour >= workingHoursStart && hour < workingHoursEnd;
                
                // Mesai saati bilgisini hazırla
                const workingHoursText = `${String(workingHoursStart).padStart(2, '0')}:00 - ${String(workingHoursEnd).padStart(2, '0')}:00`;
                
                // Uygun şablonu seç
                let messageText = isWorkingHours 
                    ? messageTemplates.missedCall.textWorkingHours 
                    : messageTemplates.missedCall.textOutsideHours;
                
                // Değişkenleri değiştir
                messageText = messageText.replace(/{TARIH}/g, callDateTime);
                messageText = messageText.replace(/{MESAI_SAATLERI}/g, workingHoursText);
                
                // WhatsApp cihazını seç
                const devices = await loadWhatsAppDevices();
                if (!devices || devices.length === 0) {
                    throw new Error('Aktif WhatsApp cihazı bulunamadı');
                }
                
                // İlk aktif cihazı kullan
                const device = devices[0];
                
                // Mesajı gönder
                const result = await sendWhatsAppMessage(
                    device.instanceName,
                    formattedPhone,
                    messageText,
                    phoneNumber // recipientName olarak telefon numarasını kullan
                );
                
                if (result.success) {
                    showToast('✅ Cevapsız çağrı mesajı gönderildi', 'success');
                    console.log('✅ Mesaj gönderildi:', formattedPhone);
                } else {
                    throw new Error(result.error || 'Mesaj gönderilemedi');
                }
                
            } catch (error) {
                console.error('❌ Cevapsız çağrı mesajı gönderilemedi:', error);
                showToast('❌ Mesaj gönderilemedi: ' + error.message, 'error');
            }
        }
        
        // Ulaşılamadı olarak işaretle VE mesaj gönder
        async function markAsUnreachableWithMessage(phoneNumber, callDateTime) {
            try {
                console.log('🚫 Ulaşılamadı işareti konuyor + mesaj gönderiliyor:', phoneNumber);
                
                // Önce "Ulaşılamadı" olarak işaretle
                const cleanCaller = phoneNumber.replace(/\D/g, '');
                let formattedCaller = cleanCaller;
                if (cleanCaller.startsWith('90') && cleanCaller.length === 12) {
                    formattedCaller = '0' + cleanCaller.slice(2);
                } else if (!cleanCaller.startsWith('0') && cleanCaller.length === 10) {
                    formattedCaller = '0' + cleanCaller;
                }
                
                // localStorage'a kaydet
                const unreachableCalls = JSON.parse(localStorage.getItem('unreachableCalls') || '{}');
                const key = formattedCaller + '_' + new Date().getTime();
                unreachableCalls[key] = {
                    phone: formattedCaller,
                    timestamp: new Date().toISOString(),
                    markedDate: new Date().toISOString()
                };
                localStorage.setItem('unreachableCalls', JSON.stringify(unreachableCalls));
                
                showToast('🚫 Ulaşılamadı olarak işaretlendi', 'info');
                
                // Mesajı gönder
                await sendMissedCallMessage(phoneNumber, callDateTime);
                
                // Sayfayı yenile
                await renderIncomingCallsPage();
                
            } catch (error) {
                console.error('❌ Ulaşılamadı işareti konulurken hata:', error);
                showToast('❌ İşlem başarısız: ' + error.message, 'error');
            }
        }
        
        // ═══════════════════════════════════════════════════════════════
        
        // Cevapsız çağrıları yenile (dashboard için)
        window.refreshMissedCalls = async function() {
            await renderMissedCalls();
        };
        
        // CRM ana sayfa: Cevapsız çağrıları minimal liste olarak göster (sadece telefon numarası)
        window.renderMissedCalls = async function() {
            const container = document.getElementById('missed-calls-list');
            if (!container) return;
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Cevapsız çağrılar yükleniyor...</span></div>';

            const missedCalls = await fetchBulutfonMissedCalls();
            if (!missedCalls || missedCalls.length === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">📵 Son 72 saatte cevapsız çağrı yok</p></div>';
                return;
            }

            container.innerHTML = missedCalls.map(call => {
                const caller = call.caller || 'Bilinmeyen';
                // Sadece numara göster (formatlanmadan, daha temiz görünüm için)
                const displayNumber = caller.replace(/\D/g, '');
                const formattedNumber = displayNumber.startsWith('90') && displayNumber.length === 12 
                    ? '0' + displayNumber.substring(2) 
                    : displayNumber;
                
                return `
                    <div style="padding: 10px 12px; margin-bottom: 8px; background: #fff8e1; border-left: 4px solid #ffa726; border-radius: 6px; cursor: pointer; font-family: monospace; font-size: 14px;" 
                         onclick="showIncomingCallsForNumber('${formattedNumber}')" 
                         title="Tıklayarak bu numaranın tüm gelen aramalarını görün">
                        📞 ${formattedNumber}
                        ${call.callCount > 1 ? `<span style="background: #ff6b6b; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-left: 8px;">${call.callCount}x</span>` : ''}
                    </div>
                `;
            }).join('');
        };
        
        // Belirli bir numaraya ait gelen aramaları göster
        window.showIncomingCallsForNumber = function(phoneNumber) {
            // Gelen aramalar sayfasına git
            showSection('crm-incoming-calls', document.querySelector('.nav-btn[onclick*=\'crm-incoming-calls\']'));
            
            // Kısa bir gecikme sonra filtreyi uygula
            setTimeout(() => {
                // Telefon filtre inputunu bul ve numara ile doldur
                const phoneFilterInput = document.getElementById('incomingPhoneFilter');
                if (phoneFilterInput) {
                    phoneFilterInput.value = phoneNumber;
                    // Filtreyi tetikle
                    filterIncomingCalls();
                }
            }, 300);
        };
        
        // Cevapsız çağrılar sayfasını yenile (artık gelen aramalara yönlendiriyor)
        window.refreshMissedCallsPage = async function() {
            await renderIncomingCallsPage();
        };
        
        // CRM ana sayfa - cevapsız çağrıları yenile
        window.refreshMissedCalls = async function() {
            await renderMissedCalls();
        };
        
        // Gelen aramalar sayfasını render et
        window.renderIncomingCallsPage = async function() {
            const container = document.getElementById('incoming-calls-list');
            if (!container) return;
            
            // Seçimleri temizle
            selectedIncomingCalls.clear();
            const selectAllCheckbox = document.getElementById('selectAllIncoming');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Gelen aramalar yükleniyor...</span></div>';
            
            // Bulutfon kontrolü - API Key'e göre kontrol et
            if (!clubSettings || !clubSettings.bulutfonApiKey) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <h3 style="color: #856404; margin-bottom: 15px;">📞 Bulutfon Entegrasyonu Gerekli</h3>
                        <p style="color: #666; margin-bottom: 20px;">
                            Gelen aramaları görüntülemek için Bulutfon API entegrasyonunu aktif etmeniz gerekiyor.
                        </p>
                        <button class="btn btn-primary" onclick="showSection('settings', document.querySelector('.nav-btn[onclick*=\\'settings\\']')); setTimeout(() => switchSettingsTab('general'), 500);">
                            ⚙️ Ayarlara Git
                        </button>
                    </div>
                `;
                return;
            }
            
            console.log('📞 Bulutfon API Key mevcut, aramalar yükleniyor...');
            
            try {
                const response = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${clubSettings.bulutfonApiKey}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const allRecords = Array.isArray(data) ? data : (data.cdrs || data.data || []);
                
                // Gelen aramaları filtrele (direction: 'IN')
                let incomingCalls = allRecords.filter(record => record.direction === 'IN');
                
                // ✅ WhatsApp gelen çağrılarını da ekle (Supabase'den)
                try {
                    console.log('📱 WhatsApp çağrıları yükleniyor (Supabase)...');
                    
                    const { data: whatsappCalls, error } = await supabase
                        .from('whatsapp_incoming_calls')
                        .select('*')
                        .eq('club_id', currentClubId)
                        .order('call_timestamp', { ascending: false })
                        .limit(100);
                    
                    if (error) {
                        console.error('❌ WhatsApp çağrıları yüklenemedi:', error);
                    } else {
                        console.log(`📱 ${whatsappCalls?.length || 0} WhatsApp çağrısı bulundu (Supabase)`);
                        
                        whatsappCalls?.forEach(whatsappCall => {
                            // Bulutfon formatına çevir
                            incomingCalls.push({
                                caller: whatsappCall.caller_phone || whatsappCall.caller_name,
                                callee: whatsappCall.called_number,
                                call_time: whatsappCall.call_timestamp,
                                direction: 'IN',
                                is_missing_call: whatsappCall.is_missing_call !== false,
                                hangup_cause: whatsappCall.is_missing_call === false ? 'ANSWERED' : 'NO_ANSWER',
                                isWhatsApp: true, // ✅ WhatsApp bayrağı
                                instanceName: whatsappCall.instance_name || 'WhatsApp',
                                callStatus: whatsappCall.status || 'unanswered' // ✅ Status ekle
                            });
                        });
                    }
                } catch (whatsappError) {
                    console.error('⚠️ WhatsApp çağrıları yüklenirken hata:', whatsappError);
                    // Hata olsa da devam et (Bulutfon aramaları gösterilir)
                }
                
                // Son 1 hafta içindeki çağrıları al
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                incomingCalls = incomingCalls.filter(record => {
                    const callTime = new Date(record.call_time);
                    return callTime >= oneWeekAgo;
                });
                
                // ✅ NOT: Silinen çağrıları burada FİLTRELEME - gruplama sonrası yapılacak
                // Çünkü aynı numaranın birden fazla çağrısı olabilir ve sadece en son çağrı silinmişse
                // diğer çağrıları da görmemiz gerekiyor (gruplama için)
                
                // ✅ İlk aramada tüm alanları görelim
                if (incomingCalls.length > 0) {
                    console.log('📋 Bulutfon Call Sample:', incomingCalls[0]);
                }
                
                // ✅ AKILLI GRUPLAMA: Aynı numaraları birleştir ve son duruma göre kategorize et
                
                // 1. Tüm giden aramaları da al (durum kontrolü için)
                const outgoingCalls = allRecords.filter(record => record.direction === 'OUT');
                
                // 2. Numaraya göre grupla
                const groupedByNumber = {};
                
                incomingCalls.forEach(call => {
                    const cleanNumber = call.caller?.replace(/\D/g, '') || 'unknown';
                    const last10Digits = cleanNumber.slice(-10);
                    
                    if (!groupedByNumber[last10Digits]) {
                        groupedByNumber[last10Digits] = {
                            number: call.caller,
                            incomingCalls: [],
                            outgoingCalls: []
                        };
                    }
                    
                    groupedByNumber[last10Digits].incomingCalls.push(call);
                });
                
                // 3. Her numara için giden aramaları da bul
                Object.keys(groupedByNumber).forEach(number => {
                    const group = groupedByNumber[number];
                    
                    group.outgoingCalls = outgoingCalls.filter(call => {
                        const cleanCallee = call.callee?.replace(/\D/g, '') || '';
                        return cleanCallee.endsWith(number) || number.endsWith(cleanCallee.slice(-10));
                    });
                });
                
                // 4. Her numara için durum analizi yap
                const analyzedCalls = Object.values(groupedByNumber).map(group => {
                    // Tüm aramaları birleştir ve tarihlerine göre sırala
                    const allCallsFromNumber = [
                        ...group.incomingCalls.map(c => ({ ...c, type: 'incoming' })),
                        ...group.outgoingCalls.map(c => ({ ...c, type: 'outgoing' }))
                    ].sort((a, b) => new Date(b.call_time) - new Date(a.call_time));
                    
                    // En son çağrıyı bul
                    const lastCall = allCallsFromNumber[0];
                    
                    // Cevapsız gelen aramaları filtrele
                    const missedIncoming = group.incomingCalls.filter(call => {
                        if (call.is_missing_call !== undefined && call.is_missing_call !== null) {
                            return call.is_missing_call === true || call.is_missing_call === "true" || call.is_missing_call === 1;
                        }
                        const hangupCause = (call.hangup_cause || '').toUpperCase();
                        return hangupCause !== 'ANSWERED';
                    });
                    
                    // Cevaplanan gelen aramaları filtrele
                    const answeredIncoming = group.incomingCalls.filter(call => {
                        if (call.is_missing_call !== undefined && call.is_missing_call !== null) {
                            return !(call.is_missing_call === true || call.is_missing_call === "true" || call.is_missing_call === 1);
                        }
                        const hangupCause = (call.hangup_cause || '').toUpperCase();
                        return hangupCause === 'ANSWERED';
                    });
                    
                    // Durum analizi
                    let status = 'unanswered'; // Varsayılan: cevapsız
                    let callbackMade = false;
                    let callbackButStillUnanswered = false; // Yeni flag: geri aradık ama cevapsız kaldı
                    
                    // En son arama giden aramaysa
                    if (lastCall.type === 'outgoing') {
                        // ✅ GİDEN ARAMALAR için answer_time kontrolü (daha güvenilir)
                        let isAnsweredOutgoing = false;
                        
                        if (lastCall.answer_time !== undefined) {
                            // answer_time varsa ve null/boş değilse → Cevaplanmış
                            isAnsweredOutgoing = lastCall.answer_time && lastCall.answer_time !== null && lastCall.answer_time !== '';
                        } else if (lastCall.hangup_cause) {
                            // Fallback: hangup_cause kontrolü
                        const hangupCause = (lastCall.hangup_cause || '').toUpperCase();
                            isAnsweredOutgoing = hangupCause === 'ANSWERED';
                        } else if (lastCall.talking_seconds !== undefined) {
                            // Son fallback: talking_seconds
                            const talkingSeconds = parseInt(lastCall.talking_seconds) || 0;
                            isAnsweredOutgoing = talkingSeconds > 0;
                        }
                        
                        if (isAnsweredOutgoing) {
                            // En son giden aramada görüşüldü
                            status = 'answered_outgoing';
                            callbackMade = true;
                        } else if (missedIncoming.length > 0) {
                            // ✅ Cevapsız gelen arama var ama geri dönüş yapılmış (cevapsız kalmış)
                            // Hala cevapsız kategorisinde kalacak ama flag set edilecek
                            status = 'unanswered';
                            callbackButStillUnanswered = true;
                            callbackMade = true;
                        }
                    } 
                    // En son arama gelen aramaysa
                    else {
                        // is_missing_call field'ı daha güvenilir (NORMAL_CLEARING hem cevaplı hem cevapsız için kullanılabiliyor)
                        if (lastCall.is_missing_call !== undefined && lastCall.is_missing_call !== null) {
                            const isMissed = lastCall.is_missing_call === true || lastCall.is_missing_call === "true" || lastCall.is_missing_call === 1;
                            status = isMissed ? 'unanswered' : 'answered';
                        } else {
                            // is_missing_call yoksa hangup_cause'a bak
                            const hangupCause = (lastCall.hangup_cause || '').toUpperCase();
                            status = (hangupCause === 'ANSWERED') ? 'answered' : 'unanswered';
                        }
                    }
                    
                    // Cevapsız arama saatlerini topla
                    const missedCallTimes = missedIncoming.map(call => {
                        const time = new Date(call.call_time);
                        time.setHours(time.getHours() - 3); // UTC'den Türkiye'ye
                        return time.toLocaleString('tr-TR', { 
                            day: '2-digit', 
                            month: '2-digit',
                            hour: '2-digit', 
                            minute: '2-digit'
                        });
                    });
                    
                    return {
                        number: group.number,
                        lastCall: lastCall,
                        status: status,
                        callbackMade: callbackMade,
                        callbackButStillUnanswered: callbackButStillUnanswered, // ✅ Yeni flag
                        totalIncomingCalls: group.incomingCalls.length,
                        totalOutgoingCalls: group.outgoingCalls.length,
                        missedCount: missedIncoming.length,
                        answeredCount: answeredIncoming.length,
                        missedCallTimes: missedCallTimes,
                        allCalls: allCallsFromNumber
                    };
                });
                
                // 5. Duruma göre kategorize et
                let unansweredCalls = analyzedCalls.filter(c => c.status === 'unanswered' && !c.callbackButStillUnanswered); // Sadece tam cevapsız
                let callbackUnansweredCalls = analyzedCalls.filter(c => c.status === 'unanswered' && c.callbackButStillUnanswered); // Dönüş yapıldı ama cevapsız
                let answeredOutgoingCalls = analyzedCalls.filter(c => c.status === 'answered_outgoing');
                let answeredCalls = analyzedCalls.filter(c => c.status === 'answered');
                
                // ✅ "Diğer" kategorisi: localStorage veya Supabase'de 'other' olan çağrılar
                // AMA: Eğer "Diğer"e atıldıktan SONRA tekrar arama gelirse, "Diğer"den ÇIKAR
                let otherCalls = analyzedCalls.filter(c => {
                    const cleanCaller = c.number?.replace(/\D/g, '') || '';
                    
                    // 1. WhatsApp çağrıları için Supabase kontrol et
                    if (c.lastCall && c.lastCall.callStatus === 'other') {
                        return true;
                    }
                    
                    // 2. Bulutfon çağrıları için localStorage kontrol et
                    const storageKey = `otherCalls_${currentClubId}`;
                    const otherCallsStorage = JSON.parse(localStorage.getItem(storageKey) || '{}');
                    
                    if (otherCallsStorage[cleanCaller]) {
                        // ✅ "Diğer"de göster - TARİH KONTROLÜ KALDIRILDI
                        // Kullanıcı manuel olarak "Diğer"e attıysa, orada kalsın
                        // Sadece kullanıcı geri getirirse çıksın
                        return true; // "Diğer"de göster
                    }
                    
                    return false;
                });
                
                // ✅ "Diğer" kategorisindeki aramaları diğer kategorilerden çıkar
                const otherNumbers = new Set(otherCalls.map(c => c.number));
                unansweredCalls = unansweredCalls.filter(c => !otherNumbers.has(c.number));
                callbackUnansweredCalls = callbackUnansweredCalls.filter(c => !otherNumbers.has(c.number));
                answeredOutgoingCalls = answeredOutgoingCalls.filter(c => !otherNumbers.has(c.number));
                answeredCalls = answeredCalls.filter(c => !otherNumbers.has(c.number));
                
                // ✅ Silinenleri filtrele (showDeletedCalls false ise) - EN SON ÇAĞRIYA göre
                if (!showDeletedCalls) {
                    unansweredCalls = unansweredCalls.filter(c => !isCallDeleted(c.number, 'incoming', c.lastCall.call_time));
                    callbackUnansweredCalls = callbackUnansweredCalls.filter(c => !isCallDeleted(c.number, 'incoming', c.lastCall.call_time));
                    answeredOutgoingCalls = answeredOutgoingCalls.filter(c => !isCallDeleted(c.number, 'incoming', c.lastCall.call_time));
                    answeredCalls = answeredCalls.filter(c => !isCallDeleted(c.number, 'incoming', c.lastCall.call_time));
                    otherCalls = otherCalls.filter(c => !isCallDeleted(c.number, 'incoming', c.lastCall.call_time));
                }
                
                // ✅ Gizlenenleri filtrele (hiddenCalls)
                if (hiddenCalls && hiddenCalls.length > 0) {
                    const isCallHidden = (number) => {
                        const cleanNumber = number?.replace(/\D/g, '') || '';
                        return hiddenCalls.some(hidden => {
                            const cleanHidden = hidden?.replace(/\D/g, '') || '';
                            return cleanNumber.endsWith(cleanHidden.slice(-10)) || cleanHidden.endsWith(cleanNumber.slice(-10));
                        });
                    };
                    
                    unansweredCalls = unansweredCalls.filter(c => !isCallHidden(c.number));
                    callbackUnansweredCalls = callbackUnansweredCalls.filter(c => !isCallHidden(c.number));
                    answeredOutgoingCalls = answeredOutgoingCalls.filter(c => !isCallHidden(c.number));
                    answeredCalls = answeredCalls.filter(c => !isCallHidden(c.number));
                    otherCalls = otherCalls.filter(c => !isCallHidden(c.number));
                    console.log(`🔍 ${hiddenCalls.length} gizli arama filtrelendi`);
                }
                
                // Sırala (en yeni en üstte)
                unansweredCalls.sort((a, b) => new Date(b.lastCall.call_time) - new Date(a.lastCall.call_time));
                callbackUnansweredCalls.sort((a, b) => new Date(b.lastCall.call_time) - new Date(a.lastCall.call_time));
                answeredOutgoingCalls.sort((a, b) => new Date(b.lastCall.call_time) - new Date(a.lastCall.call_time));
                answeredCalls.sort((a, b) => new Date(b.lastCall.call_time) - new Date(a.lastCall.call_time));
                otherCalls.sort((a, b) => new Date(b.lastCall.call_time) - new Date(a.lastCall.call_time));
                
                // Global değişkende sakla (sekmeler için)
                window.incomingCallsCategories = {
                    unanswered: unansweredCalls, // Sadece tam cevapsız
                    'callback-unanswered': callbackUnansweredCalls, // Dönüş yapıldı ama cevapsız
                    callback: answeredOutgoingCalls, // Giden aramada cevaplanmış
                    answered: answeredCalls, // Cevaplanan aramalar
                    other: otherCalls // WhatsApp, Yüz Yüze veya Diğer yolla cevaplananlar
                };
                
                // Sayıları güncelle
                document.getElementById('count-unanswered').textContent = unansweredCalls.length;
                document.getElementById('count-callback-unanswered').textContent = callbackUnansweredCalls.length;
                document.getElementById('count-callback').textContent = answeredOutgoingCalls.length;
                document.getElementById('count-answered').textContent = answeredCalls.length;
                document.getElementById('count-other').textContent = otherCalls.length;
                
                // Toplam cevapsız sayısını güncelle (bildirim için) - SADECE tam cevapsız
                window.totalUnansweredCount = unansweredCalls.length + callbackUnansweredCalls.length;
                
                // ✅ İlk yükleme ise, bildirim sayacını güncelle ve eğer cevapsız varsa bildirim göster
                if (lastMissedCallsCount === -1) {
                    lastMissedCallsCount = 0; // İlk kontrolde 0'dan başlayalım
                    console.log(`📊 İlk yükleme: Toplam cevapsız sayısı ${window.totalUnansweredCount} olarak tespit edildi`);
                    
                    // ✅ İlk yüklemede cevapsız çağrı varsa bildirim göster
                    if (window.totalUnansweredCount > 0) {
                        console.log(`🔔 İlk yükleme bildirimi: ${window.totalUnansweredCount} cevapsız çağrı mevcut`);
                        await showMissedCallNotification(window.totalUnansweredCount);
                    }
                    
                    lastMissedCallsCount = window.totalUnansweredCount;
                }
                
                if (incomingCalls.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p style="padding: 40px; color: #999;">📋 Son 72 saatte gelen arama yok</p></div>';
                return;
            }
            
                // İlk sekmeyi göster (cevapsız)
                switchIncomingCallTab('unanswered');
                
                // Toplu silme butonunu güncelle
                updateBulkDeleteButton('incoming');
            } catch (error) {
                console.error('Gelen aramalar yüklenirken hata:', error);
                container.innerHTML = '<div class="empty-state"><p style="padding: 40px; color: #f44336;">❌ Gelen aramalar yüklenirken bir hata oluştu</p></div>';
            }
        }
        
        // Sekme değiştir
        window.switchIncomingCallTab = function(tabName) {
            const container = document.getElementById('incoming-calls-list');
            if (!container || !window.incomingCallsCategories) return;
            
            // Sekme stillerini güncelle
            const tabs = ['unanswered', 'callback-unanswered', 'callback', 'answered', 'other'];
            tabs.forEach(tab => {
                const tabBtn = document.getElementById(`tab-${tab}`);
                if (tabBtn) {
                    if (tab === tabName) {
                        // Aktif sekme
                        let bgColor = '#ffebee';
                        let color = '#f44336';
                        let borderColor = '#f44336';
                        
                        if (tab === 'callback-unanswered') {
                            bgColor = '#fff3e0';
                            color = '#ff9800';
                            borderColor = '#ff9800';
                        } else if (tab === 'callback') {
                            bgColor = '#e3f2fd';
                            color = '#2196f3';
                            borderColor = '#2196f3';
                        } else if (tab === 'answered') {
                            bgColor = '#e8f5e9';
                            color = '#4caf50';
                            borderColor = '#4caf50';
                        } else if (tab === 'other') {
                            bgColor = '#f3e5f5';
                            color = '#9c27b0';
                            borderColor = '#9c27b0';
                        }
                        
                        tabBtn.style.background = bgColor;
                        tabBtn.style.color = color;
                        tabBtn.style.borderBottom = `3px solid ${borderColor}`;
                    } else {
                        // Pasif sekme
                        tabBtn.style.background = '#fff';
                        tabBtn.style.color = '#666';
                        tabBtn.style.borderBottom = '3px solid transparent';
                    }
                }
            });
            
            // İçeriği render et
            const calls = window.incomingCallsCategories[tabName] || [];
            
            if (calls.length === 0) {
                let emptyMessage = '📋 Bu kategoride arama yok';
                if (tabName === 'unanswered') {
                    emptyMessage = '✅ Harika! Cevapsız çağrınız yok.';
                } else if (tabName === 'callback-unanswered') {
                    emptyMessage = '📋 Dönüş yapıldı ama cevapsız çağrı yok';
                } else if (tabName === 'callback') {
                    emptyMessage = '📋 Giden aramada cevaplanmış çağrı yok';
                } else if (tabName === 'answered') {
                    emptyMessage = '📋 Gelen aramada cevaplanmış çağrı yok';
                } else if (tabName === 'other') {
                    emptyMessage = '📋 WhatsApp, Yüz Yüze veya Diğer yolla cevaplanan çağrı yok';
                }
                container.innerHTML = `<div class="empty-state"><p style="padding: 40px; color: #999;">${emptyMessage}</p></div>`;
                return;
            }
            
            // Limitleme
            const displayCalls = calls.slice(0, 50);
            
            // Çağrı tipine göre render et
            let callType = 'normal';
            let isMissed = false;
            
            if (tabName === 'unanswered') {
                callType = 'normal';
                isMissed = true;
            } else if (tabName === 'callback-unanswered') {
                callType = 'callback-unanswered';
                isMissed = true;
            } else if (tabName === 'callback') {
                callType = 'callback';
            } else if (tabName === 'other') {
                callType = 'other';
                isMissed = false;
            } else if (tabName === 'answered') {
                callType = 'answered';
                isMissed = false;
            }
            
            const callsHtml = displayCalls.map(call => renderIncomingCall(call, isMissed, callType)).join('');
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; padding: 15px;">
                    ${callsHtml}
                </div>
                ${calls.length > 50 ? `<p style="text-align: center; color: #666; padding: 15px;">İlk 50 arama gösteriliyor (Toplam: ${calls.length})</p>` : ''}
            `;
        };
        
        // Gelen arama kartını render et
        function renderIncomingCall(call, isMissed, callType = 'normal') {
            try {
                        const caller = call.number || call.caller || 'Bilinmeyen';
                        const formattedCaller = formatPhoneDisplay(caller);
                        
                        // ✅ ARANAN = Her zaman şirket numarası
                        // Eğer lastCall bir giden arama ise (type='outgoing'), caller=şirket
                        // Eğer lastCall bir gelen arama ise (type='incoming'), callee=şirket
                        let callee;
                        if (call.lastCall?.type === 'outgoing') {
                            // Giden aramada: caller = şirket
                            callee = call.lastCall.caller || 'Bilinmeyen';
                        } else {
                            // Gelen aramada: callee = şirket
                            callee = call.lastCall?.callee || call.callee || 'Bilinmeyen';
                        }
                        const formattedCallee = formatPhoneDisplay(callee);
                        const callTime = new Date(call.lastCall.call_time);
                        callTime.setHours(callTime.getHours() - 3); // UTC'den Türkiye saatine çevir
                        const timeStr = callTime.toLocaleString('tr-TR', { 
                            day: '2-digit', 
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit', 
                            minute: '2-digit'
                        });
                        
                            // Duration bilgisini lastCall'dan al
                            const talkingSeconds = call.lastCall.talking_seconds || call.lastCall.duration || 0;
                            const durationStr = talkingSeconds > 0 ? `${Math.floor(talkingSeconds / 60)}:${String(talkingSeconds % 60).padStart(2, '0')} dk` : '0 sn';
                            
                            // ✅ is_missing_call kullan (API dokümantasyonuna göre) - lastCall'dan al
                            let wasAnswered = false;
                            let isMissed = false;
                            
                            // Önce is_missing_call kontrol et (lastCall'dan)
                            if (call.lastCall.is_missing_call !== undefined && call.lastCall.is_missing_call !== null) {
                                const isMissingCall = call.lastCall.is_missing_call === true || call.lastCall.is_missing_call === "true" || call.lastCall.is_missing_call === 1;
                                isMissed = isMissingCall;
                                wasAnswered = !isMissingCall;
                            } 
                            // Fallback: is_missing_call yoksa hangup_cause kontrol et (lastCall'dan)
                            else {
                                const hangupCause = (call.lastCall.hangup_cause || '').toUpperCase();
                                wasAnswered = hangupCause === 'ANSWERED';
                                isMissed = !wasAnswered;
                            }
                            // ✅ Durum bilgileri - callType ve callbackButStillUnanswered durumuna göre ayarla
                            let statusIcon = '✅';
                            let statusText = 'Cevaplandı';
                            let statusColor = '#4caf50';
                            
                            // callType'a göre durum belirleme
                            if (callType === 'callback-unanswered') {
                                // Dönüş yapıldı ama cevapsız (sadece badge gösterilecek, status gösterilmeyecek)
                                statusIcon = '';
                                statusText = '';
                                statusColor = '#ff9800';
                            } else if (callType === 'callback') {
                                // Giden aramada cevaplanmış (cevapsız badge'i gösterilmeyecek)
                                statusIcon = '✅';
                                statusText = 'Cevaplandı';
                                statusColor = '#4caf50';
                            } else if (callType === 'answered') {
                                // Cevaplanan aramalar
                                statusIcon = '✅';
                                statusText = 'Cevaplandı';
                                statusColor = '#4caf50';
                            } else if (callType === 'other') {
                                // Diğer yolla cevaplananlar (WhatsApp, Yüz Yüze, Diğer)
                                statusIcon = '📋';
                                // ✅ Hangi metodla cevaplandıysa onu göster
                                statusText = call.answeredMethod || 'Diğer Yolla Cevaplandı';
                                statusColor = '#9c27b0';
                            } else if (callType === 'normal' && isMissed) {
                                // Tam cevapsız
                                statusIcon = '❌';
                                statusText = 'Cevapsız';
                                statusColor = '#f44336';
                            } else {
                                // Diğer durumlar (fallback)
                                statusIcon = wasAnswered ? '✅' : '❌';
                                statusText = wasAnswered ? 'Cevaplandı' : 'Cevapsız';
                                statusColor = wasAnswered ? '#4caf50' : '#f44336';
                            }
                            
                            // CRM'de veya üyelerde var mı kontrol et
                            const leadMatch = crmLeads.find(l => {
                                const cleanLead = l.phone?.replace(/\D/g, '');
                                const cleanCaller = caller.replace(/\D/g, '');
                                return cleanLead && cleanCaller && (
                                    cleanLead.endsWith(cleanCaller.slice(-10)) || 
                                    cleanCaller.endsWith(cleanLead.slice(-10))
                                );
                            });
                            
                            const memberMatch = members.find(m => {
                                const cleanMember = m.Telefon?.replace(/\D/g, '');
                                const cleanMember2 = m.Telefon_2?.replace(/\D/g, '');
                                const cleanCaller = caller.replace(/\D/g, '');
                                return cleanCaller && (
                                    (cleanMember && (cleanMember.endsWith(cleanCaller.slice(-10)) || cleanCaller.endsWith(cleanMember.slice(-10)))) ||
                                    (cleanMember2 && (cleanMember2.endsWith(cleanCaller.slice(-10)) || cleanCaller.endsWith(cleanMember2.slice(-10))))
                                );
                            });
                            
                            // ✅ Ulaşılamadı kontrolü
                            const cleanCaller = caller.replace(/\D/g, '');
                            const unreachableCalls = JSON.parse(localStorage.getItem('unreachableCalls') || '{}');
                            const isUnreachable = Object.values(unreachableCalls).some(u => {
                                const cleanUnreachable = u.phone?.replace(/\D/g, '');
                                return cleanUnreachable && cleanCaller && (
                                    cleanUnreachable.endsWith(cleanCaller.slice(-10)) || 
                                    cleanCaller.endsWith(cleanUnreachable.slice(-10))
                                );
                            });
                            
                            let personInfo = '';
                            let actionButtons = '';
                            let bgColor = wasAnswered ? '#e8f5e9' : (isUnreachable ? '#fff3e0' : '#ffebee');
                            let borderColor = wasAnswered ? statusColor : (isUnreachable ? '#ff9800' : statusColor);
                            
                            // Silinmiş badge ekle
                            const callDeleted = isCallDeleted(caller, 'incoming', call.lastCall.call_time);
                            const deletedBadge = callDeleted ? `<span style="background: #9e9e9e; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">🗑️ Silindi</span>` : '';
                            
                            // ✅ WhatsApp badge ekle
                            const whatsappBadge = call.lastCall.isWhatsApp ? `<span style="background: #25D366; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">📱 WhatsApp</span>` : '';
                            
                            // ✅ Otomatik mesaj gönderildi mi kontrol et
                            const autoReplySent = JSON.parse(localStorage.getItem(`autoReplySent_${currentClubId}`) || '{}');
                            const cleanCallerCheck = caller.replace(/\D/g, '');
                            const hasAutoReply = autoReplySent[cleanCallerCheck];
                            
                            // ✅ Otomatik mesaj badge ve WhatsApp butonu
                            let autoReplyBadge = '';
                            if (hasAutoReply) {
                                autoReplyBadge = `
                                    <button 
                                        onclick="openWhatsAppConversation('${caller}')" 
                                        style="background: #25D366; color: white; border: none; padding: 5px 12px; border-radius: 12px; font-size: 11px; cursor: pointer; margin-left: 8px; display: inline-flex; align-items: center; gap: 5px; font-weight: 600; box-shadow: 0 2px 4px rgba(37, 211, 102, 0.3);"
                                        title="WhatsApp konuşmasını aç"
                                    >
                                        💬 Otomatik Mesaj Gönderildi
                                    </button>
                                `;
                            }
                            
                            // ✅ Kategori badge'leri - callType'a göre
                            let categoryBadge = '';
                            if (callType === 'callback-unanswered') {
                                // Dönüş yapıldı ama cevapsız kaldı - sadece bu badge gösterilecek
                                categoryBadge = `<span style="background: #ff9800; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">↩️ Dönüş Yapıldı Ama Cevapsız</span>`;
                            } else if (callType === 'callback') {
                                // Giden aramada cevaplanmış
                                categoryBadge = `<span style="background: #2196f3; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">📞 Giden Aramada Cevaplanmış</span>`;
                            }
                            
                            // Arama sayısı ve cevapsız saatler bilgisi
                            let callCountInfo = '';
                            if (call.missedCount > 0) {
                                callCountInfo = `
                                    <div style="font-size: 12px; color: #f44336; font-weight: 600; margin-top: 6px; padding: 8px; background: rgba(244, 67, 54, 0.1); border-radius: 4px;">
                                        📵 ${call.missedCount} kere cevapsız aradı
                                        ${call.missedCallTimes && call.missedCallTimes.length > 0 ? `
                                            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                                                🕐 Saatler: ${call.missedCallTimes.join(', ')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }
                            
                            // Toplam arama sayısı
                            const totalCallsInfo = call.totalIncomingCalls > 1 ? 
                                `<span style="background: #9c27b0; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">📞 ${call.totalIncomingCalls} arama</span>` : '';
                            
                            if (leadMatch) {
                                personInfo = `<div style="font-weight: 600; font-size: 15px; color: #1976d2; margin-bottom: 6px;">👤 ${leadMatch.fullName}${deletedBadge}</div>`;
                                
                                // Dropdown menü oluştur
                                const dropdownId = `dropdown-${call.lastCall.call_time.replace(/[^0-9]/g, '')}`;
                                
                                // ✅ Gelen Aramalar İçin Sadeleştirilmiş Menü: Mesaj Gönder, Diğer Sekmesine At
                                const menuCallTime = new Date(call.lastCall.call_time);
                                menuCallTime.setHours(menuCallTime.getHours() - 3); // UTC'den Türkiye saatine
                                const menuTimeStr = menuCallTime.toLocaleString('tr-TR', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                                // ✅ Sadece cevapsız çağrılarda işlemler menüsünü göster (callback, answered, other'da gösterme)
                                const showActionsMenu = isMissed && callType !== 'callback' && callType !== 'answered' && callType !== 'other';
                                const missedCallMenuItems = showActionsMenu ? `
                                    <button class="btn btn-sm btn-secondary" onclick="sendMissedCallMessage('${leadMatch.phone || caller}', '${menuTimeStr}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left; margin-bottom: 5px;">
                                        💬 Mesaj Gönder
                                    </button>
                                    <button class="btn btn-sm" style="width: 100%; text-align: left; margin-bottom: 5px; background: #9e9e9e; color: white;" onclick="moveCallToOther('${caller}'); toggleCallDropdown('${dropdownId}')">
                                        📍 Diğer Sekmesine At
                                    </button>
                                ` : '';
                                
                                actionButtons = `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; gap: 5px; align-items: center; flex-wrap: wrap;">
                                        <button class="btn btn-sm btn-primary" onclick="openCustomerDetail('${leadMatch.id}')">
                                            📋 Görüntüle
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="showCallRecordsModal('${caller}')" title="Görüşme kayıtlarını görüntüle">
                                            📞 Görüşmeler
                                        </button>
                                        ${missedCallMenuItems ? `
                                        <div style="position: relative; display: inline-block; z-index: 10000;">
                                            <button class="btn btn-sm btn-secondary" onclick="toggleCallDropdown('${dropdownId}')" style="padding: 4px 10px;">
                                                ⚙️ İşlemler ▼
                                            </button>
                                            <div id="${dropdownId}" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 99999; min-width: 180px; padding: 8px; margin-top: 4px;">
                                                ${missedCallMenuItems}
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                `;
                                bgColor = '#e3f2fd';
                            } else if (memberMatch) {
                                const memberName = memberMatch.Resit_Olmayan_Adi_Soyadi || memberMatch.Ad_Soyad;
                                personInfo = `<div style="font-weight: 600; font-size: 15px; color: #388e3c; margin-bottom: 6px;">✅ Üye: ${memberName}${deletedBadge}</div>`;
                                
                                // Üyeler için de tarih bilgisi
                                const memberCallTimeObj = new Date(call.lastCall.call_time);
                                memberCallTimeObj.setHours(memberCallTimeObj.getHours() - 3); // UTC'den Türkiye saatine
                                const memberCallTime = memberCallTimeObj.toLocaleString('tr-TR', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                                
                                // ✅ Üyeler için de sadece cevapsız çağrılarda işlemler butonları ekle
                                const showMemberActions = isMissed && callType !== 'callback' && callType !== 'answered' && callType !== 'other';
                                const missedCallMemberButtons = showMemberActions ? `
                                    <button class="btn btn-sm btn-info" onclick="markMissedCallAsAnswered('${caller}', null, '${memberMatch.id}')" title="Manuel olarak cevaplandı işaretle">
                                        ✔️ Cevaplandı
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="sendMissedCallMessage('${memberMatch.Telefon || caller}', '${memberCallTime}')" title="Cevapsız çağrı mesajı gönder">
                                        💬 Mesaj Gönder
                                    </button>
                                ` : '';
                                
                                actionButtons = `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; flex-wrap: wrap; gap: 5px;">
                                        <button class="btn btn-sm btn-success" onclick="showMemberAttendancePage('${memberMatch.id}')">
                                            📋 Üye Bilgileri
                                        </button>
                                        ${missedCallMemberButtons}
                                    </div>
                                `;
                        } else {
                                // CRM'de olmayan cevapsız çağrılar için - FARKLI RENK
                                bgColor = '#fff8e1'; // Açık sarı/turuncu
                                borderColor = '#ffa726'; // Turuncu border
                                
                                const dropdownId = `dropdown-${call.lastCall.call_time.replace(/[^0-9]/g, '')}`;
                                const menuCallTime2 = new Date(call.lastCall.call_time);
                                menuCallTime2.setHours(menuCallTime2.getHours() - 3); // UTC'den Türkiye saatine
                                const menuTimeStr2 = menuCallTime2.toLocaleString('tr-TR', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                });
                                
                                // ✅ Sadece cevapsız çağrılarda işlemler menüsünü göster
                                const showNewCustomerActions = isMissed && callType !== 'callback' && callType !== 'answered' && callType !== 'other';
                                const missedCallMenuItems = showNewCustomerActions ? `
                                    <button class="btn btn-sm btn-secondary" onclick="sendMissedCallMessage('${caller}', '${menuTimeStr2}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left; margin-bottom: 5px;">
                                        💬 Mesaj Gönder
                                    </button>
                                    <button class="btn btn-sm" style="width: 100%; text-align: left; margin-bottom: 5px; background: #9e9e9e; color: white;" onclick="moveCallToOther('${caller}'); toggleCallDropdown('${dropdownId}')">
                                        📍 Diğer Sekmesine At
                                    </button>
                                ` : '';
                                
                                personInfo = `<div style="font-weight: 600; font-size: 15px; color: #e65100; margin-bottom: 6px;">🌟 Yeni Potansiyel Müşteri${deletedBadge}</div>`;
                                
                                actionButtons = `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; gap: 5px; align-items: center;">
                                        <button class="btn btn-sm btn-primary" onclick="addToCRMFromMissedCall('${caller}')">
                                            ➕ CRM'e Ekle
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="showCallRecordsModal('${caller}')" title="Görüşme kayıtlarını görüntüle">
                                            📞 Görüşmeler
                                        </button>
                                        ${missedCallMenuItems ? `
                                        <div style="position: relative; display: inline-block; z-index: 10000;">
                                            <button class="btn btn-sm btn-secondary" onclick="toggleCallDropdown('${dropdownId}')" style="padding: 4px 10px;">
                                                ⚙️ İşlemler ▼
                                            </button>
                                            <div id="${dropdownId}" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 99999; min-width: 180px; padding: 8px; margin-top: 4px;">
                                                ${missedCallMenuItems}
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                `;
                            }
                            
                            // Checkbox için unique key - özel karakterleri escape et
                            const safeCallTime = call.lastCall.call_time.replace(/'/g, "\\'");
                            const safeCaller = caller.replace(/'/g, "\\'");
                            const callKey = `${caller}|${call.lastCall.call_time}`;
                            const isChecked = selectedIncomingCalls.has(callKey) ? 'checked' : '';
                            
                            // CRM badge (sağ üst köşe)
                            const crmBadge = leadMatch ? `<div style="position: absolute; top: 8px; right: 8px; background: #1976d2; color: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">📋 CRM</div>` : '';
                            
                            return `
                                <div style="position: relative; padding: 15px; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 8px; transition: transform 0.2s; display: flex; gap: 12px; align-items: flex-start;" onmouseover="this.style.transform='translateY(-2px)'; this.style.zIndex='100';" onmouseout="this.style.transform='translateY(0)'; this.style.zIndex='1';">
                                    ${crmBadge}
                                    <div style="padding-top: 2px;">
                                        <input type="checkbox" class="incoming-call-checkbox" value="${callKey}" onchange="toggleIncomingCall(this, '${safeCaller}|${safeCallTime}')" ${isChecked} style="width: 20px; height: 20px; cursor: pointer; margin: 0;">
                                    </div>
                                    <div style="flex: 1;">
                                        ${personInfo}
                                        <div style="font-size: 14px; color: #333; font-weight: 500; margin-bottom: 6px;">📞 Arayan: ${formattedCaller} ${totalCallsInfo} ${whatsappBadge} ${autoReplyBadge}</div>
                                        <div style="font-size: 13px; color: #666; margin-bottom: 6px;">📱 Aranan: ${formattedCallee}</div>
                                        <div style="font-size: 13px; color: #666; margin-bottom: 4px;">🕐 En Son: ${timeStr}</div>
                                        ${statusIcon && statusText ? `<div style="font-size: 13px; color: ${statusColor}; font-weight: 600; margin-bottom: 4px;">
                                            ${statusIcon} ${statusText}
                                        </div>` : ''}
                                        ${categoryBadge ? `<div style="margin-bottom: 4px;">${categoryBadge}</div>` : ''}
                                        <div style="font-size: 12px; color: #666;">⏱️ Süre: ${durationStr}</div>
                                        ${callCountInfo}
                                        ${actionButtons}
                                    </div>
                                </div>
                            `;
            } catch (error) {
                console.error('Gelen arama kartı render hatası:', error);
                return `<div style="padding: 15px; background: #ffebee; border-radius: 8px;"><p style="color: #f44336;">❌ Kart yüklenemedi</p></div>`;
            }
        };
        
        // Giden aramalar sayfasını render et
        window.renderOutgoingCallsPage = async function() {
            const container = document.getElementById('outgoing-calls-list');
            if (!container) return;
            
            // Seçimleri temizle
            selectedOutgoingCalls.clear();
            const selectAllCheckbox = document.getElementById('selectAllOutgoing');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Giden aramalar yükleniyor...</span></div>';
            
            // Bulutfon kontrolü - API Key'e göre kontrol et
            if (!clubSettings || !clubSettings.bulutfonApiKey) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <h3 style="color: #856404; margin-bottom: 15px;">📞 Bulutfon Entegrasyonu Gerekli</h3>
                        <p style="color: #666; margin-bottom: 20px;">
                            Giden aramaları görüntülemek için Bulutfon API entegrasyonunu aktif etmeniz gerekiyor.
                        </p>
                        <button class="btn btn-primary" onclick="showSection('settings', document.querySelector('.nav-btn[onclick*=\\'settings\\']')); setTimeout(() => switchSettingsTab('general'), 500);">
                            ⚙️ Ayarlara Git
                        </button>
                    </div>
                `;
                return;
            }
            
            console.log('📞 Bulutfon API Key mevcut, aramalar yükleniyor...');
            
            try {
                const response = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${clubSettings.bulutfonApiKey}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const allRecords = Array.isArray(data) ? data : (data.cdrs || data.data || []);
                
                // Giden aramaları filtrele (direction: 'OUT')
                let outgoingCalls = allRecords.filter(record => record.direction === 'OUT');
                
                // Son 1 hafta içindeki çağrıları al
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                outgoingCalls = outgoingCalls.filter(record => {
                    const callTime = new Date(record.call_time);
                    return callTime >= oneWeekAgo;
                });
                
                // ✅ NOT: Silinen çağrıları burada FİLTRELEME - gruplama sonrası yapılacak
                // Çünkü aynı numaranın birden fazla çağrısı olabilir ve sadece en son çağrı silinmişse
                // diğer çağrıları da görmemiz gerekiyor (gruplama için)
                
                // ✅ Numaraya göre grupla ve EN SON DURUMA göre kategorilendirme yap
                const groupedByNumber = {};
                
                outgoingCalls.forEach(call => {
                    const cleanNumber = call.callee?.replace(/\D/g, '') || 'unknown';
                    const last10Digits = cleanNumber.slice(-10);
                    
                    if (!groupedByNumber[last10Digits]) {
                        groupedByNumber[last10Digits] = [];
                    }
                    
                    groupedByNumber[last10Digits].push(call);
                });
                
                // Her numara için en son duruma göre kategorilendirme yap
                const analyzedCalls = Object.values(groupedByNumber).map(calls => {
                    // En son çağrıyı bul (en yeni tarih)
                    calls.sort((a, b) => new Date(b.call_time) - new Date(a.call_time));
                    const lastCall = calls[0];
                    
                    // En son çağrının durumunu kontrol et
                    let isAnswered = false;
                    
                    // 1. answer_time kontrolü (öncelikli - giden aramalar için)
                    if (lastCall.answer_time !== undefined) {
                        isAnswered = lastCall.answer_time && lastCall.answer_time !== null && lastCall.answer_time !== '';
                    }
                    // 2. hangup_cause kontrolü (fallback)
                    else if (lastCall.hangup_cause) {
                        const hangupCause = (lastCall.hangup_cause || '').toUpperCase();
                        isAnswered = hangupCause === 'ANSWERED';
                    }
                    // 3. Son fallback: talking_seconds kontrolü
                    else {
                        const talkingSeconds = parseInt(lastCall.talking_seconds) || 0;
                        isAnswered = talkingSeconds > 0;
                    }
                    
                    return {
                        number: lastCall.callee,
                        lastCall: lastCall,
                        status: isAnswered ? 'answered' : 'unanswered',
                        totalCalls: calls.length,
                        allCalls: calls
                    };
                });
                
                // Duruma göre ayır
                let missedCalls = analyzedCalls.filter(c => c.status === 'unanswered');
                let answeredCalls = analyzedCalls.filter(c => c.status === 'answered');
                
                // ✅ Silinenleri filtrele (showDeletedCalls false ise) - EN SON ÇAĞRIYA göre
                if (!showDeletedCalls) {
                    missedCalls = missedCalls.filter(c => !isCallDeleted(c.number, 'outgoing', c.lastCall.call_time));
                    answeredCalls = answeredCalls.filter(c => !isCallDeleted(c.number, 'outgoing', c.lastCall.call_time));
                }
                
                // ✅ Gizlenenleri filtrele (hiddenCalls)
                if (hiddenCalls && hiddenCalls.length > 0) {
                    const isCallHidden = (number) => {
                        const cleanNumber = number?.replace(/\D/g, '') || '';
                        return hiddenCalls.some(hidden => {
                            const cleanHidden = hidden?.replace(/\D/g, '') || '';
                            return cleanNumber.endsWith(cleanHidden.slice(-10)) || cleanHidden.endsWith(cleanNumber.slice(-10));
                        });
                    };
                    
                    missedCalls = missedCalls.filter(c => !isCallHidden(c.number));
                    answeredCalls = answeredCalls.filter(c => !isCallHidden(c.number));
                    console.log(`🔍 Giden aramalarda ${hiddenCalls.length} gizli arama filtrelendi`);
                }
                
                // Her ikisini de sırala (en yeni en üstte)
                missedCalls.sort((a, b) => new Date(b.lastCall.call_time) - new Date(a.lastCall.call_time));
                answeredCalls.sort((a, b) => new Date(b.lastCall.call_time) - new Date(a.lastCall.call_time));
                
                // Debug: İlk birkaç kaydı göster
                console.log(`📊 Giden aramalar: ${missedCalls.length} cevapsız, ${answeredCalls.length} cevaplanan`);
                if (outgoingCalls.length > 0) {
                    console.log('🔍 İlk 3 giden arama:');
                    outgoingCalls.slice(0, 3).forEach((call, idx) => {
                        console.log(`  ${idx + 1}. answer_time: ${call.answer_time || 'null'}, hangup_cause: ${call.hangup_cause}, talking_seconds: ${call.talking_seconds}, callee: ${call.callee}`);
                    });
                }
                
                // Global değişkende sakla (sekmeler için - ileride kullanılabilir)
                window.outgoingCallsCategories = {
                    unanswered: missedCalls,
                    answered: answeredCalls
                };
                
                // En fazla 30 cevapsız, 50 cevaplı
                const displayMissed = missedCalls.slice(0, 30);
                const displayAnswered = answeredCalls.slice(0, 50);
                
                if (outgoingCalls.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p style="padding: 40px; color: #999;">📋 Son 72 saatte giden arama yok</p></div>';
                    return;
                }
                
                // Cevapsız çağrılar bölümü
                let missedSection = '';
                if (displayMissed.length > 0) {
                    missedSection = `
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #f44336; font-size: 18px; margin-bottom: 15px; padding: 10px; background: #ffebee; border-left: 4px solid #f44336; border-radius: 4px;">
                                📵 Cevapsız Çağrılar (${displayMissed.length}) - En Son Arama
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; padding: 15px;">
                                ${displayMissed.map(call => renderOutgoingCall(call, true)).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // Cevaplanan aramalar bölümü
                let answeredSection = '';
                if (displayAnswered.length > 0) {
                    answeredSection = `
                        <div>
                            <h3 style="color: #4caf50; font-size: 18px; margin-bottom: 15px; padding: 10px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 4px;">
                                ✅ Cevaplanan Aramalar (${displayAnswered.length}) - En Son Arama
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; padding: 15px;">
                                ${displayAnswered.map(call => renderOutgoingCall(call, false)).join('')}
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = missedSection + answeredSection;
                
                // Toplu silme butonunu güncelle
                updateBulkDeleteButton('outgoing');
            } catch (error) {
                console.error('Giden aramalar yüklenirken hata:', error);
                container.innerHTML = '<div class="empty-state"><p style="padding: 40px; color: #f44336;">❌ Giden aramalar yüklenirken bir hata oluştu</p></div>';
            }
        }
        
        // Giden arama kartını render et
        function renderOutgoingCall(call, isMissedParam) {
            try {
                // call.lastCall yapısından veri al
                const actualCall = call.lastCall || call; // Eski yapıyla uyumluluk için
                
                // ✅ GİDEN ARAMADA: caller=şirket, callee=müşteri
                // "Aranan" = şirket olmalı (orijinal aramada aranan şirketti)
                const callerNumber = actualCall.caller || 'Bilinmeyen'; // Şirket numarası
                const calleeNumber = call.number || actualCall.callee || 'Bilinmeyen'; // Müşteri numarası
                
                // ✅ "Aranan" sütunu için şirket numarasını kullan
                const callee = callerNumber; // Aranan = Şirket
                const formattedCallee = formatPhoneDisplay(callee);
                
                // ✅ "Arayan" sütunu için müşteri numarasını kullan
                const caller = calleeNumber; // Arayan = Müşteri
                const formattedCaller = formatPhoneDisplay(caller);
                const callTime = new Date(actualCall.call_time);
                callTime.setHours(callTime.getHours() - 3); // UTC'den Türkiye saatine çevir
                const timeStr = callTime.toLocaleString('tr-TR', { 
                    day: '2-digit', 
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit'
                });
                
                // Duration bilgisini actualCall'dan al
                const talkingSeconds = actualCall.talking_seconds || actualCall.duration || 0;
                const durationStr = talkingSeconds > 0 ? `${Math.floor(talkingSeconds / 60)}:${String(talkingSeconds % 60).padStart(2, '0')} dk` : '0 sn';
                
                // isMissedParam'dan durumu al (status'den de kontrol et)
                const isMissed = call.status === 'unanswered' || isMissedParam;
                const wasAnswered = !isMissedParam;
                const statusIcon = wasAnswered ? '✅' : '❌';
                const statusText = wasAnswered ? 'Cevaplandı' : 'Cevapsız';
                const statusColor = wasAnswered ? '#4caf50' : '#f44336';
                        
                        // CRM'de veya üyelerde var mı kontrol et
                        const leadMatch = crmLeads.find(l => {
                                const cleanLead = l.phone?.replace(/\D/g, '');
                                const cleanCallee = callee.replace(/\D/g, '');
                                return cleanLead && cleanCallee && (
                                    cleanLead.endsWith(cleanCallee.slice(-10)) || 
                                    cleanCallee.endsWith(cleanLead.slice(-10))
                            );
                        });
                        
                        const memberMatch = members.find(m => {
                                const cleanMember = m.Telefon?.replace(/\D/g, '');
                                const cleanMember2 = m.Telefon_2?.replace(/\D/g, '');
                                const cleanCallee = callee.replace(/\D/g, '');
                                return cleanCallee && (
                                    (cleanMember && (cleanMember.endsWith(cleanCallee.slice(-10)) || cleanCallee.endsWith(cleanMember.slice(-10)))) ||
                                    (cleanMember2 && (cleanMember2.endsWith(cleanCallee.slice(-10)) || cleanCallee.endsWith(cleanMember2.slice(-10))))
                            );
                        });
                        
                        let personInfo = '';
                        let actionButtons = '';
                            let bgColor = wasAnswered ? '#e8f5e9' : '#ffebee';
                            let borderColor = statusColor;
                            
                            // Silinmiş badge ekle
                            const callDeleted = isCallDeleted(callee, 'outgoing', call.call_time);
                            const deletedBadge = callDeleted ? `<span style="background: #9e9e9e; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">🗑️ Silindi</span>` : '';
                            
                            const deleteButton = callDeleted ? 
                                `<button class="btn btn-sm btn-secondary" onclick="undeleteCall('${callee}', 'outgoing', '${call.call_time}')" title="Çağrıyı geri getir">↩️ Geri Al</button>` :
                                `<button class="btn btn-sm btn-danger" onclick="deleteCall('${callee}', 'outgoing', '${call.call_time}')" title="Çağrıyı sil">🗑️ Sil</button>`;
                        
                        if (leadMatch) {
                                personInfo = `<div style="font-weight: 600; font-size: 15px; color: #1976d2; margin-bottom: 6px;">👤 ${leadMatch.fullName}${deletedBadge}</div>`;
                                
                                const dropdownId = `dropdown-out-${actualCall.call_time.replace(/[^0-9]/g, '')}`;
                                
                                // Toplam arama sayısı badge
                                const totalCallsInfo = call.totalCalls && call.totalCalls > 1 ? 
                                    `<span style="background: #9c27b0; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">📞 ${call.totalCalls} arama</span>` : '';
                                
                            actionButtons = `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; gap: 5px; align-items: center; flex-wrap: wrap;">
                                        <button class="btn btn-sm btn-primary" onclick="openCustomerDetail('${leadMatch.id}')">
                                        📋 Görüntüle
                                    </button>
                                        <button class="btn btn-sm btn-info" onclick="showCallRecordsModal('${callee}')" title="Görüşme kayıtlarını görüntüle">
                                            📞 Görüşmeler
                                        </button>
                                        <div style="position: relative; display: inline-block; z-index: 10000;">
                                            <button class="btn btn-sm btn-secondary" onclick="toggleCallDropdown('${dropdownId}')" style="padding: 4px 10px;">
                                                ⚙️ İşlemler ▼
                                            </button>
                                            <div id="${dropdownId}" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 99999; min-width: 180px; padding: 8px; margin-top: 4px;">
                                                <button class="btn btn-sm btn-success" onclick="updateCRMFromMissedCall('${leadMatch.id}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left; margin-bottom: 5px;">
                                            ✏️ Güncelle
                                    </button>
                                                <div style="border-top: 1px solid #e0e0e0; margin: 5px 0;"></div>
                                                ${callDeleted ? 
                                                    `<button class="btn btn-sm btn-secondary" onclick="undeleteCall('${callee}', 'outgoing', '${actualCall.call_time}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left;">↩️ Geri Al</button>` :
                                                    `<button class="btn btn-sm btn-danger" onclick="deleteCall('${callee}', 'outgoing', '${actualCall.call_time}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left;">🗑️ Sil</button>`}
                                            </div>
                                        </div>
                                        ${totalCallsInfo}
                                </div>
                            `;
                            bgColor = '#e3f2fd';
                        } else if (memberMatch) {
                            const memberName = memberMatch.Resit_Olmayan_Adi_Soyadi || memberMatch.Ad_Soyad;
                                personInfo = `<div style="font-weight: 600; font-size: 15px; color: #388e3c; margin-bottom: 6px;">✅ Üye: ${memberName}${deletedBadge}</div>`;
                            actionButtons = `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; flex-wrap: wrap; gap: 5px;">
                                        <button class="btn btn-sm btn-success" onclick="showMemberAttendancePage('${memberMatch.id}')">
                                            📋 Üye Bilgileri
                                    </button>
                                        ${deleteButton}
                                </div>
                            `;
                        } else {
                                // CRM'de olmayan için - FARKLI RENK
                                bgColor = '#fff8e1'; // Açık sarı/turuncu
                                borderColor = '#ffa726'; // Turuncu border
                                personInfo = `<div style="font-weight: 600; font-size: 15px; color: #e65100; margin-bottom: 6px;">🌟 Yeni Potansiyel Müşteri${deletedBadge}</div>`;
                                
                                const dropdownId = `dropdown-out-${actualCall.call_time ? actualCall.call_time.replace(/[^0-9]/g, '') : 'unknown'}`;
                                
                            actionButtons = `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; gap: 5px; align-items: center;">
                                        <button class="btn btn-sm btn-primary" onclick="addToCRMFromMissedCall('${callee}')">
                                        ➕ CRM'e Ekle
                                    </button>
                                        <button class="btn btn-sm btn-info" onclick="showCallRecordsModal('${callee}')" title="Görüşme kayıtlarını görüntüle">
                                            📞 Görüşmeler
                                        </button>
                                        <div style="position: relative; display: inline-block; z-index: 10000;">
                                            <button class="btn btn-sm btn-secondary" onclick="toggleCallDropdown('${dropdownId}')" style="padding: 4px 10px;">
                                                ⚙️ İşlemler ▼
                                            </button>
                                            <div id="${dropdownId}" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 99999; min-width: 180px; padding: 8px; margin-top: 4px;">
                                                <button class="btn btn-sm btn-secondary" onclick="sendMissedCallMessage('${callee}', 'Müşteri'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left; margin-bottom: 5px;">
                                            💬 Mesaj Gönder
                                        </button>
                                                <div style="border-top: 1px solid #e0e0e0; margin: 5px 0;"></div>
                                                ${callDeleted ? 
                                                    `<button class="btn btn-sm btn-secondary" onclick="undeleteCall('${callee}', 'outgoing', '${actualCall.call_time}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left;">↩️ Geri Al</button>` :
                                                    `<button class="btn btn-sm btn-danger" onclick="deleteCall('${callee}', 'outgoing', '${actualCall.call_time}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left;">🗑️ Sil</button>`}
                                            </div>
                                        </div>
                                </div>
                            `;
                        }
                        
                // Checkbox için unique key - özel karakterleri escape et
                const safeCallTime = actualCall.call_time ? actualCall.call_time.replace(/'/g, "\\'") : '';
                const safeCallee = callee ? callee.replace(/'/g, "\\'") : '';
                const callKey = `${callee}|${actualCall.call_time}`;
                const isChecked = selectedOutgoingCalls.has(callKey) ? 'checked' : '';
                
                // CRM badge (sağ üst köşe)
                const crmBadge = leadMatch ? `<div style="position: absolute; top: 8px; right: 8px; background: #1976d2; color: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">📋 CRM</div>` : '';
                        
                return `
                    <div style="position: relative; padding: 15px; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 8px; transition: transform 0.2s; display: flex; gap: 12px; align-items: flex-start;" onmouseover="this.style.transform='translateY(-2px)'; this.style.zIndex='100';" onmouseout="this.style.transform='translateY(0)'; this.style.zIndex='1';">
                        ${crmBadge}
                        <div style="padding-top: 2px;">
                            <input type="checkbox" class="outgoing-call-checkbox" value="${callKey}" onchange="toggleOutgoingCall(this, '${safeCallee}|${safeCallTime}')" ${isChecked} style="width: 20px; height: 20px; cursor: pointer; margin: 0;">
                        </div>
                        <div style="flex: 1;">
                            ${personInfo}
                            <div style="font-size: 14px; color: #333; font-weight: 500; margin-bottom: 6px;">📞 Aranan: ${formattedCallee}</div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 6px;">📱 Arayan: ${formattedCaller}</div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 4px;">🕐 ${timeStr}</div>
                            <div style="font-size: 13px; color: ${statusColor}; font-weight: 600; margin-bottom: 4px;">
                                ${statusIcon} ${statusText}
                            </div>
                            <div style="font-size: 12px; color: #666;">⏱️ Süre: ${durationStr}</div>
                            ${actionButtons}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Giden arama kartı render hatası:', error);
                return `<div style="padding: 15px; background: #ffebee; border-radius: 8px;"><p style="color: #f44336;">❌ Kart yüklenemedi</p></div>`;
            }
        }
        
        // Cevapsız çağrılar için otomatik kontrol sistemi
        let missedCallsCheckInterval = null;
        let lastMissedCallsCount = -1; // -1 = henüz kontrol edilmedi, ilk kontrolde bildirim gönder
        
        // Not: Gizli çağrı sistemi kaldırıldı - artık sadece yerel silme var
        
        // ✅ YENİ CEVAPSIZ ÇAĞRILARA OTOMATİK MESAJ GÖNDER (ÖNCELİKLE TANIMLA!)
        window.sendAutoReplyToNewMissedCalls = async function sendAutoReplyToNewMissedCalls() {
            try {
                console.log('🚀 sendAutoReplyToNewMissedCalls() başlatıldı');
                
                // WhatsApp cihazlarını kontrol et (Global array kullan)
                if (!whatsappDevices || whatsappDevices.length === 0) {
                    console.log('⚠️ WhatsApp cihazı yapılandırılmamış, otomatik mesaj gönderilemiyor');
                    console.log('   whatsappDevices:', whatsappDevices);
                    return;
                }
                
                console.log(`✅ ${whatsappDevices.length} WhatsApp cihazı bulundu`);
                
                // Cevapsız çağrıları al
                const unansweredCalls = window.incomingCallsCategories?.unanswered || [];
                
                if (unansweredCalls.length === 0) {
                    console.log('📞 Cevapsız çağrı yok');
                    return;
                }
                
                console.log(`📞 ${unansweredCalls.length} cevapsız çağrı bulundu, otomatik mesaj kontrolü başlıyor...`);
                
                // Bugünün tarihi (sadece gün-ay-yıl)
                const today = new Date().toLocaleDateString('tr-TR');
                
                // Bugün mesaj gönderilenler
                const todaySentMessages = JSON.parse(localStorage.getItem(`autoReplySentToday_${currentClubId}_${today}`) || '{}');
                
                // CRM mesaj şablonundan "Cevapsız çağrıya otomatik mesaj" şablonunu al
                const customTemplates = JSON.parse(localStorage.getItem(`crmTemplates_${currentClubId}`) || '{}');
                let messageTemplate = '';
                
                if (customTemplates['incoming-missed-call-template']) {
                    messageTemplate = customTemplates['incoming-missed-call-template'].message;
                } else {
                    // Varsayılan şablon
                    messageTemplate = 'Merhaba,\n\nBizi {TARIH} tarihinde aramaya çalıştınız ancak o anda yoğunluktan dolayı telefonunuzu açamadık.\n\nSize nasıl yardımcı olabiliriz?\n\nLütfen bizi tekrar arayabilir veya mesajınızı buradan iletebilirsiniz.\n\nTeşekkürler,\nSporcum';
                }
                
                let sentCount = 0;
                
                // Her cevapsız çağrı için mesaj gönder
                for (const call of unansweredCalls) {
                    const callerPhone = call.number; // Arayan numara
                    const calleePhone = call.lastCall?.callee || ''; // ✅ Aranan numara (ÖNEMLİ!)
                    
                    const cleanCaller = callerPhone.replace(/\D/g, '');
                    const cleanCallee = calleePhone.replace(/\D/g, '');
                    
                    console.log(`🔍 Çağrı detayı: Arayan=${cleanCaller}, Aranan=${cleanCallee}`);
                    
                    // ✅ GÜNLÜK LİMİT KONTROLÜ: Aynı numaraya bugün mesaj gönderildiyse ATLA
                    if (todaySentMessages[cleanCaller]) {
                        console.log(`⏭️ ${cleanCaller} - Bugün zaten mesaj gönderildi, atlanıyor`);
                        continue;
                    }
                    
                    // ✅ ARANAN NUMARAYA GÖRE WHATSAPP CİHAZINI BUL
                    let deviceToUse = null;
                    
                    // Aranan numarayı tüm WhatsApp cihazlarıyla karşılaştır
                    for (const device of whatsappDevices) {
                        const devicePhone = (device.phoneNumber || '').replace(/\D/g, '');
                        
                        // Son 10 haneyi karşılaştır (0362 363 00 64 → 3623630064)
                        const deviceLast10 = devicePhone.slice(-10);
                        const calleeLast10 = cleanCallee.slice(-10);
                        
                        if (deviceLast10 === calleeLast10) {
                            deviceToUse = device.instanceName;
                            console.log(`✅ Eşleşen cihaz bulundu: ${device.instanceName} (${device.phoneNumber})`);
                            break;
                        }
                    }
                    
                    // ❌ Eğer eşleşen cihaz bulunamadıysa, MESAJ GÖNDERME
                    if (!deviceToUse) {
                        console.log(`⚠️ ${cleanCallee} numarasına ait WhatsApp cihazı bulunamadı, mesaj gönderilmiyor`);
                        continue; // Bu çağrıyı atla
                    }
                    
                    // ✅ MESAİ SAATİ KONTROLÜ - clubSettings'den al
                    const callTimeStr = call.lastCall.call_time; // "2025-11-20 14:30:45" formatında
                    let callDate = new Date();
                    
                    if (callTimeStr && typeof callTimeStr === 'string') {
                        const [datePart, timePart] = callTimeStr.split(' ');
                        if (datePart && timePart) {
                            const [year, month, day] = datePart.split('-');
                            const [hour, minute, second] = timePart.split(':');
                            callDate = new Date(year, month - 1, day, hour, minute, second);
                        }
                    }
                    
                    const callHour = callDate.getHours();
                    const callMinute = callDate.getMinutes();
                    const callDay = callDate.getDay(); // 0 = Pazar, 6 = Cumartesi
                    
                    // Çalışma saatlerini clubSettings'den al
                    const workingHoursEnabled = clubSettings?.workingHoursEnabled || false;
                    
                    if (workingHoursEnabled) {
                        const [startHour, startMin] = (clubSettings.workingHoursStart || '09:00').split(':').map(Number);
                        const [endHour, endMin] = (clubSettings.workingHoursEnd || '18:00').split(':').map(Number);
                        
                        // Çalışma günlerini kontrol et
                        const workDays = clubSettings.workingDays || [1, 2, 3, 4, 5]; // Varsayılan: Pazartesi-Cuma
                        const isWorkingDay = workDays.includes(callDay);
                        
                        if (!isWorkingDay) {
                            console.log(`⏰ Çağrı çalışma günü dışında yapılmış (${['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'][callDay]}), otomatik mesaj gönderilmiyor`);
                            continue;
                        }
                        
                        // Saat kontrolü
                        const callTimeInMinutes = callHour * 60 + callMinute;
                        const startTimeInMinutes = startHour * 60 + startMin;
                        const endTimeInMinutes = endHour * 60 + endMin;
                        
                        const isWorkingHours = callTimeInMinutes >= startTimeInMinutes && callTimeInMinutes < endTimeInMinutes;
                        
                        if (!isWorkingHours) {
                            console.log(`⏰ Çağrı çalışma saati dışında yapılmış (${String(callHour).padStart(2, '0')}:${String(callMinute).padStart(2, '0')}), otomatik mesaj gönderilmiyor`);
                            console.log(`   Çalışma saatleri: ${clubSettings.workingHoursStart} - ${clubSettings.workingHoursEnd}`);
                            continue;
                        }
                        
                        console.log(`✅ Çağrı çalışma saati içinde (${String(callHour).padStart(2, '0')}:${String(callMinute).padStart(2, '0')}), otomatik mesaj gönderiliyor...`);
                    } else {
                        console.log(`ℹ️ Çalışma saati kontrolü devre dışı, her zaman mesaj gönderiliyor...`);
                    }
                    
                    // Arayan numarayı formatla
                    let formattedCaller = cleanCaller;
                    if (cleanCaller.startsWith('90') && cleanCaller.length === 12) {
                        formattedCaller = '0' + cleanCaller.slice(2);
                    } else if (!cleanCaller.startsWith('0') && cleanCaller.length === 10) {
                        formattedCaller = '0' + cleanCaller;
                    }
                    
                    // Tarihi Türkçe formatla (DD.MM.YYYY HH:MM)
                    let formattedDate = callTimeStr;
                    
                    try {
                        if (callTimeStr && typeof callTimeStr === 'string') {
                            // "2025-11-20 15:42:24" formatından parse et
                            const [datePart, timePart] = callTimeStr.split(' ');
                            if (datePart && timePart) {
                                const [year, month, day] = datePart.split('-');
                                const [hour, minute] = timePart.split(':');
                                formattedDate = `${day}.${month}.${year} ${hour}:${minute}`;
                            }
                        }
                    } catch (e) {
                        console.warn('⚠️ Tarih formatlanamadı:', e);
                    }
                    
                    // Mesaj metnini oluştur
                    const finalMessage = messageTemplate.replace(/{TARIH}/g, formattedDate);
                    
                    console.log(`📤 Mesaj gönderiliyor: ${formattedCaller} → Cihaz: ${deviceToUse}`);
                    
                    // Mesajı kuyruğa ekle
                    await window.firebase.addDoc(
                        window.firebase.collection(window.db, 'messageQueue'),
                        {
                            clubId: currentClubId,
                            phone: formattedCaller,
                            message: finalMessage,
                            deviceId: deviceToUse, // ✅ Aranan numaraya göre seçilen cihaz
                            scheduledFor: new Date().toISOString(),
                            status: 'pending',
                            createdAt: new Date().toISOString(),
                            createdBy: 'Sistem (Otomatik)',
                            type: 'auto_reply_missed_call'
                        }
                    );
                    
                    // ✅ localStorage'a kaydet (WhatsApp simgesi için)
                    const autoReplySent = JSON.parse(localStorage.getItem(`autoReplySent_${currentClubId}`) || '{}');
                    autoReplySent[cleanCaller] = {
                        phone: formattedCaller,
                        sentDate: new Date().toISOString(),
                        callTime: callTimeStr,
                        deviceUsed: deviceToUse
                    };
                    localStorage.setItem(`autoReplySent_${currentClubId}`, JSON.stringify(autoReplySent));
                    
                    // Günlük takip için bugün gönderildi olarak işaretle
                    todaySentMessages[cleanCaller] = {
                        sentDate: new Date().toISOString(),
                        formattedPhone: formattedCaller,
                        deviceUsed: deviceToUse
                    };
                    
                    sentCount++;
                    console.log(`✅ Otomatik mesaj kuyruğa eklendi: ${formattedCaller} (Cihaz: ${deviceToUse})`);
                }
                
                // Bugün gönderilenleri kaydet
                if (sentCount > 0) {
                    localStorage.setItem(`autoReplySentToday_${currentClubId}_${today}`, JSON.stringify(todaySentMessages));
                    console.log(`✅ ${sentCount} otomatik mesaj başarıyla kuyruğa eklendi`);
                } else {
                    console.log('ℹ️ Otomatik mesaj gönderilecek yeni çağrı yok');
                }
                
            } catch (error) {
                console.error('❌ Otomatik mesaj gönderme hatası:', error);
            }
        };
        
        // Otomatik kontrolü başlat
        async function startMissedCallsAutoCheck() {
            // Eğer Bulutfon aktif değilse başlatma
            if (!clubSettings || !clubSettings.bulutfonEnabled || !clubSettings.bulutfonApiKey) {
                return;
            }
            
            console.log('⏳ Cevapsız çağrı bildirimi sistemi başlatıldı');
            
            // Varsa önceki interval'i temizle
            if (missedCallsCheckInterval) {
                clearInterval(missedCallsCheckInterval);
            }
            
            // ✅ İlk kontrolü hemen yap (sayfa açılır açılmaz)
            setTimeout(async () => {
                await checkForNewMissedCalls();
            }, 2000); // 2 saniye sonra (sayfa yüklenmesini bekle)
            
            // Her 2 dakikada bir kontrol et
            missedCallsCheckInterval = setInterval(async () => {
                await checkForNewMissedCalls();
            }, 120 * 1000); // 120 saniye = 2 dakika
            
            console.log('✅ Cevapsız çağrılar otomatik kontrol başlatıldı (Her 2 dakikada bir)');
        }
        
        // Yeni cevapsız çağrıları kontrol et
        async function checkForNewMissedCalls() {
            try {
                // ✅ Cevapsız çağrıları yeniden hesapla
                await renderIncomingCallsPage();
                
                // Toplam cevapsız sayısını al (SADECE tam cevapsız)
                const currentCount = window.totalUnansweredCount || 0;
                
                console.log(`🔍 Kontrol: Şu an ${currentCount} cevapsız, önceki: ${lastMissedCallsCount}`);
                
                // Eğer sayı artmışsa bildirim göster VE otomatik mesaj gönder
                if (currentCount > lastMissedCallsCount && lastMissedCallsCount >= 0) {
                    const newCallsCount = currentCount - lastMissedCallsCount;
                    if (newCallsCount > 0) {
                        console.log(`🔔 ${newCallsCount} yeni cevapsız çağrı tespit edildi!`);
                        await showMissedCallNotification(newCallsCount);
                        
                        // ✅ YENİ CEVAPSIZ ÇAĞRILARA OTOMATIK MESAJ GÖNDER
                        if (typeof window.sendAutoReplyToNewMissedCalls === 'function') {
                            await window.sendAutoReplyToNewMissedCalls();
                        } else {
                            console.error('❌ sendAutoReplyToNewMissedCalls fonksiyonu tanımlı değil!');
                        }
                    }
                }
                
                lastMissedCallsCount = currentCount;
                
            } catch (error) {
                console.error('❌ Cevapsız çağrı kontrolü hatası:', error);
            }
        }
        
        // Sesli ve görsel bildirim göster
        async function showMissedCallNotification(count) {
            console.log(`🔔 Bildirim gösteriliyor: ${count} yeni cevapsız çağrı`);
            
            // Görsel bildirim (Browser Notification API)
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    const notificationBody = count === 1 
                        ? '1 cevapsız çağrınız var! Hemen inceleyin.' 
                        : `${count} cevapsız çağrınız var! Hemen inceleyin.`;
                    
                    const notification = new Notification('📵 Cevapsız Çağrı!', {
                        body: notificationBody,
                        icon: 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext y=%220.9em%22 font-size=%2290%22%3E📵%3C/text%3E%3C/svg%3E',
                        tag: 'missed-calls-' + Date.now(),
                        requireInteraction: true,
                        silent: false
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        showSection('crm-incoming-calls', document.querySelector('.nav-btn[onclick*=\'crm-incoming-calls\']'));
                        notification.close();
                    };
                    
                    console.log('✅ Browser bildirimi gönderildi');
                } else if (Notification.permission === 'default') {
                    requestNotificationPermission();
                }
            }
            
            // Sesli bildirim
            await playNotificationSound();
            
            // Sayfa içi bildirim (clickable alert) - ÇOK DAHA BELİRGİN
            let alertMessage;
            if (count >= 3) {
                alertMessage = `📵 ACELE! ${count} CEVAPSIZ ÇAĞRI!`;
            } else if (count === 1) {
                alertMessage = `📵 1 CEVAPSIZ ÇAĞRI!`;
            } else {
                alertMessage = `📵 ${count} CEVAPSIZ ÇAĞRI!`;
            }
            
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                right: 20px;
                background: ${count >= 3 ? 'linear-gradient(135deg, #f44336 0%, #e91e63 100%)' : 'linear-gradient(135deg, #ff9800 0%, #ff5722 100%)'};
                color: white;
                padding: 25px 40px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.4);
                z-index: 100000;
                cursor: pointer;
                font-size: 18px;
                font-weight: 700;
                animation: bounceIn 0.5s ease-out;
                max-width: 450px;
                border: 3px solid white;
                text-align: center;
            `;
            alertDiv.textContent = alertMessage;
            alertDiv.onclick = () => {
                showSection('crm-incoming-calls', document.querySelector('.nav-btn[onclick*=\'crm-incoming-calls\']'));
                removeNotificationFromStack(alertDiv);
                alertDiv.remove();
            };
            
            // ✅ Stack'e ekle (alta sırayla dizilir)
            addNotificationToStack(alertDiv);
            
            // 15 saniye sonra otomatik kapat
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => {
                        removeNotificationFromStack(alertDiv);
                        alertDiv.remove();
                    }, 300);
                }
            }, 15000);
            
            console.log('✅ Sayfa içi bildirim gösterildi');
        }
        
        // ✅ Bildirim sesi çal (Web Audio API fonksiyonu satır 3886'da tanımlı)
        
        // ✅ GLOBAL BİLDİRİM STACK - Tüm bildirimler için (üst üste değil, alta sırayla)
        let notificationStack = [];
        
        // ✅ Bildirimi stack'e ekle ve konumunu güncelle
        function addNotificationToStack(alertDiv) {
            // Stack'e ekle
            notificationStack.push(alertDiv);
            
            // DOM'a ekle
            document.body.appendChild(alertDiv);
            
            // Tüm bildirimlerin konumunu güncelle (alta doğru sırala)
            updateNotificationPositions();
            
            return alertDiv;
        }
        
        // ✅ Bildirim stack'ten çıkarıldığında konumları güncelle
        function removeNotificationFromStack(alertDiv) {
            const index = notificationStack.indexOf(alertDiv);
            if (index > -1) {
                notificationStack.splice(index, 1);
                updateNotificationPositions();
            }
        }
        
        // ✅ Tüm bildirimlerin konumunu güncelle (üstten alta doğru)
        function updateNotificationPositions() {
            let topOffset = 20; // İlk bildirim 20px yukarıdan
            
            notificationStack.forEach((notification, index) => {
                if (notification && notification.parentElement) {
                    notification.style.top = topOffset + 'px';
                    notification.style.transition = 'top 0.3s ease-out, opacity 0.3s';
                    
                    // Bir sonraki bildirim için offset hesapla
                    topOffset += notification.offsetHeight + 10; // 10px boşluk
                }
            });
        }
        
        // WhatsApp mesaj bildirimi göster (Modern UI)
        async function showWhatsAppMessageNotification(count, lastSender = '', messageText = '', instanceName = '') {
            console.log(`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`);
            console.log(`🔔 WhatsApp bildirimi ÇAĞRILDI:`);
            console.log(`   count = ${count}`);
            console.log(`   lastSender = ${lastSender}`);
            console.log(`   messageText = ${messageText?.substring(0, 50)}`);
            console.log(`   instanceName = ${instanceName}`);
            console.log(`━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`);
            
            // ✅ Eğer sender veya message boşsa genel bildirim göster
            const hasDetails = lastSender && messageText;
            
            // Görsel bildirim (Browser Notification API)
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    let notificationBody;
                    if (hasDetails && count === 1) {
                        // Kimin kime yazdığını göster
                        const receiverInfo = instanceName ? ` → ${instanceName}` : '';
                        notificationBody = `${lastSender}${receiverInfo}:\n${messageText.substring(0, 100)}`;
                    } else if (!hasDetails && count === 1) {
                        notificationBody = `1 yeni WhatsApp mesajı var!`;
                    } else {
                        notificationBody = `${count} yeni WhatsApp mesajı var!`;
                    }
                    
                    const notification = new Notification('💬 WhatsApp Mesajı!', {
                        body: notificationBody,
                        icon: 'https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg',
                        tag: 'whatsapp-messages-' + Date.now(),
                        requireInteraction: false,
                        silent: false
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        showSection('whatsapp', document.querySelector('.nav-btn[onclick*=\'whatsapp\']'));
                        notification.close();
                    };
                    
                    console.log('✅ WhatsApp browser bildirimi gönderildi');
                } else if (Notification.permission === 'default') {
                    // İlk mesaj geldiğinde izin iste
                    requestNotificationPermission();
                }
            }
            
            // Sesli bildirim - Hemen çal
            await playNotificationSound();
            
            // ✅ MODERN SAYFA İÇİ BİLDİRİM
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                right: 20px;
                background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
                color: white;
                padding: 0;
                border-radius: 16px;
                box-shadow: 0 10px 40px rgba(37, 211, 102, 0.3), 0 0 0 1px rgba(255,255,255,0.1);
                z-index: 100000;
                cursor: pointer;
                animation: slideInBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                max-width: 420px;
                min-width: 320px;
                backdrop-filter: blur(10px);
                overflow: hidden;
            `;
            
            const senderName = lastSender || 'Bilinmeyen';
            const preview = messageText ? messageText.substring(0, 60) : 'Yeni mesaj';
            const dots = messageText && messageText.length > 60 ? '...' : '';
            
            alertDiv.innerHTML = `
                <div style="padding: 18px 20px; display: flex; align-items: center; gap: 15px;">
                    <!-- WhatsApp Icon -->
                    <div style="
                        width: 50px;
                        height: 50px;
                        background: rgba(255,255,255,0.2);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 28px;
                        flex-shrink: 0;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    ">💬</div>
                    
                    <!-- Message Content -->
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 700; font-size: 15px; margin-bottom: 4px;">
                            ${senderName}
                        </div>
                        <div style="font-size: 13px; opacity: 0.95; font-weight: 400; line-height: 1.4; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${preview}${dots}
                        </div>
                    </div>
                    
                    <!-- Close Button -->
                    <button onclick="event.stopPropagation(); removeNotificationFromStack(this.parentElement.parentElement); this.parentElement.parentElement.remove();" style="
                        background: rgba(255,255,255,0.15);
                        border: none;
                        color: white;
                        width: 28px;
                        height: 28px;
                        border-radius: 50%;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 16px;
                        transition: all 0.2s;
                        flex-shrink: 0;
                    " onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">×</button>
                </div>
            `;
            
            alertDiv.onclick = (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    showSection('whatsapp', document.querySelector('.nav-btn[onclick*=\'whatsapp\']'));
                    removeNotificationFromStack(alertDiv);
                    alertDiv.remove();
                }
            };
            
            // ✅ Stack'e ekle (alta sırayla dizilir, cevapsız çağrı varsa onun altına gelir)
            addNotificationToStack(alertDiv);
            
            // 12 saniye sonra otomatik kapat
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.style.animation = 'fadeOutRight 0.4s ease-out';
                    setTimeout(() => {
                        removeNotificationFromStack(alertDiv);
                        alertDiv.remove();
                    }, 400);
                }
            }, 12000);
            
            console.log('✅ Sayfa içi WhatsApp bildirimi gösterildi');
        }
        
        // Browser bildirim izni iste ve Service Worker kaydet
        async function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                try {
                    // Kullanıcı ID'sini kontrol et
                    if (!currentUser || !currentUser.email) {
                        console.warn('⚠️ Kullanıcı bilgisi yok, bildirim izni atlanıyor');
                        return;
                    }
                    
                    // Firebase'den kullanıcının bildirim izni durumunu kontrol et
                    const userId = currentUser.email.replace('@', '_').replace('.', '_');
                    const userDocRef = window.firebase.doc(window.db, 'users', userId);
                    const userDoc = await window.firebase.getDoc(userDocRef);
                    
                    const userData = userDoc.data();
                    const hasAsked = userData?.notificationPermissionAsked || false;
                    
                    if (!hasAsked) {
                        const permission = await Notification.requestPermission();
                        
                        // Firebase'e kaydet
                        await window.firebase.setDoc(
                            userDocRef,
                            {
                                email: currentUser.email,
                                notificationPermissionAsked: true,
                                notificationPermission: permission,
                                notificationPermissionDate: new Date().toISOString()
                            },
                            { merge: true }
                        );
                        
                    if (permission === 'granted') {
                        console.log('✅ Bildirim izni verildi');
                            
                            // Service Worker kaydet (tarayıcı arka plandayken bildirim için)
                            // SADECE http/https protokolünde çalışır (file:// desteklenmiyor)
                            if ('serviceWorker' in navigator && location.protocol !== 'file:') {
                                try {
                                    // Inline Service Worker oluştur
                                    const swCode = `
                                        self.addEventListener('push', function(event) {
                                            const data = event.data ? event.data.json() : {};
                                            const title = data.title || 'Yeni Bildirim';
                                            const options = {
                                                body: data.body || '',
                                                icon: '/favicon.ico',
                                                badge: '/favicon.ico',
                                                vibrate: [200, 100, 200],
                                                data: data
                                            };
                                            event.waitUntil(
                                                self.registration.showNotification(title, options)
                                            );
                                        });
                                        
                                        self.addEventListener('notificationclick', function(event) {
                                            event.notification.close();
                                            event.waitUntil(
                                                clients.openWindow(event.notification.data.url || '/')
                                            );
                                        });
                                    `;
                                    
                                    const blob = new Blob([swCode], { type: 'application/javascript' });
                                    const swUrl = URL.createObjectURL(blob);
                                    
                                    const registration = await navigator.serviceWorker.register(swUrl);
                                    console.log('✅ Service Worker kaydedildi:', registration);
                                } catch (error) {
                                    console.log('⚠️ Service Worker kaydedilemedi:', error);
                                }
                            }
                        } else if (permission === 'denied') {
                            console.log('❌ Bildirim izni reddedildi');
                        }
                    }
                } catch (error) {
                    console.error('Bildirim izni kontrolü hatası:', error);
                }
            }
        }
        
        // CRM'e ekle (cevapsız çağrıdan)
        window.addToCRMFromMissedCall = async function(phoneNumber) {
            // Telefonu formatla (05xxx formatına)
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            // ✅ showSection kaldırıldı - kullanıcı bulunduğu sayfada kalacak
            
            // Modal'ı aç
                openAddLeadModal();
                
            // Telefonu doldur ve görüşme kayıtlarını yükle
                setTimeout(() => {
                    const phoneInput = document.querySelector('#addLeadModal input[name="phone"]');
                    if (phoneInput) {
                        phoneInput.value = formattedPhone;
                        // Telefon kontrolünü tetikle
                        phoneInput.dispatchEvent(new Event('blur'));
                    }
                
                // Görüşme kayıtları sekmesi ekle - daha uzun timeout
                setTimeout(async () => {
                    console.log('📞 Görüşme kayıtları yükleniyor...');
                    await addCallRecordsTabToModal(formattedPhone);
                }, 600);
            }, 300);
        };
        
        // Modal'a görüşme kayıtları sekmesi ekle
        async function addCallRecordsTabToModal(phoneNumber) {
            try {
                const modal = document.getElementById('addLeadModal');
                if (!modal) {
                    console.log('⚠️ Modal bulunamadı');
                    return;
                }
                
                // Modal içeriğine sekme ekle
                const modalBody = modal.querySelector('.modal-body');
                if (!modalBody) {
                    console.log('⚠️ Modal body bulunamadı');
                    return;
                }
                
                // Bulutfon kontrolü
                if (!clubSettings || !clubSettings.bulutfonEnabled || !clubSettings.bulutfonApiKey) {
                    console.log('⚠️ Bulutfon entegrasyonu aktif değil');
                    const form = modalBody.querySelector('#addLeadForm');
                    if (form) {
                        const existingCallRecords = modalBody.querySelector('[data-call-records]');
                        if (existingCallRecords) existingCallRecords.remove();
                        
                        const callRecordsDiv = document.createElement('div');
                        callRecordsDiv.setAttribute('data-call-records', 'true');
                        callRecordsDiv.innerHTML = `
                            <div style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 15px;">
                                <h4 style="color: #ff9800; margin-bottom: 10px;">📞 Görüşme Kayıtları</h4>
                                <div style="padding: 15px; background: #fff3e0; border-radius: 6px; border-left: 4px solid #ff9800;">
                                    <p style="color: #666; margin: 0; font-size: 13px;">Bulutfon entegrasyonu aktif değil. Görüşme kayıtlarını görmek için WhatsApp > Ayarlar > Bulutfon API'yi aktif edin.</p>
                                </div>
                            </div>
                        `;
                        form.parentNode.insertBefore(callRecordsDiv, form.nextSibling);
                    }
                    return;
                }
                
                // Yükleniyor mesajı göster
                const form = modalBody.querySelector('#addLeadForm');
                if (form) {
                    const existingCallRecords = modalBody.querySelector('[data-call-records]');
                    if (existingCallRecords) existingCallRecords.remove();
                    
                    const loadingDiv = document.createElement('div');
                    loadingDiv.setAttribute('data-call-records', 'true');
                    loadingDiv.innerHTML = `
                        <div style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 15px;">
                            <h4 style="color: #1976d2; margin-bottom: 10px;">📞 Görüşme Kayıtları</h4>
                            <div class="loading"><div class="spinner"></div><span>Görüşme kayıtları yükleniyor...</span></div>
                        </div>
                    `;
                    form.parentNode.insertBefore(loadingDiv, form.nextSibling);
                }
                
                // Bulutfon'dan bu numaraya ait çağrıları çek
                console.log(`📞 ${phoneNumber} için görüşme kayıtları çekiliyor...`);
                const response = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${clubSettings.bulutfonApiKey}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`Bulutfon API hatası: HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const allRecords = Array.isArray(data) ? data : (data.cdrs || data.data || []);
                
                console.log(`📊 Toplam ${allRecords.length} arama kaydı alındı`);
                
                // Bu telefon numarasına ait kayıtları filtrele - phonesMatch kullan
                const phoneRecords = allRecords.filter(record => {
                    return phonesMatch(record.caller, phoneNumber) || phonesMatch(record.callee, phoneNumber);
                });
                
                console.log(`📞 ${phoneNumber} için ${phoneRecords.length} görüşme kaydı bulundu`);
                
                // Sekme oluştur - kayıt yoksa da bilgi göster
                let callRecordsHtml = `
                    <div style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 15px;">
                        <h4 style="color: #1976d2; margin-bottom: 15px;">📞 Görüşme Kayıtları (${phoneRecords.length})</h4>
                `;
                
                if (phoneRecords.length === 0) {
                    callRecordsHtml += `
                        <div style="padding: 15px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                            <p style="color: #666; margin: 0; font-size: 13px;">Bu numara (${phoneNumber}) için Bulutfon sisteminde görüşme kaydı bulunamadı.</p>
                            <p style="color: #888; margin: 5px 0 0 0; font-size: 12px;">💡 Kayıtlar silinmiş veya henüz bu numarayla görüşme yapılmamış olabilir.</p>
                        </div>
                    `;
                } else {
                    callRecordsHtml += `<div style="max-height: 300px; overflow-y: auto;">`;
                
                phoneRecords.slice(0, 10).forEach(record => {
                    const callTime = new Date(record.call_time);
                    const timeStr = callTime.toLocaleString('tr-TR');
                    const direction = record.direction === 'IN' ? '📥 Gelen' : '📤 Giden';
                    const duration = record.talking_seconds ? `${record.talking_seconds}s` : 'Cevapsız';
                    const wasAnswered = record.talking_seconds && parseInt(record.talking_seconds) > 0;
                    const statusColor = wasAnswered ? '#4caf50' : '#f44336';
                    
                const recordingBtn = (record.uuid && clubSettings && clubSettings.bulutfonApiKey) ?
                        `<button class="btn btn-sm btn-info" onclick="window.open('https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonRecordingProxy?apikey=${clubSettings.bulutfonApiKey}&uuid=${record.uuid}', '_blank')" title="Ses kaydını dinle">🎧 Dinle</button>` :
                        '';
                    
                    callRecordsHtml += `
                        <div style="padding: 12px; background: #f5f5f5; border-left: 4px solid ${statusColor}; border-radius: 6px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${direction}</div>
                                    <div style="font-size: 13px; color: #666;">🕐 ${timeStr}</div>
                                    <div style="font-size: 13px; color: ${statusColor}; font-weight: 600; margin-top: 4px;">${duration}</div>
                                </div>
                                <div>
                                    ${recordingBtn}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                if (phoneRecords.length > 10) {
                    callRecordsHtml += `<div style="text-align: center; color: #666; font-size: 13px; margin-top: 10px;">... ve ${phoneRecords.length - 10} kayıt daha</div>`;
                }
                
                    callRecordsHtml += `</div>`;
                }
                
                callRecordsHtml += `</div>`;
                
                // Form'dan sonra ekle
                if (form) {
                    const existingCallRecords = modalBody.querySelector('[data-call-records]');
                    if (existingCallRecords) {
                        existingCallRecords.remove();
                    }
                    
                    const callRecordsDiv = document.createElement('div');
                    callRecordsDiv.setAttribute('data-call-records', 'true');
                    callRecordsDiv.innerHTML = callRecordsHtml;
                    form.parentNode.insertBefore(callRecordsDiv, form.nextSibling);
                }
                
            } catch (error) {
                console.error('❌ Görüşme kayıtları yüklenirken hata:', error);
                
                // Hata mesajını modal'da göster
                const modal = document.getElementById('addLeadModal');
                if (modal) {
                    const modalBody = modal.querySelector('.modal-body');
                    const form = modalBody?.querySelector('#addLeadForm');
                    if (form) {
                        const existingCallRecords = modalBody.querySelector('[data-call-records]');
                        if (existingCallRecords) existingCallRecords.remove();
                        
                        const errorDiv = document.createElement('div');
                        errorDiv.setAttribute('data-call-records', 'true');
                        errorDiv.innerHTML = `
                            <div style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 15px;">
                                <h4 style="color: #f44336; margin-bottom: 10px;">📞 Görüşme Kayıtları</h4>
                                <div style="padding: 15px; background: #ffebee; border-radius: 6px; border-left: 4px solid #f44336;">
                                    <p style="color: #c62828; margin: 0 0 5px 0; font-weight: 600;">❌ Görüşme kayıtları yüklenemedi</p>
                                    <p style="color: #666; margin: 0; font-size: 13px;">${error.message}</p>
                                    <p style="color: #888; margin: 5px 0 0 0; font-size: 12px;">💡 Bulutfon API bağlantınızı ve API key'inizi kontrol edin.</p>
                                </div>
                            </div>
                        `;
                        form.parentNode.insertBefore(errorDiv, form.nextSibling);
                    }
                }
            }
        }
        
        // CRM bilgilerini güncelle (cevapsız çağrıdan)
        window.updateCRMFromMissedCall = function(leadId) {
            // CRM sayfasına geç
            showSection('crm', document.querySelector('.nav-btn[onclick*=\'crm\']'));
            
            // Kısa bir gecikme sonra customer detail'ı aç
            setTimeout(() => {
                openCustomerDetail(leadId);
            }, 300);
        };
        
        // Telefon numarasını temizle ve formatla
        function cleanPhoneNumber(phone) {
            if (!phone) return '';
            // Tüm boşluklar, tire, parantez vb temizle - sadece rakamlar kalsın
            let cleaned = phone.replace(/\D/g, '');
            
            // ✅ BOZUK NUMARA DÜZELTMELERİ - GELİŞMİŞ
            
            // 1. Çok uzun numaralar (14+ hane) - country code'dan sonrasını al
            if (cleaned.length >= 14) {
                // 90 country code'unu bul
                const index90 = cleaned.indexOf('90');
                if (index90 !== -1 && cleaned.length - index90 >= 12) {
                    cleaned = cleaned.substring(index90);
                    console.log('🔧 Bozuk numara düzeltildi (90 bulundu):', cleaned);
                }
            }
            
            // 2. 65 prefix (Singapur kod) - kaldır
            if (cleaned.startsWith('65') && cleaned.length === 14) {
                if (cleaned.substring(2, 4) === '90') {
                    cleaned = cleaned.substring(2);
                    console.log('🔧 Bozuk numara düzeltildi (65 prefix):', cleaned);
                }
            }
            
            // 3. 6590 pattern
            if (cleaned.startsWith('6590') && cleaned.length > 12) {
                cleaned = cleaned.substring(2);
                console.log('🔧 Bozuk numara düzeltildi (6590):', cleaned);
            }
            
            // 4. Geçersiz country code patterns - skip et
            const invalidPrefixes = ['17', '127', '211', '79', '5511', '1'];
            for (const prefix of invalidPrefixes) {
                if (cleaned.startsWith(prefix) && cleaned.length > 12) {
                    // Bu numarayı kullanma
                    console.log('⚠️ Geçersiz numara atlanıyor:', cleaned);
                    return ''; // Boş döndür
                }
            }
            
            // Baştaki gereksiz sıfırları temizle (ama 90 korunsun)
            if (cleaned.startsWith('00')) {
                cleaned = cleaned.substring(2);
            }
            
            return cleaned;
        }
        
        // Telefon numaralarını karşılaştır - GÜÇLENDİRİLMİŞ VERSİYON
        function phonesMatch(phone1, phone2) {
            if (!phone1 || !phone2) return false;
            
            const clean1 = cleanPhoneNumber(phone1);
            const clean2 = cleanPhoneNumber(phone2);
            
            if (clean1.length < 10 || clean2.length < 10) return false;
            
            // Son 10 haneyi al (Türkiye telefon numarası standardı)
            const last10_1 = clean1.slice(-10);
            const last10_2 = clean2.slice(-10);
            
            return last10_1 === last10_2;
        }
        
        // Mevcut telefonu kontrol et ve önerileri göster - MÜŞTERİ FİLTRESİ GİBİ GÜÇLÜ
        window.checkExistingPhone = function(inputValue) {
            const messageDiv = document.getElementById('phone-check-message');
            if (!messageDiv) return;
            
            if (!inputValue || inputValue.trim().length < 3) {
                messageDiv.innerHTML = '';
                return;
            }
            
            // Benzer telefon numaralarını bul (phonesMatch kullanarak)
            const cleanInput = cleanPhoneNumber(inputValue);
            const matchingLeads = [];
            
            // Tam eşleşme kontrolü (son 10 hane)
            const exactMatch = crmLeads.find(lead => phonesMatch(lead.phone, inputValue));
            
            if (exactMatch) {
                messageDiv.innerHTML = `
                    <div style="color: #f44336; background: #ffebee; padding: 8px; border-radius: 4px; border-left: 3px solid #f44336;">
                        <strong>⚠️ Uyarı:</strong> Bu telefon numarası zaten kayıtlı!<br>
                        <strong>Müşteri:</strong> ${exactMatch.fullName} | Tel: ${exactMatch.phone}<br>
                        <button class="btn btn-sm btn-primary" onclick="openCustomerDetail('${exactMatch.id}')" style="margin-top: 5px;">
                            📋 Müşteriyi Görüntüle
                        </button>
                    </div>
                `;
                return;
            }
            
            // Kısmi eşleşmeleri bul (en az 5 rakam eşleşmeli) - Müşteri filtresi gibi
            if (cleanInput.length >= 5) {
                crmLeads.forEach(lead => {
                    const cleanLeadPhone = cleanPhoneNumber(lead.phone);
                    
                    // Her türlü eşleşme: 
                    // 1. Girilen rakamlar lead telefonda geçiyor mu?
                    // 2. Lead telefon girilen rakamları içeriyor mu?
                    if (cleanLeadPhone.includes(cleanInput) || cleanInput.includes(cleanLeadPhone)) {
                        if (!matchingLeads.find(l => l.id === lead.id)) {
                            matchingLeads.push(lead);
                        }
                    }
                });
            }
            
            if (matchingLeads.length > 0) {
                const suggestions = matchingLeads.slice(0, 5).map(lead => `
                    <div style="padding: 6px; margin: 4px 0; background: white; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e0e0e0;">
                        <div style="flex: 1;">
                            <strong>${lead.fullName}</strong><br>
                            <small style="color: #666;">${lead.phone}</small>
                        </div>
                        <button onclick="openCustomerDetail('${lead.id}'); event.stopPropagation();" style="padding: 4px 8px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                            Aç
                        </button>
                    </div>
                `).join('');
                
                messageDiv.innerHTML = `
                    <div style="color: #ff9800; background: #fff3e0; padding: 8px; border-radius: 4px; border-left: 3px solid #ff9800;">
                        <strong>💡 ${matchingLeads.length} benzer numara bulundu:</strong>
                        ${suggestions}
                        ${matchingLeads.length > 5 ? `<div style="font-size: 11px; color: #666; margin-top: 5px;">ve ${matchingLeads.length - 5} tane daha...</div>` : ''}
                    </div>
                `;
            } else {
                messageDiv.innerHTML = '<div style="color: #4caf50; padding: 4px 0;">✅ Bu telefon numarası kullanılabilir</div>';
            }
        };
        
        // Ulaşılamadı olarak işaretle VE mesaj gönder
        window.markAsUnreachableWithMessage = async function(phoneNumber, timeStr) {
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            try {
                // WhatsApp cihazını kontrol et
                if (!defaultWhatsAppDevice) {
                    showAlert('⚠️ WhatsApp cihazı yapılandırılmamış.', 'warning');
                    return;
                }
                
                // Mesaj şablonu
                const clubName = clubSettings.clubName || 'Sporcum';
                const messageTemplate = `Merhaba,\n\nSporcum olarak size ulaşmaya çalıştık ancak ulaşamadık.\n\nBize ${timeStr} tarihinde bir cevapsız çağrınız düşmüştür.\n\nSizinle görüşmek ve sorularınızı yanıtlamak isteriz. Lütfen uygun olduğunuzda bizi arayınız.\n\nTeşekkürler,`;
                
                // Mesajı kuyruğa ekle - CRM'e EKLEMİYORUZ, sadece mesaj gönderiyoruz
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'messageQueue'),
                    {
                        clubId: currentClubId,
                        phone: formattedPhone,
                        message: messageTemplate,
                        deviceId: defaultWhatsAppDevice,
                        scheduledFor: new Date().toISOString(),
                        status: 'pending',
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser?.fullName || 'Admin',
                        type: 'unreachable_notification'
                    }
                );
                
                // ✅ Ulaşılamadı olarak işaretle (localStorage'a kaydet)
                const unreachableKey = `unreachable_${cleanPhone}_${timeStr}`;
                const unreachableCalls = JSON.parse(localStorage.getItem('unreachableCalls') || '{}');
                unreachableCalls[unreachableKey] = {
                    phone: cleanPhone,
                    timestamp: new Date().toISOString(),
                    timeStr: timeStr
                };
                localStorage.setItem('unreachableCalls', JSON.stringify(unreachableCalls));
                
                showAlert('✅ "Ulaşılamadı" mesajı kuyruğa eklendi. Müşteri cevapsız çağrılarda kalacak.', 'success');
                
                // Cevapsız çağrıları yenile
                await renderMissedCalls();
                // Gelen aramalar sayfasını da yenile (eğer o sayfadaysak)
                if (document.getElementById('incoming-calls-list')) {
                    await renderIncomingCallsPage();
                }
            } catch (error) {
                console.error('Ulaşılamadı mesajı gönderme hatası:', error);
                showAlert('❌ İşlem başarısız: ' + error.message, 'danger');
            }
        };
        
        // Ulaşılamadı olarak işaretle (mesaj olmadan)
        window.markAsUnreachable = async function(phoneNumber, timeStr) {
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            const notes = `Ulaşılamadı - ${timeStr} tarihinde cevapsız çağrı`;
            
            try {
                // CRM'e ekle - branş bilinmediği için ulaşılamadı statüsünde kalsın
                const newLead = {
                    fullName: 'Ulaşılamadı - ' + formattedPhone,
                    phone: formattedPhone,
                    email: '',
                    branch: 'Belirsiz',
                    status: 'lost', // Kayıp olarak işaretle
                    source: 'Cevapsız Çağrı',
                    notes: notes,
                    clubId: currentClubId,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    tags: ['Ulaşılamadı'],
                    history: [{
                        date: new Date().toISOString(),
                        action: 'Ulaşılamadı olarak işaretlendi',
                        notes: notes,
                        user: currentUser?.fullName || 'Admin'
                    }]
                };
                
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'crmLeads'),
                    newLead
                );
                
                showAlert('✅ "Ulaşılamadı" olarak işaretlendi ve CRM\'e eklendi', 'success');
                
                // Cevapsız çağrıları yenile
                await renderMissedCalls();
                
                // CRM'i güncelle
                await loadData();
            } catch (error) {
                console.error('Ulaşılamadı işaretleme hatası:', error);
                showAlert('❌ İşlem başarısız: ' + error.message, 'danger');
            }
        };
        
        // Manuel olarak cevaplandı işaretle
        window.markMissedCallAsAnswered = async function(phoneNumber, leadId = null, memberId = null) {
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            const responseMethod = prompt('Nasıl iletişime geçildi?\n\n1: WhatsApp\'tan Mesaj Gönderildi\n2: Yüz Yüze Görüşüldü\n3: Diğer\n\n(Not: Telefonla aramalar ve müşteri geri aramaları sistem tarafından otomatik takip edilir)', '1');
            
            if (!responseMethod) return;
            
            // Sadece 1, 2, 3 kabul et
            if (!['1', '2', '3'].includes(responseMethod)) {
                alert('⚠️ Lütfen 1, 2 veya 3 seçeneklerinden birini girin.');
                return;
            }
            
            const methodTexts = {
                '1': 'WhatsApp\'tan mesaj gönderildi',
                '2': 'Yüz yüze görüşüldü',
                '3': 'Diğer yöntemle iletişime geçildi'
            };
            
            const methodText = methodTexts[responseMethod] || 'İletişime geçildi';
            const now = new Date().toISOString();
            const notes = `Cevaplandı - ${methodText}`;
            
            try {
                if (leadId) {
                    // CRM'de zaten var - sadece not ekle (Etiketi DEĞŞTME!)
                    const leadRef = window.firebase.doc(window.db, 'crmLeads', leadId);
                    const leadDoc = await window.firebase.getDoc(leadRef);
                    
                    if (leadDoc.exists()) {
                        const lead = leadDoc.data();
                        const updatedHistory = lead.history || [];
                        updatedHistory.push({
                            date: now,
                            action: 'Cevapsız çağrı cevaplandı (Diğer yolla)',
                            notes: methodText,
                            user: currentUser?.fullName || 'Admin'
                        });
                        
                        // ✅ Etiket değiştirme - mevcut etiketleri koru
                        await window.firebase.updateDoc(leadRef, {
                            updatedAt: now,
                            history: updatedHistory,
                            notes: (lead.notes ? lead.notes + '\n' : '') + notes
                        });
                    }
                    
                    showAlert(`✅ "${methodText}" olarak kaydedildi ve "Diğer" sekmesine taşındı`, 'success');
                } else if (memberId) {
                    // Üye - sadece bilgi mesajı
                    showAlert(`✅ Üye "${methodText}" olarak not edildi`, 'success');
                } else {
                    // CRM'de yok - yeni kayıt oluştur (Varsayılan etiketle)
                const newLead = {
                    fullName: formattedPhone,
                    phone: formattedPhone,
                    email: '',
                    branches: [{
                        branchId: 'general',
                        branchName: 'Genel',
                        selectedTag: '', // ✅ Boş etiket - kullanıcı seçsin
                        notes: methodText
                    }],
                    source: 'Cevapsız Çağrı - Manuel',
                    notes: notes,
                    clubId: currentClubId,
                    createdAt: now,
                    updatedAt: now,
                    history: [{
                        date: now,
                        action: 'Manuel olarak cevaplandı işaretlendi',
                        notes: methodText,
                        user: currentUser?.fullName || 'Admin'
                    }]
                };
                
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'crmLeads'),
                    newLead
                );
                
                showAlert(`✅ "${methodText}" olarak işaretlendi ve CRM'e eklendi`, 'success');
                }
                
                // ✅ localStorage'a cevaplandı durumunu TARİH ile kaydet
                const answeredCalls = JSON.parse(localStorage.getItem('answeredMissedCalls') || '[]');
                // Eski format (string array) kontrolü - temizle ve yeni formata geç
                if (answeredCalls.length > 0 && typeof answeredCalls[0] === 'string') {
                    localStorage.setItem('answeredMissedCalls', '[]');
                }
                
                const answeredCallsNew = JSON.parse(localStorage.getItem('answeredMissedCalls') || '[]');
                const existingIndex = answeredCallsNew.findIndex(item => item.phone === formattedPhone);
                
                if (existingIndex >= 0) {
                    // Zaten var - tarihi ve metodu güncelle
                    answeredCallsNew[existingIndex].markedDate = now;
                    answeredCallsNew[existingIndex].method = methodText;
                } else {
                    // Yeni ekle
                    answeredCallsNew.push({
                        phone: formattedPhone,
                        markedDate: now,
                        method: methodText // ✅ Hangi yöntemle cevaplandığını kaydet
                    });
                }
                
                localStorage.setItem('answeredMissedCalls', JSON.stringify(answeredCallsNew));
                
                // ✅ CRM verilerini yeniden yükle (etiket değişikliği için)
                await loadData();
                
                // Cevapsız çağrıları yenile
                await renderMissedCalls();
                
                // Gelen aramalar sayfasını da yenile (eğer o sayfadaysak)
                if (document.getElementById('incoming-calls-list')) {
                    await renderIncomingCallsPage();
                    // ✅ Sekme değişimini kaldırdık - kullanıcı hangi sekmede ise orada kalsın
                }
                
                // CRM sayfasını yenile (eğer o sayfadaysak)
                const currentSection = document.querySelector('.nav-btn.active')?.getAttribute('onclick')?.match(/showSection\('([^']+)'/)?.[1];
                if (currentSection === 'crm') {
                    console.log('🔄 CRM sayfası yenileniyor (etiket değişikliği için)...');
                    renderCRMDashboard();
                }
            } catch (error) {
                console.error('Cevaplandı işaretleme hatası:', error);
                showAlert('❌ İşlem başarısız: ' + error.message, 'danger');
            }
        };
        
        // ✅ Çağrıyı "Diğer" sekmesine taşı
        // Bulutfon çağrıları için localStorage (API'den geliyorlar, database'de yok)
        // WhatsApp çağrıları için Supabase UPDATE
        window.moveCallToOther = async function(phoneNumber) {
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            
            try {
                console.log('📍 Çağrı "Diğer" sekmesine taşınıyor:', cleanPhone);
                
                // localStorage'a kaydet (Bulutfon çağrıları için)
                const storageKey = `otherCalls_${currentClubId}`;
                const otherCalls = JSON.parse(localStorage.getItem(storageKey) || '{}');
                
                // Telefon numarasını ve tarihini kaydet
                otherCalls[cleanPhone] = {
                    phone: cleanPhone,
                    movedDate: new Date().toISOString(),
                    movedBy: currentUser?.email || 'unknown'
                };
                
                localStorage.setItem(storageKey, JSON.stringify(otherCalls));
                
                console.log('✅ Çağrı "Diğer" sekmesine taşındı (localStorage)');
                showAlert('✅ Çağrı "Diğer" sekmesine taşındı', 'success');
                
                // Gelen aramalar sayfasını yenile
                await renderIncomingCallsPage();
                
            } catch (error) {
                console.error('Çağrı taşıma hatası:', error);
                showAlert('❌ İşlem başarısız: ' + error.message, 'danger');
            }
        };
        
        // ✅ WhatsApp konuşmasını aç
        window.openWhatsAppConversation = function(phoneNumber) {
            // Telefon numarasını temizle ve formatla
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            // WhatsApp sayfasına git
            showSection('whatsapp', document.querySelector('.nav-btn[onclick*="whatsapp"]'));
            
            // Mesajlaşma sekmesine geç ve konuşmayı aç
            setTimeout(() => {
                if (window.switchWhatsAppTab) {
                    switchWhatsAppTab('messages');
                }
                
                // Konuşmayı aç (eğer fonksiyon varsa)
                setTimeout(() => {
                    if (window.openConversation) {
                        openConversation(formattedPhone);
                    } else if (window.loadConversation) {
                        loadConversation(formattedPhone);
                    }
                }, 500);
            }, 300);
            
            console.log(`💬 WhatsApp konuşması açılıyor: ${formattedPhone}`);
        };
        
        // Çağrıyı sil (localStorage'da saklanıyor - kalıcı)
        // Dropdown toggle fonksiyonu
        window.toggleCallDropdown = function(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;
            
            // Diğer açık dropdown'ları kapat ve z-index'lerini resetle
            document.querySelectorAll('[id^="dropdown-"]').forEach(d => {
                if (d.id !== dropdownId && d.style.display === 'block') {
                    d.style.display = 'none';
                    // Parent kartın z-index'ini resetle
                    let parentCard = d.closest('div[style*="position: relative"]');
                    if (!parentCard) parentCard = d.closest('div[style*="padding: 15px"]');
                    if (!parentCard) parentCard = d.closest('div[style*="padding: 12px"]');
                    if (parentCard) {
                        parentCard.style.cssText = parentCard.style.cssText.replace(/z-index:\s*\d+\s*!important;?/g, '');
                        parentCard.style.zIndex = '1';
                    }
                }
            });
            
            // Bu dropdown'ı aç/kapat
            const isOpening = dropdown.style.display === 'none';
            dropdown.style.display = isOpening ? 'block' : 'none';
            
            // Parent kartın z-index'ini ayarla - !important ile zorla
            let parentCard = dropdown.closest('div[style*="position: relative"]');
            if (!parentCard) parentCard = dropdown.closest('div[style*="padding: 15px"]');
            if (!parentCard) parentCard = dropdown.closest('div[style*="padding: 12px"]');
            if (parentCard) {
                if (isOpening) {
                    parentCard.style.setProperty('z-index', '1000', 'important');
                } else {
                    parentCard.style.cssText = parentCard.style.cssText.replace(/z-index:\s*\d+\s*!important;?/g, '');
                    parentCard.style.zIndex = '1';
                }
            }
        };
        
        // Sayfa tıklamasında dropdown'ları kapat
        document.addEventListener('click', function(e) {
            if (!e.target.closest('[onclick*="toggleCallDropdown"]') && !e.target.closest('[id^="dropdown-"]')) {
                document.querySelectorAll('[id^="dropdown-"]').forEach(d => {
                    if (d.style.display === 'block') {
                        d.style.display = 'none';
                        // Parent kartın z-index'ini resetle
                        const parentCard = d.closest('[style*="position: relative"]');
                        if (parentCard) parentCard.style.zIndex = '1';
                    }
                });
            }
        });
        
        // Görüşme kayıtları modalını göster (CRM'e kaydetmeden)
        window.showCallRecordsModal = async function(phoneNumber) {
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            const modalId = 'callRecordsViewModal';
            
            // Modal var mı kontrol et, yoksa oluştur
            let modal = document.getElementById(modalId);
            if (!modal) {
                const modalHtml = `
                    <div id="${modalId}" class="modal">
                        <div class="modal-content" style="max-width: 800px;">
                            <h3 style="margin-bottom: 20px;">📞 Görüşme Kayıtları</h3>
                            <div style="background: #f5f5f5; padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                                <div style="font-size: 14px; color: #666;">Telefon Numarası:</div>
                                <div style="font-size: 18px; font-weight: 600; color: #1976d2;" id="callRecordsPhoneDisplay">${formattedPhone}</div>
                            </div>
                            <div id="callRecordsModalContent" style="max-height: 500px; overflow-y: auto;">
                                <div class="loading"><div class="spinner"></div><span>Görüşme kayıtları yükleniyor...</span></div>
                            </div>
                            <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                                <button class="btn btn-primary" onclick="addToCRMFromMissedCall('${formattedPhone}'); closeModal('${modalId}')">
                                    ➕ CRM'e Ekle
                                </button>
                                <button class="btn btn-secondary" onclick="closeModal('${modalId}')">Kapat</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                modal = document.getElementById(modalId);
            }
            
            // Telefon numarasını güncelle
            const phoneDisplay = document.getElementById('callRecordsPhoneDisplay');
            if (phoneDisplay) phoneDisplay.textContent = formattedPhone;
            
            // Modal'ı aç
            openModal(modalId);
            
            // Görüşme kayıtlarını yükle
            await renderCallRecords(formattedPhone, 'callRecordsModalContent');
        };
        
        window.deleteCall = function(phoneNumber, callType, callTime) {
            try {
                const deletedCall = {
                    phoneNumber: phoneNumber,
                    callType: callType, // 'incoming', 'outgoing'
                    callTime: callTime,
                    deletedAt: new Date().toISOString()
                };
                
                deletedCalls.push(deletedCall);
                saveDeletedCalls();
                
                showAlert('✅ Çağrı silindi', 'success');
                
                // İlgili sayfayı yenile
                if (callType === 'incoming') renderIncomingCallsPage();
                if (callType === 'outgoing') renderOutgoingCallsPage();
            } catch (error) {
                console.error('Çağrı silme hatası:', error);
                showAlert('❌ Çağrı silinemedi: ' + error.message, 'danger');
            }
        };
        
        // Çağrıyı geri getir
        window.undeleteCall = function(phoneNumber, callType, callTime) {
            try {
                deletedCalls = deletedCalls.filter(dc => 
                    !(dc.phoneNumber === phoneNumber && dc.callType === callType && dc.callTime === callTime)
                );
                saveDeletedCalls();
                
                showAlert('✅ Çağrı geri getirildi', 'success');
                
                // Sayfayı yenile
                renderCurrentSection();
            } catch (error) {
                console.error('Çağrı geri getirme hatası:', error);
                showAlert('❌ İşlem başarısız: ' + error.message, 'danger');
            }
        };
        
        // Çağrının silinmiş olup olmadığını kontrol et
        function isCallDeleted(phoneNumber, callType, callTime) {
            return deletedCalls.some(dc => 
                dc.phoneNumber === phoneNumber && 
                dc.callType === callType &&
                dc.callTime === callTime
            );
        }
        
        // Silinenleri göster/gizle toggle
        window.toggleShowDeletedCalls = function() {
            showDeletedCalls = !showDeletedCalls;
            
            // Tüm toggle butonlarını güncelle
            const buttons = [
                document.getElementById('toggleDeletedCallsIncomingBtn'),
                document.getElementById('toggleDeletedCallsOutgoingBtn')
            ];
            
            buttons.forEach(btn => {
                if (btn) {
                    btn.textContent = showDeletedCalls ? '👁️ Silinenleri Sakla' : '🗑️ Silinenleri Göster';
                    btn.className = showDeletedCalls ? 'btn btn-sm btn-warning' : 'btn btn-sm btn-secondary';
                }
            });
            
            renderCurrentSection();
        };
        
        // Checkbox seçim fonksiyonları
        window.toggleSelectAllIncoming = function(checkbox) {
            const checkboxes = document.querySelectorAll('.incoming-call-checkbox');
            selectedIncomingCalls.clear();
            
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                if (checkbox.checked) {
                    selectedIncomingCalls.add(cb.value);
                }
            });
            
            updateBulkDeleteButton('incoming');
        };
        
        window.toggleSelectAllOutgoing = function(checkbox) {
            const checkboxes = document.querySelectorAll('.outgoing-call-checkbox');
            selectedOutgoingCalls.clear();
            
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                if (checkbox.checked) {
                    selectedOutgoingCalls.add(cb.value);
                }
            });
            
            updateBulkDeleteButton('outgoing');
        };
        
        window.toggleIncomingCall = function(checkbox, callKey) {
            if (checkbox.checked) {
                selectedIncomingCalls.add(callKey);
            } else {
                selectedIncomingCalls.delete(callKey);
                document.getElementById('selectAllIncoming').checked = false;
            }
            updateBulkDeleteButton('incoming');
        };
        
        window.toggleOutgoingCall = function(checkbox, callKey) {
            if (checkbox.checked) {
                selectedOutgoingCalls.add(callKey);
            } else {
                selectedOutgoingCalls.delete(callKey);
                document.getElementById('selectAllOutgoing').checked = false;
            }
            updateBulkDeleteButton('outgoing');
        };
        
        function updateBulkDeleteButton(callType) {
            const selectedCount = callType === 'incoming' ? selectedIncomingCalls.size : selectedOutgoingCalls.size;
            const btnId = callType === 'incoming' ? 'bulkDeleteIncomingBtn' : 'bulkDeleteOutgoingBtn';
            const btn = document.getElementById(btnId);
            
            if (btn) {
                if (selectedCount > 0) {
                    btn.textContent = `🗑️ Seçilenleri Sil (${selectedCount})`;
                    btn.disabled = false;
                    btn.className = 'btn btn-sm btn-danger';
                } else {
                    btn.textContent = '🗑️ Seçilenleri Sil';
                    btn.disabled = true;
                    btn.className = 'btn btn-sm btn-secondary';
                }
            }
        }
        
        // Toplu silme fonksiyonları - Seçilenleri sil
        // Gelen aramalar için silme modunu aç
        window.showIncomingDeleteMode = function() {
            // Checkbox'ları göster
            document.querySelectorAll('.incoming-call-checkbox').forEach(cb => {
                cb.style.display = 'block';
                cb.parentElement.style.display = 'block';
            });
            document.getElementById('selectAllIncomingLabel').style.display = 'flex';
            
            // Butonları değiştir
            document.getElementById('showDeleteModeIncomingBtn').style.display = 'none';
            document.getElementById('confirmDeleteIncomingBtn').style.display = 'inline-block';
            document.getElementById('cancelDeleteIncomingBtn').style.display = 'inline-block';
        };
        
        // Gelen aramalar silmeyi iptal et
        window.cancelIncomingDeleteMode = function() {
            // Checkbox'ları gizle
            document.querySelectorAll('.incoming-call-checkbox').forEach(cb => {
                cb.style.display = 'none';
                cb.parentElement.style.display = 'none';
                cb.checked = false;
            });
            document.getElementById('selectAllIncomingLabel').style.display = 'none';
            document.getElementById('selectAllIncoming').checked = false;
            
            // Seçimleri temizle
            selectedIncomingCalls.clear();
            
            // Butonları değiştir
            document.getElementById('showDeleteModeIncomingBtn').style.display = 'inline-block';
            document.getElementById('confirmDeleteIncomingBtn').style.display = 'none';
            document.getElementById('cancelDeleteIncomingBtn').style.display = 'none';
        };
        
        // Gelen aramaları onayla ve sil
        window.confirmDeleteIncomingCalls = async function() {
            if (selectedIncomingCalls.size === 0) {
                showAlert('⚠️ Lütfen silmek istediğiniz aramaları seçin', 'warning');
                return;
            }
            
            if (!confirm(`Seçili ${selectedIncomingCalls.size} aramayı kalıcı olarak silmek istediğinize emin misiniz?`)) {
                return;
            }
            
            await bulkDeleteIncomingCalls();
            cancelIncomingDeleteMode();
        };
        
        window.bulkDeleteIncomingCalls = async function() {
            if (selectedIncomingCalls.size === 0) {
                return;
            }
            
            try {
                // Seçili aramaları sil
                selectedIncomingCalls.forEach(callKey => {
                    const [phoneNumber, callTime] = callKey.split('|');
                    const deletedCall = {
                        phoneNumber: phoneNumber,
                        callType: 'incoming',
                        callTime: callTime,
                        deletedAt: new Date().toISOString()
                    };
                    deletedCalls.push(deletedCall);
                });
                
                saveDeletedCalls();
                const deletedCount = selectedIncomingCalls.size;
                selectedIncomingCalls.clear();
                
                showAlert(`✅ ${deletedCount} gelen arama silindi`, 'success');
                renderIncomingCallsPage();
            } catch (error) {
                console.error('Toplu silme hatası:', error);
                showAlert('❌ Toplu silme başarısız: ' + error.message, 'danger');
            }
        };
        
        // Giden aramalar için silme modunu aç
        window.showOutgoingDeleteMode = function() {
            // Checkbox'ları göster
            document.querySelectorAll('.outgoing-call-checkbox').forEach(cb => {
                cb.style.display = 'block';
                cb.parentElement.style.display = 'block';
            });
            document.getElementById('selectAllOutgoingLabel').style.display = 'flex';
            
            // Butonları değiştir
            document.getElementById('showDeleteModeOutgoingBtn').style.display = 'none';
            document.getElementById('confirmDeleteOutgoingBtn').style.display = 'inline-block';
            document.getElementById('cancelDeleteOutgoingBtn').style.display = 'inline-block';
        };
        
        // Giden aramalar silmeyi iptal et
        window.cancelOutgoingDeleteMode = function() {
            // Checkbox'ları gizle
            document.querySelectorAll('.outgoing-call-checkbox').forEach(cb => {
                cb.style.display = 'none';
                cb.parentElement.style.display = 'none';
                cb.checked = false;
            });
            document.getElementById('selectAllOutgoingLabel').style.display = 'none';
            document.getElementById('selectAllOutgoing').checked = false;
            
            // Seçimleri temizle
            selectedOutgoingCalls.clear();
            
            // Butonları değiştir
            document.getElementById('showDeleteModeOutgoingBtn').style.display = 'inline-block';
            document.getElementById('confirmDeleteOutgoingBtn').style.display = 'none';
            document.getElementById('cancelDeleteOutgoingBtn').style.display = 'none';
        };
        
        // Giden aramaları onayla ve sil
        window.confirmDeleteOutgoingCalls = async function() {
            if (selectedOutgoingCalls.size === 0) {
                showAlert('⚠️ Lütfen silmek istediğiniz aramaları seçin', 'warning');
                return;
            }
            
            if (!confirm(`Seçili ${selectedOutgoingCalls.size} aramayı kalıcı olarak silmek istediğinize emin misiniz?`)) {
                return;
            }
            
            await bulkDeleteOutgoingCalls();
            cancelOutgoingDeleteMode();
        };
        
        window.bulkDeleteOutgoingCalls = async function() {
            if (selectedOutgoingCalls.size === 0) {
                return;
            }
            
            try {
                // Seçili aramaları sil
                selectedOutgoingCalls.forEach(callKey => {
                    const [phoneNumber, callTime] = callKey.split('|');
                    const deletedCall = {
                        phoneNumber: phoneNumber,
                        callType: 'outgoing',
                        callTime: callTime,
                        deletedAt: new Date().toISOString()
                    };
                    deletedCalls.push(deletedCall);
                });
                
                saveDeletedCalls();
                const deletedCount = selectedOutgoingCalls.size;
                selectedOutgoingCalls.clear();
                
                showAlert(`✅ ${deletedCount} giden arama silindi`, 'success');
                renderOutgoingCallsPage();
            } catch (error) {
                console.error('Toplu silme hatası:', error);
                showAlert('❌ Toplu silme başarısız: ' + error.message, 'danger');
            }
        };
        
        // Cevapsız çağrı mesajı gönder
        window.sendMissedCallMessage = async function(phoneNumber, callDateTime) {
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            // Tarihi formatla - callDateTime zaten Türkçe formatında string olabilir
            let formattedDate = callDateTime;
            
            // Eğer callDateTime string değilse veya "Invalid Date" ise, parse et
            if (callDateTime && typeof callDateTime === 'string') {
                // Eğer zaten "15.11.2025 14:30:45" formatındaysa, saniyeyi kaldır
                if (callDateTime.includes(':')) {
                    // Son iki nokta üst üste arasındaki kısmı (saniye) kaldır
                    const parts = callDateTime.split(' ');
                    if (parts.length >= 2) {
                        const timeParts = parts[1].split(':');
                        if (timeParts.length === 3) {
                            // Saniyeyi çıkar: "14:30:45" -> "14:30"
                            formattedDate = `${parts[0]} ${timeParts[0]}:${timeParts[1]}`;
                        } else {
                            formattedDate = callDateTime;
                        }
                    } else {
                        formattedDate = callDateTime;
                    }
                }
            } else {
                // Date objesi ise formatla
                const dateObj = new Date(callDateTime);
                if (!isNaN(dateObj.getTime())) {
                    formattedDate = dateObj.toLocaleString('tr-TR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } else {
                    formattedDate = 'Bilinmeyen tarih';
                }
            }
            
            // ✅ CRM Mesaj Şablonlarından "Dönüş yapıldı ama cevapsız mesajı" şablonunu al
            const customTemplates = JSON.parse(localStorage.getItem(`crmTemplates_${currentClubId}`) || '{}');
            let messageTemplate = '';
            
            if (customTemplates['missed-call-template']) {
                // Özel şablon varsa onu kullan
                messageTemplate = customTemplates['missed-call-template'].message.replace('{TARIH}', formattedDate);
            } else {
                // Varsayılan şablon
                messageTemplate = `Merhaba,\n\nSporcum olarak size ulaşmaya çalıştık ancak ulaşamadık.\n\nBize ${formattedDate} tarihinde bir cevapsız çağrınız düşmüştür.\n\nSizinle görüşmek ve sorularınızı yanıtlamak isteriz. Lütfen uygun olduğunuzda bizi arayınız.\n\nTeşekkürler,`;
            }
            
            if (!confirm(`${formattedPhone} numarasına aşağıdaki mesajı göndermek istiyor musunuz?\n\n${messageTemplate}`)) {
                return;
            }
            
            try {
                // WhatsApp cihazını kontrol et
                if (!defaultWhatsAppDevice) {
                    showAlert('⚠️ WhatsApp cihazı yapılandırılmamış. Lütfen ayarlardan WhatsApp entegrasyonunu yapılandırın.', 'warning');
                    return;
                }
                
                // Mesajı kuyruğa ekle
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'messageQueue'),
                    {
                        clubId: currentClubId,
                        phone: formattedPhone,
                        message: messageTemplate,
                        deviceId: defaultWhatsAppDevice,
                        scheduledFor: new Date().toISOString(),
                        status: 'pending',
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser?.fullName || 'Admin',
                        type: 'missed_call_notification'
                    }
                );
                
                showAlert('✅ Mesaj kuyruğa eklendi ve en kısa sürede gönderilecek', 'success');
                
                // Cevapsız çağrıları yenile
                await renderMissedCalls();
            } catch (error) {
                console.error('Mesaj gönderme hatası:', error);
                showAlert('❌ Mesaj gönderilemedi: ' + error.message, 'danger');
            }
        };
        
        // Bulutfon checkbox toggle
        window.addEventListener('DOMContentLoaded', function() {
            const bulutfonCheckbox = document.getElementById('bulutfonEnabled');
            const bulutfonSettings = document.getElementById('bulutfon-api-settings');
            
            if (bulutfonCheckbox && bulutfonSettings) {
                bulutfonCheckbox.addEventListener('change', function() {
                    bulutfonSettings.style.display = this.checked ? 'block' : 'none';
                });
                
                // Sayfa yüklendiğinde mevcut duruma göre ayarla
                if (clubSettings && clubSettings.bulutfonEnabled) {
                    bulutfonCheckbox.checked = true;
                    bulutfonSettings.style.display = 'block';
                    if (clubSettings.bulutfonApiKey) {
                        document.getElementById('bulutfonApiKey').value = clubSettings.bulutfonApiKey;
                    }
                }
            }
            
            // ✅ Webhook Checkbox Event Listener
            const webhookCheckbox = document.getElementById('webhookEnabled');
            const webhookSettings = document.getElementById('webhook-settings');
            
            if (webhookCheckbox && webhookSettings) {
                webhookCheckbox.addEventListener('change', function() {
                    webhookSettings.style.display = this.checked ? 'block' : 'none';
                });
                
                // Load webhook settings from Firebase
                loadWebhookSettings();
            }
        });
        
        // ✅ Load Webhook Settings
        async function loadWebhookSettings() {
            try {
                const webhookDoc = await window.firebase.getDoc(
                    window.firebase.doc(window.db, 'webhooks', `contract_${currentClubId}`)
                );
                
                if (webhookDoc.exists()) {
                    const webhookData = webhookDoc.data();
                    const webhookCheckbox = document.getElementById('webhookEnabled');
                    const webhookSettings = document.getElementById('webhook-settings');
                    const webhookUrl = document.getElementById('webhookUrl');
                    
                    if (webhookCheckbox && webhookData.active) {
                        webhookCheckbox.checked = true;
                        if (webhookSettings) webhookSettings.style.display = 'block';
                    }
                    
                    if (webhookUrl && webhookData.url) {
                        webhookUrl.value = webhookData.url;
                    }
                }
            } catch (error) {
                console.error('Webhook ayarları yüklenirken hata:', error);
            }
        }
        
        // ✅ Test Webhook Function
        window.testWebhook = async function() {
            const webhookUrl = document.getElementById('webhookUrl').value;
            
            if (!webhookUrl || webhookUrl.trim() === '') {
                showAlert('⚠️ Lütfen önce Webhook URL giriniz', 'warning');
                return;
            }
            
            try {
                showAlert('🔄 Webhook test ediliyor...', 'info');
                
                const testPayload = {
                    event: 'contract_signed_test',
                    Ad_Soyad: 'Test Kullanıcı',
                    Telefon: '05551234567',
                    TC_Kimlik_No: '12345678901',
                    Adres: 'Test Adresi',
                    branch: 'test',
                    paymentPlan: [],
                    contractPdfBase64: 'data:application/pdf;base64,test',
                    preRegistrationId: 'test-123',
                    timestamp: new Date().toISOString(),
                    isTest: true
                };
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testPayload)
                });
                
                if (response.ok) {
                    showAlert(`✅ Webhook test başarılı! (${response.status} ${response.statusText})`, 'success');
                } else {
                    showAlert(`⚠️ Webhook yanıt verdi ama hata kodu: ${response.status} ${response.statusText}`, 'warning');
                }
            } catch (error) {
                console.error('Webhook test hatası:', error);
                showAlert('❌ Webhook test başarısız! URL\'yi kontrol edin. CORS hatası olabilir.', 'danger');
            }
        };
        
        // Bulutfon bağlantısını test et
        window.testBulutfonConnection = async function() {
            const apiKey = document.getElementById('bulutfonApiKey').value;
            
            if (!apiKey || apiKey.trim() === '') {
                showAlert('⚠️ Lütfen önce API Key giriniz', 'warning');
                return;
            }
            
            try {
                showAlert('🔄 Bağlantı test ediliyor...', 'info');
                
                const response = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${apiKey}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const recordCount = Array.isArray(data) ? data.length : (data.data?.length || 0);
                
                showAlert(`✅ Bağlantı başarılı! ${recordCount} adet görüşme kaydı bulundu.`, 'success');
            } catch (error) {
                console.error('Bulutfon test hatası:', error);
                showAlert('❌ Bağlantı başarısız! API Key\'inizi kontrol edin veya Bulutfon desteği ile iletişime geçin.', 'danger');
            }
        };
        
        // Telefon numarasına tıklayınca kopyala
        window.handlePhoneClick = function(event, phoneNumber) {
            event.preventDefault();
            event.stopPropagation();
            
            if (!phoneNumber) return;
            
            const message = `📋 ${formatPhoneDisplay(phoneNumber)} kopyalandı!`;
            
            // Clipboard API ile kopyala
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(phoneNumber)
                    .then(() => {
                        showAlert(message, 'success');
                    })
                    .catch(err => {
                        console.error('Kopyalama hatası:', err);
                        // Fallback: Eski yöntem
                        fallbackCopyToClipboard(phoneNumber, message);
                    });
            } else {
                // Eski tarayıcılar için fallback
                fallbackCopyToClipboard(phoneNumber, message);
            }
        };
        
        function renderBranchDistribution() {
            const container = document.getElementById('branch-distribution');
            if (!container) return;
            
            const branchCounts = {};
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        const branchName = branches.find(b => b.id === br.branchId)?.name || 'Bilinmiyor';
                        branchCounts[branchName] = (branchCounts[branchName] || 0) + 1;
                    });
                }
            });
            
            const total = Object.values(branchCounts).reduce((a, b) => a + b, 0);
            const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a'];
            
            if (total === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">Henüz branş verisi yok</p></div>';
                return;
            }
            
            container.innerHTML = Object.entries(branchCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([branchName, count], idx) => {
                    const percentage = ((count / total) * 100).toFixed(1);
                    const color = colors[idx % colors.length];
                    return `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="font-weight: 600; font-size: 14px;">${branchName}</span>
                                <span style="font-weight: 600; color: ${color};">${count} (${percentage}%)</span>
                            </div>
                            <div style="background: #f0f0f0; border-radius: 10px; height: 10px; overflow: hidden;">
                                <div style="background: ${color}; height: 100%; width: ${percentage}%; border-radius: 10px; transition: width 0.5s;"></div>
                            </div>
                        </div>
                    `;
                }).join('');
        }
        
        function renderTagDistribution() {
            const container = document.getElementById('tag-distribution');
            if (!container) return;
            
            const tagCounts = {};
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        if (br.selectedTag) {
                            tagCounts[br.selectedTag] = (tagCounts[br.selectedTag] || 0) + 1;
                        }
                        if (br.ageGroup === 'child' && br.children) {
                            br.children.forEach(c => {
                                if (c.selectedTag) {
                                    tagCounts[c.selectedTag] = (tagCounts[c.selectedTag] || 0) + 1;
                                }
                            });
                        }
                    });
                }
            });
            
            const total = Object.values(tagCounts).reduce((a, b) => a + b, 0);
            const colors = ['#f093fb', '#4facfe', '#43e97b', '#fa709a', '#667eea'];
            
            if (total === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">Henüz etiket verisi yok</p></div>';
                return;
            }
            
            container.innerHTML = Object.entries(tagCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([tagName, count], idx) => {
                    const percentage = ((count / total) * 100).toFixed(1);
                    const color = colors[idx % colors.length];
                    return `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="font-weight: 600; font-size: 14px;">🏷️ ${tagName}</span>
                                <span style="font-weight: 600; color: ${color};">${count} (${percentage}%)</span>
                            </div>
                            <div style="background: #f0f0f0; border-radius: 10px; height: 10px; overflow: hidden;">
                                <div style="background: ${color}; height: 100%; width: ${percentage}%; border-radius: 10px; transition: width 0.5s;"></div>
                            </div>
                        </div>
                    `;
                }).join('');
        }
        
        function renderAccumulationAnalysis() {
            const container = document.getElementById('accumulation-analysis');
            if (!container) return;
            
            // Hangi branş+etiket kombinasyonlarında en çok birikme var
            const combinations = {};
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        const branchName = branches.find(b => b.id === br.branchId)?.name || 'Bilinmiyor';
                        const tag = br.selectedTag || 'Etiketsiz';
                        const key = `${branchName} - ${tag}`;
                        combinations[key] = (combinations[key] || 0) + 1;
                        
                        if (br.ageGroup === 'child' && br.children) {
                            br.children.forEach(c => {
                                const childTag = c.selectedTag || 'Etiketsiz';
                                const childKey = `${branchName} - ${childTag}`;
                                combinations[childKey] = (combinations[childKey] || 0) + 1;
                            });
                        }
                    });
                }
            });
            
            const sortedCombo = Object.entries(combinations)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            if (sortedCombo.length === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">Henüz veri yok</p></div>';
                return;
            }
            
            const maxCount = sortedCombo[0][1];
            
            container.innerHTML = `
                <div style="display: grid; gap: 12px;">
                    ${sortedCombo.map(([combo, count]) => {
                        const percentage = ((count / maxCount) * 100);
                        return `
                            <div style="padding: 15px; background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border-radius: 10px; border-left: 4px solid #667eea;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 5px;">${combo}</div>
                                        <div style="background: #e3f2fd; border-radius: 10px; height: 8px; width: ${Math.max(percentage, 10)}px; max-width: 300px; transition: width 0.5s;"></div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 24px; font-weight: 700; color: #667eea;">${count}</div>
                                        <div style="font-size: 11px; color: #888;">Müşteri</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // CRM Leads Listesi
        function renderCRMLeads() {
            const container = document.getElementById('crm-leads-list');
            if (!container) return;
            
            const statusFilter = document.getElementById('crm-status-filter')?.value || 'all';
            const branchFilter = document.getElementById('crm-branch-filter')?.value || 'all';
            
            let filteredLeads = crmLeads;
            
            if (statusFilter !== 'all') {
                filteredLeads = filteredLeads.filter(l => l.status === statusFilter);
            }
            
            if (branchFilter !== 'all') {
                filteredLeads = filteredLeads.filter(l => l.branch === branchFilter);
            }

            // Apply branch-level visibility rules
            filteredLeads = filterByBranch(filteredLeads, 'branch');
            
            // ✅ Ek filtreler buraya eklenebilir (müşteri filtrele, denemeler, etiketler)
            
            if (filteredLeads.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Kayıt bulunamadı</h3>
                        <p>Filtrelerinizi değiştirin veya yeni kayıt ekleyin</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ad Soyad</th>
                            <th>Telefon</th>
                            <th>Branş</th>
                            <th>Durum</th>
                            <th>Üyelik</th>
                            <th>Kaynak</th>
                            <th>Deneme Tarihi</th>
                            <th>Oluşturma</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredLeads.map(lead => {
                            const status = crmStatuses.find(s => s.id === lead.status);
                            const branch = branches.find(b => b.id === lead.branch);
                            const trialDateFormatted = lead.trialDate ? 
                                new Date(lead.trialDate).toLocaleString('tr-TR', { 
                                    year: 'numeric', month: '2-digit', day: '2-digit',
                                    hour: '2-digit', minute: '2-digit'
                                }) : '-';
                            const createdFormatted = new Date(lead.createdAt).toLocaleDateString('tr-TR');
                            
                            // ✅ Üye kontrolü - telefon numarasına göre
                            const memberMatch = members.find(m => phonesMatch(m.Telefon, lead.phone) || phonesMatch(m.Telefon_2, lead.phone));
                            const membershipBadge = memberMatch ? 
                                `<span style="background: #4CAF5015; color: #4CAF50; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer;" onclick="showMemberAttendancePage('${memberMatch.id}')" title="Üye detaylarını görüntüle">
                                    ✅ Üye
                                </span>` : 
                                `<span style="background: #99999915; color: #999; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                    ➖ Üye Değil
                                </span>`;
                            
                            return `
                                <tr>
                                    <td><strong style="cursor: pointer; color: var(--primary-color); text-decoration: underline;" onclick="openCustomerDetail('${lead.id}')">${lead.fullName}</strong></td>
                                    <td><a href="#" class="phone-link" onclick="handlePhoneClick(event, '${lead.phone}')">${lead.phone}</a></td>
                                    <td>${branch ? branch.icon + ' ' + branch.name : '-'}</td>
                                    <td>
                                        <span style="background: ${status?.color}15; color: ${status?.color}; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                            ${status?.icon} ${status?.name}
                                        </span>
                                    </td>
                                    <td>${membershipBadge}</td>
                                    <td>${getSourceName(lead.source)}</td>
                                    <td>${trialDateFormatted}</td>
                                    <td>${createdFormatted}</td>
                                    <td>
                                        <button class="btn btn-sm btn-success" onclick="openCustomerDetail('${lead.id}')" title="Detay">👤</button>
                                        ${memberMatch ? `<button class="btn btn-sm btn-info" onclick="showMemberAttendancePage('${memberMatch.id}')" title="Üye Sayfası">👥</button>` : ''}
                                        <button class="btn btn-sm btn-danger" onclick="deleteLead('${lead.id}')" title="Sil">🗑️</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // WhatsApp ile lead aç
        function openWhatsAppWithLead(leadId) {
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) return;
            
            // WhatsApp sayfasına geç
            showSection('whatsapp', document.querySelector('.nav-btn[onclick*="whatsapp"]'));
            
            // Kısa bir gecikme ile lead'i seç (sayfa yüklenmesini beklemek için)
            setTimeout(() => {
                // WhatsApp contact'ı bul veya oluştur
                const normalizedPhone = lead.phone.replace(/\D/g, '');
                
                // Eğer contact listede varsa seç
                const contactElement = document.querySelector(`[data-phone="${normalizedPhone}"]`);
                if (contactElement) {
                    contactElement.click();
                } else {
                    // Yeni mesaj başlat
                    showToast(`💬 ${lead.fullName} ile WhatsApp Mesajlaşması başlatılıyor...`, 'info');
                }
            }, 500);
        }

        // ============================================
        // ✅ CRM FILTER FUNCTIONS
        // ============================================
        
        // Müşteri yaşını hesapla (doğum tarihinden)
        function getCustomerAge(lead) {
            if (!lead.branches || lead.branches.length === 0) return 999; // Bilinmeyen yaş için büyük değer
            
            let oldestAge = 0;
            
            lead.branches.forEach(branchData => {
                // Yetişkin yaş grubu için parentBirthDate'i kontrol et
                if (branchData.ageGroup === 'adult' && branchData.parentBirthDate) {
                    const birthDate = new Date(branchData.parentBirthDate);
                    const today = new Date();
                    const age = today.getFullYear() - birthDate.getFullYear();
                    const monthDiff = today.getMonth() - birthDate.getMonth();
                    const adjustedAge = (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) ? age - 1 : age;
                    if (adjustedAge > oldestAge) oldestAge = adjustedAge;
                }
                
                // Çocuk yaş grubu için children array'indeki yaş bilgisini kontrol et
                if (branchData.ageGroup === 'child' && branchData.children && branchData.children.length > 0) {
                    branchData.children.forEach(child => {
                        // Önce direkt age alanını kontrol et
                        if (child.age && !isNaN(child.age)) {
                            const childAge = parseInt(child.age);
                            if (childAge > oldestAge) oldestAge = childAge;
                        } 
                        // Yoksa birthDate'den hesapla
                        else if (child.birthDate) {
                            const birthDate = new Date(child.birthDate);
                            const today = new Date();
                            const age = today.getFullYear() - birthDate.getFullYear();
                            const monthDiff = today.getMonth() - birthDate.getMonth();
                            const adjustedAge = (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) ? age - 1 : age;
                            if (adjustedAge > oldestAge) oldestAge = adjustedAge;
                        }
                    });
                }
            });
            
            return oldestAge || 999; // Yaş bulunamazsa büyük değer döndür
        }
        
        // Müşterinin son işlem tarihini al
        function getLastActionDate(lead) {
            let lastDate = null;
            
            // updatedAt varsa kullan
            if (lead.updatedAt) {
                lastDate = new Date(lead.updatedAt);
            }
            
            // createdAt varsa karşılaştır
            if (lead.createdAt) {
                const createdDate = new Date(lead.createdAt);
                if (!lastDate || createdDate > lastDate) {
                    lastDate = createdDate;
                }
            }
            
            // History'deki en son tarihi bul
            if (lead.history && lead.history.length > 0) {
                lead.history.forEach(h => {
                    if (h.date) {
                        // Türkçe tarih formatını parse et (DD/MM/YYYY, HH:MM)
                        const dateParts = h.date.split(/[\s,/:]+/);
                        if (dateParts.length >= 5) {
                            const day = parseInt(dateParts[0]);
                            const month = parseInt(dateParts[1]) - 1;
                            const year = parseInt(dateParts[2]);
                            const hour = parseInt(dateParts[3]);
                            const minute = parseInt(dateParts[4]);
                            const historyDate = new Date(year, month, day, hour, minute);
                            
                            if (!lastDate || historyDate > lastDate) {
                                lastDate = historyDate;
                            }
                        }
                    }
                });
            }
            
            return lastDate;
        }
        
        // Müşteri filtrelerini uygula
        window.applyCustomerFilters = function(exportMode = false) {
            const branchFilter = document.getElementById('filter-branch')?.value || 'all';
            const ageGroupFilter = document.getElementById('filter-age-group')?.value || 'all';
            const tagFilter = document.getElementById('filter-tag')?.value || 'all';
            const searchText = document.getElementById('filter-search')?.value.toLowerCase() || '';
            const dateStart = document.getElementById('filter-date-start')?.value || '';
            const dateEnd = document.getElementById('filter-date-end')?.value || '';
            
            // ✅ İlk açılışta hiçbir filtre seçili değilse, müşterileri gösterme
            const noFilterSelected = branchFilter === 'all' && 
                                     ageGroupFilter === 'all' && 
                                     tagFilter === 'all' && 
                                     searchText === '' && 
                                     dateStart === '' && 
                                     dateEnd === '';
            
            if (noFilterSelected && !exportMode) {
                const tableBody = document.getElementById('filter-customer-list');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <i data-lucide="filter" class="text-muted mb-3" style="width:48px;height:48px;"></i>
                                <p class="text-muted mb-0">Lütfen bir filtre seçin veya arama yapın</p>
                            </td>
                        </tr>
                    `;
                    lucide.createIcons();
                }
                return [];
            }
            
            // Telefon araması için boşluksuz versiyonu da hazırla
            const searchTextNoSpaces = searchText.replace(/\s/g, '');
            
            // ✅ CRM müşterileri + Üyeleri birleştir
            let filtered = [...crmLeads];
            
            // ✅ Üyeleri de ekle (CRM'de olmayan)
            members.forEach(member => {
                // ✅ Çocuğun 2 telefonu varsa (Veli 1 ve Veli 2) her ikisi için de kayıt oluştur
                const phones = [];
                const phone1 = cleanPhoneNumber(member.Telefon);
                const phone2 = cleanPhoneNumber(member.Telefon_2);
                
                if (phone1 && phone1.length >= 10) phones.push({ phone: phone1, veliName: member.Ad_Soyad || '' });
                if (phone2 && phone2.length >= 10) phones.push({ phone: phone2, veliName: member.Veli_2_Adi_Soyadi || '' });
                
                phones.forEach((phoneData, phoneIndex) => {
                    const memberPhone = phoneData.phone;
                    const veliName = phoneData.veliName;
                    
                    // CRM'de zaten var mı kontrol et
                    const existsInCRM = crmLeads.some(l => phonesMatch(l.phone, memberPhone));
                    if (!existsInCRM) {
                        // Branş bilgisini bul
                        const memberBranch = branches.find(b => b.name === member.Brans);
                        const branchId = memberBranch?.id || '';
                        const branchName = member.Brans || 'Bilinmeyen';
                        
                        // Çocuk mu yetişkin mi?
                        const isChild = member.Resit_Olmayan_Adi_Soyadi && member.Resit_Olmayan_Adi_Soyadi.trim() !== '';
                        
                        // ✅ fullName'i düzgün set et (arama için önemli)
                        let displayName = '';
                        let searchableName = '';
                        
                        if (isChild) {
                            // Çocuk: Her veli için ayrı searchableName
                            displayName = member.Resit_Olmayan_Adi_Soyadi;
                            searchableName = `${member.Resit_Olmayan_Adi_Soyadi} ${veliName || member.Ad_Soyad || ''}`; // Hem çocuk hem ilgili veli ismiyle aranabilir
                        } else {
                            // Yetişkin
                            displayName = member.Ad_Soyad || '';
                            searchableName = member.Ad_Soyad || '';
                        }
                        
                        // Üyeyi CRM formatına çevir
                        const memberAsLead = {
                            id: `member_${member.id}_${phoneIndex}`, // ✅ Her telefon için unique ID
                            fullName: displayName,
                            searchableName: searchableName,
                            phone: memberPhone,
                            source: 'member',
                            status: 'converted',
                            isMember: true,
                            memberId: member.id,
                            branches: [{
                                branchId: branchId,
                                branchName: branchName,
                                ageGroup: isChild ? 'child' : 'adult',
                                fullName: displayName,
                                parentName: veliName || (isChild ? (member.Ad_Soyad || '') : ''),
                                selectedTag: 'Üye',
                                children: isChild ? [{
                                    name: member.Resit_Olmayan_Adi_Soyadi,
                                    age: member.studentBirthDate ? calculateAge(member.studentBirthDate) : '',
                                    selectedTag: 'Üye'
                                }] : []
                            }],
                            createdAt: member.registrationDate || member.createdAt || new Date().toISOString(),
                            history: []
                        };
                        filtered.push(memberAsLead);
                    }
                });
            });
            
            // Branş filtresi - En az bir branşı eşleşmeli
            if (branchFilter !== 'all') {
                filtered = filtered.filter(l => {
                    if (!l.branches || l.branches.length === 0) return false;
                    return l.branches.some(b => b.branchId === branchFilter);
                });
            }
            
            // Yaş grubu filtresi - Branş seviyesinde kontrol et
            if (ageGroupFilter !== 'all') {
                filtered = filtered.filter(l => {
                    if (!l.branches || l.branches.length === 0) return false;
                    return l.branches.some(b => b.ageGroup === ageGroupFilter);
                });
            }
            
            // Etiket filtresi - Branş ve çocuk etiketlerini kontrol et
            if (tagFilter !== 'all') {
                filtered = filtered.filter(l => {
                    if (!l.branches || l.branches.length === 0) return false;
                    return l.branches.some(b => {
                        // Branş etiketi kontrolü (yetişkinler için)
                        if (b.selectedTag === tagFilter) return true;
                        // Çocuk etiketleri kontrolü
                        if (b.children && b.children.length > 0) {
                            return b.children.some(c => c.selectedTag === tagFilter);
                        }
                        return false;
                    });
                });
            }
            
            // Son İşlem Tarihi Filtresi
            if (dateStart || dateEnd) {
                filtered = filtered.filter(l => {
                    const lastActionDate = getLastActionDate(l);
                    if (!lastActionDate) return false;
                    
                    // Sadece tarih kısmını karşılaştır (saat dahil etme)
                    const actionDateOnly = new Date(lastActionDate.getFullYear(), lastActionDate.getMonth(), lastActionDate.getDate());
                    
                    if (dateStart) {
                        const startDate = new Date(dateStart);
                        if (actionDateOnly < startDate) return false;
                    }
                    
                    if (dateEnd) {
                        const endDate = new Date(dateEnd);
                        if (actionDateOnly > endDate) return false;
                    }
                    
                    return true;
                });
            }
            
            // Arama filtresi - İsim, telefon, veli ismi, çocuk isimlerinde ara
            if (searchText) {
                filtered = filtered.filter(l => {
                    // Telefon ve genel isim
                    if (l.fullName && l.fullName.toLowerCase().includes(searchText)) return true;
                    
                    // ✅ searchableName alanında ara (üyeler için veli ismi de dahil)
                    if (l.searchableName && l.searchableName.toLowerCase().includes(searchText)) return true;
                    
                    // Telefon araması - tüm rakam olmayan karakterleri temizleyerek ara
                    // Eğer arama metni sayı içeriyorsa telefon olarak değerlendir
                    if (/\d/.test(searchText)) {
                        const cleanSearch = cleanPhoneNumber(searchText); // Sadece rakamlar
                        const cleanLeadPhone = cleanPhoneNumber(l.phone); // Sadece rakamlar
                        
                        // En az 3 haneli arama için kısmi eşleşme
                        if (cleanSearch.length >= 3) {
                            // Aramanın telefonda geçip geçmediğini kontrol et
                            if (cleanLeadPhone.includes(cleanSearch)) return true;
                            
                            // Tam eşleşme kontrolü (son 10 hane)
                            if (cleanSearch.length >= 10 && cleanLeadPhone.length >= 10) {
                                const last10Search = cleanSearch.slice(-10);
                                const last10Phone = cleanLeadPhone.slice(-10);
                                if (last10Search === last10Phone) return true;
                            }
                        }
                    }
                    
                    // Branşlarda ara
                    if (l.branches && l.branches.length > 0) {
                        return l.branches.some(b => {
                            // Yetişkin ismi
                            if (b.fullName && b.fullName.toLowerCase().includes(searchText)) return true;
                            // Veli ismi
                            if (b.parentName && b.parentName.toLowerCase().includes(searchText)) return true;
                            // Çocuk isimleri
                            if (b.children && b.children.length > 0) {
                                return b.children.some(c => c.name && c.name.toLowerCase().includes(searchText));
                            }
                            return false;
                        });
                    }
                    return false;
                });
            }
            
            // Sıralama uygula
            const sortOption = document.getElementById('filter-sort')?.value || 'date-desc';
            
            filtered.sort((a, b) => {
                switch(sortOption) {
                    case 'date-desc': // Son İşlem Tarihi (Yeni → Eski)
                        const dateA = getLastActionDate(a);
                        const dateB = getLastActionDate(b);
                        return (dateB?.getTime() || 0) - (dateA?.getTime() || 0);
                    
                    case 'date-asc': // Son İşlem Tarihi (Eski → Yeni)
                        const dateA2 = getLastActionDate(a);
                        const dateB2 = getLastActionDate(b);
                        return (dateA2?.getTime() || 0) - (dateB2?.getTime() || 0);
                    
                    case 'age-desc': // Yaş (Büyükten Küçüğe)
                        const ageA = getCustomerAge(a);
                        const ageB = getCustomerAge(b);
                        return ageB - ageA;
                    
                    case 'age-asc': // Yaş (Küçükten Büyüğe)
                        const ageA2 = getCustomerAge(a);
                        const ageB2 = getCustomerAge(b);
                        return ageA2 - ageB2;
                    
                    case 'name-asc': // İsim (A → Z)
                        return (a.fullName || '').localeCompare(b.fullName || '', 'tr');
                    
                    case 'name-desc': // İsim (Z → A)
                        return (b.fullName || '').localeCompare(a.fullName || '', 'tr');
                    
                    default:
                        return 0;
                }
            });
            
            // Export mode için direkt veriyi döndür
            if (exportMode) {
                return filtered;
            }
            
            // Normal mode: İstatistikleri güncelle ve listeyi render et
            updateFilterStats(filtered);
            renderFilteredCustomers(filtered);
        };
        
        // Filtrelenmiş müşteri istatistiklerini güncelle
        function updateFilterStats(filtered) {
            document.getElementById('total-filtered').textContent = filtered.length;
            document.getElementById('new-filtered').textContent = filtered.filter(l => l.status === 'new').length;
            document.getElementById('trial-filtered').textContent = filtered.filter(l => l.status === 'trial').length;
            document.getElementById('converted-filtered').textContent = filtered.filter(l => l.status === 'converted').length;
        }
        
        // Filtrelenmiş müşterileri listele
        function renderFilteredCustomers(filtered) {
            const container = document.getElementById('filtered-customers-list');
            if (!container) return;
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Müşteri bulunamadı</h3>
                        <p>Filtrelerinizi değiştirerek yeniden deneyin</p>
                    </div>
                `;
                return;
            }
            
            // Status'a göre renk atama
            const statusColors = {
                'new': { bg: '#e3f2fd', border: '#2196F3', text: '#1976D2' },
                'trial': { bg: '#f3e5f5', border: '#9C27B0', text: '#7B1FA2' },
                'converted': { bg: '#e8f5e9', border: '#4CAF50', text: '#388E3C' },
                'lost': { bg: '#ffebee', border: '#f44336', text: '#d32f2f' },
                'default': { bg: '#fff3e0', border: '#FF9800', text: '#F57C00' }
            };
            
            container.innerHTML = filtered.map(customer => {
                // Status rengi belirle
                const statusColor = statusColors[customer.status] || statusColors['default'];
                
                // Branş bilgilerini kompakt listele
                const branchesInfo = [];
                if (customer.branches && customer.branches.length > 0) {
                    customer.branches.forEach(branchData => {
                        const branch = branches.find(b => b.id === branchData.branchId);
                        const branchIcon = branch ? branch.icon : '🎯';
                        const branchName = branch ? branch.name : 'Bilinmeyen';
                        
                        if (branchData.ageGroup === 'adult') {
                            const tag = branchData.selectedTag || 'Aranmadı';
                            branchesInfo.push(`<div style="display: inline-flex; align-items: center; margin: 2px 4px 2px 0; padding: 4px 8px; background: rgba(255,255,255,0.7); border-radius: 12px; font-size: 10px; border: 1px solid rgba(0,0,0,0.08);">
                                ${branchIcon} <strong style="margin: 0 4px;">${branchName}</strong> <span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 8px; margin-right: 4px;">👨</span> <span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 8px;">${tag}</span>
                            </div>`);
                        } else if (branchData.ageGroup === 'child' && branchData.children) {
                            branchData.children.forEach(child => {
                                const childTag = child.selectedTag || 'Aranmadı';
                                const childAgeInfo = child.age ? ` (${child.age} yaş)` : '';
                                const veliName = branchData.parentName || 'Belirtilmemiş';
                                const displayText = `Öğrenci: ${child.name}${childAgeInfo} / Veli: ${veliName}`;
                                branchesInfo.push(`<div style="display: inline-flex; align-items: center; margin: 2px 4px 2px 0; padding: 4px 8px; background: rgba(255,255,255,0.7); border-radius: 12px; font-size: 10px; border: 1px solid rgba(0,0,0,0.08);">
                                    ${branchIcon} <strong style="margin: 0 4px;">${branchName}</strong> <span style="background: #FFC107; color: white; padding: 2px 6px; border-radius: 8px; margin-right: 4px; font-weight: 600;">${displayText}</span> <span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 8px;">${childTag}</span>
                                </div>`);
                            });
                        }
                    });
                }
                
                const branchesHtml = branchesInfo.length > 0 ? branchesInfo.join('') : '<div style="font-size: 11px; color: #999; padding: 4px 0;">Branş yok</div>';
                
                // Son işlem tarihi
                const lastActionDate = getLastActionDate(customer);
                let lastActionStr = '';
                if (lastActionDate) {
                    const now = new Date();
                    const diffMs = now - lastActionDate;
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 0) {
                        lastActionStr = 'Bugün';
                    } else if (diffDays === 1) {
                        lastActionStr = 'Dün';
                    } else if (diffDays < 7) {
                        lastActionStr = `${diffDays} gün önce`;
                    } else if (diffDays < 30) {
                        lastActionStr = `${Math.floor(diffDays / 7)} hafta önce`;
                    } else {
                        lastActionStr = lastActionDate.toLocaleDateString('tr-TR');
                    }
                }
                
                // Status badge
                const statusLabels = {
                    'new': '🆕 Yeni',
                    'trial': '🎾 Deneme',
                    'converted': '✅ Üye Oldu',
                    'lost': '❌ Kayıp'
                };
                const statusLabel = statusLabels[customer.status] || '📋 Müşteri';
                
                // ✅ Üye ise üye sayfasına, CRM ise detay sayfasına yönlendir
                const clickAction = customer.isMember && customer.memberId 
                    ? `onclick="showMemberAttendancePage('${customer.memberId}')"` 
                    : `onclick="openCustomerDetail('${customer.id}')"`;
                
                return `
                    <div class="filtered-customer-item" style="cursor: pointer; padding: 15px; margin-bottom: 10px; background: ${statusColor.bg}; border-radius: 10px; border-left: 5px solid ${statusColor.border}; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.08);" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.12)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.08)'; this.style.transform='translateY(0)'" ${clickAction}>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-weight: 600; font-size: 14px; color: #333;">${customer.fullName || customer.phone}</div>
                            <div style="background: ${statusColor.border}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">${statusLabel}</div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                            📞 <span onclick="event.stopPropagation()" style="cursor: pointer; display: inline-flex; gap: 6px; align-items: center;">
                                <span onclick="copyToClipboard('${customer.phone}', 'Telefon numarası kopyalandı')" style="padding: 3px 8px; background: rgba(255,255,255,0.8); border-radius: 4px; transition: all 0.2s; border: 1px solid rgba(0,0,0,0.1);" onmouseover="this.style.background='rgba(255,255,255,1)'" onmouseout="this.style.background='rgba(255,255,255,0.8)'" title="Kopyala">${customer.phone} 📋</span>
                                <a href="tel:${customer.phone}" style="padding: 3px 8px; background: rgba(76,175,80,0.1); border-radius: 4px; text-decoration: none; color: #4CAF50; transition: all 0.2s; border: 1px solid rgba(76,175,80,0.2);" onmouseover="this.style.background='rgba(76,175,80,0.2)'" onmouseout="this.style.background='rgba(76,175,80,0.1)'" title="Ara">📞</a>
                            </span>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 4px; margin-bottom: 8px;">
                            ${branchesHtml}
                        </div>
                        ${lastActionStr ? `<div style="font-size: 11px; color: ${statusColor.text}; font-weight: 500;">🕐 Son işlem: ${lastActionStr}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Filtreleri temizle
        window.clearCRMFilters = function() {
            document.getElementById('filter-branch').value = 'all';
            document.getElementById('filter-age-group').value = 'all';
            document.getElementById('filter-tag').value = 'all';
            document.getElementById('filter-search').value = '';
            document.getElementById('filter-date-start').value = '';
            document.getElementById('filter-date-end').value = '';
            document.getElementById('filter-sort').value = 'date-desc'; // Sıralamayı varsayılana döndür
            
            // Listeyi temizle - applyCustomerFilters ile tutarlı mesaj
            const tableBody = document.getElementById('filter-customer-list');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-5">
                            <i data-lucide="filter" class="text-muted mb-3" style="width:48px;height:48px;"></i>
                            <p class="text-muted mb-0">Lütfen bir filtre seçin veya arama yapın</p>
                        </td>
                    </tr>
                `;
                lucide.createIcons();
            }
            
            // İstatistikleri sıfırla
            document.getElementById('total-filtered').textContent = '0';
            document.getElementById('new-filtered').textContent = '0';
            document.getElementById('trial-filtered').textContent = '0';
            document.getElementById('converted-filtered').textContent = '0';
        };
        
        // Filtrelenmiş müşterileri dışa aktar
        window.exportFilteredCustomers = function() {
            // Filtre uygula
            const filtered = applyCustomerFilters(true); // true = export mode
            
            if (!filtered || filtered.length === 0) {
                alert('Dışa aktarılacak müşteri bulunamadı! Önce filtre uygulayın.');
                return;
            }
            
            // CSV oluştur
            const csvRows = [
                ['Telefon', 'Ad Soyad', 'Branş', 'Yaş Grubu', 'Etiket', 'Veli/Öğrenci', 'Yaş', 'Kaynak', 'Oluşturma Tarihi']
            ];
            
            filtered.forEach(customer => {
                if (customer.branches && customer.branches.length > 0) {
                    customer.branches.forEach(branchData => {
                        const branch = branches.find(b => b.id === branchData.branchId);
                        const branchName = branch ? branch.name : 'Bilinmeyen';
                        
                        if (branchData.ageGroup === 'adult') {
                            csvRows.push([
                                customer.phone,
                                customer.fullName || branchData.fullName || '',
                                branchName,
                                'Yetişkin',
                                branchData.selectedTag || '',
                                branchData.fullName || '',
                                '',
                                getSourceName(customer.source || 'other'),
                                customer.createdAt ? new Date(customer.createdAt).toLocaleDateString('tr-TR') : ''
                            ]);
                        } else if (branchData.ageGroup === 'child') {
                            if (branchData.children && branchData.children.length > 0) {
                                branchData.children.forEach(child => {
                                    csvRows.push([
                                        customer.phone,
                                        branchData.parentName || '',
                                        branchName,
                                        'Çocuk',
                                        child.selectedTag || '',
                                        child.name || '',
                                        child.age || '',
                                        getSourceName(customer.source || 'other'),
                                        customer.createdAt ? new Date(customer.createdAt).toLocaleDateString('tr-TR') : ''
                                    ]);
                                });
                            } else {
                                csvRows.push([
                                    customer.phone,
                                    branchData.parentName || '',
                                    branchName,
                                    'Çocuk',
                                    branchData.selectedTag || '',
                                    '',
                                    '',
                                    getSourceName(customer.source || 'other'),
                                    customer.createdAt ? new Date(customer.createdAt).toLocaleDateString('tr-TR') : ''
                                ]);
                            }
                        }
                    });
                } else {
                    csvRows.push([
                        customer.phone,
                        customer.fullName || '',
                        '',
                        '',
                        '',
                        '',
                        '',
                        getSourceName(customer.source || 'other'),
                        customer.createdAt ? new Date(customer.createdAt).toLocaleDateString('tr-TR') : ''
                    ]);
                }
            });
            
            // BOM ekleyerek UTF-8 desteği sağla
            const csvContent = '\ufeff' + csvRows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `musteriler_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showAlert('✅ Müşteriler dışa aktarıldı!', 'success');
        };

        // Ortak görüşme kayıtları render fonksiyonu (üyeler ve CRM detayları için)
        window.renderCallRecords = async function(phoneNumber, containerId) {
            try {
                const container = document.getElementById(containerId);
                if (!container) return;

                container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Görüşme kayıtları yükleniyor...</span></div>';

                if (!clubSettings || !clubSettings.bulutfonApiKey) {
                    container.innerHTML = '<p style="color:#999; padding: 12px;">Bulutfon API anahtarı tanımlı değil.</p>';
                    return;
                }

                const res = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${clubSettings.bulutfonApiKey}`, { headers: { 'Content-Type': 'application/json' } });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const records = Array.isArray(data) ? data : (data.cdrs || data.data || []);

                const phoneRecords = records.filter(r => phonesMatch(r.caller, phoneNumber) || phonesMatch(r.callee, phoneNumber));

                if (phoneRecords.length === 0) {
                    container.innerHTML = '<p style="color:#999; padding: 12px;">Bu numara için görüşme kaydı bulunamadı.</p>';
                    return;
                }

                const html = phoneRecords.slice(0, 20).map(record => {
                    const callTime = new Date(record.call_time);
                    callTime.setHours(callTime.getHours() - 3); // ✅ UTC'den Türkiye saatine çevir
                    const timeStr = callTime.toLocaleString('tr-TR');
                    const direction = record.direction === 'IN' ? '📥 Gelen' : '📤 Giden';
                    const duration = record.talking_seconds ? `${record.talking_seconds}s` : 'Cevapsız';
                    const wasAnswered = record.talking_seconds && parseInt(record.talking_seconds) > 0;
                    const statusColor = wasAnswered ? '#4caf50' : '#f44336';
                    const recordingBtn = (record.uuid && clubSettings && clubSettings.bulutfonApiKey) ?
                        `<button class="btn btn-sm btn-info" onclick="window.open('https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonRecordingProxy?apikey=${clubSettings.bulutfonApiKey}&uuid=${record.uuid}', '_blank')" title="Ses kaydını dinle">🎧 Dinle</button>` : '';
                    return `
                        <div style="padding: 12px; background: #f5f5f5; border-left: 4px solid ${statusColor}; border-radius: 6px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${direction}</div>
                                    <div style="font-size: 13px; color: #666;">🕐 ${timeStr}</div>
                                    <div style="font-size: 13px; color: ${statusColor}; font-weight: 600; margin-top: 4px;">${duration}</div>
                                </div>
                                <div>${recordingBtn}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `<div>${html}</div>`;
            } catch (err) {
                const container = document.getElementById(containerId);
                if (container) container.innerHTML = '<p style="color:#c00; padding: 12px;">Görüşme kayıtları yüklenemedi.</p>';
                console.error('renderCallRecords error:', err);
            }
        };

        // ============================================
        // ✅ CRM TRIALS FUNCTIONS
        // ============================================
        
        // Denemeleri render et
        window.renderTrials = function() {
            const container = document.getElementById('trials-list');
            if (!container) {
                console.log('❌ trials-list container bulunamadı!');
                return;
            }
            
            const branchFilter = document.getElementById('trial-branch-filter')?.value || 'all';
            const searchText = document.getElementById('trial-search')?.value.toLowerCase() || '';
            
            console.log('🎾 renderTrials çağrıldı, crmLeads:', crmLeads.length);
            
            // Deneme tarihi olan her kişiyi (yetişkin veya çocuk) topla
            // Etiket değişse bile deneme tarihi varsa listede kalmalı (manuel kaldırma ile silinir)
            let trials = [];
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(branchData => {
                        // Yetişkin için branş seviyesinde kontrol - sadece denemeDate kontrol et
                        if (branchData.ageGroup === 'adult' && branchData.denemeDate) {
                            trials.push({
                                lead,
                                branchData,
                                childData: null,
                                trialStatus: branchData.trialStatus || 'scheduled'
                            });
                        }
                        // Çocuklar için her çocuğu ayrı kontrol et - sadece denemeDate kontrol et
                        else if (branchData.ageGroup === 'child' && branchData.children && branchData.children.length > 0) {
                            branchData.children.forEach(childData => {
                                if (childData.denemeDate) {
                                    trials.push({
                                        lead,
                                        branchData,
                                        childData,
                                        trialStatus: childData.trialStatus || 'scheduled'
                                    });
                                }
                            });
                        }
                    });
                }
            });
            
            console.log('🎾 Bulunan deneme sayısı:', trials.length);
            
            // Filtreleri uygula
            if (branchFilter !== 'all') {
                trials = trials.filter(t => t.branchData.branchId === branchFilter);
            }
            if (searchText) {
                trials = trials.filter(t => {
                    const parentName = t.branchData.parentName || '';
                    const childName = t.childData ? t.childData.name : '';
                    const adultName = t.branchData.fullName || lead.fullName || '';
                    const searchNoSpaces = searchText.replace(/\s/g, '');
                    
                    return parentName.toLowerCase().includes(searchText) ||
                           childName.toLowerCase().includes(searchText) ||
                           adultName.toLowerCase().includes(searchText) ||
                           t.lead.phone.includes(searchText) ||
                           t.lead.phone.replace(/\s/g, '').includes(searchNoSpaces);
                });
            }
            
            // İstatistikleri güncelle
            updateTrialStats(trials);
            
            if (trials.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Deneme dersi bulunamadı</h3>
                        <p>"Denemeye Gelecek" etiketine sahip müşteriler burada görünür</p>
                    </div>
                `;
                return;
            }
            
            // Tarihe göre gruplandır ve sırala
            const trialsByDate = {};
            const dateColorMap = {};
            const dateBranchMap = {}; // Branş bilgisini saklamak için
            
            // ✅ Branşa göre renk ve stil tanımları
            const branchStyles = {
                'tenis': {
                    colors: ['#fff9e6', '#fff3cc', '#ffe4b3', '#ffd699', '#ffc780'], // Sarı tonları
                    emoji: '🎾',
                    borderColor: '#ffc107'
                },
                'yuzme': {
                    colors: ['#e3f2fd', '#bbdefb', '#90caf9', '#64b5f6', '#42a5f5'], // Mavi tonları
                    emoji: '🏊',
                    borderColor: '#2196f3'
                },
                'default': {
                    colors: ['#f3e5f5', '#e1bee7', '#ce93d8', '#ba68c8', '#ab47bc'], // Mor tonları
                    emoji: '🎯',
                    borderColor: '#9c27b0'
                }
            };
            
            trials.forEach(trial => {
                const trialDate = trial.childData ? new Date(trial.childData.denemeDate) : new Date(trial.branchData.denemeDate);
                const dateTimeStr = trialDate.toLocaleString('tr-TR', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // ✅ Aynı branş + aynı yaş grubu + aynı saat için aynı renk
                const ageGroup = trial.branchData.ageGroup || 'adult';
                const dateKey = `${trial.branchData.branchId}_${ageGroup}_${dateTimeStr}`;
                
                if (!trialsByDate[dateKey]) {
                    trialsByDate[dateKey] = [];
                    
                    // Branş stilini al
                    const branchStyle = branchStyles[trial.branchData.branchId] || branchStyles['default'];
                    dateBranchMap[dateKey] = branchStyle;
                    
                    // Aynı branş için farklı saatlere farklı tonlar
                    const existingBranchKeys = Object.keys(dateBranchMap).filter(k => k.startsWith(trial.branchData.branchId));
                    const colorIndex = existingBranchKeys.length - 1;
                    dateColorMap[dateKey] = branchStyle.colors[colorIndex % branchStyle.colors.length];
                }
                trialsByDate[dateKey].push(trial);
            });
            
            // Tarihe göre sıralı HTML oluştur (branchId_datetime formatından tarihi al)
            const sortedDates = Object.keys(trialsByDate).sort((a, b) => {
                const dateA = trialsByDate[a][0].childData 
                    ? new Date(trialsByDate[a][0].childData.denemeDate)
                    : new Date(trialsByDate[a][0].branchData.denemeDate);
                const dateB = trialsByDate[b][0].childData 
                    ? new Date(trialsByDate[b][0].childData.denemeDate)
                    : new Date(trialsByDate[b][0].branchData.denemeDate);
                // Önce tarihe göre sırala, aynı tarihse branş ID'ye göre
                const timeDiff = dateA - dateB;
                if (timeDiff !== 0) return timeDiff;
                return a.localeCompare(b); // BranchId için alfasayısal sıralama
            });
            
            container.innerHTML = sortedDates.map(dateKey => {
                const dateTrials = trialsByDate[dateKey];
                const bgColor = dateColorMap[dateKey];
                const branchStyle = dateBranchMap[dateKey]; // Branş stilini al
                
                return dateTrials.map(({lead, branchData, childData, trialStatus}) => {
                    const branch = branches.find(b => b.id === branchData.branchId);
                    const trialDate = childData ? new Date(childData.denemeDate) : new Date(branchData.denemeDate);
                    const lastNote = branchData.notesHistory && branchData.notesHistory.length > 0 
                        ? branchData.notesHistory[branchData.notesHistory.length - 1].text 
                        : 'Not yok';
                    
                    // İsim bilgisini belirle
                    let displayName = '';
                    let branchFullName = '';
                    
                    if (childData) {
                        // Çocuk denemesi - veli: xx öğrenci: xx formatında
                        const ageInfo = childData.age ? ` (${childData.age} yaş)` : '';
                        displayName = `Veli: ${branchData.parentName || 'Belirtilmemiş'} / Öğrenci: ${childData.name}${ageInfo}`;
                        branchFullName = '👶 Çocuk - ' + (branch ? branch.name : 'Branş yok');
                    } else if (branchData.ageGroup === 'adult') {
                        // Yetişkin denemesi
                        displayName = branchData.fullName || lead.fullName || 'Yetişkin';
                        branchFullName = '👨 Yetişkin - ' + (branch ? branch.name : 'Branş yok');
                    }
                    
                    // Etiket bilgisi
                    const selectedTag = childData ? childData.selectedTag : branchData.selectedTag;
                    const tagBadge = selectedTag ? `<span style="background: #667eea; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">🏷️ ${selectedTag}</span>` : '';
                    
                    // Deneme ID'si
                    const branchIndex = lead.branches.findIndex(b => b === branchData);
                    const childIndex = childData && branchData.children ? branchData.children.findIndex(c => c === childData) : -1;
                    
                    // Tarih formatı - daha belirgin
                    const dateFormatted = trialDate.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const timeFormatted = trialDate.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                    
                    return `
                        <div class="trial-item ${trialStatus}" style="position: relative; background: ${bgColor}; border-left: 6px solid ${branchStyle.borderColor}; padding: 18px; border-radius: 10px; margin-bottom: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div style="position: absolute; top: 10px; right: 10px; font-size: 64px; opacity: 0.15; pointer-events: none; z-index: 0;">
                                ${branchStyle.emoji}
                            </div>
                            <div style="position: relative; z-index: 1; display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 15px; font-weight: 600; color: #333; margin-bottom: 6px;">
                                        <span style="font-size: 20px; margin-right: 8px;">${branchStyle.emoji}</span>${displayName}
                                    </div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 4px;">
                                        📞 <span onclick="event.stopPropagation()" style="cursor: pointer; display: inline-flex; gap: 8px; align-items: center;">
                                            <span onclick="copyToClipboard('${lead.phone}', 'Telefon numarası kopyalandı')" style="padding: 4px 8px; background: #e3f2fd; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#bbdefb'" onmouseout="this.style.background='#e3f2fd'" title="Kopyala">${lead.phone} 📋</span>
                                            <a href="tel:${lead.phone}" style="padding: 4px 8px; background: #e8f5e9; border-radius: 4px; text-decoration: none; color: #666; transition: background 0.2s;" onmouseover="this.style.background='#c8e6c9'" onmouseout="this.style.background='#e8f5e9'" title="Ara">📞</a>
                                        </span>
                                    </div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 4px;">
                                        🎯 ${branchFullName}
                                    </div>
                                    <div style="margin-top: 6px;">
                                        ${tagBadge}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 18px; font-weight: 700; color: #2c3e50; margin-bottom: 2px;">
                                        ${timeFormatted}
                                    </div>
                                    <div style="font-size: 14px; font-weight: 600; color: #555;">
                                        📅 ${dateFormatted}
                                    </div>
                                    <div style="margin-top: 8px; background: ${getTrialStatusColor(trialStatus)}15; color: ${getTrialStatusColor(trialStatus)}; padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 600; text-align: center;">
                                        ${getTrialStatusIcon(trialStatus)} ${getTrialStatusName(trialStatus)}
                                    </div>
                                </div>
                            </div>
                            <div style="position: relative; z-index: 1; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px;">
                                <button class="btn btn-sm btn-primary" onclick="openCustomerDetail('${lead.id}', ${branchIndex})" style="width: 100%; padding: 8px 12px; font-size: 12px;">👤 Detay</button>
                                <button class="btn btn-sm btn-warning trial-reminder-btn" id="trialBtn_${lead.phone}_${branchIndex}_${childIndex}" onclick="sendTrialReminder('${lead.phone}', '${displayName.replace(/'/g, "\\'")}', '${timeFormatted}', '${dateFormatted}', 'trialBtn_${lead.phone}_${branchIndex}_${childIndex}')" style="width: 100%; padding: 8px 12px; font-size: 12px;">⏰ Hatırlat</button>
                                <button class="btn btn-sm btn-danger" onclick="removeFromTrials('${lead.id}', ${branchIndex}, ${childIndex})" style="width: 100%; padding: 8px 12px; font-size: 12px; background: #f44336;">🗑️ Denemeden Kaldır</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }).join('');
        };
        
        // Denemeden kaldır (sadece listeden, müşteriyi silmez)
        window.removeFromTrials = async function(leadId, branchIndex, childIndex) {
            try {
                const lead = crmLeads.find(l => l.id === leadId);
                if (!lead || !lead.branches || !lead.branches[branchIndex]) {
                    showAlert('❌ Müşteri bulunamadı', 'danger');
                    return;
                }
                
                const branchData = lead.branches[branchIndex];
                let selectedTag = '';
                
                // Çocuk denemesi mi yoksa yetişkin denemesi mi?
                if (childIndex >= 0 && branchData.children && branchData.children[childIndex]) {
                    selectedTag = branchData.children[childIndex].selectedTag;
                } else {
                    selectedTag = branchData.selectedTag;
                }
                
                // ✅ Eğer etiket "Denemeye Gelecek" ise hiçbir şekilde silmeye izin verme
                if (selectedTag === 'Denemeye Gelecek') {
                    showAlert('⚠️ Bu müşterinin etiketi "Denemeye Gelecek" olarak işaretli!\n\nLütfen önce denemeyi sonuçlandırın ve etiketini değiştirin. Denemeye gelecek etiketli müşteriler listeden kaldırılamaz.', 'warning');
                    return; // İşlemi tamamen iptal et
                }
                
                // Diğer etiketler için onay iste
                if (!confirm('Bu denemeyi listeden kaldırmak istediğinize emin misiniz?\n(Müşteri kaydı silinmeyecek, sadece deneme tarihi temizlenecek, etiket korunacak)')) {
                    return;
                }
                
                // Çocuk denemesi mi yoksa yetişkin denemesi mi?
                if (childIndex >= 0 && branchData.children && branchData.children[childIndex]) {
                    // ✅ Çocuk denemesi - SADECE deneme tarihini temizle, ETİKET KALSIN
                    branchData.children[childIndex].denemeDate = null;
                } else {
                    // ✅ Yetişkin denemesi - SADECE deneme tarihini temizle, ETİKET KALSIN
                    branchData.denemeDate = null;
                }
                
                // Firebase'e kaydet
                await window.firebase.updateDoc(
                    window.firebase.doc(window.db, 'crmLeads', leadId),
                    { branches: lead.branches }
                );
                
                showAlert('✅ Deneme listeden kaldırıldı! (Etiket korundu)', 'success');
                await loadData();
                renderTrials();
                updateDashboard();
            } catch (error) {
                console.error('Deneme kaldırma hatası:', error);
                showAlert('❌ İşlem başarısız: ' + error.message, 'danger');
            }
        };
        
        // Deneme hatırlatması gönder (Evolution API ile)
        window.sendTrialReminder = async function(phone, name, time, date, buttonId) {
            try {
                // ✅ Butonu disable et ve görünümünü değiştir
                const btn = document.getElementById(buttonId);
                if (btn) {
                    if (btn.disabled) {
                        showAlert('⏳ Mesaj zaten gönderildi veya kuyruğa eklendi!', 'warning');
                        return;
                    }
                    btn.disabled = true;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '⏳ Gönderiliyor...';
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                }
                
                // WhatsApp cihazını kontrol et
                if (!whatsappDevices || whatsappDevices.length === 0) {
                    showAlert('⚠️ WhatsApp cihazı bulunamadı!', 'warning');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                    }
                    return;
                }
                
                const instanceName = whatsappDevices[0].instanceName || whatsappDevices[0].instance;
                
                // Varsayılan mesaj
                const message = `Merhaba,\n\n📅 ${date} tarihinde saat ${time}'de deneme dersini hatırlatmak isteriz.\n\nGörüşmek üzere! 🎾`;
                
                // Evolution API ile gönder
                const cleanPhone = phone.replace(/\D/g, '');
                
                console.log('📤 Deneme hatırlatması gönderiliyor:', { instanceName, phone: cleanPhone, name });
                
                const success = await sendWhatsAppMessage(instanceName, cleanPhone, message, name);
                
                // ✅ Butonu "Gönderildi" durumuna getir
                if (btn) {
                    btn.innerHTML = '✅ Gönderildi';
                    btn.classList.remove('btn-warning');
                    btn.classList.add('btn-success');
                    btn.style.background = '#4caf50';
                }
                
                showAlert('✅ Deneme hatırlatması kuyruğa eklendi!', 'success');
            } catch (error) {
                console.error('❌ Deneme hatırlatma hatası:', error);
                showAlert('❌ Mesaj gönderilemedi: ' + error.message, 'danger');
                
                // ✅ Hata durumunda butonu tekrar aktif et
                const btn = document.getElementById(buttonId);
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '⏰ Hatırlat';
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            }
        };
        
        // Deneme istatistiklerini güncelle - İstatistikler kaldırıldı, fonksiyon boş bırakıldı
        function updateTrialStats(trials) {
            // İstatistik kartları kaldırıldı
        }
        
        // Deneme durumu rengi
        function getTrialStatusColor(status) {
            const colors = {
                scheduled: '#4facfe',
                completed: '#43e97b',
                cancelled: '#f5576c',
                converted: '#f093fb'
            };
            return colors[status] || '#667eea';
        }
        
        // Deneme durumu ikonu
        function getTrialStatusIcon(status) {
            const icons = {
                scheduled: '📅',
                completed: '✅',
                cancelled: '❌',
                converted: '🎉'
            };
            return icons[status] || '📋';
        }
        
        // Deneme durumu adı
        function getTrialStatusName(status) {
            const names = {
                scheduled: 'Planlandı',
                completed: 'Tamamlandı',
                cancelled: 'İptal',
                converted: 'Üye Oldu'
            };
            return names[status] || 'Bilinmiyor';
        }
        
        // Deneme tamamla
        window.markTrialCompleted = async function(leadId) {
            if (!confirm('Deneme dersini tamamlandı olarak işaretlemek istediğinize emin misiniz?')) return;
            
            try {
                const leadRef = window.firebase.doc(window.db, 'crmLeads', leadId);
                await window.firebase.updateDoc(leadRef, {
                    trialStatus: 'completed',
                    updatedAt: new Date().toISOString()
                });
                showAlert('✅ Deneme tamamlandı olarak işaretlendi!', 'success');
                await loadData();
                renderTrials();
            } catch (error) {
                console.error('Deneme güncellenirken hata:', error);
                showAlert('❌ Hata oluştu: ' + error.message, 'danger');
            }
        };
        
        // Deneme iptal et
        window.cancelTrial = async function(leadId) {
            if (!confirm('Deneme dersini iptal etmek istediğinize emin misiniz?')) return;
            
            try {
                const leadRef = window.firebase.doc(window.db, 'crmLeads', leadId);
                await window.firebase.updateDoc(leadRef, {
                    trialStatus: 'cancelled',
                    updatedAt: new Date().toISOString()
                });
                showAlert('✅ Deneme iptal edildi!', 'success');
                await loadData();
                renderTrials();
            } catch (error) {
                console.error('Deneme güncellenirken hata:', error);
                showAlert('❌ Hata oluştu: ' + error.message, 'danger');
            }
        };
        
        // Deneme modal aç
        window.openAddTrialModal = function() {
            openAddLeadModal();
            // Deneme tarihi alanına odaklan
            setTimeout(() => {
                document.querySelector('[name="trialDate"]')?.focus();
            }, 100);
        };

        // ============================================
        // ✅ CRM TAGS FUNCTIONS
        // ============================================
        
        // Global etiket listesi
        let crmTags = [];
        
        // Etiketleri yükle
        async function loadCRMTags() {
            if (!currentClubId) return;
            
            try {
                // PostgreSQL için: subcollection yerine clubId filtresi
                const tagsRef = window.firebase.query(
                    window.firebase.collection(window.db, 'crmTags'),
                    window.firebase.where('clubId', '==', currentClubId)
                );
                const tagsSnapshot = await window.firebase.getDocs(tagsRef);
                crmTags = tagsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                console.log(`📊 [Kulüp ID: ${currentClubId}] Veritabanından ${crmTags.length} etiket yüklendi:`, crmTags.map(t => `${t.name} (${t.category})`));
                
                // Branşları otomatik etiket olarak ekle
                await syncBranchTags();
                
                console.log(`📊 [Kulüp ID: ${currentClubId}] Branş senkronizasyonu sonrası ${crmTags.length} etiket`);
                
                // Sistem etiketlerini ekle
                await ensureSystemTags();
                
                console.log(`📊 [Kulüp ID: ${currentClubId}] Sistem etiketleri sonrası TOPLAM ${crmTags.length} etiket:`, crmTags.map(t => `${t.name} (${t.category})`));
                
                renderAllTags();
                updateTagStats();
                loadTagsToFilters();
            } catch (error) {
                console.error('Etiketler yüklenirken hata:', error);
            }
        }
        
        // Branşları otomatik etiket olarak senkronize et
        async function syncBranchTags() {
            if (!branches || branches.length === 0) return;
            
            try {
                for (const branch of branches) {
                    // Bu branş etiketi var mı kontrol et
                    const existingTag = crmTags.find(t => t.name === branch.name && t.category === 'branch');
                    
                    if (!existingTag) {
                        // Yoksa ekle
                        const newTag = {
                            name: branch.name,
                            category: 'branch',
                            description: `${branch.icon} ${branch.name} branşı`,
                            isActive: true,
                            isAutoGenerated: true,
                            createdAt: new Date().toISOString(),
                            clubId: currentClubId
                        };
                        
                        const docRef = await window.firebase.addDoc(
                            window.firebase.collection(window.db, 'crmTags'),
                            newTag
                        );
                        
                        crmTags.push({ id: docRef.id, ...newTag });
                    }
                }
            } catch (error) {
                console.error('Branş etiketleri senkronize edilirken hata:', error);
            }
        }
        
        // Sistem etiketlerini oluştur (Kayıt Olabilir, Denemeye Gelecek, Üye Oldu)
        async function ensureSystemTags() {
            const systemTags = [
                {
                    name: 'Aranmadı',
                    category: 'status',
                    description: 'Henüz aranmamış müşteriler',
                    isSystem: true,
                    requiresDate: false,
                    order: 1
                },
                {
                    name: 'Mesaj Atılacak',
                    category: 'status',
                    description: 'Mesaj gönderilecek müşteriler',
                    isSystem: true,
                    requiresDate: false,
                    order: 2
                },
                {
                    name: 'Denemeye Gelecek',
                    category: 'status',
                    description: 'Deneme dersi için randevusu olan müşteriler',
                    isSystem: true,
                    requiresDate: true,
                    order: 3
                },
                {
                    name: 'Denemeye Geldi',
                    category: 'status',
                    description: 'Deneme dersine gelmiş müşteriler',
                    isSystem: true,
                    requiresDate: false,
                    order: 4
                },
                {
                    name: 'Denemeye Gelmedi',
                    category: 'status',
                    description: 'Deneme dersine gelmemiş müşteriler',
                    isSystem: true,
                    requiresDate: false,
                    order: 5
                },
                {
                    name: 'Düşünmüyor',
                    category: 'status',
                    description: 'Kayıt olmayı düşünmeyen müşteriler',
                    isSystem: true,
                    requiresDate: false,
                    order: 6
                },
                {
                    name: 'Kayıt Olabilir',
                    category: 'status',
                    description: 'İleri tarihte kayıt olabilecek müşteriler için',
                    isSystem: true,
                    requiresDate: true,
                    order: 7
                },
                {
                    name: 'Kayıt Oldu',
                    category: 'status',
                    description: 'Kayıt olmuş müşteriler',
                    isSystem: true,
                    requiresDate: false,
                    order: 8
                },
                {
                    name: 'Diğer',
                    category: 'status',
                    description: 'Diğer durumdaki müşteriler',
                    isSystem: true,
                    requiresDate: false,
                    order: 9
                }
            ];
            
            try {
                for (const sysTag of systemTags) {
                    const existing = crmTags.find(t => t.name === sysTag.name);
                    
                    if (!existing) {
                        const newTag = {
                            ...sysTag,
                            isActive: true,
                            createdAt: new Date().toISOString(),
                            clubId: currentClubId
                        };
                        
                        const docRef = await window.firebase.addDoc(
                            window.firebase.collection(window.db, 'crmTags'),
                            newTag
                        );
                        
                        crmTags.push({ id: docRef.id, ...newTag });
                    }
                }
            } catch (error) {
                console.error('Sistem etiketleri oluşturulurken hata:', error);
            }
        }
        
        // Tüm etiketleri render et
        window.renderAllTags = function() {
            const searchText = document.getElementById('tag-search')?.value.toLowerCase() || '';
            const categoryFilter = document.getElementById('tag-category-filter')?.value || 'all';
            
            let filtered = [...crmTags];
            
            if (searchText) {
                filtered = filtered.filter(tag => tag.name.toLowerCase().includes(searchText));
            }
            
            if (categoryFilter !== 'all') {
                filtered = filtered.filter(tag => tag.category === categoryFilter);
            }
            
            // Sıralamaya göre sırala
            filtered.sort((a, b) => (a.order || 999) - (b.order || 999));
            
            // Kategorilere göre ayır ve sırala
            const statusTags = filtered.filter(t => t.category === 'status').sort((a, b) => (a.order || 999) - (b.order || 999));
            const branchTags = filtered.filter(t => t.category === 'branch').sort((a, b) => (a.order || 999) - (b.order || 999));
            const customTags = filtered.filter(t => t.category === 'custom').sort((a, b) => (a.order || 999) - (b.order || 999));
            
            // Her kategoriyi render et
            renderTagCategory('status-tags-list', statusTags, 'status');
            renderTagCategory('branch-tags-list', branchTags, 'branch');
            renderTagCategory('custom-tags-list', customTags, 'custom');
            
            // Tüm etiketler listesi
            const allContainer = document.getElementById('all-tags-list');
            if (allContainer) {
                if (filtered.length === 0) {
                    allContainer.innerHTML = `
                        <div class="empty-state">
                            <h3>Etiket bulunamadı</h3>
                            <p>Yeni etiket eklemek için yukarıdaki butonu kullanın</p>
                        </div>
                    `;
                } else {
                    allContainer.innerHTML = filtered.map((tag, index) => {
                        const usageCount = crmLeads.filter(l => (l.tags || []).includes(tag.name)).length;
                        const tagId = tag.id.replace(/'/g, "\\'");
                        return `
                            <div class="tag-item ${tag.category}-tag" data-tag-id="${tag.id}">
                                <div style="display: flex; flex-direction: column; gap: 2px; margin-right: 8px;">
                                    <button onclick="moveTagUp('${tagId}', 'all')" ${index === 0 ? 'disabled' : ''} style="padding: 2px 6px; font-size: 10px; background: ${index === 0 ? '#ccc' : '#4CAF50'}; color: white; border: none; border-radius: 3px; cursor: ${index === 0 ? 'not-allowed' : 'pointer'};" title="Yukarı Taşı">▲</button>
                                    <button onclick="moveTagDown('${tagId}', 'all')" ${index === filtered.length - 1 ? 'disabled' : ''} style="padding: 2px 6px; font-size: 10px; background: ${index === filtered.length - 1 ? '#ccc' : '#4CAF50'}; color: white; border: none; border-radius: 3px; cursor: ${index === filtered.length - 1 ? 'not-allowed' : 'pointer'};" title="Aşağı Taşı">▼</button>
                                </div>
                                <span class="tag-name">${tag.name}</span>
                                <span class="tag-count">${usageCount}</span>
                                <div class="tag-actions">
                                    <button onclick="editTag('${tagId}')" title="Düzenle">✏️</button>
                                    <button onclick="deleteTag('${tagId}')" title="Sil">🗑️</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
        };
        
        // Kategori etiketlerini render et
        function renderTagCategory(containerId, tags, category) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (tags.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 12px; padding: 10px;">Henüz etiket yok</p>';
                return;
            }
            
            container.innerHTML = tags.map((tag, index) => {
                const usageCount = crmLeads.filter(l => (l.tags || []).includes(tag.name)).length;
                const tagId = tag.id.replace(/'/g, "\\'");
                const categoryStr = category.replace(/'/g, "\\'");
                return `
                    <div class="tag-item ${category}-tag" data-tag-id="${tag.id}">
                        <div style="display: flex; flex-direction: column; gap: 2px; margin-right: 8px;">
                            <button onclick="moveTagUp('${tagId}', '${categoryStr}')" ${index === 0 ? 'disabled' : ''} style="padding: 2px 6px; font-size: 10px; background: ${index === 0 ? '#ccc' : '#4CAF50'}; color: white; border: none; border-radius: 3px; cursor: ${index === 0 ? 'not-allowed' : 'pointer'};" title="Yukarı Taşı">▲</button>
                            <button onclick="moveTagDown('${tagId}', '${categoryStr}')" ${index === tags.length - 1 ? 'disabled' : ''} style="padding: 2px 6px; font-size: 10px; background: ${index === tags.length - 1 ? '#ccc' : '#4CAF50'}; color: white; border: none; border-radius: 3px; cursor: ${index === tags.length - 1 ? 'not-allowed' : 'pointer'};" title="Aşağı Taşı">▼</button>
                        </div>
                        <span class="tag-name">${tag.name}</span>
                        <span class="tag-count">${usageCount}</span>
                        <div class="tag-actions">
                            <button onclick="editTag('${tagId}')" title="Düzenle">✏️</button>
                            <button onclick="deleteTag('${tagId}')" title="Sil">🗑️</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Etiket taşıma fonksiyonları (ok işaretleri ile)
        window.moveTagUp = async function(tagId, category) {
            console.log('moveTagUp çağrıldı:', tagId, category);
            const tag = crmTags.find(t => t.id === tagId);
            if (!tag) {
                console.error('Etiket bulunamadı:', tagId);
                return;
            }
            
            // Aynı kategorideki etiketleri al ve sırala
            const sameCategoryTags = crmTags
                .filter(t => category === 'all' || t.category === category)
                .sort((a, b) => (a.order || 999) - (b.order || 999));
            
            console.log('Aynı kategorideki etiketler:', sameCategoryTags.length);
            
            const currentIndex = sameCategoryTags.findIndex(t => t.id === tagId);
            if (currentIndex <= 0) {
                console.log('Etiket zaten en üstte');
                return; // Zaten en üstte
            }
            
            // Sadece iki etiketin order değerlerini değiştir (swap)
            const currentTag = sameCategoryTags[currentIndex];
            const previousTag = sameCategoryTags[currentIndex - 1];
            
            const tempOrder = currentTag.order;
            currentTag.order = previousTag.order;
            previousTag.order = tempOrder;

            try {
                // Sadece 2 etiketi güncelle
                await Promise.all([
                    window.firebase.updateDoc(
                        window.firebase.doc(window.db, 'crmTags', currentTag.id),
                        { order: currentTag.order }
                    ),
                    window.firebase.updateDoc(
                        window.firebase.doc(window.db, 'crmTags', previousTag.id),
                        { order: previousTag.order }
                    )
                ]);

                console.log('✅ Etiket sıralaması güncellendi');
                await loadCRMTags();
                renderAllTags();
            } catch (error) {
                console.error('Etiket taşınırken hata:', error);
                showAlert('❌ Etiket taşınırken hata oluştu: ' + error.message, 'danger');
            }
        };
        
        window.moveTagDown = async function(tagId, category) {
            console.log('moveTagDown çağrıldı:', tagId, category);
            const tag = crmTags.find(t => t.id === tagId);
            if (!tag) {
                console.error('Etiket bulunamadı:', tagId);
                return;
            }
            
            // Aynı kategorideki etiketleri al ve sırala
            const sameCategoryTags = crmTags
                .filter(t => category === 'all' || t.category === category)
                .sort((a, b) => (a.order || 999) - (b.order || 999));
            
            console.log('Aynı kategorideki etiketler:', sameCategoryTags.length);
            
            const currentIndex = sameCategoryTags.findIndex(t => t.id === tagId);
            if (currentIndex >= sameCategoryTags.length - 1 || currentIndex < 0) {
                console.log('Etiket zaten en altta');
                return; // Zaten en altta
            }
            
            // Sadece iki etiketin order değerlerini değiştir (swap)
            const currentTag = sameCategoryTags[currentIndex];
            const nextTag = sameCategoryTags[currentIndex + 1];
            
            const tempOrder = currentTag.order;
            currentTag.order = nextTag.order;
            nextTag.order = tempOrder;

            try {
                // Sadece 2 etiketi güncelle
                await Promise.all([
                    window.firebase.updateDoc(
                        window.firebase.doc(window.db, 'crmTags', currentTag.id),
                        { order: currentTag.order }
                    ),
                    window.firebase.updateDoc(
                        window.firebase.doc(window.db, 'crmTags', nextTag.id),
                        { order: nextTag.order }
                    )
                ]);

                console.log('✅ Etiket sıralaması güncellendi');
                await loadCRMTags();
                renderAllTags();
            } catch (error) {
                console.error('Etiket taşınırken hata:', error);
                showAlert('❌ Etiket taşınırken hata oluştu: ' + error.message, 'danger');
            }
        };
        
        // Drag & Drop fonksiyonları (eski sistem - opsiyonel)
        let draggedTagElement = null;
        let draggedTagId = null;
        
        window.handleTagDragStart = function(event) {
            draggedTagElement = event.target;
            draggedTagId = event.target.dataset.tagId;
            event.target.style.opacity = '0.4';
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.innerHTML);
        };
        
        window.handleTagDragOver = function(event) {
            if (event.preventDefault) {
                event.preventDefault();
            }
            event.dataTransfer.dropEffect = 'move';
            
            const target = event.target.closest('.tag-item');
            if (target && target !== draggedTagElement) {
                target.style.borderTop = '2px solid #4CAF50';
            }
            return false;
        };
        
        window.handleTagDrop = async function(event) {
            if (event.stopPropagation) {
                event.stopPropagation();
            }
            
            const target = event.target.closest('.tag-item');
            if (!target || target === draggedTagElement) return false;
            
            target.style.borderTop = '';
            
            // Sıralamayı değiştir
            const draggedTag = crmTags.find(t => t.id === draggedTagId);
            const targetTagId = target.dataset.tagId;
            const targetTag = crmTags.find(t => t.id === targetTagId);
            
            if (!draggedTag || !targetTag) return false;
            
            // Sadece aynı kategorideki etiketleri sıralayabilir
            if (draggedTag.category !== targetTag.category) {
                showAlert('⚠️ Sadece aynı kategorideki etiketleri sıralayabilirsiniz', 'warning');
                return false;
            }
            
            // Sıralamayı değiştir
            const draggedOrder = draggedTag.order || 999;
            const targetOrder = targetTag.order || 999;
            
            // Aynı kategorideki tüm etiketleri al ve sırala
            const sameCategoryTags = crmTags
                .filter(t => t.category === draggedTag.category)
                .sort((a, b) => (a.order || 999) - (b.order || 999));
            
            // Yeni sıralamayı hesapla
            const draggedIndex = sameCategoryTags.findIndex(t => t.id === draggedTagId);
            const targetIndex = sameCategoryTags.findIndex(t => t.id === targetTagId);
            
            // Sıralamayı değiştir
            sameCategoryTags.splice(draggedIndex, 1);
            sameCategoryTags.splice(targetIndex, 0, draggedTag);
            
            // Her etikete yeni order değeri ata ve kaydet
            try {
                for (let i = 0; i < sameCategoryTags.length; i++) {
                    const tag = sameCategoryTags[i];
                    tag.order = i;
                    
                    // Firebase'e kaydet
                    const tagRef = window.firebase.doc(window.db, `clubs/${currentClubId}/crmTags/${tag.id}`);
                    await window.firebase.updateDoc(tagRef, { order: i });
                }
                
                // Local array'i güncelle
                await loadCRMTags();
                
                showAlert('✅ Etiket sıralaması güncellendi', 'success');
            } catch (error) {
                console.error('Sıralama kaydedilirken hata:', error);
                showAlert('❌ Sıralama kaydedilemedi', 'danger');
            }
            
            return false;
        };
        
        window.handleTagDragEnd = function(event) {
            event.target.style.opacity = '1';
            
            // Tüm border'ları temizle
            document.querySelectorAll('.tag-item').forEach(item => {
                item.style.borderTop = '';
            });
        };
        
        // Etiket istatistiklerini güncelle
        function updateTagStats() {
            const activeTags = crmTags.filter(t => t.isActive !== false);
            const taggedCustomers = new Set();
            crmLeads.forEach(lead => {
                if (lead.tags && lead.tags.length > 0) {
                    taggedCustomers.add(lead.id);
                }
            });
            
            document.getElementById('total-tags').textContent = crmTags.length;
            document.getElementById('active-tags').textContent = activeTags.length;
            document.getElementById('tagged-customers').textContent = taggedCustomers.size;
        }
        
        // Etiketleri filtrelere yükle
        function loadTagsToFilters() {
            const filterTag = document.getElementById('filter-tag');
            if (filterTag) {
                // Branş etiketlerini gizle ve ORDER'a göre sırala
                const nonBranchTags = crmTags
                    .filter(tag => tag.category !== 'branch')
                    .sort((a, b) => {
                        const orderA = a.order !== undefined ? a.order : 999;
                        const orderB = b.order !== undefined ? b.order : 999;
                        return orderA - orderB;
                    });
                filterTag.innerHTML = '<option value="all">Tümü</option>' + 
                    nonBranchTags.map(tag => 
                        `<option value="${tag.name}">${tag.name}</option>`
                    ).join('');
            }
        }
        
        // CRM Şablonlar Sayfasını Render Et
        function renderCRMTemplatesPage() {
            const container = document.getElementById('main-content') || document.querySelector('.admin-content');
            if (!container) return;
            
            // localStorage'dan özel şablonları yükle
            const customTemplates = JSON.parse(localStorage.getItem(`crmTemplates_${currentClubId}`) || '{}');
            
            // ✅ Sadece 2 mesaj şablonu
            const genTemplates = [
                {
                    id: 'missed-call-template',
                    name: 'Dönüş yapıldı ama cevapsız mesajı',
                    message: 'Merhaba,\n\nSporcum olarak size ulaşmaya çalıştık ancak ulaşamadık.\n\nBize {TARIH} tarihinde bir cevapsız çağrınız düşmüştür.\n\nSizinle görüşmek ve sorularınızı yanıtlamak isteriz. Lütfen uygun olduğunuzda bizi arayınız.\n\nTeşekkürler,',
                    icon: '📞',
                    color: '#2196F3'
                },
                {
                    id: 'incoming-missed-call-template',
                    name: 'Cevapsız çağrıya otomatik mesaj',
                    message: 'Merhaba,\n\nBizi {TARIH} tarihinde aramaya çalıştınız ancak o anda yoğunluktan dolayı telefonunuzu açamadık.\n\nSize nasıl yardımcı olabiliriz?\n\nLütfen bizi tekrar arayabilir veya mesajınızı buradan iletebilirsiniz.\n\nTeşekkürler,\nSporcum',
                    icon: '📵',
                    color: '#f44336'
                }
            ];
            
            // ✅ localStorage'daki özel şablonu uygula
            genTemplates.forEach(template => {
                if (customTemplates[template.id]) {
                    template.name = customTemplates[template.id].name;
                    template.message = customTemplates[template.id].message;
                }
            });
            
            const templatesByBranch = {};
            templatesByBranch['genel'] = genTemplates;
            
            // ✅ BRANŞ SEKMELERİ KALDIRILDI - Sadece genel şablonlar kullanılıyor
            
            // Sekme butonları oluştur (sadece genel)
            let tabsHTML = '';
            
            // Sekme içerikleri
            let contentsHTML = '';
            
            // Her branş için içerik oluştur
            Object.keys(templatesByBranch).forEach((branchKey, index) => {
                const isActive = branchKey === 'genel';
                const templates = templatesByBranch[branchKey];
                const branchName = branchKey === 'genel' ? 'Genel CRM' : (branches.find(b => b.id === branchKey)?.name || branchKey);
                
                contentsHTML += `
                    <div class="tab-content ${isActive ? 'active' : ''}" id="template-tab-${branchKey}" style="display: ${isActive ? 'block' : 'none'};">
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #667eea; margin-bottom: 15px;">${branchName} Mesaj Şablonları</h3>
                            <div style="display: grid; gap: 15px;">
                                ${templates.map(template => `
                                    <div style="background: ${template.color}15; border-left: 4px solid ${template.color}; border-radius: 8px; padding: 15px;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                                            <div>
                                                <div style="font-size: 24px; margin-bottom: 5px;">${template.icon}</div>
                                                <h4 style="margin: 0; font-size: 16px; color: #333;">${template.name}</h4>
                            </div>
                                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                                <button class="btn btn-sm btn-warning" onclick="editCRMTemplate('${template.id}', '${branchKey}')" title="Şablonu Düzenle">
                                                    ✏️ Düzenle
                                                </button>
                                                <button class="btn btn-sm btn-primary" onclick="copyTemplateToClipboard(\`${template.message.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, '${branchKey}')" title="Şablonu Kopyala">
                                                    📋 Kopyala
                                                </button>
                            </div>
                            </div>
                                        <pre style="background: white; padding: 12px; border-radius: 6px; font-size: 13px; white-space: pre-wrap; margin: 0; font-family: inherit; border: 1px solid ${template.color}30; line-height: 1.6;">${template.message}</pre>
                                        <div style="margin-top: 10px; font-size: 11px; color: #666; padding: 8px; background: white; border-radius: 4px;">
                                            <strong>📝 Değişkenler:</strong> {isim}, {tarih}, {saat}, {kulup_adi}, {adres}, {tutar}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                    </div>
                </div>
            `;
            });
            
            // Ana HTML'i oluştur
            const html = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">📝 CRM Mesaj Şablonları</h2>
                    </div>
                    
                    ${tabsHTML}
                    ${contentsHTML}
                </div>
            `;
            
            // Render et
            const mainContent = document.querySelector('.admin-content');
            if (mainContent) {
                // Mevcut içeriği temizle ve yeni içeriği ekle
                const sections = mainContent.querySelectorAll('.section');
                sections.forEach(s => s.style.display = 'none');
                
                // CRM Templates section varsa güncelle, yoksa oluştur
                let templateSection = document.getElementById('crm-templates-section');
                if (!templateSection) {
                    templateSection = document.createElement('div');
                    templateSection.id = 'crm-templates-section';
                    templateSection.className = 'section';
                    mainContent.appendChild(templateSection);
                }
                
                templateSection.innerHTML = html;
                templateSection.style.display = 'block';
            }
        }
        
        // Şablon sekmesini değiştir
        window.switchTemplateTab = function(branchId) {
            // Tüm sekmeleri pasif yap
            const tabs = document.querySelectorAll('.customer-tabs .tab-button');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Tüm içerikleri gizle
            const contents = document.querySelectorAll('[id^="template-tab-"]');
            contents.forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // Seçilen sekmeyi aktif yap
            const selectedTab = Array.from(tabs).find(tab => tab.getAttribute('onclick').includes(branchId));
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Seçilen içeriği göster
            const selectedContent = document.getElementById(`template-tab-${branchId}`);
            if (selectedContent) {
                selectedContent.classList.add('active');
                selectedContent.style.display = 'block';
            }
        };
        
        // CRM şablonu düzenle
        window.editCRMTemplate = function(templateId, branchKey) {
            // localStorage'dan özel şablonları yükle
            const customTemplates = JSON.parse(localStorage.getItem(`crmTemplates_${currentClubId}`) || '{}');
            
            // Şablon içeriğini bul (önce localStorage'da, sonra default'ta)
            let template = customTemplates[templateId];
            
            if (!template) {
                // ✅ 2 mesaj şablonu
                const allTemplates = {};
                allTemplates['missed-call-template'] = { 
                    name: 'Dönüş yapıldı ama cevapsız mesajı', 
                    message: 'Merhaba,\n\nSporcum olarak size ulaşmaya çalıştık ancak ulaşamadık.\n\nBize {TARIH} tarihinde bir cevapsız çağrınız düşmüştür.\n\nSizinle görüşmek ve sorularınızı yanıtlamak isteriz. Lütfen uygun olduğunuzda bizi arayınız.\n\nTeşekkürler,' 
                };
                allTemplates['incoming-missed-call-template'] = { 
                    name: 'Cevapsız çağrıya otomatik mesaj', 
                    message: 'Merhaba,\n\nBizi {TARIH} tarihinde aramaya çalıştınız ancak o anda yoğunluktan dolayı telefonunuzu açamadık.\n\nSize nasıl yardımcı olabiliriz?\n\nLütfen bizi tekrar arayabilir veya mesajınızı buradan iletebilirsiniz.\n\nTeşekkürler,\nSporcum' 
                };
                
                template = allTemplates[templateId] || { name: 'Şablon', message: '' };
            }
            
            // ✅ Inline düzenleme alanı oluştur
            const editContainer = document.createElement('div');
            editContainer.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            
            editContainer.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 30px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <h2 style="margin: 0 0 20px 0; color: #333; font-size: 24px;">✏️ Şablonu Düzenle</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">Şablon Adı:</label>
                        <input type="text" id="templateNameInput" value="${template.name || ''}" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;" />
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">Mesaj İçeriği:</label>
                        <textarea id="templateMessageInput" rows="12" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px; font-family: inherit; line-height: 1.6; box-sizing: border-box; resize: vertical;">${template.message || ''}</textarea>
                        <small style="display: block; margin-top: 8px; color: #666; font-size: 13px;">
                            📝 <strong>Kullanılabilir değişken:</strong> {TARIH} (Çağrı tarihi otomatik eklenir - saniye olmadan)
                        </small>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button id="cancelEditBtn" style="padding: 12px 24px; border: 2px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                            ❌ İptal
                        </button>
                        <button id="saveEditBtn" style="padding: 12px 24px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
                            💾 Kaydet
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(editContainer);
            
            // Focus input
            document.getElementById('templateNameInput').focus();
            
            // İptal butonu
            document.getElementById('cancelEditBtn').onclick = function() {
                document.body.removeChild(editContainer);
            };
            
            // Overlay'e tıklama ile kapat
            editContainer.onclick = function(e) {
                if (e.target === editContainer) {
                    document.body.removeChild(editContainer);
                }
            };
            
            // Kaydet butonu
            document.getElementById('saveEditBtn').onclick = function() {
                const newName = document.getElementById('templateNameInput').value.trim();
                const newMessage = document.getElementById('templateMessageInput').value.trim();
                
                if (!newName || !newMessage) {
                    alert('⚠️ Şablon adı ve mesaj içeriği boş olamaz!');
                    return;
                }
                
                // localStorage'a kaydet
                const updatedTemplate = {
                    name: newName,
                    message: newMessage
                };
                
                customTemplates[templateId] = updatedTemplate;
                localStorage.setItem(`crmTemplates_${currentClubId}`, JSON.stringify(customTemplates));
                
                showAlert('✅ Şablon başarıyla güncellendi!', 'success');
                
                // Modal'ı kapat
                document.body.removeChild(editContainer);
                
                // Sayfayı yenile
                renderCRMTemplatesPage();
                switchTemplateTab(branchKey);
            };
        };
        
        // Şablonu panoya kopyala
        window.copyTemplateToClipboard = function(message, branchId) {
            navigator.clipboard.writeText(message).then(() => {
                showAlert('✅ Şablon panoya kopyalandı!', 'success', 2000);
            }).catch(err => {
                console.error('Kopyalama hatası:', err);
                showAlert('❌ Kopyalama başarısız!', 'danger');
            });
        };
        
        // Şablonu WhatsApp'ta kullan
        window.useTemplateInWhatsApp = function(message) {
            // WhatsApp sayfasına git
            showSection('whatsapp', document.querySelector('.nav-btn[onclick*="whatsapp"]'));
            
            // Mesaj alanına şablonu yerleştir
            setTimeout(() => {
                const messageField = document.getElementById('bulkMessageText');
                if (messageField) {
                    messageField.value = message;
                    showAlert('✅ Şablon WhatsApp mesaj alanına yüklendi!', 'success', 2000);
                    
                    // Mesajlaşma sekmesine geç
                    if (window.switchWhatsAppTab) {
                        switchWhatsAppTab('messages');
                    }
                } else {
                    showAlert('❌ WhatsApp mesaj alanı bulunamadı!', 'danger');
                }
            }, 500);
        };
        
        // Etiket modal aç
        window.openAddTagModal = function() {
            const html = `
                <div id="addTagModal" class="modal" style="display: block;">
                    <div class="modal-content">
                        <span class="close" onclick="closeModal('addTagModal')">&times;</span>
                        <h3>➕ Yeni Etiket</h3>
                        <form id="addTagForm" onsubmit="handleAddTag(event)">
                            <div class="form-group">
                                <label>Etiket Adı *</label>
                                <input type="text" name="tagName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Kategori *</label>
                                <select name="category" class="form-control" required>
                                    <option value="status">Durum</option>
                                    <option value="branch">Branş</option>
                                    <option value="custom">Özel</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Açıklama</label>
                                <textarea name="description" class="form-control" rows="3"></textarea>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="submit" class="btn btn-primary" style="flex: 1;">💾 Kaydet</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('addTagModal')">İptal</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Modal varsa kaldır
            const existing = document.getElementById('addTagModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', html);
        };
        
        // Etiket ekle
        window.handleAddTag = async function(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const newTag = {
                name: formData.get('tagName'),
                category: formData.get('category'),
                description: formData.get('description') || '',
                isActive: true,
                order: (crmTags && crmTags.length > 0) ? Math.max(...crmTags.map(t => t.order ?? 0)) + 1 : 0,
                createdAt: new Date().toISOString(),
                clubId: currentClubId
            };
            
            try {
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'crmTags'), 
                    newTag
                );
                showAlert('✅ Etiket başarıyla eklendi!', 'success');
                closeModal('addTagModal');
                loadCRMTags();
            } catch (error) {
                console.error('Etiket eklenirken hata:', error);
                showAlert('❌ Etiket eklenirken hata oluştu: ' + error.message, 'danger');
            }
        };
        
        // Etiket düzenle
        window.editTag = function(tagId) {
            const tag = crmTags.find(t => t.id === tagId);
            if (!tag) return;
            
            const html = `
                <div id="editTagModal" class="modal" style="display: block;">
                    <div class="modal-content">
                        <span class="close" onclick="closeModal('editTagModal')">&times;</span>
                        <h3>✏️ Etiket Düzenle</h3>
                        <form id="editTagForm" onsubmit="handleEditTag(event, '${tagId}')">
                            <div class="form-group">
                                <label>Etiket Adı *</label>
                                <input type="text" name="tagName" class="form-control" value="${tag.name}" required>
                            </div>
                            <div class="form-group">
                                <label>Kategori *</label>
                                <select name="category" class="form-control" required>
                                    <option value="status" ${tag.category === 'status' ? 'selected' : ''}>Durum</option>
                                    <option value="branch" ${tag.category === 'branch' ? 'selected' : ''}>Branş</option>
                                    <option value="custom" ${tag.category === 'custom' ? 'selected' : ''}>Özel</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Açıklama</label>
                                <textarea name="description" class="form-control" rows="3">${tag.description || ''}</textarea>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="submit" class="btn btn-primary" style="flex: 1;">💾 Güncelle</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('editTagModal')">İptal</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('editTagModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', html);
        };
        
        // Etiket güncelle
        window.handleEditTag = async function(event, tagId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const updatedTag = {
                name: formData.get('tagName'),
                category: formData.get('category'),
                description: formData.get('description') || '',
                updatedAt: new Date().toISOString()
            };
            
            try {
                const tagRef = window.firebase.doc(window.db, 'crmTags', tagId);
                await window.firebase.updateDoc(tagRef, updatedTag);
                showAlert('✅ Etiket başarıyla güncellendi!', 'success');
                closeModal('editTagModal');
                loadCRMTags();
            } catch (error) {
                console.error('Etiket güncellenirken hata:', error);
                showAlert('❌ Etiket güncellenirken hata oluştu: ' + error.message, 'danger');
            }
        };
        
        // Etiket sil
        window.deleteTag = async function(tagId) {
            if (!confirm('Bu etiketi silmek istediğinize emin misiniz?')) return;
            
            try {
                await window.firebase.deleteDoc(
                    window.firebase.doc(window.db, 'crmTags', tagId)
                );
                showAlert('✅ Etiket başarıyla silindi!', 'success');
                loadCRMTags();
            } catch (error) {
                console.error('Etiket silinirken hata:', error);
                showAlert('❌ Etiket silinirken hata oluştu: ' + error.message, 'danger');
            }
        };
        
        // Global branş sayacı
        let branchFieldCounter = 0;
        
        // Branş field HTML'i oluştur
        function generateBranchFieldHTML(params) {
            const { index, branchId, branchData, ageGroup, fullName, parentName, children, selectedTag, kayitOlabilirDate, denemeDate, notesHistory, newNote } = params;
            
            const nonBranchTags = crmTags
                .filter(tag => tag.category !== 'branch')
                .sort((a, b) => (a.order || 999) - (b.order || 999));
            
            // Çocukları render et
            const childrenArray = children || [];
            const childrenHtml = childrenArray.map((child, childIndex) => `
                <div style="padding: 15px; background: white; border-radius: 8px; border: 2px solid #e0e0e0; margin-bottom: 10px; position: relative;" data-child-index="${childIndex}">
                    <button type="button" onclick="removeChildFromBranch(${index}, ${childIndex})" style="position: absolute; top: 10px; right: 10px; background: #f44336; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 16px; z-index: 10;">×</button>
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 11px; color: #666;">Çocuk Ad Soyad</label>
                            <input type="text" placeholder="Ad Soyad" value="${child.name || ''}" class="form-control" onchange="updateChildData(${index}, ${childIndex}, 'name', this.value)">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 11px; color: #666;">Yaş</label>
                            <input type="number" placeholder="Yaş" value="${child.age || ''}" class="form-control" min="1" max="18" onchange="updateChildData(${index}, ${childIndex}, 'age', this.value)">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-size: 11px; color: #666;">&#x1F3F7;&#xFE0F; Etiket *</label>
                        <select class="form-control" required onchange="updateChildData(${index}, ${childIndex}, 'selectedTag', this.value); handleChildTagSelection(${index}, ${childIndex}, this)">
                            <option value="">Etiket seçiniz...</option>
                            ${nonBranchTags.map(tag => `<option value="${tag.name}" ${child.selectedTag === tag.name ? 'selected' : ''}>${tag.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div id="child-${index}-${childIndex}-dates" style="display: ${child.selectedTag ? 'block' : 'none'};">
                        <div id="child-${index}-${childIndex}-kayit" style="display: ${child.selectedTag === 'Kayıt Olabilir' ? 'block' : 'none'}; margin-bottom: 10px;">
                            <label style="font-size: 11px; color: #666;">&#x1F4C5; Kayıt Olabilir Tarihi</label>
                            <input type="datetime-local" value="${child.kayitOlabilirDate || ''}" class="form-control" onchange="updateChildData(${index}, ${childIndex}, 'kayitOlabilirDate', this.value)">
                        </div>
                        
                        <div id="child-${index}-${childIndex}-deneme" style="display: ${child.selectedTag === 'Denemeye Gelecek' ? 'block' : 'none'}; margin-bottom: 10px;">
                            <label style="font-size: 11px; color: #666;">&#x1F4C5; Deneme Dersi Tarihi</label>
                            <input type="datetime-local" value="${child.denemeDate || ''}" class="form-control" onchange="updateChildData(${index}, ${childIndex}, 'denemeDate', this.value)">
                        </div>
                    </div>
                </div>
            `).join('');
            
            return `
                <div class="branch-field-card" id="branch-field-${index}" style="background: #f9f9f9; border: 2px solid #ddd; border-radius: 12px; padding: 15px; margin-bottom: 15px; position: relative;">
                    <button type="button" onclick="removeBranchField(${index})" style="position: absolute; top: 10px; right: 10px; background: #f44336; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px; z-index: 10;">×</button>
                    
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label>Branş *</label>
                            <select name="branches[${index}][branchId]" class="form-control" required>
                                <option value="">Seçiniz...</option>
                                ${branches.map(b => `<option value="${b.id}" ${branchId === b.id ? 'selected' : ''}>${b.icon} ${b.name}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Yaş Grubu *</label>
                            <select name="branches[${index}][ageGroup]" class="form-control" required onchange="handleBranchAgeGroupChange(${index}, this)">
                                <option value="">Seçiniz...</option>
                                <option value="adult" ${ageGroup === 'adult' ? 'selected' : ''}>👨 Yetişkin</option>
                                <option value="child" ${ageGroup === 'child' ? 'selected' : ''}>👶 Çocuk</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="branch-tag-field-${index}">
                            <label>🏷️ Etiket *</label>
                            <select name="branches[${index}][selectedTag]" class="form-control" required onchange="handleBranchTagSelection(${index}, this)">
                                <option value="">Etiket seçiniz...</option>
                                ${nonBranchTags.map(tag => `<option value="${tag.name}" ${selectedTag === tag.name ? 'selected' : ''}>${tag.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Yetişkin için Alan -->
                    <div id="branch-adult-${index}" style="display: ${ageGroup === 'adult' ? 'block' : 'none'};">
                        <div class="form-group">
                            <label>Ad Soyad *</label>
                            <input type="text" name="branches[${index}][fullName]" class="form-control" value="${fullName || ''}">
                        </div>
                        
                        <!-- Yetişkin için özel etiket tarihleri -->
                        <div id="branch-adult-dates-${index}" style="display: ${selectedTag ? 'block' : 'none'};">
                            <div id="branch-adult-kayit-${index}" style="display: ${selectedTag === 'Kayıt Olabilir' ? 'block' : 'none'};">
                                <div class="form-group">
                                    <label>&#x1F4C5; Kayıt Olabilir Tarihi</label>
                                    <input type="datetime-local" name="branches[${index}][kayitOlabilirDate]" class="form-control" value="${kayitOlabilirDate || ''}">
                                </div>
                            </div>
                            
                            <div id="branch-adult-deneme-${index}" style="display: ${selectedTag === 'Denemeye Gelecek' ? 'block' : 'none'};">
                                <div class="form-group">
                                    <label>&#x1F4C5; Deneme Dersi Tarihi</label>
                                    <input type="datetime-local" name="branches[${index}][denemeDate]" class="form-control" value="${denemeDate || ''}">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Çocuk için Alanlar -->
                    <div id="branch-child-${index}" style="display: ${ageGroup === 'child' ? 'block' : 'none'};">
                        <div class="form-group">
                            <label>Veli Ad Soyad *</label>
                            <input type="text" name="branches[${index}][parentName]" class="form-control" value="${parentName || ''}" list="parent-names-${index}" placeholder="Veli ismi giriniz (varsa listeden seçebilirsiniz)">
                            <datalist id="parent-names-${index}">
                                ${window.existingParentNames && window.existingParentNames.length > 0 
                                    ? window.existingParentNames.map(name => `<option value="${name}">${name}</option>`).join('')
                                    : ''}
                            </datalist>
                        </div>
                        
                        <div class="form-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <label style="margin: 0;">👶 Çocuklar</label>
                                <button type="button" class="btn btn-sm btn-success" onclick="addChildToBranch(${index})">+ Çocuk Ekle</button>
                            </div>
                            <div id="branch-children-${index}">
                                ${childrenHtml || '<p style="color: #999; font-size: 12px; text-align: center; padding: 10px;">Henüz çocuk eklenmedi</p>'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>📝 Açıklama</label>
                        <textarea name="branches[${index}][newNote]" class="form-control" rows="2" placeholder="Bu branş için açıklama...">${newNote || ''}</textarea>
                    </div>
                    
                    ${notesHistory && notesHistory.length > 0 ? `
                        <div class="form-group">
                            <label>📋 Geçmiş Açıklamalar</label>
                            <div style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: white;">
                                ${notesHistory.slice().reverse().map((note, reverseIndex) => {
                                    const noteIndex = notesHistory.length - 1 - reverseIndex;
                                    return `
                                    <div style="padding: 8px; margin-bottom: 8px; border-left: 3px solid var(--primary-color); background: #f9f9f9; position: relative;">
                                        <button type="button" onclick="deleteBranchNote(${index}, ${noteIndex})" style="position: absolute; top: 5px; right: 5px; background: #f44336; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 14px;">×</button>
                                        <div style="font-size: 11px; color: #666; margin-bottom: 4px;">👤 ${note.by} - ${note.date}</div>
                                        <div style="font-size: 12px; white-space: pre-wrap;">${note.text}</div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <input type="hidden" name="branches[${index}][notesHistory]" value='${notesHistory ? JSON.stringify(notesHistory) : '[]'}'>
                    <input type="hidden" name="branches[${index}][children]" value='${childrenArray.length > 0 ? JSON.stringify(childrenArray) : '[]'}'>
                </div>
            `;
        }
        
        // Branş alanı ekle
        window.addBranchField = function(branchData = null) {
            const index = branchFieldCounter++;
            const container = document.getElementById('branches-container');
            
            const branchHtml = generateBranchFieldHTML({
                index: index,
                branchId: branchData?.branchId,
                branchData: branchData,
                ageGroup: branchData?.ageGroup || 'adult',
                fullName: branchData?.fullName || '',
                parentName: branchData?.parentName || '',
                children: branchData?.children || [],
                selectedTag: branchData?.selectedTag || '',
                kayitOlabilirDate: branchData?.kayitOlabilirDate || '',
                denemeDate: branchData?.denemeDate || '',
                notesHistory: branchData?.notesHistory || [],
                newNote: branchData?.newNote || ''
            });
            
            container.insertAdjacentHTML('beforeend', branchHtml);
            
            // Etiket seçilmişse tarihleri göster
            if (branchData && branchData.selectedTag) {
                const select = document.querySelector(`[name="branches[${index}][selectedTag]"]`);
                if (select) {
                    handleBranchTagSelection(index, select);
                }
            }
        };
        
        // Branş etiket seçimi (Yetişkinler için)
        window.handleBranchTagSelection = function(index, selectElement) {
            const selectedTag = selectElement.value;
            const datesContainer = document.getElementById(`branch-adult-dates-${index}`);
            const kayitField = document.getElementById(`branch-adult-kayit-${index}`);
            const denemeField = document.getElementById(`branch-adult-deneme-${index}`);
            
            if (!datesContainer) return; // Çocuk branşı ise
            
            const kayitInput = kayitField?.querySelector('input[type="datetime-local"]');
            const denemeInput = denemeField?.querySelector('input[type="datetime-local"]');
            
            if (selectedTag === 'Kayıt Olabilir') {
                datesContainer.style.display = 'block';
                kayitField.style.display = 'block';
                denemeField.style.display = 'none';
                if (kayitInput) kayitInput.required = false;
                if (denemeInput) {
                    denemeInput.required = false;
                    // ✅ Deneme tarihi SİLİNMEYECEK - sadece gizlenecek (manuel kaldırma için korunacak)
                }
            } else if (selectedTag === 'Denemeye Gelecek') {
                datesContainer.style.display = 'block';
                kayitField.style.display = 'none';
                denemeField.style.display = 'block';
                if (denemeInput) denemeInput.required = false; // ✅ JavaScript validasyonu kullanılıyor, HTML required kaldırıldı
                if (kayitInput) {
                    kayitInput.required = false;
                    // ✅ Kayıt tarihi SİLİNMEYECEK - sadece gizlenecek
                }
            } else {
                datesContainer.style.display = 'none';
                kayitField.style.display = 'none';
                denemeField.style.display = 'none';
                if (kayitInput) {
                    kayitInput.required = false;
                    // ✅ Kayıt tarihi SİLİNMEYECEK - sadece gizlenecek
                }
                if (denemeInput) {
                    denemeInput.required = false;
                    // ✅ Deneme tarihi SİLİNMEYECEK - sadece gizlenecek (manuel kaldırma için korunacak)
                }
            }
        };
        
        // Branş yaş grubu değişimi
        window.handleBranchAgeGroupChange = function(branchIndex, selectElement) {
            const value = selectElement.value;
            const adultDiv = document.getElementById(`branch-adult-${branchIndex}`);
            const childDiv = document.getElementById(`branch-child-${branchIndex}`);
            const tagField = document.getElementById(`branch-tag-field-${branchIndex}`);
            const tagSelect = document.querySelector(`[name="branches[${branchIndex}][selectedTag]"]`);
            
            if (value === 'adult') {
                adultDiv.style.display = 'block';
                childDiv.style.display = 'none';
                if (tagField) tagField.style.display = 'block'; // Yetişkin için etiket göster
                if (tagSelect) tagSelect.required = true; // ✅ Etiket zorunlu
                // Adult zorunlu yap
                const fullNameInput = document.querySelector(`[name="branches[${branchIndex}][fullName]"]`);
                if (fullNameInput) fullNameInput.required = true;
                // Child opsiyonel yap
                const parentNameInput = document.querySelector(`[name="branches[${branchIndex}][parentName]"]`);
                if (parentNameInput) parentNameInput.required = false;
            } else if (value === 'child') {
                adultDiv.style.display = 'none';
                childDiv.style.display = 'block';
                if (tagField) tagField.style.display = 'none'; // Çocuk için etiket gizle
                if (tagSelect) {
                    tagSelect.required = false; // ✅ Etiket zorunlu değil
                    tagSelect.value = ''; // ✅ Değeri temizle
                }
                // Child zorunlu yap
                const parentNameInput = document.querySelector(`[name="branches[${branchIndex}][parentName]"]`);
                if (parentNameInput) parentNameInput.required = true;
                // Adult opsiyonel yap
                const fullNameInput = document.querySelector(`[name="branches[${branchIndex}][fullName]"]`);
                if (fullNameInput) fullNameInput.required = false;
            } else {
                adultDiv.style.display = 'none';
                childDiv.style.display = 'none';
                if (tagField) tagField.style.display = 'block';
                if (tagSelect) tagSelect.required = true; // ✅ Etiket zorunlu
            }
        };
        
        // Branşa çocuk ekle
        window.addChildToBranch = function(branchIndex) {
            const container = document.getElementById(`branch-children-${branchIndex}`);
            const childrenInput = document.querySelector(`[name="branches[${branchIndex}][children]"]`);
            const children = JSON.parse(childrenInput.value || '[]');
            
            const childIndex = children.length;
            children.push({ name: '', age: '', selectedTag: '', kayitOlabilirDate: '', denemeDate: '' });
            childrenInput.value = JSON.stringify(children);
            
            const nonBranchTags = crmTags
                .filter(tag => tag.category !== 'branch')
                .sort((a, b) => (a.order || 999) - (b.order || 999));
            
            const childHtml = `
                <div style="padding: 15px; background: white; border-radius: 8px; border: 2px solid #e0e0e0; margin-bottom: 10px; position: relative;" data-child-index="${childIndex}">
                    <button type="button" onclick="removeChildFromBranch(${branchIndex}, ${childIndex})" style="position: absolute; top: 10px; right: 10px; background: #f44336; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 16px; z-index: 10;">×</button>
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 11px; color: #666;">Çocuk Ad Soyad</label>
                            <input type="text" placeholder="Ad Soyad" class="form-control" onchange="updateChildData(${branchIndex}, ${childIndex}, 'name', this.value)">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 11px; color: #666;">Yaş</label>
                            <input type="number" placeholder="Yaş" class="form-control" min="1" max="18" onchange="updateChildData(${branchIndex}, ${childIndex}, 'age', this.value)">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-size: 11px; color: #666;">&#x1F3F7;&#xFE0F; Etiket</label>
                        <select class="form-control" onchange="updateChildData(${branchIndex}, ${childIndex}, 'selectedTag', this.value); handleChildTagSelection(${branchIndex}, ${childIndex}, this)">
                            <option value="">Etiket seçiniz...</option>
                            ${nonBranchTags.map(tag => `<option value="${tag.name}">${tag.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div id="child-${branchIndex}-${childIndex}-dates" style="display: none;">
                        <div id="child-${branchIndex}-${childIndex}-kayit" style="display: none; margin-bottom: 10px;">
                            <label style="font-size: 11px; color: #666;">&#x1F4C5; Kayıt Olabilir Tarihi</label>
                            <input type="datetime-local" class="form-control" onchange="updateChildData(${branchIndex}, ${childIndex}, 'kayitOlabilirDate', this.value)">
                        </div>
                        
                        <div id="child-${branchIndex}-${childIndex}-deneme" style="display: none; margin-bottom: 10px;">
                            <label style="font-size: 11px; color: #666;">&#x1F4C5; Deneme Dersi Tarihi</label>
                            <input type="datetime-local" class="form-control" onchange="updateChildData(${branchIndex}, ${childIndex}, 'denemeDate', this.value)">
                        </div>
                    </div>
                </div>
            `;
            
            if (container.querySelector('p')) {
                container.innerHTML = '';
            }
            container.insertAdjacentHTML('beforeend', childHtml);
        };
        
        // Çocuk verisini güncelle
        window.updateChildData = function(branchIndex, childIndex, field, value) {
            const childrenInput = document.querySelector(`[name="branches[${branchIndex}][children]"]`);
            const children = JSON.parse(childrenInput.value || '[]');
            if (children[childIndex]) {
                children[childIndex][field] = value;
                childrenInput.value = JSON.stringify(children);
            }
        };
        
        // Çocuğu branştan kaldır
        window.removeChildFromBranch = function(branchIndex, childIndex) {
            const childrenInput = document.querySelector(`[name="branches[${branchIndex}][children]"]`);
            const children = JSON.parse(childrenInput.value || '[]');
            children.splice(childIndex, 1);
            childrenInput.value = JSON.stringify(children);
            
            // UI'den kaldır
            const container = document.getElementById(`branch-children-${branchIndex}`);
            const childElements = container.querySelectorAll('[data-child-index]');
            childElements[childIndex]?.remove();
            
            // Eğer hiç çocuk kalmadıysa mesaj göster
            if (children.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 12px; text-align: center; padding: 10px;">Henüz çocuk eklenmedi</p>';
            }
        };
        
        // Branş alanını kaldır
        window.removeBranchField = function(index) {
            const field = document.getElementById(`branch-field-${index}`);
            if (field) {
                field.remove();
            }
        };
        
        // Branş not silme
        window.deleteBranchNote = function(branchIndex, noteIndex) {
            const notesInput = document.querySelector(`[name="branches[${branchIndex}][notesHistory]"]`);
            if (notesInput) {
                const notesHistory = JSON.parse(notesInput.value || '[]');
                notesHistory.splice(noteIndex, 1);
                notesInput.value = JSON.stringify(notesHistory);
                
                // Kartı yeniden render et
                const branchField = document.getElementById(`branch-field-${branchIndex}`);
                if (branchField) {
                    // Mevcut değerleri al
                    const branchId = document.querySelector(`[name="branches[${branchIndex}][branchId]"]`).value;
                    const selectedTag = document.querySelector(`[name="branches[${branchIndex}][selectedTag]"]`).value;
                    const kayitDate = document.querySelector(`[name="branches[${branchIndex}][kayitOlabilirDate]"]`)?.value;
                    const denemeDate = document.querySelector(`[name="branches[${branchIndex}][denemeDate]"]`)?.value;
                    const newNote = document.querySelector(`[name="branches[${branchIndex}][newNote]"]`).value;
                    
                    // Kartı kaldır
                    branchField.remove();
                    
                    // Yeni kart ekle
                    branchFieldCounter--;
                    addBranchField({
                        branchId,
                        selectedTag,
                        kayitOlabilirDate: kayitDate,
                        denemeDate: denemeDate,
                        newNote,
                        notesHistory
                    });
                }
            }
        };
        
        
        // Her çocuk için etiket seçimi
        window.handleChildTagSelection = function(branchIndex, childIndex, selectElement) {
            const selectedTag = selectElement.value;
            const datesContainer = document.getElementById(`child-${branchIndex}-${childIndex}-dates`);
            const kayitField = document.getElementById(`child-${branchIndex}-${childIndex}-kayit`);
            const denemeField = document.getElementById(`child-${branchIndex}-${childIndex}-deneme`);
            
            // Tarih inputlarını bul
            const kayitInput = kayitField?.querySelector('input[type="datetime-local"]');
            const denemeInput = denemeField?.querySelector('input[type="datetime-local"]');
            
            if (selectedTag === 'Kayıt Olabilir') {
                datesContainer.style.display = 'block';
                kayitField.style.display = 'block';
                denemeField.style.display = 'none';
                if (kayitInput) kayitInput.required = false;
                if (denemeInput) {
                    denemeInput.required = false;
                    // ✅ Deneme tarihi SİLİNMEYECEK - sadece gizlenecek (manuel kaldırma için korunacak)
                }
            } else if (selectedTag === 'Denemeye Gelecek') {
                datesContainer.style.display = 'block';
                kayitField.style.display = 'none';
                denemeField.style.display = 'block';
                if (denemeInput) denemeInput.required = false; // ✅ JavaScript validasyonu kullanılıyor, HTML required kaldırıldı
                if (kayitInput) {
                    kayitInput.required = false;
                    // ✅ Kayıt tarihi SİLİNMEYECEK - sadece gizlenecek
                }
            } else {
                if (datesContainer) datesContainer.style.display = 'none';
                if (kayitField) kayitField.style.display = 'none';
                if (denemeField) denemeField.style.display = 'none';
                if (kayitInput) kayitInput.required = false;
                if (denemeInput) denemeInput.required = false;
                // ✅ Tarihler SİLİNMEYECEK - sadece gizlenecek (manuel kaldırma için korunacak)
            }
        };
        
        // Yaş grubu değiştiğinde alanları göster/gizle
        window.handleAgeGroupChange = function(selectElement) {
            const value = selectElement.value;
            const childFields = document.getElementById('child-fields');
            const adultFields = document.getElementById('adult-fields');
            
            if (value === 'child') {
                childFields.style.display = 'block';
                adultFields.style.display = 'none';
                // Sadece veli ismi zorunlu
                childFields.querySelectorAll('input').forEach(input => {
                    if (input.name === 'parentName') {
                        input.required = true;
                    } else {
                        input.required = false;
                    }
                });
                adultFields.querySelectorAll('input').forEach(input => input.required = false);
            } else if (value === 'adult') {
                childFields.style.display = 'none';
                adultFields.style.display = 'block';
                // Yetişkin ismi zorunlu
                adultFields.querySelectorAll('input').forEach(input => input.required = true);
                childFields.querySelectorAll('input').forEach(input => input.required = false);
            } else {
                childFields.style.display = 'none';
                adultFields.style.display = 'none';
            }
        };
        
        // Tek etiket seçimi değiştiğinde tarih alanlarını göster/gizle
        window.handleSingleTagSelection = function(selectElement) {
            const selectedTag = selectElement.value;
            
            const tagDateFields = document.getElementById('tag-date-fields');
            const kayitOlabilirField = document.getElementById('kayit-olabilir-date');
            const denemeField = document.getElementById('denemeye-gelecek-date');
            
            // Kayıt Olabilir seçildi mi?
            if (selectedTag === 'Kayıt Olabilir') {
                kayitOlabilirField.style.display = 'block';
                denemeField.style.display = 'none';
                tagDateFields.style.display = 'block';
            } else if (selectedTag === 'Denemeye Gelecek') {
                denemeField.style.display = 'block';
                kayitOlabilirField.style.display = 'none';
                tagDateFields.style.display = 'block';
            } else {
                kayitOlabilirField.style.display = 'none';
                denemeField.style.display = 'none';
                tagDateFields.style.display = 'none';
            }
        };
        
        // Eski handleTagSelection fonksiyonu - artık kullanılmıyor ama uyumluluk için bırakıyoruz
        window.handleTagSelection = function(selectElement) {
            const selectedTags = Array.from(selectElement.selectedOptions).map(o => o.value);
            
            const tagDateFields = document.getElementById('tag-date-fields');
            const kayitOlabilirField = document.getElementById('kayit-olabilir-date');
            const denemeField = document.getElementById('denemeye-gelecek-date');
            
            // Kayıt Olabilir seçildi mi?
            if (selectedTags.includes('Kayıt Olabilir')) {
                kayitOlabilirField.style.display = 'block';
                tagDateFields.style.display = 'block';
            } else {
                kayitOlabilirField.style.display = 'none';
            }
            
            // Denemeye Gelecek seçildi mi?
            if (selectedTags.includes('Denemeye Gelecek')) {
                denemeField.style.display = 'block';
                tagDateFields.style.display = 'block';
            } else {
                denemeField.style.display = 'none';
            }
            
            // Hiçbiri seçili değilse gizle
            if (!selectedTags.includes('Kayıt Olabilir') && !selectedTags.includes('Denemeye Gelecek')) {
                tagDateFields.style.display = 'none';
            }
        };
    
        // Telefon numarası kontrolü
        let phoneCheckTimeout;
        let lastCheckedPhone = '';
        window.checkExistingPhone = function(phone) {
            clearTimeout(phoneCheckTimeout);
            const messageDiv = document.getElementById('phone-check-message');
            const form = document.getElementById('addLeadForm');
            
            // Telefon numarası değiştiğinde ve daha önce bir müşteri yüklendiyse formu temizle
            if (lastCheckedPhone && phone && lastCheckedPhone !== phone && form.dataset.leadId) {
                // Formu sıfırla
                clearAddLeadForm();
                messageDiv.innerHTML = '';
                lastCheckedPhone = '';
            }
            
            if (!phone || phone.length < 10) {
                messageDiv.innerHTML = '';
                return;
            }
            
            phoneCheckTimeout = setTimeout(() => {
                const existingLead = crmLeads.find(l => phonesMatch(l.phone, phone));
                
                if (existingLead) {
                    // Mevcut müşteri bulundu
                    const branchNames = existingLead.branches?.map(b => {
                        const branch = branches.find(br => br.id === b.branchId);
                        return branch ? branch.name : 'Yok';
                    }).join(', ') || 'Yok';
                    
                    // Mevcut veli isimlerini topla
                    const parentNames = new Set();
                    if (existingLead.branches && existingLead.branches.length > 0) {
                        existingLead.branches.forEach(branch => {
                            if (branch.ageGroup === 'child' && branch.parentName) {
                                parentNames.add(branch.parentName);
                            }
                        });
                    }
                    window.existingParentNames = Array.from(parentNames);
                    
                    let displayName = 'Müşteri';
                    if (existingLead.branches && existingLead.branches.length > 0) {
                        const firstBranch = existingLead.branches[0];
                        if (firstBranch.ageGroup === 'adult') {
                            displayName = firstBranch.fullName || 'Müşteri';
                        } else {
                            displayName = firstBranch.parentName || 'Veli';
                        }
                    }
                    
                    messageDiv.innerHTML = `<span style="color: #2196F3;">✅ Mevcut müşteri: <strong>${displayName}</strong> (${branchNames}). Yeni branş ekleyebilirsiniz.</span>`;
                    
                    // Mevcut müşterinin bilgilerini yükle
                    form.dataset.leadId = existingLead.id;
                    form.elements['source'].value = existingLead.source || 'other';
                    
                    // Sekmeli yapı oluştur
                    branchFieldCounter = 0;
                    const mainContainer = document.getElementById('branches-container');
                    mainContainer.innerHTML = '';
                    
                    if (existingLead.branches && existingLead.branches.length > 0) {
                        // Sekmeli yapı oluştur
                        let tabsHtml = '<div class="customer-tabs" style="margin-bottom: 15px;">';
                        let tabContentsHtml = '<div id="edit-tabs-content">';
                        
                        existingLead.branches.forEach((branch, index) => {
                            const branchObj = branches.find(b => b.id === branch.branchId);
                            const baseBranchName = branchObj ? `${branchObj.icon} ${branchObj.name}` : 'Branş';
                            const ageGroupPrefix = branch.ageGroup === 'child' ? '👶 ÇOCUK - ' : 
                                                   branch.ageGroup === 'adult' ? '👨 YETİŞKİN - ' : '';
                            const branchName = ageGroupPrefix + baseBranchName;
                            
                            // Sekme başlığı
                            tabsHtml += `
                                <button type="button" class="tab-button ${index === 0 ? 'active' : ''}" onclick="switchEditTab(${index})">
                                    ${branchName}
                                </button>
                            `;
                            
                            // formatDate fonksiyonu
                            const formatDate = (dateStr) => {
                                if (!dateStr) return '';
                                const d = new Date(dateStr);
                                if (isNaN(d.getTime())) return '';
                                const y = d.getFullYear();
                                const m = String(d.getMonth() + 1).padStart(2, '0');
                                const day = String(d.getDate()).padStart(2, '0');
                                const h = String(d.getHours()).padStart(2, '0');
                                const min = String(d.getMinutes()).padStart(2, '0');
                                return y + '-' + m + '-' + day + 'T' + h + ':' + min;
                            };
                            
                            // Bu branş için içeriği oluştur
                            const branchFieldHtml = generateBranchFieldHTML({
                                index: index,
                                branchId: branch.branchId,
                                branchData: branch,
                                ageGroup: branch.ageGroup || 'adult',
                                fullName: branch.fullName || '',
                                parentName: branch.parentName || '',
                                children: branch.children || [],
                                selectedTag: branch.selectedTag || '',
                                kayitOlabilirDate: formatDate(branch.kayitOlabilirDate),
                                denemeDate: formatDate(branch.denemeDate),
                                notesHistory: branch.notesHistory || [],
                                newNote: ''
                            });
                            
                            // Sekme içeriği
                            tabContentsHtml += `
                                <div class="tab-content ${index === 0 ? 'active' : ''}" id="edit-tab-${index}" style="display: ${index === 0 ? 'block' : 'none'};">
                                    ${branchFieldHtml}
                                </div>
                            `;
                        });
                        
                        // Yeni branş ekleme sekmesi
                        const newIndex = existingLead.branches.length;
                        tabsHtml += `
                            <button type="button" class="tab-button" onclick="switchEditTab(${newIndex})" style="background: #4CAF50; color: white;">
                                ➕ Yeni Branş
                            </button>
                        `;
                        
                        // ✅ Yeni branş formu için tab content ekle
                        const newBranchFormHtml = generateBranchFieldHTML({
                            index: newIndex,
                            branchId: '',
                            ageGroup: '',
                            selectedTag: '',
                            fullName: '',
                            parentName: '',
                            newNote: '',
                            notesHistory: [],
                            childrenArray: [],
                            kayitOlabilirDate: '',
                            denemeDate: ''
                        });
                        
                        tabContentsHtml += `
                            <div class="tab-content" id="edit-tab-${newIndex}" style="display: none;">
                                ${newBranchFormHtml}
                            </div>
                        `;
                        
                        tabsHtml += '</div>';
                        tabContentsHtml += '</div>';
                        
                        mainContainer.innerHTML = tabsHtml + tabContentsHtml;
                        
                        // Her branş için event handler'ları ayarla
                        existingLead.branches.forEach((branch, index) => {
                            const ageGroupSelect = document.querySelector(`#edit-tab-${index} [name="branches[${index}][ageGroup]"]`);
                            if (ageGroupSelect && branch.ageGroup) {
                                handleBranchAgeGroupChange(index, ageGroupSelect);
                            }
                            
                            const tagSelect = document.querySelector(`#edit-tab-${index} [name="branches[${index}][selectedTag]"]`);
                            if (tagSelect && branch.selectedTag) {
                                handleBranchTagSelection(index, tagSelect);
                            }
                        });
                        
                        // ✅ İlk sekmeyi aktif et ve required alanları enable et
                        setTimeout(() => {
                            switchEditTab(0);
                        }, 100);
                    } else {
                        // Hiç branş yoksa tek branş ekle
                        addBranchField();
                    }
                    
                    document.querySelector('#addLeadModal h3').textContent = `✏️ ${displayName} - Branş Ekle/Düzenle`;
                    
                    // Son kontrol edilen telefonu kaydet
                    lastCheckedPhone = phone;
                } else {
                    // Yeni müşteri
                    messageDiv.innerHTML = '<span style="color: #4CAF50;">✅ Yeni müşteri kaydı</span>';
                    form.removeAttribute('data-lead-id');
                    document.querySelector('#addLeadModal h3').textContent = '➕ Yeni Potansiyel Müşteri';
                    
                    // Son kontrol edilen telefonu kaydet
                    lastCheckedPhone = phone;
                }
            }, 500);
        };
        
        // Form temizleme fonksiyonu
        function clearAddLeadForm() {
            const form = document.getElementById('addLeadForm');
            if (!form) return;
            
            // leadId'yi temizle
            form.removeAttribute('data-lead-id');
            
            // Telefon hariç formu resetle (telefon inputu değişmemeli)
            const phoneInput = form.querySelector('input[name="phone"]');
            const phoneValue = phoneInput ? phoneInput.value : '';
            
            // Kaynağı varsayılana çek
            const sourceSelect = form.querySelector('select[name="source"]');
            if (sourceSelect) sourceSelect.value = 'other';
            
            // Branş container'ı temizle ve yeni bir tane ekle
            const branchesContainer = document.getElementById('branches-container');
            if (branchesContainer) {
                branchesContainer.innerHTML = '';
                branchFieldCounter = 0;
                addBranchField();
            }
            
            // Telefon değerini geri yaz
            if (phoneInput) phoneInput.value = phoneValue;
            
            // Modal başlığını güncelle
            document.querySelector('#addLeadModal h3').textContent = '➕ Yeni Potansiyel Müşteri';
            
            // Global değişkenleri temizle
            window.existingParentNames = [];
            lastCheckedPhone = '';
        }
        
        // Lead Modal Aç
        function openAddLeadModal() {
            const modal = document.getElementById('addLeadModal');
            if (!modal) {
                console.error('❌ addLeadModal bulunamadı!');
                return;
            }
            
            const form = document.getElementById('addLeadForm');
            form.reset();
            form.removeAttribute('data-lead-id');
            
            // Submit butonunu resetle
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '💾 Kaydet';
            }
            
            // Mesajı temizle
            document.getElementById('phone-check-message').innerHTML = '';
            
            // Branş container'ı temizle
            document.getElementById('branches-container').innerHTML = '';
            branchFieldCounter = 0;
            
            // Otomatik ilk branş ekle
            addBranchField();
            
            // Branş ekleme butonunu göster (yeni müşteri modunda)
            const addBranchBtn = document.querySelector('#addLeadModal .btn-success[onclick*="addBranchField"]');
            if (addBranchBtn) addBranchBtn.style.display = 'inline-block';
            
            // lastCheckedPhone'u sıfırla
            lastCheckedPhone = '';
            
            document.querySelector('#addLeadModal h3').textContent = '➕ Yeni Potansiyel Müşteri';
            openModal('addLeadModal');
        }
        
        // Lead Düzenle
        function editLead(leadId, openBranchIndex = 0) {
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) {
                console.error('Lead bulunamadı:', leadId);
                return;
            }
            
            const modal = document.getElementById('addLeadModal');
            const form = document.getElementById('addLeadForm');
            
            form.elements['phone'].value = lead.phone || '';
            form.elements['source'].value = lead.source || 'other';
            
            const formatDate = (date) => {
                if (!date) return '';
                const d = new Date(date);
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const h = String(d.getHours()).padStart(2, '0');
                const min = String(d.getMinutes()).padStart(2, '0');
                return `${y}-${m}-${day}T${h}:${min}`;
            };
            
            // Sekmeli yapı oluştur
            branchFieldCounter = 0;
            
            // Önce container'ı temizle
            const mainContainer = document.getElementById('branches-container');
            mainContainer.innerHTML = '';
            
            if (lead.branches && lead.branches.length > 0) {
                // Sekmeli yapı oluştur
                let tabsHtml = '<div class="customer-tabs" style="margin-bottom: 15px;">';
                let tabContentsHtml = '<div id="edit-tabs-content">';
                
                lead.branches.forEach((branch, index) => {
                    const branchObj = branches.find(b => b.id === branch.branchId);
                    const baseBranchName = branchObj ? `${branchObj.icon} ${branchObj.name}` : 'Branş';
                    const ageGroupPrefix = branch.ageGroup === 'child' ? '👶 ÇOCUK - ' : 
                                           branch.ageGroup === 'adult' ? '👨 YETİŞKİN - ' : '';
                    const branchName = ageGroupPrefix + baseBranchName;
                    
                    // Sekme başlığı - openBranchIndex'e göre aktif sekmeyi belirle
                    tabsHtml += `
                        <button type="button" class="tab-button ${index === openBranchIndex ? 'active' : ''}" onclick="switchEditTab(${index})">
                            ${branchName}
                        </button>
                    `;
                    
                    // Bu branş için ayrı field container oluştur
                    const tempContainer = document.createElement('div');
                    tempContainer.id = 'temp-branch-container';
                    
                    // addBranchField ile içeriği oluştur
                    const branchFieldHtml = generateBranchFieldHTML({
                        index: index,
                        branchId: branch.branchId,
                        branchData: branch,
                        ageGroup: branch.ageGroup || 'adult',
                        fullName: branch.fullName || '',
                        parentName: branch.parentName || '',
                        children: branch.children || [],
                        selectedTag: branch.selectedTag || '',
                        kayitOlabilirDate: formatDate(branch.kayitOlabilirDate),
                        denemeDate: formatDate(branch.denemeDate),
                        notesHistory: branch.notesHistory || [],
                        newNote: ''
                    });
                    
                    // Sekme içeriği - openBranchIndex'e göre göster
                    tabContentsHtml += `
                        <div class="tab-content ${index === openBranchIndex ? 'active' : ''}" id="edit-tab-${index}" style="display: ${index === openBranchIndex ? 'block' : 'none'};">
                            ${branchFieldHtml}
                        </div>
                    `;
                });
                
                tabsHtml += '</div>';
                tabContentsHtml += '</div>';
                
                mainContainer.innerHTML = tabsHtml + tabContentsHtml;
                
                // Her branş için event handler'ları ayarla
                lead.branches.forEach((branch, index) => {
                    const ageGroupSelect = document.querySelector(`#edit-tab-${index} [name="branches[${index}][ageGroup]"]`);
                    if (ageGroupSelect && branch.ageGroup) {
                        handleBranchAgeGroupChange(index, ageGroupSelect);
                    }
                    
                    const tagSelect = document.querySelector(`#edit-tab-${index} [name="branches[${index}][selectedTag]"]`);
                    if (tagSelect && branch.selectedTag) {
                        handleBranchTagSelection(index, tagSelect);
                    }
                });
                
                // ✅ Açılacak sekmeyi aktif et ve required alanları doğru şekilde enable/disable et
                setTimeout(() => {
                    switchEditTab(openBranchIndex);
                }, 100);
            }
            
            form.dataset.leadId = leadId;
            
            let displayName = lead.fullName || 'Müşteri';
            if (lead.branches && lead.branches.length > 0) {
                const firstBranch = lead.branches[0];
                if (firstBranch.ageGroup === 'adult') {
                    displayName = firstBranch.fullName || lead.fullName || 'Müşteri';
                } else {
                    displayName = firstBranch.parentName || lead.fullName || 'Veli';
                }
            }
            
            // Branş ekleme butonunu gizle (düzenleme modunda)
            const addBranchBtn = document.querySelector('#addLeadModal .btn-success[onclick*="addBranchField"]');
            if (addBranchBtn) addBranchBtn.style.display = 'none';
            
            // Submit butonunu resetle
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '💾 Kaydet';
            }
            
            document.querySelector('#addLeadModal h3').textContent = `✏️ ${displayName} - Düzenle`;
            openModal('addLeadModal');
        }
        
        // WhatsApp'tan CRM lead detayını aç
        window.openCrmLeadDetail = function(leadId) {
            // ✅ Sayfayı değiştirmeden modal'ı aç
            editLead(leadId, 0);
        }
        
        // Düzenleme sekmelerini değiştir
        window.switchEditTab = function(tabIndex) {
            // Tüm butonlardan active kaldır
            document.querySelectorAll('#addLeadModal .tab-button').forEach(btn => btn.classList.remove('active'));
            
            // Tüm içerikleri gizle ve required attribute'ü disable et
            document.querySelectorAll('#edit-tabs-content .tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
                
                // ✅ Gizli sekmelerdeki required alanları disable et
                content.querySelectorAll('[required]').forEach(input => {
                    input.disabled = true;
                });
            });
            
            const tabs = document.querySelectorAll('#addLeadModal .tab-button');
            const contents = document.querySelectorAll('#edit-tabs-content .tab-content');
            
            // Seçili sekmeyi aktif yap
            if (tabs[tabIndex]) tabs[tabIndex].classList.add('active');
            if (contents[tabIndex]) {
                contents[tabIndex].classList.add('active');
                contents[tabIndex].style.display = 'block';
                
                // ✅ Aktif sekmedeki required alanları enable et
                contents[tabIndex].querySelectorAll('[required]').forEach(input => {
                    input.disabled = false;
                });
            }
        };
        
        // CRM müşteriyi sil
        window.deleteCRMLead = async function(leadId) {
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) {
                showAlert('❌ Müşteri bulunamadı', 'danger');
                return;
            }
            
            if (!confirm(`"${lead.fullName}" isimli müşteriyi silmek istediğinize emin misiniz?\n\nBu işlem geri alınamaz!`)) {
                return;
            }
            
            try {
                await window.firebase.deleteDoc(
                    window.firebase.doc(window.db, 'crmLeads', leadId)
                );
                
                // Önce global diziden sil (anında UI güncellemesi için)
                const leadIndex = crmLeads.findIndex(l => l.id === leadId);
                if (leadIndex !== -1) {
                    crmLeads.splice(leadIndex, 1);
                }
                
                // Modal'ı hemen kapat
                closeModal('customerDetailModal');
                
                showAlert('✅ Müşteri başarıyla silindi', 'success');
                
                // CRM listesini hemen yenile (refresh beklemeden)
                renderCRMLeads();
                renderCRMDashboard();
                renderCurrentSection();
                
                // Arka planda full data reload (senkronizasyon için)
                loadData().catch(err => console.error('Background loadData error:', err));
            } catch (error) {
                console.error('Müşteri silme hatası:', error);
                showAlert('❌ Müşteri silinemedi: ' + error.message, 'danger');
            }
        };
        
        // Müşteri detay sayfasını aç
        window.openCustomerDetail = function(leadId, openBranchIndex = 0) {
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) return;
            
            // Sekmeler ve içerikler
            let tabsHtml = '';
            let tabContentsHtml = '';
            
            if (lead.branches && lead.branches.length > 0) {
                lead.branches.forEach((branchData, index) => {
                    const branch = branches.find(b => b.id === branchData.branchId);
                    const baseBranchName = branch ? `${branch.icon} ${branch.name}` : 'Bilinmeyen Branş';
                    
                    // Yaş grubu etiketi ekle
                    const ageGroupPrefix = branchData.ageGroup === 'child' ? '👶 ÇOCUK - ' : 
                                           branchData.ageGroup === 'adult' ? '👨 YETİŞKİN - ' : '';
                    const branchName = ageGroupPrefix + baseBranchName;
                    const selectedTag = branchData.selectedTag || 'Yok';
                    
                    // Sekme başlığı - açılacak sekmeyi belirle
                    tabsHtml += `
                        <button class="tab-button ${index === openBranchIndex ? 'active' : ''}" onclick="switchCustomerTab(${index})">
                            ${branchName}
                        </button>
                    `;
                    
                    // Not geçmişi - En yeni açıklamalar en üstte
                    const notesHistory = branchData.notesHistory || [];
                    const notesHtml = notesHistory.length > 0 ? notesHistory.slice().reverse().map((note, noteIndex) => `
                        <div style="padding: 10px; margin-bottom: 10px; border-left: 3px solid var(--primary-color); background: white; border-radius: 6px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">
                                👤 ${note.by} - ${note.date}
                            </div>
                            <div style="font-size: 13px; white-space: pre-wrap;">${note.text}</div>
                        </div>
                    `).join('') : '<p style="color: #999; font-size: 13px; text-align: center; padding: 20px;">Henüz açıklama yok</p>';
                    
                    // Yaş grubu ve isim bilgileri
                    let ageGroupInfo = '';
                    if (branchData.ageGroup === 'child') {
                        ageGroupInfo = `
                            <div class="branch-info-item">
                                <strong>👶 Yaş Grubu</strong>
                                <span>Çocuk</span>
                            </div>
                            <div class="branch-info-item">
                                <strong>👨 Veli</strong>
                                <span>${branchData.parentName || 'Belirtilmemiş'}</span>
                            </div>
                        `;
                        
                        if (branchData.children && branchData.children.length > 0) {
                            // Her çocuk için ayrı kartlar
                            ageGroupInfo += `
                                <div class="branch-info-item" style="grid-column: 1 / -1;">
                                    <strong>👶 Çocuklar</strong>
                                    <div style="margin-top: 12px; display: grid; gap: 12px;">
                                        ${branchData.children.map((child, childIdx) => `
                                            <div style="background: white; padding: 15px; border-radius: 12px; border: 2px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                                    <div>
                                                        <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 4px;">${child.name}</div>
                                                        <div style="font-size: 13px; color: #666;">🎂 ${child.age} yaş</div>
                                                    </div>
                                                    ${child.selectedTag ? `
                                                        <span style="background: #667eea; color: white; padding: 6px 12px; border-radius: 16px; font-size: 11px;">
                                                            🏷️ ${child.selectedTag}
                                                        </span>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }
                    } else if (branchData.ageGroup === 'adult') {
                        ageGroupInfo = `
                            <div class="branch-info-item">
                                <strong>👨 Yaş Grubu</strong>
                                <span>Yetişkin</span>
                            </div>
                            <div class="branch-info-item">
                                <strong>📝 Ad Soyad</strong>
                                <span>${branchData.fullName || 'Belirtilmemiş'}</span>
                            </div>
                        `;
                    }
                    
                    // Sekme içeriği - openBranchIndex parametresine göre göster
                    tabContentsHtml += `
                        <div class="tab-content ${index === openBranchIndex ? 'active' : ''}" id="tab-${index}" style="display: ${index === openBranchIndex ? 'block' : 'none'};">
                            <div class="branch-tab-content">
                                <div class="branch-info-grid">
                                    ${ageGroupInfo}
                                    ${branchData.ageGroup === 'adult' ? `
                                        <div class="branch-info-item">
                                            <strong>🏷️ Etiket</strong>
                                            <span style="color: var(--primary-color);">${selectedTag}</span>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <div style="margin-top: 20px;">
                                    <h4 style="font-size: 14px; color: #666; margin-bottom: 12px;">📋 Açıklama Geçmişi</h4>
                                    <div style="max-height: 300px; overflow-y: auto;">
                                        ${notesHtml}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                tabsHtml = '';
                tabContentsHtml = '';
            }
            
            // Görüşme kayıtları sekmesi ekle (Bulutfon aktifse)
            let callRecordsTabIndex = lead.branches ? lead.branches.length : 0;
            let historyTabIndex = callRecordsTabIndex;
            let newBranchIndex = callRecordsTabIndex;
            
            if (clubSettings && clubSettings.bulutfonEnabled) {
                tabsHtml += `
                    <button class="tab-button" onclick="switchCustomerTab(${callRecordsTabIndex}); loadCallRecordsTab('${leadId}', 'tab-calls-${callRecordsTabIndex}')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        📞 Görüşme Kayıtları
                    </button>
                `;
                
                tabContentsHtml += `
                    <div class="tab-content" id="tab-calls-${callRecordsTabIndex}" style="display: none;">
                        <div class="branch-tab-content">
                            <h4 style="font-size: 16px; color: #666; margin-bottom: 15px;">📞 Görüşme Kayıtları</h4>
                            <div id="callRecords-${leadId}">
                                <div class="loading"><div class="spinner"></div><span>Yükleniyor...</span></div>
                            </div>
                        </div>
                    </div>
                `;
                
                historyTabIndex = callRecordsTabIndex + 1;
                newBranchIndex = historyTabIndex + 1;
            } else {
                historyTabIndex = callRecordsTabIndex;
                newBranchIndex = historyTabIndex + 1;
            }
            
            // History sekmesi ekle
            tabsHtml += `
                <button class="tab-button" onclick="switchCustomerTab(${historyTabIndex})" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                    📜 Geçmiş
                </button>
            `;
            
            const historyHtml = (lead.history && lead.history.length > 0) 
                ? lead.history.slice().reverse().map((entry, index) => `
                    <div style="padding: 12px; margin-bottom: 10px; border-left: 4px solid #f5576c; background: white; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size: 11px; color: #666; margin-bottom: 5px;">
                            👤 ${entry.by} - ${entry.date}
                        </div>
                        <div style="font-size: 13px; color: #333; font-weight: 500;">${entry.details}</div>
                    </div>
                `).join('')
                : '<p style="color: #999; font-size: 13px; text-align: center; padding: 20px;">Henüz geçmiş kaydı yok</p>';
            
            tabContentsHtml += `
                <div class="tab-content" id="tab-history-${historyTabIndex}" style="display: none;">
                    <div class="branch-tab-content">
                        <h4 style="font-size: 16px; color: #666; margin-bottom: 15px;">📜 Müşteri Geçmişi</h4>
                        <div style="max-height: 500px; overflow-y: auto;">
                            ${historyHtml}
                        </div>
                    </div>
                </div>
            `;
            
            // Yeni branş ekleme sekmesi ve içeriği
            tabsHtml += `
                <button class="tab-button" onclick="switchCustomerTab(${newBranchIndex})" style="background: #4CAF50; color: white; font-weight: bold;">
                    ➕ Yeni Branş
                </button>
            `;
            
            // Yeni branş ekleme formu
            const nonBranchTags = crmTags
                .filter(tag => tag.category !== 'branch')
                .sort((a, b) => (a.order || 999) - (b.order || 999));
            
            tabContentsHtml += `
                <div class="tab-content" id="tab-${newBranchIndex}" style="display: none;">
                    <div class="branch-tab-content">
                        <h4 style="font-size: 16px; color: #666; margin-bottom: 15px;">➕ Yeni Branş Ekle</h4>
                        <form id="addNewBranchForm" onsubmit="handleAddNewBranch(event, '${lead.id}'); return false;">
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                                <div class="form-group">
                                    <label>Branş *</label>
                                    <select name="branchId" class="form-control" required>
                                        <option value="">Seçiniz...</option>
                                        ${branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Yaş Grubu *</label>
                                    <select name="ageGroup" class="form-control" required onchange="handleNewBranchAgeGroupChange(this)">
                                        <option value="">Seçiniz...</option>
                                        <option value="adult">👨 Yetişkin</option>
                                        <option value="child">👶 Çocuk</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Yetişkin için -->
                            <div id="new-branch-adult" style="display: none;">
                                <div class="form-group">
                                    <label>Ad Soyad *</label>
                                    <input type="text" name="fullName" class="form-control" placeholder="Ad Soyad">
                                </div>
                                <div class="form-group">
                                    <label>🏷️ Etiket</label>
                                    <select name="selectedTag" class="form-control" onchange="handleNewBranchTagChange(this)">
                                        <option value="">Etiket seçiniz...</option>
                                        ${nonBranchTags.map(tag => `<option value="${tag.name}">${tag.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div id="new-branch-adult-dates" style="display: none;">
                                    <div id="new-branch-adult-kayit" style="display: none;">
                                        <label>&#x1F4C5; Kayıt Olabilir Tarihi</label>
                                        <input type="datetime-local" name="kayitOlabilirDate" class="form-control">
                                    </div>
                                    <div id="new-branch-adult-deneme" style="display: none;">
                                        <label>&#x1F4C5; Deneme Dersi Tarihi</label>
                                        <input type="datetime-local" name="denemeDate" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Çocuk için -->
                            <div id="new-branch-child" style="display: none;">
                                <div class="form-group">
                                    <label>Veli Ad Soyad *</label>
                                    <input type="text" name="parentName" class="form-control" placeholder="Veli ismi" value="${lead.branches && lead.branches.length > 0 && lead.branches[0].parentName ? lead.branches[0].parentName : ''}">
                                </div>
                                <div class="form-group">
                                    <label>Çocuk Ad Soyad</label>
                                    <input type="text" name="childName" class="form-control" placeholder="Çocuk ismi">
                                </div>
                                <div class="form-group">
                                    <label>Çocuk Yaş</label>
                                    <input type="number" name="childAge" class="form-control" placeholder="Yaş" min="1" max="18">
                                </div>
                                <div class="form-group">
                                    <label>🏷️ Etiket</label>
                                    <select name="childTag" class="form-control" onchange="handleNewChildTagChange(this)">
                                        <option value="">Etiket seçiniz...</option>
                                        ${nonBranchTags.map(tag => `<option value="${tag.name}">${tag.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div id="new-branch-child-dates" style="display: none;">
                                    <div id="new-branch-child-kayit" style="display: none;">
                                        <label>&#x1F4C5; Kayıt Olabilir Tarihi</label>
                                        <input type="datetime-local" name="childKayitDate" class="form-control">
                                    </div>
                                    <div id="new-branch-child-deneme" style="display: none;">
                                        <label>&#x1F4C5; Deneme Dersi Tarihi</label>
                                        <input type="datetime-local" name="childDenemeDate" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>📝 Açıklama</label>
                                <textarea name="newNote" class="form-control" rows="3" placeholder="Branş hakkında not..."></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="width: 100%;">💾 Branşı Kaydet</button>
                        </form>
                    </div>
                </div>
            `;
            
            const html = `
                <div id="customerDetailModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <span class="close" onclick="closeModal('customerDetailModal')">&times;</span>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">👤 ${lead.fullName}</h3>
                            <button class="btn btn-danger btn-sm" onclick="deleteCRMLead('${lead.id}')" style="padding: 6px 12px;">
                                🗑️ Müşteriyi Sil
                            </button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">📞 Telefon</div>
                                <div style="font-size: 18px; font-weight: bold;">${lead.phone}</div>
                            </div>
                            ${(() => {
                                const memberMatch = members.find(m => phonesMatch(m.Telefon, lead.phone) || phonesMatch(m.Telefon_2, lead.phone));
                                if (memberMatch) {
                                    return `
                                        <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); padding: 15px; border-radius: 10px; color: white; text-align: center; cursor: pointer;" onclick="showMemberAttendancePage('${memberMatch.id}')" title="Üye sayfasına git">
                                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">✅ Üyelik Durumu</div>
                                            <div style="font-size: 18px; font-weight: bold;">ÜYE</div>
                                        </div>
                                    `;
                                } else {
                                    return `
                                        <div style="background: linear-gradient(135deg, #999 0%, #777 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">❌ Üyelik Durumu</div>
                                            <div style="font-size: 18px; font-weight: bold;">ÜYE DEĞİL</div>
                                        </div>
                                    `;
                                }
                            })()}
                            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">🎯 Branş Sayısı</div>
                                <div style="font-size: 18px; font-weight: bold;">${lead.branches ? lead.branches.length : 0}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">📍 Kaynak</div>
                                <div style="font-size: 16px; font-weight: bold;">${getSourceName(lead.source || 'other')}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">📅 Oluşturma</div>
                                <div style="font-size: 16px; font-weight: bold;">${lead.createdAt ? new Date(lead.createdAt).toLocaleDateString('tr-TR') : '-'}</div>
                            </div>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <h4 style="font-size: 16px; color: #666; margin-bottom: 10px;">🎯 Branşlar ve Bilgiler</h4>
                            <div class="customer-tabs">
                                ${tabsHtml}
                            </div>
                            ${tabContentsHtml}
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
                            <button class="btn btn-primary" onclick="closeModal('customerDetailModal'); editLead('${lead.id}', ${openBranchIndex})">✏️ Düzenle</button>
                            <button class="btn btn-success" onclick="closeModal('customerDetailModal'); openWhatsAppWithLead('${lead.id}')">💬 WhatsApp</button>
                            <button class="btn btn-secondary" onclick="closeModal('customerDetailModal')">Kapat</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Modal varsa kaldır
            const existing = document.getElementById('customerDetailModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', html);
            
            // Backdrop'a tıklayınca modalı kapat
            const modal = document.getElementById('customerDetailModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    // Eğer modal'ın kendisine (backdrop) tıklanmışsa kapat, içeriğe tıklanmamışsa kapatma
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
        };
        
        // Görüşme kayıtları sekmesi yükleyici
        window.loadCallRecordsTab = async function(leadId, tabId) {
            // Eğer zaten yüklenmiş ise tekrar yükleme
            const tabElement = document.getElementById(tabId);
            if (!tabElement) return;
            
            const contentDiv = tabElement.querySelector(`#callRecords-${leadId}`);
            if (!contentDiv || contentDiv.dataset.loaded === 'true') return;
            
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) return;
            
            await renderCallRecords(lead.phone, `callRecords-${leadId}`);
            contentDiv.dataset.loaded = 'true';
        };
        
        // Müşteri detay sekmelerini değiştir
        window.switchCustomerTab = function(tabIndex) {
            // Modal içindeki sekmeleri bul
            const modal = document.getElementById('customerDetailModal');
            if (!modal) return;
            
            // Tüm sekme butonlarını pasif yap
            const tabs = modal.querySelectorAll('.tab-button');
            tabs.forEach(btn => btn.classList.remove('active'));
            
            // Tüm sekme içeriklerini gizle
            const contents = modal.querySelectorAll('.tab-content');
            contents.forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // Seçilen sekmeyi aktif yap
            if (tabs[tabIndex]) {
                tabs[tabIndex].classList.add('active');
            }
            if (contents[tabIndex]) {
                contents[tabIndex].classList.add('active');
                contents[tabIndex].style.display = 'block';
            }
        };
        
        // Yeni branş yaş grubu değişimi
        window.handleNewBranchAgeGroupChange = function(selectElement) {
            const value = selectElement.value;
            const adultDiv = document.getElementById('new-branch-adult');
            const childDiv = document.getElementById('new-branch-child');
            
            if (value === 'adult') {
                adultDiv.style.display = 'block';
                childDiv.style.display = 'none';
                adultDiv.querySelector('[name="fullName"]').required = true;
                childDiv.querySelector('[name="parentName"]').required = false;
            } else if (value === 'child') {
                adultDiv.style.display = 'none';
                childDiv.style.display = 'block';
                childDiv.querySelector('[name="parentName"]').required = true;
                adultDiv.querySelector('[name="fullName"]').required = false;
            } else {
                adultDiv.style.display = 'none';
                childDiv.style.display = 'none';
            }
        };
        
        // Yeni branş yetişkin etiket değişimi
        window.handleNewBranchTagChange = function(selectElement) {
            const value = selectElement.value;
            const datesDiv = document.getElementById('new-branch-adult-dates');
            const kayitDiv = document.getElementById('new-branch-adult-kayit');
            const denemeDiv = document.getElementById('new-branch-adult-deneme');
            
            if (value === 'Kayıt Olabilir') {
                datesDiv.style.display = 'block';
                kayitDiv.style.display = 'block';
                denemeDiv.style.display = 'none';
            } else if (value === 'Denemeye Gelecek') {
                datesDiv.style.display = 'block';
                kayitDiv.style.display = 'none';
                denemeDiv.style.display = 'block';
                // ✅ JavaScript validasyonu kullanılıyor, HTML required kaldırıldı
            } else {
                datesDiv.style.display = 'none';
                kayitDiv.style.display = 'none';
                denemeDiv.style.display = 'none';
            }

            // Etiket seçiminden sonra form sonuna kaydır
            try {
                const form = selectElement.closest('form');
                if (form) {
                    setTimeout(() => {
                        form.scrollTo({ top: form.scrollHeight, behavior: 'smooth' });
                    }, 50);
                }
            } catch(e) { /* no-op */ }
        };
        
        // Yeni branş çocuk etiket değişimi
        window.handleNewChildTagChange = function(selectElement) {
            const value = selectElement.value;
            const datesDiv = document.getElementById('new-branch-child-dates');
            const kayitDiv = document.getElementById('new-branch-child-kayit');
            const denemeDiv = document.getElementById('new-branch-child-deneme');
            
            if (value === 'Kayıt Olabilir') {
                datesDiv.style.display = 'block';
                kayitDiv.style.display = 'block';
                denemeDiv.style.display = 'none';
            } else if (value === 'Denemeye Gelecek') {
                datesDiv.style.display = 'block';
                kayitDiv.style.display = 'none';
                denemeDiv.style.display = 'block';
                // ✅ JavaScript validasyonu kullanılıyor, HTML required kaldırıldı
            } else {
                datesDiv.style.display = 'none';
                kayitDiv.style.display = 'none';
                denemeDiv.style.display = 'none';
            }
        };
        
        // Yeni branş ekleme
        window.handleAddNewBranch = async function(event, leadId) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            // Submit butonunu devre dışı bırak
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '⏳ Kaydediliyor...';
            
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) {
                showAlert('❌ Müşteri bulunamadı!', 'danger');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                return;
            }
            
            // Yeni branş verisi
            const newBranch = {
                branchId: formData.get('branchId'),
                ageGroup: formData.get('ageGroup'),
                notesHistory: [],
                createdAt: new Date().toISOString()
            };
            
            // Açıklama varsa ekle
            if (formData.get('newNote')) {
                newBranch.notesHistory.push({
                    text: formData.get('newNote'),
                    by: currentUser.fullName || currentUser.email,
                    date: new Date().toLocaleString('tr-TR')
                });
            }
            
            // Yaş grubuna göre veri ekle
            if (newBranch.ageGroup === 'adult') {
                newBranch.fullName = formData.get('fullName');
                newBranch.selectedTag = formData.get('selectedTag') || '';
                newBranch.kayitOlabilirDate = formData.get('kayitOlabilirDate') || '';
                newBranch.denemeDate = formData.get('denemeDate') || '';
            } else if (newBranch.ageGroup === 'child') {
                newBranch.parentName = formData.get('parentName');
                newBranch.children = [];
                
                // Çocuk bilgisi varsa ekle
                if (formData.get('childName')) {
                    newBranch.children.push({
                        name: formData.get('childName'),
                        age: formData.get('childAge') || '',
                        selectedTag: formData.get('childTag') || '',
                        kayitOlabilirDate: formData.get('childKayitDate') || '',
                        denemeDate: formData.get('childDenemeDate') || ''
                    });
                }
            }
            
            try {
                // Mevcut branşlara ekle
                const updatedBranches = [...(lead.branches || []), newBranch];
                
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'crmLeads', leadId), {
                    branches: updatedBranches
                });
                
                showAlert('✅ Yeni branş başarıyla eklendi!', 'success');
                
                // Listeyi yenile
                await loadData();
                
                // Modalı kapat ve yeniden aç
                closeModal('customerDetailModal');
                setTimeout(() => openCustomerDetail(leadId), 100);
                
            } catch (error) {
                console.error('Branş eklenirken hata:', error);
                showAlert('❌ Branş eklenirken hata oluştu: ' + error.message, 'danger');
                
                // Hata durumunda butonu tekrar aktif et
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        };
        
        // Müşteriye branş ekle
        window.addBranchToLead = function(leadId) {
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) return;
            
            // Branş ekleme butonunu göster
            setTimeout(() => {
                const addBranchBtn = document.querySelector('#addLeadModal .btn-success[onclick*="addBranchField"]');
                if (addBranchBtn) addBranchBtn.style.display = 'inline-block';
            }, 50);
            
            // Telefon numarasını otomatik kontrol ettir
            setTimeout(() => {
                const phoneInput = document.querySelector('#addLeadForm input[name="phone"]');
                if (phoneInput) {
                    phoneInput.value = lead.phone;
                    phoneInput.dispatchEvent(new Event('input'));
                }
            }, 100);
            
            openModal('addLeadModal');
        };
        
        // Açıklama geçmişinden bir notu sil
        window.deleteNoteHistory = async function(leadId, noteIndex) {
            if (!confirm('Bu açıklamayı silmek istediğinize emin misiniz?')) return;
            
            try {
                const lead = crmLeads.find(l => l.id === leadId);
                if (!lead) return;
                
                const notesHistory = lead.notesHistory || [];
                notesHistory.splice(noteIndex, 1);
                
                await window.firebase.updateDoc(
                    window.firebase.doc(window.db, 'crmLeads', leadId),
                    { notesHistory: notesHistory }
                );
                
                showAlert('✅ Açıklama silindi!', 'success');
                await loadData();
                
                // Modal'ı yenile
                closeModal('customerDetailModal');
                openCustomerDetail(leadId);
            } catch (error) {
                console.error('Açıklama silme hatası:', error);
                showAlert('❌ Silme işlemi başarısız: ' + error.message, 'danger');
            }
        };
        
        // WhatsApp ile lead'e mesaj at
        window.openWhatsAppWithLead = function(leadId) {
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) return;
            
            // WhatsApp bölümüne git
            showSection('whatsapp', document.querySelector('.nav-btn[onclick*="whatsapp"]'));
            
            // Telefon numarasını temizle ve formatla
            let phone = lead.phone.replace(/\D/g, '');
            if (phone.startsWith('0')) {
                phone = '90' + phone.substring(1);
            } else if (!phone.startsWith('90')) {
                phone = '90' + phone;
            }
            
            // Chat'i aç (bir süre bekle ki sayfa yüklensin)
            setTimeout(() => {
                const phoneWithSuffix = phone + '@s.whatsapp.net';
                // WhatsApp chat açma fonksiyonunu çağır
                if (window.openWhatsAppChat) {
                    window.openWhatsAppChat(phoneWithSuffix);
                }
            }, 500);
        };
        
        // Lead Sil
        async function deleteLead(leadId) {
            if (!confirm('Bu potansiyel müşteriyi silmek istediğinize emin misiniz?')) return;
            
            try {
                await window.firebase.deleteDoc(window.firebase.doc(window.db, 'crmLeads', leadId));
                showAlert('✅ Müşteri başarıyla silindi!', 'success');
                await loadData();
                renderCRMDashboard();
                renderCRMLeads();
            } catch (error) {
                console.error('Lead silme hatası:', error);
                showAlert('❌ Silme işlemi başarısız: ' + error.message, 'danger');
            }
        }
        
        // Lead Kaydet/Güncelle
        async function handleAddLead(e) {
            e.preventDefault();
            const form = e.target;
            const leadId = form.dataset.leadId;
            const formData = new FormData(form);
            
            // ✅ Kaydet butonunu devre dışı bırak ve loading göster
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '⏳ Kaydediliyor...';
            
            const phoneRaw = formData.get('phone');
            // Telefon numarasını temizle - boşluklar, tire vb. kaldır
            const phone = cleanPhoneNumber(phoneRaw);
            
            // Telefon numarası boş mu kontrol et
            if (!phone || phone.length < 10) {
                showAlert('⚠️ Geçerli bir telefon numarası girin!', 'warning');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                return;
            }
            
            // YENİ EKLEME: Aynı telefon numarası var mı kontrol et - phonesMatch kullan
            if (!leadId) { // Sadece yeni ekleme yapılırken kontrol et
                const existingLead = crmLeads.find(l => phonesMatch(l.phone, phone));
                
                if (existingLead) {
                    const openExisting = confirm(
                        `⚠️ Bu telefon numarası zaten kayıtlı!\n\n` +
                        `Müşteri: ${existingLead.fullName}\n` +
                        `Telefon: ${existingLead.phone}\n\n` +
                        `Mevcut müşteriyi açmak ister misiniz?`
                    );
                    
                    if (openExisting) {
                        closeModal('addLeadModal');
                        openCustomerDetail(existingLead.id);
                    }
                    
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    return;
                }
            }
            
            // Branş verilerini topla
            const branchesData = [];
            const branchInputs = form.querySelectorAll('[name^="branches["]');
            const branchIndices = new Set();
            
            branchInputs.forEach(input => {
                const match = input.name.match(/branches\[(\d+)\]\[(\w+)\]/);
                if (match) {
                    branchIndices.add(parseInt(match[1]));
                }
            });
            
            const now = new Date();
            const dateStr = now.toLocaleString('tr-TR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            const userName = currentUser.fullName || currentUser.email || 'Kullanıcı';
            
            branchIndices.forEach(index => {
                const branchId = formData.get(`branches[${index}][branchId]`);
                if (!branchId) return; // Branş seçilmemişse atla
                
                const ageGroup = formData.get(`branches[${index}][ageGroup]`);
                const selectedTag = formData.get(`branches[${index}][selectedTag]`);
                const newNote = formData.get(`branches[${index}][newNote]`);
                const kayitOlabilirDate = formData.get(`branches[${index}][kayitOlabilirDate]`);
                const denemeDate = formData.get(`branches[${index}][denemeDate]`);
                const notesHistoryStr = formData.get(`branches[${index}][notesHistory]`);
                const childrenStr = formData.get(`branches[${index}][children]`);
                
                let notesHistory = [];
                try {
                    notesHistory = JSON.parse(notesHistoryStr || '[]');
                } catch (e) {
                    notesHistory = [];
                }
                
                let children = [];
                try {
                    children = JSON.parse(childrenStr || '[]');
                } catch (e) {
                    children = [];
                }
                
                // Yeni not ekle
                if (newNote && newNote.trim()) {
                    notesHistory.push({
                        text: newNote.trim(),
                        by: userName,
                        date: dateStr
                    });
                }
                
                const branchData = {
                    branchId,
                    branchName: branches.find(b => b.id === branchId)?.name || '',
                    ageGroup: ageGroup || 'adult',
                    selectedTag: selectedTag || '',
                    notesHistory,
                    kayitOlabilirDate: kayitOlabilirDate || null,
                    denemeDate: denemeDate || null
                };
                
                // Yaş grubuna göre isim bilgisi
                if (ageGroup === 'adult') {
                    branchData.fullName = formData.get(`branches[${index}][fullName]`);
                } else if (ageGroup === 'child') {
                    branchData.parentName = formData.get(`branches[${index}][parentName]`);
                    branchData.children = children.filter(c => c.name && c.name.trim());
                }
                
                branchesData.push(branchData);
            });
            
            // ✅ Validasyon: "Denemeye Gelecek" etiketi seçiliyse deneme tarihi zorunlu
            for (const branch of branchesData) {
                if (branch.selectedTag === 'Denemeye Gelecek') {
                    // Yetişkin için deneme tarihi kontrolü
                    if (branch.ageGroup === 'adult' && (!branch.denemeDate || branch.denemeDate.trim() === '')) {
                        alert('⚠️ "Denemeye Gelecek" etiketi seçildiğinde deneme dersi tarihi zorunludur!\n\nLütfen deneme tarihi girin.');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                        return;
                    }
                    // Çocuklar için her çocuğun deneme tarihi kontrolü
                    if (branch.ageGroup === 'child' && branch.children && branch.children.length > 0) {
                        const childrenWithDenemeTag = branch.children.filter(child => child.selectedTag === 'Denemeye Gelecek');
                        for (const child of childrenWithDenemeTag) {
                            if (!child.denemeDate || child.denemeDate.trim() === '') {
                                alert(`⚠️ "${child.name}" için "Denemeye Gelecek" etiketi seçildiğinde deneme dersi tarihi zorunludur!\n\nLütfen deneme tarihi girin.`);
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalText;
                                return;
                            }
                        }
                    }
                }
                
                // ✅ Validasyon: "Kayıt Olabilir" etiketi seçiliyse kayıt tarihi zorunlu
                if (branch.selectedTag === 'Kayıt Olabilir') {
                    // Yetişkin için kayıt tarihi kontrolü
                    if (branch.ageGroup === 'adult' && (!branch.kayitOlabilirDate || branch.kayitOlabilirDate.trim() === '')) {
                        alert('⚠️ "Kayıt Olabilir" etiketi seçildiğinde kayıt olabilir tarihi zorunludur!\n\nLütfen kayıt olabilir tarihi girin.');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                        return;
                    }
                    // Çocuklar için her çocuğun kayıt tarihi kontrolü
                    if (branch.ageGroup === 'child' && branch.children && branch.children.length > 0) {
                        const childrenWithKayitTag = branch.children.filter(child => child.selectedTag === 'Kayıt Olabilir');
                        for (const child of childrenWithKayitTag) {
                            if (!child.kayitOlabilirDate || child.kayitOlabilirDate.trim() === '') {
                                alert(`⚠️ "${child.name}" için "Kayıt Olabilir" etiketi seçildiğinde kayıt olabilir tarihi zorunludur!\n\nLütfen kayıt olabilir tarihi girin.`);
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalText;
                                return;
                            }
                        }
                    }
                }
            }
            
            // fullName belirle - ilk branştan veya veli isminden
            let fullName = 'Müşteri';
            if (branchesData.length > 0) {
                const firstBranch = branchesData[0];
                if (firstBranch.ageGroup === 'adult') {
                    fullName = firstBranch.fullName || 'Müşteri';
                } else {
                    fullName = firstBranch.parentName || 'Veli';
                }
            }
            
            // Temel veri
            const leadData = {
                fullName: fullName, // Listeleme için
                phone: phone,
                source: formData.get('source') || 'other',
                branches: branchesData,
                clubId: currentClubId
            };
            
            try {
                if (leadId) {
                    // Güncelleme
                    leadData.updatedAt = now.toISOString();
                    leadData.updatedBy = userName;
                    
                    // Eski lead'i bul ve etiket değişikliklerini kontrol et
                    const oldLead = crmLeads.find(l => l.id === leadId);
                    const newHistory = [];
                    
                    if (oldLead && oldLead.branches) {
                        // Her branş için etiket değişikliklerini kontrol et
                        branchesData.forEach((newBranch) => {
                            const oldBranch = oldLead.branches.find(b => b.branchId === newBranch.branchId);
                            
                            if (oldBranch) {
                                // Etiket değişti mi?
                                if (oldBranch.selectedTag !== newBranch.selectedTag) {
                                    newHistory.push({
                                        action: 'tag_changed',
                                        by: userName,
                                        date: dateStr,
                                        details: `${newBranch.branchName} - Etiket "${oldBranch.selectedTag || 'Yok'}" → "${newBranch.selectedTag || 'Yok'}"`
                                    });
                                }
                            } else {
                                // Yeni branş eklendi
                                if (newBranch.selectedTag) {
                                    newHistory.push({
                                        action: 'tag_added',
                                        by: userName,
                                        date: dateStr,
                                        details: `${newBranch.branchName} - Etiket: "${newBranch.selectedTag}"`
                                    });
                                }
                            }
                        });
                    }
                    
                    // Varsa yeni history kayıtlarını ekle
                    if (newHistory.length > 0) {
                        leadData.history = [...(oldLead?.history || []), ...newHistory];
                    }
                    
                    await window.firebase.updateDoc(
                        window.firebase.doc(window.db, 'crmLeads', leadId),
                        leadData
                    );
                    showAlert('✅ Potansiyel müşteri başarıyla güncellendi!', 'success');
                } else {
                    // Yeni ekleme
                    leadData.createdAt = now.toISOString();
                    leadData.createdBy = userName;
                    leadData.status = 'new';
                    
                    // History'e müşteri oluşturma kaydı ekle
                    leadData.history = [{
                        action: 'created',
                        by: userName,
                        date: dateStr,
                        details: `Müşteri oluşturuldu - ${fullName} (${phone})`
                    }];
                    
                    // Her branş için etiket bilgisi ekle
                    branchesData.forEach((branch, index) => {
                        if (branch.selectedTag) {
                            leadData.history.push({
                                action: 'tag_added',
                                by: userName,
                                date: dateStr,
                                details: `${branch.branchName} - Etiket: "${branch.selectedTag}"`
                            });
                        }
                    });
                    
                    await window.firebase.addDoc(
                        window.firebase.collection(window.db, 'crmLeads'),
                        leadData
                    );
                    showAlert('✅ Potansiyel müşteri başarıyla eklendi!', 'success');
                }
                
                // ✅ Veri yükleme tamamlanana kadar bekle
                await loadData();
                
                // ✅ "Kayıt Oldu" etiketi varsa otomatik olarak üye sistemine ekle
                await checkAndAddToMembers(leadData, phone, fullName);
                
                // ✅ Başarılı - modal'ı kapat
                closeModal('addLeadModal');
                renderCRMDashboard();
                renderCRMLeads();
            } catch (error) {
                console.error('Lead kaydetme hatası:', error);
                showAlert('❌ Kayıt sırasında hata oluştu: ' + error.message, 'danger');
                
                // ✅ Hata durumunda butonu tekrar aktif et
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }
        
        // "Kayıt Oldu" etiketi varsa otomatik üye sistemine ekle
        async function checkAndAddToMembers(leadData, phone, fullName) {
            if (!leadData.branches || leadData.branches.length === 0) return;
            
            try {
                // "Kayıt Oldu" etiketi olan branşları bul
                const convertedBranches = leadData.branches.filter(b => b.selectedTag === 'Kayıt Oldu');
                
                if (convertedBranches.length === 0) return;
                
                // Üye sisteminde zaten var mı kontrol et
                const existingMember = members.find(m => phonesMatch(m.Telefon, phone));
                
                for (const branch of convertedBranches) {
                    const branchInfo = branches.find(b => b.id === branch.branchId);
                    if (!branchInfo) continue;
                    
                    // Üye verisi oluştur
                    const memberData = {
                        Ad_Soyad: branch.ageGroup === 'adult' ? (branch.fullName || fullName) : (branch.parentName || fullName),
                        Veli_2_Adi_Soyadi: '',
                        Telefon_2: '',
                        Resit_Olmayan_Adi_Soyadi: branch.ageGroup === 'child' && branch.children && branch.children.length > 0 ? branch.children[0].name : '',
                        Telefon: phone,
                        Brans: branchInfo.name, // Branş ismi olarak kaydet
                        studentBirthDate: '',
                        status: 'pending', // Bekleyen üye olarak ekle
                        registrationDate: new Date().toISOString(),
                        clubId: currentClubId,
                        crmSourceLeadId: leadData.id || null, // CRM'den geldiğini işaretle
                        notes: `CRM'den otomatik eklendi - Etiket: "Kayıt Oldu"`
                    };
                    
                    if (existingMember) {
                        // Üye zaten varsa, sadece notları güncelle
                        console.log(`✅ ${fullName}: Zaten üye sisteminde mevcut`);
                        
                        const currentNotes = existingMember.notes || '';
                        const newNotes = currentNotes + `\n[${new Date().toLocaleString('tr-TR')}] CRM'de "Kayıt Oldu" olarak işaretlendi - ${branchInfo.name}`;
                        
                        await window.firebase.updateDoc(
                            window.firebase.doc(window.db, 'members', existingMember.id),
                            { notes: newNotes }
                        );
                    } else {
                        // Yeni üye ekle
                        await window.firebase.addDoc(
                            window.firebase.collection(window.db, 'members'),
                            memberData
                        );
                        
                        console.log(`✅ ${fullName}: Bekleyen üyelere eklendi (${branchInfo.name})`);
                        
                        // Başarı mesajı
                        showAlert(`✅ Müşteri "Bekleyen Üyeler" listesine eklendi!\n\nÜyeler bölümünden ödeme planı ve diğer bilgileri girebilirsiniz.`, 'success');
                    }
                }
                
                // Üye listesini yenile
                await loadData();
                
            } catch (error) {
                console.error('Üye sisteme eklenirken hata:', error);
                showAlert(`⚠️ CRM kaydı başarılı ancak üye sistemine eklenirken hata oluştu: ${error.message}`, 'warning');
            }
        }
        
        // Kaynak adı helper
        function getSourceName(source) {
            const sources = {
                'website': '🌐 Website',
                'phone': '📞 Telefon',
                'referral': '👥 Tavsiye',
                'social': '📱 Sosyal Medya',
                'other': '🔹 Diğer'
            };
            return sources[source] || source;
        }
        
        // ========== ZAMANLANMIŞ MESAJ FONKSİYONLARI ==========
        
        // Zamanlanmış mesaj modalını aç
        function openScheduleMessageModal() {
            const modal = document.getElementById('scheduleMessageModal');
            if (!modal) {
                console.error('❌ scheduleMessageModal bulunamadı!');
                return;
            }
            
            const form = document.getElementById('scheduleMessageForm');
            form.reset();
            
            // Minimum zamanı şu andan 5 dakika sonra yap
            const minTime = new Date(Date.now() + 5 * 60 * 1000);
            const year = minTime.getFullYear();
            const month = String(minTime.getMonth() + 1).padStart(2, '0');
            const day = String(minTime.getDate()).padStart(2, '0');
            const hours = String(minTime.getHours()).padStart(2, '0');
            const minutes = String(minTime.getMinutes()).padStart(2, '0');
            form.elements['scheduledTime'].min = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            openModal('scheduleMessageModal');
        }
        
        // Zamanlanmış mesaj kaydet
        async function handleScheduleMessage(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            try {
                // Default cihazı al
                const device = whatsappDevices.find(d => 
                    d.status === 'connected' && d.instanceName === defaultWhatsAppDevice
                ) || whatsappDevices.find(d => d.status === 'connected');
                
                if (!device) {
                    showAlert('❌ Bağlı WhatsApp cihazı bulunamadı!', 'danger');
                    return;
                }
                
                const phoneNumber = formData.get('phoneNumber');
                const recipientName = formData.get('recipientName') || phoneNumber;
                const messageText = formData.get('messageText');
                const scheduledTime = new Date(formData.get('scheduledTime'));
                const messageType = formData.get('messageType');
                
                // Zamanlama kontrolü
                if (scheduledTime < new Date()) {
                    showAlert('⚠️ Gönderim zamanı geçmişte olamaz!', 'warning');
                    return;
                }
                
                // Firebase'e kaydet
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'scheduledMessages'), 
                    {
                        clubId: currentClubId,
                        deviceId: device.id,
                        recipientName: recipientName,
                        phoneNumber: phoneNumber,
                        messageText: messageText,
                        messageType: messageType,
                        scheduledTime: scheduledTime,
                        status: 'scheduled',
                        createdAt: new Date(),
                        createdBy: currentUser.email || currentUser.fullName,
                        retryCount: 0
                    }
                );
                
                const timeStr = scheduledTime.toLocaleString('tr-TR', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                showAlert(`✅ Mesaj ${timeStr} tarihinde gönderilmek üzere zamanlandı!\n\n⚠️ Tarayıcıyı kapatabilirsiniz, mesaj Firebase Cloud Functions üzerinden otomatik gönderilecektir.`, 'success');
                
                closeModal('scheduleMessageModal');
                
            } catch (error) {
                console.error('Mesaj zamanlama hatası:', error);
                showAlert('❌ Mesaj zamanlanamadı: ' + error.message, 'danger');
            }
        }
        
        // Global'e ekle
        window.openScheduleMessageModal = openScheduleMessageModal;
        window.handleScheduleMessage = handleScheduleMessage;
        window.openAddLeadModal = openAddLeadModal;
        window.editLead = editLead;
        window.deleteLead = deleteLead;
        window.handleAddLead = handleAddLead;
        window.renderCRMDashboard = renderCRMDashboard;
        
        // Kampanya Sayfası
        function renderCampaignsPage() {
            // Branş filtresini doldur
            const branchFilter = document.getElementById('campaign-branch-filter');
            if (branchFilter) {
                branchFilter.innerHTML = '<option value="all">Tüm Branşlar</option>' + 
                    branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
            }
            
            // Etiket filtresini doldur
            const tagFilter = document.getElementById('campaign-tag-filter');
            if (tagFilter && crmTags) {
                const nonBranchTags = crmTags.filter(tag => tag.category !== 'branch');
                tagFilter.innerHTML = '<option value="all">Tüm Etiketler</option>' + 
                    nonBranchTags.map(t => `<option value="${t.name}">🏷️ ${t.name}</option>`).join('');
            }
            
            // Cihaz listesini doldur
            const deviceSelect = document.getElementById('campaign-device');
            if (deviceSelect && whatsappDevices) {
                deviceSelect.innerHTML = '<option value="">Cihaz seçin...</option>' +
                    whatsappDevices
                        .filter(d => d.status === 'connected')
                        .map(d => `<option value="${d.instanceName}">${d.instanceName} (${d.phoneNumber})</option>`).join('');
            }
            
            updateCampaignRecipients();
        }
        
        window.updateCampaignRecipients = function() {
            const branchFilter = document.getElementById('campaign-branch-filter')?.value || 'all';
            const tagFilter = document.getElementById('campaign-tag-filter')?.value || 'all';
            const ageFilter = document.getElementById('campaign-agegroup-filter')?.value || 'all';
            
            let recipients = new Set();
            
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        let match = true;
                        
                        // Branş filtresi
                        if (branchFilter !== 'all' && br.branchId !== branchFilter) {
                            match = false;
                        }
                        
                        // Yaş grubu filtresi
                        if (ageFilter !== 'all' && br.ageGroup !== ageFilter) {
                            match = false;
                        }
                        
                        // Etiket filtresi
                        if (tagFilter !== 'all' && br.selectedTag !== tagFilter) {
                            match = false;
                        }
                        
                        if (match && lead.phone) {
                            recipients.add(lead.phone);
                        }
                        
                        // Çocukları da kontrol et
                        if (match && br.ageGroup === 'child' && br.children) {
                            br.children.forEach(c => {
                                if (tagFilter === 'all' || c.selectedTag === tagFilter) {
                                    if (lead.phone) recipients.add(lead.phone);
                                }
                            });
                        }
                    });
                }
            });
            
            const countEl = document.getElementById('campaign-recipient-count');
            if (countEl) {
                countEl.textContent = recipients.size;
            }
        };
        
        window.sendCampaignMessages = async function() {
            const device = document.getElementById('campaign-device').value;
            const message = document.getElementById('campaign-message').value;
            const sendDelay = document.getElementById('campaign-send-delay').checked;
            
            if (!device || !message.trim()) {
                showAlert('❌ Lütfen tüm alanları doldurun!', 'danger');
                return;
            }
            
            if (!confirm('Kampanyayı başlatmak istediğinize emin misiniz?')) {
                return;
            }
            
            const branchFilter = document.getElementById('campaign-branch-filter')?.value || 'all';
            const tagFilter = document.getElementById('campaign-tag-filter')?.value || 'all';
            const ageFilter = document.getElementById('campaign-agegroup-filter')?.value || 'all';
            
            // Alıcıları topla
            const recipients = [];
            const phoneSet = new Set();
            
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        let match = true;
                        
                        if (branchFilter !== 'all' && br.branchId !== branchFilter) match = false;
                        if (ageFilter !== 'all' && br.ageGroup !== ageFilter) match = false;
                        if (tagFilter !== 'all' && br.selectedTag !== tagFilter) match = false;
                        
                        if (match && lead.phone && !phoneSet.has(lead.phone)) {
                            phoneSet.add(lead.phone);
                            const name = br.ageGroup === 'adult' ? (br.fullName || lead.fullName) : br.parentName;
                            recipients.push({ phone: lead.phone, name: name || 'Müşteri' });
                        }
                        
                        if (match && br.ageGroup === 'child' && br.children) {
                            br.children.forEach(c => {
                                if ((tagFilter === 'all' || c.selectedTag === tagFilter) && lead.phone && !phoneSet.has(lead.phone)) {
                                    phoneSet.add(lead.phone);
                                    recipients.push({ phone: lead.phone, name: br.parentName || 'Veli' });
                                }
                            });
                        }
                    });
                }
            });
            
            if (recipients.length === 0) {
                showAlert('❌ Seçilen kriterlere uygun müşteri bulunamadı!', 'danger');
                return;
            }
            
            // Gönderim başlat
            const statusDiv = document.getElementById('campaign-status');
            const progressDiv = document.getElementById('campaign-progress');
            statusDiv.style.display = 'block';
            
            let successCount = 0;
            let failCount = 0;
            
            for (let i = 0; i < recipients.length; i++) {
                const recipient = recipients[i];
                const personalizedMessage = message
                    .replace(/\{ad\}/g, recipient.name)
                    .replace(/\{telefon\}/g, recipient.phone);
                
                progressDiv.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>İlerleme:</strong> ${i + 1} / ${recipients.length}
                    </div>
                    <div style="background: #fff; border-radius: 8px; height: 20px; overflow: hidden;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${((i + 1) / recipients.length * 100).toFixed(1)}%; transition: width 0.3s;"></div>
                    </div>
                    <div style="margin-top: 10px; font-size: 14px;">
                        <span style="color: #4caf50;">✅ Başarılı: ${successCount}</span> | 
                        <span style="color: #f44336;">❌ Başarısız: ${failCount}</span>
                    </div>
                `;
                
                try {
                    const result = await sendWhatsAppMessage(device, recipient.phone, personalizedMessage, recipient.name);
                    if (result.success || result === true) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    failCount++;
                }
                
                if (sendDelay && i < recipients.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            progressDiv.innerHTML += `
                <div style="margin-top: 20px; padding: 15px; background: ${successCount > 0 ? '#e8f5e9' : '#ffebee'}; border-radius: 8px;">
                    <h4>🎉 Kampanya Tamamlandı!</h4>
                    <p><strong>Toplam:</strong> ${recipients.length} | <strong>Başarılı:</strong> ${successCount} | <strong>Başarısız:</strong> ${failCount}</p>
                </div>
            `;
        };
        
        // === YENİ KAMPANYA SİSTEMİ FONKSIYONLARI ===
        
        // ✅ Direkt mesaj gönderme modalını aç
        window.openDirectMessageModal = function() {
            // Cihaz dropdown'ını doldur
            const deviceSelect = document.getElementById('direct-message-device');
            if (deviceSelect && whatsappDevices) {
                deviceSelect.innerHTML = '<option value="">Varsayılan cihaz</option>' +
                    whatsappDevices
                        .filter(d => d.status === 'open')
                        .map(d => `<option value="${d.instanceName}">${d.name || d.instanceName}</option>`)
                        .join('');
            }
            
            // Formu temizle
            document.getElementById('directMessageForm').reset();
            
            // Modal'ı aç
            openModal('directMessageModal');
        };
        
        // ✅ Direkt mesaj gönder
        window.handleDirectMessage = async function(event) {
            event.preventDefault();
            const form = event.target;
            const phone = form.phone.value.trim();
            const message = form.message.value.trim();
            const deviceId = form.deviceId.value || null;
            
            if (!phone || !message) {
                showAlert('Telefon numarası ve mesaj gerekli!', 'warning');
                return;
            }
            
            // Cihaz seç
            let device = null;
            if (deviceId) {
                device = whatsappDevices.find(d => d.instanceName === deviceId);
            } else {
                // Varsayılan cihaz veya ilk aktif cihazı kullan
                device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice) || 
                         whatsappDevices.find(d => d.status === 'open');
            }
            
            if (!device) {
                showAlert('❌ Aktif WhatsApp cihazı bulunamadı!', 'danger');
                return;
            }
            
            // Loading göster
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></span> Gönderiliyor...';
            
            try {
                // Mesaj gönder
                const success = await sendWhatsAppMessage(
                    device.instanceName,
                    phone,
                    message,
                    phone // recipient name
                );
                
                if (success) {
                    showAlert('✅ Mesaj başarıyla gönderildi!', 'success');
                    closeModal('directMessageModal');
                } else {
                    showAlert('❌ Mesaj gönderilemedi. Lütfen tekrar deneyin.', 'danger');
                }
            } catch (error) {
                console.error('Direct message error:', error);
                showAlert('❌ Mesaj gönderilirken hata oluştu: ' + error.message, 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        };
        
        window.openCampaignModal = function() {
            // Etiket dropdown'ını doldur
            const tagSelect = document.getElementById('campaign-tag-select');
            if (tagSelect && crmTags) {
                const nonBranchTags = crmTags.filter(tag => tag.category !== 'branch');
                tagSelect.innerHTML = '<option value="">Seçiniz...</option>' + 
                    nonBranchTags.map(t => `<option value="${t.name}">🏷️ ${t.name}</option>`).join('');
            }
            
            // Branş dropdown'ını doldur
            const branchSelect = document.getElementById('campaign-branch-select');
            if (branchSelect && branches) {
                branchSelect.innerHTML = '<option value="">Seçiniz...</option>' +
                    branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
            }
            
            // Modal'ı aç
            document.getElementById('campaignModal').style.display = 'block';
        };
        
        window.updateCampaignRecipientCount = function(audienceType) {
            // Etiket ve branş filtrelerini göster/gizle
            document.getElementById('campaign-tag-filter').style.display = audienceType === 'crm-by-tag' ? 'block' : 'none';
            document.getElementById('campaign-branch-filter').style.display = audienceType === 'crm-by-branch' ? 'block' : 'none';
            
            // Alıcı sayısını hesapla
            let recipientCount = 0;
            
            switch(audienceType) {
                case 'all-members':
                    recipientCount = members.filter(m => m.Telefon).length;
                    break;
                case 'active-members':
                    recipientCount = members.filter(m => m.Telefon && m.Durum === 'aktif').length;
                    break;
                case 'inactive-members':
                    recipientCount = members.filter(m => m.Telefon && m.Durum !== 'aktif').length;
                    break;
                case 'crm-all':
                    recipientCount = crmLeads.filter(l => l.phone).length;
                    break;
                case 'crm-by-tag':
                case 'crm-by-branch':
                    // Kullanıcı etiketi veya branşı seçince hesaplanır
                    recipientCount = 0;
                    break;
            }
            
            document.getElementById('campaign-recipient-count').textContent = recipientCount;
            
            // Tahmini süreyi hesapla
            const dailyLimit = parseInt(document.querySelector('input[name="dailyLimit"]').value) || 200;
            const estimatedDays = Math.ceil(recipientCount / dailyLimit);
            document.getElementById('campaign-duration').textContent = estimatedDays > 0 ? `${estimatedDays} gün` : '-';
        };
        
        window.handleCreateCampaign = async function(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            const campaignData = {
                name: formData.get('campaignName'),
                targetAudience: formData.get('targetAudience'),
                messageContent: formData.get('messageContent'),
                dailyLimit: parseInt(formData.get('dailyLimit')),
                startTime: formData.get('startTime'),
                status: 'pending',
                createdAt: new Date().toISOString(),
                clubId: currentClubId,
                createdBy: currentUserEmail
            };
            
            // CRM filtreler
            if (campaignData.targetAudience === 'crm-by-tag') {
                campaignData.crmTag = formData.get('crmTag');
            } else if (campaignData.targetAudience === 'crm-by-branch') {
                campaignData.crmBranch = formData.get('crmBranch');
            }
            
            // Alıcıları belirle
            const recipients = getCampaignRecipients(campaignData);
            campaignData.totalRecipients = recipients.length;
            
            if (recipients.length === 0) {
                showAlert('❌ Hedef kitle boş! Lütfen alıcıları kontrol edin.', 'danger');
                return;
            }
            
            if (!confirm(`${recipients.length} kişiye mesaj gönderilecek. Devam etmek istiyor musunuz?`)) {
                return;
            }
            
            try {
                // Kampanyayı Firebase'e kaydet
                const campaignRef = await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'campaigns'),
                    campaignData
                );
                
                // Alıcıları parçalara böl ve kuyruğa ekle
                const startDate = new Date(campaignData.startTime);
                const dailyLimit = campaignData.dailyLimit;
                
                let dayOffset = 0;
                for (let i = 0; i < recipients.length; i += dailyLimit) {
                    const batch = recipients.slice(i, i + dailyLimit);
                    const scheduledDate = new Date(startDate);
                    scheduledDate.setDate(scheduledDate.getDate() + dayOffset);
                    
                    // Her alıcı için Mesaj Kuyruğuna ekle
                    for (const recipient of batch) {
                        const message = campaignData.messageContent
                            .replace(/{AD_SOYAD}/g, recipient.name || '')
                            .replace(/{AD}/g, (recipient.name || '').split(' ')[0])
                            .replace(/{TELEFON}/g, recipient.phone);
                        
                        await window.firebase.addDoc(
                            window.firebase.collection(window.db, 'messageQueue'),
                            {
                                clubId: currentClubId,
                                campaignId: campaignRef.id,
                                phone: recipient.phone,
                                message: message,
                                scheduledFor: scheduledDate.toISOString(),
                                status: 'pending',
                                createdAt: new Date().toISOString()
                            }
                        );
                    }
                    
                    dayOffset++;
                }
                
                showAlert(`✅ Kampanya oluşturuldu! ${recipients.length} mesaj ${dayOffset} güne bölünerek kuyruğa eklendi.`, 'success');
                closeModal('campaignModal');
                form.reset();
                loadCampaigns();
            } catch (error) {
                console.error('❌ Kampanya oluşturma hatası:', error);
                showAlert('❌ Kampanya oluşturulamadı: ' + error.message, 'danger');
            }
        };
        
        function getCampaignRecipients(campaignData) {
            const recipients = [];
            const phoneSet = new Set();
            
            switch(campaignData.targetAudience) {
                case 'all-members':
                    members.forEach(m => {
                        if (m.Telefon && !phoneSet.has(m.Telefon)) {
                            phoneSet.add(m.Telefon);
                            recipients.push({
                                phone: m.Telefon,
                                name: m.OgrenciAdiSoyadi || m.VeliAdiSoyadi
                            });
                        }
                    });
                    break;
                case 'active-members':
                    members.filter(m => m.Durum === 'aktif').forEach(m => {
                        if (m.Telefon && !phoneSet.has(m.Telefon)) {
                            phoneSet.add(m.Telefon);
                            recipients.push({
                                phone: m.Telefon,
                                name: m.OgrenciAdiSoyadi || m.VeliAdiSoyadi
                            });
                        }
                    });
                    break;
                case 'inactive-members':
                    members.filter(m => m.Durum !== 'aktif').forEach(m => {
                        if (m.Telefon && !phoneSet.has(m.Telefon)) {
                            phoneSet.add(m.Telefon);
                            recipients.push({
                                phone: m.Telefon,
                                name: m.OgrenciAdiSoyadi || m.VeliAdiSoyadi
                            });
                        }
                    });
                    break;
                case 'crm-all':
                    crmLeads.forEach(lead => {
                        if (lead.phone && !phoneSet.has(lead.phone)) {
                            phoneSet.add(lead.phone);
                            recipients.push({
                                phone: lead.phone,
                                name: lead.fullName
                            });
                        }
                    });
                    break;
                case 'crm-by-tag':
                    crmLeads.forEach(lead => {
                        if (lead.branches) {
                            lead.branches.forEach(br => {
                                if (br.selectedTag === campaignData.crmTag && lead.phone && !phoneSet.has(lead.phone)) {
                                    phoneSet.add(lead.phone);
                                    recipients.push({
                                        phone: lead.phone,
                                        name: lead.fullName
                                    });
                                }
                            });
                        }
                    });
                    break;
                case 'crm-by-branch':
                    crmLeads.forEach(lead => {
                        if (lead.branches) {
                            lead.branches.forEach(br => {
                                if (br.branchId === campaignData.crmBranch && lead.phone && !phoneSet.has(lead.phone)) {
                                    phoneSet.add(lead.phone);
                                    recipients.push({
                                        phone: lead.phone,
                                        name: lead.fullName
                                    });
                                }
                            });
                        }
                    });
                    break;
            }
            
            return recipients;
        }
        
        window.loadCampaigns = async function() {
            const container = document.getElementById('campaigns-list');
            if (!container) return;
            
            try {
                container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Kampanyalar yükleniyor...</span></div>';
                
                const campaignsRef = window.firebase.collection(window.db, 'campaigns');
                const q = window.firebase.query(
                    campaignsRef,
                    window.firebase.where('clubId', '==', currentClubId),
                    window.firebase.orderBy('createdAt', 'desc')
                );
                
                const snapshot = await window.firebase.getDocs(q);
                
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-state"><p>Henüz kampanya oluşturulmamış</p></div>';
                    return;
                }
                
                let html = '<div style="display: grid; gap: 15px;">';
                snapshot.forEach(doc => {
                    const campaign = doc.data();
                    const createdDate = new Date(campaign.createdAt).toLocaleString('tr-TR');
                    const startDate = new Date(campaign.startTime).toLocaleString('tr-TR');
                    
                    const statusColors = {
                        'pending': '#ff9800',
                        'active': '#4CAF50',
                        'completed': '#9e9e9e',
                        'paused': '#f44336'
                    };
                    
                    const statusText = {
                        'pending': '⏰ Bekliyor',
                        'active': '▶️ Aktif',
                        'completed': '✅ Tamamlandı',
                        'paused': '⏸️ Duraklatıldı'
                    };
                    
                    html += `
                        <div style="padding: 15px; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <h4 style="margin: 0 0 5px 0;">${campaign.name}</h4>
                                    <span style="background: ${statusColors[campaign.status]}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px;">
                                        ${statusText[campaign.status]}
                                    </span>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 6px; font-size: 13px;">
                                <div>
                                    <div style="color: #666;">📊 Alıcı Sayısı</div>
                                    <div style="font-weight: 600;">${campaign.totalRecipients}</div>
                                </div>
                                <div>
                                    <div style="color: #666;">📅 Günlük Limit</div>
                                    <div style="font-weight: 600;">${campaign.dailyLimit}</div>
                                </div>
                                <div>
                                    <div style="color: #666;">🕐 Başlangıç</div>
                                    <div style="font-weight: 600;">${startDate}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
            } catch (error) {
                console.error('❌ Kampanyalar yüklenirken hata:', error);
                container.innerHTML = '<div class="empty-state"><p>Kampanyalar yüklenemedi</p></div>';
            }
        };
        
        // === KAMPANYA FONKSİYONLARI SONU ===
        
        window.sendCampaignMessages = async function() {
            
            showAlert(`✅ Kampanya tamamlandı! ${successCount} mesaj gönderildi.`, 'success');
        };
        
        window.resetCampaignForm = function() {
            document.getElementById('campaign-branch-filter').value = 'all';
            document.getElementById('campaign-tag-filter').value = 'all';
            document.getElementById('campaign-agegroup-filter').value = 'all';
            document.getElementById('campaign-message').value = '';
            document.getElementById('campaign-send-delay').checked = false;
            document.getElementById('campaign-status').style.display = 'none';
            updateCampaignRecipients();
        };
        
        window.renderCampaignsPage = renderCampaignsPage;
        window.renderCRMLeads = renderCRMLeads;
        
        // ========== END CRM FUNCTIONS ==========

        function renderTasksPage() {
            const tableBody = document.getElementById('tasksTableBody');
            if (!tableBody) return;
            
            let filteredTasks = tasks;
            if (!currentUser.isSuperAdmin) {
                filteredTasks = tasks.filter(task => task.assignedTo === currentUser.fullName);
            }

            tableBody.innerHTML = filteredTasks.length === 0 
                ? `<tr><td colspan="8" class="empty-state"><h3>Aktif görev bulunmuyor.</h3></td></tr>`
                : filteredTasks.map(task => {
                    let statusClass = 'pending';
                    if (task.status === 'Tamamlandı') statusClass = 'completed';
                    if (task.status === 'Devam Ediyor') statusClass = 'active';
                    const messageCount = (task.messages || []).length;
                    const unreadCount = (task.messages || []).filter(m => !m.read && m.sender !== currentUser.fullName).length;
                    return `
                    <tr>
                        <td>${task.taskName}</td>
                        <td>${task.assignedTo}</td>
                        <td><span class="status-badge status-${statusClass}">${task.status}</span></td>
                        <td>${task.notes || '-'}</td>
                        <td>${formatDate(task.createdAt)}</td>
                        <td>${task.completedAt ? formatDate(task.completedAt) : '-'}</td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="openTaskMessagesModal('${task.id}')">
                                💬 Mesajlar ${unreadCount > 0 ? `<span class="badge">${unreadCount}</span>` : `(${messageCount})`}
                            </button>
                        </td>
                        <td>
                            <div class="actions-cell">
                                ${currentUser.isSuperAdmin || currentUser.isAdmin ? `<button class="btn btn-warning btn-sm" onclick="sendTaskReminder('${task.id}')" title="WhatsApp ile hatırlat">🔔 Hatırlat</button>` : ''}
                                <button class="btn btn-primary btn-sm" onclick="openTaskEditModal('${task.id}')">Düzenle</button>
                                ${currentUser.isSuperAdmin || currentUser.isAdmin ? `<button class="btn btn-danger btn-sm" onclick="deleteItem('tasks', '${task.id}')">Sil</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `}).join('');
        }
        
        async function sendTaskReminder(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) {
                showAlert('Görev bulunamadı.', 'danger');
                return;
            }
            
            // ✅ Kullanıcılar henüz yüklenmediyse yükle
            if (!users || users.length === 0) {
                console.log('⏳ Kullanıcılar yükleniyor...');
                try {
                    const { data: usersData, error: usersError } = await supabase
                        .from('users')
                        .select('*')
                        .eq('clubId', currentClubId);
                    
                    if (usersError) throw usersError;
                    users = usersData || [];
                    console.log('✅ Kullanıcılar yüklendi:', users.length);
                } catch (error) {
                    console.error('❌ Kullanıcılar yüklenemedi:', error);
                    showAlert('Kullanıcılar yüklenemedi. Lütfen sayfayı yenileyin.', 'danger');
                    return;
                }
            }
            
            // Find user phone number
            const assignedUser = users.find(u => u.fullName === task.assignedTo);
            if (!assignedUser) {
                console.error('❌ Kullanıcı bulunamadı:', {
                    aranan: task.assignedTo,
                    mevcutKullanicilar: users.map(u => u.fullName)
                });
                showAlert(`Sorumlu kişi "${task.assignedTo}" kullanıcı listesinde bulunamadı.`, 'danger');
                return;
            }
            
            if (!assignedUser.phone) {
                showAlert(`${assignedUser.fullName} adlı kişinin telefon numarası kayıtlı değil.`, 'danger');
                return;
            }
            
            // ✅ WhatsApp cihazlarını ve ayarlarını yükle
            if (!whatsappDevices || whatsappDevices.length === 0) {
                console.log('⏳ WhatsApp cihazları yükleniyor...');
                try {
                    const { data: devicesData, error: devicesError } = await supabase
                        .from('whatsappDevices')
                        .select('*')
                        .eq('clubId', currentClubId);
                    
                    if (devicesError) throw devicesError;
                    whatsappDevices = devicesData || [];
                    console.log('✅ WhatsApp cihazları yüklendi:', whatsappDevices.length);
                } catch (error) {
                    console.error('❌ WhatsApp cihazları yüklenemedi:', error);
                    showAlert('WhatsApp cihazları yüklenemedi. Lütfen sayfayı yenileyin.', 'danger');
                    return;
                }
            }
            
            // ✅ Ana WhatsApp hattını yükle
            if (!defaultWhatsAppDevice) {
                console.log('⏳ Ana WhatsApp hattı ayarları yükleniyor...');
                try {
                    // clubSettings'den yükle
                    if (clubSettings && (clubSettings.defaultWhatsAppDevice || clubSettings.defaultDevice)) {
                        defaultWhatsAppDevice = clubSettings.defaultWhatsAppDevice || clubSettings.defaultDevice;
                        console.log('✅ Ana hat clubSettings\'den yüklendi:', defaultWhatsAppDevice);
                    } else {
                        // Supabase'den yükle
                        const { data: settingsData, error: settingsError } = await supabase
                            .from('settings')
                            .select('data')
                            .eq('id', `whatsapp_${currentClubId}`)
                            .single();
                        
                        if (settingsData && settingsData.data && settingsData.data.defaultDevice) {
                            defaultWhatsAppDevice = settingsData.data.defaultDevice;
                            console.log('✅ Ana hat Supabase\'den yüklendi:', defaultWhatsAppDevice);
                        }
                    }
                } catch (error) {
                    console.error('❌ Ana WhatsApp hattı yüklenemedi:', error);
                }
            }
            
            // Check WhatsApp connection - ANA WHATSAPP HATTI KULLAN
            if (!defaultWhatsAppDevice) {
                showAlert('Ana WhatsApp hattı ayarlanmamış. Lütfen önce Ayarlar > WhatsApp bölümünden ana hattı belirleyin.', 'danger');
                return;
            }
            
            // ✅ status veya isConnected kullan (Supabase migration için)
            const connectedDevice = whatsappDevices.find(d => 
                (d.status === 'connected' || d.isConnected === true) && 
                d.instanceName === defaultWhatsAppDevice
            );
            if (!connectedDevice) {
                showAlert(`Ana WhatsApp hattı (${defaultWhatsAppDevice}) bağlı değil. Lütfen cihazı bağlayın.`, 'danger');
                return;
            }
            
            console.log('🔍 Connected device bulundu:', {
                instanceName: connectedDevice.instanceName,
                phoneNumber: connectedDevice.phoneNumber,
                defaultWhatsAppDevice: defaultWhatsAppDevice
            });
            
            // Check if evolutionUrl exists
            if (!connectedDevice.evolutionUrl || connectedDevice.evolutionUrl === 'undefined') {
                showAlert('⚠️ WhatsApp cihazının Evolution API URL\'si tanımlanmamış. Lütfen WhatsApp ayarlarından cihazı yeniden yapılandırın.', 'danger');
                console.error('Device configuration:', connectedDevice);
                return;
            }
            
            // Format phone number for Evolution API
            let phoneNumber = assignedUser.phone.replace(/\D/g, ''); // Remove all non-digits
            if (phoneNumber.startsWith('0')) {
                phoneNumber = '90' + phoneNumber.substring(1); // Replace leading 0 with 90
            } else if (!phoneNumber.startsWith('90')) {
                phoneNumber = '90' + phoneNumber; // Add 90 prefix if missing
            }
            
            // Prepare message
            const message = `🔔 Görev Hatırlatması\n\n` +
                          `Görev: ${task.taskName}\n` +
                          `Durum: ${task.status}\n` +
                          `Notlar: ${task.notes || 'Yok'}\n` +
                          `Oluşturulma: ${formatDate(task.createdAt)}\n\n` +
                          `Lütfen görevinizi kontrol edin.`;
            
            try {
                console.log(`📤 Görev hatırlatması gönderiliyor: ${phoneNumber}...`);
                
                // ✅ MESAI SAATLERİNDE DİREKT GÖNDER (sendImmediately = true)
                const queueId = await addMessageToQueue(phoneNumber, message, connectedDevice.instanceName, task.assignedTo, true);
                
                if (queueId === null) {
                    // Direkt gönderildi
                    showAlert(`✅ Hatırlatma ${task.assignedTo} adlı kişiye direkt gönderildi!`, 'success');
                } else {
                    // Kuyruğa eklendi (mesai saatleri dışı)
                    showAlert(`✅ Hatırlatma ${task.assignedTo} adlı kişiye gönderilmek üzere kuyruğa eklendi.`, 'success');
                    
                    // Mesaj kuyruğunu yenile
                    if (typeof renderMessageQueue === 'function') {
                        await renderMessageQueue();
                    }
                }
            } catch (error) {
                console.error('Error sending task reminder:', error);
                showAlert('Hatırlatma gönderilirken hata oluştu: ' + error.message, 'danger');
            }
        }
        
        window.sendTaskReminder = sendTaskReminder;
        
        function updateTaskNotificationStatus() {
            const container = document.getElementById('taskNotificationStatus');
            if (!container) return;
            
            const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
            const hasDefaultDevice = defaultWhatsAppDevice && connectedDevices.find(d => d.instanceName === defaultWhatsAppDevice);
            const taskTemplateEnabled = messageTemplates.task && messageTemplates.task.enabled;
            
            let statusHtml = '<div style="display: grid; gap: 15px;">';
            
            // Template Status
            statusHtml += `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">${taskTemplateEnabled ? '✅' : '❌'}</span>
                    <div>
                        <strong>Görev Bildirimi Şablonu:</strong> 
                        <span style="color: ${taskTemplateEnabled ? 'green' : 'red'};">
                            ${taskTemplateEnabled ? 'Etkin' : 'Devre Dışı'}
                        </span>
                        ${!taskTemplateEnabled ? '<br><small style="color: #666;">Ayarlar → Mesaj Şablonları → Görev Bildirimi</small>' : ''}
                    </div>
                </div>
            `;
            
            // Device Status
            statusHtml += `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">${hasDefaultDevice ? '✅' : connectedDevices.length > 0 ? '⚠️' : '❌'}</span>
                    <div>
                        <strong>WhatsApp Cihazı:</strong> 
                        <span style="color: ${hasDefaultDevice ? 'green' : connectedDevices.length > 0 ? 'orange' : 'red'};">
                            ${hasDefaultDevice ? `Ana hat: ${defaultWhatsAppDevice}` : connectedDevices.length > 0 ? `${connectedDevices.length} cihaz bağlı (Ana hat seçilmemiş)` : 'Bağlı cihaz yok'}
                        </span>
                        ${!hasDefaultDevice ? '<br><small style="color: #666;">Ayarlar → WhatsApp Ayarları → Ana WhatsApp Hattı</small>' : ''}
                    </div>
                </div>
            `;
            
            // User Phone Numbers (check both phoneNumber and phone fields)
            const usersWithoutPhone = users.filter(u => !u.phoneNumber && !u.phone);
            statusHtml += `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">${usersWithoutPhone.length === 0 ? '✅' : '⚠️'}</span>
                    <div>
                        <strong>Yönetici Telefon Numaraları:</strong> 
                        <span style="color: ${usersWithoutPhone.length === 0 ? 'green' : 'orange'};">
                            ${users.length - usersWithoutPhone.length}/${users.length} kayıtlı
                        </span>
                        ${usersWithoutPhone.length > 0 ? `<br><small style="color: #666;">Eksik: ${usersWithoutPhone.map(u => u.fullName).join(', ')}</small>` : ''}
                    </div>
                </div>
            `;
            
            // Overall Status
            const canSendNotifications = taskTemplateEnabled && (hasDefaultDevice || connectedDevices.length > 0);
            statusHtml += `
                <div style="padding: 15px; background: ${canSendNotifications ? '#d4edda' : '#f8d7da'}; border-radius: 8px; margin-top: 10px;">
                    <strong style="color: ${canSendNotifications ? '#155724' : '#721c24'};">
                        ${canSendNotifications ? '✅ Görev bildirimleri çalışıyor!' : '❌ Görev bildirimleri çalışmıyor'}
                    </strong>
                    ${!canSendNotifications ? '<br><small>Yukarıdaki eksiklikleri tamamlayın.</small>' : ''}
                </div>
            `;
            
            // Test Button
            if (canSendNotifications && users.length > 0) {
                statusHtml += `
                    <div style="margin-top: 10px;">
                        <button class="btn btn-warning" onclick="testTaskNotification()">🧪 Test Mesajı Gönder</button>
                        <small style="color: #666; margin-left: 10px;">Size bir test görevi mesajı gönderilecek</small>
                    </div>
                `;
            }
            
            statusHtml += '</div>';
            container.innerHTML = statusHtml;
        }
        
        window.testTaskNotification = async function() {
            if (!currentUser || !currentUser.phoneNumber) {
                return showAlert('❌ Profilinizde telefon numarası kayıtlı değil!', 'danger');
            }
            
            showAlert('📤 Test mesajı gönderiliyor...', 'info');
            
            const testTaskData = {
                taskName: 'Test Görevi',
                notes: 'Bu bir test mesajıdır. Görev bildirimleri çalışıyor!',
                createdAt: new Date().toISOString(),
                assignedTo: currentUser.email
            };
            
            const success = await sendTaskNotification(testTaskData);
            
            if (success) {
                showAlert('✅ Test mesajı gönderildi! Telefonunuzu kontrol edin.', 'success');
            } else {
                showAlert('❌ Test mesajı gönderilemedi. Ayarları kontrol edin.', 'danger');
            }
        };
        
        // --- UPDATE & INTERACTION FUNCTIONS ---
        async function updateMemberStatus(memberId, newStatus) {
            const member = members.find(m => m.id === memberId);
            if (!member) return showAlert('Üye bulunamadı.', 'danger');

            const memberGroups = groups.filter(g => Array.isArray(g.members) && g.members.includes(memberId));
            if (newStatus === 'active' && memberGroups.length === 0) {
                const proceed = confirm('Bu üye henüz bir gruba atanmamış. Yine de aktif yapmak istiyor musunuz?');
                if (!proceed) {
                    await loadData(); // Reload to revert the visual change
                return;
                }
            }

            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'members', memberId), { status: newStatus });
                showAlert('✅ Üye durumu güncellendi: ' + (newStatus === 'active' ? 'Aktif' : newStatus === 'pending' ? 'Bekliyor' : 'Pasif'), 'success');
                member.status = newStatus;
                renderCurrentSection(); // Re-render the current section to reflect changes
            } catch(e) { 
                showAlert('Üye durumu güncellenirken hata.', 'danger'); 
                await loadData();
            }
        }

        async function saveReason(recordId, newReason, cellElement) {
            // Restore the onclick listener so it can be edited again
            cellElement.setAttribute('onclick', `editReason(this, '${recordId}')`);
            
            try {
                // ✅ SUPABASE: attendanceRecords tablosunda reason güncelle
                const { error } = await supabase
                    .from('attendanceRecords')
                    .update({ reason: newReason })
                    .eq('id', recordId);
                
                if (error) {
                    console.error("Supabase update error:", error);
                    throw error;
                }
                
                // Update local data
                const recordIndex = attendanceRecords.findIndex(rec => rec.id === recordId);
                if (recordIndex > -1) {
                    attendanceRecords[recordIndex].reason = newReason;
                }
                
                // Update UI without full reload
                cellElement.innerHTML = newReason || '<i>Sebep Ekle</i>';

                showAlert('Devamsızlık sebebi güncellendi (Supabase).', 'success');
            } catch (error) {
                console.error("Error updating absence reason:", error);
                showAlert('Sebep güncellenirken bir hata oluştu: ' + error.message, 'danger');
                cellElement.innerHTML = 'Hata oluştu'; // Revert to some text
            }
        }

        async function removeMemberFromGroup(memberId, groupId) {
             showConfirmModal('Üyeyi gruptan çıkarmak istediğinize emin misiniz?', async () => {
                 closeModal('confirmModal');
                 try {
                     // 1️⃣ groups.members array'inden üyeyi çıkar
                     await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', groupId), {
                        members: window.firebase.arrayRemove(memberId)
                   });
                   console.log('✅ groups.members güncelendi (üye çıkarıldı)');
                   
                    // 2️⃣ Üyenin başka grubu var mı kontrol et
                    const remainingGroups = groups.filter(g => g.id !== groupId && Array.isArray(g.members) && g.members.includes(memberId));
                    
                    if (remainingGroups.length === 0) {
                         // Başka grubu yoksa: groupId'yi temizle ve status'u pending yap
                         await window.firebase.updateDoc(window.firebase.doc(window.db, 'members', memberId), { 
                             status: 'pending',
                             groupId: null  // ✅ groupId'yi temizle!
                         });
                         console.log('✅ members.groupId temizlendi (başka grup yok)');
                    } else {
                         // Başka grubu varsa: groupId'yi ilk gruba ayarla
                         await window.firebase.updateDoc(window.firebase.doc(window.db, 'members', memberId), { 
                             groupId: remainingGroups[0].id
                         });
                         console.log('✅ members.groupId güncellendi (başka gruba taşındı)');
                    }

                     showAlert('Üye gruptan çıkarıldı.', 'success');
                     await loadData();
                 } catch (e) { 
                     console.error('❌ Gruptan çıkarma hatası:', e);
                     showAlert('Üye gruptan çıkarılırken hata oluştu.', 'danger'); 
                 }
             });
        }

        async function confirmGroupAssignment(memberId, newGroupId, shouldRemove = false) {
            try {
                console.log('🔄 Grup ataması başlatılıyor...', { memberId, newGroupId, shouldRemove });
                
                // Önce grup verisini kontrol et
                const groupBefore = groups.find(g => g.id === newGroupId);
                console.log('📋 Grup önce:', { 
                    id: groupBefore?.id, 
                    name: groupBefore?.groupName,
                    members: groupBefore?.members
                });
                
                // Eğer TAŞI seçeneği seçildiyse, önce diğer gruplardan çıkar
                if (shouldRemove) {
                    const memberGroups = groups.filter(g => Array.isArray(g.members) && g.members.includes(memberId));
                    console.log('🔄 TAŞI seçildi - Üye şu gruplardan çıkarılacak:', 
                        memberGroups.map(g => g.groupName).join(', ') || 'Hiç grup yok'
                    );
                    
                    for (const group of memberGroups) {
                        console.log(`  → ${group.groupName} grubundan çıkarılıyor...`);
                        await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', group.id), {
                            members: window.firebase.arrayRemove(memberId)
                        });
                        console.log(`  ✅ ${group.groupName} grubundan çıkarıldı`);
                    }
                } else {
                    console.log('📌 SADECE EKLE seçildi - Mevcut gruplara dokunulmayacak');
                }
                
                // 1️⃣ groups.members array'ine üyeyi ekle
                const updateData = { members: window.firebase.arrayUnion(memberId) };
                console.log('📤 Grup güncelleniyor:', updateData);
                
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', newGroupId), updateData);
                console.log('✅ groups.members güncellendi');
                
                // 2️⃣ members.groupId alanını güncelle (ÖNEMLİ!)
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'members', memberId), { 
                    status: 'active',
                    groupId: newGroupId  // ✅ groupId'yi de güncelle!
                });
                console.log('✅ members.groupId güncellendi');
                
                showAlert(shouldRemove ? 'Üye başarıyla taşındı.' : 'Üye başarıyla gruba eklendi.', 'success');
                
                // Her iki modalı da kapat
                closeModal('choiceModal');
                closeModal('groupAssignModal');
                
                await loadData();
                
                // Sonra grup verisini kontrol et
                const groupAfter = groups.find(g => g.id === newGroupId);
                console.log('📋 Grup sonra:', { 
                    id: groupAfter?.id, 
                    name: groupAfter?.groupName,
                    members: groupAfter?.members
                });
            } catch (error) { 
                console.error('❌ Grup atama hatası:', error);
                showAlert('Gruba üye atanırken bir hata oluştu.', 'danger'); 
                console.error(error);
            }
        }
        
        function deleteSchedule(event, scheduleId) {
            event.stopPropagation();
            const text = `Bu dersi takvimden kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.`;
            showConfirmModal(text, () => executeDeleteSchedule(scheduleId));
        }

        async function executeDeleteSchedule(scheduleId) {
            closeModal('confirmModal');
            try {
                await window.firebase.deleteDoc(window.firebase.doc(window.db, 'schedules', scheduleId));
                showAlert('Ders takvimden silindi.', 'success');
                await loadData();
            } catch (error) {
                showAlert('Ders silinirken bir hata oluştu.', 'danger');
                console.error("Schedule delete error:", error);
            }
        }
        
        async function deletePaymentFromSchedule(preRegId, paymentNumber) {
            const text = `${paymentNumber}. taksiti kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.`;
            showConfirmModal(text, async () => {
                closeModal('confirmModal');
                try {
                    const preReg = preRegistrations.find(p => p.id === preRegId);
                    if (!preReg) throw new Error("Ön kayıt bulunamadı.");

                    let updatedSchedule = preReg.paymentSchedule.filter(p => p.paymentNumber !== paymentNumber);

                    // Re-number subsequent payments
                    updatedSchedule.forEach((p, index) => {
                        p.paymentNumber = index + 1;
                    });
                    
                    await window.firebase.updateDoc(window.firebase.doc(window.db, 'preRegistrations', preRegId), { paymentSchedule: updatedSchedule });
                    
                    showAlert('Taksit başarıyla silindi.', 'success');
                    await loadData();
                    
                    // ✅ İstatistikleri ve listeyi güncelle
                    if (typeof updatePaymentStats === 'function') {
                        updatePaymentStats();
                    }
                    if (typeof renderPaymentsList === 'function' && currentSection === 'payments') {
                        renderPaymentsList();
                    }
                    
                    viewPaymentPlan(preRegId);
                } catch (error) {
                    showAlert('Taksit silinirken bir hata oluştu.', 'danger');
                    console.error("Payment delete error:", error);
                }
            });
        }

         async function deleteAttendanceRecord(recordId) {
            showConfirmModal('Bu yoklama kaydını kalıcı olarak silmek istediğinizden emin misiniz?', async () => {
                closeModal('confirmModal');
                try {
                    const record = attendanceRecords.find(r => r.id === recordId);
                    if (!record) throw new Error("Kayıt bulunamadı.");
                    const memberId = record.memberId;
                    
                    // ✅ SUPABASE: attendanceRecords tablosundan sil
                    const { error } = await supabase
                        .from('attendanceRecords')
                        .delete()
                        .eq('id', recordId);
                    
                    if (error) {
                        console.error("Supabase delete error:", error);
                        throw error;
                    }
                    
                    // Remove from local array
                    attendanceRecords = attendanceRecords.filter(r => r.id !== recordId);
                    
                    showAlert('Yoklama kaydı silindi (Supabase).', 'success');
                    showMemberAttendancePage(memberId); // Refresh the view
                } catch (error) {
                    console.error("Error deleting attendance record:", error);
                    showAlert('Kayıt silinirken bir hata oluştu: ' + error.message, 'danger');
                }
            });
        }

        // --- UI & MODAL FUNCTIONS ---
        function assignToGroup(memberId, groupId = null) {
            const modalContent = document.getElementById('groupAssignContent');
            let contentHtml = '';
            
            if (memberId) { // Assign/Move a specific member
                const member = members.find(m => m.id === memberId);
                if (!member) return;
                
                document.getElementById('groupAssignTitle').textContent = `${member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad} için Grup Ata/Taşı`;
                
                const renderGroupList = (searchTerm = '') => {
                    const memberGroups = groups.filter(g => Array.isArray(g.members) && g.members.includes(memberId));
                    const memberGroupIds = memberGroups.map(g => g.id);
                    const availableGroups = groups.filter(g => {
                         const memberCount = members.filter(m => Array.isArray(g.members) && g.members.includes(m.id) && m.status !== 'expired').length;
                         return g.branch === member.Brans && 
                                !memberGroupIds.includes(g.id) &&
                                memberCount < g.maxMembers &&
                                g.groupName.toLowerCase().includes(searchTerm.toLowerCase());
                    });

                    return `<div class="group-selection-list">${availableGroups.map(g => {
                        const memberCount = members.filter(m => Array.isArray(g.members) && g.members.includes(m.id) && m.status !== 'expired').length;
                        return `<div class="group-selection-item" onclick="promptMoveOrAdd('${memberId}', '${g.id}')"><strong>${g.groupName}</strong><span>${memberCount}/${g.maxMembers}</span></div>`
                    }).join('') || '<p class="empty-state">Bu branşta atanacak uygun grup bulunmuyor.</p>'}</div>`;
                }

                contentHtml = `
                    <div class="form-group" style="margin-bottom: 15px;">
                        <input type="search" id="groupAssignSearchInput" class="form-control" placeholder="Grup adı ile ara...">
                    </div>
                    <div id="group-list-container">
                        ${renderGroupList()}
                    </div>
                `;
                 modalContent.innerHTML = contentHtml;
                 modalContent.querySelector('#groupAssignSearchInput').addEventListener('input', (e) => {
                    modalContent.querySelector('#group-list-container').innerHTML = renderGroupList(e.target.value);
                 });


            } else if (groupId) { // Add/remove members from a specific group
                const group = groups.find(g => g.id === groupId);
                if (!group) return;
                
                // 🔍 Debug: Grup üyelik durumunu göster
                console.log('🔍 assignToGroup Modal Açılıyor:', {
                    groupId: groupId,
                    groupName: group.groupName,
                    groupMembers: group.members,
                    isArray: Array.isArray(group.members),
                    memberCount: Array.isArray(group.members) ? group.members.length : 0
                });
                
                document.getElementById('groupAssignTitle').textContent = `${group.groupName} grubuna üye ekle/çıkar`;
                const unassignedMembers = members.filter(m => m.status !== 'expired' && m.Brans === group.branch && !(Array.isArray(group.members) && group.members.includes(m.id)));
                const assignedMembers = members.filter(m => Array.isArray(group.members) && group.members.includes(m.id) && m.status !== 'expired');
                
                console.log('  → Atanmamış üyeler:', unassignedMembers.length);
                console.log('  → Atanmış üyeler:', assignedMembers.length);

                contentHtml = '<h4>Gruba Ekle</h4>' + (unassignedMembers.length > 0 ? unassignedMembers.map(m =>
                     `<div class="group-selection-item" onclick="confirmGroupAssignment('${m.id}', '${groupId}')"><strong>${m.Resit_Olmayan_Adi_Soyadi || m.Ad_Soyad}</strong><span>+ Ekle</span></div>`
                ).join('') : '<p>Eklenecek üye yok.</p>');

                contentHtml += '<hr style="margin: 20px 0;"><h4>Gruptan Çıkar</h4>' + (assignedMembers.length > 0 ? assignedMembers.map(m =>
                     `<div class="group-selection-item" onclick="removeMemberFromGroup('${m.id}', '${groupId}')"><strong>${m.Resit_Olmayan_Adi_Soyadi || m.Ad_Soyad}</strong><span style="color:red;">- Çıkar</span></div>`
                ).join('') : '<p>Çıkarılacak üye yok.</p>');
                 modalContent.innerHTML = contentHtml;
            }
           
            openModal('groupAssignModal');
        }

        function togglePaymentDetails(memberId, forceOpen = false) {
            const detailsDiv = document.getElementById(`payment-details-${memberId}`);
            if (detailsDiv) {
                if(forceOpen) detailsDiv.style.display = 'block';
                else detailsDiv.style.display = detailsDiv.style.display === 'block' ? 'none' : 'block';
            }
        }
        
        function openMemberEditModal(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            // Üye adını belirle
            const memberName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad || 'İsimsiz';
            const parentName = member.Ad_Soyad || '-';
            const parentName2 = member.Veli_2_Adi_Soyadi || '-';
            const phone1 = member.Telefon || '-';
            const phone2 = member.Telefon_2 || '-';
            
            // Grubunu bul
            const memberGroups = groups.filter(g => Array.isArray(g.members) && g.members.includes(memberId));
            const groupNames = memberGroups.map(g => g.groupName).join(', ') || 'Atanmamış';
            
            // Branşını bul
            const branchName = memberGroups.length > 0 && memberGroups[0].branch 
                ? (branches.find(b => b.id === memberGroups[0].branch)?.name || 'Bilinmiyor')
                : 'Atanmamış';
            
            const html = `
                <div id="memberDetailModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <span class="close" onclick="closeMemberDetail()">&times;</span>
                        <h3>👤 ${memberName}</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">📞 Telefon 1</div>
                                <div style="font-size: 16px; font-weight: bold;">${formatPhoneDisplay(phone1)}</div>
                            </div>
                            ${phone2 !== '-' ? `
                            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">📞 Telefon 2</div>
                                <div style="font-size: 16px; font-weight: bold;">${formatPhoneDisplay(phone2)}</div>
                            </div>
                            ` : ''}
                            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">🎯 Branş</div>
                                <div style="font-size: 16px; font-weight: bold;">${branchName}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">👥 Grup</div>
                                <div style="font-size: 14px; font-weight: bold;">${groupNames}</div>
                            </div>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <div class="customer-tabs">
                                <button class="tab-button active" onclick="switchMemberTab(0)">📋 Genel Bilgiler</button>
                                <button class="tab-button" onclick="switchMemberTab(1); loadMemberCallRecords('${memberId}')">📞 Görüşme Kayıtları</button>
                            </div>
                            
                            <div class="tab-content active" style="padding: 20px; background: white; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 8px 8px;">
                                <h4 style="margin-top: 0;">👤 Üye Bilgileri</h4>
                                <div id="member-info-${memberId}" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div><strong>Öğrenci Adı:</strong> ${member.Resit_Olmayan_Adi_Soyadi || '-'}</div>
                                    ${member.studentTc ? `<div><strong>🆔 Öğrenci TC:</strong> ${member.studentTc}</div>` : '<div id="student-tc-placeholder"></div>'}
                                    ${member.Resit_Olmayan_Dogum_Tarihi ? `<div><strong>📅 Öğrenci Doğum Tarihi:</strong> ${new Date(member.Resit_Olmayan_Dogum_Tarihi).toLocaleDateString('tr-TR')}</div>` : ''}
                                    <div><strong>Veli 1:</strong> ${parentName}</div>
                                    ${member.parentTc || member.TC_Kimlik_No || member.TC_No ? `<div><strong>🆔 Veli TC:</strong> ${member.parentTc || member.TC_Kimlik_No || member.TC_No}</div>` : '<div id="parent-tc-placeholder"></div>'}
                                    ${member.DogumTarihi || member.Dogum_Tarihi ? `<div><strong>📅 Veli Doğum Tarihi:</strong> ${new Date(member.DogumTarihi || member.Dogum_Tarihi).toLocaleDateString('tr-TR')}</div>` : '<div id="parent-birth-placeholder"></div>'}
                                    <div><strong>Veli 2:</strong> ${parentName2}</div>
                                    <div><strong>Durum:</strong> ${member.status === 'active' ? '✅ Aktif' : member.status === 'expired' ? '❌ Pasif' : '⏸️ Dondurulmuş'}</div>
                                </div>
                            </div>
                            
                            <div class="tab-content" style="padding: 20px; background: white; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 8px 8px; display: none;">
                                <h4 style="margin-top: 0;">📞 Görüşme Kayıtları</h4>
                                <div id="memberCallRecords-${memberId}">
                                    <div class="loading"><div class="spinner"></div><span>Görüşme kayıtları yükleniyor...</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
                            <button class="btn btn-primary" onclick="closeMemberDetail(); openMemberEditForm('${memberId}')">✏️ Düzenle</button>
                            <button class="btn btn-secondary" onclick="closeMemberDetail()">Kapat</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Modal varsa kaldır
            const existing = document.getElementById('memberDetailModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', html);
            
            // Backdrop'a tıklayınca modalı kapat
            const modal = document.getElementById('memberDetailModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
            
            // ✅ preRegistrations'dan TC bilgilerini çek
            (async () => {
                try {
                    console.log('🔍 TC bilgileri aranıyor...', {
                        telefon: member.Telefon || member.phone,
                        clubId: currentClubId,
                        memberId: memberId
                    });
                    
                    const { data: preReg, error } = await supabase
                        .from('preRegistrations')
                        .select('studentTc, parentTc, parentBirthDate')
                        .eq('Telefon', member.Telefon || member.phone)
                        .eq('clubId', currentClubId)
                        .order('createdAt', { ascending: false })
                        .limit(1)
                        .single();
                    
                    console.log('📊 preRegistrations sorgu sonucu:', { preReg, error });
                    
                    if (!error && preReg) {
                        console.log('✅ TC bilgileri bulundu:', preReg);
                        
                        const infoDiv = document.getElementById(`member-info-${memberId}`);
                        console.log('📍 Info div:', infoDiv);
                        
                        if (infoDiv) {
                            // Öğrenci TC ekle
                            if (preReg.studentTc && !member.studentTc) {
                                const placeholder = document.getElementById('student-tc-placeholder');
                                console.log('👶 Öğrenci TC placeholder:', placeholder, 'TC:', preReg.studentTc);
                                if (placeholder) {
                                    placeholder.innerHTML = `<strong>🆔 Öğrenci TC:</strong> ${preReg.studentTc}`;
                                    console.log('✅ Öğrenci TC eklendi');
                                }
                            } else {
                                console.log('⏭️ Öğrenci TC atlandı:', { 
                                    preRegTc: preReg.studentTc, 
                                    memberTc: member.studentTc 
                                });
                            }
                            
                            // Veli TC ekle
                            if (preReg.parentTc && !member.parentTc && !member.TC_Kimlik_No) {
                                const placeholder = document.getElementById('parent-tc-placeholder');
                                console.log('👨 Veli TC placeholder:', placeholder, 'TC:', preReg.parentTc);
                                if (placeholder) {
                                    placeholder.innerHTML = `<strong>🆔 Veli TC:</strong> ${preReg.parentTc}`;
                                    console.log('✅ Veli TC eklendi');
                                }
                            } else {
                                console.log('⏭️ Veli TC atlandı:', { 
                                    preRegTc: preReg.parentTc, 
                                    memberParentTc: member.parentTc,
                                    memberTcKimlikNo: member.TC_Kimlik_No 
                                });
                            }
                            
                            // Veli Doğum Tarihi ekle
                            if (preReg.parentBirthDate && !member.DogumTarihi && !member.Dogum_Tarihi) {
                                const placeholder = document.getElementById('parent-birth-placeholder');
                                console.log('📅 Veli Doğum Tarihi placeholder:', placeholder, 'Tarih:', preReg.parentBirthDate);
                                if (placeholder) {
                                    placeholder.innerHTML = `<strong>📅 Veli Doğum Tarihi:</strong> ${new Date(preReg.parentBirthDate).toLocaleDateString('tr-TR')}`;
                                    console.log('✅ Veli Doğum Tarihi eklendi');
                                }
                            } else {
                                console.log('⏭️ Veli Doğum Tarihi atlandı:', { 
                                    preRegBirth: preReg.parentBirthDate, 
                                    memberDogumTarihi: member.DogumTarihi,
                                    memberDogum_Tarihi: member.Dogum_Tarihi 
                                });
                            }
                        }
                    } else {
                        console.warn('⚠️ preRegistration bulunamadı veya hata:', error);
                    }
                } catch (err) {
                    console.error('❌ TC bilgileri yüklenemedi:', err);
                }
            })();
        }
        
        // Üye detay modalını kapat
        window.closeMemberDetail = function() {
            const modal = document.getElementById('memberDetailModal');
            if (modal) modal.remove();
        };
        
        // Üye detay sekmelerini değiştir
        window.switchMemberTab = function(tabIndex) {
            const modal = document.getElementById('memberDetailModal');
            if (!modal) return;
            
            const tabs = modal.querySelectorAll('.tab-button');
            const contents = modal.querySelectorAll('.tab-content');
            
            tabs.forEach((btn, idx) => {
                if (idx === tabIndex) {
                    btn.classList.add('active');
                    contents[idx].style.display = 'block';
                } else {
                    btn.classList.remove('active');
                    contents[idx].style.display = 'none';
                }
            });
        };
        
        // Üye görüşme kayıtlarını yükle
        window.loadMemberCallRecords = async function(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            const container = document.getElementById(`memberCallRecords-${memberId}`);
            if (!container || container.dataset.loaded === 'true') return;
            
            // Telefon numarasını belirle - Önce Telefon, sonra Telefon_2
            const phoneNumber = member.Telefon || member.Telefon_2;
            if (!phoneNumber) {
                container.innerHTML = '<p style="color: #999;">Bu üye için telefon numarası bulunamadı.</p>';
                return;
            }
            
            await renderCallRecords(phoneNumber, `memberCallRecords-${memberId}`);
            container.dataset.loaded = 'true';
        };
        
        // Eski düzenleme formunu aç
        window.openMemberEditForm = function(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            // ✅ Branş dropdown'ını doldur
            const branchSelect = document.getElementById('memberEditBrans');
            if (branchSelect && branches) {
                branchSelect.innerHTML = '<option value="">Seçiniz...</option>' +
                    branches.map(b => `<option value="${b.name}">${b.icon} ${b.name}</option>`).join('');
            }
            
            const form = document.getElementById('memberEditForm');
            form.memberId.value = memberId;
            form.Ad_Soyad.value = member.Ad_Soyad || '';
            form.Veli_2_Adi_Soyadi.value = member.Veli_2_Adi_Soyadi || '';
            form.Telefon_2.value = member.Telefon_2 || '';
            form.Resit_Olmayan_Adi_Soyadi.value = member.Resit_Olmayan_Adi_Soyadi || '';
            form.Telefon.value = member.Telefon || '';
            
            // ✅ Öğrenci TC Kimlik No
            if (form.studentTc) {
                form.studentTc.value = member.studentTc || '';
            }
            
            // ✅ Veli TC Kimlik No
            if (form.parentTc) {
                form.parentTc.value = member.parentTc || '';
            }
            
            // ✅ Doğum tarihi (studentBirthDate veya DogumTarihi)
            const birthDate = member.studentBirthDate || member.DogumTarihi || '';
            if (birthDate) {
                // ISO formatına çevir (YYYY-MM-DD)
                const date = new Date(birthDate);
                if (!isNaN(date.getTime())) {
                    form.studentBirthDate.value = date.toISOString().split('T')[0];
                }
            } else {
                form.studentBirthDate.value = '';
            }
            
            // ✅ Branş
            form.Brans.value = member.Brans || '';
            
            // ✅ Durum
            form.status.value = member.status || 'active';
            
            openModal('memberEditModal');
        }

        function openPreRegEditModal(preRegId) {
            const reg = preRegistrations.find(p => p.id === preRegId);
            if (!reg) return showAlert('Ön kayıt bulunamadı.', 'danger');
            
            const member = members.find(m => m.preRegistrationId === preRegId);
            const isAdult = member && !member.Resit_Olmayan_Adi_Soyadi;

            const form = document.getElementById('preRegEditForm');
            form.preRegId.value = preRegId;
            form.parentName.value = reg.parentName || '';
            form.studentName.value = reg.studentName || '';
            form.branch.value = reg.branch || '';
            form.notes.value = reg.notes || '';
            
            toggleParentStudentFieldsForEdit(form, isAdult);

            // --- Group Selector Logic for Edit Modal ---
            const groupSearchInput = form.querySelector('#preRegEditGroupSearch');
            const groupHiddenInput = form.querySelector('#preRegEditGroupId');
            const groupResultsContainer = form.querySelector('#preRegEditGroupResults');
            
            // Only check groups if member exists
            if (member && member.id) {
            const memberGroups = groups.filter(g => Array.isArray(g.memberIds) && g.memberIds.includes(member.id));
            if(memberGroups.length > 0) {
                // If in multiple groups, just show one for simplicity in this UI or leave blank
                groupSearchInput.value = memberGroups[0].groupName; 
                groupHiddenInput.value = memberGroups[0].id;
                } else {
                     groupSearchInput.value = '';
                     groupHiddenInput.value = '';
                }
            } else {
                 groupSearchInput.value = '';
                 groupHiddenInput.value = '';
            }

            const availableGroups = groups.filter(g => {
                const memberCount = members.filter(m => Array.isArray(g.memberIds) && g.memberIds.includes(m.id) && m.status !== 'expired').length;
                return g.branch === reg.branch && memberCount < g.maxMembers;
            });

            groupSearchInput.oninput = () => {
                const searchTerm = groupSearchInput.value.toLowerCase();
                groupHiddenInput.value = '';
                const filtered = availableGroups.filter(g => g.groupName.toLowerCase().includes(searchTerm));
                
                groupResultsContainer.innerHTML = filtered.length > 0 ? filtered.map(g => {
                    const memberCount = members.filter(m => Array.isArray(g.members) && g.members.includes(m.id) && m.status !== 'expired').length;
                    return `<div class="searchable-select-item" data-id="${g.id}" data-name="${g.groupName}">${g.groupName} - (${memberCount}/${g.maxMembers})</div>`
                }).join('') : '<div class="searchable-select-item disabled">Sonuç bulunamadı</div>';
                groupResultsContainer.classList.add('active');
            };

            groupResultsContainer.onclick = (e) => {
                if (e.target.classList.contains('searchable-select-item') && e.target.dataset.id) {
                    groupHiddenInput.value = e.target.dataset.id;
                    groupSearchInput.value = e.target.dataset.name;
                    groupResultsContainer.classList.remove('active');
                    console.log('PreReg Edit - Group selected:', { 
                        groupId: groupHiddenInput.value, 
                        groupName: groupSearchInput.value 
                    });
                }
            };

            openModal('preRegEditModal');
        }
        
        function openGroupEditModal(groupId) {
            const group = groups.find(g => g.id === groupId);
            if(!group) return;
            const form = document.getElementById('groupForm');
            form.reset();
            
            // ✅ Branş dropdown'unu dinamik olarak güncelle
            const branchSelect = form.querySelector('[name="branch"]');
            branchSelect.innerHTML = '<option value="">Seçiniz...</option>' + 
                branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
            
            form.groupId.value = groupId;
            form.groupName.value = group.groupName;
            form.branch.value = group.branch;
            form.instructor.value = group.instructor;
            form.maxMembers.value = group.maxMembers;
            form.description.value = group.description || '';
            
            // Load existing schedule times and days for this group
            const groupSchedules = schedules.filter(s => s.groupId === groupId);
            if (groupSchedules.length > 0) {
                // Get unique days and sort them
                const scheduledDays = [...new Set(groupSchedules.map(s => s.day))];
                const checkboxes = form.querySelectorAll('input[name="days"]');
                checkboxes.forEach(cb => {
                    cb.checked = scheduledDays.includes(cb.value);
                });
                
                // Set time from first schedule (assuming all schedules have same time)
                const firstSchedule = groupSchedules[0];
                const startTimeInput = form.querySelector('[name="startTime"]');
                const endTimeInput = form.querySelector('[name="endTime"]');
                if (startTimeInput) startTimeInput.value = firstSchedule.startTime;
                if (endTimeInput) endTimeInput.value = firstSchedule.endTime;
            }
            
            document.getElementById('groupModalTitle').textContent = 'Grubu Düzenle';
            openModal('groupModal');
        }
        
        function openAttendanceModal(groupId) {
            const group = groups.find(g => g.id === groupId);
            if(!group) return;

            const modalTitle = document.getElementById('attendanceModalTitle');
            const attendanceList = document.getElementById('attendanceList');
            const form = document.getElementById('attendanceForm');

            modalTitle.textContent = `📝 ${group.groupName} - Yoklama`;
            form.groupId.value = groupId;
            form.querySelector('[name="attendanceDate"]').value = getTodayString();
            
            const groupMembers = members.filter(m => Array.isArray(group.members) && group.members.includes(m.id) && m.status === 'active');

            if(groupMembers.length === 0) {
                attendanceList.innerHTML = `<p class="empty-state">Bu grupta aktif üye bulunmuyor.</p>`;
            } else {
                attendanceList.innerHTML = groupMembers.map(m => `
                    <div class="attendance-item">
                        <label>
                            <input type="checkbox" name="presentMembers" value="${m.id}" onchange="toggleReasonInput(this, '${m.id}')" checked>
                            <span>${m.Resit_Olmayan_Adi_Soyadi || m.Ad_Soyad}</span>
                        </label>
                        <input type="text" name="reason_${m.id}" class="form-control reason-input" placeholder="Devamsızlık sebebi..." style="display:none;">
                    </div>
                `).join('');
            }
            openModal('attendanceModal');
        }
        
        function openTaskEditModal(taskId = null) {
            const form = document.getElementById('taskForm');
            form.reset();
            const modalTitle = document.getElementById('taskModalTitle');
            
            const assigneeSelect = form.querySelector('[name="assignedTo"]');
            assigneeSelect.innerHTML = users.map(u => `<option value="${u.fullName}">${u.fullName}</option>`).join('');

            if (taskId) { // Edit mode
                modalTitle.textContent = 'Görevi Düzenle';
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    form.taskId.value = task.id;
                    form.taskName.value = task.taskName;
                    form.assignedTo.value = task.assignedTo;
                    form.status.value = task.status;
                    form.notes.value = task.notes || '';
                }
            } else { // Add mode
                modalTitle.textContent = 'Yeni Görev Ekle';
                form.taskId.value = '';
            }
            openModal('taskModal');
        }

        function openProfileEditModal() {
            const form = document.getElementById('profileForm');
            form.reset();
            form.fullName.value = currentUser.fullName;
            form.phone.value = currentUser.phone || currentUser.phoneNumber || '';
            openModal('profileModal');
        }
        
        // --- DRAG & DROP FUNCTIONS ---
        function drag(ev, id, isGroup) { 
            ev.dataTransfer.setData("id", id);
            ev.dataTransfer.setData("isGroup", isGroup);
        }
        function allowDrop(ev) { 
            ev.preventDefault();
            ev.currentTarget.classList.add('drag-over');
            ev.currentTarget.addEventListener('dragleave', () => ev.currentTarget.classList.remove('drag-over'), { once: true });
        }
        async function drop(ev, day) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            const id = ev.dataTransfer.getData("id");
            const isGroup = ev.dataTransfer.getData("isGroup") === 'true';
            
            if (isGroup) {
                openScheduleModalForGroup(id, day);
            }
        }

        // ✅ Mevcut schedule'ı düzenle (saha bilgisi ekle/güncelle)
        window.editScheduleCourt = async function(scheduleId) {
            const schedule = schedules.find(s => s.id === scheduleId);
            if (!schedule) return;
            
            const group = groups.find(g => g.id === schedule.groupId);
            if (!group) return;
            
            const branchInfo = branches.find(b => b.id === schedule.branch);
            if (!branchInfo || !branchInfo.courts || branchInfo.courts.length === 0) {
                return showAlert('Bu branşta saha tanımlı değil.', 'warning');
            }
            
            const courtOptions = branchInfo.courts.map((c, idx) => `${idx + 1}. ${c.name}`).join('\n');
            const currentCourt = schedule.court ? `\n\nMevcut saha: ${schedule.court}` : '';
            const courtChoice = prompt(`Saha seçin:${currentCourt}\n\n${courtOptions}\n\nSaha numarasını girin (0 = saha kaldır):`);
            
            if (courtChoice === null) return; // İptal
            
            let newCourt = null;
            if (courtChoice !== '0' && courtChoice !== '') {
                const courtIndex = parseInt(courtChoice) - 1;
                if (courtIndex >= 0 && courtIndex < branchInfo.courts.length) {
                    newCourt = branchInfo.courts[courtIndex].name;
                }
            }
            
            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'schedules', scheduleId), {
                    court: newCourt
                });
                showAlert(`✅ Saha bilgisi ${newCourt ? `"${newCourt}" olarak` : ''} güncellendi`, 'success');
                await loadData();
            } catch (error) {
                console.error('Error updating court:', error);
                showAlert('❌ Saha güncellenirken hata oluştu', 'danger');
            }
        }

        function openScheduleModalForGroup(groupId, day = null) {
            const group = groups.find(g => g.id === groupId);
            if (!group) {
                console.log('❌ Grup bulunamadı:', groupId);
                return;
            }
            
            console.log('🔵 openScheduleModalForGroup çağrıldı:', group.groupName, 'Branş:', group.branch);
            
            const form = document.getElementById('newScheduleForm');
            if (!form) return;
            
            form.reset();
            
            // Grup bilgilerini doldur
            form.querySelector('[name="groupId"]').value = groupId;
            form.querySelector('[name="groupName"]').value = group.groupName;
            
            // ✅ Branş bilgisini bul ve saha dropdown'unu hazırla
            const branchInfo = branches.find(b => b.id === group.branch);
            console.log('📌 Branş bilgisi:', branchInfo);
            console.log('📍 Sahalar:', branchInfo?.courts);
            
            const courtSelectContainer = document.getElementById('courtSelectContainer');
            const courtSelect = document.getElementById('courtSelect');
            
            if (branchInfo && branchInfo.courts && branchInfo.courts.length > 0) {
                console.log('✅ Sahalar mevcut, dropdown gösteriliyor...');
                // Saha dropdown'unu doldur
                courtSelect.innerHTML = '<option value="">Saha Seçiniz (opsiyonel)</option>' + 
                    branchInfo.courts.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                
                // ✅ Eğer bir saha seçiliyse, onu otomatik seç
                if (selectedCourtForSchedule) {
                    courtSelect.value = selectedCourtForSchedule;
                }
                
                courtSelectContainer.style.display = 'block';
            } else {
                console.log('⚠️ Bu branşta saha yok');
                courtSelectContainer.style.display = 'none';
            }
            
            // Mevcut schedule'ları kontrol et ve formda göster
            const groupSchedules = schedules.filter(s => s.groupId === groupId);
            if (groupSchedules.length > 0) {
                // Mevcut günleri işaretle
                const scheduledDays = [...new Set(groupSchedules.map(s => s.day))];
                const checkboxes = form.querySelectorAll('input[name="days"]');
                checkboxes.forEach(cb => {
                    cb.checked = scheduledDays.includes(cb.value);
                });
                
                // Mevcut saatleri doldur
                const firstSchedule = groupSchedules[0];
                form.querySelector('[name="startTime"]').value = firstSchedule.startTime;
                form.querySelector('[name="endTime"]').value = firstSchedule.endTime;
                
                // Mevcut sahayı seç
                if (firstSchedule.court && courtSelect) {
                    courtSelect.value = firstSchedule.court;
                }
            } else if (day) {
                // Belirli bir güne sürüklenirse o günü işaretle
                const checkboxes = form.querySelectorAll('input[name="days"]');
                checkboxes.forEach(cb => {
                    cb.checked = cb.value === day;
                });
            }

            // Modal'ı aç
            openModal('scheduleModal');
        }
        
        function showMembers(event, groupId) {
            const tooltip = document.getElementById('member-tooltip');
            const group = groups.find(g => g.id === groupId);
            if (!group || !group.members || group.members.length === 0) {
                tooltip.innerHTML = 'Bu grupta üye yok.';
            } else {
                const memberNames = group.members.map(mid => members.find(m => m.id === mid)?.Ad_Soyad || 'Bilinmeyen Üye');
                tooltip.innerHTML = `<ul><li>${memberNames.join('</li><li>')}</li></ul>`;
            }
            tooltip.style.display = 'block';
            tooltip.style.left = `${event.pageX + 15}px`;
            tooltip.style.top = `${event.pageY + 15}px`;
        }
        function hideMembers() { document.getElementById('member-tooltip').style.display = 'none'; }
        
        // --- OTHER UI FUNCTIONS ---
        function applyRolePermissions() {
             // Ayarlar menüsü artık tüm kulüpler için görünür
             // SuperAdmin kontrolü kaldırıldı
             
             // ✅ Admin kullanıcıları tüm izinlere sahip
             if (currentUser && currentUser.role === 'admin') {
                 console.log('✅ Admin kullanıcısı - tüm izinler verildi');
                 return; // Adminler için hiçbir kısıtlama yok
             }
             
             // Permissions kontrolü - eğer permissions yoksa varsayılan olarak hepsine izin ver
             if (!currentUser || !currentUser.permissions) {
                 console.log('⚠️ User permissions bulunamadı, varsayılan izinler uygulanıyor');
                 return;
             }
             
             // ✅ SAYFA ERİŞİM KONTROLÜ - Menü öğelerini gizle
             const pageAccess = currentUser.pageAccess || {}; // pageAccess yoksa boş obje (tümüne erişim var)
             
             console.log('🔐 Sayfa erişim kontrolleri:', {
                 pageAccess: pageAccess,
                 paymentsAccess: pageAccess.payments,
                 settingsAccess: pageAccess.settings
             });
             
             // Members/Üyeler
             if (pageAccess.members === false) {
                 const membersDropdown = document.querySelector('.nav-dropdown .dropdown-content');
                 if (membersDropdown) {
                     membersDropdown.querySelectorAll('[onclick*="members"]').forEach(btn => btn.style.display = 'none');
                     membersDropdown.querySelectorAll('[onclick*="registration-procedures"]').forEach(btn => btn.style.display = 'none');
                     membersDropdown.querySelectorAll('[onclick*="inactive-members"]').forEach(btn => btn.style.display = 'none');
                     membersDropdown.querySelectorAll('[onclick*="pending-members"]').forEach(btn => btn.style.display = 'none');
                 }
             }
             
             // Payments/Ödemeler (Aidatlar)
             if (pageAccess.payments === false) {
                 document.querySelectorAll('.nav-btn').forEach(btn => {
                     const onclick = btn.getAttribute('onclick');
                     if (onclick && onclick.includes("'payments'")) {
                         btn.style.display = 'none';
                     }
                 });
             }
             
             // CRM
             if (pageAccess.crm === false) {
                 const crmDropdown = document.getElementById('crm-menu-dropdown');
                 if (crmDropdown) crmDropdown.style.display = 'none';
             }
             
             // Settings/Ayarlar
             if (pageAccess.settings === false) {
                 document.querySelectorAll('.nav-btn').forEach(btn => {
                     const onclick = btn.getAttribute('onclick');
                     if (onclick && onclick.includes("'settings'")) {
                         btn.style.display = 'none';
                     }
                 });
             }
             
             // Messages/WhatsApp
             if (pageAccess.messages === false) {
                 document.querySelectorAll('.nav-dropdown').forEach(dropdown => {
                     const toggleBtn = dropdown.querySelector('.dropdown-toggle .nav-text');
                     if (toggleBtn && toggleBtn.textContent.includes('WhatsApp')) {
                         dropdown.style.display = 'none';
                     }
                 });
             }
             
             // Reports/Raporlar
             if (pageAccess.reports === false) {
                 document.querySelectorAll('[onclick*="reports"]').forEach(btn => {
                     if (btn.classList.contains('nav-btn')) {
                         btn.style.display = 'none';
                     }
                 });
             }
             
             // Attendance/Yoklama
             if (pageAccess.attendance === false) {
                 document.querySelectorAll('[onclick*="attendance"]').forEach(btn => {
                     if (btn.classList.contains('nav-btn')) {
                         btn.style.display = 'none';
                     }
                 });
             }
             
             // Schedule/Takvim
             if (pageAccess.schedule === false) {
                 document.querySelectorAll('[onclick*="schedule"]').forEach(btn => {
                     if (btn.classList.contains('nav-btn') || btn.classList.contains('sub-item')) {
                         btn.style.display = 'none';
                     }
                 });
             }

             // ⚠️ ESKİ PERMİSSİONS SİSTEMİ - Sadece pageAccess yoksa kullan
             if (!currentUser.pageAccess) {
                 // Legacy permissions fallback
                 if (!currentUser?.permissions?.view_payments) {
                      const paymentsBtn = document.querySelector('.nav-btn[onclick*="payments"]');
                      if (paymentsBtn) paymentsBtn.style.display = 'none';
                 }

                 if (currentUser.permissions && !currentUser.permissions.view_stats) {
                    const paymentStats = document.getElementById('payment-stats');
                    if(paymentStats) paymentStats.style.display = 'none';
                    
                    const monthlyRevenueCard = document.getElementById('monthlyRevenue');
                    if(monthlyRevenueCard) monthlyRevenueCard.closest('.stat-card').style.display = 'none';
                 }
                 
                 if (currentUser.permissions && !currentUser.permissions.manage_users) {
                      document.getElementById('user-management-card').style.display = 'none';
                 }
             }
        }
        
        function updateDashboard() {
            // ✅ BRANŞ FİLTRESİ: Sadece yetkili branşların istatistiklerini göster
            const filteredMembers = filterByBranch(members, 'Brans');
            const filteredPreRegs = filterByBranch(preRegistrations, 'branch');
            
            console.log('📊 Dashboard Filtreleme:', {
                totalMembers: members.length,
                filteredMembers: filteredMembers.length,
                totalPreRegs: preRegistrations.length,
                filteredPreRegs: filteredPreRegs.length,
                userBranches: currentUser?.branches
            });
            
            // ✅ Sayıları hemen göster (veri yoksa 0)
            document.getElementById('totalMembers').textContent = filteredMembers.length;
            document.getElementById('activeMembers').textContent = filteredMembers.filter(m => m.status === 'active').length;
            document.getElementById('inactiveMembers').textContent = filteredMembers.filter(m => m.status === 'expired').length;
            
            // ✅ BRANŞ FİLTRESİ: Bekleyen kayıtlar sayacı members tablosundan gelsin (Bekleyen Kayıtlar sayfasıyla tutarlı olsun)
            const pendingMembersCount = filteredMembers.filter(m => m.status === 'pending').length;
            document.getElementById('pendingRegistrations').textContent = pendingMembersCount;
            
            console.log('📊 Bekleyen Kayıtlar:', {
                pendingMembersCount,
                pendingMembers: filteredMembers.filter(m => m.status === 'pending').map(m => ({ branch: m.Brans, name: m.Ad_Soyad, phone: m.Telefon }))
            });
            
            // Bekleyen ön kayıtlar (pending_contract durumundaki preRegistrations) - sadece log için
            const pendingPreRegs = filteredPreRegs.filter(p => {
                if (p.status !== 'pending_contract') return false;
                
                // Bu preReg'e ait member var mı kontrol et (SADECE filtrelenmiş üyeler arasında ara)
                const member = filteredMembers.find(m => 
                    m.preRegistrationId === p.id || 
                    (m.Telefon && p.phone && m.Telefon.replace(/\D/g, '').replace(/^0/, '') === p.phone.replace(/\D/g, '').replace(/^0/, ''))
                );
                
                // Eğer üye aktif veya pasif ise gösterme
                if (member && (member.status === 'active' || member.status === 'expired')) {
                    return false;
                }
                
                // Eğer member pasif/aktif değilse ama pending ise göster
                return true;
            });
            
            console.log('📊 Bekleyen Ön Kayıtlar (sadece log):', {
                totalPending: preRegistrations.filter(p => p.status === 'pending_contract').length,
                filteredPending: pendingPreRegs.length,
                pendingBranches: pendingPreRegs.map(p => p.branch),
                pendingDetails: pendingPreRegs.map(p => ({ branch: p.branch, name: p.parentName || p.studentName, phone: p.phone }))
            });
            
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const prevMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            
            let currentMonthRevenue = 0, previousMonthRevenue = 0;

            // ✅ BRANŞ FİLTRESİ: Sadece yetkili branşların gelirlerini hesapla
            filteredPreRegs.forEach(preReg => {
                if (preReg.paymentSchedule) {
                    preReg.paymentSchedule.forEach(p => {
                        if (p.status === 'paid' && p.paymentDate) {
                            const paymentDate = new Date(p.paymentDate);
                            if (paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear) {
                                currentMonthRevenue += p.amount;
                            } else if (paymentDate.getMonth() === prevMonth && paymentDate.getFullYear() === prevMonthYear) {
                                previousMonthRevenue += p.amount;
                            }
                        }
                    });
                }
            });

            document.getElementById('monthlyRevenue').textContent = currentMonthRevenue.toLocaleString('tr-TR') + '₺';
            const comparisonEl = document.getElementById('revenueComparison');
            if (previousMonthRevenue > 0) {
                const percentChange = ((currentMonthRevenue - previousMonthRevenue) / previousMonthRevenue) * 100;
                comparisonEl.textContent = `${percentChange >= 0 ? '▲' : '▼'} ${Math.abs(percentChange).toFixed(1)}% (Önceki Ay)`;
                comparisonEl.className = `stat-comparison ${percentChange >= 0 ? 'increase' : 'decrease'}`;
            } else {
                comparisonEl.textContent = 'Önceki ay veri yok';
                 comparisonEl.className = 'stat-comparison';
            }
            
            // Dashboard tutarlarını maskele (eğer gizli ise)
            setTimeout(() => applyDashboardAmountsVisibility(), 50);
            
            renderAbsentStudents();
            renderUpcomingBirthdays();
            // renderKayitOlabilirReminders(); // ❌ Kaldırıldı - CRM Dashboard'da var
            // renderDenemeGelecekReminders(); // ❌ Kaldırıldı - CRM Dashboard'da var
        }

        function updatePaymentStats() {
            // ✅ Veriler henüz yüklenmemişse skip et
            if (!members || members.length === 0 || !preRegistrations || preRegistrations.length === 0) {
                console.log('⏸️ updatePaymentStats atlandı - veriler henüz yüklenmedi');
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            console.log('📅 Mevcut Ay Bilgisi:', {
                'Ay': currentMonth + 1,
                'Yıl': currentYear,
                'Tarih': today.toLocaleDateString('tr-TR')
            });

            let totalPaidThisMonth = 0;
            let pendingThisMonth = 0;
            let paidPaymentsThisMonth = [];

            // Önce branş filtreleme yap
            const filteredMembersForPayments = filterByBranch(members, 'Brans');
            
            // Sadece aktif/pending ve preReg'i olan üyeler
            const activeMembers = filteredMembersForPayments.filter(m => {
                if (m.status !== 'active' && m.status !== 'pending') return false;
                if (!m.preRegistrationId) return false;
                const preReg = preRegistrations.find(p => p.id === m.preRegistrationId);
                return preReg && preReg.paymentSchedule && preReg.paymentSchedule.length > 0;
            });

            console.log('👥 Aktif Üye Sayısı (Filtrelenmiş):', activeMembers.length, 'Branş:', currentUser?.branches);

            activeMembers.forEach(member => {
                const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                if (!preReg || !preReg.paymentSchedule) return;

                preReg.paymentSchedule.forEach(p => {
                    const dueDate = new Date(p.dueDate + 'T00:00:00');

                    // Bu ay ödenen ödemeler
                    if (p.status === 'paid' && p.paymentDate) {
                        // Tarih parse etme - YYYY-MM-DD formatı için T00:00:00 ekle
                        let paymentDateStr = p.paymentDate;
                        if (paymentDateStr.length === 10 && paymentDateStr.includes('-')) {
                            paymentDateStr += 'T00:00:00';
                        }
                        const paymentDate = new Date(paymentDateStr);
                        
                        const paymentMonth = paymentDate.getMonth();
                        const paymentYear = paymentDate.getFullYear();
                        
                        if (paymentMonth === currentMonth && paymentYear === currentYear) {
                            totalPaidThisMonth += (p.amount || 0);
                            paidPaymentsThisMonth.push({
                                member: member.Ad_Soyad,
                                amount: p.amount,
                                date: p.paymentDate,
                                parsedDate: paymentDate.toLocaleDateString('tr-TR'),
                                month: paymentMonth + 1,
                                year: paymentYear
                            });
                        }
                    }

                    // Bu ay vadesi gelen ödemeler (ödenmemiş)
                    if (p.status === 'unpaid') {
                        const isDueThisMonth = dueDate.getMonth() === currentMonth && dueDate.getFullYear() === currentYear;
                        if (isDueThisMonth) {
                            pendingThisMonth += p.amount;
                        }
                    }
                });
            });

            console.log('💰 [AİDATLAR SEKMESİ] Bu Ay Ödenen Detay:', {
                'Toplam': totalPaidThisMonth.toLocaleString('tr-TR') + '₺',
                'Ödeme Sayısı': paidPaymentsThisMonth.length,
                'Aranan Ay': currentMonth + 1,
                'Aranan Yıl': currentYear,
                'Ödemeler': paidPaymentsThisMonth
            });
            
            // Tüm paid ödemeleri de görelim
            let allPaidPayments = [];
            activeMembers.forEach(member => {
                const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                if (!preReg || !preReg.paymentSchedule) return;
                
                preReg.paymentSchedule.forEach(p => {
                    if (p.status === 'paid' && p.paymentDate) {
                        let paymentDateStr = p.paymentDate;
                        if (paymentDateStr.length === 10 && paymentDateStr.includes('-')) {
                            paymentDateStr += 'T00:00:00';
                        }
                        const paymentDate = new Date(paymentDateStr);
                        
                        allPaidPayments.push({
                            member: member.Ad_Soyad,
                            amount: p.amount,
                            date: p.paymentDate,
                            month: paymentDate.getMonth() + 1,
                            year: paymentDate.getFullYear()
                        });
                    }
                });
            });
            
            console.log('📋 Tüm Ödenen Ödemeler:', allPaidPayments);

            const totalCiro = totalPaidThisMonth + pendingThisMonth;

            const totalRevenueText = totalCiro.toLocaleString('tr-TR') + '₺';
            const totalPaidText = totalPaidThisMonth.toLocaleString('tr-TR') + '₺';
            const totalUnpaidText = pendingThisMonth.toLocaleString('tr-TR') + '₺';
            
            console.log('🔧 DOM güncellenecek:', {
                totalRevenue: totalRevenueText,
                totalPaid: totalPaidText,
                totalUnpaid: totalUnpaidText
            });
            
            document.getElementById('totalRevenue').textContent = totalRevenueText;
            document.getElementById('totalPaid').textContent = totalPaidText;
            document.getElementById('totalUnpaid').textContent = totalUnpaidText;
            
            console.log('✅ DOM güncellendi - kontrol:', document.getElementById('totalPaid').textContent);


            // Gecikmiş ödemeler - hem sayı hem tutar
            let overdueInstallmentCount = 0;
            let overdueAmount = 0;
            const membersWithOverdue = new Set();
            let overdueDetails = [];
            
            // Yukarıda tanımlanan activeMembers kullan
            activeMembers.forEach(m => {
                const preReg = preRegistrations.find(p => p.id === m.preRegistrationId);
                if (!preReg || !preReg.paymentSchedule) return;
                
                let memberHasOverdue = false;
                let memberOverdueCount = 0;
                let memberOverdueAmount = 0;
                
                preReg.paymentSchedule.forEach(p => {
                    if (p.status === 'unpaid' && new Date(p.dueDate + 'T00:00:00') < today) {
                        overdueInstallmentCount++;
                        overdueAmount += p.amount || 0;
                        memberOverdueCount++;
                        memberOverdueAmount += p.amount || 0;
                        memberHasOverdue = true;
                    }
                });
                
                if (memberHasOverdue) {
                    membersWithOverdue.add(m.id);
                    overdueDetails.push({
                        name: m.Ad_Soyad,
                        count: memberOverdueCount,
                        amount: memberOverdueAmount
                    });
                }
            });
            
            const overdueMemberCount = membersWithOverdue.size;
            
            console.log('💰 [İSTATİSTİK] Gecikmiş Ödeme İstatistikleri:', {
                'Aktif Üye Sayısı': activeMembers.length,
                'Gecikmesi Olan Üye Sayısı': overdueMemberCount,
                'Taksit Sayısı': overdueInstallmentCount,
                'Toplam Tutar': overdueAmount.toLocaleString('tr-TR') + '₺',
                'Üye İsimleri': overdueDetails.map(d => d.name),
                'Detaylar': overdueDetails
            });
            
            // Buton metninde üye sayısını göster
            document.getElementById('overdue-count').textContent = `(${overdueMemberCount})`;
            
            // Gecikmiş ödemeler istatistiklerini güncelle
            const overdueAmountEl = document.getElementById('overdue-total-amount');
            const overdueMemberCountEl = document.getElementById('overdue-member-count');
            if (overdueAmountEl) {
                const overdueAmountText = overdueAmount.toLocaleString('tr-TR') + '₺';
                overdueAmountEl.textContent = overdueAmountText;
                overdueAmountEl.dataset.originalValue = overdueAmountText; // ✅ Maskeleme için güncelle
            }
            if (overdueMemberCountEl) {
                overdueMemberCountEl.textContent = overdueMemberCount;
                overdueMemberCountEl.dataset.originalValue = overdueMemberCount.toString(); // ✅ Maskeleme için güncelle
            }
            
            // Planı bitenler - sadece preReg'i ve paymentSchedule'ı olan aktif/pending üyeler
            const finishedCount = activeMembers.filter(member => {
                const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                return preReg && preReg.paymentSchedule && preReg.paymentSchedule.length > 0 && preReg.paymentSchedule.every(p => p.status === 'paid');
            }).length;
            document.getElementById('finished-count').textContent = `(${finishedCount})`;
            
            // Ödeme tutarlarını maskele (eğer gizli ise) - titreme önleme için animasyon frame kullan
            requestAnimationFrame(() => applyPaymentVisibility());
        }

        function renderAbsentStudents() {
            const container = document.getElementById('absentStudentsList');
            if(!container) return;
            
            // 🚀 Veriler boşsa bilgi mesajı göster (yeni kulüpte veri olmayabilir)
            if (!members || members.length === 0 || !attendanceRecords || attendanceRecords.length === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">Henüz devamsızlık kaydı yok ✅</p></div>';
                return;
            }
            
            // ✅ BRANŞ FİLTRESİ: Önce üyeleri filtrele
            const filteredMembers = filterByBranch(members, 'Brans');
            
            // ✅ Sadece aktif ve yetkili branşların üyelerine ait devamsızlıkları göster
            const allAbsences = attendanceRecords
                .filter(rec => {
                    if (rec.status !== 'absent') return false;
                    const member = filteredMembers.find(m => m.id === rec.memberId);
                    return member && member.status === 'active'; // Sadece aktif ve yetkili branş üyeleri
                })
                .sort((a, b) => new Date(b.date) - new Date(a.date));
                
            const displayAbsences = allAbsences.slice(0, 10);

            if (displayAbsences.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>Son zamanlarda devamsızlık yapan öğrenci bulunmuyor.</p></div>`;
                return;
            }
            
            let html = displayAbsences.map(absence => {
                const member = filteredMembers.find(m => m.id === absence.memberId);
                if (!member) return ''; // Güvenlik kontrolü
                
                const memberName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad || 'İsimsiz';
                const phone = member.Telefon || 'Telefon yok';
                const dateStr = formatDate(absence.date);
                const reasonText = absence.reason ? absence.reason : '<i style="color: #999;">Sebep belirtilmedi</i>';
                
                return `
                    <div class="absence-item" onclick="showMemberAttendancePage('${member.id}')" style="cursor: pointer;">
                        <div>
                            <strong>${memberName}</strong><br>
                            <small style="color: #666;">📞 ${phone} • 📅 ${dateStr}</small>
                        </div>
                        <div class="absence-reason">
                            ${reasonText}
                        </div>
                    </div>
                `;
            }).filter(html => html !== '').join(''); // Boş HTML'leri filtrele
            
            if (allAbsences.length > 10) {
                html += `<div style="text-align: center; padding: 15px;">
                    <button class="btn btn-primary btn-sm" onclick="showSection('attendance-tracking', document.querySelector('.nav-btn[onclick*=attendance]'))">Tüm Devamsızlıkları Göster (${allAbsences.length})</button>
                </div>`;
            }
            
            container.innerHTML = html || `<div class="empty-state"><p>Son zamanlarda devamsızlık yapan öğrenci bulunmuyor.</p></div>`;
        }
        
        function renderUpcomingBirthdays() {
            const container = document.getElementById('upcomingBirthdaysList');
            if(!container) return;
            
            // 🚀 Veriler boşsa bilgi mesajı göster (yeni kulüpte üye olmayabilir)
            if (!members || members.length === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">Henüz üye kaydı yok</p></div>';
                return;
            }
            
            // ✅ BRANŞ FİLTRESİ: Sadece yetkili branşların üyelerini kullan
            const filteredMembers = filterByBranch(members, 'Brans');

            const today = new Date();
            today.setHours(0,0,0,0);
            const upcomingLimit = new Date();
            upcomingLimit.setDate(today.getDate() + 30); // Next 30 days

            let birthdayList = [];
            
            filteredMembers.forEach(m => {
                // ✅ Öğrenci doğum günü
                if (m.studentBirthDate) {
                    const birthDate = new Date(m.studentBirthDate);
                    let nextBirthday = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());
                    if (nextBirthday < today) {
                        nextBirthday.setFullYear(today.getFullYear() + 1);
                    }
                    if (nextBirthday >= today && nextBirthday <= upcomingLimit) {
                        birthdayList.push({
                            member: m,
                            nextBirthday: nextBirthday,
                            birthDate: m.studentBirthDate,
                            name: m.Resit_Olmayan_Adi_Soyadi || m.Ad_Soyad,
                            type: m.Resit_Olmayan_Adi_Soyadi ? 'Öğrenci' : 'Üye'
                        });
                    }
                }
                
                // ✅ Veli doğum günü (kayit.html'den gelen Dogum_Tarihi alanı)
                if (m.Dogum_Tarihi && m.Resit_Olmayan_Adi_Soyadi) {
                    // Sadece çocuk kaydıysa veli doğum günü ekle
                    const birthDate = new Date(m.Dogum_Tarihi);
                    let nextBirthday = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());
                    if (nextBirthday < today) {
                        nextBirthday.setFullYear(today.getFullYear() + 1);
                    }
                    if (nextBirthday >= today && nextBirthday <= upcomingLimit) {
                        birthdayList.push({
                            member: m,
                            nextBirthday: nextBirthday,
                            birthDate: m.Dogum_Tarihi,
                            name: m.Ad_Soyad,
                            studentName: m.Resit_Olmayan_Adi_Soyadi,
                            type: 'Veli'
                        });
                    }
                }
            });

            birthdayList.sort((a, b) => a.nextBirthday - b.nextBirthday);

            if (birthdayList.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>Yaklaşan doğum günü bulunmuyor.</p></div>`;
                return;
            }

            container.innerHTML = birthdayList.map(item => {
                const formattedDate = item.nextBirthday.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' });
                const age = calculateAge(item.birthDate) + 1;
                const isToday = item.nextBirthday.getDate() === today.getDate() && item.nextBirthday.getMonth() === today.getMonth();
                const sendButton = isToday ? `<button class="btn btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-left: 10px; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;" onclick="sendBirthdayMessage('${item.member.id}')">🎂 Mesaj Gönder</button>` : '';
                
                // ✅ Veli için özel badge ve detay
                let typeBadge, nameDisplay;
                if (item.type === 'Veli') {
                    typeBadge = '<span style="background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%); color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 8px;">👨‍👩‍👧 VELİ</span>';
                    nameDisplay = `<strong>${item.name}</strong>${typeBadge}<br><small style="color: #888; font-size: 12px;">👶 Öğrenci: ${item.studentName || 'Belirtilmemiş'}</small>`;
                } else if (item.type === 'Öğrenci') {
                    typeBadge = '<span style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 8px;">👶 ÖĞRENCİ</span>';
                    nameDisplay = `<strong>${item.name}</strong>${typeBadge}`;
                } else {
                    typeBadge = '<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 8px;">👤 ÜYE</span>';
                    nameDisplay = `<strong>${item.name}</strong>${typeBadge}`;
                }

                return `
                    <div class="birthday-item">
                        <div>
                            ${nameDisplay}${isToday ? ' <span style="color: #667eea; font-weight: bold;">🎂 BUGÜN!</span>' : ''}<br>
                            <small>${formattedDate} tarihinde ${age}. yaşına girecek.</small>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${sendButton}
                        <div class="birthday-icon">🎉</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Kayıt Olabilir hatırlatmalarını göster
        function renderKayitOlabilirReminders() {
            const container = document.getElementById('kayitOlabilirList');
            if (!container) {
                console.log('❌ kayitOlabilirList container bulunamadı!');
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const weekLater = new Date(today);
            weekLater.setDate(today.getDate() + 7);
            
            console.log('📅 renderKayitOlabilirReminders çağrıldı, crmLeads:', crmLeads.length);
            
            // Kayıt Olabilir etiketine sahip ve tarihi yaklaşan branşlar
            const reminders = [];
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(branchData => {
                        if (branchData.selectedTag === 'Kayıt Olabilir' && branchData.kayitOlabilirDate) {
                            const reminderDate = new Date(branchData.kayitOlabilirDate);
                            if (reminderDate >= today && reminderDate <= weekLater) {
                                reminders.push({
                                    lead,
                                    branchData,
                                    date: reminderDate
                                });
                            }
                        }
                    });
                }
            });
            
            console.log('📅 Bulunan Kayıt Olabilir hatırlatması:', reminders.length);
            
            reminders.sort((a, b) => a.date - b.date);
            
            if (reminders.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>Yaklaşan kayıt hatırlatması yok</p></div>`;
                return;
            }
            
            container.innerHTML = reminders.map(({lead, branchData, date}) => {
                const isToday = date.getDate() === today.getDate() && 
                               date.getMonth() === today.getMonth() && 
                               date.getFullYear() === today.getFullYear();
                
                const formattedDate = date.toLocaleString('tr-TR', {
                    day: 'numeric',
                    month: 'long',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const branch = branches.find(b => b.id === branchData.branchId);
                const branchText = branch ? `${branch.icon} ${branch.name}` : '';
                
                return `
                    <div class="birthday-item" style="cursor: pointer;" onclick="openCustomerDetail('${lead.id}')">
                        <div>
                            <strong>${lead.fullName}</strong>${isToday ? ' <span style="color: #667eea; font-weight: bold;">📅 BUGÜN!</span>' : ''}<br>
                            <small>${formattedDate} - ${branchText}</small><br>
                            <small style="color: #666;">📞 ${lead.phone}</small>
                        </div>
                        <div class="birthday-icon">📞</div>
                    </div>
                `;
            }).join('');
        }
        
        // Denemeye Gelecek hatırlatmalarını göster
        function renderDenemeGelecekReminders() {
            const container = document.getElementById('denemeGelecekList');
            if (!container) {
                console.log('❌ denemeGelecekList container bulunamadı!');
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const weekLater = new Date(today);
            weekLater.setDate(today.getDate() + 7);
            
            console.log('🎾 renderDenemeGelecekReminders çağrıldı, crmLeads:', crmLeads.length);
            
            // Denemeye Gelecek etiketine sahip ve tarihi yaklaşan branşlar
            const reminders = [];
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(branchData => {
                        if (branchData.selectedTag === 'Denemeye Gelecek' && branchData.denemeDate) {
                            const denemeDate = new Date(branchData.denemeDate);
                            if (denemeDate >= today && denemeDate <= weekLater) {
                                reminders.push({
                                    lead,
                                    branchData,
                                    date: denemeDate
                                });
                            }
                        }
                    });
                }
            });
            
            console.log('🎾 Bulunan Denemeye Gelecek hatırlatması:', reminders.length);
            
            reminders.sort((a, b) => a.date - b.date);
            
            if (reminders.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>Yaklaşan deneme dersi yok</p></div>`;
                return;
            }
            
            container.innerHTML = reminders.map(({lead, branchData, date}) => {
                const isToday = date.getDate() === today.getDate() && 
                               date.getMonth() === today.getMonth() && 
                               date.getFullYear() === today.getFullYear();
                
                const formattedDate = date.toLocaleString('tr-TR', {
                    day: 'numeric',
                    month: 'long',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const branch = branches.find(b => b.id === branchData.branchId);
                const branchText = branch ? `${branch.icon} ${branch.name}` : '';
                
                return `
                    <div class="birthday-item" style="cursor: pointer;" onclick="openCustomerDetail('${lead.id}')">
                        <div>
                            <strong>${lead.fullName}</strong>${isToday ? ' <span style="color: #f093fb; font-weight: bold;">🎾 BUGÜN!</span>' : ''}<br>
                            <small>${formattedDate} - ${branchText}</small><br>
                            <small style="color: #666;">📞 ${lead.phone}</small>
                        </div>
                        <div class="birthday-icon">🎾</div>
                    </div>
                `;
            }).join('');
        }
        
        function openModal(modalId) { 
            const modal = document.getElementById(modalId);
            modal.style.display = 'block';
            
            // Modal overlay'e tıklama eventi ekle (sadece modal-content dışı)
            modal.onclick = function(event) {
                if (event.target === modal) {
                    closeModal(modalId);
                }
            };
        }
        function openGroupModal() {
            const form = document.getElementById('groupForm');
            form.reset();
            form.groupId.value = ''; // Ensure no old ID is present
            
            // ✅ Branş dropdown'unu dinamik olarak güncelle
            const branchSelect = form.querySelector('[name="branch"]');
            branchSelect.innerHTML = '<option value="">Seçiniz...</option>' + 
                branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
            
            if (selectedBranchForGroups) {
                branchSelect.value = selectedBranchForGroups;
            }
            document.getElementById('groupModalTitle').textContent = '➕ Yeni Grup Oluştur';
            openModal('groupModal');
        }
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) {
                modal.style.display = 'none';
                const form = modal.querySelector('form');
                if (form) form.reset();
                
                // ✅ Modal kapandığında tüm ses kayıtlarını durdur
                const audioElements = modal.querySelectorAll('audio');
                audioElements.forEach(audio => {
                    audio.pause();
                    audio.currentTime = 0;
                    // Blob URL'leri temizle (memory leak önleme)
                    if (audio.src && audio.src.startsWith('blob:')) {
                        URL.revokeObjectURL(audio.src);
                        audio.src = '';
                    }
                });
                
                // addLeadModal kapatılırken lastCheckedPhone'u sıfırla
                if (modalId === 'addLeadModal') {
                    lastCheckedPhone = '';
                    const messageDiv = document.getElementById('phone-check-message');
                    if (messageDiv) messageDiv.innerHTML = '';
                }
            }
        }
        
        function deleteItem(collectionName, id) {
            let itemType = '';
            if (collectionName === 'members') itemType = 'üyeyi ve ilişkili kayıtlarını';
            else if (collectionName === 'preRegistrations') itemType = 'kaydı ve ilişkili üyeyi';
            else if (collectionName === 'groups') itemType = 'grubu (içindeki üyeler çıkarılacak)';
            else if (collectionName === 'users') itemType = 'kullanıcıyı';
            else if (collectionName === 'tasks') itemType = 'görevi';
            else itemType = 'öğeyi';
            const text = `Bu ${itemType} kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.`;
            showConfirmModal(text, () => executeDelete(collectionName, id));
        }
        
        async function executeDelete(collectionName, id) {
            closeModal('confirmModal');
            try {
                if (collectionName === 'members') {
                    const memberToDelete = members.find(m => m.id === id);
                    if (memberToDelete) {
                        const group = groups.find(g => Array.isArray(g.members) && g.members.includes(id));
                        if (group) {
                            await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', group.id), { members: window.firebase.arrayRemove(id) });
                        }
                        if (memberToDelete.preRegistrationId) {
                            await window.firebase.deleteDoc(window.firebase.doc(window.db, 'preRegistrations', memberToDelete.preRegistrationId)).catch(e => {});
                        }
                    }
                } else if (collectionName === 'preRegistrations') {
                    const preRegToDelete = preRegistrations.find(p => p.id === id);
                    if (preRegToDelete) {
                        const memberToDelete = members.find(m => m.preRegistrationId === id || m.Telefon === preRegToDelete.phone);
                        if (memberToDelete) {
                            const group = groups.find(g => Array.isArray(g.members) && g.members.includes(memberToDelete.id));
                            if (group) {
                                await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', group.id), { members: window.firebase.arrayRemove(memberToDelete.id) });
                            }
                            await window.firebase.deleteDoc(window.firebase.doc(window.db, 'members', memberToDelete.id));
                        }
                    }
                }
                
                await window.firebase.deleteDoc(window.firebase.doc(window.db, collectionName, id));
                
                showAlert('Öğe ve ilişkili kayıtlar başarıyla silindi', 'success');
                await loadData();
            } catch (error) { 
                showAlert('Öğe silinirken hata oluştu', 'danger'); 
                console.error(error); 
            }
        }
        
        function viewMemberPayments(memberId) {
            if (!currentUser?.permissions?.view_payments) {
                return showAlert('Ödemeleri görüntüleme yetkiniz yok.', 'warning');
            }
            const member = members.find(m => m.id === memberId);
            const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
            if (preReg) viewPaymentPlan(preReg.id);
            else showAlert('Bu üyeye ait ödeme planı bulunamadı.', 'warning');
        }

        function viewPaymentPlan(preRegId) {
            const preReg = preRegistrations.find(p => p.id === preRegId);
            if (!preReg) return;
            document.getElementById('paymentPlanTitle').innerHTML = `📅 Ödeme Planı - <strong>${preReg.parentName || preReg.studentName}</strong>`;
            let planHtml = `<div style="background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px;"><p><strong>Dönem:</strong> ${formatDate(preReg.periodStart)} - ${formatDate(preReg.periodEnd)}</p></div>`;
            
            // ✅ Yetki kontrolü ile butonları göster
            if (currentUser?.permissions?.edit_payments) {
                planHtml += `<div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <button class="btn btn-sm btn-secondary" onclick="selectAllPayments('${preReg.id}', true)">✓ Tümünü Seç</button>
                    <button class="btn btn-sm btn-secondary" onclick="selectAllPayments('${preReg.id}', false)">✗ Seçimi Kaldır</button>
                    <button class="btn btn-sm btn-success" onclick="markSelectedPaymentsAsPaid('${preReg.id}')">💰 Seçilenleri Ödendi Yap</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteSelectedPayments('${preReg.id}')">🗑️ Seçilenleri Sil</button>
                </div>`;
            }
            
            planHtml += renderPaymentDetailsTable(preReg);
            
            if (currentUser?.permissions?.edit_payments) {
                planHtml += `<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; gap: 10px;">
                    <button class="btn btn-danger" onclick="deleteSelectedPayments('${preReg.id}')">🗑️ Seçilenleri Sil</button>
                    <button class="btn btn-success" onclick="openPaymentEditModal('${preReg.id}', null, true)">➕ Yeni Taksit Ekle</button>
                </div>`;
            }
            
            document.getElementById('paymentPlanContent').innerHTML = planHtml;
            openModal('paymentPlanModal');
        }

        function openPaymentEditModal(preRegId, paymentNumber, isNew = false) {
            if (!currentUser?.permissions?.edit_payments) {
                return showAlert('Bu işlem için yetkiniz bulunmamaktadır.', 'warning');
            }
            closeModal('paymentPlanModal');
            const form = document.getElementById('paymentForm');
            form.reset();
            document.getElementById('paymentPeriodInfoStatic').style.display = 'none';

            form.querySelector('button[type="submit"]').style.display = 'block';
            
            const preReg = preRegistrations.find(p => p.id === preRegId);
            if(!preReg) return;

            form.dataset.mode = isNew ? 'new' : 'edit';
            form.paymentPreRegId.value = preRegId;

            // ✅ Kaç ay daha aidat eklenecek alanını göster/gizle
            const additionalMonthsField = document.getElementById('additionalMonthsField');
            
            if (isNew) {
                document.getElementById('paymentModalTitle').textContent = `➕ Yeni Taksit Ekle`;
                document.getElementById('paymentPeriodInfo').style.display = 'grid';
                additionalMonthsField.style.display = 'block'; // ✅ Yeni aidatta göster
                form.paymentNumber.value = (preReg.paymentSchedule || []).length + 1;
                form.additionalMonths.value = 0; // Varsayılan 0
            } else {
                const payment = preReg.paymentSchedule.find(p => p.paymentNumber === paymentNumber);
                if(!payment) return;
                
                document.getElementById('paymentModalTitle').textContent = `✏️ ${paymentNumber}. Ödemeyi Düzenle`;
                document.getElementById('paymentPeriodInfo').style.display = 'grid'; 
                additionalMonthsField.style.display = 'none'; // ✅ Düzenlemede gizle

                form.paymentNumber.value = paymentNumber;
                form.paymentDate.value = payment.paymentDate || '';
                form.paymentAmount.value = payment.amount.toLocaleString('tr-TR');
                form.paymentDueDate.value = payment.dueDate;
                form.paymentMethod.value = payment.method || '';
                form.paymentStatus.value = payment.status;
                form.paymentNote.value = payment.note || '';
                form.periodStart.value = payment.period.start;
                form.periodEnd.value = payment.period.end;
                form.lessonCount.value = payment.period.lessonCount;
                
                 const paymentStatusSelect = form.querySelector('[name="paymentStatus"]');
                 const paymentDateInput = form.querySelector('[name="paymentDate"]');
                
                 paymentStatusSelect.onchange = () => {
                    if (paymentStatusSelect.value === 'paid' && !paymentDateInput.value) {
                         paymentDateInput.value = getTodayString();
                    }
                 };
                 paymentStatusSelect.value = payment.status;
            }
            
            openModal('paymentModal');
        }
        
        function renderPaymentDetailsTable(preReg) {
            const paymentSchedule = preReg.paymentSchedule || [];
            if (paymentSchedule.length === 0) return `<p class="empty-state">Ödeme planı yok.</p>`;
            
            // ✅ Yetki kontrolü - checkbox kolonunu göster/gizle
            const hasEditPermission = currentUser?.permissions?.edit_payments;
            const checkboxHeader = hasEditPermission ? `<th style="width: 40px;"><input type="checkbox" onchange="selectAllPayments('${preReg.id}', this.checked)"></th>` : '';
            const tableHeaders = `<thead><tr>${checkboxHeader}<th>Dönem</th><th>Dersler ve Tarih Aralığı</th><th>Tutar</th><th>Son Ödeme</th><th>Ödeme Tarihi</th><th>Durum</th><th style="width: 150px;">İşlemler</th></tr></thead>`;

            // Bu ay ödenen taksitler için highlight
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            const bodyHtml = paymentSchedule.map(p => {
                today.setHours(0,0,0,0);
                const dueDate = new Date(p.dueDate + 'T00:00:00');
                const isOverdue = dueDate < today && p.status === 'unpaid';
                const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                const isUpcoming = daysUntilDue > 0 && daysUntilDue <= 7 && p.status === 'unpaid';
                const statusClass = isOverdue ? 'overdue' : p.status;
                const lessonCountText = `${p.period.lessonCount} Ders`;
                
                // Bu ay ödenen taksitler için highlight
                let isPaidThisMonth = false;
                if (p.status === 'paid' && p.paymentDate) {
                    const paymentDate = new Date(p.paymentDate);
                    isPaidThisMonth = paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear;
                }
                const rowStyle = isPaidThisMonth ? 'background-color: #e3f2fd;' : '';
                
                // Build dropdown menu items
                let dropdownItems = [];
                
                // Message button (if unpaid) - tüm unpaid ödemeler için mesaj gönderilebilsin
                if (p.status === 'unpaid') {
                    if (isOverdue) {
                        dropdownItems.push(`<button onclick="event.stopPropagation(); window.sendPaymentReminderMessage('${preReg.id}', ${p.paymentNumber}, 'overdue')">💬 Gecikmiş Ödeme Mesajı</button>`);
                    } else {
                        // Vadesi gelmeyen ödemeler için de "Yaklaşan Ödeme" şablonunu kullan
                        dropdownItems.push(`<button onclick="event.stopPropagation(); window.sendPaymentReminderMessage('${preReg.id}', ${p.paymentNumber}, 'upcoming')">💬 Ödeme Hatırlatması Gönder</button>`);
                    }
                }
                
                // Edit button (if has permission)
                if(currentUser?.permissions?.edit_payments){
                    dropdownItems.push(`<button onclick="event.stopPropagation(); window.openPaymentEditModal('${preReg.id}', ${p.paymentNumber})">✏️ Düzenle</button>`);
                    dropdownItems.push(`<button class="danger" onclick="event.stopPropagation(); window.deletePaymentFromSchedule('${preReg.id}', ${p.paymentNumber})">🗑️ Sil</button>`);
                }
                
                const actionsHtml = dropdownItems.length > 0 ? `
                    <div class="actions-dropdown">
                        <button class="actions-dropdown-btn" type="button">
                            ⚙️ İşlemler ▼
                        </button>
                        <div class="actions-dropdown-content">
                            ${dropdownItems.join('')}
                        </div>
                    </div>
                ` : '';

                // ✅ Checkbox kolonunu yetki kontrolü ile göster
                const checkboxCell = hasEditPermission ? 
                    `<td><input type="checkbox" class="payment-checkbox" data-prereg-id="${preReg.id}" data-payment-num="${p.paymentNumber}" ${p.status === 'paid' ? 'disabled' : ''}></td>` : '';
                
                return `<tr style="${rowStyle}">
                    ${checkboxCell}
                    <td>${p.paymentNumber}. Aidat${isPaidThisMonth ? ' 💳' : ''}</td>
                    <td>${lessonCountText} (${formatDate(p.period.start)} - ${formatDate(p.period.end)})</td>
                    <td>${p.amount.toLocaleString('tr-TR')}₺</td>
                    <td>${formatDate(p.dueDate)}</td>
                    <td>${p.paymentDate ? formatDate(p.paymentDate) : '-'}</td>
                    <td><span class="status-badge status-${statusClass}">${getPaymentStatusText(statusClass)}</span></td>
                    <td class="actions-cell">${actionsHtml}</td>
                </tr>`;
            }).join('');

            return `<div class="table-container"><table class="data-table">${tableHeaders}<tbody>${bodyHtml}</tbody></table></div>`;
        }
        
        function selectAllPayments(preRegId, checked) {
            const checkboxes = document.querySelectorAll(`.payment-checkbox[data-prereg-id="${preRegId}"]`);
            checkboxes.forEach(cb => {
                if (!cb.disabled) cb.checked = checked;
            });
        }
        
        async function markSelectedPaymentsAsPaid(preRegId) {
            const selectedCheckboxes = Array.from(document.querySelectorAll(`.payment-checkbox[data-prereg-id="${preRegId}"]:checked`));
            if (selectedCheckboxes.length === 0) {
                return showAlert('Lütfen en az bir ödeme seçin.', 'warning');
            }
            
            const paymentNumbers = selectedCheckboxes.map(cb => parseInt(cb.dataset.paymentNum));
            const preReg = preRegistrations.find(p => p.id === preRegId);
            if (!preReg) return showAlert('Ön kayıt bulunamadı.', 'danger');
            
            const todayString = getTodayString();
            const updatedSchedule = preReg.paymentSchedule.map(p => {
                if (paymentNumbers.includes(p.paymentNumber) && p.status !== 'paid') {
                    return { ...p, status: 'paid', paymentDate: todayString };
                }
                return p;
            });
            
            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'preRegistrations', preRegId), { paymentSchedule: updatedSchedule });
                showAlert('Seçili ödemeler ödendi olarak işaretlendi.', 'success');
                await loadData();
                
                // ✅ İstatistikleri ve listeyi güncelle
                if (typeof updatePaymentStats === 'function') {
                    updatePaymentStats();
                }
                if (typeof renderPaymentsList === 'function' && currentSection === 'payments') {
                    renderPaymentsList();
                }
                
                viewPaymentPlan(preRegId); // Refresh
            } catch (error) {
                console.error('Error marking payments as paid:', error);
                showAlert('Ödemeler güncellenirken hata oluştu.', 'danger');
            }
        }
        
        async function deleteSelectedPayments(preRegId) {
            const selectedCheckboxes = Array.from(document.querySelectorAll(`.payment-checkbox[data-prereg-id="${preRegId}"]:checked`));
            if (selectedCheckboxes.length === 0) {
                return showAlert('Lütfen en az bir ödeme seçin.', 'warning');
            }
            
            const paymentNumbers = selectedCheckboxes.map(cb => parseInt(cb.dataset.paymentNum));
            
            if (!confirm(`Seçili ${paymentNumbers.length} ödeme kalıcı olarak silinecek. Emin misiniz?`)) {
                return;
            }
            
            const preReg = preRegistrations.find(p => p.id === preRegId);
            if (!preReg) return showAlert('Ön kayıt bulunamadı.', 'danger');
            
            // Filter out selected payments
            const updatedSchedule = preReg.paymentSchedule.filter(p => !paymentNumbers.includes(p.paymentNumber));
            
            // Renumber remaining payments
            updatedSchedule.forEach((p, index) => {
                p.paymentNumber = index + 1;
            });
            
            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'preRegistrations', preRegId), { paymentSchedule: updatedSchedule });
                showAlert('Seçili ödemeler silindi.', 'success');
                await loadData();
                
                // ✅ İstatistikleri ve listeyi güncelle
                if (typeof updatePaymentStats === 'function') {
                    updatePaymentStats();
                }
                if (typeof renderPaymentsList === 'function' && currentSection === 'payments') {
                    renderPaymentsList();
                }
                
                viewPaymentPlan(preRegId); // Refresh
            } catch (error) {
                console.error('Error deleting payments:', error);
                showAlert('Ödemeler silinirken hata oluştu.', 'danger');
            }
        }
        
        // --- HELPER FUNCTIONS ---
        function timeToMinutes(timeStr) {
            if (!timeStr || !timeStr.includes(':')) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTime(totalMinutes) {
            const hours = Math.floor(totalMinutes / 60).toString().padStart(2, '0');
            const mins = (totalMinutes % 60).toString().padStart(2, '0');
            return `${hours}:${mins}`;
        }

        function capitalize(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

         function capitalizeWords(str) {
            if (!str) return '';
            return str.toLowerCase().replace(/(?:^|\s)\S/g, function(a) { return a.toUpperCase(); });
        }


        function calculateAge(birthDateString) {
            if (!birthDateString) return null;
            const birthDate = new Date(birthDateString);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function generatePaymentSchedule(firstStart, firstEnd, firstDueDate, totalInstallments, firstAmount, subsequentAmount, dueDay, firstLessonCount) {
            const payments = [];
            
            payments.push({
                paymentNumber: 1,
                dueDate: new Date(firstDueDate).toISOString().split('T')[0],
                amount: firstAmount,
                status: 'unpaid',
                period: {
                    start: new Date(firstStart).toISOString().split('T')[0],
                    end: new Date(firstEnd).toISOString().split('T')[0],
                    lessonCount: firstLessonCount
                }
            });

            let lastPeriodEnd = new Date(firstEnd);
            let referenceDueDate = new Date(firstDueDate);
            referenceDueDate.setHours(12,0,0,0);

            for (let i = 2; i <= totalInstallments; i++) {
                const newPeriodStart = new Date(lastPeriodEnd);
                newPeriodStart.setDate(newPeriodStart.getDate() + 1);

                const newPeriodEnd = new Date(newPeriodStart);
                newPeriodEnd.setDate(newPeriodEnd.getDate() + 27); // approx 4 weeks
                
                referenceDueDate.setMonth(referenceDueDate.getMonth() + 1);
                let nextDueDate = new Date(referenceDueDate.getFullYear(), referenceDueDate.getMonth(), dueDay, 12, 0, 0);

                payments.push({
                    paymentNumber: i,
                    dueDate: nextDueDate.toISOString().split('T')[0],
                    amount: subsequentAmount,
                    status: 'unpaid',
                    period: {
                        start: newPeriodStart.toISOString().split('T')[0],
                        end: newPeriodEnd.toISOString().split('T')[0],
                        lessonCount: 8 // Her taksitte ders sayısı farklı olabilir, admin panelde düzenlenir
                    }
                });
                
                lastPeriodEnd = newPeriodEnd;
            }
            return payments;
        }
        
        function autoCalculateLessonCount(form) {
            const start = form.querySelector('[name=firstPeriodStart]').value;
            const end = form.querySelector('[name=firstPeriodEnd]').value;
            const lessonCountInput = form.querySelector('[name=firstLessonCount]');
            if (start && end) {
                const startDate = new Date(start);
                const endDate = new Date(end);
                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                const weeks = Math.round(diffDays / 7);
                lessonCountInput.value = weeks * 2; // Assuming 2 lessons per week
                previewPaymentPlan(form);
            }
        }

        function previewPaymentPlan(form) {
            const data = Object.fromEntries(new FormData(form).entries());
            const previewContainer = form.querySelector('.payment-plan-preview');
            
            if(!data.firstPeriodStart || !data.firstPeriodEnd || !data.firstInstallmentAmount || !data.firstDueDate || !data.installments || !data.subsequentInstallmentAmount || !data.firstLessonCount) {
                previewContainer.innerHTML = ''; 
                return;
            }

            const totalInstallments = parseInt(data.installments) + 1;
            const firstAmount = parseFloat(unformatCurrency(data.firstInstallmentAmount) || '0');
            const subsequentAmount = parseFloat(unformatCurrency(data.subsequentInstallmentAmount) || '0');
            const paymentSchedule = generatePaymentSchedule(
                new Date(data.firstPeriodStart), new Date(data.firstPeriodEnd), new Date(data.firstDueDate),
                totalInstallments, firstAmount, subsequentAmount, parseInt(data.dueDay), parseInt(data.firstLessonCount)
            );
            
            previewContainer.innerHTML = `<h4>Ödeme Planı Önizlemesi</h4>` + renderPaymentDetailsTable({paymentSchedule: paymentSchedule}, true);
        }

        function formatCurrency(input) {
            let value = input.value.replace(/\D/g, ''); // Remove non-digits
            if(value) {
                input.value = new Intl.NumberFormat('tr-TR').format(value);
            } else {
                input.value = '';
            }
        }
        function unformatCurrency(value) {
            return value.replace(/\./g, '');
        }
        
        // Para formatı için yardımcı fonksiyon (gösterim için)
        window.formatPrice = function(amount) {
            if (amount === null || amount === undefined || isNaN(amount)) return '0₺';
            const parts = parseFloat(amount).toFixed(2).split('.');
            const integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            const decimalPart = parts[1];
            return decimalPart === '00' ? `${integerPart}₺` : `${integerPart},${decimalPart}₺`;
        };
        
        function setPaymentFilter(filter, element) {
            paymentFilter = filter;
            document.querySelectorAll('#payments .btn-group .btn').forEach(btn => btn.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
            
            // Gecikmiş ödemeler istatistiklerini göster/gizle
            const overdueStatsContainer = document.getElementById('overdue-stats-container');
            if (overdueStatsContainer) {
                if (filter === 'overdue') {
                    overdueStatsContainer.style.display = 'grid';
                } else {
                    overdueStatsContainer.style.display = 'none';
                }
            }
            
            renderPaymentsList();
        }
        
        function navigateToSection(sectionId) {
            const button = document.querySelector(`.nav-btn[onclick*="'${sectionId}'"]`);
            if (button) button.click();
        }

        function getStatusText(status) {
            const statuses = { pending: 'Bekliyor', active: 'Aktif', completed: 'Tamamlandı', expired: 'Pasif' };
            return statuses[status] || 'Bilinmiyor';
        }
        function getPaymentStatusText(status) {
            const statuses = { paid: 'Ödendi', unpaid: 'Ödenmedi', overdue: 'Gecikmiş' };
            return statuses[status] || 'Bilinmiyor';
        }
        function formatDate(dateString) {
            if (!dateString) return '';
            // ISO strings (like from toISOString()) can be parsed directly.
            // YYYY-MM-DD strings might be interpreted as UTC, so we help it by adding time.
            if (dateString.length === 10 && dateString.includes('-')) {
                return new Date(dateString + 'T00:00:00').toLocaleDateString('tr-TR');
            }
            return new Date(dateString).toLocaleDateString('tr-TR');
        }
        function getTodayString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function generateId() {
            // Generate a unique ID (UUID v4 style for compatibility with existing TEXT ids)
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        function closeAlert() {
            if (window.currentAlertModal && document.body.contains(window.currentAlertModal)) {
                document.body.removeChild(window.currentAlertModal);
                window.currentAlertModal = null;
            }
        }
        
        window.closeAlert = closeAlert;
        
        function showAlert(message, type = 'info') {
            // Check if message contains HTML (for modals)
            const isModal = message.includes('<form') || message.includes('<div style');
            
            if (isModal) {
                // Create modal overlay
                const modalOverlay = document.createElement('div');
                modalOverlay.style.cssText = `
                    position: fixed; 
                    top: 0; 
                    left: 0; 
                    width: 100%; 
                    height: 100%; 
                    background: rgba(0,0,0,0.5); 
                    z-index: 2000; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center;
                    overflow-y: auto;
                    padding: 20px;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.innerHTML = message;
                modalContent.style.cssText = `
                    background: white; 
                    border-radius: 12px; 
                    box-shadow: 0 10px 40px rgba(0,0,0,0.3); 
                    max-width: 600px; 
                    width: 100%; 
                    max-height: 90vh;
                    overflow-y: auto;
                    position: relative;
                `;
                
                modalOverlay.appendChild(modalContent);
                document.body.appendChild(modalOverlay);
                
                // Close on overlay click
                modalOverlay.addEventListener('click', (e) => {
                    if (e.target === modalOverlay) {
                        document.body.removeChild(modalOverlay);
                        window.currentAlertModal = null;
                    }
                });
                
                // Store reference for closeAlert
                window.currentAlertModal = modalOverlay;
                
                return;
            }
            
            // Regular alert notification
            // ✅ Bildirimleri yukarıdan aşağıya stack et
            const existingAlerts = document.querySelectorAll('.toast-notification');
            let topOffset = 20;
            existingAlerts.forEach(alert => {
                topOffset += alert.offsetHeight + 10; // Her bildirimin yüksekliği + boşluk
            });
            
            const alertContainer = document.createElement('div');
            alertContainer.className = 'toast-notification';
            alertContainer.innerHTML = message.replace(/\n/g, '<br>');
            alertContainer.style.cssText = `position: fixed; top: ${topOffset}px; right: 20px; z-index: 999999; padding: 15px; border-radius: 8px; color: white; background-color: ${type === 'success' ? 'var(--success-color)' : type === 'danger' ? 'var(--danger-color)' : 'var(--info-color)'}; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: all 0.5s ease; opacity: 1; max-width: 400px;`;
            document.body.appendChild(alertContainer);
            
            setTimeout(() => {
                alertContainer.style.opacity = '0';
                alertContainer.style.transform = 'translateX(450px)'; // Sağa kaydır
                setTimeout(() => { 
                    if(document.body.contains(alertContainer)) {
                        document.body.removeChild(alertContainer);
                        // Diğer bildirimleri yukarı kaydır
                        updateAlertPositions();
                    }
                }, 500);
            }, 6000);
        }
        
        // Bildirimlerin pozisyonlarını güncelle
        function updateAlertPositions() {
            const alerts = document.querySelectorAll('.toast-notification');
            let topOffset = 20;
            alerts.forEach(alert => {
                alert.style.top = `${topOffset}px`;
                topOffset += alert.offsetHeight + 10;
            });
        }
        
        // Custom confirm dialog
        function showConfirm(message, title = '⚠️ Onay') {
            return new Promise((resolve) => {
                const modalOverlay = document.createElement('div');
                modalOverlay.style.cssText = `
                    position: fixed; 
                    top: 0; 
                    left: 0; 
                    width: 100%; 
                    height: 100%; 
                    background: rgba(0,0,0,0.7); 
                    z-index: 999999; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center;
                    padding: 20px;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white; 
                    border-radius: 16px; 
                    box-shadow: 0 20px 60px rgba(0,0,0,0.4); 
                    max-width: 500px; 
                    width: 100%; 
                    padding: 30px;
                    text-align: center;
                `;
                
                modalContent.innerHTML = `
                    <h3 style="margin: 0 0 20px 0; color: var(--primary-color); font-size: 1.5em;">${title}</h3>
                    <p style="margin: 0 0 30px 0; color: #333; line-height: 1.6; white-space: pre-wrap;">${message}</p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button id="confirmNo" class="btn btn-warning" style="flex: 1; padding: 12px;">❌ İptal</button>
                        <button id="confirmYes" class="btn btn-success" style="flex: 1; padding: 12px;">✅ Devam Et</button>
                    </div>
                `;
                
                modalOverlay.appendChild(modalContent);
                document.body.appendChild(modalOverlay);
                
                const cleanup = () => {
                    if (document.body.contains(modalOverlay)) {
                        document.body.removeChild(modalOverlay);
                    }
                };
                
                modalContent.querySelector('#confirmYes').onclick = () => {
                    cleanup();
                    resolve(true);
                };
                
                modalContent.querySelector('#confirmNo').onclick = () => {
                    cleanup();
                    resolve(false);
                };
                
                // ESC tuşu ile kapat
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        cleanup();
                        resolve(false);
                        document.removeEventListener('keydown', handleEscape);
                    }
                };
                document.addEventListener('keydown', handleEscape);
            });
        }

        function toggleParentStudentFields(form) {
            const type = form.querySelector('[name="memberType"]').value;
            const phone1Label = form.querySelector('label[for="preRegPhonePre"]');

            const parentName1Group = document.getElementById('parentName1Group');
            const phone1Group = document.getElementById('phone1Group');
            const parentName2Group = document.getElementById('parentName2Group');
            const phone2Group = document.getElementById('phone2Group');
            const studentsContainer = document.getElementById('studentsContainer');
            const singleStudentContainer = document.getElementById('singleStudentContainer');

            if (type === 'adult') {
                phone1Label.textContent = 'Telefon *';
                
                [parentName1Group, parentName2Group, phone2Group].forEach(el => el.style.display = 'none');
                [parentName1Group, parentName2Group, phone2Group].forEach(el => el.querySelector('input').required = false);
                
                // Tek öğrenci alanını göster
                studentsContainer.style.display = 'none';
                // ✅ Gizli çoklu öğrenci alanlarının required'ını kaldır
                studentsContainer.querySelectorAll('.student-name').forEach(input => input.required = false);
                
                singleStudentContainer.style.display = 'block';
                document.getElementById('studentNamePre').required = true;
                document.getElementById('studentBirthDatePre').required = false;
                
            } else { // child
                phone1Label.textContent = 'Veli Telefon *';
                
                [parentName1Group, parentName2Group, phone2Group].forEach(el => el.style.display = 'flex');
                parentName1Group.querySelector('input').required = true;
                
                // Çoklu öğrenci alanlarını göster
                studentsContainer.style.display = 'block';
                // ✅ Görünür çoklu öğrenci alanlarının required'ını geri ekle
                studentsContainer.querySelectorAll('.student-name').forEach(input => input.required = true);
                
                singleStudentContainer.style.display = 'none';
                document.getElementById('studentNamePre').required = false;
                document.getElementById('studentBirthDatePre').required = false;
            }
        }
        
        // Öğrenci alanı ekle
        window.addStudentField = function() {
            const container = document.getElementById('studentFieldsContainer');
            const studentCount = container.querySelectorAll('.student-field-group').length;
            
            const newStudentField = document.createElement('div');
            newStudentField.className = 'student-field-group';
            newStudentField.setAttribute('data-student-index', studentCount);
            
            const borderColors = ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#F44336'];
            const borderColor = borderColors[studentCount % borderColors.length];
            
            const today = getTodayString();
            
            newStudentField.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; position: relative; border-left: 4px solid ${borderColor};">
                    <h5 style="margin: 0 0 15px 0; color: #333;">Öğrenci ${studentCount + 1}</h5>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeStudentField(${studentCount})" style="position: absolute; top: 10px; right: 10px;">🗑️</button>
                    <div class="form-grid">
                        <div class="form-group"><label>Ad Soyad *</label><input type="text" class="form-control student-name" name="studentName_${studentCount}" required></div>
                        <div class="form-group"><label>Doğum Tarihi</label><input type="date" class="form-control student-birthdate" name="studentBirthDate_${studentCount}" max="${today}"></div>
                    </div>
                </div>
            `;
            container.appendChild(newStudentField);
        };
        
        // Öğrenci alanını kaldır
        window.removeStudentField = function(index) {
            const container = document.getElementById('studentFieldsContainer');
            const studentGroups = container.querySelectorAll('.student-field-group');
            
            if (studentGroups.length <= 1) {
                showAlert('En az bir öğrenci olmalıdır.', 'warning');
                return;
            }
            
            const fieldToRemove = container.querySelector(`[data-student-index="${index}"]`);
            if (fieldToRemove) {
                fieldToRemove.remove();
            }
        };
        
        function toggleParentStudentFieldsForEdit(form, isAdult) {
            const parentNameGroup = form.querySelector('[name="parentName"]').parentElement;
            const studentNameLabel = form.querySelector('label[for="studentName"]');

            if (isAdult) {
                if(studentNameLabel) studentNameLabel.textContent = 'Ad Soyad *';
                if(parentNameGroup) parentNameGroup.style.display = 'none';
                if(parentNameGroup) parentNameGroup.querySelector('input').required = false;
            } else {
                if(studentNameLabel) studentNameLabel.textContent = 'Öğrenci Ad Soyad *';
                if(parentNameGroup) parentNameGroup.style.display = 'flex';
                if(parentNameGroup) parentNameGroup.querySelector('input').required = true;
            }
        }


        function filterGroupsByBranch(branch, element) {
            selectedBranchForGroups = branch;
            document.querySelectorAll('#group-branch-filter .btn').forEach(b => b.classList.remove('active'));
            if (element) element.classList.add('active');
            document.getElementById('newGroupBtn').style.display = 'inline-flex';
            renderGroupsList();
        }

        function filterScheduleByBranch(branch, element) {
            selectedBranchForSchedule = branch;
            document.querySelectorAll('#schedule-branch-filter .btn').forEach(b => b.classList.remove('active'));
            if (element) element.classList.add('active');
            renderScheduleGrid();
        }

        function showConfirmModal(text, onConfirm) {
             const confirmModal = document.getElementById('confirmModal');
             document.getElementById('confirmText').textContent = text;
             const confirmYesBtn = document.getElementById('confirmYesBtn');
             
             const newYesBtn = confirmYesBtn.cloneNode(true);
             newYesBtn.textContent = 'Evet, Onayla';
             confirmYesBtn.parentNode.replaceChild(newYesBtn, confirmYesBtn);
             
             newYesBtn.onclick = onConfirm;
             openModal('confirmModal');
        }

        function sortMembersByAge() {
            if (ageSortDirection === 'none') {
                ageSortDirection = 'asc';
            } else if (ageSortDirection === 'asc') {
                ageSortDirection = 'desc';
            } else {
                ageSortDirection = 'none';
            }
            renderMembersTable();
        }
        
        function editReason(cellElement, recordId) {
            const currentReason = cellElement.textContent === 'Sebep Ekle' ? '' : cellElement.textContent;
            cellElement.innerHTML = `<input type="text" class="form-control" value="${currentReason}" onblur="saveReason('${recordId}', this.value, this.parentElement)" onkeypress="if(event.key === 'Enter') this.blur()" autofocus>`;
            cellElement.querySelector('input').focus();
            cellElement.onclick = null; // Prevent re-triggering while editing
        }

        // Üye detayını gizle ve listeye dön
        window.hideMemberDetail = function() {
            const contentDiv = document.getElementById('member-detail-content');
            const memberListCard = document.getElementById('members-list-card');
            if (contentDiv) contentDiv.style.display = 'none';
            if (memberListCard) memberListCard.style.display = 'block';
        };
        
        // ✅ Sidebar dropdown toggle
        window.toggleDropdown = function(button) {
            button.classList.toggle('open');
            const dropdown = button.nextElementSibling;
            if (dropdown && dropdown.classList.contains('dropdown-content')) {
                dropdown.classList.toggle('show');
            }
            
            // Ok işaretini döndür
            const arrow = button.querySelector('.dropdown-arrow');
            if (arrow) {
                if (button.classList.contains('open')) {
                    arrow.style.transform = 'rotate(180deg)';
                } else {
                    arrow.style.transform = 'rotate(0deg)';
                }
            }
        };
        
        function generatePeriodBasedAttendance(member, preReg, attendanceRecords) {
            // 🔍 DEBUG: Yoklama kayıtlarını logla
            console.log('🔍 DEBUG - generatePeriodBasedAttendance:', {
                memberName: member.Ad_Soyad,
                memberId: member.id,
                attendanceRecordsCount: attendanceRecords.length,
                attendanceRecords: attendanceRecords.map(r => {
                    const foundGroup = groups.find(g => g.id === r.groupId);
                    return {
                        id: r.id,
                        date: r.date,
                        groupId: r.groupId,
                        status: r.status,
                        groupFound: !!foundGroup,
                        groupName: foundGroup?.groupName || '❌ GRUP BULUNAMADI',
                        groupDetails: foundGroup ? {
                            id: foundGroup.id,
                            name: foundGroup.groupName,
                            hasMemberIds: !!foundGroup.memberIds,
                            hasMembers: !!foundGroup.members,
                            memberIdsCount: foundGroup.memberIds?.length || 0,
                            membersCount: foundGroup.members?.length || 0,
                            includesThisMember_memberIds: foundGroup.memberIds?.includes(member.id),
                            includesThisMember_members: foundGroup.members?.includes(member.id)
                        } : null
                    };
                }),
                preRegExists: !!preReg,
                paymentScheduleLength: preReg?.paymentSchedule?.length || 0,
                totalGroupsInSystem: groups.length,
                groupsWithThisMember: groups.filter(g => 
                    (g.memberIds && g.memberIds.includes(member.id)) || 
                    (g.members && g.members.includes(member.id))
                ).map(g => ({ id: g.id, name: g.groupName }))
            });
            
            if (!preReg || !preReg.paymentSchedule || preReg.paymentSchedule.length === 0) {
                // Aidat dönemi yoksa eski görünümü göster
                return `
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Grup</th>
                                    <th>Durum</th>
                                    <th>Devamsızlık Sebebi</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${attendanceRecords.length === 0 ? `<tr><td colspan="5" class="empty-state">Bu üye için yoklama kaydı bulunmuyor.</td></tr>` : 
                                attendanceRecords.map(record => {
                                    const group = groups.find(g => g.id === record.groupId);
                                    const statusClass = record.status === 'present' ? 'status-present' : 'status-absent';
                                    const statusText = record.status === 'present' ? 'Katıldı' : 'Katılmadı';
                                    // ✅ Saat farkı sorunu çözümü: Yerel saat diliminde tarih oluştur
                                    const recordDate = new Date(record.date);
                                    const formattedDate = recordDate.toLocaleDateString('tr-TR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                                    
                                    // 🔍 DEBUG: Grup bulunamadığında detaylı log
                                    if (!group) {
                                        console.warn('⚠️ Grup bulunamadı (eski görünüm):', {
                                            recordId: record.id,
                                            groupId: record.groupId,
                                            memberName: member.Ad_Soyad,
                                            allGroupIds: groups.map(g => g.id)
                                        });
                                    }
                                    
                                    const groupName = group ? group.groupName : `⚠️ Grup Bulunamadı (ID: ${record.groupId.substring(0, 8)}...)`;
                                    
                                    const reasonCell = record.status === 'absent'
                                        ? `<td class="editable-reason" onclick="editReason(this, '${record.id}')">${record.reason || '<i>Sebep Ekle</i>'}</td>`
                                        : `<td>-</td>`;
                                    const statusCell = `<td onclick="toggleAttendanceStatus('${record.id}', '${record.status}')" style="cursor:pointer;"><span class="status-badge ${statusClass}">${statusText}</span></td>`;
                                    return `
                                        <tr>
                                            <td class="editable-date">
                                                <span>${formattedDate}</span>
                                                <button class="btn-icon" onclick="editAttendanceDate(this, '${record.id}')">✏️</button>
                                            </td>
                                            <td>${groupName}</td>
                                            ${statusCell}
                                            ${reasonCell}
                                            <td>
                                                <button class="btn-icon danger" onclick="deleteAttendanceRecord('${record.id}')">🗑️</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // Dönemler için HTML oluştur
            let periodsHtml = '';
            
            preReg.paymentSchedule.forEach((period, index) => {
                // ✅ Tarihleri yerel saat diliminde karşılaştır (saat farkı sorunu çözümü)
                // String tarihi "YYYY-MM-DD" formatından parse et
                const [startYear, startMonth, startDay] = period.period.start.split('-').map(Number);
                const [endYear, endMonth, endDay] = period.period.end.split('-').map(Number);
                
                const periodStart = new Date(startYear, startMonth - 1, startDay, 0, 0, 0, 0);
                const periodEnd = new Date(endYear, endMonth - 1, endDay, 23, 59, 59, 999);
                const lessonCount = period.period.lessonCount || 'N/A';
                
                // Bu döneme ait devamsızlık kayıtlarını filtrele
                const periodAttendance = attendanceRecords.filter(record => {
                    // ✅ String tarihi "YYYY-MM-DD" formatından parse et (saat farkı sorunu çözümü)
                    const [recYear, recMonth, recDay] = record.date.split('-').map(Number);
                    const recordDate = new Date(recYear, recMonth - 1, recDay, 0, 0, 0, 0);
                    const isInPeriod = recordDate >= periodStart && recordDate <= periodEnd;
                    
                    // 🔍 DEBUG: Tarihleri logla
                    const foundGroup = groups.find(g => g.id === record.groupId);
                    console.log(`🔍 Dönem ${index + 1} Filtresi (${member.Ad_Soyad}):`, {
                        recordId: record.id,
                        recordDate: record.date,
                        recordDateLocal: recordDate.toLocaleDateString('tr-TR'),
                        periodStartLocal: periodStart.toLocaleDateString('tr-TR'),
                        periodEndLocal: periodEnd.toLocaleDateString('tr-TR'),
                        isInPeriod: isInPeriod,
                        groupId: record.groupId,
                        groupFound: !!foundGroup,
                        groupName: foundGroup?.groupName || '❌ GRUP BULUNAMADI'
                    });
                    
                    return isInPeriod;
                }).sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const presentCount = periodAttendance.filter(r => r.status === 'present').length;
                const absentCount = periodAttendance.filter(r => r.status === 'absent').length;
                const attendanceRate = periodAttendance.length > 0 ? ((presentCount / periodAttendance.length) * 100).toFixed(0) : 0;
                
                periodsHtml += `
                    <div class="period-card" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 5px solid var(--primary-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h3 style="margin: 0; color: var(--primary-color); font-size: 1.3em;">
                                    📅 ${period.paymentNumber}. Dönem
                                </h3>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 0.95em;">
                                    ${formatDate(period.period.start)} - ${formatDate(period.period.end)} 
                                    <span style="background: #e3f2fd; padding: 3px 10px; border-radius: 15px; margin-left: 10px; font-weight: bold;">
                                        ${lessonCount} Ders
                                    </span>
                                </p>
                            </div>
                            <div style="text-align: right;">
                                <div style="display: flex; gap: 15px; align-items: center;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.5em; font-weight: bold; color: var(--success-color);">${presentCount}</div>
                                        <div style="font-size: 0.8em; color: #666;">Katıldı</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.5em; font-weight: bold; color: var(--danger-color);">${absentCount}</div>
                                        <div style="font-size: 0.8em; color: #666;">Katılmadı</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.5em; font-weight: bold; color: var(--info-color);">${attendanceRate}%</div>
                                        <div style="font-size: 0.8em; color: #666;">Oran</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${periodAttendance.length === 0 ? 
                            `<div style="text-align: center; padding: 30px; color: #999; background: white; border-radius: 8px;">
                                <p style="margin: 0; font-size: 1.1em;">📝 Bu dönem için henüz yoklama kaydı bulunmuyor.</p>
                            </div>` 
                            : 
                            `<div class="table-container">
                                <table class="data-table" style="background: white;">
                                    <thead>
                                        <tr>
                                            <th>Tarih</th>
                                            <th>Grup</th>
                                            <th>Durum</th>
                                            <th>Devamsızlık Sebebi</th>
                                            <th>İşlemler</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${periodAttendance.map(record => {
                                            const group = groups.find(g => g.id === record.groupId);
                                            const statusClass = record.status === 'present' ? 'status-present' : 'status-absent';
                                            const statusText = record.status === 'present' ? '✅ Katıldı' : '❌ Katılmadı';
                                            // ✅ Saat farkı sorunu çözümü: Yerel saat diliminde tarih oluştur
                                            const recordDate = new Date(record.date);
                                            const formattedDate = recordDate.toLocaleDateString('tr-TR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                                            
                                            // 🔍 DEBUG: Grup bulunamadığında detaylı log
                                            if (!group) {
                                                console.warn('⚠️ Grup bulunamadı:', {
                                                    recordId: record.id,
                                                    groupId: record.groupId,
                                                    memberName: member.Ad_Soyad,
                                                    allGroupIds: groups.map(g => g.id)
                                                });
                                            }
                                            
                                            const groupName = group ? group.groupName : `⚠️ Grup Bulunamadı (ID: ${record.groupId.substring(0, 8)}...)`;
                                            
                                            const reasonCell = record.status === 'absent'
                                                ? `<td class="editable-reason" onclick="editReason(this, '${record.id}')">${record.reason || '<i style="color:#999;">Sebep Ekle</i>'}</td>`
                                                : `<td style="color:#999;">-</td>`;
                                            const statusCell = `<td onclick="toggleAttendanceStatus('${record.id}', '${record.status}')" style="cursor:pointer;"><span class="status-badge ${statusClass}">${statusText}</span></td>`;
                                            return `
                                                <tr>
                                                    <td class="editable-date">
                                                        <span>${formattedDate}</span>
                                                        <button class="btn-icon" onclick="editAttendanceDate(this, '${record.id}')">✏️</button>
                                                    </td>
                                                    <td>${groupName}</td>
                                                    ${statusCell}
                                                    ${reasonCell}
                                                    <td>
                                                        <button class="btn-icon danger" onclick="deleteAttendanceRecord('${record.id}')">🗑️</button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>`
                        }
                    </div>
                `;
            });
            
            if (periodsHtml === '') {
                return '<div class="empty-state"><p>Aidat dönemi bilgisi bulunamadı.</p></div>';
            }
            
            return periodsHtml;
        }

        // Open modal to add attendance record for single member
        window.openAddMemberAttendanceModal = async function(memberId) {
            try {
                const member = members.find(m => m.id === memberId);
                if (!member) {
                    return showAlert('Üye bulunamadı.', 'danger');
                }
                
                // Set member ID
                document.getElementById('singleMemberId').value = memberId;
                
                // Set today as default date
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('singleAttendanceDate').value = today;
                
                // Load groups for dropdown
                const groupSelect = document.getElementById('singleAttendanceGroup');
                groupSelect.innerHTML = '<option value="">Grup Seçin</option>';
                
                // ✅ DEBUG: Tüm grupları ve member ile ilgili alanları logla
                console.log('🔍 DEBUG - Tüm Gruplar:', {
                    totalGroups: groups.length,
                    firstGroupSample: groups[0] ? {
                        id: groups[0].id,
                        name: groups[0].groupName,
                        memberIds: groups[0].memberIds,
                        members: groups[0].members,
                        hasMemberIds: !!groups[0].memberIds,
                        hasMembers: !!groups[0].members
                    } : null
                });
                
                // Find member's groups - ✅ FIX: memberIds kullan, members değil
                const memberGroups = groups.filter(g => {
                    const hasMemberIds = g.memberIds && Array.isArray(g.memberIds) && g.memberIds.includes(memberId);
                    const hasMembers = g.members && Array.isArray(g.members) && g.members.includes(memberId);
                    
                    // Her grup için detaylı log
                    if (hasMemberIds || hasMembers) {
                        console.log(`✅ Grup bulundu: ${g.groupName}`, {
                            groupId: g.id,
                            hasMemberIds,
                            hasMembers,
                            memberIds: g.memberIds,
                            members: g.members
                        });
                    }
                    
                    return hasMemberIds || hasMembers;
                });
                
                console.log('🔍 Üye grupları:', {
                    memberId,
                    totalGroups: groups.length,
                    memberGroups: memberGroups.length,
                    groupDetails: memberGroups.map(g => ({ id: g.id, name: g.groupName, memberIds: g.memberIds, members: g.members }))
                });
                
                if (memberGroups.length === 0) {
                    groupSelect.innerHTML = '<option value="">Üye herhangi bir gruba kayıtlı değil</option>';
                } else {
                    memberGroups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group.id;
                        option.textContent = group.groupName || 'İsimsiz Grup';
                        groupSelect.appendChild(option);
                    });
                }
                
                // Reset status and reason
                document.getElementById('singleAttendanceStatus').value = 'present';
                document.getElementById('singleAttendanceReason').value = '';
                document.getElementById('singleReasonGroup').style.display = 'none';
                
                // Show/hide reason field based on status
                document.getElementById('singleAttendanceStatus').onchange = function() {
                    const reasonGroup = document.getElementById('singleReasonGroup');
                    reasonGroup.style.display = this.value === 'absent' ? 'block' : 'none';
                };
                
                // Open modal
                document.getElementById('addMemberAttendanceModal').style.display = 'block';
                
                // Handle form submission
                document.getElementById('addMemberAttendanceForm').onsubmit = async function(e) {
                    e.preventDefault();
                    await handleAddMemberAttendance();
                };
                
            } catch (error) {
                console.error("Error opening add attendance modal:", error);
                showAlert('Modal açılırken hata oluştu: ' + error.message, 'danger');
            }
        };

        // Handle adding attendance record for single member
        window.handleAddMemberAttendance = async function() {
            try {
                const memberId = document.getElementById('singleMemberId').value;
                const date = document.getElementById('singleAttendanceDate').value;
                const groupId = document.getElementById('singleAttendanceGroup').value;
                const status = document.getElementById('singleAttendanceStatus').value;
                const reason = document.getElementById('singleAttendanceReason').value.trim();
                
                if (!memberId || !date || !groupId) {
                    return showAlert('Lütfen tüm zorunlu alanları doldurun.', 'warning');
                }
                
                // Generate unique ID
                const recordId = generateId();
                
                // Prepare record
                const newRecord = {
                    id: recordId,
                    memberId: memberId,
                    groupId: groupId,
                    date: date,
                    status: status,
                    reason: status === 'absent' ? reason : '',
                    recordedBy: currentUser.fullName || currentUser.username || 'Admin',
                    clubId: currentClubId,
                    createdAt: new Date().toISOString()
                };
                
                // Insert to Supabase
                const { data, error } = await supabase
                    .from('attendanceRecords')
                    .insert([newRecord])
                    .select();
                
                if (error) {
                    console.error("Supabase insert error:", error);
                    throw error;
                }
                
                console.log("Attendance record created:", data);
                
                // Add to local cache
                if (!attendanceRecords) attendanceRecords = [];
                attendanceRecords.push(newRecord);
                
                // Close modal
                closeModal('addMemberAttendanceModal');
                
                // Show success message
                showAlert('Yoklama kaydı başarıyla eklendi.', 'success');
                
                // Refresh member attendance page
                showMemberAttendancePage(memberId);
                
            } catch (error) {
                console.error("Error adding attendance record:", error);
                showAlert('Yoklama kaydı eklenirken hata oluştu: ' + error.message, 'danger');
            }
        };

        // Make message editable inline (for message queue)
        window.makeMessageEditable = async function(messageId) {
            const msgDiv = document.getElementById('msg-' + messageId);
            if (!msgDiv) return;
            
            const currentText = msgDiv.textContent.trim();
            const originalBg = msgDiv.style.background;
            
            // Create textarea
            const textarea = document.createElement('textarea');
            textarea.value = currentText;
            textarea.style.width = '100%';
            textarea.style.minHeight = '80px';
            textarea.style.padding = '8px';
            textarea.style.border = '2px solid #2196F3';
            textarea.style.borderRadius = '4px';
            textarea.style.fontFamily = 'inherit';
            textarea.style.fontSize = '13px';
            textarea.style.resize = 'vertical';
            
            // Create buttons
            const btnContainer = document.createElement('div');
            btnContainer.style.marginTop = '8px';
            btnContainer.style.display = 'flex';
            btnContainer.style.gap = '8px';
            
            const saveBtn = document.createElement('button');
            saveBtn.textContent = '✓ Kaydet';
            saveBtn.className = 'btn btn-sm';
            saveBtn.style.background = '#4CAF50';
            saveBtn.style.color = 'white';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = '✕ İptal';
            cancelBtn.className = 'btn btn-sm';
            cancelBtn.style.background = '#9E9E9E';
            cancelBtn.style.color = 'white';
            
            btnContainer.appendChild(saveBtn);
            btnContainer.appendChild(cancelBtn);
            
            // Store original content
            const originalContent = msgDiv.innerHTML;
            
            // Replace with textarea
            msgDiv.innerHTML = '';
            msgDiv.style.cursor = 'default';
            msgDiv.onclick = null;
            msgDiv.onmouseover = null;
            msgDiv.onmouseout = null;
            msgDiv.appendChild(textarea);
            msgDiv.appendChild(btnContainer);
            
            textarea.focus();
            textarea.select();
            
            // Cancel handler
            cancelBtn.onclick = function() {
                msgDiv.innerHTML = originalContent;
                msgDiv.style.cursor = 'pointer';
                msgDiv.style.background = originalBg;
                msgDiv.onclick = function() { window.makeMessageEditable(messageId); };
                msgDiv.onmouseover = function() { this.style.background = '#f5f5f5'; };
                msgDiv.onmouseout = function() { this.style.background = originalBg; };
            };
            
            // Save handler
            saveBtn.onclick = async function() {
                const newMessage = textarea.value.trim();
                if (!newMessage) {
                    showAlert('Mesaj boş olamaz.', 'warning');
                    return;
                }
                
                try {
                    saveBtn.disabled = true;
                    saveBtn.textContent = '⏳ Kaydediliyor...';
                    
                    // Update in Supabase
                    const { error } = await supabase
                        .from('messageQueue')
                        .update({ message: newMessage })
                        .eq('id', messageId);
                    
                    if (error) throw error;
                    
                    // Update UI with escaped text
                    const escapedMessage = newMessage
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                    
                    msgDiv.innerHTML = escapedMessage;
                    msgDiv.style.cursor = 'pointer';
                    msgDiv.style.background = originalBg;
                    msgDiv.onclick = function() { window.makeMessageEditable(messageId); };
                    msgDiv.onmouseover = function() { this.style.background = '#f5f5f5'; };
                    msgDiv.onmouseout = function() { this.style.background = originalBg; };
                    
                    showAlert('Mesaj güncellendi.', 'success');
                    
                } catch (error) {
                    console.error('Error updating message:', error);
                    showAlert('Mesaj güncellenirken hata oluştu: ' + error.message, 'danger');
                    saveBtn.disabled = false;
                    saveBtn.textContent = '✓ Kaydet';
                }
            };
        };

        async function showMemberAttendancePage(memberId) {
            showSection('members');
            const contentDiv = document.getElementById('member-detail-content');
            if (!contentDiv) {
                console.error('member-detail-content not found');
                return;
            }
            
            // Üye listesini gizle, detayı göster
            const memberListCard = document.getElementById('members-list-card');
            if (memberListCard) memberListCard.style.display = 'none';
            contentDiv.style.display = 'block';
            contentDiv.innerHTML = `<div class="loading"><div class="spinner"></div><span>Üye verileri yükleniyor...</span></div>`;

            const member = members.find(m => m.id === memberId);
            if (!member) {
                contentDiv.innerHTML = `<div class="card empty-state"><h3>Hata: Üye bulunamadı.</h3></div>`;
                return;
            }
            
            const memberGroups = groups.filter(g => Array.isArray(g.members) && g.members.includes(member.id));
            const memberName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad;
            
            // 🔍 DEBUG: Grup bilgisi kontrolü
            console.log('🔍 Grup Debug:', {
                memberId: member.id,
                memberName: memberName,
                totalGroups: groups.length,
                memberGroups: memberGroups.length,
                memberGroupsDetails: memberGroups.map(g => ({ name: g.groupName, memberCount: g.members?.length })),
                allGroupsWithThisMember: groups.filter(g => g.members?.includes(member.id)).map(g => g.groupName)
            });
            
            // Update header to show member name
            const headerTitle = document.getElementById('header-title-members');
            if (headerTitle) headerTitle.textContent = `👤 ${memberName}`;
            
            // Debug: Attendance kayıtlarını kontrol et
            console.log('🔍 Attendance Debug:', {
                memberId: memberId,
                totalAttendanceRecords: attendanceRecords.length,
                memberAttendanceRecords: attendanceRecords.filter(r => r.memberId === memberId).length
            });
            
            const memberAttendanceRecords = attendanceRecords.filter(r => r.memberId === memberId).sort((a, b) => new Date(b.date) - new Date(a.date));

            const totalRecords = memberAttendanceRecords.length;
            const presentCount = memberAttendanceRecords.filter(r => r.status === 'present').length;
            const absentCount = totalRecords - presentCount;
            const attendanceRate = totalRecords > 0 ? ((presentCount / totalRecords) * 100).toFixed(1) : 0;
            const birthDate = member.studentBirthDate ? formatDate(member.studentBirthDate) : 'Belirtilmemiş';
            
            // ✅ Üyenin aidat bilgilerini al - sadece "Tüm Ödeme Planını Gör" butonu için kontrol
            const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
            let paymentInfoHtml = '';
            
            if (preReg && preReg.paymentSchedule && preReg.paymentSchedule.length > 0) {
                paymentInfoHtml = `
                    <div class="card" style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 class="card-title" style="margin: 0;">💰 Ödeme Takvimi</h2>
                            <button class="btn btn-primary" onclick="event.stopPropagation(); window.viewPaymentPlan('${preReg.id}')">
                                📋 Tüm Ödeme Planını Gör
                            </button>
                        </div>
                    </div>
                `;
            }
            
            let memberInfoHtml = '';
            const isChild = member.Resit_Olmayan_Adi_Soyadi && member.Resit_Olmayan_Adi_Soyadi.trim() !== '';

            if (isChild) {
                let veli2Html = '';
                if(member.Veli_2_Adi_Soyadi || member.Telefon_2) {
                    veli2Html = `
                        <div class="contact-card">
                            <div class="contact-card-header">Veli 2</div>
                            <div class="contact-card-body">
                                ${member.Veli_2_Adi_Soyadi ? `<p><strong>İsim:</strong> <span>${member.Veli_2_Adi_Soyadi}</span></p>` : ''}
                                ${member.Telefon_2 ? `<p><strong>Telefon:</strong> <span>${formatPhoneDisplay(member.Telefon_2)}</span></p>` : ''}
                            </div>
                        </div>`;
                }

                memberInfoHtml = `
                <div class="member-info-container">
                    <div class="member-info-main">
                        <div class="detail-item"><strong>Üye Adı Soyadı:</strong> <span>${memberName}</span></div>
                        <div class="detail-item" id="student-tc-info-${memberId}"><strong>🆔 TC:</strong> <span>...</span></div>
                        <div class="detail-item"><strong>Doğum Tarihi:</strong> <span>${birthDate}</span></div>
                        <div class="detail-item"><strong>Branş:</strong> <span>${capitalize(member.Brans || 'Bilinmiyor')}</span></div>
                        <div class="detail-item"><strong>Gruplar:</strong> <span>${memberGroups.length > 0 ? memberGroups.map(g => g.groupName).join(', ') : 'Atanmamış'}</span></div>
                    </div>
                    <div class="member-info-contact">
                        <h4>Veli Bilgileri</h4>
                        <div class="contact-card">
                            <div class="contact-card-header">Veli 1</div>
                            <div class="contact-card-body">
                                <p><strong>İsim:</strong> <span>${member.Ad_Soyad || 'Belirtilmemiş'}</span></p>
                                <p><strong>Telefon:</strong> <span>${member.Telefon ? formatPhoneDisplay(member.Telefon) : 'Belirtilmemiş'}</span></p>
                                <p id="parent-tc-info-${memberId}"><strong>🆔 TC:</strong> <span>...</span></p>
                                <p id="parent-birth-info-${memberId}"><strong>📅 Doğum Tarihi:</strong> <span>...</span></p>
                            </div>
                        </div>
                        ${veli2Html}
                    </div>
                </div>
                `;
            } else { // Adult member
                 memberInfoHtml = `
                    <div class="member-details-grid">
                        <div class="detail-item"><strong>Üye Adı Soyadı:</strong> <span>${memberName}</span></div>
                        <div class="detail-item"><strong>Telefon:</strong> <span>${member.Telefon ? formatPhoneDisplay(member.Telefon) : 'Belirtilmemiş'}</span></div>
                        <div class="detail-item"><strong>Doğum Tarihi:</strong> <span>${birthDate}</span></div>
                        <div class="detail-item"><strong>Branş:</strong> <span>${capitalize(member.Brans || 'Bilinmiyor')}</span></div>
                        <div class="detail-item"><strong>Gruplar:</strong> <span>${memberGroups.length > 0 ? memberGroups.map(g => g.groupName).join(', ') : 'Atanmamış'}</span></div>
                    </div>
                 `;
            }


            const detailsHtml = `
                <button class="btn btn-secondary" onclick="hideMemberDetail()" style="margin-bottom: 15px;">
                    ← Üye Listesine Dön
                </button>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 class="card-title" style="margin: 0;">Üye Bilgileri</h2>
                        <button class="btn btn-primary btn-sm" onclick="openMemberEditForm('${memberId}')">
                            ✏️ Bilgileri Düzenle
                        </button>
                    </div>
                    ${memberInfoHtml}
                </div>

                ${paymentInfoHtml}

                <div class="stats-grid" style="margin-top: 20px;">
                    <div class="stat-card">
                        <div class="stat-number">${totalRecords}</div>
                        <div class="stat-label">Toplam Ders</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--success-color);">
                        <div class="stat-number" style="color: var(--success-color);">${presentCount}</div>
                        <div class="stat-label">Katıldığı Ders</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--danger-color);">
                        <div class="stat-number" style="color: var(--danger-color);">${absentCount}</div>
                        <div class="stat-label">Katılmadığı Ders</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--info-color);">
                        <div class="stat-number" style="color: var(--info-color);">${attendanceRate}%</div>
                        <div class="stat-label">Katılım Oranı</div>
                    </div>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 class="card-title" style="margin: 0;">Yoklama Geçmişi (Dönem Dönem)</h2>
                        <button class="btn btn-success btn-sm" onclick="openAddMemberAttendanceModal('${memberId}')">
                            ➕ Yeni Yoklama Ekle
                        </button>
                    </div>
                    ${generatePeriodBasedAttendance(member, preReg, memberAttendanceRecords)}
                </div>

                <div class="card">
                    <h2 class="card-title">📞 Görüşme Kayıtları</h2>
                    <div id="member-call-records-${memberId}">
                        <div class="loading"><div class="spinner"></div><span>Görüşme kayıtları yükleniyor...</span></div>
                    </div>
                </div>
            `;
            
            contentDiv.innerHTML = detailsHtml;
            
            // ✅ preRegistrations'dan TC bilgilerini çek ve göster
            (async () => {
                try {
                    console.log('🔍 TC bilgileri aranıyor (showMemberAttendancePage)...', {
                        telefon: member.Telefon,
                        clubId: currentClubId,
                        memberId: memberId
                    });
                    
                    const { data: preReg, error } = await supabase
                        .from('preRegistrations')
                        .select('studentTc, parentTc, parentBirthDate')
                        .eq('Telefon', member.Telefon)
                        .eq('clubId', currentClubId)
                        .order('createdAt', { ascending: false })
                        .limit(1)
                        .single();
                    
                    console.log('📊 preReg sonucu:', { preReg, error });
                    
                    if (!error && preReg) {
                        // Öğrenci TC
                        const studentTcEl = document.getElementById(`student-tc-info-${memberId}`);
                        if (studentTcEl && preReg.studentTc) {
                            studentTcEl.innerHTML = `<strong>🆔 TC:</strong> <span>${preReg.studentTc}</span>`;
                            console.log('✅ Öğrenci TC güncellendi:', preReg.studentTc);
                        } else if (studentTcEl) {
                            studentTcEl.innerHTML = `<strong>🆔 TC:</strong> <span style="color: #999;">Belirtilmemiş</span>`;
                        }
                        
                        // Veli TC
                        const parentTcEl = document.getElementById(`parent-tc-info-${memberId}`);
                        if (parentTcEl && preReg.parentTc) {
                            parentTcEl.innerHTML = `<strong>🆔 TC:</strong> <span>${preReg.parentTc}</span>`;
                            console.log('✅ Veli TC güncellendi:', preReg.parentTc);
                        } else if (parentTcEl) {
                            parentTcEl.innerHTML = `<strong>🆔 TC:</strong> <span style="color: #999;">Belirtilmemiş</span>`;
                        }
                        
                        // Veli Doğum Tarihi
                        const parentBirthEl = document.getElementById(`parent-birth-info-${memberId}`);
                        if (parentBirthEl && preReg.parentBirthDate) {
                            parentBirthEl.innerHTML = `<strong>📅 Doğum Tarihi:</strong> <span>${new Date(preReg.parentBirthDate).toLocaleDateString('tr-TR')}</span>`;
                            console.log('✅ Veli Doğum Tarihi güncellendi:', preReg.parentBirthDate);
                        } else if (parentBirthEl) {
                            parentBirthEl.innerHTML = `<strong>📅 Doğum Tarihi:</strong> <span style="color: #999;">Belirtilmemiş</span>`;
                        }
                    } else {
                        console.warn('⚠️ preRegistration bulunamadı');
                        // Elementleri "Belirtilmemiş" olarak güncelle
                        const studentTcEl = document.getElementById(`student-tc-info-${memberId}`);
                        if (studentTcEl) studentTcEl.innerHTML = `<strong>🆔 TC:</strong> <span style="color: #999;">Belirtilmemiş</span>`;
                        
                        const parentTcEl = document.getElementById(`parent-tc-info-${memberId}`);
                        if (parentTcEl) parentTcEl.innerHTML = `<strong>🆔 TC:</strong> <span style="color: #999;">Belirtilmemiş</span>`;
                        
                        const parentBirthEl = document.getElementById(`parent-birth-info-${memberId}`);
                        if (parentBirthEl) parentBirthEl.innerHTML = `<strong>📅 Doğum Tarihi:</strong> <span style="color: #999;">Belirtilmemiş</span>`;
                    }
                } catch (err) {
                    console.error('❌ TC bilgileri yüklenemedi:', err);
                }
            })();
            
            // Görüşme kayıtlarını yükle
            const phoneNumber = member.Telefon || member.Telefon_2;
            if (phoneNumber) {
                await renderCallRecords(phoneNumber, `member-call-records-${memberId}`);
            } else {
                const callRecordsContainer = document.getElementById(`member-call-records-${memberId}`);
                if (callRecordsContainer) {
                    callRecordsContainer.innerHTML = '<p style="color: #999; padding: 15px;">Bu üye için telefon numarası bulunamadı.</p>';
                }
            }
        }

        async function toggleAttendanceStatus(recordId, currentStatus) {
            const newStatus = currentStatus === 'present' ? 'absent' : 'present';
            try {
                // ✅ SUPABASE: attendanceRecords tablosunda status güncelle
                const { error } = await supabase
                    .from('attendanceRecords')
                    .update({ status: newStatus })
                    .eq('id', recordId);
                
                if (error) {
                    console.error("Supabase update error:", error);
                    throw error;
                }
                
                const recordIndex = attendanceRecords.findIndex(rec => rec.id === recordId);
                if (recordIndex > -1) {
                    attendanceRecords[recordIndex].status = newStatus;
                     // Refresh the view for the specific member
                    showMemberAttendancePage(attendanceRecords[recordIndex].memberId);
                }
                showAlert('Yoklama durumu güncellendi (Supabase).', 'success');
            } catch (error) {
                 console.error("Error toggling attendance status:", error);
                 showAlert('Durum güncellenirken bir hata oluştu: ' + error.message, 'danger');
            }
        }
        
         function editAttendanceDate(buttonEl, recordId) {
            const dateCell = buttonEl.closest('.editable-date');
            const record = attendanceRecords.find(r => r.id === recordId);
            if (!record) return;

            dateCell.innerHTML = `<input type="date" class="form-control" value="${record.date}" onblur="saveAttendanceDate(this, '${record.id}')" onkeypress="if(event.key === 'Enter') this.blur()" autofocus>`;
            dateCell.querySelector('input').focus();
        }

        async function saveAttendanceDate(inputEl, recordId) {
            const newDate = inputEl.value;
            const record = attendanceRecords.find(r => r.id === recordId);
            if (!record || !newDate) {
                if(record) showMemberAttendancePage(record.memberId); // Re-render to cancel edit
                return;
            }

            try {
                // ✅ SUPABASE: attendanceRecords tablosunda güncelle
                const { error } = await supabase
                    .from('attendanceRecords')
                    .update({ date: newDate })
                    .eq('id', recordId);
                
                if (error) {
                    console.error("Supabase update error:", error);
                    throw error;
                }
                
                record.date = newDate; // Update local data
                
                showAlert('Yoklama tarihi güncellendi (Supabase).', 'success');
                showMemberAttendancePage(record.memberId); // Refresh view
            } catch (error) {
                console.error("Error updating attendance date:", error);
                showAlert('Tarih güncellenirken bir hata oluştu: ' + error.message, 'danger');
                if(record) showMemberAttendancePage(record.memberId); // Re-render on error
            }
        }

        function toggleActionsMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('context-menu');
            const button = event.currentTarget;
            const type = button.dataset.type;
            const memberId = button.dataset.memberId;
            const preRegId = button.dataset.preregId;

            if (type === 'prereg' && !preRegId) {
                return showAlert('Bu kaydın ilişkili ön kayıt verisi bulunamadı. Lütfen kontrol ediniz.', 'danger');
            }

            const isAlreadyOpen = menu.classList.contains('active');
            const currentActiveId = menu.dataset.activeButtonId;
            const newId = memberId || preRegId;

            // First, always hide the menu to simplify logic
            menu.classList.remove('active');

            // If we clicked the same button that the menu was open for, we're done.
            if (isAlreadyOpen && currentActiveId === newId) {
                return;
            }

            // --- Populate Menu Content ---
            let menuHtml = '';
            if (type === 'prereg') {
                let paymentLink = '';
                if (currentUser?.permissions?.view_payments) {
                    paymentLink = `<a href="#" onclick="viewPaymentPlan('${preRegId}')">💰 Ödeme Planı Görüntüle</a>`;
                }
                menuHtml = `${paymentLink}<a href="#" onclick="openPreRegEditModal('${preRegId}')">✏️ Kaydı Düzenle</a><a href="#" class="danger" onclick="deleteItem('preRegistrations', '${preRegId}')">🗑️ Kaydı Sil</a>`;
            } else if (type === 'member') {
                menuHtml = `<a href="#" onclick="viewMemberPayments('${memberId}')">💰 Ödeme Planı Görüntüle</a><a href="#" onclick="assignToGroup('${memberId}', null)">🔄 Gruba Ata/Taşı</a><a href="#" onclick="openMemberEditForm('${memberId}')">✏️ Bilgileri Düzenle</a><a href="#" class="danger" onclick="deleteItem('members', '${memberId}')">🗑️ Üyeyi Sil</a>`;
            }
            menu.innerHTML = menuHtml;
            document.body.appendChild(menu); // Append to body to avoid clipping issues
            
            const rect = button.getBoundingClientRect();

            // Position menu relative to the viewport
            menu.style.top = `${rect.bottom + window.scrollY + 5}px`;
            
            const menuWidth = menu.offsetWidth;
            const clientWidth = document.documentElement.clientWidth;

            if (rect.left + menuWidth > clientWidth - 10) {
                 menu.style.left = 'auto';
                 menu.style.right = `${clientWidth - rect.right}px`;
            } else {
                 menu.style.left = `${rect.left}px`;
                 menu.style.right = 'auto';
            }

            menu.classList.add('active');
            menu.dataset.activeButtonId = newId;
        }


        function closeAllMenus(event) {
            const contextMenu = document.getElementById('context-menu');
            if (contextMenu && !event.target.closest('.actions-toggle')) {
                contextMenu.classList.remove('active');
            }
            
            const phoneMenu = document.getElementById('phone-context-menu');
            if (phoneMenu && !event.target.closest('.phone-link')) {
                phoneMenu.style.display = 'none';
            }
        }

        function handlePhoneClick(event, phone) {
            event.preventDefault();
            event.stopPropagation();
            if (!phone) return;

            // Close other menus first
            const contextMenu = document.getElementById('context-menu');
            if(contextMenu) {
                contextMenu.classList.remove('active');
            }

            const menu = document.getElementById('phone-context-menu');
            const copyBtn = document.getElementById('phone-copy-btn');
            const callBtn = document.getElementById('phone-call-btn');

            copyBtn.onclick = (e) => {
                e.stopPropagation();
                const tempInput = document.createElement("textarea");
                tempInput.value = phone;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand('copy');
                    showAlert('Telefon numarası kopyalandı!', 'success');
                } catch (err) {
                     showAlert('Kopyalanamadı.', 'danger');
                }
                document.body.removeChild(tempInput);
                menu.style.display = 'none';
            };
            callBtn.onclick = (e) => {
                e.stopPropagation();
                window.location.href = `tel:${phone}`;
                menu.style.display = 'none';
            };

            const rect = event.target.getBoundingClientRect();
            menu.style.top = `${rect.bottom + 5}px`;
            menu.style.left = `${rect.left}px`;
            menu.style.display = 'block';
        }
        
        function toggleReasonInput(checkbox, memberId) {
            const reasonInput = document.querySelector(`input[name="reason_${memberId}"]`);
            reasonInput.style.display = checkbox.checked ? 'none' : 'block';
        }
        
        function changeMembersPage(direction) {
            membersCurrentPage += direction;
            renderMembersTable();
        }

        function changeMembersItemsPerPage(selectElement) {
            membersItemsPerPage = parseInt(selectElement.value, 10);
            membersCurrentPage = 1;
            renderMembersTable();
        }

        function promptMoveOrAdd(memberId, newGroupId) {
            const member = members.find(m => m.id === memberId);
            const newGroup = groups.find(g => g.id === newGroupId);
            if (!member || !newGroup) return;

            const memberGroups = groups.filter(g => Array.isArray(g.members) && g.members.includes(memberId));

            if (memberGroups.length === 0) {
                // Member is in no groups, so just add them without asking.
                confirmGroupAssignment(memberId, newGroupId, false);
                return;
            }

            const modal = document.getElementById('choiceModal');
            modal.querySelector('#choiceTitle').textContent = 'Gruba Ekleme Yöntemi';
            modal.querySelector('#choiceText').textContent = `"${member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad}" adlı üyeyi "${newGroup.groupName}" grubuna nasıl eklemek istersiniz?`;
            
            const buttonContainer = modal.querySelector('#choiceButtons');
            buttonContainer.innerHTML = `
                <button class="btn btn-primary" onclick="window.confirmGroupAssignment('${memberId}', '${newGroupId}', false); event.stopPropagation();" style="margin: 5px;">SADECE BU GRUBA EKLE</button>
                <button class="btn btn-warning" onclick="window.confirmGroupAssignment('${memberId}', '${newGroupId}', true); event.stopPropagation();" style="margin: 5px;">TAŞI (DİĞER GRUPLARDAN ÇIKAR)</button>
                <button class="btn btn-secondary" onclick="window.closeModal('choiceModal'); event.stopPropagation();" style="margin: 5px;">İPTAL</button>
            `;
            
            openModal('choiceModal');
        }

        // --- Expose functions to global scope for onclick handlers ---
        window.showSection = showSection;
        window.setPaymentFilter = setPaymentFilter;
        window.filterScheduleByBranch = filterScheduleByBranch;
        window.filterGroupsByBranch = filterGroupsByBranch;
        window.openGroupModal = openGroupModal;
        window.closeModal = closeModal;
        window.deleteItem = deleteItem;
        window.updateMemberStatus = updateMemberStatus;
        window.viewPaymentPlan = viewPaymentPlan;
        window.openPreRegEditModal = openPreRegEditModal;
        window.openMemberEditModal = openMemberEditModal;
        window.assignToGroup = assignToGroup;
        window.viewMemberPayments = viewMemberPayments;
        window.togglePaymentDetails = togglePaymentDetails;
        window.openPaymentEditModal = openPaymentEditModal;
        window.drag = drag;
        window.allowDrop = allowDrop;
        window.drop = drop;
        window.openAttendanceModal = openAttendanceModal;
        window.deleteSchedule = deleteSchedule;
        window.removeMemberFromGroup = removeMemberFromGroup;
        window.confirmGroupAssignment = confirmGroupAssignment;
        window.openGroupEditModal = openGroupEditModal;
        window.navigateToSection = navigateToSection;
        window.showMemberAttendancePage = showMemberAttendancePage;
        window.toggleActionsMenu = toggleActionsMenu;
        window.handlePhoneClick = handlePhoneClick;
        window.toggleReasonInput = toggleReasonInput;
        window.sortMembersByAge = sortMembersByAge;
        window.editReason = editReason;
        window.saveReason = saveReason;
        window.changeMembersPage = changeMembersPage;
        window.changeMembersItemsPerPage = changeMembersItemsPerPage;
        window.deletePaymentFromSchedule = deletePaymentFromSchedule;
        window.recalculateSubsequentPayments = recalculateSubsequentPayments;
        window.toggleAttendanceStatus = toggleAttendanceStatus;
        window.openScheduleModalForGroup = openScheduleModalForGroup;
        window.handleTaskSubmit = handleTaskSubmit;
        window.openTaskEditModal = openTaskEditModal;
        window.openTaskMessagesModal = openTaskMessagesModal;
        window.deleteTaskMessage = deleteTaskMessage;
        window.openProfileEditModal = openProfileEditModal;
        window.deleteAttendanceRecord = deleteAttendanceRecord;
        window.editAttendanceDate = editAttendanceDate;
        window.saveAttendanceDate = saveAttendanceDate;
        window.promptMoveOrAdd = promptMoveOrAdd;
        window.renderAbsentStudents = renderAbsentStudents;
        window.selectAllPayments = selectAllPayments;
        window.markSelectedPaymentsAsPaid = markSelectedPaymentsAsPaid;
        window.deleteSelectedPayments = deleteSelectedPayments;
        window.switchSettingsTab = switchSettingsTab;
        window.showInstanceQR = showInstanceQR;
        window.restartInstance = restartInstance;
        window.deleteInstance = deleteInstance;
        window.checkConnectionStatus = checkConnectionStatus;
        
        // Dropdown toggle with event delegation (works in modals too)
        document.addEventListener('click', function(e) {
            // Toggle dropdown when clicking the button
            if (e.target.closest('.actions-dropdown-btn')) {
                e.stopPropagation();
                const btn = e.target.closest('.actions-dropdown-btn');
                const dropdown = btn.closest('.actions-dropdown');
                const wasActive = dropdown.classList.contains('active');
                
                // Close all other dropdowns
                document.querySelectorAll('.actions-dropdown.active').forEach(d => {
                    if (d !== dropdown) {
                        d.classList.remove('active');
                    }
                });
                
                // Toggle current dropdown
                if (!wasActive) {
                    dropdown.classList.add('active');
                    
                    // Position the dropdown menu
                    const dropdownContent = dropdown.querySelector('.actions-dropdown-content');
                    const btnRect = btn.getBoundingClientRect();
                    
                    // Position below the button, aligned to the right
                    dropdownContent.style.top = (btnRect.bottom + 5) + 'px';
                    dropdownContent.style.left = (btnRect.right - 180) + 'px'; // 180px is min-width
                    
                    // Check if it goes off screen bottom
                    const contentRect = dropdownContent.getBoundingClientRect();
                    if (contentRect.bottom > window.innerHeight) {
                        // Show above the button instead
                        dropdownContent.style.top = (btnRect.top - contentRect.height - 5) + 'px';
                    }
                    
                    // Check if it goes off screen left
                    if (contentRect.left < 0) {
                        dropdownContent.style.left = '10px';
                    }
                } else {
                    dropdown.classList.remove('active');
                }
                return;
            }
            
            // Handle clicks inside dropdown content
            if (e.target.closest('.actions-dropdown-content button')) {
                // Close dropdown after clicking a button
                setTimeout(() => {
                    document.querySelectorAll('.actions-dropdown.active').forEach(d => {
                        d.classList.remove('active');
                    });
                }, 100);
                return;
            }
            
            // Don't close if clicking inside dropdown content (but not a button)
            if (e.target.closest('.actions-dropdown-content')) {
                return;
            }
            
            // Close all dropdowns when clicking outside
            document.querySelectorAll('.actions-dropdown.active').forEach(d => {
                d.classList.remove('active');
            });
        });
        
        // Close dropdowns on scroll
        window.addEventListener('scroll', function() {
            document.querySelectorAll('.actions-dropdown.active').forEach(d => {
                d.classList.remove('active');
            });
        }, true);
        
        // Debug tool for checking payment info by phone
        window.debugPaymentInfo = function(phone) {
            console.log('=== ÖDEME BİLGİSİ KONTROL ===');
            console.log('Aranan Telefon:', phone);
            
            // Normalize phone
            let normalizedPhone = phone.replace(/\s/g, '').replace(/\D/g, '');
            if (normalizedPhone.startsWith('0')) {
                normalizedPhone = normalizedPhone.substring(1);
            }
            const phoneFormats = [phone, '0' + normalizedPhone, '90' + normalizedPhone, normalizedPhone];
            
            console.log('Denenen Formatlar:', phoneFormats);
            
            // Find member
            const member = members.find(m => phoneFormats.includes(m.Telefon));
            if (!member) {
                console.error('❌ Üye bulunamadı!');
                return;
            }
            
            console.log('✅ Üye Bulundu:', member.Ad_Soyad, member.Resit_Olmayan_Adi_Soyadi);
            console.log('Üye ID:', member.id);
            console.log('PreRegistration ID:', member.preRegistrationId);
            console.log('Telefon:', member.Telefon);
            
            // Find preRegistration by ID
            let preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
            
            if (!preReg) {
                console.warn('⚠️ PreRegistration ID ile bulunamadı, telefon ile aranıyor...');
                preReg = preRegistrations.find(p => phoneFormats.includes(p.phone));
            }
            
            if (!preReg) {
                console.error('❌ Ödeme planı bulunamadı!');
                console.log('Tüm PreRegistrations:', preRegistrations.map(p => ({ id: p.id, phone: p.phone })));
                return;
            }
            
            console.log('✅ Ödeme Planı Bulundu:');
            console.log('PreReg ID:', preReg.id);
            console.log('PreReg Telefon:', preReg.phone);
            console.log('Branş:', preReg.branch);
            console.log('Dönem:', formatDate(preReg.periodStart), '-', formatDate(preReg.periodEnd));
            console.log('\n=== ÖDEME PLANI ===');
            
            if (preReg.paymentSchedule && preReg.paymentSchedule.length > 0) {
                console.table(preReg.paymentSchedule.map(p => ({
                    'Taksit': p.paymentNumber,
                    'Tutar': p.amount + ' ₺',
                    'Dönem Başlangıç': formatDate(p.period?.start),
                    'Dönem Bitiş': formatDate(p.period?.end),
                    'Ders Sayısı': p.period?.lessonCount || 'YOK',
                    'Son Ödeme': formatDate(p.dueDate),
                    'Durum': p.status,
                    'Ödeme Tarihi': p.paymentDate ? formatDate(p.paymentDate) : '-'
                })));
            } else {
                console.log('❌ Ödeme planı boş!');
            }
            
            return { member, preReg };
        };
        
        window.manualCheckConnection = async function(instanceName, deviceId) {
            showAlert('🔍 Bağlantı kontrol ediliyor...', 'info');
            
            const isConnected = await checkConnectionStatus(instanceName, deviceId);
            
            if (isConnected) {
                showAlert('✅ WhatsApp bağlantısı başarılı! Cihaz kullanıma hazır.', 'success');
                loadWhatsAppInstances();
            } else {
                showAlert('⚠️ Cihaz henüz bağlanmadı. QR kodu okuttuğunuzdan emin olun.', 'warning');
            }
        };
        
        window.sendTestWhatsAppMessage = async function(event) {
            event.preventDefault();
            
            const form = event.target;
            const instanceName = form.testMessageDevice.value;
            const phone = form.testMessagePhone.value.trim();
            const message = form.testMessageText.value.trim();
            
            console.log('Test mesajı gönderiliyor:', { instanceName, phone, message });
            
            if (!phone || !message) {
                return showAlert('Lütfen telefon ve mesaj alanlarını doldurun.', 'warning');
            }
            
            if (!instanceName || instanceName === '') {
                return showAlert('Lütfen bir WhatsApp cihazı seçin. Önce cihaz bağlayın.', 'warning');
            }
            
            // Check if device exists and is connected
            const device = whatsappDevices.find(d => d.instanceName === instanceName);
            if (!device) {
                return showAlert('Seçilen cihaz bulunamadı. Lütfen sayfayı yenileyin.', 'danger');
            }
            
            if (device.status !== 'connected') {
                return showAlert(`Cihaz bağlı değil! Durum: ${device.status}. Lütfen QR kodu okutun.`, 'warning');
            }
            
            // Show loading
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '⏳ Gönderiliyor...';
            
            try {
                // Format phone number for WhatsApp (remove leading 0 if exists, add @s.whatsapp.net)
                let formattedPhone = phone.replace(/\D/g, ''); // Remove non-digits
                if (formattedPhone.startsWith('0')) {
                    formattedPhone = formattedPhone.substring(1); // Remove leading 0
                }
                if (!formattedPhone.startsWith('90')) {
                    formattedPhone = '90' + formattedPhone; // Add country code if missing
                }
                
                const apiUrl = `${EVOLUTION_API_URL}/message/sendText/${instanceName}`;
                const requestBody = {
                    number: `${formattedPhone}@s.whatsapp.net`,
                    text: message
                };
                
                console.log('API İsteği:', {
                    url: apiUrl,
                    body: requestBody,
                    device: device
                });
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': EVOLUTION_API_KEY
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('API Yanıtı - Status:', response.status, 'OK:', response.ok);
                
                const data = await response.json().catch(err => {
                    console.error('JSON parse hatası:', err);
                    return null;
                });
                
                console.log('API Yanıt Data:', data);
                
                if (response.ok) {
                    showAlert('✅ Mesaj başarıyla gönderildi!', 'success');
                    form.testMessageText.value = '';
                } else {
                    console.error('Mesaj gönderme hatası:', { 
                        status: response.status, 
                        statusText: response.statusText,
                        data: data 
                    });
                    
                    let errorMsg = 'Bilinmeyen hata';
                    if (response.status === 500) {
                        errorMsg = 'Sunucu hatası. Instance adını kontrol edin veya cihazı yeniden başlatın.';
                        if (data && data.message) {
                            errorMsg += ` Detay: ${data.message}`;
                        }
                    } else if (response.status === 404) {
                        errorMsg = 'Instance bulunamadı. Cihaz adını kontrol edin.';
                    } else if (response.status === 401) {
                        errorMsg = 'API Key hatası. Yetkisiz erişim.';
                    } else if (data) {
                        errorMsg = data.message || data.error || `HTTP ${response.status}`;
                    }
                    showAlert(`❌ Mesaj gönderilemedi: ${errorMsg}`, 'danger');
                }
            } catch (error) {
                console.error('Mesaj gönderme exception:', error);
                showAlert(`❌ Mesaj gönderilirken hata oluştu: ${error.message}`, 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        };

        // =====================================================
        // 📥 BULK IMPORT FUNCTIONS
        // =====================================================
        
        let importData = []; // Parse edilen veriler
        let validImportRecords = []; // Geçerli kayıtlar
        
        // Modal açma/kapama
        window.openBulkImportModal = function() {
            document.getElementById('bulkImportModal').style.display = 'flex';
            resetImportSteps();
        };
        
        window.closeBulkImportModal = function() {
            document.getElementById('bulkImportModal').style.display = 'none';
            resetImportSteps();
            importData = [];
            validImportRecords = [];
            document.getElementById('csvFileInput').value = '';
        };
        
        function resetImportSteps() {
            document.getElementById('import-step-1').style.display = 'block';
            document.getElementById('import-step-2').style.display = 'none';
            document.getElementById('import-step-3').style.display = 'none';
            document.getElementById('import-step-4').style.display = 'none';
        }
        
        // Şablon indirme - Excel formatında dropdown menüler ile
        window.downloadImportTemplate = function() {
            if (typeof XLSX === 'undefined') {
                showAlert('❌ Excel kütüphanesi yüklenemedi. Lütfen sayfayı yenileyin.', 'danger');
                return;
            }
            
            // Branş listesi
            const branchNames = branches.map(b => b.name);
            
            // Etiket listesi (branş etiketleri hariç)
            const tagNames = crmTags
                .filter(tag => tag.category !== 'branch')
                .map(tag => tag.name);
            
            // Kaynak listesi
            const sources = ['Telefon', 'WhatsApp', 'Sosyal Medya', 'Referans', 'Web Sitesi', 'Diğer'];
            
            // Yaş grubu listesi
            const ageGroups = ['Yetişkin', 'Çocuk'];
            
            // Excel workbook oluştur
            const wb = XLSX.utils.book_new();
            
            // Ana veri sayfası
            const mainSheet = [
                ['Telefon', 'Ad Soyad', 'Kaynak', 'Branş', 'Yaş Grubu', 'Etiket', 'Veli Adı (Çocuk için)', 'Çocuk Adı', 'Çocuk Yaşı', 'Not'],
                ['05321234567', 'Ahmet Yılmaz', 'Telefon', branchNames[0] || 'Tenis', 'Yetişkin', tagNames[0] || 'Aranmadı', '', '', '', 'İlk görüşme yapıldı'],
                ['05439876543', '', 'WhatsApp', branchNames[0] || 'Tenis', 'Çocuk', 'Denemeye Gelecek', 'Ayşe Demir', 'Zeynep Demir', '8', 'Cumartesi deneme dersi'],
                ['05551234567', 'Mehmet Kaya', 'Sosyal Medya', branchNames[0] || 'Voleybol', 'Yetişkin', 'Aranmadı', '', '', '', 'Fiyat bilgisi verildi'],
                ['05449876543', '', 'Telefon', branchNames[0] || 'Tenis', 'Çocuk', 'Kayıt Olabilir', 'Fatma Şahin', 'Ali Şahin', '10', '2 çocuk var'],
                ['05505123456', 'Hakan Yıldız', 'Referans', branchNames[0] || 'Tenis', 'Yetişkin', 'Aranmadı', '', '', '', 'Başlangıç seviyesi']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(mainSheet);
            
            // Sütun genişlikleri
            ws['!cols'] = [
                {wch: 12}, // Telefon
                {wch: 18}, // Ad Soyad
                {wch: 15}, // Kaynak
                {wch: 15}, // Branş
                {wch: 12}, // Yaş Grubu
                {wch: 18}, // Etiket
                {wch: 18}, // Veli Adı
                {wch: 18}, // Çocuk Adı
                {wch: 10}, // Çocuk Yaşı
                {wch: 25}  // Not
            ];
            
            // Dropdown validasyonları ekle - Tüm aralık için tek seferde
            ws['!dataValidation'] = [];
            
            // Kaynak dropdown (C2:C1000)
            ws['!dataValidation'].push({
                type: 'list',
                allowBlank: true,
                sqref: 'C2:C1000',
                formulas: [sources.join(',')]
            });
            
            // Branş dropdown (D2:D1000) - Branşlar sayfasından referans
            if (branchNames.length > 0) {
                ws['!dataValidation'].push({
                    type: 'list',
                    allowBlank: false,
                    sqref: 'D2:D1000',
                    formulas: [branchNames.join(',')]
                });
            }
            
            // Yaş Grubu dropdown (E2:E1000)
            ws['!dataValidation'].push({
                type: 'list',
                allowBlank: false,
                sqref: 'E2:E1000',
                formulas: [ageGroups.join(',')]
            });
            
            // Etiket dropdown (F2:F1000) - Etiketler sayfasından referans
            if (tagNames.length > 0) {
                ws['!dataValidation'].push({
                    type: 'list',
                    allowBlank: false,
                    sqref: 'F2:F1000',
                    formulas: [tagNames.join(',')]
                });
            }
            
            // Ana sayfayı ekle
            XLSX.utils.book_append_sheet(wb, ws, 'Müşteriler');
            
            // Yardımcı sayfa - Branşlar
            const branchSheet = [
                ['📋 Mevcut Branşlar'],
                ...branchNames.map(name => [name])
            ];
            const wsBranch = XLSX.utils.aoa_to_sheet(branchSheet);
            XLSX.utils.book_append_sheet(wb, wsBranch, 'Branşlar');
            
            // Yardımcı sayfa - Etiketler
            const tagSheet = [
                ['🏷️ Mevcut Etiketler'],
                ...tagNames.map(name => [name])
            ];
            const wsTag = XLSX.utils.aoa_to_sheet(tagSheet);
            XLSX.utils.book_append_sheet(wb, wsTag, 'Etiketler');
            
            // Yardımcı sayfa - Talimatlar
            const instructionsSheet = [
                ['📖 TOPLU MÜŞTERİ EKLEME TALİMATLARI'],
                [''],
                ['1. SÜTUN AÇIKLAMALARI:'],
                ['• Telefon: 05XX XXX XX XX formatında (zorunlu)'],
                ['• Ad Soyad: Yetişkin için doldurulmalı'],
                ['• Kaynak: Müşterinin nereden geldiği (Branşlar sayfasından kopyala-yapıştır)'],
                ['• Branş: İlgilendikleri branş (Branşlar sayfasından kopyala-yapıştır - zorunlu)'],
                ['• Yaş Grubu: "Yetişkin" veya "Çocuk" (elle yazın - zorunlu)'],
                ['• Etiket: Müşterinin durumu (Etiketler sayfasından kopyala-yapıştır - zorunlu)'],
                ['• Veli Adı: Sadece çocuk müşteriler için (zorunlu)'],
                ['• Çocuk Adı: Sadece çocuk müşteriler için (zorunlu)'],
                ['• Çocuk Yaşı: Çocuğun yaşı (opsiyonel)'],
                ['• Not: Ek açıklamalar (opsiyonel)'],
                [''],
                ['2. ÖNEMLİ KURALLAR:'],
                ['✓ Telefon numarası benzersiz olmalı'],
                ['✓ Yetişkin seçiliyse "Ad Soyad" doldurulmalı'],
                ['✓ Çocuk seçiliyse "Veli Adı" ve "Çocuk Adı" doldurulmalı'],
                ['✓ Branş ve Etiket için "Branşlar" ve "Etiketler" sayfalarındaki değerleri kullanın'],
                ['✓ Yaş Grubu: "Yetişkin" veya "Çocuk" (tam olarak bu şekilde yazın)'],
                [''],
                ['3. BRANŞ VE ETİKET NASIL SEÇİLİR?'],
                ['Yöntem 1 (Önerilen):'],
                ['• "Branşlar" veya "Etiketler" sekmesine git'],
                ['• İstediğin değeri kopyala (Ctrl+C)'],
                ['• "Müşteriler" sekmesindeki ilgili hücreye yapıştır (Ctrl+V)'],
                [''],
                ['Yöntem 2 (Manuel Dropdown):'],
                ['• Excel\'de hücreyi seç → Veri → Veri Doğrulama'],
                ['• Liste seç → Kaynak olarak "Branşlar" veya "Etiketler" sayfasını referans et'],
                ['• Örnek: =Branşlar!$A$2:$A$10 (branşlar için)'],
                [''],
                ['4. ÖRNEK VERİLER:'],
                ['• Örnek verileri inceleyip silebilir veya değiştirebilirsiniz'],
                ['• Yeni satırlar ekleyebilirsiniz'],
                ['• Branş/Etiket değerlerini kopyala-yapıştır ile ekleyin'],
                [''],
                ['5. DOSYA KAYDETME:'],
                ['• Dosyayı Excel formatında (.xlsx) olarak kaydedin'],
                ['• CSV olarak kaydetmeyin'],
                [''],
                ['6. YÜKLEME:'],
                ['• "Toplu İçe Aktar" bölümünden dosyayı yükleyin'],
                ['• Sistem otomatik kontrol yapacak ve hataları gösterecek'],
                [''],
                ['⚠️ ÖNEMLİ NOT:'],
                ['Branş ve Etiket isimlerini tam olarak "Branşlar" ve "Etiketler"'],
                ['sayfalarındaki gibi yazın. Yazım hatası yaparsanız sistem'],
                ['bu kayıtları kabul etmez!']
            ];
            const wsInstructions = XLSX.utils.aoa_to_sheet(instructionsSheet);
            wsInstructions['!cols'] = [{wch: 70}];
            XLSX.utils.book_append_sheet(wb, wsInstructions, 'Talimatlar');
            
            // Dosyayı indir
            XLSX.writeFile(wb, 'CRM_Toplu_Musteri_Ekleme_Sablonu.xlsx');
            
            showAlert('✅ Excel şablonu indirildi!\n\n📋 "Branşlar" ve "Etiketler" sekmelerinden değerleri kopyalayıp "Müşteriler" sekmesine yapıştırın.\n\n⚠️ Yazım hatası yapmamak için mutlaka kopyala-yapıştır kullanın!', 'success');
        };
        
        // Dosya seçme
        window.handleFileSelect = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('📁 Dosya seçildi:', file.name, file.type);
            
            try {
                if (file.name.endsWith('.csv')) {
                    await parseCSV(file);
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    await parseExcel(file);
                } else {
                    showAlert('❌ Desteklenmeyen dosya formatı! Lütfen CSV veya Excel dosyası yükleyin.', 'danger');
                    return;
                }
            } catch (error) {
                console.error('Dosya parse hatası:', error);
                showAlert('❌ Dosya okunurken hata oluştu: ' + error.message, 'danger');
            }
        };
        
        // Excel Parse (XLSX)
        async function parseExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        if (typeof XLSX === 'undefined') {
                            reject(new Error('Excel kütüphanesi yüklenemedi'));
                            return;
                        }
                        
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // İlk sheet'i al (Müşteriler sayfası)
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // JSON'a çevir (header: 1 ile array of arrays olarak al)
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        if (jsonData.length < 2) {
                            reject(new Error('Dosyada veri bulunamadı'));
                            return;
                        }
                        
                        // İlk satır başlık
                        const headers = jsonData[0];
                        
                        // Data satırları
                        importData = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (!row || row.length === 0 || !row[0]) continue; // Boş satır
                            
                            const record = {
                                rowNumber: i,
                                phone: row[0] ? String(row[0]) : '',
                                fullName: row[1] ? String(row[1]) : '',
                                source: row[2] ? String(row[2]) : '',
                                branchName: row[3] ? String(row[3]) : '',
                                ageGroup: row[4] ? String(row[4]) : '',
                                tag: row[5] ? String(row[5]) : '',
                                parentName: row[6] ? String(row[6]) : '',
                                childName: row[7] ? String(row[7]) : '',
                                childAge: row[8] ? String(row[8]) : '',
                                note: row[9] ? String(row[9]) : ''
                            };
                            
                            importData.push(record);
                        }
                        
                        console.log('📊 Excel\'den parse edilen kayıt sayısı:', importData.length);
                        
                        if (importData.length === 0) {
                            reject(new Error('Dosyada işlenebilir veri bulunamadı'));
                            return;
                        }
                        
                        // Validation ve preview
                        validateAndPreview();
                        resolve();
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Dosya okunamadı'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }
        
        // CSV Parse
        async function parseCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        const lines = text.split(/\r?\n/).filter(line => line.trim());
                        
                        if (lines.length < 2) {
                            reject(new Error('Dosya boş veya sadece başlık satırı var'));
                            return;
                        }
                        
                        // İlk satır header olmalı
                        const headers = lines[0].split(',').map(h => h.trim());
                        console.log('📋 CSV Headers:', headers);
                        
                        // Data satırları
                        importData = [];
                        for (let i = 1; i < lines.length; i++) {
                            const values = parseCSVLine(lines[i]);
                            if (values.length === 0) continue; // Boş satır
                            
                            const record = {
                                rowNumber: i,
                                phone: values[0] || '',
                                fullName: values[1] || '', // Yetişkin için
                                source: values[2] || '',
                                branchName: values[3] || '',
                                ageGroup: values[4] || '',
                                tag: values[5] || '',
                                parentName: values[6] || '', // Çocuk için veli adı
                                childName: values[7] || '', // Çocuk için çocuk adı
                                childAge: values[8] || '', // Çocuk için yaş
                                note: values[9] || ''
                            };
                            
                            importData.push(record);
                        }
                        
                        console.log('📊 Parse edilen kayıt sayısı:', importData.length);
                        
                        if (importData.length === 0) {
                            reject(new Error('Dosyada işlenebilir veri bulunamadı'));
                            return;
                        }
                        
                        // Validation ve preview
                        validateAndPreview();
                        resolve();
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Dosya okunamadı'));
                };
                
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // CSV satır parse (virgül içindeki virgülleri handle et)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }
        
        // Validation ve Preview
        function validateAndPreview() {
            validImportRecords = [];
            const invalidRecords = [];
            
            importData.forEach(record => {
                const errors = [];
                
                // Telefon kontrolü
                const cleanPhone = record.phone.replace(/\D/g, '');
                if (!cleanPhone || cleanPhone.length < 10) {
                    errors.push('Geçersiz telefon');
                } else {
                    // Telefon zaten kayıtlı mı?
                    const existing = crmLeads.find(l => 
                        l.phone && phonesMatch(l.phone, cleanPhone)
                    );
                    if (existing) {
                        errors.push('Telefon kayıtlı');
                    }
                }
                
                // Yaş grubuna göre ad kontrolü
                const isChild = record.ageGroup && record.ageGroup.toLowerCase() === 'çocuk';
                if (isChild) {
                    // Çocuk ise: Veli Adı ve Çocuk Adı zorunlu
                    if (!record.parentName || record.parentName.trim().length < 2) {
                        errors.push('Veli Adı eksik');
                    }
                    if (!record.childName || record.childName.trim().length < 2) {
                        errors.push('Çocuk Adı eksik');
                    }
                } else {
                    // Yetişkin ise: Ad Soyad zorunlu
                    if (!record.fullName || record.fullName.trim().length < 2) {
                        errors.push('Ad Soyad eksik');
                    }
                }
                
                // Kaynak kontrolü
                const validSources = ['telefon', 'whatsapp', 'sosyal medya', 'referans', 'web sitesi', 'diğer'];
                if (!record.source || !validSources.includes(record.source.toLowerCase())) {
                    errors.push('Geçersiz kaynak');
                }
                
                // Branş kontrolü
                const branch = branches.find(b => 
                    b.name && record.branchName && 
                    b.name.toLowerCase().includes(record.branchName.toLowerCase())
                );
                if (!branch) {
                    errors.push('Branş bulunamadı');
                }
                
                // Yaş grubu kontrolü
                const validAgeGroups = ['yetişkin', 'çocuk'];
                if (!record.ageGroup || !validAgeGroups.includes(record.ageGroup.toLowerCase())) {
                    errors.push('Geçersiz yaş grubu');
                }
                
                record.errors = errors;
                record.isValid = errors.length === 0;
                record.cleanPhone = cleanPhone;
                record.branch = branch;
                
                if (record.isValid) {
                    validImportRecords.push(record);
                } else {
                    invalidRecords.push(record);
                }
            });
            
            // Preview'i göster
            renderImportPreview();
            
            // Adım 2'ye geç
            document.getElementById('import-step-1').style.display = 'none';
            document.getElementById('import-step-2').style.display = 'block';
        }
        
        // Preview render
        function renderImportPreview() {
            const tbody = document.getElementById('import-preview-body');
            const summaryDiv = document.getElementById('import-summary');
            
            // Summary
            const totalCount = importData.length;
            const validCount = validImportRecords.length;
            const invalidCount = totalCount - validCount;
            
            summaryDiv.innerHTML = `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 600;">${totalCount}</div>
                    <div style="font-size: 12px; color: #666;">Toplam</div>
                </div>
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 600; color: #4caf50;">${validCount}</div>
                    <div style="font-size: 12px; color: #666;">Geçerli</div>
                </div>
                <div style="background: #ffebee; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 600; color: #f44336;">${invalidCount}</div>
                    <div style="font-size: 12px; color: #666;">Hatalı</div>
                </div>
            `;
            
            document.getElementById('valid-count').textContent = validCount;
            
            // Tablo
            tbody.innerHTML = importData.map(record => {
                const statusColor = record.isValid ? '#4caf50' : '#f44336';
                const statusText = record.isValid ? '✅ Geçerli' : '❌ ' + record.errors.join(', ');
                const rowStyle = record.isValid ? '' : 'background: #ffebee;';
                
                // Veli/Çocuk bilgisini göster
                const isChild = record.ageGroup && record.ageGroup.toLowerCase() === 'çocuk';
                let parentChildInfo = '-';
                if (isChild && (record.parentName || record.childName)) {
                    const parts = [];
                    if (record.parentName) parts.push(`Veli: ${record.parentName}`);
                    if (record.childName) parts.push(`Çocuk: ${record.childName}`);
                    if (record.childAge) parts.push(`Yaş: ${record.childAge}`);
                    parentChildInfo = parts.join('<br>');
                }
                
                return `
                    <tr style="${rowStyle}">
                        <td>${record.rowNumber}</td>
                        <td>${record.phone}</td>
                        <td>${record.fullName || '-'}</td>
                        <td style="font-size: 11px;">${parentChildInfo}</td>
                        <td>${record.source}</td>
                        <td>${record.branchName}</td>
                        <td>${record.ageGroup}</td>
                        <td>${record.tag || '-'}</td>
                        <td style="color: ${statusColor}; font-size: 12px;">${statusText}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Toplu import onaylama
        window.confirmBulkImport = async function() {
            if (validImportRecords.length === 0) {
                showAlert('❌ Eklenebilecek geçerli kayıt yok!', 'warning');
                return;
            }
            
            const confirmMsg = `${validImportRecords.length} müşteri eklenecek. Onaylıyor musunuz?`;
            if (!confirm(confirmMsg)) return;
            
            // Step 3'e geç (progress)
            document.getElementById('import-step-2').style.display = 'none';
            document.getElementById('import-step-3').style.display = 'block';
            
            await processBulkImport();
        };
        
        // Toplu import işleme
        async function processBulkImport() {
            const total = validImportRecords.length;
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            const progressBar = document.getElementById('import-progress-bar');
            const progressText = document.getElementById('import-progress-text');
            
            const now = new Date();
            const dateStr = now.toLocaleString('tr-TR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            const userName = currentUser.fullName || currentUser.email || 'Admin';
            
            for (let i = 0; i < validImportRecords.length; i++) {
                const record = validImportRecords[i];
                
                try {
                    // Kaynak mapping
                    const sourceMap = {
                        'telefon': 'phone',
                        'whatsapp': 'whatsapp',
                        'sosyal medya': 'social',
                        'referans': 'referral',
                        'web sitesi': 'website',
                        'diğer': 'other'
                    };
                    const source = sourceMap[record.source.toLowerCase()] || 'other';
                    
                    // Yaş grubu mapping
                    const ageGroup = record.ageGroup.toLowerCase() === 'yetişkin' ? 'adult' : 'child';
                    
                    // Lead verisi - Çocuk/Yetişkin'e göre branch oluştur
                    const branchData = {
                        branchId: record.branch.id,
                        branchName: record.branch.name,
                        ageGroup: ageGroup,
                        selectedTag: record.tag || '',
                        notesHistory: record.note ? [{
                            text: record.note,
                            by: userName,
                            date: dateStr
                        }] : [],
                        kayitOlabilirDate: null,
                        denemeDate: null
                    };
                    
                    if (ageGroup === 'adult') {
                        // Yetişkin
                        branchData.fullName = record.fullName;
                        branchData.parentName = '';
                        branchData.children = [];
                    } else {
                        // Çocuk
                        branchData.fullName = '';
                        branchData.parentName = record.parentName || '';
                        branchData.children = [{
                            name: record.childName || '',
                            age: record.childAge || '',
                            selectedTag: record.tag || '',
                            kayitOlabilirDate: null,
                            denemeDate: null
                        }];
                    }
                    
                    const leadData = {
                        fullName: ageGroup === 'adult' ? record.fullName : record.parentName,
                        phone: record.cleanPhone,
                        source: source,
                        clubId: currentClubId,
                        createdAt: now.toISOString(),
                        createdBy: userName + ' (Toplu Import)',
                        status: 'new',
                        branches: [branchData],
                        history: [
                            {
                                action: 'created',
                                by: userName,
                                date: dateStr,
                                details: ageGroup === 'adult' 
                                    ? `Toplu import ile oluşturuldu - ${record.fullName} (${record.cleanPhone})`
                                    : `Toplu import ile oluşturuldu - Veli: ${record.parentName}, Çocuk: ${record.childName} (${record.cleanPhone})`
                            }
                        ]
                    };
                    
                    // Etiket varsa history'e ekle
                    if (record.tag) {
                        leadData.history.push({
                            action: 'tag_added',
                            by: userName,
                            date: dateStr,
                            details: `${record.branch.name} - Etiket: "${record.tag}"`
                        });
                    }
                    
                    // Firebase'e ekle
                    await window.firebase.addDoc(
                        window.firebase.collection(window.db, 'crmLeads'),
                        leadData
                    );
                    
                    successCount++;
                    
                } catch (error) {
                    console.error(`Satır ${record.rowNumber} import hatası:`, error);
                    errorCount++;
                    errors.push(`Satır ${record.rowNumber} (${record.fullName}): ${error.message}`);
                }
                
                // Progress güncelle
                const progress = ((i + 1) / total) * 100;
                progressBar.style.width = progress + '%';
                progressText.textContent = `${i + 1} / ${total}`;
                
                // Rate limiting
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            // Step 4'e geç (sonuç)
            document.getElementById('import-step-3').style.display = 'none';
            document.getElementById('import-step-4').style.display = 'block';
            
            // Sonuç göster
            const resultDiv = document.getElementById('import-result');
            resultDiv.innerHTML = `
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="font-size: 18px; font-weight: 600; color: #4caf50;">✅ Başarılı: ${successCount}</div>
                </div>
                ${errorCount > 0 ? `
                <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="font-size: 18px; font-weight: 600; color: #f44336;">❌ Hatalı: ${errorCount}</div>
                    ${errors.length > 0 ? `
                    <div style="margin-top: 10px; font-size: 12px;">
                        <strong>Hatalar:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            ${errors.slice(0, 5).map(err => `<li>${err}</li>`).join('')}
                            ${errors.length > 5 ? `<li>... ve ${errors.length - 5} hata daha</li>` : ''}
                        </ul>
                    </div>
                    ` : ''}
                </div>
                ` : ''}
            `;
            
            // Başarılı ise veriyi yeniden yükle
            if (successCount > 0) {
                setTimeout(() => {
                    loadData(false); // Fresh data yükle
                }, 2000);
            }
        }

        // ============================================
        // 📊 MUHASEBE (ACCOUNTING) FUNCTIONS
        // ============================================
        
        // Muhasebe özetini yükle
        window.renderAccountingSummary = async function() {
            console.log('📊 Muhasebe özeti yükleniyor...');
            
            // Branş seçeneklerini doldur
            populateBranchFilters();
            
            await Promise.all([
                loadExpenses(),
                loadProducts(),
                calculateSummary()
            ]);
        };
        
        // Branş filtrelerini doldur
        function populateBranchFilters() {
            const branchFilter = document.getElementById('summaryBranchFilter');
            if (!branchFilter) return;
            
            // Eğer zaten doldurulmuşsa tekrar doldurma
            if (branchFilter.options.length > 1) return;
            
            // ✅ Kullanıcının erişebildiği branşları kullan
            const availableBranches = filterByBranch(branches, 'id');
            
            // Branşları ekle
            availableBranches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.name;
                option.textContent = `${branch.icon || '🏢'} ${branch.name}`;
                branchFilter.appendChild(option);
            });
        }
        
        // Özet filtrelerini sıfırla
        window.resetSummaryFilters = function() {
            const startDate = document.getElementById('summaryStartDate');
            const endDate = document.getElementById('summaryEndDate');
            const branchFilter = document.getElementById('summaryBranchFilter');
            
            if (startDate) startDate.value = '';
            if (endDate) endDate.value = '';
            if (branchFilter) {
                branchFilter.value = 'all';
                // Branş seçeneklerini yeniden doldur
                branchFilter.innerHTML = '<option value="all">🌐 Tüm Branşlar</option>';
                
                // ✅ Kullanıcının erişebildiği branşları kullan
                const availableBranches = filterByBranch(branches, 'id');
                
                availableBranches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.name;
                    option.textContent = `${branch.icon || '🏢'} ${branch.name}`;
                    branchFilter.appendChild(option);
                });
            }
            
            renderAccountingSummary();
        };
        
        // ✅ SUPABASE: Giderleri yükle
        async function loadExpenses() {
            const container = document.getElementById('expensesTableContainer');
            if (!container) return;
            
            try {
                const { data: expensesData, error } = await supabase
                    .from('expenses')
                    .select('*')
                    .eq('clubId', currentClubId);
                
                if (error) throw error;
                
                let expenses = expensesData || [];
                
                // ✅ BRANŞ FİLTRESİ: Kullanıcının yetkili olduğu branşları göster
                expenses = filterByBranch(expenses, 'branch');
                
                // Tarih filtrelerini uygula
                const startDateInput = document.getElementById('summaryStartDate');
                const endDateInput = document.getElementById('summaryEndDate');
                
                if (startDateInput && startDateInput.value) {
                    const startDate = new Date(startDateInput.value);
                    startDate.setHours(0, 0, 0, 0);
                    expenses = expenses.filter(exp => {
                        const expDate = new Date(exp.date);
                        return expDate >= startDate;
                    });
                }
                
                if (endDateInput && endDateInput.value) {
                    const endDate = new Date(endDateInput.value);
                    endDate.setHours(23, 59, 59, 999);
                    expenses = expenses.filter(exp => {
                        const expDate = new Date(exp.date);
                        return expDate <= endDate;
                    });
                }
                
                // Client-side sorting (index gerekmez)
                expenses.sort((a, b) => {
                    const dateA = new Date(a.date || 0);
                    const dateB = new Date(b.date || 0);
                    return dateB - dateA; // En yeni en üstte
                });
                
                // İlk 20 kayıt
                expenses = expenses.slice(0, 20);
                
                if (expenses.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>Henüz gider kaydı yok</p></div>';
                    return;
                }
                
                container.innerHTML = `
                    <div style="overflow-x: auto;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Kategori</th>
                                    <th>Branş</th>
                                    <th>Açıklama</th>
                                    <th>Tutar</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${expenses.map(expense => `
                                    <tr>
                                        <td>${new Date(expense.date).toLocaleDateString('tr-TR')}</td>
                                        <td>${expense.category || 'Genel'}</td>
                                        <td><span style="background: #e3f2fd; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${expense.branch || 'Genel'}</span></td>
                                        <td>${expense.description || '-'}</td>
                                        <td style="font-weight: bold; color: #f44336;">${expense.amount || 0} ₺</td>
                                        <td>
                                            <button class="btn btn-sm btn-danger" onclick="deleteExpense('${expense.id}')">
                                                🗑️ Sil
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Giderler yüklenirken hata:', error);
                container.innerHTML = '<div class="empty-state"><p style="color: #f44336;">❌ Giderler yüklenemedi</p></div>';
            }
        }
        
        // ✅ SUPABASE: Ürünleri yükle
        async function loadProducts() {
            const container = document.getElementById('productsTableContainer');
            if (!container) return;
            
            try {
                const { data: productsData, error } = await supabase
                    .from('products')
                    .select('*')
                    .eq('clubId', currentClubId);
                
                if (error) throw error;
                
                let products = productsData || [];
                
                // ✅ BRANŞ FİLTRESİ: Kullanıcının yetkili olduğu branşları göster
                products = filterByBranch(products, 'branch');
                
                // Client-side sorting (index gerekmez)
                products.sort((a, b) => {
                    const dateA = new Date(a.createdAt || 0);
                    const dateB = new Date(b.createdAt || 0);
                    return dateB - dateA; // En yeni en üstte
                });
                
                if (products.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>Henüz ürün kaydı yok</p></div>';
                    return;
                }
                
                container.innerHTML = `
                    <div style="overflow-x: auto;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Ürün Adı</th>
                                    <th>Kategori</th>
                                    <th>Branş</th>
                                    <th>Fiyat</th>
                                    <th>Stok</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${products.map(product => `
                                    <tr>
                                        <td style="font-weight: 600;">${product.name || '-'}</td>
                                        <td>${product.category || 'Genel'}</td>
                                        <td><span style="background: #e8f5e9; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${product.branch || 'Genel'}</span></td>
                                        <td style="font-weight: bold; color: #4caf50;">${product.price || 0} ₺</td>
                                        <td>${product.stock !== undefined ? product.stock : '-'}</td>
                                        <td>
                                            <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product.id}')">
                                                🗑️ Sil
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Ürünler yüklenirken hata:', error);
                container.innerHTML = '<div class="empty-state"><p style="color: #f44336;">❌ Ürünler yüklenemedi</p></div>';
            }
        }
        
        // Özet hesapla
        async function calculateSummary() {
            try {
                // Tarih filtrelerini kontrol et
                const startDateInput = document.getElementById('summaryStartDate');
                const endDateInput = document.getElementById('summaryEndDate');
                const branchFilterInput = document.getElementById('summaryBranchFilter');
                
                let startOfMonth, endOfMonth;
                
                if (startDateInput && startDateInput.value) {
                    startOfMonth = new Date(startDateInput.value);
                    startOfMonth.setHours(0, 0, 0, 0);
                } else {
                    const now = new Date();
                    startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                }
                
                if (endDateInput && endDateInput.value) {
                    endOfMonth = new Date(endDateInput.value);
                    endOfMonth.setHours(23, 59, 59, 999);
                } else {
                    const now = new Date();
                    endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                }
                
                const selectedBranch = branchFilterInput ? branchFilterInput.value : 'all';
                
                console.log('📊 Özet hesaplanıyor...', { startOfMonth, endOfMonth, selectedBranch });
                
                // ✅ SUPABASE: Giderleri hesapla
                let totalExpense = 0;
                try {
                    const { data: expensesData, error: expensesError } = await supabase
                        .from('expenses')
                        .select('*')
                        .eq('clubId', currentClubId);
                    
                    if (expensesError) throw expensesError;
                    
                    // ✅ BRANŞ FİLTRESİ: Kullanıcının yetkili olduğu branşları kullan
                    let allowedExpenses = expensesData || [];
                    allowedExpenses = filterByBranch(allowedExpenses, 'branch');
                    
                    // Client-side filtering - tarih ve branş filtreleri
                    totalExpense = allowedExpenses.reduce((sum, expense) => {
                        const expenseDate = new Date(expense.date);
                        
                        // Tarih filtresi
                        if (expenseDate >= startOfMonth && expenseDate <= endOfMonth) {
                            // Dropdown branş filtresi (eğer seçilmişse)
                            if (selectedBranch === 'all' || expense.branch === selectedBranch) {
                                return sum + (expense.amount || 0);
                            }
                        }
                        return sum;
                    }, 0);
                    
                    console.log('💸 Toplam gider:', totalExpense, 'Branş:', selectedBranch);
                } catch (error) {
                    console.error('Gider hesaplama hatası:', error);
                }
                
                // Gelirleri hesapla (preRegistrations'dan paymentSchedule üzerinden)
                let totalIncome = 0;
                try {
                    // Ödemeler preRegistrations içinde paymentSchedule array'inde tutuluyor
                    let monthlyPaymentCount = 0;
                    
                    console.log('📊 PreRegistrations üzerinden ödemeler kontrol ediliyor...', preRegistrations.length, 'kayıt');
                    
                    // ✅ BRANŞ FİLTRESİ: Sadece yetkili branşların preRegistrations'larını al
                    const filteredPreRegs = filterByBranch(preRegistrations, 'branch');
                    
                    // Sadece aktif/pending ve preReg'i olan üyelerin ödemelerini say
                    const activeMembers = members.filter(m => {
                        if (m.status !== 'active' && m.status !== 'pending') return false;
                        if (!m.preRegistrationId) return false;
                        const preReg = filteredPreRegs.find(p => p.id === m.preRegistrationId);
                        return preReg && preReg.paymentSchedule && preReg.paymentSchedule.length > 0;
                    });
                    
                    activeMembers.forEach(member => {
                        const preReg = filteredPreRegs.find(p => p.id === member.preRegistrationId);
                        if (!preReg || !preReg.paymentSchedule) return;
                        
                        // Branş kontrolü
                        const preRegBranch = preReg.branch;
                        if (selectedBranch !== 'all' && preRegBranch !== selectedBranch) {
                            return;
                        }
                        
                        // Her preReg'in paymentSchedule'ını kontrol et
                        preReg.paymentSchedule.forEach(payment => {
                            // Sadece ödenen taksitleri say
                            if (payment.status !== 'paid') return;
                            
                            // ✅ SADECE paymentDate varsa say (ödeme tarihi olmayanları sayma)
                            if (!payment.paymentDate) return;
                            
                            // Tarih parse etme
                            let paymentDateStr = payment.paymentDate;
                            if (paymentDateStr.length === 10 && paymentDateStr.includes('-')) {
                                paymentDateStr += 'T00:00:00';
                            }
                            const paymentDate = new Date(paymentDateStr);
                            
                            if (isNaN(paymentDate.getTime())) return;
                            
                            // Tarih filtresi
                            if (paymentDate >= startOfMonth && paymentDate <= endOfMonth) {
                                monthlyPaymentCount++;
                                const amount = parseFloat(payment.amount || 0);
                                totalIncome += amount;
                            }
                        });
                    });
                    
                    console.log('💰 [MUHASEBE SEKMESİ] Toplam gelir (aidatlardan):', totalIncome.toLocaleString('tr-TR') + '₺', 'Ödeme sayısı:', monthlyPaymentCount, 'Branş:', selectedBranch);
                } catch (error) {
                    console.error('Gelir hesaplama hatası:', error);
                    console.error('Hata detayı:', error.message, error.stack);
                }
                
                // Ürün satışlarını hesapla (Supabase'den)
                let totalProductSales = 0;
                try {
                    const { data: sales, error } = await supabaseClient
                        .from('productSales')
                        .select('totalAmount, saleDate, branch')
                        .eq('clubId', currentClubId);
                    
                    if (error) throw error;
                    
                    // ✅ BRANŞ FİLTRESİ: Kullanıcının yetkili olduğu branşları kullan
                    let filteredSales = sales || [];
                    filteredSales = filterByBranch(filteredSales, 'branch');
                    
                    if (filteredSales && filteredSales.length > 0) {
                        totalProductSales = filteredSales.reduce((sum, sale) => {
                            const saleDate = new Date(sale.saleDate);
                            
                            // Tarih filtresi
                            if (saleDate >= startOfMonth && saleDate <= endOfMonth) {
                                // Branş filtresi
                                if (selectedBranch === 'all' || sale.branch === selectedBranch) {
                                    return sum + (parseFloat(sale.totalAmount) || 0);
                                }
                            }
                            return sum;
                        }, 0);
                        
                        console.log('🛒 Toplam ürün satışları:', totalProductSales.toLocaleString('tr-TR') + '₺', 'Branş:', selectedBranch);
                    }
                } catch (error) {
                    console.error('Ürün satışları hesaplama hatası:', error);
                }
                
                // ✅ SUPABASE: Diğer gelirleri hesapla
                let totalOtherIncomes = 0;
                try {
                    const { data: otherIncomesData, error: otherIncomesError } = await supabase
                        .from('otherIncomes')
                        .select('*')
                        .eq('clubId', currentClubId);
                    
                    if (otherIncomesError) throw otherIncomesError;
                    
                    // ✅ BRANŞ FİLTRESİ: Kullanıcının yetkili olduğu branşları kullan
                    let allowedIncomes = otherIncomesData || [];
                    allowedIncomes = filterByBranch(allowedIncomes, 'branch');
                    
                    // Client-side filtering - tarih ve branş filtreleri
                    totalOtherIncomes = allowedIncomes.reduce((sum, income) => {
                        const incomeDate = new Date(income.date);
                        
                        // Tarih filtresi
                        if (incomeDate >= startOfMonth && incomeDate <= endOfMonth) {
                            // Dropdown branş filtresi
                            if (selectedBranch === 'all' || income.branch === selectedBranch) {
                                return sum + (parseFloat(income.amount) || 0);
                            }
                        }
                        return sum;
                    }, 0);
                    
                    console.log('💰 Toplam diğer gelirler:', totalOtherIncomes.toLocaleString('tr-TR') + '₺', 'Branş:', selectedBranch);
                } catch (error) {
                    console.error('Diğer gelirler hesaplama hatası:', error);
                }
                
                // TOPLAM GELİR = Aidatlar + Ürün Satışları + Diğer Gelirler
                const totalAllIncomes = totalIncome + totalProductSales + totalOtherIncomes;
                
                // Net kar/zarar
                const netProfit = totalAllIncomes - totalExpense;
                
                console.log('📊 ÖZET:', {
                    'Aidatlar': totalIncome.toLocaleString('tr-TR') + '₺',
                    'Ürün Satışları': totalProductSales.toLocaleString('tr-TR') + '₺',
                    'Diğer Gelirler': totalOtherIncomes.toLocaleString('tr-TR') + '₺',
                    'TOPLAM GELİR': totalAllIncomes.toLocaleString('tr-TR') + '₺',
                    'Giderler': totalExpense.toLocaleString('tr-TR') + '₺',
                    'Net Kar/Zarar': netProfit.toLocaleString('tr-TR') + '₺'
                });
                
                // UI'ı güncelle
                const totalIncomeEl = document.getElementById('totalIncome');
                const totalExpenseEl = document.getElementById('totalExpense');
                const netProfitEl = document.getElementById('netProfit');
                const totalProductSalesEl = document.getElementById('totalProductSales');
                
                if (totalIncomeEl) totalIncomeEl.textContent = formatPrice(totalAllIncomes);
                if (totalExpenseEl) totalExpenseEl.textContent = formatPrice(totalExpense);
                if (netProfitEl) netProfitEl.textContent = formatPrice(netProfit);
                if (totalProductSalesEl) totalProductSalesEl.textContent = formatPrice(totalProductSales);
                
                // Net kar/zarar rengini ayarla
                if (netProfitEl) {
                    const netProfitElement = netProfitEl.parentElement;
                    if (netProfit >= 0) {
                        netProfitElement.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';
                    } else {
                        netProfitElement.style.background = 'linear-gradient(135deg, #f44336 0%, #e53935 100%)';
                    }
                }
                
                // Grafikleri güncelle
                await renderAccountingCharts(totalIncome, totalProductSales, totalOtherIncomes, totalExpense, startOfMonth, endOfMonth, selectedBranch);
                
            } catch (error) {
                console.error('Özet hesaplanırken hata:', error);
            }
        }
        
        // Muhasebe grafiklerini render et
        let incomeChartInstance = null;
        let expenseChartInstance = null;
        let comparisonChartInstance = null;
        
        async function renderAccountingCharts(totalIncome, totalProductSales, totalOtherIncomes, totalExpense, startOfMonth, endOfMonth, selectedBranch) {
            try {
                // Gelir Dağılımı Grafiği
                const incomeCtx = document.getElementById('incomeChart');
                if (incomeCtx) {
                    // Eski grafiği temizle
                    if (incomeChartInstance) {
                        incomeChartInstance.destroy();
                    }
                    
                    incomeChartInstance = new Chart(incomeCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['💳 Aidatlar', '🛍️ Ürün Satışları', '💰 Diğer Gelirler'],
                            datasets: [{
                                data: [totalIncome, totalProductSales, totalOtherIncomes],
                                backgroundColor: [
                                    '#2196F3',
                                    '#FF9800',
                                    '#4CAF50'
                                ],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 15,
                                        font: {
                                            size: 12,
                                            weight: 'bold'
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return `${label}: ${formatPrice(value)} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // ✅ SUPABASE: Gider Kategorilerine Göre Dağılım
                const { data: expensesForChart, error: expensesChartError } = await supabase
                    .from('expenses')
                    .select('*')
                    .eq('clubId', currentClubId);
                
                if (expensesChartError) {
                    console.error('Expenses chart yükleme hatası:', expensesChartError);
                }
                
                const expenseByCategory = {};
                const expensesFiltered = expensesForChart || [];
                expensesFiltered.forEach(expense => {
                    const expenseDate = new Date(expense.date);
                    
                    if (expenseDate >= startOfMonth && expenseDate <= endOfMonth) {
                        if (selectedBranch === 'all' || expense.branch === selectedBranch) {
                            const category = expense.category || 'Diğer';
                            expenseByCategory[category] = (expenseByCategory[category] || 0) + (expense.amount || 0);
                        }
                    }
                });
                
                const expenseCtx = document.getElementById('expenseChart');
                if (expenseCtx) {
                    if (expenseChartInstance) {
                        expenseChartInstance.destroy();
                    }
                    
                    const expenseLabels = Object.keys(expenseByCategory);
                    const expenseData = Object.values(expenseByCategory);
                    const expenseColors = [
                        '#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5',
                        '#00BCD4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39',
                        '#FFEB3B', '#FFC107', '#FF9800', '#FF5722', '#795548'
                    ];
                    
                    expenseChartInstance = new Chart(expenseCtx, {
                        type: 'doughnut',
                        data: {
                            labels: expenseLabels,
                            datasets: [{
                                data: expenseData,
                                backgroundColor: expenseColors.slice(0, expenseLabels.length),
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 15,
                                        font: {
                                            size: 12,
                                            weight: 'bold'
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return `${label}: ${formatPrice(value)} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Karşılaştırma Grafiği (Bar Chart)
                const comparisonCtx = document.getElementById('comparisonChart');
                if (comparisonCtx) {
                    if (comparisonChartInstance) {
                        comparisonChartInstance.destroy();
                    }
                    
                    const totalAllIncomes = totalIncome + totalProductSales + totalOtherIncomes;
                    
                    comparisonChartInstance = new Chart(comparisonCtx, {
                        type: 'bar',
                        data: {
                            labels: ['💳 Aidatlar', '🛍️ Ürün Satışları', '💰 Diğer Gelirler', '📉 Giderler', '📊 Net Kar/Zarar'],
                            datasets: [{
                                label: 'Tutar (₺)',
                                data: [totalIncome, totalProductSales, totalOtherIncomes, totalExpense, totalAllIncomes - totalExpense],
                                backgroundColor: [
                                    '#2196F3',
                                    '#FF9800',
                                    '#4CAF50',
                                    '#F44336',
                                    (totalAllIncomes - totalExpense) >= 0 ? '#4CAF50' : '#F44336'
                                ],
                                borderWidth: 0,
                                borderRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return formatPrice(context.parsed.y);
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return formatPrice(value);
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
            } catch (error) {
                console.error('Grafikler oluşturulurken hata:', error);
            }
        }
        
        // Gider ekleme modalı aç
        window.openAddExpenseModal = function() {
            // Branş seçeneklerini doldur - SADECE YETKİLİ BRANŞLAR
            const branchSelect = document.getElementById('expenseBranch');
            if (branchSelect) {
                // Önce mevcut seçenekleri temizle (Genel hariç)
                branchSelect.innerHTML = '<option value="Genel">🌐 Genel (Tüm Branşlar)</option>';
                
                // ✅ BRANŞ FİLTRESİ: Sadece yetkili branşları göster
                const availableBranches = filterByBranch(branches, 'id');
                
                // Branşları ekle
                availableBranches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.name;
                    option.textContent = `${branch.icon || '🏢'} ${branch.name}`;
                    branchSelect.appendChild(option);
                });
            }
            
            // Kategori seçeneklerini doldur (varsayılan + özel kategoriler)
            const categorySelect = document.getElementById('expenseCategory');
            if (categorySelect) {
                // Varsayılan kategoriler
                const defaultCategories = [
                    { name: 'Kira', icon: '🏠' },
                    { name: 'Maaş', icon: '💰' },
                    { name: 'Fatura', icon: '📄' },
                    { name: 'Malzeme', icon: '🔧' },
                    { name: 'Diğer', icon: '📦' }
                ];
                
                categorySelect.innerHTML = '<option value="">Seçiniz...</option>';
                
                // Varsayılan kategorileri ekle
                defaultCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    option.textContent = `${cat.icon} ${cat.name}`;
                    categorySelect.appendChild(option);
                });
                
                // Özel kategorileri ekle
                if (clubSettings.expenseCategories && clubSettings.expenseCategories.length > 0) {
                    clubSettings.expenseCategories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.name;
                        option.textContent = `${cat.icon} ${cat.name}`;
                        categorySelect.appendChild(option);
                    });
                }
            }
            
            // Formu temizle
            document.getElementById('expenseForm').reset();
            
            // Bugünün tarihini ayarla
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDate').value = today;
            
            // Modal'ı aç
            openModal('addExpenseModal');
        };
        
        // Gider form submit handler
        window.handleExpenseFormSubmit = async function(event) {
            event.preventDefault();
            
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const date = document.getElementById('expenseDate').value;
            const category = document.getElementById('expenseCategory').value;
            const branch = document.getElementById('expenseBranch').value;
            const description = document.getElementById('expenseDescription').value;
            
            if (!amount || amount <= 0 || !date || !category || !description) {
                showAlert('❌ Lütfen tüm alanları doldurun', 'danger');
                return;
            }
            
            // Modal'ı kapat
            closeModal('addExpenseModal');
            
            // Gider ekle
            await addExpense(category, description, amount, branch, date);
        };
        
        // ✅ SUPABASE: Gider ekle
        async function addExpense(category, description, amount, branch = 'Genel', date = null) {
            try {
                const now = new Date().toISOString();
                const expenseDate = date ? new Date(date).toISOString() : now;
                
                // Supabase'e ekle
                const { data, error } = await supabase
                    .from('expenses')
                    .insert({
                        clubId: currentClubId,
                        category: category,
                        description: description,
                        amount: amount,
                        branch: branch,
                        date: expenseDate,
                        createdBy: currentUser?.fullName || 'Admin',
                        createdAt: now
                    })
                    .select();
                
                if (error) throw error;
                
                showAlert('✅ Gider başarıyla eklendi', 'success');
                
                // Açık sayfaya göre yenile
                if (currentSection === 'accounting-summary') {
                    renderAccountingSummary();
                } else if (currentSection === 'expenses') {
                    renderExpensesPage();
                }
            } catch (error) {
                console.error('Gider eklenirken hata:', error);
                showAlert('❌ Gider eklenirken bir hata oluştu', 'danger');
            }
        }
        
        // Gider sil (accounting-summary'den)
        // ✅ SUPABASE: Gider sil
        window.deleteExpense = async function(expenseId) {
            if (!confirm('Bu gideri silmek istediğinize emin misiniz?')) return;
            
            try {
                const { error } = await supabase
                    .from('expenses')
                    .delete()
                    .eq('id', expenseId);
                
                if (error) throw error;
                
                showAlert('✅ Gider silindi', 'success');
                
                // Açık sayfaya göre yenile
                if (currentSection === 'accounting-summary') {
                    renderAccountingSummary();
                } else if (currentSection === 'expenses') {
                    renderExpensesPage();
                }
            } catch (error) {
                console.error('Gider silinirken hata:', error);
                showAlert('❌ Gider silinirken bir hata oluştu', 'danger');
            }
        };
        
        // Ürün ekleme modalı aç
        window.openAddProductModal = function() {
            // Branş seçeneklerini doldur - SADECE YETKİLİ BRANŞLAR
            const branchSelect = document.getElementById('productBranch');
            if (branchSelect) {
                // Önce mevcut seçenekleri temizle (Genel hariç)
                branchSelect.innerHTML = '<option value="Genel">🌐 Genel (Tüm Branşlar)</option>';
                
                // ✅ BRANŞ FİLTRESİ: Sadece yetkili branşları göster
                const availableBranches = filterByBranch(branches, 'id');
                
                // Branşları ekle
                availableBranches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.name;
                    option.textContent = `${branch.icon || '🏢'} ${branch.name}`;
                    branchSelect.appendChild(option);
                });
            }
            
            // Kategori seçeneklerini doldur (varsayılan + özel kategoriler)
            const categorySelect = document.getElementById('productCategory');
            if (categorySelect) {
                // Varsayılan kategoriler
                const defaultCategories = [
                    { name: 'Ekipman', icon: '⚽' },
                    { name: 'Kıyafet', icon: '👕' },
                    { name: 'Abonelik', icon: '💳' },
                    { name: 'Diğer', icon: '📦' }
                ];
                
                categorySelect.innerHTML = '<option value="">Seçiniz...</option>';
                
                // Varsayılan kategorileri ekle
                defaultCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    option.textContent = `${cat.icon} ${cat.name}`;
                    categorySelect.appendChild(option);
                });
                
                // Özel kategorileri ekle
                if (clubSettings.productCategories && clubSettings.productCategories.length > 0) {
                    clubSettings.productCategories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.name;
                        option.textContent = `${cat.icon} ${cat.name}`;
                        categorySelect.appendChild(option);
                    });
                }
            }
            
            // Formu temizle
            document.getElementById('productForm').reset();
            
            // Modal'ı aç
            openModal('addProductModal');
        };
        
        // Ürün form submit handler
        window.handleProductFormSubmit = async function(event) {
            event.preventDefault();
            
            const name = document.getElementById('productName').value;
            const category = document.getElementById('productCategory').value;
            const branch = document.getElementById('productBranch').value;
            const costPrice = parseFloat(document.getElementById('productCostPrice').value) || 0;
            const price = parseFloat(document.getElementById('productPrice').value);
            const stock = parseInt(document.getElementById('productStock').value) || 0;
            
            if (!name || !category || !price || price <= 0) {
                showAlert('❌ Lütfen tüm zorunlu alanları doldurun', 'danger');
                return;
            }
            
            // Modal'ı kapat
            closeModal('addProductModal');
            
            // Ürün ekle
            await addProduct(name, category, price, stock, branch, costPrice);
        };
        
        // ✅ SUPABASE: Ürün ekle
        async function addProduct(name, category, price, stock, branch = 'Genel', costPrice = 0) {
            try {
                const now = new Date().toISOString();
                
                // Supabase'e ekle
                const { data, error } = await supabase
                    .from('products')
                    .insert({
                        clubId: currentClubId,
                        name: name,
                        category: category,
                        costPrice: costPrice,
                        price: price,
                        stock: stock,
                        branch: branch,
                        createdBy: currentUser?.fullName || 'Admin',
                        createdAt: now
                    })
                    .select();
                
                if (error) throw error;
                
                showAlert('✅ Ürün başarıyla eklendi', 'success');
                
                // Açık sayfaya göre yenile
                if (currentSection === 'accounting-summary') {
                    renderAccountingSummary();
                } else if (currentSection === 'products') {
                    renderProductsPage();
                }
            } catch (error) {
                console.error('Ürün eklenirken hata:', error);
                showAlert('❌ Ürün eklenirken bir hata oluştu', 'danger');
            }
        }
        
        // Ürün sil
        // ✅ SUPABASE: Ürün sil
        window.deleteProduct = async function(productId) {
            if (!confirm('Bu ürünü silmek istediğinize emin misiniz?')) return;
            
            try {
                const { error } = await supabase
                    .from('products')
                    .delete()
                    .eq('id', productId);
                
                if (error) throw error;
                
                showAlert('✅ Ürün silindi', 'success');
                
                // Açık sayfaya göre yenile
                if (currentSection === 'accounting-summary') {
                    renderAccountingSummary();
                } else if (currentSection === 'products') {
                    renderProductsPage();
                }
            } catch (error) {
                console.error('Ürün silinirken hata:', error);
                showAlert('❌ Ürün silinirken bir hata oluştu', 'danger');
            }
        };
        
        // ============================================
        // 📄 GIDERLER VE ÜRÜNLER SAYFALARI
        // ============================================
        
        // Giderler sayfasını render et
        window.renderExpensesPage = async function() {
            const container = document.getElementById('expensesPageContainer');
            if (!container) return;
            
            // Branş filtrelerini doldur - SADECE YETKİLİ BRANŞLAR
            const branchFilter = document.getElementById('expensesBranchFilter');
            if (branchFilter && branchFilter.options.length === 1) {
                // ✅ BRANŞ FİLTRESİ: Sadece yetkili branşları göster
                const availableBranches = filterByBranch(branches, 'id');
                
                availableBranches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.name;
                    option.textContent = branch.name;
                    branchFilter.appendChild(option);
                });
            }
            
            // Kategori filtrelerini güncelle (özel kategorileri de ekle)
            const categoryFilter = document.getElementById('expensesCategoryFilter');
            if (categoryFilter && categoryFilter.options.length === 6) { // Sadece varsayılan kategoriler varsa
                if (clubSettings.expenseCategories && clubSettings.expenseCategories.length > 0) {
                    clubSettings.expenseCategories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.name;
                        option.textContent = `${cat.icon} ${cat.name}`;
                        categoryFilter.appendChild(option);
                    });
                }
            }
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Giderler yükleniyor...</span></div>';
            
            try {
                // ✅ SUPABASE: expenses yükleme
                const { data: expenses, error } = await supabase
                    .from('expenses')
                    .select('*')
                    .eq('clubId', currentClubId);
                
                if (error) {
                    console.error('Expenses yükleme hatası:', error);
                    container.innerHTML = '<div class="alert alert-danger">❌ Giderler yüklenirken bir hata oluştu</div>';
                    return;
                }
                
                let filteredExpenses = expenses || [];
                
                // ✅ BRANŞ FİLTRESİ: Kullanıcının yetkili olduğu branşlara göre filtrele (dropdown öncesi)
                filteredExpenses = filterByBranch(filteredExpenses, 'branch');
                
                // Tarih filtrelerini uygula
                const startDateInput = document.getElementById('expensesStartDate');
                const endDateInput = document.getElementById('expensesEndDate');
                const categoryFilterInput = document.getElementById('expensesCategoryFilter');
                const branchFilterInput = document.getElementById('expensesBranchFilter');
                
                if (startDateInput && startDateInput.value) {
                    const startDate = new Date(startDateInput.value);
                    startDate.setHours(0, 0, 0, 0);
                    filteredExpenses = filteredExpenses.filter(exp => {
                        const expDate = new Date(exp.date);
                        return expDate >= startDate;
                    });
                }
                
                if (endDateInput && endDateInput.value) {
                    const endDate = new Date(endDateInput.value);
                    endDate.setHours(23, 59, 59, 999);
                    filteredExpenses = filteredExpenses.filter(exp => {
                        const expDate = new Date(exp.date);
                        return expDate <= endDate;
                    });
                }
                
                // Kategori filtresini uygula
                if (categoryFilterInput && categoryFilterInput.value !== 'all') {
                    const selectedCategory = categoryFilterInput.value;
                    filteredExpenses = filteredExpenses.filter(exp => exp.category === selectedCategory);
                }
                
                // Branş filtresini uygula
                if (branchFilterInput && branchFilterInput.value !== 'all') {
                    const selectedBranch = branchFilterInput.value;
                    filteredExpenses = filteredExpenses.filter(exp => exp.branch === selectedBranch);
                }
                
                // Client-side sorting ve limit
                filteredExpenses.sort((a, b) => {
                    const dateA = new Date(a.date || 0);
                    const dateB = new Date(b.date || 0);
                    return dateB - dateA; // En yeni en üstte
                });
                
                // Toplam hesaplama için tüm kayıtları kullan
                const allExpenses = [...filteredExpenses];
                
                // Sadece tabloda göstermek için ilk 20 kayıt
                const displayExpenses = filteredExpenses.slice(0, 20);
                
                if (displayExpenses.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>Henüz gider kaydı yok. "➕ Gider Ekle" butonunu kullanarak gider ekleyebilirsiniz.</p></div>';
                    return;
                }
                
                // Kategoriye göre topla (tüm kayıtlar üzerinden)
                const byCategory = {};
                const byBranch = {};
                let total = 0;
                
                allExpenses.forEach(exp => {
                    const cat = exp.category || 'Diğer';
                    const branch = exp.branch || 'Genel';
                    
                    if (!byCategory[cat]) byCategory[cat] = 0;
                    if (!byBranch[branch]) byBranch[branch] = 0;
                    
                    byCategory[cat] += exp.amount || 0;
                    byBranch[branch] += exp.amount || 0;
                    total += exp.amount || 0;
                });
                
                // Ortalama gider hesapla
                const avgExpense = allExpenses.length > 0 ? total / allExpenses.length : 0;
                
                // En yüksek kategorileri bul
                const topCategory = Object.entries(byCategory).sort((a, b) => b[1] - a[1])[0];
                
                // Pasta grafiği için veriler
                const categoryLabels = Object.keys(byCategory);
                const categoryData = Object.values(byCategory);
                // Zıt renkler - kategoriler net ayrılabilsin
                const categoryColors = [
                    '#FF1744', '#00E676', '#2979FF', '#FFEA00', '#D500F9',
                    '#00E5FF', '#FF6D00', '#C6FF00', '#651FFF', '#FF3D00',
                    '#1DE9B6', '#F50057', '#00B0FF', '#FFD600', '#AA00FF'
                ];
                
                container.innerHTML = `
                    <!-- Başlık ve Butonlar -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                        <h2 style="margin: 0; color: #333; font-size: 28px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 36px;">💸</span>
                            Gider Yönetimi
                        </h2>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <button onclick="openExpenseCategoryManager()" class="btn btn-primary" style="padding: 10px 20px; border-radius: 10px; font-weight: 600; box-shadow: 0 4px 12px rgba(33,150,243,0.3); transition: all 0.2s; display: flex; align-items: center; gap: 8px; font-size: 15px;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <span style="font-size: 16px;">⚙️</span>
                                Kategori Yönetimi
                            </button>
                            <button onclick="openAddExpenseModal()" class="btn btn-danger" style="padding: 12px 24px; border-radius: 12px; font-weight: 600; box-shadow: 0 4px 12px rgba(244,67,54,0.3); transition: all 0.2s; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <span style="font-size: 18px;">➕</span>
                                Yeni Gider Ekle
                            </button>
                        </div>
                    </div>
                    
                    <!-- İstatistik Özet Kartları -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- Toplam Gider -->
                        <div style="background: linear-gradient(135deg, #f44336 0%, #e53935 100%); color: white; padding: 25px; border-radius: 16px; box-shadow: 0 8px 16px rgba(244,67,54,0.3); transform: translateY(0); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 12px 24px rgba(244,67,54,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 16px rgba(244,67,54,0.3)';">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                                <span style="font-size: 36px;">💸</span>
                                <div>
                                    <div style="font-size: 13px; opacity: 0.9; font-weight: 500;">Toplam Gider</div>
                                    <div style="font-size: 12px; opacity: 0.7;">${allExpenses.length} kayıt (${expenses.length} gösteriliyor)</div>
                                </div>
                            </div>
                            <div style="font-size: 32px; font-weight: bold;">${formatPrice(total)}</div>
                        </div>
                        
                        <!-- Ortalama Gider -->
                        <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 25px; border-radius: 16px; box-shadow: 0 8px 16px rgba(255,152,0,0.3); transform: translateY(0); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 12px 24px rgba(255,152,0,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 16px rgba(255,152,0,0.3)';">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                                <span style="font-size: 36px;">📊</span>
                                <div>
                                    <div style="font-size: 13px; opacity: 0.9; font-weight: 500;">Ortalama Gider</div>
                                    <div style="font-size: 12px; opacity: 0.7;">Per kayıt</div>
                                </div>
                            </div>
                            <div style="font-size: 32px; font-weight: bold;">${formatPrice(avgExpense)}</div>
                        </div>
                        
                        <!-- En Yüksek Kategori -->
                        <div style="background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); color: white; padding: 25px; border-radius: 16px; box-shadow: 0 8px 16px rgba(233,30,99,0.3); transform: translateY(0); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 12px 24px rgba(233,30,99,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 16px rgba(233,30,99,0.3)';">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                                <span style="font-size: 36px;">🏆</span>
                                <div>
                                    <div style="font-size: 13px; opacity: 0.9; font-weight: 500;">En Yüksek Kategori</div>
                                    <div style="font-size: 12px; opacity: 0.7;">${topCategory ? topCategory[0] : '-'}</div>
                                </div>
                            </div>
                            <div style="font-size: 32px; font-weight: bold;">${topCategory ? formatPrice(topCategory[1]) : '0₺'}</div>
                        </div>
                        
                        <!-- Kategori Sayısı -->
                        <div style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white; padding: 25px; border-radius: 16px; box-shadow: 0 8px 16px rgba(156,39,176,0.3); transform: translateY(0); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 12px 24px rgba(156,39,176,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 16px rgba(156,39,176,0.3)';">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                                <span style="font-size: 36px;">📂</span>
                                <div>
                                    <div style="font-size: 13px; opacity: 0.9; font-weight: 500;">Kategori Çeşitliliği</div>
                                    <div style="font-size: 12px; opacity: 0.7;">Farklı kategori</div>
                                </div>
                            </div>
                            <div style="font-size: 32px; font-weight: bold;">${categoryLabels.length}</div>
                        </div>
                    </div>
                    
                    <!-- Grafik ve Kategori Detayları -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; margin-bottom: 30px;">
                        <!-- Pasta Grafiği -->
                        <div style="background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                            <h3 style="margin: 0 0 20px 0; color: #333; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 28px;">📈</span>
                                Kategorilere Göre Dağılım
                            </h3>
                            <div style="position: relative; height: 300px;">
                                <canvas id="expenseCategoryChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Kategori Detayları -->
                        <div style="background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                            <h3 style="margin: 0 0 20px 0; color: #333; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 28px;">📋</span>
                                Kategori Detayları
                            </h3>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${Object.entries(byCategory).sort((a, b) => b[1] - a[1]).map(([cat, amount], index) => {
                                    const percentage = ((amount / total) * 100).toFixed(1);
                                    const color = categoryColors[index % categoryColors.length];
                                    return `
                                        <div style="padding: 12px; background: linear-gradient(90deg, ${color}15 0%, transparent 100%); border-left: 4px solid ${color}; border-radius: 8px; margin-bottom: 10px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                                <span style="font-weight: 600; color: #333; font-size: 14px;">${cat}</span>
                                                <span style="background: ${color}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">${percentage}%</span>
                                            </div>
                                            <div style="font-size: 18px; font-weight: bold; color: ${color};">${formatPrice(amount)}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Giderler Tablosu - Modern UI -->
                    <div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 6px 20px rgba(0,0,0,0.08);">
                        <h3 style="margin: 0 0 25px 0; color: #333; display: flex; align-items: center; gap: 12px; font-size: 22px; font-weight: 700;">
                            <span style="font-size: 32px;">📝</span>
                            Gider Detayları
                        </h3>
                        <div style="overflow-x: auto; border-radius: 12px; border: 1px solid #e0e0e0;">
                            <table style="width: 100%; border-collapse: collapse; background: white;">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, #f5f5f5 0%, #e9e9e9 100%);">
                                        <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">📅 Tarih</th>
                                        <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">🏷️ Kategori</th>
                                        <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">🏢 Branş</th>
                                        <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">📄 Açıklama</th>
                                        <th style="padding: 16px 20px; text-align: right; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">💰 Tutar</th>
                                        <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">👤 Ekleyen</th>
                                        <th style="padding: 16px 20px; text-align: center; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">⚙️ İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${displayExpenses.map((expense, index) => `
                                        <tr style="transition: all 0.2s; background: ${index % 2 === 0 ? 'white' : '#fafafa'};" onmouseover="this.style.background='#f0f7ff'; this.style.transform='scale(1.01)'" onmouseout="this.style.background='${index % 2 === 0 ? 'white' : '#fafafa'}'; this.style.transform='scale(1)'">
                                            <td style="padding: 18px 20px; white-space: nowrap; font-size: 14px; color: #666; border-bottom: 1px solid #f0f0f0;">${new Date(expense.date).toLocaleDateString('tr-TR')}</td>
                                            <td style="padding: 18px 20px; border-bottom: 1px solid #f0f0f0;"><span style="background: linear-gradient(135deg, #f44336 0%, #e53935 100%); color: white; padding: 8px 16px; border-radius: 25px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 8px rgba(244,67,54,0.3); display: inline-block;">${expense.category || 'Genel'}</span></td>
                                            <td style="padding: 18px 20px; border-bottom: 1px solid #f0f0f0;"><span style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; padding: 8px 16px; border-radius: 25px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 8px rgba(33,150,243,0.3); display: inline-block;">${expense.branch || 'Genel'}</span></td>
                                            <td style="padding: 18px 20px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; font-size: 14px; color: #666; border-bottom: 1px solid #f0f0f0;">${expense.description || '-'}</td>
                                            <td style="padding: 18px 20px; text-align: right; font-weight: 700; color: #f44336; font-size: 16px; white-space: nowrap; border-bottom: 1px solid #f0f0f0;">${formatPrice(expense.amount || 0)}</td>
                                            <td style="padding: 18px 20px; font-size: 13px; color: #888; border-bottom: 1px solid #f0f0f0;">${expense.createdBy || '-'}</td>
                                            <td style="padding: 18px 20px; text-align: center; border-bottom: 1px solid #f0f0f0;">
                                                <button class="btn btn-sm btn-danger" onclick="deleteExpenseFromPage('${expense.id}')" style="padding: 8px 16px; border-radius: 10px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 6px rgba(244,67,54,0.3); transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                                    🗑️ Sil
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // Pasta grafiğini çiz
                setTimeout(() => {
                    const ctx = document.getElementById('expenseCategoryChart');
                    if (ctx && window.Chart) {
                        // Eski grafiği yok et
                        if (window.expenseCategoryChartInstance) {
                            window.expenseCategoryChartInstance.destroy();
                        }
                        
                        window.expenseCategoryChartInstance = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: categoryLabels,
                                datasets: [{
                                    data: categoryData,
                                    backgroundColor: categoryColors.slice(0, categoryLabels.length),
                                    borderWidth: 2,
                                    borderColor: '#fff'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            padding: 15,
                                            font: {
                                                size: 12,
                                                weight: '600'
                                            },
                                            usePointStyle: true,
                                            pointStyle: 'circle'
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const label = context.label || '';
                                                const value = context.parsed || 0;
                                                const percentage = ((value / total) * 100).toFixed(1);
                                                return label + ': ' + formatPrice(value) + ' (' + percentage + '%)';
                                            }
                                        },
                                        backgroundColor: 'rgba(0,0,0,0.8)',
                                        padding: 12,
                                        titleFont: {
                                            size: 14,
                                            weight: 'bold'
                                        },
                                        bodyFont: {
                                            size: 13
                                        },
                                        borderColor: 'rgba(255,255,255,0.1)',
                                        borderWidth: 1
                                    }
                                }
                            }
                        });
                    }
                }, 100);
            } catch (error) {
                console.error('Giderler yüklenirken hata:', error);
                container.innerHTML = '<div class="empty-state"><p style="color: #f44336;">❌ Giderler yüklenirken bir hata oluştu</p></div>';
            }
        };
        
        // Gider sil (expenses sayfasından)
        // ✅ SUPABASE: Gider sil (Giderler sayfasından)
        window.deleteExpenseFromPage = async function(expenseId) {
            if (!confirm('Bu gideri silmek istediğinize emin misiniz?')) return;
            
            try {
                const { error } = await supabase
                    .from('expenses')
                    .delete()
                    .eq('id', expenseId);
                
                if (error) throw error;
                
                showAlert('✅ Gider silindi', 'success');
                
                // Açık sayfaya göre yenile
                if (currentSection === 'accounting-summary') {
                    renderAccountingSummary();
                } else if (currentSection === 'expenses') {
                    renderExpensesPage();
                }
            } catch (error) {
                console.error('Gider silinirken hata:', error);
                showAlert('❌ Gider silinirken bir hata oluştu', 'danger');
            }
        };
        
        // Hızlı dönem filtresi
        window.setExpensePeriod = function(period) {
            const today = new Date();
            const startDate = new Date();
            const endDate = new Date();
            
            switch(period) {
                case 'today':
                    // Bugün
                    break;
                case 'week':
                    // Son 7 gün
                    startDate.setDate(today.getDate() - 7);
                    break;
                case 'month':
                    // Bu ayın ilk günü
                    startDate.setDate(1);
                    break;
                case 'lastMonth':
                    // Geçen ayın ilk ve son günü
                    startDate.setMonth(today.getMonth() - 1);
                    startDate.setDate(1);
                    endDate.setDate(0); // Geçen ayın son günü
                    break;
                case 'year':
                    // Bu yılın ilk günü
                    startDate.setMonth(0);
                    startDate.setDate(1);
                    break;
            }
            
            // Tarih inputlarını güncelle
            document.getElementById('expensesStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('expensesEndDate').value = endDate.toISOString().split('T')[0];
            
            // Sayfayı yenile
            renderExpensesPage();
        };
        
        // Giderler filtrelerini sıfırla
        window.resetExpensesFilters = function() {
            document.getElementById('expensesStartDate').value = '';
            document.getElementById('expensesEndDate').value = '';
            document.getElementById('expensesCategoryFilter').value = 'all';
            const branchFilter = document.getElementById('expensesBranchFilter');
            if (branchFilter) {
                // ✅ Dropdown'u sıfırla ve yeniden doldur
                branchFilter.innerHTML = '<option value="all">Tümü</option>';
                const availableBranches = filterByBranch(branches, 'id');
                availableBranches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.name;
                    option.textContent = branch.name;
                    branchFilter.appendChild(option);
                });
                branchFilter.value = 'all';
            }
            renderExpensesPage();
        };
        
        // 💰 GELİRLER (INCOMES) FUNCTIONS
        // ============================================
        
        // Gelirler sayfasını render et
        window.renderIncomesPage = async function() {
            const container = document.getElementById('incomesPageContainer');
            if (!container) return;
            
            // İlk açılışta bu ay filtrelerini ayarla
            const startDateInput = document.getElementById('incomesStartDate');
            const endDateInput = document.getElementById('incomesEndDate');
            if (startDateInput && !startDateInput.value && endDateInput && !endDateInput.value) {
                const now = new Date();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                
                startDateInput.value = startOfMonth.toISOString().split('T')[0];
                endDateInput.value = endOfMonth.toISOString().split('T')[0];
            }
            
            // Branş filtrelerini doldur - SADECE YETKİLİ BRANŞLAR
            const branchFilter = document.getElementById('incomesBranchFilter');
            if (branchFilter && branchFilter.options.length === 1) {
                // ✅ BRANŞ FİLTRESİ: Sadece yetkili branşları göster
                const availableBranches = filterByBranch(branches, 'id');
                
                availableBranches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.name;
                    option.textContent = branch.name;
                    branchFilter.appendChild(option);
                });
            }
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Gelirler yükleniyor...</span></div>';
            
            try {
                // otherIncomes tablosundan gelir verilerini çek (Supabase)
                const { data: incomes, error } = await supabaseClient
                    .from('otherIncomes')
                    .select('*')
                    .eq('clubId', currentClubId);
                
                if (error) throw error;
                
                // Ürün satışlarını çek (productSales tablosundan)
                const { data: productSales, error: salesError } = await supabaseClient
                    .from('productSales')
                    .select('*')
                    .eq('clubId', currentClubId);
                
                if (salesError) {
                    console.error('Ürün satışları çekilirken hata:', salesError);
                }
                
                // Ürün satışlarını gelir formatına dönüştür
                const salesAsIncomes = (productSales || []).map(sale => ({
                    id: sale.id,
                    date: sale.saleDate,
                    category: '🛒 Ürün Satışları',
                    branch: sale.branch || 'Genel',
                    description: `${sale.productName} (${sale.quantity} adet)${sale.customer ? ' - ' + sale.customer : ''}${sale.note ? ' - ' + sale.note : ''}`,
                    amount: parseFloat(sale.totalAmount) || 0,
                    createdBy: sale.createdBy || '-',
                    isProductSale: true
                }));
                
                // Aidatları gelir olarak ekle (preRegistrations'dan paymentSchedule)
                const memberPaymentsAsIncomes = [];
                
                // ✅ BRANŞ FİLTRESİ: Önce members'ı filtrele
                const filteredMembersForIncomes = filterByBranch(members, 'Brans');
                
                const activeMembers = filteredMembersForIncomes.filter(m => {
                    if (m.status !== 'active' && m.status !== 'pending') return false;
                    if (!m.preRegistrationId) return false;
                    const preReg = preRegistrations.find(p => p.id === m.preRegistrationId);
                    return preReg && preReg.paymentSchedule && preReg.paymentSchedule.length > 0;
                });
                
                activeMembers.forEach(member => {
                    const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                    if (!preReg || !preReg.paymentSchedule) return;
                    
                    // Üye ismini doğru alanlardan al (Resit_Olmayan_Adi_Soyadi veya Ad_Soyad)
                    const memberName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad || preReg.Resit_Olmayan_Adi_Soyadi || preReg.Ad_Soyad || `Üye #${member.id.slice(-8)}`;
                    
                    const memberBranch = preReg.branch || member.branch || 'Genel';
                    
                    preReg.paymentSchedule.forEach((payment, idx) => {
                        if (payment.status !== 'paid' || !payment.paymentDate) return;
                        
                        let paymentDateStr = payment.paymentDate;
                        if (paymentDateStr.length === 10 && paymentDateStr.includes('-')) {
                            paymentDateStr += 'T00:00:00';
                        }
                        const paymentDate = new Date(paymentDateStr);
                        
                        if (isNaN(paymentDate.getTime())) return;
                        
                        const installmentNum = payment.installment || (idx + 1);
                        
                        memberPaymentsAsIncomes.push({
                            id: `payment_${member.id}_${installmentNum}`,
                            date: paymentDate.toISOString(),
                            category: '💳 Aidat Ödemeleri',
                            branch: memberBranch,
                            description: `${memberName} - Taksit ${installmentNum}`,
                            amount: parseFloat(payment.amount) || 0,
                            createdBy: 'Sistem',
                            isPayment: true
                        });
                    });
                });
                
                // Tüm gelirleri birleştir (otherIncomes + ürün satışları + aidatlar)
                let filteredIncomes = [...(incomes || []), ...salesAsIncomes, ...memberPaymentsAsIncomes];
                
                // ✅ BRANŞ FİLTRESİ: Kullanıcının yetkili olduğu branşlara göre filtrele (dropdown öncesi)
                filteredIncomes = filterByBranch(filteredIncomes, 'branch');
                
                console.log('📊 Gelir kaynakları (filtrelenmiş):', {
                    otherIncomes: (incomes || []).length,
                    productSales: salesAsIncomes.length,
                    memberPayments: memberPaymentsAsIncomes.length,
                    totalFiltered: filteredIncomes.length,
                    samplePaymentBranches: filteredIncomes.slice(0, 3).map(p => p.branch)
                });
                
                // Tarih filtrelerini uygula
                const startDateInput = document.getElementById('incomesStartDate');
                const endDateInput = document.getElementById('incomesEndDate');
                const categoryFilterInput = document.getElementById('incomesCategoryFilter');
                const branchFilterInput = document.getElementById('incomesBranchFilter');
                
                if (startDateInput && startDateInput.value) {
                    const startDate = new Date(startDateInput.value);
                    startDate.setHours(0, 0, 0, 0);
                    filteredIncomes = filteredIncomes.filter(inc => {
                        const incDate = new Date(inc.date);
                        return incDate >= startDate;
                    });
                }
                
                if (endDateInput && endDateInput.value) {
                    const endDate = new Date(endDateInput.value);
                    endDate.setHours(23, 59, 59, 999);
                    filteredIncomes = filteredIncomes.filter(inc => {
                        const incDate = new Date(inc.date);
                        return incDate <= endDate;
                    });
                }
                
                // Kategori filtresini uygula
                if (categoryFilterInput && categoryFilterInput.value !== 'all') {
                    const selectedCategory = categoryFilterInput.value;
                    filteredIncomes = filteredIncomes.filter(inc => inc.category === selectedCategory);
                }
                
                // Branş filtresini uygula
                if (branchFilterInput && branchFilterInput.value !== 'all') {
                    const selectedBranch = branchFilterInput.value;
                    filteredIncomes = filteredIncomes.filter(inc => inc.branch === selectedBranch);
                }
                
                // Client-side sorting ve limit
                filteredIncomes.sort((a, b) => {
                    const dateA = new Date(a.date || 0);
                    const dateB = new Date(b.date || 0);
                    return dateB - dateA; // En yeni en üstte
                });
                
                // Toplam hesaplama için tüm kayıtları kullan
                const allIncomes = [...filteredIncomes];
                
                // Sadece tabloda göstermek için ilk 20 kayıt
                filteredIncomes = filteredIncomes.slice(0, 20);
                
                if (allIncomes.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>Henüz gelir kaydı yok. "➕ Gelir Ekle" butonunu kullanarak gelir ekleyebilirsiniz.</p></div>';
                    return;
                }
                
                // Kategoriye göre topla (tüm kayıtlar üzerinden)
                const byCategory = {};
                const byBranch = {};
                let total = 0;
                
                allIncomes.forEach(inc => {
                    const cat = inc.category || 'Diğer Gelir';
                    const branch = inc.branch || 'Genel';
                    
                    if (!byCategory[cat]) byCategory[cat] = 0;
                    if (!byBranch[branch]) byBranch[branch] = 0;
                    
                    byCategory[cat] += inc.amount || 0;
                    byBranch[branch] += inc.amount || 0;
                    total += inc.amount || 0;
                });
                
                // En yüksek kategorileri bul
                const topCategory = Object.entries(byCategory).sort((a, b) => b[1] - a[1])[0];
                
                // Pasta grafiği için veriler
                const categoryLabels = Object.keys(byCategory);
                const categoryData = Object.values(byCategory);
                
                // Kategoriye göre özel renk atama fonksiyonu
                const getCategoryColor = (category, index) => {
                    if (category.includes('Aidat')) return '#2979FF'; // Mavi - Aidat ödemeleri
                    if (category.includes('Ürün Satış')) return '#00E676'; // Yeşil - Ürün satışları
                    
                    // Diğer kategoriler için zıt renkler
                    const defaultColors = [
                        '#FF1744', '#FFEA00', '#D500F9', '#00E5FF', '#FF6D00', 
                        '#C6FF00', '#651FFF', '#FF3D00', '#1DE9B6', '#F50057', 
                        '#00B0FF', '#FFD600', '#AA00FF'
                    ];
                    return defaultColors[index % defaultColors.length];
                };
                
                // Her kategori için renk dizisi oluştur
                const categoryColors = categoryLabels.map((cat, idx) => getCategoryColor(cat, idx));
                
                container.innerHTML = `
                    <!-- Başlık ve Butonlar -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                        <h2 style="margin: 0; color: #333; font-size: 28px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 36px;">💰</span>
                            Gelir Yönetimi
                        </h2>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <button onclick="openIncomeCategoryManager()" class="btn btn-primary" style="padding: 10px 20px; border-radius: 10px; font-weight: 600; box-shadow: 0 4px 12px rgba(33,150,243,0.3); transition: all 0.2s; display: flex; align-items: center; gap: 8px; font-size: 15px;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <span style="font-size: 16px;">⚙️</span>
                                Kategori Yönetimi
                            </button>
                            <button onclick="openAddIncomeModal()" class="btn btn-success" style="padding: 12px 24px; border-radius: 12px; font-weight: 600; box-shadow: 0 4px 12px rgba(76,175,80,0.3); transition: all 0.2s; display: flex; align-items: center; gap: 8px;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <span style="font-size: 18px;">➕</span>
                                Yeni Gelir Ekle
                            </button>
                        </div>
                    </div>
                    
                    <!-- İstatistik Özet Kartları -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- Toplam Gelir -->
                        <div style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; padding: 25px; border-radius: 16px; box-shadow: 0 8px 16px rgba(76,175,80,0.3); transform: translateY(0); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 12px 24px rgba(76,175,80,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 16px rgba(76,175,80,0.3)';">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                                <span style="font-size: 36px;">💰</span>
                                <div>
                                    <div style="font-size: 13px; opacity: 0.9; font-weight: 500;">Toplam Gelir</div>
                                    <div style="font-size: 12px; opacity: 0.7;">${allIncomes.length} kayıt (${filteredIncomes.length} gösteriliyor)</div>
                                </div>
                            </div>
                            <div style="font-size: 32px; font-weight: bold;">${formatPrice(total)}</div>
                        </div>
                        
                        <!-- En Yüksek Kategori -->
                        <div style="background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%); color: white; padding: 25px; border-radius: 16px; box-shadow: 0 8px 16px rgba(102,187,106,0.3); transform: translateY(0); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 12px 24px rgba(102,187,106,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 16px rgba(102,187,106,0.3)';">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                                <span style="font-size: 36px;">🏆</span>
                                <div>
                                    <div style="font-size: 13px; opacity: 0.9; font-weight: 500;">En Yüksek Kategori</div>
                                    <div style="font-size: 12px; opacity: 0.7;">${topCategory ? topCategory[0] : '-'}</div>
                                </div>
                            </div>
                            <div style="font-size: 32px; font-weight: bold;">${topCategory ? formatPrice(topCategory[1]) : '0₺'}</div>
                        </div>
                        
                        <!-- Kategori Sayısı -->
                        <div style="background: linear-gradient(135deg, #81c784 0%, #66bb6a 100%); color: white; padding: 25px; border-radius: 16px; box-shadow: 0 8px 16px rgba(129,199,132,0.3); transform: translateY(0); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 12px 24px rgba(129,199,132,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 16px rgba(129,199,132,0.3)';">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                                <span style="font-size: 36px;">📂</span>
                                <div>
                                    <div style="font-size: 13px; opacity: 0.9; font-weight: 500;">Kategori Çeşitliliği</div>
                                    <div style="font-size: 12px; opacity: 0.7;">Farklı kategori</div>
                                </div>
                            </div>
                            <div style="font-size: 32px; font-weight: bold;">${categoryLabels.length}</div>
                        </div>
                    </div>
                    
                    <!-- Grafik ve Kategori Detayları -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; margin-bottom: 30px;">
                        <!-- Pasta Grafiği -->
                        <div style="background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                            <h3 style="margin: 0 0 20px 0; color: #333; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 28px;">📈</span>
                                Kategorilere Göre Dağılım
                            </h3>
                            <div style="position: relative; height: 300px;">
                                <canvas id="incomeCategoryChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Kategori Detayları -->
                        <div style="background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                            <h3 style="margin: 0 0 20px 0; color: #333; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 28px;">📋</span>
                                Kategori Detayları
                            </h3>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${Object.entries(byCategory).sort((a, b) => b[1] - a[1]).map(([cat, amount], index) => {
                                    const percentage = ((amount / total) * 100).toFixed(1);
                                    // Kategori bazlı renk - getCategoryColor fonksiyonunu kullan
                                    const categoryIndex = categoryLabels.indexOf(cat);
                                    const color = categoryColors[categoryIndex];
                                    return `
                                        <div style="padding: 12px; background: linear-gradient(90deg, ${color}15 0%, transparent 100%); border-left: 4px solid ${color}; border-radius: 8px; margin-bottom: 10px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                                <span style="font-weight: 600; color: #333; font-size: 14px;">${cat}</span>
                                                <span style="background: ${color}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">${percentage}%</span>
                                            </div>
                                            <div style="font-size: 18px; font-weight: bold; color: ${color};">${formatPrice(amount)}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gelirler Tablosu - Modern UI -->
                    <div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 6px 20px rgba(0,0,0,0.08);">
                        <h3 style="margin: 0 0 25px 0; color: #333; display: flex; align-items: center; gap: 12px; font-size: 22px; font-weight: 700;">
                            <span style="font-size: 32px;">📝</span>
                            Gelir Detayları
                        </h3>
                        <div style="overflow-x: auto; border-radius: 12px; border: 1px solid #e0e0e0;">
                            <table style="width: 100%; border-collapse: collapse; background: white;">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, #f5f5f5 0%, #e9e9e9 100%);">
                                        <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">📅 Tarih</th>
                                        <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">🏷️ Kategori</th>
                                        <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">🏢 Branş</th>
                                        <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">📄 Açıklama</th>
                                        <th style="padding: 16px 20px; text-align: right; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">💰 Tutar</th>
                                        <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">👤 Ekleyen</th>
                                        <th style="padding: 16px 20px; text-align: center; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">⚙️ İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredIncomes.map((income, index) => {
                                        const categoryColor = income.isProductSale ? '#ff9800 0%, #f57c00' : (income.isPayment ? '#2196f3 0%, #1976d2' : '#4caf50 0%, #45a049');
                                        const canDelete = !income.isProductSale && !income.isPayment;
                                        const actionText = income.isProductSale ? 'Ürün Satışı' : (income.isPayment ? 'Aidat Ödemesi' : '');
                                        
                                        return `
                                        <tr style="transition: all 0.2s; background: ${index % 2 === 0 ? 'white' : '#fafafa'};" onmouseover="this.style.background='#f0fff4'; this.style.transform='scale(1.01)'" onmouseout="this.style.background='${index % 2 === 0 ? 'white' : '#fafafa'}'; this.style.transform='scale(1)'">
                                            <td style="padding: 18px 20px; white-space: nowrap; font-size: 14px; color: #666; border-bottom: 1px solid #f0f0f0;">${new Date(income.date).toLocaleDateString('tr-TR')}</td>
                                            <td style="padding: 18px 20px; border-bottom: 1px solid #f0f0f0;"><span style="background: linear-gradient(135deg, ${categoryColor} 100%); color: white; padding: 8px 16px; border-radius: 25px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 8px rgba(76,175,80,0.3); display: inline-block;">${income.category || 'Diğer Gelir'}</span></td>
                                            <td style="padding: 18px 20px; border-bottom: 1px solid #f0f0f0;"><span style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; padding: 8px 16px; border-radius: 25px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 8px rgba(33,150,243,0.3); display: inline-block;">${income.branch || 'Genel'}</span></td>
                                            <td style="padding: 18px 20px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; font-size: 14px; color: #666; border-bottom: 1px solid #f0f0f0;">${income.description || '-'}</td>
                                            <td style="padding: 18px 20px; text-align: right; font-weight: 700; color: #4caf50; font-size: 16px; white-space: nowrap; border-bottom: 1px solid #f0f0f0;">${formatPrice(income.amount || 0)}</td>
                                            <td style="padding: 18px 20px; font-size: 13px; color: #888; border-bottom: 1px solid #f0f0f0;">${income.createdBy || '-'}</td>
                                            <td style="padding: 18px 20px; text-align: center; border-bottom: 1px solid #f0f0f0;">
                                                ${canDelete 
                                                    ? `<button class="btn btn-sm btn-danger" onclick="deleteIncomeFromPage('${income.id}')" style="padding: 8px 16px; border-radius: 10px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 6px rgba(244,67,54,0.3); transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                                    🗑️ Sil
                                                </button>`
                                                    : `<span style="color: #999; font-size: 12px;">${actionText}</span>`
                                                }
                                            </td>
                                        </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // Pasta grafiğini çiz
                setTimeout(() => {
                    const ctx = document.getElementById('incomeCategoryChart');
                    if (ctx && window.Chart) {
                        // Eski grafiği yok et
                        if (window.incomeCategoryChartInstance) {
                            window.incomeCategoryChartInstance.destroy();
                        }
                        
                        window.incomeCategoryChartInstance = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: categoryLabels,
                                datasets: [{
                                    data: categoryData,
                                    backgroundColor: categoryColors.slice(0, categoryLabels.length),
                                    borderWidth: 2,
                                    borderColor: '#fff'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            padding: 15,
                                            font: {
                                                size: 12,
                                                weight: '600'
                                            },
                                            usePointStyle: true,
                                            pointStyle: 'circle'
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const label = context.label || '';
                                                const value = context.parsed || 0;
                                                const percentage = ((value / total) * 100).toFixed(1);
                                                return label + ': ' + formatPrice(value) + ' (' + percentage + '%)';
                                            }
                                        },
                                        backgroundColor: 'rgba(0,0,0,0.8)',
                                        padding: 12,
                                        titleFont: {
                                            size: 14,
                                            weight: 'bold'
                                        },
                                        bodyFont: {
                                            size: 13
                                        },
                                        borderColor: 'rgba(255,255,255,0.1)',
                                        borderWidth: 1
                                    }
                                }
                            }
                        });
                    }
                }, 100);
            } catch (error) {
                console.error('Gelirler yüklenirken hata:', error);
                container.innerHTML = '<div class="empty-state"><p style="color: #f44336;">❌ Gelirler yüklenirken bir hata oluştu</p></div>';
            }
        };
        
        // Gelir sil (incomes sayfasından)
        window.deleteIncomeFromPage = async function(incomeId) {
            if (!confirm('Bu geliri silmek istediğinize emin misiniz?')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('otherIncomes')
                    .delete()
                    .eq('id', incomeId);
                
                if (error) throw error;
                
                showAlert('✅ Gelir silindi', 'success');
                
                // Açık sayfaya göre yenile
                if (currentSection === 'accounting-summary') {
                    renderAccountingSummary();
                } else if (currentSection === 'incomes') {
                    renderIncomesPage();
                }
            } catch (error) {
                console.error('Gelir silinirken hata:', error);
                showAlert('❌ Gelir silinirken bir hata oluştu', 'danger');
            }
        };
        
        // Hızlı dönem filtresi (gelirler için)
        window.setIncomePeriod = function(period) {
            const today = new Date();
            const startDate = new Date();
            const endDate = new Date();
            
            switch(period) {
                case 'today':
                    // Bugün
                    break;
                case 'week':
                    // Son 7 gün
                    startDate.setDate(today.getDate() - 7);
                    break;
                case 'month':
                    // Bu ayın ilk günü
                    startDate.setDate(1);
                    break;
                case 'lastMonth':
                    // Geçen ayın ilk ve son günü
                    startDate.setMonth(today.getMonth() - 1);
                    startDate.setDate(1);
                    endDate.setDate(0); // Geçen ayın son günü
                    break;
                case 'year':
                    // Bu yılın ilk günü
                    startDate.setMonth(0);
                    startDate.setDate(1);
                    break;
            }
            
            // Tarih inputlarını güncelle
            document.getElementById('incomesStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('incomesEndDate').value = endDate.toISOString().split('T')[0];
            
            // Sayfayı yenile
            renderIncomesPage();
        };
        
        // Gelirler filtrelerini sıfırla
        window.resetIncomesFilters = function() {
            document.getElementById('incomesStartDate').value = '';
            document.getElementById('incomesEndDate').value = '';
            document.getElementById('incomesCategoryFilter').value = 'all';
            const branchFilter = document.getElementById('incomesBranchFilter');
            if (branchFilter) {
                // ✅ Dropdown'u sıfırla ve yeniden doldur
                branchFilter.innerHTML = '<option value="all">Tümü</option>';
                const availableBranches = filterByBranch(branches, 'id');
                availableBranches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.name;
                    option.textContent = branch.name;
                    branchFilter.appendChild(option);
                });
                branchFilter.value = 'all';
            }
            renderIncomesPage();
        };
        
        // Gelir ekle modal aç
        window.openAddIncomeModal = async function() {
            // Kategori seçeneklerini düzgün emoji'lerle doldur
            const categorySelect = document.getElementById('incomeCategory');
            if (categorySelect) {
                categorySelect.innerHTML = `
                    <option value="">Seçiniz...</option>
                    <option value="Aidat">💳 Aidat</option>
                    <option value="Diğer Gelir">💰 Diğer Gelir</option>
                `;
                
                // Özel kategorileri Supabase'den yükle ve ekle
                try {
                    const { data: customCategories, error } = await supabaseClient
                        .from('incomeCategories')
                        .select('*')
                        .eq('clubId', currentClubId)
                        .order('name');
                    
                    if (!error && customCategories && customCategories.length > 0) {
                        customCategories.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat.name;
                            option.textContent = `${cat.icon || '📌'} ${cat.name}`;
                            categorySelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Özel kategoriler yüklenirken hata:', error);
                }
            }
            
            // Branş seçeneklerini doldur - SADECE YETKİLİ BRANŞLAR
            const branchSelect = document.getElementById('incomeBranch');
            if (branchSelect) {
                branchSelect.innerHTML = '<option value="">Seçiniz...</option>';
                
                // ✅ BRANŞ FİLTRESİ: Sadece yetkili branşları göster
                const availableBranches = filterByBranch(branches, 'id');
                
                availableBranches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.name;
                    option.textContent = `${branch.icon || '🏢'} ${branch.name}`;
                    branchSelect.appendChild(option);
                });
            }
            
            // Tarihi bugün olarak ayarla
            const dateInput = document.getElementById('incomeDate');
            if (dateInput) {
                dateInput.value = new Date().toISOString().split('T')[0];
            }
            
            // Formu temizle
            document.getElementById('incomeForm').reset();
            
            // Modal'ı aç
            openModal('addIncomeModal');
        };
        
        // Gelir form submit handler
        window.handleIncomeFormSubmit = async function(event) {
            event.preventDefault();
            
            const amount = parseFloat(document.getElementById('incomeAmount').value);
            const category = document.getElementById('incomeCategory').value;
            const branch = document.getElementById('incomeBranch').value;
            const date = document.getElementById('incomeDate').value;
            const description = document.getElementById('incomeDescription').value;
            
            if (!amount || !category || !branch || !date) {
                showAlert('❌ Lütfen tüm zorunlu alanları doldurun', 'danger');
                return;
            }
            
            // Modal'ı kapat
            closeModal('addIncomeModal');
            
            // Gelir ekle
            await saveIncome(amount, category, branch, date, description);
        };
        
        // Gelir kaydet
        async function saveIncome(amount, category, branch, date, description) {
            try {
                const incomeData = {
                    clubId: currentClubId,
                    amount: amount,
                    category: category,
                    branch: branch,
                    date: date,
                    description: description || null,
                    createdBy: currentUser?.fullName || currentUser?.email || 'Admin',
                    createdAt: new Date().toISOString()
                };
                
                const { error } = await supabaseClient
                    .from('otherIncomes')
                    .insert([incomeData]);
                
                if (error) throw error;
                
                showAlert('✅ Gelir başarıyla eklendi', 'success');
                
                // Kısa bir gecikme ile veritabanının güncellenmesini bekle
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Açık sayfaya göre yenile
                if (currentSection === 'accounting-summary') {
                    renderAccountingSummary();
                } else if (currentSection === 'incomes') {
                    renderIncomesPage();
                }
            } catch (error) {
                console.error('Gelir eklenirken hata:', error);
                showAlert('❌ Gelir eklenirken bir hata oluştu', 'danger');
            }
        }
        
        // Gelir kategori yöneticisi aç
        window.openIncomeCategoryManager = async function() {
            openModal('incomeCategoryManagerModal');
            await loadIncomeCategories();
        };
        
        // Gelir kategorilerini yükle
        async function loadIncomeCategories() {
            try {
                const { data: categories, error } = await supabaseClient
                    .from('incomeCategories')
                    .select('*')
                    .eq('clubId', currentClubId)
                    .order('name');
                
                if (error) throw error;
                
                const container = document.getElementById('incomeCategoryList');
                if (!container) return;
                
                if (!categories || categories.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Henüz özel kategori eklenmemiş.</p>';
                    return;
                }
                
                container.innerHTML = categories.map((cat, index) => `
                    <div style="padding: 15px; background: white; border-radius: 8px; border: 2px solid #e0e0e0; text-align: center; position: relative; transition: all 0.2s; cursor: pointer;" onmouseover="this.style.borderColor='#4caf50'" onmouseout="this.style.borderColor='#e0e0e0'">
                        <div style="font-size: 36px; margin-bottom: 8px;">${cat.icon || '📦'}</div>
                        <div style="font-weight: 600; color: #333; font-size: 13px; margin-bottom: 10px;">${cat.name}</div>
                        <button onclick="deleteIncomeCategory('${cat.id}', '${cat.name}')" class="btn btn-sm btn-danger" style="padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;">
                            🗑️ Sil
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Kategoriler yüklenirken hata:', error);
                showAlert('❌ Kategoriler yüklenirken bir hata oluştu', 'danger');
            }
        }
        
        // Icon seçimi için helper fonksiyon
        window.selectIncomeIcon = function(icon) {
            const iconInput = document.getElementById('newCategoryIcon');
            const selectedIconDisplay = document.getElementById('incomeSelectedIcon');
            
            if (iconInput) iconInput.value = icon;
            if (selectedIconDisplay) selectedIconDisplay.textContent = icon;
            
            // Tüm icon butonlarından seçili stilini kaldır
            document.querySelectorAll('#incomeIconPicker .icon-option').forEach(btn => {
                btn.style.borderColor = 'transparent';
                btn.style.background = 'white';
            });
            
            // Seçili icon'a stil ekle
            const selectedBtn = document.querySelector(`#incomeIconPicker .icon-option[data-icon="${icon}"]`);
            if (selectedBtn) {
                selectedBtn.style.borderColor = '#4caf50';
                selectedBtn.style.background = '#e8f5e9';
            }
        };
        
        // Icon input değiştiğinde preview'u güncelle
        document.addEventListener('DOMContentLoaded', function() {
            const iconInput = document.getElementById('newCategoryIcon');
            if (iconInput) {
                iconInput.addEventListener('input', function(e) {
                    const selectedIconDisplay = document.getElementById('incomeSelectedIcon');
                    if (selectedIconDisplay) {
                        selectedIconDisplay.textContent = e.target.value || '📦';
                    }
                });
            }
        });
        
        // Yeni gelir kategorisi ekle
        window.handleAddIncomeCategory = async function(event) {
            event.preventDefault();
            
            const nameInput = document.getElementById('newCategoryName');
            const iconInput = document.getElementById('newCategoryIcon');
            const name = nameInput.value.trim();
            const icon = iconInput ? iconInput.value.trim() : '📦';
            
            if (!name) {
                showAlert('⚠️ Lütfen kategori adı giriniz', 'warning');
                return;
            }
            
            try {
                const categoryData = {
                    clubId: currentClubId,
                    name: name,
                    icon: icon || '📦',
                    name: name,
                    createdAt: new Date().toISOString()
                };
                
                const { error } = await supabaseClient
                    .from('incomeCategories')
                    .insert([categoryData]);
                
                if (error) throw error;
                
                showAlert('✅ Kategori başarıyla eklendi', 'success');
                nameInput.value = '';
                if (iconInput) iconInput.value = '';
                document.getElementById('incomeSelectedIcon').textContent = '📦';
                await loadIncomeCategories();
                
                // Modal'ı kapat
                closeModal('incomeCategoryManagerModal');
                
            } catch (error) {
                console.error('Kategori eklenirken hata:', error);
                showAlert('❌ Kategori eklenirken bir hata oluştu', 'danger');
            }
        };
        
        // Gelir kategorisini sil
        window.deleteIncomeCategory = async function(categoryId, categoryName) {
            if (!confirm(`"${categoryName}" kategorisini silmek istediğinizden emin misiniz?`)) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('incomeCategories')
                    .delete()
                    .eq('id', categoryId);
                
                if (error) throw error;
                
                showAlert('✅ Kategori silindi', 'success');
                await loadIncomeCategories();
                
            } catch (error) {
                console.error('Kategori silinirken hata:', error);
                showAlert('❌ Kategori silinirken bir hata oluştu', 'danger');
            }
        };
        
        // Ürünler sayfasını render et
        window.renderProductsPage = async function() {
            const container = document.getElementById('productsPageContainer');
            if (!container) return;
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Ürünler yükleniyor...</span></div>';
            
            try {
                // ✅ SUPABASE: products yükleme
                const { data: products, error } = await supabase
                    .from('products')
                    .select('*')
                    .eq('clubId', currentClubId);
                
                if (error) {
                    console.error('Products yükleme hatası:', error);
                    container.innerHTML = '<div class="alert alert-danger">❌ Ürünler yüklenirken bir hata oluştu</div>';
                    return;
                }
                
                let filteredProducts = products || [];
                
                // ✅ BRANŞ FİLTRESİ: Kullanıcının yetkili olduğu branşlara göre filtrele
                filteredProducts = filterByBranch(filteredProducts, 'branch');
                
                // Client-side sorting
                filteredProducts.sort((a, b) => {
                    const dateA = new Date(a.createdAt || 0);
                    const dateB = new Date(b.createdAt || 0);
                    return dateB - dateA; // En yeni en üstte
                });
                
                if (filteredProducts.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>Henüz ürün kaydı yok. "➕ Ürün Ekle" butonunu kullanarak ürün ekleyebilirsiniz.</p></div>';
                    return;
                }
                
                // Kategoriye göre topla
                const byCategory = {};
                let totalValue = 0;
                let totalStock = 0;
                filteredProducts.forEach(prod => {
                    const cat = prod.category || 'Diğer';
                    if (!byCategory[cat]) byCategory[cat] = { count: 0, value: 0 };
                    byCategory[cat].count++;
                    byCategory[cat].value += (prod.price || 0) * (prod.stock || 0);
                    totalValue += (prod.price || 0) * (prod.stock || 0);
                    totalStock += prod.stock || 0;
                });
                
                container.innerHTML = `
                    <!-- Özet Kartları -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">🛍️ Toplam Ürün</div>
                            <div style="font-size: 28px; font-weight: bold;">${filteredProducts.length}</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Stok: ${totalStock}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">💰 Toplam Değer</div>
                            <div style="font-size: 28px; font-weight: bold;">${totalValue.toFixed(2)} ₺</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Envanter değeri</div>
                        </div>
                    </div>
                    
                    <!-- Ürünler Tablosu - Modern UI -->
                    <div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 6px 20px rgba(0,0,0,0.08);">
                        <h3 style="margin: 0 0 25px 0; color: #333; display: flex; align-items: center; gap: 12px; font-size: 22px; font-weight: 700;">
                            <span style="font-size: 32px;">🛍️</span>
                            Ürün Detayları
                        </h3>
                        <div style="overflow-x: auto; border-radius: 12px; border: 1px solid #e0e0e0;">
                            <table style="width: 100%; border-collapse: collapse; background: white;">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, #f5f5f5 0%, #e9e9e9 100%);">
                                        <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">🏷️ Ürün Adı</th>
                                        <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">📂 Kategori</th>
                                        <th style="padding: 16px 20px; text-align: right; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">💵 Fiyat</th>
                                        <th style="padding: 16px 20px; text-align: center; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">📦 Stok</th>
                                        <th style="padding: 16px 20px; text-align: right; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">💰 Toplam Değer</th>
                                        <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">👤 Ekleyen</th>
                                        <th style="padding: 16px 20px; text-align: center; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">⚙️ İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredProducts.map((product, index) => {
                                        const totalVal = (product.price || 0) * (product.stock || 0);
                                        return `
                                        <tr style="transition: all 0.2s; background: ${index % 2 === 0 ? 'white' : '#fafafa'};" onmouseover="this.style.background='#f0f7ff'; this.style.transform='scale(1.01)'" onmouseout="this.style.background='${index % 2 === 0 ? 'white' : '#fafafa'}'; this.style.transform='scale(1)'">
                                            <td style="padding: 18px 20px; font-weight: 600; font-size: 14px; color: #333; border-bottom: 1px solid #f0f0f0;">${product.name || '-'}</td>
                                            <td style="padding: 18px 20px; border-bottom: 1px solid #f0f0f0;"><span style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 8px 16px; border-radius: 25px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 8px rgba(255,152,0,0.3); display: inline-block;">${product.category || 'Genel'}</span></td>
                                            <td style="padding: 18px 20px; text-align: right; font-weight: 700; color: #4caf50; font-size: 16px; border-bottom: 1px solid #f0f0f0;">${product.price || 0} ₺</td>
                                            <td style="padding: 18px 20px; text-align: center; border-bottom: 1px solid #f0f0f0;"><span style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; padding: 8px 16px; border-radius: 25px; font-weight: 600; box-shadow: 0 2px 8px rgba(33,150,243,0.3); display: inline-block;">${product.stock !== undefined ? product.stock : '-'}</span></td>
                                            <td style="padding: 18px 20px; text-align: right; font-weight: 700; font-size: 16px; color: #333; border-bottom: 1px solid #f0f0f0;">${totalVal.toFixed(2)} ₺</td>
                                            <td style="padding: 18px 20px; font-size: 13px; color: #888; border-bottom: 1px solid #f0f0f0;">${product.createdBy || '-'}</td>
                                            <td style="padding: 18px 20px; text-align: center; border-bottom: 1px solid #f0f0f0;">
                                                <button class="btn btn-sm btn-success" onclick="openProductSaleModal('${product.id}', '${product.name.replace(/'/g, "\\'")}', ${product.price || 0}, ${product.stock || 0})" style="padding: 8px 16px; border-radius: 10px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 6px rgba(76,175,80,0.3); transition: all 0.2s; margin-right: 5px;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                                    💰 Satış Yap
                                                </button>
                                                <button class="btn btn-sm btn-danger" onclick="deleteProductFromPage('${product.id}')" style="padding: 8px 16px; border-radius: 10px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 6px rgba(244,67,54,0.3); transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                                    🗑️ Sil
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // Satış geçmişini yükle
                await loadProductSalesHistory(container);
                
            } catch (error) {
                console.error('Ürünler yüklenirken hata:', error);
                container.innerHTML = '<div class="empty-state"><p style="color: #f44336;">❌ Ürünler yüklenirken bir hata oluştu</p></div>';
            }
        };
        
        // Ürün sil (products sayfasından)
        // ✅ SUPABASE: Ürün sil (Ürünler sayfasından)
        window.deleteProductFromPage = async function(productId) {
            if (!confirm('Bu ürünü silmek istediğinize emin misiniz?')) return;
            
            try {
                const { error} = await supabase
                    .from('products')
                    .delete()
                    .eq('id', productId);
                
                if (error) throw error;
                
                showAlert('✅ Ürün silindi', 'success');
                
                // Açık sayfaya göre yenile
                if (currentSection === 'accounting-summary') {
                    renderAccountingSummary();
                } else if (currentSection === 'products') {
                    renderProductsPage();
                }
            } catch (error) {
                console.error('Ürün silinirken hata:', error);
                showAlert('❌ Ürün silinirken bir hata oluştu', 'danger');
            }
        };
        
        // 💰 ÜRÜN SATIŞI FUNCTIONS
        // ============================================
        
        // Ürün satış modalını aç
        window.openProductSaleModal = function(productId, productName, productPrice, productStock) {
            if (productStock <= 0) {
                showAlert('⚠️ Bu üründe stok bulunmuyor!', 'warning');
                return;
            }
            
            // Ürün bilgilerini hidden inputlara kaydet
            document.getElementById('saleProductId').value = productId;
            document.getElementById('saleProductPrice').value = productPrice;
            document.getElementById('saleProductStock').value = productStock;
            
            // Ürün bilgilerini göster
            document.getElementById('saleModalTitle').textContent = `Ürün Satışı - ${productName}`;
            document.getElementById('saleProductInfo').innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span><strong>Ürün:</strong> ${productName}</span>
                    <span><strong>Fiyat:</strong> ${productPrice} ₺</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span><strong>Mevcut Stok:</strong> ${productStock}</span>
                </div>
            `;
            
            // Branş seçeneklerini doldur
            const branchSelect = document.getElementById('saleBranch');
            if (branchSelect) {
                branchSelect.innerHTML = '<option value="">Seçiniz...</option>';
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.name;
                    option.textContent = `${branch.icon || '🏢'} ${branch.name}`;
                    branchSelect.appendChild(option);
                });
            }
            
            // Form alanlarını ayarla
            document.getElementById('saleQuantity').value = 1;
            document.getElementById('saleQuantity').max = productStock;
            document.getElementById('saleUnitPrice').value = productPrice;
            document.getElementById('saleCustomer').value = '';
            document.getElementById('saleNote').value = '';
            
            // Toplam tutarı hesapla
            calculateSaleTotal();
            
            // Modal'ı aç
            openModal('productSaleModal');
        };
        
        // Ürün satış form submit handler
        window.handleProductSaleFormSubmit = async function(event) {
            event.preventDefault();
            
            const productId = document.getElementById('saleProductId').value;
            const currentStock = parseInt(document.getElementById('saleProductStock').value);
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            const unitPrice = parseFloat(document.getElementById('saleUnitPrice').value);
            const totalAmount = parseFloat(document.getElementById('saleTotalAmount').value);
            const branch = document.getElementById('saleBranch').value;
            const customer = document.getElementById('saleCustomer').value;
            const note = document.getElementById('saleNote').value;
            
            if (quantity > currentStock) {
                showAlert('❌ Satış miktarı stok miktarından fazla olamaz!', 'danger');
                return;
            }
            
            // Modal'ı kapat
            closeModal('productSaleModal');
            
            // Satışı kaydet
            await saveProductSale(productId, currentStock, quantity, unitPrice, totalAmount, branch, customer, note);
        };
        
        // Satış toplamını hesapla
        window.calculateSaleTotal = function() {
            const quantity = parseInt(document.getElementById('saleQuantity').value) || 0;
            const unitPrice = parseFloat(document.getElementById('saleUnitPrice').value) || 0;
            const total = quantity * unitPrice;
            document.getElementById('saleTotalAmount').value = total.toFixed(2);
        };
        
        // Ürün satışını kaydet
        async function saveProductSale(productId, currentStock, quantity, unitPrice, totalAmount, branch, customer, note) {
            try {
                // Ürün adını modal başlığından al
                const productName = document.getElementById('saleModalTitle').textContent.replace('Ürün Satışı - ', '');
                
                // Satış kaydını oluştur (id'yi Supabase otomatik oluşturacak)
                const saleData = {
                    clubId: currentClubId,
                    productId: productId,
                    productName: productName,
                    quantity: quantity,
                    unitPrice: unitPrice,
                    totalAmount: totalAmount,
                    branch: branch,
                    customer: customer || null,
                    note: note || null,
                    saleDate: new Date().toISOString(),
                    createdBy: currentUser?.fullName || currentUser?.email || 'Admin',
                    createdAt: new Date().toISOString()
                };
                
                // productSales koleksiyonuna ekle (Supabase)
                const { error: saleError } = await supabaseClient
                    .from('productSales')
                    .insert([saleData]);
                
                if (saleError) throw saleError;
                
                // Ürün stokunu güncelle (Supabase)
                const { error: updateError } = await supabaseClient
                    .from('products')
                    .update({
                        stock: currentStock - quantity,
                        lastSaleDate: new Date().toISOString()
                    })
                    .eq('id', productId);
                
                if (updateError) throw updateError;
                
                showAlert('✅ Satış başarıyla kaydedildi ve stok güncellendi', 'success');
                
                // Sayfayı yenile
                if (currentSection === 'products') {
                    renderProductsPage();
                } else if (currentSection === 'accounting-summary') {
                    renderAccountingSummary();
                }
            } catch (error) {
                console.error('Satış kaydedilirken hata:', error);
                showAlert('❌ Satış kaydedilirken bir hata oluştu', 'danger');
            }
        }
        
        // Ürün satışını sil
        window.deleteProductSale = async function(saleId, productId, quantity) {
            if (!confirm('Bu satış kaydını silmek istediğinizden emin misiniz?\n\nStok miktarı geri yüklenecektir.')) {
                return;
            }
            
            try {
                // Satış kaydını sil
                const { error: deleteError } = await supabaseClient
                    .from('productSales')
                    .delete()
                    .eq('id', saleId);
                
                if (deleteError) throw deleteError;
                
                // Ürünün stok miktarını geri yükle
                const { data: product } = await supabaseClient
                    .from('products')
                    .select('stock')
                    .eq('id', productId)
                    .single();
                
                if (product) {
                    await supabaseClient
                        .from('products')
                        .update({ stock: product.stock + quantity })
                        .eq('id', productId);
                }
                
                showAlert('✅ Satış kaydı silindi ve stok geri yüklendi', 'success');
                
                // Sayfayı yenile
                if (currentSection === 'products') {
                    renderProductsPage();
                } else if (currentSection === 'accounting-summary') {
                    renderAccountingSummary();
                }
            } catch (error) {
                console.error('Satış silinirken hata:', error);
                showAlert('❌ Satış silinirken bir hata oluştu', 'danger');
            }
        };
        
        // Ürün satış geçmişini yükle
        window.loadProductSalesHistory = async function(container) {
            try {
                const { data: sales, error } = await supabaseClient
                    .from('productSales')
                    .select('*')
                    .eq('clubId', currentClubId)
                    .order('saleDate', { ascending: false });
                
                if (error) throw error;
                
                const salesList = sales || [];
                
                if (salesList.length === 0) {
                    container.innerHTML += `
                        <div style="margin-top: 40px; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 6px 20px rgba(0,0,0,0.08);">
                            <h3 style="margin: 0 0 15px 0; color: #333;">📊 Satış Geçmişi</h3>
                            <div class="empty-state"><p>Henüz satış kaydı bulunmuyor.</p></div>
                        </div>
                    `;
                    return;
                }
                
                // Satış istatistikleri
                const totalSalesAmount = salesList.reduce((sum, sale) => sum + (sale.totalAmount || 0), 0);
                const totalItemsSold = salesList.reduce((sum, sale) => sum + (sale.quantity || 0), 0);
                
                container.innerHTML += `
                    <div style="margin-top: 40px;">
                        <!-- Satış İstatistikleri -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                            <div style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">💰 Toplam Satış</div>
                                <div style="font-size: 28px; font-weight: bold;">${formatPrice(totalSalesAmount)}</div>
                                <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">${salesList.length} satış</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">📦 Satılan Ürün</div>
                                <div style="font-size: 28px; font-weight: bold;">${totalItemsSold}</div>
                                <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Adet</div>
                            </div>
                        </div>
                        
                        <!-- Satış Geçmişi Tablosu -->
                        <div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 6px 20px rgba(0,0,0,0.08);">
                            <h3 style="margin: 0 0 25px 0; color: #333; display: flex; align-items: center; gap: 12px; font-size: 22px; font-weight: 700;">
                                <span style="font-size: 32px;">📊</span>
                                Satış Geçmişi
                            </h3>
                            <div style="overflow-x: auto; border-radius: 12px; border: 1px solid #e0e0e0;">
                                <table style="width: 100%; border-collapse: collapse; background: white;">
                                    <thead>
                                        <tr style="background: linear-gradient(135deg, #f5f5f5 0%, #e9e9e9 100%);">
                                            <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">📅 Tarih</th>
                                            <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">🏷️ Ürün</th>
                                            <th style="padding: 16px 20px; text-align: center; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">📦 Miktar</th>
                                            <th style="padding: 16px 20px; text-align: right; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">💵 Birim Fiyat</th>
                                            <th style="padding: 16px 20px; text-align: right; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">💰 Toplam</th>
                                            <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">🏢 Branş</th>
                                            <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">👤 Müşteri</th>
                                            <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">👤 Satış Yapan</th>
                                            <th style="padding: 16px 20px; text-align: center; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">⚙️ İşlemler</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${salesList.map((sale, index) => `
                                            <tr style="transition: all 0.2s; background: ${index % 2 === 0 ? 'white' : '#fafafa'};" onmouseover="this.style.background='#f0fff4'" onmouseout="this.style.background='${index % 2 === 0 ? 'white' : '#fafafa'}'">
                                                <td style="padding: 18px 20px; white-space: nowrap; font-size: 14px; color: #666; border-bottom: 1px solid #f0f0f0;">${new Date(sale.saleDate).toLocaleDateString('tr-TR')}</td>
                                                <td style="padding: 18px 20px; font-weight: 600; font-size: 14px; color: #333; border-bottom: 1px solid #f0f0f0;">${sale.productName}</td>
                                                <td style="padding: 18px 20px; text-align: center; border-bottom: 1px solid #f0f0f0;"><span style="background: #2196f3; color: white; padding: 6px 12px; border-radius: 15px; font-weight: 600;">${sale.quantity}</span></td>
                                                <td style="padding: 18px 20px; text-align: right; font-size: 14px; color: #666; border-bottom: 1px solid #f0f0f0;">${formatPrice(sale.unitPrice)}</td>
                                                <td style="padding: 18px 20px; text-align: right; font-weight: 700; color: #4caf50; font-size: 16px; border-bottom: 1px solid #f0f0f0;">${formatPrice(sale.totalAmount)}</td>
                                                <td style="padding: 18px 20px; border-bottom: 1px solid #f0f0f0;"><span style="background: #ff9800; color: white; padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: 600;">${sale.branch || '-'}</span></td>
                                                <td style="padding: 18px 20px; font-size: 13px; color: #666; border-bottom: 1px solid #f0f0f0;">${sale.customer || '-'}</td>
                                                <td style="padding: 18px 20px; font-size: 13px; color: #888; border-bottom: 1px solid #f0f0f0;">${sale.createdBy || '-'}</td>
                                                <td style="padding: 18px 20px; text-align: center; border-bottom: 1px solid #f0f0f0;">
                                                    <button class="btn btn-sm btn-danger" onclick="deleteProductSale('${sale.id}', '${sale.productId}', ${sale.quantity})" style="padding: 8px 16px; border-radius: 10px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 6px rgba(244,67,54,0.3); transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                                        🗑️ Sil
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Satış geçmişi yüklenirken hata:', error);
            }
        };


    </script>
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
            --border-color: #dee2e6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        
        /* Checkbox'ları varsayılan olarak gizle */
        .incoming-call-checkbox,
        .outgoing-call-checkbox {
            display: none;
        }
        
        .incoming-call-checkbox:checked,
        .outgoing-call-checkbox:checked {
            display: block;
        }

        #password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #password-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            width: 90%;
            max-width: 400px;
        }

        #password-box h2 {
            margin-bottom: 20px;
            color: var(--dark-color);
        }

        #password-box .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        #password-error {
            color: var(--danger-color);
            margin-top: 10px;
            display: none;
        }

        #main-wrapper {
            display: none; /* Initially hidden */
        }

        .current-user-display {
            color: rgba(255,255,255,0.9);
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
            text-align: center;
            word-break: break-word;
        }


        /* ✅ Sidebar Navigation Styles */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: width 0.3s ease;
        }
        
        /* Collapsed durumda sidebar dar görünür */
        .sidebar.collapsed {
            width: 70px;
        }
        
        /* Collapsed durumda yazılar ve dropdown'lar gizlenir */
        .sidebar.collapsed .nav-text,
        .sidebar.collapsed .dropdown-arrow,
        .sidebar.collapsed .sidebar-header h2 {
            display: none;
        }
        
        .sidebar.collapsed .dropdown-content {
            display: none !important;
        }
        
        .sidebar.collapsed #whatsapp-balance-container {
            padding: 4px !important;
            gap: 0 !important;
            font-size: 10px !important;
            min-width: 0 !important;
            max-width: 70px !important;
            flex-direction: column !important;
            overflow: hidden !important;
        }
        
        .sidebar.collapsed #whatsapp-balance-container span:not(#whatsapp-balance) {
            display: none !important;
        }
        
        .sidebar.collapsed .nav-btn {
            justify-content: center;
            padding: 12px;
        }
        
        .sidebar.collapsed .nav-icon {
            font-size: 20px;
            margin: 0;
        }
        
        .sidebar.collapsed .sidebar-header {
            padding: 15px 10px;
            text-align: center;
        }
        
        .sidebar.collapsed .sidebar-header button {
            margin: 0 auto;
        }
        
        .sidebar.collapsed .sidebar-footer {
            padding: 10px 5px;
        }
        
        .sidebar.collapsed .current-user-display {
            display: none;
        }
        
        .sidebar.collapsed #logout-btn-sidebar {
            font-size: 18px;
            padding: 8px 5px !important;
        }
        
        .sidebar.collapsed #logout-btn-sidebar:before {
            content: "🚪";
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .sidebar-header h2 {
            color: white;
            font-size: 18px;
            margin: 0;
            font-weight: 600;
        }

        .sidebar-menu {
            flex: 1;
            padding: 15px 0;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .sidebar-menu::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar-menu::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
        }
        
        .sidebar-menu::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }

        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.3);
            flex-shrink: 0;
        }

        .sidebar .nav-btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 3px solid transparent;
        }

        .sidebar .nav-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
            border-left-color: var(--primary-color);
        }

        .sidebar .nav-btn.active {
            background: rgba(102, 126, 234, 0.2);
            color: white;
            border-left-color: var(--primary-color);
            font-weight: 600;
        }

        .sidebar .nav-icon {
            font-size: 18px;
            min-width: 24px;
        }

        .sidebar .nav-text {
            flex: 1;
            font-size: 14px;
        }

        /* Dropdown Menu */
        .nav-dropdown {
            position: relative;
        }

        .dropdown-toggle {
            position: relative;
        }

        .dropdown-arrow {
            font-size: 10px;
            transition: transform 0.3s ease;
        }

        .dropdown-toggle.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            background: rgba(0,0,0,0.3);
            display: block;
            margin: 4px 0;
            border-radius: 8px;
            padding: 0;
        }

        .dropdown-content.show {
            max-height: 1000px !important;
            overflow: visible !important;
            padding: 8px 0 !important;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.2);
        }

        .sidebar .nav-btn.sub-item {
            padding: 12px 16px 12px 56px;
            font-size: 14px;
            border-left: 3px solid transparent;
            margin: 2px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .sidebar .nav-btn.sub-item:hover {
            background: rgba(255,255,255,0.2);
            border-left-color: rgba(255,255,255,0.4);
            transform: translateX(2px);
        }
        
        .sidebar .nav-btn.sub-sub-item {
            padding: 10px 16px 10px 76px;
            font-size: 13px;
            border-left: 3px solid transparent;
            margin: 2px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .sidebar .nav-btn.sub-sub-item:hover {
            background: rgba(255,255,255,0.25);
            border-left-color: rgba(255,255,255,0.5);
            transform: translateX(2px);
        }
        
        .nav-dropdown.sub-dropdown {
            margin-left: 0;
            margin: 4px 8px;
        }
        
        .nav-dropdown.sub-dropdown .dropdown-toggle {
            padding: 10px 16px 10px 56px;
            font-size: 14px;
        }
        
        .nav-dropdown.sub-dropdown .dropdown-content {
            background: rgba(0,0,0,0.4);
            margin: 4px 0 4px 8px;
            border-radius: 6px;
        }
        
        .nav-dropdown.sub-dropdown .dropdown-content.show {
            padding: 6px 0 !important;
        }

        /* Main Content Wrapper */
        .main-content-wrapper {
            flex: 1;
            margin-left: 260px;
            width: calc(100% - 260px);
            min-height: 100vh;
            background: #f5f5f5;
            transition: margin-left 0.3s ease, width 0.3s ease;
        }
        
        .sidebar.collapsed ~ .main-content-wrapper {
            margin-left: 70px;
            width: calc(100% - 70px);
        }
        
        .admin-content {
            padding: 30px;
            width: 100%;
            max-width: 100%;
            margin: 0;
        }

        .section { display: none; }
        .section.active { display: block; }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
        }
        .card > h3.card-subtitle {
            font-size: 1.2em;
            color: var(--dark-color);
            margin-top: 25px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .settings-subsection {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
        
        .settings-subtitle {
            font-size: 1.1em;
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .settings-tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 25px;
        }
        
        .settings-tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            margin-bottom: -2px;
        }
        
        .settings-tab:hover:not(:disabled) {
            color: var(--primary-color);
            background: rgba(255, 149, 0, 0.05);
        }
        
        .settings-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }
        
        .settings-tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .settings-tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .whatsapp-device-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: box-shadow 0.2s;
        }
        
        .whatsapp-device-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .device-info h4 {
            margin: 0 0 10px 0;
            color: var(--dark-color);
        }
        
        .device-info p {
            margin: 5px 0;
        }
        
        .device-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .card-title {
            font-size: 1.4em;
            color: var(--dark-color);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .permissions-group {
             display: flex;
             flex-wrap: wrap;
             gap: 15px;
             background: #f8f9fa;
             padding: 15px;
             border-radius: 8px;
             grid-column: 1 / -1; /* Span full width */
        }
        .permissions-group label {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .form-group label {
            font-weight: 600;
            color: var(--dark-color);
        }

        .form-control {
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .search-input {
            padding: 8px 15px;
            border: 2px solid var(--border-color);
            border-radius: 25px;
            width: 100%;
            max-width: 250px;
            font-size: 0.9em;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            padding: 5px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            transition: background-color 0.2s;
        }
        .btn-icon:hover {
            background-color: #e9ecef;
        }
        .btn-icon.danger:hover {
            background-color: #f8d7da;
            color: var(--danger-color);
        }

        .btn:disabled {
            background-color: #ccc !important;
            box-shadow: none;
            transform: none;
            cursor: not-allowed;
        }
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8em;
        }

        .btn-primary { background: var(--primary-color); color: white; }
        .btn-success { background: var(--success-color); color: white; }
        .btn-warning { background: var(--warning-color); color: #212529; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-info { background: var(--info-color); color: white; }
        .btn-secondary { background: #6c757d; color: white; }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-group .btn.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .btn-group .btn-secondary.active {
            background-color: var(--primary-color) !important;
            color: white !important;
        }

        .table-container {
            overflow: auto;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }
        
        .data-table tbody tr {
            transition: background-color 0.2s;
        }

        .data-table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .data-table tbody tr:hover {
            background: #f8f9ff;
        }
        
        .editable-row:hover {
            cursor: pointer;
            background-color: #f1f3f5 !important;
        }
        .editable-date {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .editable-date .btn-icon {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .data-table tbody tr:hover .editable-date .btn-icon {
            opacity: 1;
        }
        
        td.editable-reason {
            cursor: pointer;
            text-decoration: underline dotted;
        }
        td.editable-reason:hover {
            background-color: #f8f9fa;
        }
        .table-container {
            overflow-x: auto;
            overflow-y: visible;
        }
        
        .actions-cell {
            white-space: nowrap;
            position: relative;
        }
        .actions-cell .btn {
            margin-right: 5px;
        }
        
        /* Dropdown Menu Styles */
        .actions-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .actions-dropdown-btn {
            background: #4f46e5;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        
        .actions-dropdown-btn:hover {
            background: #4338ca;
        }
        
        .actions-dropdown-content {
            display: none;
            position: fixed;
            background: white;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 8px;
            z-index: 10000;
            margin-top: 5px;
            overflow: visible;
            border: 1px solid #e5e7eb;
        }
        
        .actions-dropdown.active .actions-dropdown-content {
            display: block;
        }
        
        .actions-dropdown-content button {
            width: 100%;
            padding: 10px 15px;
            border: none;
            background: white;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #374151;
        }
        
        .actions-dropdown-content button:hover {
            background: #f3f4f6;
        }
        
        .actions-dropdown-content button:not(:last-child) {
            border-bottom: 1px solid #f3f4f6;
        }
        
        .actions-dropdown-content button.danger {
            color: #dc2626;
        }
        
        .actions-dropdown-content button.danger:hover {
            background: #fee2e2;
        }


        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: none;
            cursor: pointer;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-active { background: #d4edda; color: #155724; }
        .status-expired { background: #f8d7da; color: #721c24; }
        .status-paid { background: #d1ecf1; color: #0c5460; }
        .status-unpaid { background: #f5c6cb; color: #721c24; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-overdue { background: #f8d7da; color: #721c24; }
        .status-present { background: #d4edda; color: #155724; }
        .status-absent { background: #f8d7da; color: #721c24; }

        .modal {
            display: none;
            position: fixed;
            z-index: 99999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            overflow-y: auto; /* ✅ Scroll ekle */
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh; /* ✅ Maksimum yükseklik */
            overflow-y: auto; /* ✅ İçerik overflow olursa scroll */
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }
        
        /* Member Edit Modal Specific Styles */
        .member-edit-modal {
            max-width: 900px;
        }
        
        .modal-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .modal-header h2 {
            margin: 0;
            color: var(--dark-color);
            font-size: 1.8em;
        }
        
        .form-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        
        .form-section:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-color: var(--primary-color);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .section-icon {
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section-title {
            margin: 0;
            font-size: 1.2em;
            color: var(--dark-color);
            font-weight: 600;
            flex: 1;
        }
        
        .required-badge {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .optional-badge {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #666;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .required-star {
            color: var(--danger-color);
            font-weight: bold;
            margin-left: 2px;
        }
        
        .form-text {
            display: block;
            margin-top: 5px;
            font-size: 0.85em;
            color: #6c757d;
            font-style: italic;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }
        
        .modal-footer .btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            font-size: 1em;
            font-weight: 600;
        }
        
        .modal-footer .btn span {
            font-size: 1.2em;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInBounce {
            0% { 
                opacity: 0; 
                transform: translateX(100%) scale(0.8); 
            }
            60% { 
                opacity: 1; 
                transform: translateX(-10px) scale(1.05); 
            }
            100% { 
                opacity: 1; 
                transform: translateX(0) scale(1); 
            }
        }
        
        @keyframes fadeOutRight {
            from { 
                opacity: 1; 
                transform: translateX(0) scale(1); 
            }
            to { 
                opacity: 0; 
                transform: translateX(50px) scale(0.9); 
            }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover { color: var(--danger-color); }

        /* Tab Styles */
        .customer-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin: 20px 0;
            gap: 5px;
        }
        
        .tab-button {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tab-button:hover {
            color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }
        
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .branch-tab-content {
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .branch-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .branch-info-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
        
        .branch-info-item strong {
            font-size: 11px;
            color: #666;
            display: block;
            margin-bottom: 5px;
        }
        
        .branch-info-item span {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        /* Modern Schedule Styles */
        #unassigned-groups-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            background: var(--light-color);
            border-radius: 10px;
            margin-bottom: 20px;
            min-height: 40px;
        }
        .unassigned-group {
            background: white;
            padding: 5px 12px;
            border-radius: 20px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-weight: 500;
            font-size: 0.9em;
        }
        .unassigned-group:active { cursor: grabbing; }
        
        .schedule-row {
            display: grid;
            gap: 10px;
            margin-top: 10px;
        }
        .schedule-row:first-child {
            margin-top: 0;
        }
        .schedule-row.weekday-row {
             grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }
        .schedule-row.weekend-row {
             grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }

        .schedule-day {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            min-height: 200px;
            transition: background-color 0.2s;
        }
        .schedule-day.drag-over {
             background-color: #e9eefe;
        }
        .schedule-day.is-holiday {
            background-color: #f1f3f5;
            opacity: 0.7;
        }

        .schedule-day h4 {
            text-align: center;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .lesson-block {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 8px 10px;
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 0.85em;
            position: relative;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .lesson-block.trial-lesson {
            background: linear-gradient(135deg, var(--info-color), #148a9b);
        }
        
        .delete-lesson-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: background 0.2s, opacity 0.2s;
            opacity: 0;
        }
        .lesson-block:hover .delete-lesson-btn {
            opacity: 1;
        }
        .delete-lesson-btn:hover {
            background: var(--danger-color);
        }
        .lesson-block.empty-slot .delete-lesson-btn {
            opacity: 1;
            background: rgba(0,0,0,0.1);
        }
        .lesson-block.empty-slot .delete-lesson-btn:hover {
             background: rgba(0,0,0,0.2);
        }

        .lesson-block.empty-slot {
            background: #fffbe6;
            color: #856404;
            border: 1px dashed #ffeeba;
            justify-content: center;
            align-items: center;
            display: flex;
            flex-direction: column;
            cursor: default;
        }
         .lesson-block.empty-slot:hover {
            background: #fff9d7;
        }


        .time-editor {
            font-size: 0.9em;
            cursor: pointer;
        }
        .time-editor input {
            width: 70px;
        }
        .time-editor button {
            padding: 2px 5px;
            font-size: 0.8em;
        }

        #member-tooltip {
            display: none;
            position: absolute;
            background: var(--dark-color);
            color: white;
            padding: 10px;
            border-radius: 8px;
            z-index: 1001;
            pointer-events: none;
            font-size: 0.9em;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #member-tooltip ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        /* Modern Payment List */
        .payment-member-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .payment-member-item {
            background: white;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .payment-member-header {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--light-color);
        }
        .payment-member-header:hover {
            background: #e9ecef;
        }
        .payment-member-info {
            flex-grow: 1;
            cursor: pointer;
        }
        .status-container {
            cursor: pointer;
        }
        .payment-details {
            padding: 20px;
            display: none; /* Collapsed by default */
        }
        .payment-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .payment-details .data-table {
            box-shadow: none;
            border-radius: 0;
        }
        .status-container {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            flex-shrink: 0;
        }
        .sub-status {
            font-size: 0.8em;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }
        .sub-status.pending {
            background-color: var(--warning-color);
            color: #333;
        }
        .sub-status.expired {
            background: #f8d7da;
            color: #721c24;
        }
        .sub-status.group-name {
            background-color: #e9ecef;
            color: #495057;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-top: 4px solid var(--primary-color);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1.1em;
        }

        .stat-comparison {
            font-size: 0.9em;
            font-weight: bold;
        }
        .stat-comparison.increase { color: var(--success-color); }
        .stat-comparison.decrease { color: var(--danger-color); }
        
        #groupsList {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        #groupsList h2.group-category-title {
            font-size: 1.5em;
            color: var(--primary-color);
            margin-top: 20px;
            margin-bottom: 0px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--border-color);
        }
         #groupsList h2.group-category-title:first-of-type {
            margin-top: 0;
        }

        .group-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            border-left: 5px solid var(--primary-color);
            display: flex;
            flex-direction: column;
            transition: all 0.2s ease-in-out;
        }
        .group-card.group-card-trial {
            border-left-color: var(--info-color);
        }
        .group-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .group-card h4 {
            font-size: 1.1em;
            margin-bottom: 8px;
        }
        .group-card p {
            font-size: 0.9em;
            margin-bottom: 5px;
            color: #555;
        }
        .group-members {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
            flex-grow: 1;
        }

        .member-tag {
            background: var(--light-color);
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.85em;
            border: 1px solid var(--border-color);
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .group-card-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            gap: 10px;
        }
        
        .qr-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            gap: 15px;
            text-align: center;
        }
        
        .qr-loading .spinner {
            width: 40px;
            height: 40px;
            border-width: 4px;
        }
        
        .qr-loading p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: #666;
            width: 100%;
        }

        .empty-state h3 {
            margin-bottom: 8px;
            color: var(--primary-color);
            font-size: 16px;
        }
        
        .empty-state p {
            font-size: 13px;
        }

        /* CRM Tags Styles */
        .tags-category-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 50px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .tag-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: white;
            border-radius: 16px;
            border: 1.5px solid #e0e0e0;
            font-size: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .tag-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border-color: var(--primary-color);
        }

        .tag-item .tag-name {
            font-weight: 500;
        }

        .tag-item .tag-count {
            background: rgba(0,0,0,0.05);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
        }

        .tag-item .tag-actions {
            display: flex;
            gap: 4px;
            margin-left: 4px;
        }

        .tag-item .tag-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 13px;
            padding: 2px 4px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .tag-item .tag-actions button:hover {
            opacity: 1;
        }

        .tag-item.status-tag {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%);
        }

        .tag-item.branch-tag {
            border-color: #f093fb;
            background: linear-gradient(135deg, rgba(240, 147, 251, 0.1) 0%, rgba(245, 87, 108, 0.05) 100%);
        }

        .tag-item.custom-tag {
            border-color: #43e97b;
            background: linear-gradient(135deg, rgba(67, 233, 123, 0.1) 0%, rgba(56, 249, 215, 0.05) 100%);
        }

        /* Filtered Customer Item */
        .filtered-customer-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .filtered-customer-item:hover {
            transform: translateX(3px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border-color: var(--primary-color);
        }

        .filtered-customer-item .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .filtered-customer-item .customer-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .filtered-customer-item .customer-status {
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .filtered-customer-item .customer-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 8px;
            margin-top: 8px;
            font-size: 13px;
        }

        .filtered-customer-item .customer-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }

        .filtered-customer-item .customer-tag {
            padding: 2px 8px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            font-size: 10px;
            color: #667eea;
        }

        /* Trial Item */
        .trial-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
            border-left: 3px solid #667eea;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .trial-item:hover {
            transform: translateX(3px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        .trial-item.scheduled {
            border-left-color: #4facfe;
        }

        .trial-item.completed {
            border-left-color: #43e97b;
        }

        .trial-item.cancelled {
            border-left-color: #f5576c;
            opacity: 0.7;
        }

        .trial-item.converted {
            border-left-color: #f093fb;
        }

        .trial-item .trial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .trial-item .trial-customer {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .trial-item .trial-status {
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .trial-item .trial-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            font-size: 12px;
            color: #666;
        }

        /* WhatsApp Styles */
        #whatsapp-contacts-list {
            max-height: calc(100vh - 350px);
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 5px;
        }
        
        #whatsapp-contacts-list::-webkit-scrollbar {
            width: 6px;
        }
        
        #whatsapp-contacts-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }
        
        #whatsapp-contacts-list::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 3px;
        }
        
        #whatsapp-contacts-list::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.8);
        }
        
        .whatsapp-contact-item {
            padding: 14px;
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            word-wrap: break-word;
            overflow: hidden;
        }
        
        .whatsapp-contact-item:hover {
            background: rgba(245, 246, 246, 0.95);
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .whatsapp-contact-item.active {
            background: linear-gradient(135deg, rgba(37, 211, 102, 0.15) 0%, rgba(37, 211, 102, 0.05) 100%);
            border-left: 4px solid #25d366;
            box-shadow: 0 2px 12px rgba(37, 211, 102, 0.2);
        }
        
        #whatsapp-messages-area {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            backdrop-filter: blur(10px);
            position: relative;
        }
        
        #whatsapp-messages-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="10" cy="10" r="1" fill="%23ffffff" opacity="0.3"/><circle cx="30" cy="25" r="1" fill="%23ffffff" opacity="0.2"/><circle cx="60" cy="15" r="1" fill="%23ffffff" opacity="0.25"/><circle cx="80" cy="40" r="1" fill="%23ffffff" opacity="0.3"/><circle cx="45" cy="60" r="1" fill="%23ffffff" opacity="0.2"/></svg>');
            opacity: 0.4;
            pointer-events: none;
        }
        
        .whatsapp-message-wrapper {
            display: flex;
            margin-bottom: 8px;
            clear: both;
        }
        
        .whatsapp-message-wrapper.sent {
            justify-content: flex-end;
        }
        
        .whatsapp-message-wrapper.received {
            justify-content: flex-start;
        }
        
        .whatsapp-message {
            max-width: 65%;
            padding: 8px 12px 6px 12px;
            border-radius: 8px;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
            transition: box-shadow 0.2s ease;
        }
        
        .whatsapp-message:hover {
            box-shadow: 0 2px 2px rgba(0,0,0,0.15);
        }
        
        .whatsapp-message.sent {
            background: #D9FDD3;
            border-radius: 8px 8px 0 8px;
        }
        
        .whatsapp-message.received {
            background: #FFFFFF;
            border-radius: 8px 8px 8px 0;
        }
        
        .whatsapp-message .message-content {
            margin-bottom: 2px;
            color: #111;
            font-size: 14.2px;
            line-height: 19px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        
        .whatsapp-message .message-time {
            font-size: 11px;
            color: rgba(0,0,0,0.45);
            text-align: right;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 3px;
        }
        
        .message-check {
            color: #53bdeb;
            font-size: 14px;
        }
        
        .message-date-divider {
            text-align: center;
            margin: 15px auto;
            padding: 6px 12px;
            background: rgba(225, 245, 254, 0.92);
            border-radius: 8px;
            font-size: 12.5px;
            color: #667781;
            display: inline-block;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
            font-weight: 500;
            border-radius: 7.5px;
            font-size: 12.5px;
            color: #54656f;
            position: relative;
            z-index: 1;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
        }
        
        #whatsapp-chat-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        #whatsapp-message-input {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }
        
        #whatsapp-message-text {
            border: 2px solid rgba(100, 100, 100, 0.2);
            border-radius: 24px;
            padding: 12px 18px;
            transition: all 0.3s ease;
        }
        
        #whatsapp-message-text:focus {
            border-color: #25d366;
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
            outline: none;
        }
        
        #whatsapp-message-text {
            border-radius: 21px;
            border: 1px solid #d1d7db;
            padding: 9px 12px;
            font-size: 15px;
        }
        
        .recipient-status-badge {
            float: right;
            margin-top: 5px;
        }
        
        .bulk-recipient-checkbox {
            margin-right: 10px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .actions-container {
            position: relative;
        }
        #context-menu {
            display: none;
            position: fixed;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            z-index: 1001;
            min-width: 200px;
            overflow: hidden;
        }
        #context-menu.active {
            display: block;
        }
        #context-menu a {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            color: var(--dark-color);
            text-decoration: none;
            font-size: 0.9em;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        #context-menu a:hover {
            background-color: #f8f9fa;
        }
        #context-menu a.danger {
            color: var(--danger-color);
        }
        #context-menu a.danger:hover {
            background-color: #fff2f4;
        }

        #phone-context-menu {
            display: none;
            position: fixed;
            z-index: 1002;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        #phone-context-menu button {
            display: block;
            width: 100%;
            padding: 12px 20px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
        }
        #phone-context-menu button:hover {
            background: #f8f9fa;
        }
        
        /* Task Messages Styles */
        .task-message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            max-width: 80%;
        }
        
        .task-message-mine {
            background: var(--primary-color);
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .task-message-other {
            background: white;
            border: 1px solid #e0e0e0;
            margin-right: auto;
        }
        
        .task-message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85em;
        }
        
        .task-message-mine .task-message-header {
            flex-direction: row-reverse;
        }
        
        .task-message-time {
            opacity: 0.7;
            font-size: 0.9em;
        }
        
        .task-message-body {
            word-wrap: break-word;
        }
        
        .task-message-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .task-message-delete:hover {
            background: var(--danger-color);
        }
        
        .task-message {
            position: relative;
        }
        
        .badge {
            background: var(--danger-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            margin-left: 5px;
        }


        .group-selection-list, .group-members-list, .attendance-list {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .group-selection-item {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .group-selection-item:hover {
            background: #f8f9ff;
            border-color: var(--primary-color);
        }
        .member-item, .attendance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--light-color);
            border-radius: 5px;
            gap: 10px;
        }
        .attendance-item label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            flex-grow: 1;
        }
        .reason-input {
            flex-shrink: 1;
            min-width: 150px;
        }

        .holiday-settings-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        .holiday-settings-grid label {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .registration-forms-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }
        .registration-form-wrapper {
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 10px;
        }

        .searchable-select-container {
            position: relative;
        }
        .searchable-select-results {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        .searchable-select-results.active {
            display: block;
        }
        .searchable-select-item {
            padding: 10px 15px;
            cursor: pointer;
        }
        .searchable-select-item:not(.disabled):hover {
            background: #f0f0f0;
        }
        .searchable-select-item.disabled {
            cursor: not-allowed;
            color: #999;
        }

        a.phone-link {
            color: inherit;
            text-decoration: none;
        }
        a.phone-link:hover {
            text-decoration: underline;
        }

        .member-name-link {
            color: var(--dark-color);
            text-decoration: none;
            transition: color 0.2s;
        }
        .member-name-link:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }

        .absence-item, .birthday-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .absence-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .absence-item:hover {
            background-color: var(--light-color);
        }
        .absence-item:last-child, .birthday-item:last-child {
            border-bottom: none;
        }
        .absence-reason {
            color: #555;
            font-size: 0.9em;
            font-style: italic;
        }
        .birthday-icon {
            font-size: 1.5em;
        }
        
        .member-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .detail-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .detail-item strong {
            display: block;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 15px;
        }
        .pagination-controls .btn {
            text-transform: none;
        }
        .pagination-controls .page-info-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .attendance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            padding: 0;
            margin-bottom: 20px;
        }

        .modern-title {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            /* text-fill-color: transparent; */ /* Non-standard, webkit prefix kullan */
            font-weight: 700;
            display: inline-block;
            font-size: 2.2em;
        }

        .member-info-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        @media (min-width: 768px) {
            .member-info-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        .member-info-main, .member-info-contact {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .member-info-contact h4 {
            font-size: 1.1em;
            color: var(--dark-color);
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--primary-color);
        }

        .contact-card {
            background: var(--light-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .contact-card-header {
            background: #e9ecef;
            padding: 8px 12px;
            font-weight: 600;
            font-size: 0.9em;
            color: #495057;
        }
        .contact-card-body {
            padding: 12px;
        }
        .contact-card-body p {
            margin-bottom: 8px;
            font-size: 1em;
        }
        .contact-card-body p:last-child {
            margin-bottom: 0;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 992px) {
            .current-user-display { display: none; }
        }
        
        /* Sidebar Overlay (Mobile) */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }
        
        @media (max-width: 768px) {
            /* Mobilde sidebar tamamen ekranın dışında başlar */
            .sidebar {
                position: fixed;
                left: -260px;
                width: 260px;
                height: 100vh;
                transition: left 0.3s ease, box-shadow 0.3s ease;
                z-index: 1001;
                box-shadow: none;
            }
            
            /* Açık haldeki sidebar - collapsed OLMAYAN */
            .sidebar:not(.collapsed) {
                left: 0;
                width: 260px;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
            }
            
            /* Kapalı haldeki sidebar (ekranın dışında) - collapsed VAR */
            .sidebar.collapsed {
                left: -260px;
                width: 260px;
            }
            
            /* ✅ Mobilde hamburger butonu sabit konumda (her zaman görünür) */
            .sidebar-header > div:first-child > button:first-child {
                position: fixed !important;
                top: 10px !important;
                left: 10px !important;
                z-index: 1002 !important;
                background: var(--primary-color) !important;
                border-radius: 6px !important;
                padding: 8px 12px !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
            }
            
            /* Main content her zaman full width */
            .main-content-wrapper {
                margin-left: 0 !important;
                width: 100% !important;
            }
            
            .sidebar-header h2 {
                font-size: 24px;
            }
            
            /* Mobilde sidebar açıkken elementler görünsün */
            .sidebar:not(.collapsed) .nav-text,
            .sidebar:not(.collapsed) .dropdown-arrow,
            .sidebar:not(.collapsed) .sidebar-header h2 {
                display: block !important;
            }
            
            /* WhatsApp balance mobilde */
            #whatsapp-balance-container {
                flex-wrap: wrap;
                justify-content: center;
                gap: 4px;
                padding: 6px 8px;
            }
            
            .admin-content { 
                padding: 15px;
            }
            
            .form-grid { 
                grid-template-columns: 1fr; 
            }
            
            .modal-content { 
                width: 95%; 
                margin: 10% auto; 
                padding: 20px; 
            }
            
            /* ✅ WhatsApp Mesajlaşma Mobil Düzeltme */
            #whatsapp-messaging-area > div {
                grid-template-columns: 1fr !important;
                height: auto !important;
                max-height: none !important;
            }
            
            #whatsapp-contacts-list {
                max-height: 300px !important;
            }
            
            #whatsapp-messages-area {
                min-height: 400px !important;
                max-height: 500px !important;
            }
            
            /* Member Edit Modal Mobile */
            .member-edit-modal {
                max-width: 100%;
                padding: 15px;
            }
            
            .modal-header h2 {
                font-size: 1.4em;
            }
            
            .form-section {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .section-header {
                flex-wrap: wrap;
            }
            
            .section-icon {
                width: 35px;
                height: 35px;
                font-size: 1.2em;
            }
            
            .section-title {
                font-size: 1em;
            }
            
            .required-badge,
            .optional-badge {
                font-size: 0.65em;
                padding: 3px 10px;
            }
            
            .modal-footer {
                flex-direction: column-reverse;
            }
            
            .modal-footer .btn {
                width: 100%;
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .pagination-controls {
                flex-direction: column;
            }
            
            .card-title {
                flex-direction: column;
                gap: 10px;
            }
            
            /* ✅ CRM Mobil Uyumluluk - Geliştirilmiş */
            .crm-grid {
                grid-template-columns: 1fr !important;
            }
            
            .crm-tabs {
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                margin-bottom: 15px;
            }
            
            .crm-tab-button {
                font-size: 12px !important;
                padding: 8px 12px !important;
            }
            
            .crm-card {
                margin-bottom: 15px;
            }
            
            .crm-card-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .crm-card-actions button {
                width: 100%;
            }
            
            /* 📱 Tablo -> Kart Görünümü (TÜM TABLOLAR) */
            .data-table,
            #crm-leads-list table,
            #member-payment-list table,
            table.data-table {
                display: block !important;
                overflow-x: visible !important;
            }
            
            .data-table thead,
            #crm-leads-list thead,
            #member-payment-list thead,
            table.data-table thead {
                display: block !important;
            }
            
            .data-table thead tr,
            #crm-leads-list thead tr,
            #member-payment-list thead tr,
            table.data-table thead tr {
                position: absolute !important;
                top: -9999px !important;
                left: -9999px !important;
            }
            
            .data-table tbody,
            #crm-leads-list tbody,
            #member-payment-list tbody,
            table.data-table tbody {
                display: block !important;
            }
            
            .data-table tr,
            #crm-leads-list tr,
            #member-payment-list tr,
            table.data-table tr {
                display: block !important;
                border: 1px solid #ddd !important;
                margin-bottom: 15px !important;
                border-radius: 8px !important;
                background: white !important;
                padding: 15px !important;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            }
            
            .data-table td,
            #crm-leads-list td,
            #member-payment-list td,
            table.data-table td {
                display: block !important;
                border: none !important;
                position: relative !important;
                padding: 8px 0 !important;
                padding-left: 45% !important;
                text-align: left !important;
                word-wrap: break-word !important;
            }
            
            .data-table td:before,
            #crm-leads-list td:before,
            #member-payment-list td:before,
            table.data-table td:before {
                content: attr(data-label) !important;
                position: absolute !important;
                left: 10px !important;
                width: 40% !important;
                padding-right: 10px !important;
                white-space: nowrap !important;
                font-weight: 600 !important;
                color: #666 !important;
                font-size: 12px !important;
            }
            
            /* CRM Leads özel etiketleri */
            #crm-leads-list td:nth-of-type(1):before { content: "Ad Soyad:" !important; }
            #crm-leads-list td:nth-of-type(2):before { content: "Telefon:" !important; }
            #crm-leads-list td:nth-of-type(3):before { content: "Branş:" !important; }
            #crm-leads-list td:nth-of-type(4):before { content: "Durum:" !important; }
            #crm-leads-list td:nth-of-type(5):before { content: "Kaynak:" !important; }
            #crm-leads-list td:nth-of-type(6):before { content: "Deneme:" !important; }
            #crm-leads-list td:nth-of-type(7):before { content: "Oluşturma:" !important; }
            #crm-leads-list td:nth-of-type(8):before { content: "İşlemler:" !important; }
            
            /* Son sütun (İşlemler) özel stil */
            .data-table td:last-child,
            #crm-leads-list td:last-child,
            table.data-table td:last-child {
                padding-left: 10px !important;
                display: flex !important;
                gap: 5px !important;
                flex-wrap: wrap !important;
                margin-top: 10px !important;
                padding-top: 10px !important;
                border-top: 1px solid #eee !important;
            }
            
            .data-table td:last-child button,
            #crm-leads-list td:last-child button,
            table.data-table td:last-child button {
                flex: 1 1 auto !important;
                min-width: 80px !important;
            }
            
            .data-table td:last-child:before,
            #crm-leads-list td:last-child:before,
            table.data-table td:last-child:before {
                display: none !important;
            }
            
            /* Checkbox ve radio hücreler */
            .data-table td:first-child:has(input[type="checkbox"]),
            table.data-table td:first-child:has(input[type="checkbox"]) {
                padding-left: 10px !important;
            }
            
            .data-table td:first-child:has(input[type="checkbox"]):before,
            table.data-table td:first-child:has(input[type="checkbox"]):before {
                display: none !important;
            }
            
            /* 📱 CRM Dashboard Stats Grid */
            #crm-dashboard .stats-grid,
            #branch-tag-stats {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            .stat-card {
                padding: 15px !important;
            }
            
            .stat-number {
                font-size: 24px !important;
            }
            
            .stat-label {
                font-size: 13px !important;
            }
            
            /* 📱 CRM Filtreler Mobil */
            #crm-filter .form-grid,
            .filter-controls {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            #crm-filter select,
            #crm-filter input {
                font-size: 14px !important;
            }
            
            /* 📱 CRM Modal Detay Sayfası */
            #customer-detail-content {
                padding: 10px !important;
            }
            
            .customer-detail-header {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .customer-detail-tabs {
                overflow-x: auto !important;
                white-space: nowrap !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            .customer-detail-tabs button {
                font-size: 12px !important;
                padding: 8px 12px !important;
            }
            
            /* 📱 CRM Notlar ve Geçmiş */
            .note-item,
            .history-item {
                padding: 10px !important;
                font-size: 13px !important;
            }
            
            /* 📱 CRM Etiket Yönetimi */
            .tag-badge {
                font-size: 11px !important;
                padding: 4px 8px !important;
            }
            
            /* Gelen/Giden Aramalar Grid */
            div[style*="grid-template-columns: repeat(auto-fill"] {
                grid-template-columns: 1fr !important;
            }
            
            /* 📱 Gelen Aramalar Kart Görünümü */
            .call-card {
                padding: 12px !important;
                margin-bottom: 10px !important;
            }
            
            .call-card-header {
                flex-direction: column !important;
                gap: 5px !important;
                align-items: flex-start !important;
            }
            
            .call-card-actions {
                display: flex !important;
                flex-direction: column !important;
                gap: 5px !important;
                width: 100% !important;
                margin-top: 10px !important;
            }
            
            .call-card-actions button {
                width: 100% !important;
                font-size: 12px !important;
            }
            
            /* 📱 Arama Sekmeleri */
            .incoming-calls-tabs {
                overflow-x: auto !important;
                white-space: nowrap !important;
                -webkit-overflow-scrolling: touch !important;
                padding-bottom: 5px !important;
            }
            
            .incoming-calls-tabs button {
                font-size: 11px !important;
                padding: 8px 10px !important;
                min-width: auto !important;
            }
            
            /* Dropdown menüler mobilde üstte göster */
            div[id^="dropdown-"] {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                width: 90% !important;
                max-width: 300px !important;
                z-index: 999999 !important;
            }
            
            /* Modal içerikleri mobilde scroll */
            .modal-body {
                max-height: 70vh;
                overflow-y: auto;
            }
            
            /* 📱 Form Inputlar Mobilde Daha Büyük */
            .form-control,
            input[type="text"],
            input[type="tel"],
            input[type="email"],
            input[type="date"],
            input[type="datetime-local"],
            select,
            textarea {
                font-size: 16px !important; /* iOS zoom engellemek için */
            }
            
            /* 📱 Butonlar Mobilde Touch-Friendly */
            .btn {
                min-height: 44px !important;
                padding: 10px 15px !important;
            }
            
            .btn-sm {
                min-height: 36px !important;
                padding: 8px 12px !important;
            }
        }
        
        /* 📱 Çok Küçük Ekranlar (Telefonlar) */
        @media (max-width: 480px) {
            .sidebar {
                width: 60px !important;
            }
            
            .sidebar:hover {
                width: 220px !important;
            }
            
            .main-content-wrapper {
                margin-left: 60px !important;
                width: calc(100% - 60px) !important;
            }
            
            .admin-content {
                padding: 10px !important;
            }
            
            /* CRM Leads Kart Düzeni */
            #crm-leads-list td {
                padding-left: 50% !important;
                font-size: 13px !important;
            }
            
            #crm-leads-list td:before {
                width: 45% !important;
                font-size: 11px !important;
            }
            
            #crm-leads-list tr {
                padding: 12px !important;
            }
            
            /* Modal Tam Ekran */
            .modal-content {
                width: 100% !important;
                height: 100vh !important;
                margin: 0 !important;
                border-radius: 0 !important;
                max-height: 100vh !important;
            }
            
            .modal-header {
                padding: 12px !important;
            }
            
            .modal-body {
                padding: 12px !important;
                max-height: calc(100vh - 120px) !important;
            }
            
            /* CRM Dashboard */
            .stat-card {
                padding: 12px !important;
            }
            
            .stat-number {
                font-size: 20px !important;
            }
            
            .stat-label {
                font-size: 11px !important;
            }
            
            /* Başlıklar */
            h2 {
                font-size: 18px !important;
            }
            
            h3 {
                font-size: 16px !important;
            }
            
            /* Sekme Butonları */
            .crm-tab-button,
            .customer-detail-tabs button,
            .incoming-calls-tabs button {
                font-size: 10px !important;
                padding: 6px 8px !important;
            }
            
            /* Tablo Butonları */
            #crm-leads-list td:last-child button {
                min-width: 70px !important;
                font-size: 11px !important;
                padding: 6px 8px !important;
            }
        }
        
        @media (min-width: 769px) {
            .admin-content {
                max-width: 1600px;
                margin: 0 auto;
            }
        }
        
        /* Settings Subsection Styling */
        .settings-subsection {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2f9 100%);
            border: 1px solid #e0e5f0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.3s ease;
        }
        
        .settings-subsection:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }
        
        .settings-subtitle {
            font-size: 1.3em;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-subsection textarea.form-control {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            transition: all 0.2s ease;
            resize: vertical;
            min-height: 120px;
        }
        
        .settings-subsection textarea.form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: #fafbff;
        }
        
        .settings-subsection small {
            display: inline-block;
            margin-top: 6px;
            padding: 6px 12px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }
        
        .settings-subsection small code {
            background: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
            color: #667eea;
            border: 1px solid #e2e8f0;
        }
        
        .expense-category-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            cursor: default;
            position: relative;
        }
        
        .expense-category-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }
        
        .expense-category-card .delete-category-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .expense-category-card:hover .delete-category-btn {
            display: flex;
        }
        
        .expense-category-card .delete-category-btn:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }
    </style>
    <!-- SheetJS for Excel export with dropdowns -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- ✅ YÜKLEME EKRANI (Desktop için) -->
    <style>
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease-out;
        }
        #loadingScreen.hide {
            opacity: 0;
            pointer-events: none;
        }
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-text {
            color: white;
            font-size: 18px;
            margin-top: 20px;
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body>
    <!-- ✅ Loading Screen -->
    <div id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Yükleniyor...</div>
    </div>
    
    <div id="main-wrapper" style="display: flex;">
        <!-- ✅ Sol Sidebar Menü -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <button onclick="toggleSidebar()" style="background: transparent; border: none; color: white; font-size: 20px; cursor: pointer; padding: 5px; margin: 0;" title="Menüyü aç/kapat">
                        ☰
                    </button>
                    <h2 style="margin: 0; flex: 1; text-align: center; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 5px;"><span id="club-title"></span></h2>
                    <div style="width: 34px;"></div> <!-- Boşluk için -->
                </div>
                <div id="whatsapp-balance-container" style="text-align: center; font-size: 11px; color: white; padding: 6px 8px; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; gap: 6px; max-width: 100%; overflow: hidden; box-sizing: border-box;">
                    <span style="font-size: 14px; flex-shrink: 0;">&#x1F4AC;</span>
                    <span style="opacity: 0.9; white-space: nowrap;">Bakiye:</span>
                    <span id="sidebar-whatsapp-balance" style="font-weight: bold; font-size: 13px; white-space: nowrap;">∞</span>
                </div>
            </div>
            
            <div class="sidebar-menu">
                <!-- Ana Sayfa -->
                <button class="nav-btn active" onclick="showSection('dashboard', this)">
                    <span class="nav-icon">📊</span>
                    <span class="nav-text">Ana Sayfa</span>
                </button>
                
                <!-- Yönetim Dropdown -->
                <div class="nav-dropdown">
                    <button class="nav-btn dropdown-toggle">
                        <span class="nav-icon">🛠️</span>
                        <span class="nav-text">Yönetim</span>
                        <span class="dropdown-arrow">▼</span>
                    </button>
                    <div class="dropdown-content">
                        <button class="nav-btn sub-item" onclick="showSection('registration-procedures', this)">
                            <span class="nav-text">📑 Kayıt İşlemleri</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('members', this); hideMemberDetail()">
                            <span class="nav-text">👥 Üyeler</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('pending-members', this)">
                            <span class="nav-text">📋 Bekleyen Kayıtlar</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('inactive-members', this)">
                            <span class="nav-text">⏸️ Pasif Üyeler</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('groups', this)">
                            <span class="nav-text">⭐ Gruplar</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('schedule', this)">
                            <span class="nav-text">📅 Ders Planı</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('tasks', this)">
                            <span class="nav-text">✅ Görevlerim</span>
                        </button>
                    </div>
                </div>
                
                <!-- Muhasebe Dropdown -->
                <div class="nav-dropdown">
                    <button class="nav-btn dropdown-toggle">
                        <span class="nav-icon">💵</span>
                        <span class="nav-text">Muhasebe</span>
                        <span class="dropdown-arrow">▼</span>
                    </button>
                    <div class="dropdown-content">
                        <button class="nav-btn sub-item" onclick="showSection('payments', this)">
                            <span class="nav-text">💳 Aidatlar</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('incomes', this)">
                            <span class="nav-text">💰 Gelirler</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('expenses', this)">
                            <span class="nav-text">💸 Giderler</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('accounting-summary', this)">
                            <span class="nav-text">📊 Muhasebe Özeti</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('products', this)">
                            <span class="nav-text">🛍️ Ürünler</span>
                        </button>
                    </div>
                </div>
                
                <!-- WhatsApp Dropdown -->
                <div class="nav-dropdown">
                    <button class="nav-btn dropdown-toggle">
                        <span class="nav-icon">💬</span>
                        <span class="nav-text">WhatsApp</span>
                        <span class="dropdown-arrow">▼</span>
                    </button>
                    <div class="dropdown-content">
                        <button class="nav-btn sub-item" onclick="showSection('whatsapp', this); switchWhatsAppTab('messages')">
                            <span class="nav-text">&#x1F4AC; Mesajlaşma</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('whatsapp', this); switchWhatsAppTab('devices')">
                            <span class="nav-text">&#x1F4F1; Cihazlar</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('whatsapp', this); switchWhatsAppTab('bulk')">
                            <span class="nav-text">&#x1F4E4; Toplu Mesaj</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('whatsapp', this); switchWhatsAppTab('queue')">
                            <span class="nav-text">&#x1F4E5; Mesaj Kuyruğu</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('whatsapp', this); switchWhatsAppTab('reports')">
                            <span class="nav-text">&#x1F4CA; Mesaj Raporları</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('whatsapp-balance', this)">
                            <span class="nav-text">&#x1F4B0; WhatsApp Bakiyem</span>
                        </button>
                    </div>
                </div>
                
                <!-- CRM Dropdown -->
                <div id="crm-menu-dropdown" class="nav-dropdown">
                    <button class="nav-btn dropdown-toggle">
                        <span class="nav-icon">👤</span>
                        <span class="nav-text">CRM</span>
                        <span class="dropdown-arrow">▼</span>
                    </button>
                    <div class="dropdown-content">
                        <button class="nav-btn sub-item" onclick="showSection('crm', this)">
                            <span class="nav-text">📋 CRM Ana Sayfa</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('crm-incoming-calls', this)">
                            <span class="nav-text">📞 Gelen Aramalar</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('crm-outgoing-calls', this)">
                            <span class="nav-text">📲 Giden Aramalar</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('crm-filter', this)">
                            <span class="nav-text">🔍 Müşteri Filtrele</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('crm-trials', this)">
                            <span class="nav-text">🎯 Denemeler</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('crm-tags', this)">
                            <span class="nav-text">🏷️ Etiketler</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('crm-templates', this)">
                            <span class="nav-text">📝 CRM Mesaj Şablonları</span>
                        </button>
                    </div>
                </div>
                
                <!-- Ayarlar (En Alt) -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid rgba(255,255,255,0.1);">
                    <button class="nav-btn" onclick="showSection('settings', this)">
                        <span class="nav-icon">⚙️</span>
                        <span class="nav-text">Ayarlar</span>
                    </button>
                    <button class="nav-btn" onclick="showSection('user-activities', this)">
                        <span class="nav-icon">📝</span>
                        <span class="nav-text">Kullanıcı Hareketleri</span>
                    </button>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="current-user-display" style="margin-bottom: 10px; font-size: 12px;"></div>
                <button id="logout-btn-sidebar" class="btn btn-danger" style="width: 100%; padding: 10px; font-size: 13px;">
                    🚪 Çıkış Yap
                </button>
            </div>
        </nav>

        <!-- ✅ Ana İçerik Alanı -->
        <div class="main-content-wrapper">
            <div class="admin-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                    <h2 class="card-title" style="margin: 0;">Ana Sayfa</h2>
                    <button id="toggle-dashboard-amounts-btn" onclick="toggleDashboardAmounts()" style="background: none; border: none; cursor: pointer; font-size: 20px; padding: 5px; transition: all 0.2s;" title="Tutarları Gizle/Göster">
                        👁️
                    </button>
                </div>
                <div class="stats-grid" id="dashboard-stats-grid">
                    <div class="stat-card" onclick="navigateToSection('members')">
                        <div class="stat-number" id="totalMembers">0</div>
                        <div class="stat-label">Toplam Üye</div>
                    </div>
                    <div class="stat-card" onclick="navigateToSection('members')">
                        <div class="stat-number" id="activeMembers">0</div>
                        <div class="stat-label">Aktif Üye</div>
                    </div>
                    <div class="stat-card" onclick="showSection('pending-members')">
                        <div class="stat-number" id="pendingRegistrations">0</div>
                        <div class="stat-label">Bekleyen Kayıtlar</div>
                    </div>
                    <div class="stat-card" onclick="navigateToSection('inactive-members')">
                        <div class="stat-number" id="inactiveMembers">0</div>
                        <div class="stat-label">Pasif Üyeler</div>
                    </div>
                    <div class="stat-card" onclick="navigateToSection('payments')">
                        <div class="stat-number" id="monthlyRevenue">0₺</div>
                        <div class="stat-label">Bu Ay Toplam Ciro</div>
                        <div class="stat-comparison" id="revenueComparison"></div>
                    </div>
                </div>
                
                <div class="dashboard-grid">
                    <div class="card">
                        <h3 class="card-title" style="cursor: pointer;" onclick="showSection('attendance-tracking', document.querySelector('.nav-btn[onclick*=attendance]'))">🏃‍♂️ Son Devamsızlıklar</h3>
                        <div id="absentStudentsList">
                            <div class="loading">
                                <div class="spinner"></div>
                                <span>Yükleniyor...</span>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">🎂 Yaklaşan Doğum Günleri</h3>
                        <div id="upcomingBirthdaysList">
                             <div class="loading">
                                <div class="spinner"></div>
                                <span>Yükleniyor...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WhatsApp Balance Section -->
            <div id="whatsapp-balance" class="section">
                <h2 class="card-title">&#x1F4B0; WhatsApp Bakiyem</h2>
                
                <div id="whatsapp-balance-content" style="display: flex; flex-direction: column; gap: 25px;">
                    <div class="loading" style="text-align: center; padding: 40px;">
                        <div class="spinner"></div>
                        <span>Yükleniyor...</span>
                    </div>
                </div>
            </div>

            <!-- Registration Procedures Section -->
            <div id="registration-procedures" class="section">
                <div class="card">
                    <h3 class="card-title">Yeni Kayıt Ekle</h3>
                    <div class="registration-forms-container">
                        <div class="registration-form-wrapper">
                             <h4 style="font-size: 1.2em; margin-bottom: 15px;">📝 Yeni Kayıt Oluştur</h4>
                             <form id="preRegistrationForm">
                                 <div class="form-grid">
                                     <div class="form-group"><label for="memberTypePre">Kayıt Tipi *</label><select class="form-control" name="memberType" id="memberTypePre" required><option value="child">Çocuk</option><option value="adult">Yetişkin</option></select></div>
                                     <div class="form-group" id="parentName1Group"><label for="parentNamePre">Veli Adı Soyadı *</label><input type="text" id="parentNamePre" class="form-control" name="parentName"></div>
                                     <div class="form-group" id="parentTcGroup"><label for="parentTcPre">🆔 Veli TC Kimlik No</label><input type="text" id="parentTcPre" class="form-control" name="parentTc" pattern="[0-9]{11}" maxlength="11" placeholder="11 haneli TC kimlik numarası (opsiyonel)"></div>
                                     <div class="form-group" id="phone1Group"><label for="preRegPhonePre">Veli Telefon *</label><input type="tel" id="preRegPhonePre" class="form-control" name="phone" required pattern="0[0-9]{10}" maxlength="11"></div>
                                     <div class="form-group" id="parentName2Group"><label for="parentName2Pre">Veli 2 Adı Soyadı (İsteğe Bağlı)</label><input type="text" id="parentName2Pre" class="form-control" name="parentName2"></div>
                                     <div class="form-group" id="phone2Group"><label for="preRegPhone2Pre">Veli 2 Telefon</label><input type="tel" id="preRegPhone2Pre" class="form-control" name="phone2" pattern="0[0-9]{10}" maxlength="11"></div>
                                     <div class="form-group"><label for="preRegBranchPre">Branş *</label><select class="form-control" name="branch" id="preRegBranchPre" required><option value="">Seçiniz...</option><option value="tenis">🎾 Tenis</option><option value="yuzme">🏊 Yüzme</option></select></div>
                                 </div>
                                 
                                 <!-- Öğrenci Bilgileri (Çoklu) -->
                                 <div id="studentsContainer" style="display: none; margin-top: 20px;">
                                     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                         <h4 style="margin: 0;">👶 Öğrenci Bilgileri</h4>
                                         <button type="button" class="btn btn-sm btn-success" onclick="addStudentField()" id="addStudentBtn">➕ Öğrenci Ekle</button>
                                     </div>
                                     <p style="font-size: 13px; color: #666; margin-bottom: 15px;">ℹ️ Her öğrenci için ayrı kayıt ve ödeme planı oluşturulacaktır.</p>
                                     <div id="studentFieldsContainer">
                                         <div class="student-field-group" data-student-index="0">
                                             <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; position: relative; border-left: 4px solid #4CAF50;">
                                                 <h5 style="margin: 0 0 15px 0; color: #333;">Öğrenci 1</h5>
                                                 <div class="form-grid">
                                                    <div class="form-group"><label>Ad Soyad *</label><input type="text" class="form-control student-name" name="studentName_0" required></div>
                                                    <div class="form-group"><label>Doğum Tarihi</label><input type="date" class="form-control student-birthdate" name="studentBirthDate_0"></div>
                                                 </div>
                                             </div>
                                         </div>
                                     </div>
                                 </div>
                                 
                                 <!-- Yetişkin için tek öğrenci alanı -->
                                 <div id="singleStudentContainer" style="display: none; margin-top: 20px;">
                                    <h4 style="margin-bottom: 15px;">👨 Üye Bilgileri</h4>
                                    <div class="form-grid" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                        <div class="form-group"><label for="studentNamePre">Ad Soyad *</label><input type="text" id="studentNamePre" class="form-control" name="studentName" required></div>
                                        <div class="form-group"><label for="studentBirthDatePre">Doğum Tarihi</label><input type="date" id="studentBirthDatePre" class="form-control" name="studentBirthDate"></div>
                                     </div>
                                 </div>
                                 
                                 <div class="form-grid" style="margin-top: 20px;">
                                     <div class="form-group">
                                         <label for="preRegGroupSearch">Grup</label>
                                         <div class="searchable-select-container">
                                             <input type="text" id="preRegGroupSearch" class="form-control" placeholder="Önce branş seçin" autocomplete="off" disabled>
                                             <input type="hidden" name="groupId" id="preRegGroupId">
                                             <div class="searchable-select-results" id="preRegGroupResults"></div>
                                         </div>
                                     </div>
                                 </div>
                                 <hr style="margin: 20px 0;">
                                 <h4 style="margin-bottom: 15px;">Ödeme Planı</h4>
                                 <div class="form-grid">
                                     <div class="form-group"><label>İlk Dönem Başlangıç *</label><input type="date" class="form-control" name="firstPeriodStart" required></div>
                                     <div class="form-group"><label>İlk Dönem Bitiş *</label><input type="date" class="form-control" name="firstPeriodEnd" required></div>
                                     <div class="form-group"><label>İlk Dönem Ders Sayısı</label><input type="number" class="form-control" name="firstLessonCount"></div>
                                     <div class="form-group"><label>İlk Dönem Ücreti (TL) *</label><input type="text" class="form-control" name="firstInstallmentAmount" required></div>
                                     <div class="form-group"><label>İlk Dönem Son Ödeme *</label><input type="date" class="form-control" name="firstDueDate" required></div>
                                     <div class="form-group"><label>Sonraki Taksit Sayısı</label><input type="number" class="form-control" name="installments" value="6" min="0"></div>
                                     <div class="form-group"><label>Sonraki Taksit Ücreti (TL)</label><input type="text" class="form-control" name="subsequentInstallmentAmount"></div>
                                     <div class="form-group"><label>Ödeme Günü</label><input type="number" class="form-control" name="dueDay" value="20" min="1" max="31"></div>
                                 </div>
                                 <div class="form-group"><label>Notlar</label><textarea class="form-control" name="notes" rows="2"></textarea></div>
                                 <div class="payment-plan-preview" style="margin-top: 20px;"></div>
                                 <button type="submit" class="btn btn-primary" style="margin-top: 20px;">📝 Kayıt Oluştur</button>
                               </form>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">📋 Bekleyen Kayıtlar</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ad Soyad</th>
                                    <th>Veli Adı</th>
                                    <th>Telefon</th>
                                    <th>Branş</th>
                                    <th>Durum</th>
                                    <th>Grup</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="preRegistrationTable"></tbody>
                        </table>
                    </div>
                </div>

            </div>

            <!-- Bekleyen Üyeler Section -->
            <div id="pending-members" class="section">
                <div class="card">
                    <h3 class="card-title">📋 Bekleyen Kayıtlar</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ad Soyad</th>
                                    <th>Veli Adı</th>
                                    <th>Telefon</th>
                                    <th>Branş</th>
                                    <th>Durum</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="pendingMembersTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pasif Üyeler Section -->
            <div id="inactive-members" class="section">
                <div class="card">
                    <h3 class="card-title">⏸️ Pasif Üyeler</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ad Soyad</th>
                                    <th>Veli Adı</th>
                                    <th>Telefon</th>
                                    <th>Branş</th>
                                    <th>Durum</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="inactiveMembersTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Members Section -->
            <div id="members" class="section">
                <!-- Üye Detay Alanı (Üyeye tıklanınca gösterilecek) -->
                <div id="member-detail-content" style="display: none;"></div>
                
                <div class="card" id="members-list-card">
                    <div class="card-title">
                        <h3>👥 Üyeler</h3>
                        <input type="text" id="memberSearch" class="form-control search-input" placeholder="Üye ara (İsim, Telefon)...">
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Üye</th>
                                    <th>Veli</th>
                                    <th>Telefon</th>
                                    <th onclick="sortMembersByAge()" style="cursor: pointer;">Yaş</th>
                                    <th>Branş</th>
                                    <th>Durum</th>
                                    <th>Grup</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="membersTable"></tbody>
                        </table>
                    </div>
                    <div class="pagination-controls">
                        <div class="page-info-group">
                             <label for="itemsPerPage">Sayfa başına:</label>
                            <select id="itemsPerPage" class="form-control" onchange="changeMembersItemsPerPage(this)">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <div class="page-nav-group">
                            <button id="prevPageBtn" class="btn btn-secondary" onclick="changeMembersPage(-1)">Önceki</button>
                            <span id="pageInfo" style="padding: 0 15px; font-weight: 500;">Sayfa 1 / 1</span>
                            <button id="nextPageBtn" class="btn btn-secondary" onclick="changeMembersPage(1)">Sonraki</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payments Section -->
            <div id="payments" class="section">
                <div class="card">
                    <div class="card-title">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <h3 style="margin: 0;">💰 Ödeme Takibi</h3>
                            <button id="toggle-payment-visibility-btn" onclick="togglePaymentVisibility()" style="background: none; border: none; cursor: pointer; font-size: 20px; padding: 5px; transition: all 0.2s;" title="Tutarları Gizle/Göster">
                                👁️
                            </button>
                        </div>
                        <input type="text" id="paymentSearch" class="form-control search-input" placeholder="Üye ara (İsim, Telefon)...">
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 15px;">
                        <div class="btn-group">
                             <button class="btn btn-primary btn-sm active" onclick="setPaymentFilter('all', this)">Tüm Üyeler</button>
                             <button class="btn btn-info btn-sm" onclick="setPaymentFilter('paidThisMonth', this)">💳 Bu Ay Ödenen</button>
                             <button class="btn btn-danger btn-sm" onclick="setPaymentFilter('overdue', this)">Gecikmiş Ödemeler <span id="overdue-count"></span></button>
                             <button class="btn btn-success btn-sm" onclick="setPaymentFilter('finished', this)">Planı Bitenler <span id="finished-count"></span></button>
                        </div>
                        <!-- ✅ Gecikmiş ödemelere Toplu Mesaj butonu -->
                        <button class="btn btn-warning btn-sm" onclick="sendBulkOverdueReminders()" style="margin-left: auto;">
                            📢 Gecikmiş Ödemelere Toplu Mesaj
                        </button>
                    </div>
                    <div class="stats-grid" id="payment-stats" style="margin-top:20px;">
                        <div class="stat-card" style="cursor: pointer; transition: transform 0.2s;" onclick="showSection('payments'); document.getElementById('payment-filter').value='all'; loadPayments();" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div class="stat-number" id="totalRevenue">0₺</div>
                            <div class="stat-label">📊 Bu Ay Vadesi Gelen Toplam</div>
                            <div style="font-size: 11px; color: #999; margin-top: 5px;">Tahsil edilen + Bekleyen</div>
                        </div>
                        <div class="stat-card" style="cursor: pointer; transition: transform 0.2s; border-color: #4caf50;" onclick="showSection('payments'); setPaymentFilter('paidThisMonth');" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div class="stat-number" id="totalPaid" style="color: #4caf50;">0₺</div>
                            <div class="stat-label">✅ Bu Ay Tahsil Edilen</div>
                            <div style="font-size: 11px; color: #999; margin-top: 5px;">Ödeme tarihi bu ay olanlar</div>
                        </div>
                        <div class="stat-card" style="cursor: pointer; transition: transform 0.2s; border-color: #ff9800;" onclick="showSection('payments'); setPaymentFilter('unpaidThisMonth');" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div class="stat-number" id="totalUnpaid" style="color: #ff9800;">0₺</div>
                            <div class="stat-label">⏳ Bu Ay Alacaklar</div>
                            <div style="font-size: 11px; color: #999; margin-top: 5px;">Vadesi bu ay, ödenmemiş</div>
                        </div>
                    </div>
                     <div id="overdue-stats-container" class="stats-grid" style="display: none; margin-top: 20px;">
                        <div class="stat-card" style="border-color: var(--danger-color);">
                            <div class="stat-number" id="overdue-total-amount" style="color: var(--danger-color);">0₺</div>
                            <div class="stat-label">Toplam Gecikmiş Tutar</div>
                        </div>
                        <div class="stat-card" style="border-color: var(--danger-color);">
                            <div class="stat-number" id="overdue-member-count" style="color: var(--danger-color);">0</div>
                            <div class="stat-label">Gecikmesi Olan Kişi Sayısı</div>
                        </div>
                    </div>
                    <div id="member-payment-list" class="payment-member-list">
                         <div class="loading">
                             <div class="spinner"></div>
                             <span>Üyeler yükleniyor...</span>
                         </div>
                    </div>
                </div>
            </div>

            <!-- Expenses Section (Giderler) -->
            <div id="expenses" class="section">
                <div class="card">
                    <!-- Başlık ve Butonlar -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 3px solid #f44336;">
                        <h2 style="margin: 0; color: #f44336; font-size: 28px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 36px;">💸</span>
                            Gider Yönetimi
                        </h2>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn" onclick="openExpenseCategoryManager()" style="background: linear-gradient(135deg, #f44336 0%, #e53935 100%); color: white; padding: 12px 24px; border: none; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 8px rgba(244,67,54,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(244,67,54,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(244,67,54,0.3)'">
                                📂 Kategori Yönetimi
                            </button>
                            <button class="btn" onclick="openAddExpenseModal()" style="background: linear-gradient(135deg, #ff5722 0%, #f4511e 100%); color: white; padding: 12px 24px; border: none; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 8px rgba(255,87,34,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(255,87,34,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(255,87,34,0.3)'">
                                ➕ Yeni Gider Ekle
                            </button>
                        </div>
                    </div>
                    
                    <!-- Hızlı Filtreler -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn" onclick="setExpensePeriod('today')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; font-weight: 600; border-radius: 10px; box-shadow: 0 4px 8px rgba(102,126,234,0.3);">
                            📅 Bugün
                        </button>
                        <button class="btn" onclick="setExpensePeriod('week')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 12px 20px; font-weight: 600; border-radius: 10px; box-shadow: 0 4px 8px rgba(240,147,251,0.3);">
                            📆 Son 1 Hafta
                        </button>
                        <button class="btn" onclick="setExpensePeriod('month')" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 12px 20px; font-weight: 600; border-radius: 10px; box-shadow: 0 4px 8px rgba(79,172,254,0.3);">
                            📊 Bu Ay
                        </button>
                        <button class="btn" onclick="setExpensePeriod('lastMonth')" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 12px 20px; font-weight: 600; border-radius: 10px; box-shadow: 0 4px 8px rgba(67,233,123,0.3);">
                            📈 Geçen Ay
                        </button>
                        <button class="btn" onclick="setExpensePeriod('year')" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 12px 20px; font-weight: 600; border-radius: 10px; box-shadow: 0 4px 8px rgba(250,112,154,0.3);">
                            📅 Bu Yıl
                        </button>
                    </div>
                    
                    <!-- Filtreler - Modern Tasarım -->
                    <div style="background: linear-gradient(135deg, #f44336 0%, #e53935 100%); padding: 20px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 8px 16px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="font-size: 24px;">🔍</span>
                            <h3 style="color: white; margin: 0; font-size: 18px; font-weight: 600;">Detaylı Filtreler</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #333;">
                                    <span style="font-size: 18px;">📅</span>
                                    Başlangıç Tarihi
                                </label>
                                <input type="date" id="expensesStartDate" class="form-control" onchange="renderExpensesPage()" style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; font-size: 14px;">
                            </div>
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #333;">
                                    <span style="font-size: 18px;">📅</span>
                                    Bitiş Tarihi
                                </label>
                                <input type="date" id="expensesEndDate" class="form-control" onchange="renderExpensesPage()" style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; font-size: 14px;">
                            </div>
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #333;">
                                    <span style="font-size: 18px;">📂</span>
                                    Kategori
                                </label>
                                <select id="expensesCategoryFilter" class="form-control" onchange="renderExpensesPage()" style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; font-size: 14px; cursor: pointer;">
                                    <option value="all">📋 Tüm Kategoriler</option>
                                    <option value="Kira">🏠 Kira</option>
                                                                                </select>
                            </div>
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #333;">
                                    <span style="font-size: 18px;">🏢</span>
                                    Branş
                                </label>
                                <select id="expensesBranchFilter" class="form-control" onchange="renderExpensesPage()" style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; font-size: 14px; cursor: pointer;">
                                    <option value="all">🌐 Tüm Branşlar</option>
                                </select>
                            </div>
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; align-items: flex-end;">
                                <button class="btn btn-light" onclick="resetExpensesFilters()" style="width: 100%; padding: 10px; border: 2px solid #fff; border-radius: 8px; font-weight: 600; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; box-shadow: 0 4px 8px rgba(255,152,0,0.3);">
                                    🔄 Filtreleri Sıfırla
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="expensesPageContainer">
                        <div class="loading"><div class="spinner"></div><span>Giderler yükleniyor...</span></div>
                    </div>
                </div>
            </div>

            <!-- Incomes Section (Gelirler) -->
            <div id="incomes" class="section">
                <div class="card">
                    <!-- Başlık ve Butonlar -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 3px solid #4caf50;">
                        <h2 style="margin: 0; color: #4caf50; font-size: 28px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 36px;">💰</span>
                            Gelir Yönetimi
                        </h2>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn" onclick="openIncomeCategoryManager()" style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; padding: 12px 24px; border: none; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 8px rgba(76,175,80,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(76,175,80,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(76,175,80,0.3)'">
                                📂 Kategori Yönetimi
                            </button>
                            <button class="btn" onclick="openAddIncomeModal()" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; padding: 12px 24px; border: none; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 8px rgba(33,150,243,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(33,150,243,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(33,150,243,0.3)'">
                                ➕ Yeni Gelir Ekle
                            </button>
                        </div>
                    </div>
                    
                    <!-- Hızlı Filtreler -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn" onclick="setIncomePeriod('today')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; font-weight: 600; border-radius: 10px; box-shadow: 0 4px 8px rgba(102,126,234,0.3);">
                            📅 Bugün
                        </button>
                        <button class="btn" onclick="setIncomePeriod('week')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 12px 20px; font-weight: 600; border-radius: 10px; box-shadow: 0 4px 8px rgba(240,147,251,0.3);">
                            📆 Son 1 Hafta
                        </button>
                        <button class="btn" onclick="setIncomePeriod('month')" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 12px 20px; font-weight: 600; border-radius: 10px; box-shadow: 0 4px 8px rgba(79,172,254,0.3);">
                            📊 Bu Ay
                        </button>
                        <button class="btn" onclick="setIncomePeriod('lastMonth')" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 12px 20px; font-weight: 600; border-radius: 10px; box-shadow: 0 4px 8px rgba(67,233,123,0.3);">
                            📈 Geçen Ay
                        </button>
                        <button class="btn" onclick="setIncomePeriod('year')" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 12px 20px; font-weight: 600; border-radius: 10px; box-shadow: 0 4px 8px rgba(250,112,154,0.3);">
                            📅 Bu Yıl
                        </button>
                    </div>
                    
                    <!-- Filtreler - Modern Tasarım -->
                    <div style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); padding: 20px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 8px 16px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="font-size: 24px;">🔍</span>
                            <h3 style="color: white; margin: 0; font-size: 18px; font-weight: 600;">Detaylı Filtreler</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #333;">
                                    <span style="font-size: 18px;">📅</span>
                                    Başlangıç Tarihi
                                </label>
                                <input type="date" id="incomesStartDate" class="form-control" onchange="renderIncomesPage()" style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; font-size: 14px;">
                            </div>
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #333;">
                                    <span style="font-size: 18px;">📅</span>
                                    Bitiş Tarihi
                                </label>
                                <input type="date" id="incomesEndDate" class="form-control" onchange="renderIncomesPage()" style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; font-size: 14px;">
                            </div>
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #333;">
                                    <span style="font-size: 18px;">📂</span>
                                    Kategori
                                </label>
                                <select id="incomesCategoryFilter" class="form-control" onchange="renderIncomesPage()" style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; font-size: 14px; cursor: pointer;">
                                    <option value="all">📋 Tüm Kategoriler</option>
                                    <option value="Aidat">💳 Aidat</option>
                                    <option value="Ürün Satışı">🛍️ Ürün Satışı</option>
                                    <option value="Diğer Gelir">� Diğer Gelir</option>
                                </select>
                            </div>
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #333;">
                                    <span style="font-size: 18px;">🏢</span>
                                    Branş
                                </label>
                                <select id="incomesBranchFilter" class="form-control" onchange="renderIncomesPage()" style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; font-size: 14px; cursor: pointer;">
                                    <option value="all">🌐 Tüm Branşlar</option>
                                </select>
                            </div>
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; align-items: flex-end;">
                                <button class="btn btn-light" onclick="resetIncomesFilters()" style="width: 100%; padding: 10px; border: 2px solid #fff; border-radius: 8px; font-weight: 600; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; box-shadow: 0 4px 8px rgba(76,175,80,0.3);">
                                    🔄 Filtreleri Sıfırla
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="incomesPageContainer">
                        <div class="loading"><div class="spinner"></div><span>Gelirler yükleniyor...</span></div>
                    </div>
                </div>
            </div>

            <!-- Accounting Summary Section (Muhasebe Özeti) -->
            <div id="accounting-summary" class="section">
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                        <h2>📊 Muhasebe Özeti</h2>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="openAddExpenseModal()">
                                ➕ Gider Ekle
                            </button>
                            <button class="btn btn-secondary" onclick="openAddProductModal()">
                                ➕ Ürün Ekle
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtreler - Modern Tasarım -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 8px 16px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="font-size: 24px;">🔍</span>
                            <h3 style="color: white; margin: 0; font-size: 18px; font-weight: 600;">Filtreler</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px;">
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #333;">
                                    <span style="font-size: 18px;">📅</span>
                                    Başlangıç Tarihi
                                </label>
                                <input type="date" id="summaryStartDate" class="form-control" onchange="renderAccountingSummary()" style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; font-size: 14px; transition: all 0.3s;">
                            </div>
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #333;">
                                    <span style="font-size: 18px;">📅</span>
                                    Bitiş Tarihi
                                </label>
                                <input type="date" id="summaryEndDate" class="form-control" onchange="renderAccountingSummary()" style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; font-size: 14px; transition: all 0.3s;">
                            </div>
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #333;">
                                    <span style="font-size: 18px;">🏢</span>
                                    Branş
                                </label>
                                <select id="summaryBranchFilter" class="form-control" onchange="renderAccountingSummary()" style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; font-size: 14px; transition: all 0.3s; cursor: pointer;">
                                    <option value="all">🌐 Tüm Branşlar</option>
                                </select>
                            </div>
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; align-items: flex-end;">
                                <button class="btn btn-light" onclick="resetSummaryFilters()" style="width: 100%; padding: 10px; border: 2px solid #fff; border-radius: 8px; font-weight: 600; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; transition: all 0.3s; box-shadow: 0 4px 8px rgba(245,87,108,0.3);">
                                    🔄 Filtreleri Sıfırla
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Özet Kartları -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- Toplam Gelir (Tahsil Edilen) -->
                        <div style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">💰 Toplam Gelir</div>
                            <div id="totalIncome" style="font-size: 32px; font-weight: bold;">0 ₺</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Aidat + Satış + Diğer</div>
                        </div>
                        
                        <!-- Toplam Gider -->
                        <div style="background: linear-gradient(135deg, #f44336 0%, #e53935 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">📉 Toplam Gider</div>
                            <div id="totalExpense" style="font-size: 32px; font-weight: bold;">0 ₺</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Bu ay yapılan giderler</div>
                        </div>
                        
                        <!-- Net Kar/Zarar -->
                        <div style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">📊 Net Kar/Zarar</div>
                            <div id="netProfit" style="font-size: 32px; font-weight: bold;">0 ₺</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Gelir - Gider</div>
                        </div>
                        
                        <!-- Ürün Satışları -->
                        <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">🛍️ Ürün Satışları</div>
                            <div id="totalProductSales" style="font-size: 32px; font-weight: bold;">0 ₺</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Satışlardan gelir</div>
                        </div>
                    </div>
                    
                    <!-- Grafikler Bölümü -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- Gelir Dağılımı Grafiği -->
                        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 20px 0; color: #4caf50; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">📊</span>
                                Gelir Dağılımı
                            </h4>
                            <canvas id="incomeChart" style="max-height: 300px;"></canvas>
                        </div>
                        
                        <!-- Gider Dağılımı Grafiği -->
                        <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 20px 0; color: #f44336; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">📉</span>
                                Gider Dağılımı
                            </h4>
                            <canvas id="expenseChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                    
                    <!-- Gelir/Gider Karşılaştırma Grafiği -->
                    <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 30px;">
                        <h4 style="margin: 0 0 20px 0; color: #2196f3; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">📈</span>
                            Gelir vs Gider Karşılaştırması
                        </h4>
                        <canvas id="comparisonChart" style="max-height: 350px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Products Section (Ürünler) -->
            <div id="products" class="section">
                <div class="card">
                    <!-- Başlık ve Butonlar -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 3px solid #ff9800;">
                        <h2 style="margin: 0; color: #ff9800; font-size: 28px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 36px;">🛍️</span>
                            Ürün Yönetimi
                        </h2>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn" onclick="openProductCategoryManager()" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 12px 24px; border: none; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 8px rgba(255,152,0,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(255,152,0,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(255,152,0,0.3)'">
                                📂 Kategori Yönetimi
                            </button>
                            <button class="btn" onclick="openAddProductModal()" style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; padding: 12px 24px; border: none; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 8px rgba(76,175,80,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(76,175,80,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(76,175,80,0.3)'">
                                ➕ Yeni Ürün Ekle
                            </button>
                        </div>
                    </div>
                    
                    <div id="productsPageContainer">
                        <div class="loading"><div class="spinner"></div><span>Ürünler yükleniyor...</span></div>
                    </div>
                </div>
            </div>

            <!-- Schedule Section -->
            <div id="schedule" class="section">
                <div class="card">
                    <div class="card-title">
                        <h3>📅 Ders Planı Yönetimi</h3>
                        <div id="schedule-branch-buttons" class="btn-group">
                            <!-- ✅ Dinamik branş butonları buraya gelecek -->
                       </div>
                    </div>
                    <div id="unassigned-groups-container"></div>
                    <div id="scheduleGrid">
                        <div class="empty-state" style="grid-column: 1 / -1;"><h3>Lütfen bir branş seçin.</h3></div>
                    </div>
                </div>
            </div>

            <!-- Groups Section -->
            <div id="groups" class="section">
                <div class="card">
                    <div class="card-title">
                        <h3>🤸 Grup Yönetimi</h3>
                        <input type="text" id="groupSearch" class="form-control search-input" placeholder="Grup ara...">
                        <div id="groups-branch-buttons" class="btn-group">
                            <!-- ✅ Dinamik branş butonları buraya gelecek -->
                       </div>
                        <button class="btn btn-primary btn-sm" id="newGroupBtn" style="display:none;" onclick="openGroupModal()">➕ Yeni Grup</button>
                    </div>
                    <div id="groupsList">
                        <div class="empty-state"><h3>Lütfen bir branş seçin.</h3></div>
                    </div>
                </div>
            </div>
            
            <!-- Tasks Section -->
            <div id="tasks" class="section">
                <div class="card">
                    <div class="card-title">
                        <h3>🎯 Görev Yönetimi</h3>
                        <button class="btn btn-primary" onclick="openTaskEditModal()">➕ Yeni Görev Ekle</button>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Görev</th>
                                    <th>Sorumlu Kişi</th>
                                    <th>Aşama</th>
                                    <th>Notlar</th>
                                    <th>Eklenme Tarihi</th>
                                    <th>Tamamlanma Tarihi</th>
                                    <th>Mesajlar</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="tasksTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="section">
                <!-- Profilim Section -->
                <div class="card">
                    <h3 class="card-title">🔑 Profilim</h3>
                    <p>Aşağıdaki butona tıklayarak adınızı ve şifrenizi güncelleyebilirsiniz.</p>
                    <button class="btn btn-primary" style="margin-top:15px;" onclick="openProfileEditModal()">Profili Düzenle</button>
                </div>
                
                <!-- Settings Tabs -->
                <div class="card">
                    <div class="settings-tabs">
                        <button class="settings-tab active" onclick="switchSettingsTab('club')">🏢 Kulüp Bilgileri</button>
                        <button class="settings-tab" onclick="switchSettingsTab('general')">⚙️ Genel Ayarlar</button>
                        <button class="settings-tab" onclick="switchSettingsTab('branches')">🏃 Branş Yönetimi</button>
                        <button class="settings-tab" onclick="switchSettingsTab('users')">👥 Yönetici Yönetimi</button>
                        <button class="settings-tab" onclick="switchSettingsTab('contract')">📄 Sözleşme Şablonu</button>
                        <button class="settings-tab" onclick="switchSettingsTab('templates')">📝 Üye Mesaj Şablonları</button>
                    </div>
                    
                    <!-- Tab Content: Kulüp Bilgileri -->
                    <div id="settings-tab-club" class="settings-tab-content active">
                        <form id="clubInfoForm" onsubmit="saveClubInfo(event)">
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">🏢 Temel Bilgiler</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="clubInfoName">Kulüp Adı *</label>
                                        <input type="text" id="clubInfoName" name="clubName" class="form-control" required placeholder="Örn: Atakum Tenis Kulübü" oninput="generateRegistrationLink()">
                                    </div>
                                    <div class="form-group">
                                        <label for="clubIcon">İkon (Emoji)</label>
                                        <input type="text" id="clubIcon" name="clubIcon" class="form-control" maxlength="2" placeholder="🎾">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="clubDescription">Kulüp Açıklaması</label>
                                    <textarea id="clubDescription" name="clubDescription" class="form-control" rows="3" placeholder="Kulübünüz hakkında kısa açıklama..."></textarea>
                                </div>
                                
                                <!-- Kayıt Linki -->
                                <div id="registrationLinkSection" style="background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50; margin-top: 20px; display: none;">
                                    <h5 style="margin: 0 0 10px 0; color: #2e7d32; font-size: 14px;">🔗 Kulüp Kayıt Linki</h5>
                                    <p style="margin: 0 0 10px 0; font-size: 13px; color: #666;">
                                        Bu linki üyelerinizle paylaşarak online kayıt almalarını sağlayabilirsiniz:
                                    </p>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input type="text" id="registrationLinkDisplay" readonly class="form-control" style="background: white; font-family: monospace; font-size: 12px; flex: 1;">
                                        <button type="button" class="btn btn-success" onclick="copyRegistrationLink()" style="white-space: nowrap;">
                                            📋 Kopyala
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="openRegistrationLink()" style="white-space: nowrap;">
                                            🔗 Aç
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary" style="margin-top: 20px;">💾 Kulüp Bilgilerini Kaydet</button>
                        </form>
                    </div>
                    
                    <!-- Tab Content: Genel Ayarlar -->
                    <div id="settings-tab-general" class="settings-tab-content">
                        <form id="settingsForm">
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">📅 Haftalık Tatil Günleri</h4>
                                <div class="form-group">
                                    <div id="holiday-settings" class="holiday-settings-grid"></div>
                                </div>
                            </div>
                            
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">📞 Bulutfon API Entegrasyonu</h4>
                                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                                    Bulutfon API'yi aktif ederek CRM'de görüşme kayıtlarını, cevapsız çağrıları ve arama geçmişini görüntüleyebilirsiniz.
                                </p>
                                
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="bulutfonEnabled" name="bulutfonEnabled" onclick="toggleBulutfonFields()" style="width: 20px; height: 20px;">
                                        <span style="font-weight: 600;">Bulutfon Entegrasyonunu Aktif Et</span>
                                    </label>
                                </div>
                                
                                <div id="bulutfon-api-settings" style="display: none; padding: 15px; background: #f5f5f5; border-radius: 8px; margin-top: 15px;">
                                    <div style="background: #e3f2fd; padding: 15px; border-radius: 6px; border-left: 4px solid #2196F3; margin-bottom: 20px;">
                                        <h5 style="margin: 0 0 10px 0; color: #1976d2; font-size: 14px;">📋 API Bilgileri</h5>
                                        <div style="font-size: 13px; color: #333; line-height: 1.6;">
                                            <p style="margin: 5px 0;"><strong>API URL:</strong> <code>https://api.bulutfon.com</code></p>
                                            <p style="margin: 5px 0;"><strong>Dokümentasyon:</strong> <a href="https://www.bulutfon.com/developers" target="_blank" style="color: #1976d2;">https://www.bulutfon.com/developers</a></p>
                                            <p style="margin: 5px 0;"><strong>Gerekli İzinler:</strong> CDR (Call Detail Records) okuma yetkisi</p>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="bulutfonApiKey">Bulutfon API Key *</label>
                                        <input type="text" id="bulutfonApiKey" name="bulutfonApiKey" class="form-control" placeholder="API Key'inizi buraya girin">
                                        <small style="color: #666; display: block; margin-top: 5px;">
                                            💡 Bulutfon panelinden <strong>Ayarlar → API</strong> bölümünden API key'inizi alabilirsiniz.
                                        </small>
                                    </div>
                                    
                                    <div style="background: #fff3cd; padding: 12px; border-radius: 6px; border-left: 4px solid #ff9800; margin-top: 15px;">
                                        <p style="margin: 0; font-size: 13px; color: #856404;">
                                            <strong>⚠️ Önemli:</strong> Bulutfon hesabınızda <strong>CDR (Call Detail Records)</strong> özelliğinin aktif olması gerekir.
                                            API key'i girdikten sonra "Bağlantıyı Test Et" butonu ile test edebilirsiniz.
                                        </p>
                                    </div>
                                    
                                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                                        <button type="button" class="btn btn-primary" onclick="saveBulutfonSettings()">
                                            💾 Kaydet
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="testBulutfonConnection()">
                                            🔌 Bağlantıyı Test Et
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">🔔 Webhook Ayarları (Üye Kayıt Bildirimleri)</h4>
                                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                                    Kayıt sayfasından üye kaydı tamamlandığında belirtilen webhook URL'sine POST isteği gönderilir. Bu sayede kendi sisteminize otomatik bildirim alabilirsiniz.
                                </p>
                                
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="webhookEnabled" name="webhookEnabled" style="width: 20px; height: 20px;">
                                        <span style="font-weight: 600;">Webhook Bildirimi Aktif</span>
                                    </label>
                                </div>
                                
                                <div id="webhook-settings" style="display: none; padding: 15px; background: #f5f5f5; border-radius: 8px; margin-top: 15px;">
                                    <div style="background: #e8f5e9; padding: 15px; border-radius: 6px; border-left: 4px solid #4caf50; margin-bottom: 20px;">
                                        <h5 style="margin: 0 0 10px 0; color: #2e7d32; font-size: 14px;">📋 Webhook Bilgileri</h5>
                                        <div style="font-size: 13px; color: #333; line-height: 1.6;">
                                            <p style="margin: 5px 0;"><strong>Method:</strong> POST</p>
                                            <p style="margin: 5px 0;"><strong>Content-Type:</strong> application/json</p>
                                            <p style="margin: 5px 0;"><strong>Event Type:</strong> contract_signed</p>
                                            <p style="margin: 5px 0;"><strong>Payload İçeriği:</strong> Üye bilgileri, ödeme planı, sözleşme PDF'i (base64)</p>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="webhookUrl">Webhook URL *</label>
                                        <input type="url" id="webhookUrl" name="webhookUrl" class="form-control" placeholder="https://example.com/webhook/member-registered">
                                        <small style="color: #666; display: block; margin-top: 5px;">
                                            💡 POST isteği gönderilecek URL'yi buraya girin.
                                        </small>
                                    </div>
                                    
                                    <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; border-left: 4px solid #2196f3; margin-top: 15px;">
                                        <p style="margin: 0 0 8px 0; font-size: 13px; color: #1565c0; font-weight: 600;">
                                            📦 Örnek Webhook Payload:
                                        </p>
                                        <pre style="background: #fff; padding: 10px; border-radius: 4px; font-size: 11px; overflow-x: auto; margin: 0;">{
  "event": "contract_signed",
  "Ad_Soyad": "Ahmet Yılmaz",
  "Telefon": "05551234567",
  "TC_Kimlik_No": "12345678901",
  "Adres": "...",
  "branch": "tenis",
  "paymentPlan": [...],
  "contractPdfBase64": "data:application/pdf;base64,...",
  "preRegistrationId": "abc123",
  "timestamp": "2025-01-15T10:30:00.000Z"
}</pre>
                                    </div>
                                    
                                    <button type="button" class="btn btn-secondary" onclick="testWebhook()" style="margin-top: 15px;">
                                        🧪 Webhook'u Test Et
                                    </button>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="margin-top: 20px;">💾 Ayarları Kaydet</button>
                        </form>
                    </div>
                    
                    <!-- Tab Content: Branş Yönetimi -->
                    <div id="settings-tab-branches" class="settings-tab-content">
                        <h3 class="card-title">🏃 Branş Yönetimi</h3>
                        <p style="margin-bottom: 25px; color: #666;">
                            Kulübünüzdeki branşları buradan yönetebilirsiniz. Her branş için özel ders ismi belirleyebilirsiniz.
                        </p>
                        
                        <div class="settings-subsection">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 class="settings-subtitle" id="branchFormTitle" style="margin: 0;">➕ Yeni Branş Ekle</h4>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="resetBranchForm()" style="padding: 6px 12px;">🔄 Formu Temizle</button>
                            </div>
                            <form id="branchForm" onsubmit="addBranch(event)">
                                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 2fr auto;">
                                    <div class="form-group">
                                        <label for="branchId">Branş ID *</label>
                                        <input type="text" id="branchId" name="branchId" class="form-control" placeholder="ornek: futbol" required>
                                        <small style="color: #666; display: block; margin-top: 4px;">Küçük harf, boşluksuz</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="branchName">Branş Adı *</label>
                                        <input type="text" id="branchName" name="branchName" class="form-control" placeholder="Futbol" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="branchIcon">İkon (opsiyonel)</label>
                                        <input type="text" id="branchIcon" name="branchIcon" class="form-control" placeholder="⚽">
                                        <small style="color: #666; display: block; margin-top: 4px;">Emoji - boş bırakırsanız varsayılan ⚽ kullanılır</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="branchLessonName">Ders Adı *</label>
                                        <input type="text" id="branchLessonName" name="branchLessonName" class="form-control" placeholder="Futbol Antrenmanı" required>
                                        <small style="color: #666; display: block; margin-top: 4px;">Mesajlarda görünecek</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="branchCourts">Sahalar (opsiyonel)</label>
                                        <input type="text" id="branchCourts" name="branchCourts" class="form-control" placeholder="Saha 1, Saha 2, Merkez Saha">
                                        <small style="color: #666; display: block; margin-top: 4px;">Virgülle ayırın. Birden fazla saha varsa ders planında saha seçimi görünecek</small>
                                    </div>
                                    <div class="form-group">
                                        <label style="visibility: hidden;">Ekle</label>
                                        <button type="submit" id="branchSubmitBtn" class="btn btn-primary">➕ Ekle</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <div class="settings-subsection">
                            <h4 class="settings-subtitle">📋 Mevcut Branşlar</h4>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 60px;">İkon</th>
                                            <th>Branş ID</th>
                                            <th>Branş Adı</th>
                                            <th>Ders Adı</th>
                                            <th>Sahalar</th>
                                            <th style="width: 120px;">İşlemler</th>
                                        </tr>
                                    </thead>
                                    <tbody id="branchesTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Content: Gider Kategorileri -->
                    <div id="settings-tab-expense-categories" class="settings-tab-content">
                        <h3 class="card-title">💸 Gider Kategorileri Yönetimi</h3>
                        <p style="margin-bottom: 25px; color: #666;">
                            Gider kategorilerinizi buradan yönetebilirsiniz. Varsayılan kategoriler: Kira, Maaş, Fatura, Malzeme, Diğer
                        </p>
                        
                        <div class="settings-subsection">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 class="settings-subtitle" id="expenseCategoryFormTitle" style="margin: 0;">➕ Yeni Kategori Ekle</h4>
                            </div>
                            <form id="expenseCategoryForm" onsubmit="addExpenseCategory(event)" style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 30px;">
                                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                                    <label for="newExpenseCategoryName">Kategori Adı *</label>
                                    <input type="text" id="newExpenseCategoryName" class="form-control" placeholder="Örn: Elektrik, Su, Doğalgaz" required>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="newExpenseCategoryIcon">İkon</label>
                                    <input type="text" id="newExpenseCategoryIcon" class="form-control" placeholder="⚡" style="width: 80px; text-align: center;">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <button type="submit" class="btn btn-primary">➕ Ekle</button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="settings-subsection">
                            <h4 class="settings-subtitle">📋 Mevcut Kategoriler</h4>
                            <div id="expenseCategoriesContainer">
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                                    <!-- Varsayılan Kategoriler -->
                                    <div class="expense-category-card" data-category="Kira">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 24px;">🏠</span>
                                            <span style="font-weight: 600;">Kira</span>
                                        </div>
                                        <span style="font-size: 11px; color: #666; margin-top: 5px;">Varsayılan</span>
                                    </div>
                                    <div class="expense-category-card" data-category="Maaş">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 24px;">💰</span>
                                            <span style="font-weight: 600;">Maaş</span>
                                        </div>
                                        <span style="font-size: 11px; color: #666; margin-top: 5px;">Varsayılan</span>
                                    </div>
                                    <div class="expense-category-card" data-category="Fatura">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 24px;">📄</span>
                                            <span style="font-weight: 600;">Fatura</span>
                                        </div>
                                        <span style="font-size: 11px; color: #666; margin-top: 5px;">Varsayılan</span>
                                    </div>
                                    <div class="expense-category-card" data-category="Malzeme">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 24px;">🔧</span>
                                            <span style="font-weight: 600;">Malzeme</span>
                                        </div>
                                        <span style="font-size: 11px; color: #666; margin-top: 5px;">Varsayılan</span>
                                    </div>
                                    <div class="expense-category-card" data-category="Diğer">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 24px;">📦</span>
                                            <span style="font-weight: 600;">Diğer</span>
                                        </div>
                                        <span style="font-size: 11px; color: #666; margin-top: 5px;">Varsayılan</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Content: Yönetici Yönetimi -->
                    <div id="settings-tab-users" class="settings-tab-content">
                        <div id="user-management-card">
                            <h3 class="card-title">👥 Yönetici Yönetimi</h3>
                     <form id="userForm">
                         <div class="form-grid">
                             <div class="form-group">
                                 <label for="userFullName">Ad Soyad *</label>
                                 <input type="text" class="form-control" name="fullName" required>
                             </div>
                             <div class="form-group">
                                 <label for="userPhone">Telefon *</label>
                                 <input type="tel" class="form-control" name="phone" required>
                             </div>
                             <div class="form-group">
                                 <label for="userUsername">Kullanıcı Adı (Telefon)</label>
                                 <input type="text" class="form-control" name="username" autocomplete="username" readonly>
                             </div>
                             <div class="form-group">
                                 <label for="userPassword">Şifre *</label>
                                 <input type="password" class="form-control" name="password" autocomplete="new-password" required>
                             </div>
                        </div>
                         <div class="form-group">
                              <label>Yetkiler</label>
                              <div class="permissions-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                                  <strong style="grid-column: 1 / -1; color: #1976d2; margin-bottom: 5px;">💰 Finansal Yetkiler</strong>
                                  <label><input type="checkbox" name="permissions" value="view_payments"> Ödemeleri Görüntüleme</label>
                                  <label><input type="checkbox" name="permissions" value="edit_payments"> Ödemeleri Düzenleme</label>
                                  <label><input type="checkbox" name="permissions" value="delete_payments"> Ödemeleri Silme</label>
                                  <label><input type="checkbox" name="permissions" value="export_payments"> Ödemeleri Dışa Aktarma</label>
                                  
                                  <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">👥 Üye Yetkileri</strong>
                                  <label><input type="checkbox" name="permissions" value="view_members"> Üyeleri Görüntüleme</label>
                                  <label><input type="checkbox" name="permissions" value="add_members"> Üye Ekleme</label>
                                  <label><input type="checkbox" name="permissions" value="edit_members"> Üye Düzenleme</label>
                                  <label><input type="checkbox" name="permissions" value="delete_members"> Üye Silme</label>
                                  <label><input type="checkbox" name="permissions" value="export_members"> Üyeleri Dışa Aktarma</label>
                                  
                                  <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">📞 CRM Yetkileri</strong>
                                  <label><input type="checkbox" name="permissions" value="view_crm"> CRM Görüntüleme</label>
                                  <label><input type="checkbox" name="permissions" value="add_crm"> CRM'e Ekleme</label>
                                  <label><input type="checkbox" name="permissions" value="edit_crm"> CRM Düzenleme</label>
                                  <label><input type="checkbox" name="permissions" value="delete_crm"> CRM'den Silme</label>
                                  <label><input type="checkbox" name="permissions" value="view_calls"> Arama Kayıtlarını Görüntüleme</label>
                                  
                                  <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">💬 İletişim Yetkileri</strong>
                                  <label><input type="checkbox" name="permissions" value="send_messages"> Mesaj Gönderme</label>
                                  <label><input type="checkbox" name="permissions" value="send_bulk_messages"> Toplu Mesaj Gönderme</label>
                                  <label><input type="checkbox" name="permissions" value="view_message_history"> Mesaj Geçmişini Görüntüleme</label>
                                  
                                  <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">📊 Raporlar ve İstatistikler</strong>
                                  <label><input type="checkbox" name="permissions" value="view_stats"> İstatistikleri Görüntüleme</label>
                                  <label><input type="checkbox" name="permissions" value="view_reports"> Raporları Görüntüleme</label>
                                  <label><input type="checkbox" name="permissions" value="export_reports"> Raporları Dışa Aktarma</label>
                                  
                                  <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">⚙️ Ayarlar ve Yönetim</strong>
                                  <label><input type="checkbox" name="permissions" value="manage_users"> Kullanıcı Yönetimi</label>
                                  <label><input type="checkbox" name="permissions" value="manage_settings"> Ayarları Yönetme</label>
                                  <label><input type="checkbox" name="permissions" value="manage_branches"> Branş Yönetimi</label>
                                  <label><input type="checkbox" name="permissions" value="manage_groups"> Grup Yönetimi</label>
                                  
                                  <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">📋 Yoklama ve Takvim</strong>
                                  <label><input type="checkbox" name="permissions" value="view_attendance"> Yoklama Görüntüleme</label>
                                  <label><input type="checkbox" name="permissions" value="edit_attendance"> Yoklama Düzenleme</label>
                                  <label><input type="checkbox" name="permissions" value="manage_schedule"> Takvim Yönetimi</label>
                              </div>
                         </div>
                         <button type="submit" class="btn btn-success">👤 Kullanıcı Ekle</button>
                     </form>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead><tr><th>Ad Soyad</th><th>Telefon (K. Adı)</th><th>Branşlar</th><th>İzinler</th><th>İşlemler</th></tr></thead>
                                    <tbody id="usersTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Content: Sözleşme Şablonu -->
                    <div id="settings-tab-contract" class="settings-tab-content">
                        <h3 class="card-title">📄 Kulüp Sözleşme Şablonu</h3>
                        <p style="margin-bottom: 25px; color: #666;">
                            Ön kayıt yapan üyelerin sözleşme onayı sırasında gösterilecek sözleşme şablonunu düzenleyin.
                        </p>
                        
                        <!-- Kulübe Özel Sözleşme Linki -->
                        <div id="contractLinkSection" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; color: white;">
                            <h4 style="margin-top: 0; color: white;">🔗 Üyelik Kayıt Linki</h4>
                            <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                                <strong style="font-size: 16px;">🏢 Kulüp Adı:</strong> <span id="contractClubName" style="font-size: 16px; font-weight: 600;">Yükleniyor...</span>
                            </div>
                            <p style="margin-bottom: 15px; opacity: 0.9;">Ön kayıtlı üyelerinizin sözleşmeyi tamamlaması için bu linki paylaşın:</p>
                            <div style="display: flex; gap: 10px; align-items: center; background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
                                <input 
                                    type="text" 
                                    id="contractLink" 
                                    readonly 
                                    style="flex: 1; padding: 10px; border: none; border-radius: 6px; font-family: monospace; font-size: 14px;"
                                    value="Yükleniyor..."
                                />
                                <button 
                                    onclick="copyContractLink()" 
                                    class="btn btn-success"
                                    style="white-space: nowrap; padding: 10px 20px;">
                                    📋 Kopyala
                                </button>
                                <a 
                                    id="contractLinkOpen"
                                    href="#" 
                                    target="_blank"
                                    class="btn"
                                    style="background: white; color: #667eea; white-space: nowrap; padding: 10px 20px; text-decoration: none;">
                                    🔗 Aç
                                </a>
                            </div>
                        </div>
                        
                        <form id="contractTemplateForm" onsubmit="saveContractTemplate(event)">
                            <!-- Genel Ayarlar -->
                            <div class="settings-subsection">
                                <h4 style="color: #667eea; margin-bottom: 15px;">🎨 Sayfa Başlıkları</h4>
                                
                                <div class="form-group">
                                    <label for="contract-page-title">Sayfa Ana Başlığı</label>
                                    <input type="text" id="contract-page-title" name="pageTitle" class="form-control" placeholder="Örn: Spor Kulübü" value="Spor Kulübü">
                                    <small style="color: #666;">Sözleşme sayfasının en üstündeki başlık</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="contract-page-subtitle">Sayfa Alt Başlığı</label>
                                    <input type="text" id="contract-page-subtitle" name="pageSubtitle" class="form-control" placeholder="Örn: Üyelik Sözleşmesi" value="Üyelik Sözleşmesi">
                                </div>
                            </div>
                            
                            <!-- Onay Kutuları -->
                            <div class="settings-subsection">
                                <h4 style="color: #667eea; margin-bottom: 15px;">✅ Onay Kutuları</h4>
                                <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">
                                    📌 Kayıt formunda gösterilecek onay kutularının metinlerini düzenleyin. Boş bırakırsanız o kutu kayıt sayfasında gösterilmez.
                                </p>
                                
                                <div class="form-group">
                                    <label for="contract-checkbox1-text">
                                        <strong>1. Onay Kutusu:</strong> Sözleşme Onayı
                                    </label>
                                    <input 
                                        type="text" 
                                        id="contract-checkbox1-text" 
                                        name="checkbox1Text" 
                                        class="form-control" 
                                        placeholder="Üyelik sözleşmesini okudum, anladım ve kabul ediyorum."
                                        value="Üyelik sözleşmesini okudum, anladım ve kabul ediyorum.">
                                    <small style="color: #666;">
                                        ✅ Zorunlu alan: Kullanıcının sözleşmeyi kabul etmesi için gösterilir
                                    </small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="contract-checkbox2-text">
                                        <strong>2. Onay Kutusu:</strong> İptal ve Üyelik Politikası
                                    </label>
                                    <textarea 
                                        id="contract-checkbox2-text" 
                                        name="checkbox2Text" 
                                        class="form-control" 
                                        rows="3"
                                        placeholder="Üyeliğiniz iptal edilene kadar devam etmektedir..."
                                    >Üyeliğiniz iptal edilene kadar devam etmektedir. Her ayın 14'ü, yeni dönem için kayıt iptali yapılabilecek son gündür. Bu tarihe kadar iptal edilmeyen kayıtlar, devam eden dönem için geçerli sayılır.</textarea>
                                    <small style="color: #666;">
                                        ⚙️ İsteğe bağlı: İptal politikası veya ek bilgilendirme için. Boş bırakırsanız gösterilmez.
                                    </small>
                                </div>
                                
                                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-top: 15px;">
                                    <strong>💡 İpucu:</strong>
                                    <ul style="margin: 10px 0 0 20px; padding: 0;">
                                        <li>İkinci onay kutusunu kullanmak istemiyorsanız alanı <strong>tamamen boş</strong> bırakın</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <!-- Kayıt Tamamlandı Mesajı -->
                            <div class="settings-subsection">
                                <h4 style="color: #667eea; margin-bottom: 15px;">🎉 Kayıt Tamamlandı Mesajı</h4>
                                <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">
                                    Üye sözleşmeyi onaylayıp kaydını tamamladıktan sonra gösterilecek başarı mesajını düzenleyin.
                                </p>
                                
                                <div class="form-group">
                                    <label for="contract-success-title">Başarı Mesajı Başlığı</label>
                                    <input 
                                        type="text" 
                                        id="contract-success-title" 
                                        name="successTitle" 
                                        class="form-control" 
                                        placeholder="Örn: Kayıt İşleminiz Tamamlandı!"
                                        value="Kayıt İşleminiz Tamamlandı!"
                                        oninput="updateSuccessPreview()">
                                    <small style="color: #666;">Başarı sayfasının ana başlığı</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="contract-success-message">Başarı Mesajı İçeriği</label>
                                    <textarea 
                                        id="contract-success-message" 
                                        name="successMessage" 
                                        class="form-control" 
                                        rows="4"
                                        placeholder="Ailemize hoş geldiniz! Üyelik sözleşmeniz başarıyla tamamlandı..."
                                    >Ailemize hoş geldiniz! Üyelik sözleşmeniz kulübümüze başarıyla ulaşmıştır. En kısa sürede sizinle iletişime geçeceğiz.</textarea>
                                    <small style="color: #666;">Başarı sayfasında gösterilecek detaylı mesaj</small>
                                </div>
                                
                                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3; margin-top: 15px;">
                                    <strong>💡 İpucu:</strong>
                                    <ul style="margin: 10px 0 0 20px; padding: 0;">
                                        <li>Bu mesaj, üye sözleşmeyi imzalayıp "Kaydı Tamamla" butonuna tıkladıktan sonra gösterilir</li>
                                        <li>İletişim bilgilerinizi ekleyerek üyelerinize nasıl ulaşabileceklerini belirtebilirsiniz</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <!-- Sözleşme İçeriği -->
                            <div class="settings-subsection">
                                <h4 style="color: #667eea; margin-bottom: 15px;">📜 Sözleşme İçeriği</h4>
                                
                                <!-- Placeholder Açıklaması -->
                                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                                    <strong>📌 Kullanılabilir Placeholder'lar:</strong><br>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; font-size: 0.9em;">
                                        <div style="grid-column: 1 / -1; background: #e3f2fd; padding: 8px; border-radius: 4px; margin-bottom: 5px;"><strong>👤 Üye Bilgileri:</strong></div>
                                        <div><code>{UYE_AD_SOYAD}</code> - Üye/Veli adı</div>
                                        <div><code>{UYE_TCKN}</code> - TC Kimlik No</div>
                                        <div><code>{UYE_DOGUM_TARIHI}</code> - Doğum tarihi</div>
                                        <div><code>{UYE_TELEFON}</code> - Telefon</div>
                                        <div><code>{UYE_ADRES}</code> - Adres</div>
                                        <div><code>{BRANS}</code> - Branş</div>
                                        <div><code>{OGRENCI_AD_SOYAD}</code> - Öğrenci adı</div>
                                        <div><code>{OGRENCI_DOGUM_TARIHI}</code> - Öğrenci doğum tarihi</div>
                                        <div><code>{TARIH}</code> - Sözleşme tarihi</div>
                                        
                                        <div style="grid-column: 1 / -1; background: #fff3cd; padding: 8px; border-radius: 4px; margin-top: 5px;"><strong>📋 Özel Alanlar:</strong></div>
                                        <div style="grid-column: 1 / -1;"><code>{AIDAT_TAKVIMI}</code> - Aidat takvimi tablosu (otomatik oluşur)</div>
                                        <div style="grid-column: 1 / -1;"><code>{OGRENCI_BILGILERI}</code> - Reşit olmayan öğrenci bilgileri (çocuk kaydında otomatik eklenir)</div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <label for="contractTemplate" style="margin: 0;">Sözleşme Metni (HTML)</label>
                                        <button type="button" onclick="previewContractPDF()" class="btn btn-sm btn-info" style="padding: 5px 15px;">
                                            📄 PDF Önizleme
                                        </button>
                                    </div>
                                    <textarea 
                                        id="contractTemplate" 
                                        name="contractText" 
                                        class="form-control" 
                                        rows="20" 
                                        style="font-family: 'Courier New', monospace; font-size: 13px; white-space: pre-wrap;"
                                        placeholder="Kulüp sözleşme metnini buraya yazın...

HTML kullanabilirsiniz. Örnek:
<h4>ÜYELİK SÖZLEŞMESİ</h4>
<p><strong>1-) TARAFLAR</strong></p>
<p><strong>A-KULÜP</strong><br>
Adı-Soyadı: {KULUP_YETKILI}<br>
Ünvanı: {KULUP_ADI}<br>
Adres: {KULUP_ADRES}<br>
Vergi No: {KULUP_VERGI_NO}<br>
Telefon: {KULUP_TELEFON}<br>
E-mail: {KULUP_EMAIL}</p>
<p><strong>B-ÜYE/VELİ</strong><br>
Adı-Soyadı: {UYE_AD_SOYAD}<br>
Doğum Tarihi: {UYE_DOGUM_TARIHI}<br>
TCKN: {UYE_TCKN}<br>
Telefon: {UYE_TELEFON}<br>
Adres: {UYE_ADRES}<br>
Branş: {BRANS}<br>
Öğrenci Adı: {OGRENCI_AD_SOYAD}<br>
</p>

<p><strong>Sözleşme Tarihi:</strong> {TARIH}</p>"></textarea>
                                    <small style="color: #666;">
                                        <strong>💡 İpucu:</strong> HTML etiketleri kullanabilirsiniz. Yukarıdaki placeholder'ları kullanarak üye bilgileri otomatik doldurulur.
                                    </small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="contract-enabled" name="contractEnabled" style="width: auto;">
                                    <label for="contract-enabled" style="margin: 0;">Bu sözleşme şablonunu etkinleştir</label>
                                </div>
                            </div>
                            
                            <div class="settings-subsection" style="margin-top: 30px; background: #f0f9ff; padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary-color);">
                                <h4 style="margin-bottom: 10px; color: var(--primary-color);">💳 Branş Bazlı Ödeme Bilgileri</h4>
                                <p style="margin-bottom: 20px; color: #666; font-size: 0.9em;">
                                    Her branş için farklı IBAN tanımlayabilirsiniz. Üye sözleşmeyi tamamladığında kendi branşının IBAN bilgilerini görecek.
                                </p>
                                
                                <!-- Dinamik Branş IBAN Alanları -->
                                <div id="dynamic-branch-iban-container">
                                    <!-- JavaScript ile doldurulacak -->
                                </div>
                                
                                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                                    <strong>💡 İpucu:</strong>
                                    <ul style="margin: 10px 0 0 20px; padding: 0;">
                                        <li>Her branş için farklı hesap bilgileri tanımlayabilirsiniz</li>
                                        <li>Üye sözleşmeyi tamamladığında sadece kendi branşının IBAN'larını görür</li>
                                        <li>İkinci hesap alanı isteğe bağlıdır, boş bırakabilirsiniz</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">💾 Sözleşme Şablonunu Kaydet</button>
                        </form>
                    </div>
                    
                    <!-- Tab Content: Mesaj Şablonları -->
                    <div id="settings-tab-templates" class="settings-tab-content">
                        <h3 class="card-title">📝 Üye Mesaj Şablonları</h3>
                        <p style="margin-bottom: 15px; color: #666;">
                            Bu şablonlar <strong>kayıtlı üyeler</strong> için otomatik mesaj gönderimi için kullanılır. 
                            Doğum günü, aidat hatırlatma, devamsızlık gibi otomatik mesajları buradan düzenleyebilirsiniz.
                            <strong>{UYE_AD_SOYAD}</strong>, <strong>{OGRENCI_AD_SOYAD}</strong>, <strong>{TUTAR}</strong>, <strong>{TARIH}</strong> gibi değişkenleri kullanabilirsiniz.
                        </p>
                        <div style="background: #f0f8ff; padding: 12px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #0066cc;">
                            <strong>💡 Değişken Sistemi:</strong><br>
                            <strong>{UYE_AD_SOYAD}:</strong> Yetişkinde üyenin kendisi, çocukta veli adı<br>
                            <strong>{OGRENCI_AD_SOYAD}:</strong> Sadece çocuk şablonlarında kullanılır, öğrencinin adı
                        </div>

                        <!-- Branş Sekmeleri (Dinamik) -->
                        <div class="settings-tabs" id="branchTemplateTabsContainer" style="margin-bottom: 20px;">
                            <!-- Branş sekmeleri JavaScript ile doldurulacak -->
                        </div>

                        <form id="templatesForm" onsubmit="saveMessageTemplates(event)">
                            
                            <!-- Dinamik Branş Şablonları -->
                            <div id="dynamicBranchTemplatesContainer">
                                <!-- Branş şablonları JavaScript ile doldurulacak -->
                            </div>
                            
                            <!-- TENİS BRANŞI ŞABLONLARI (ESKİ - SİLİNECEK) -->
                            <div id="branch-templates-tenis" class="branch-templates-content" style="display: none;">
                                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
                                    <strong>🎾 Tenis Branşı</strong><br>
                                    <p style="margin: 5px 0 0 0; color: #666;">Tenis branşındaki üyeler için aşağıdaki mesaj şablonları kullanılacaktır.</p>
                                </div>

                            <!-- Doğum Günü Şablonu -->
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">🎂 Doğum Günü Kutlama Şablonu</h4>
                                
                                <!-- Çocuk Üyeler İçin -->
                                <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                    <label for="template-birthday-child" style="font-weight: 600; color: #4CAF50;">👶 Çocuk Üyeler İçin (Veliye gönderilir)</label>
                                    <div style="position: relative;">
                                        <textarea id="template-birthday-child" name="birthdayChild" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, Tenisçimiz {OGRENCI_AD_SOYAD}'nın doğum gününü kutlarız! 🎂🎾"></textarea>
                                        <button type="button" onclick="copyTemplateText('template-birthday-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                    </div>
                                    <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code></small>
                                </div>
                                
                                <!-- Yetişkin Üyeler İçin -->
                                <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                    <label for="template-birthday-adult" style="font-weight: 600; color: #2196F3;">👤 Yetişkin Üyeler İçin</label>
                                    <div style="position: relative;">
                                        <textarea id="template-birthday-adult" name="birthdayAdult" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, Doğum gününüzü kutlarız! 🎂🎾"></textarea>
                                        <button type="button" onclick="copyTemplateText('template-birthday-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                    </div>
                                    <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code></small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                    <input type="checkbox" id="birthday-enabled" name="birthdayEnabled" style="width: auto;">
                                    <label for="birthday-enabled" style="margin: 0;">Otomatik doğum günü mesajlarını etkinleştir</label>
                                </div>
                            </div>

                            <!-- Gecikmiş Aidat Şablonu -->
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">💰 Gecikmiş Aidat Hatırlatma Şablonu</h4>
                                
                                <!-- Çocuk Üyeler İçin -->
                                <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                    <label for="template-payment-child" style="font-weight: 600; color: #4CAF50;">👶 Çocuk Üyeler İçin (Veliye gönderilir)</label>
                                    <div style="position: relative;">
                                        <textarea id="template-payment-child" name="paymentChild" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, Velisi olduğunuz {OGRENCI_AD_SOYAD} için {TUTAR} TL ödemeniz {TARIH} tarihinden beri gecikmiştir."></textarea>
                                        <button type="button" onclick="copyTemplateText('template-payment-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                    </div>
                                    <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code>, <code>{TUTAR}</code>, <code>{TARIH}</code>, <code>{DONEM_BASLANGIC}</code>, <code>{DONEM_BITIS}</code>, <code>{DERS_SAYISI}</code></small>
                                </div>
                                
                                <!-- Yetişkin Üyeler İçin -->
                                <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                    <label for="template-payment-adult" style="font-weight: 600; color: #2196F3;">👤 Yetişkin Üyeler İçin</label>
                                    <div style="position: relative;">
                                        <textarea id="template-payment-adult" name="paymentAdult" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, {TUTAR} TL ödemeniz {TARIH} tarihinden beri gecikmiştir."></textarea>
                                        <button type="button" onclick="copyTemplateText('template-payment-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                    </div>
                                    <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code>, <code>{TUTAR}</code>, <code>{TARIH}</code>, <code>{DONEM_BASLANGIC}</code>, <code>{DONEM_BITIS}</code>, <code>{DERS_SAYISI}</code></small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                    <input type="checkbox" id="payment-enabled" name="paymentEnabled" style="width: auto;">
                                    <label for="payment-enabled" style="margin: 0;">Bu şablonu etkinleştir</label>
                                </div>
                            </div>

                            <!-- Devamsızlık Şablonu -->
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">📅 Devamsızlık Bildirimi Şablonu</h4>
                                
                                <!-- Çocuk Üyeler İçin -->
                                <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                    <label for="template-absence-child" style="font-weight: 600; color: #4CAF50;">👶 Çocuk Üyeler İçin (Veliye gönderilir)</label>
                                    <div style="position: relative;">
                                        <textarea id="template-absence-child" name="absenceChild" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, Velisi olduğunuz {OGRENCI_AD_SOYAD}'nın {TARIH} tarihindeki {DERS} dersine katılamadığını fark ettik..."></textarea>
                                        <button type="button" onclick="copyTemplateText('template-absence-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                    </div>
                                    <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code> (veli adı), <code>{OGRENCI_AD_SOYAD}</code> (öğrenci adı), <code>{TARIH}</code>, <code>{DERS}</code></small>
                                </div>
                                
                                <!-- Yetişkin Üyeler İçin -->
                                <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                    <label for="template-absence-adult" style="font-weight: 600; color: #2196F3;">👤 Yetişkin Üyeler İçin</label>
                                    <div style="position: relative;">
                                        <textarea id="template-absence-adult" name="absenceAdult" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, {TARIH} tarihindeki {DERS} dersine katılamadığınızı fark ettik..."></textarea>
                                        <button type="button" onclick="copyTemplateText('template-absence-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                    </div>
                                    <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code> (üye adı), <code>{TARIH}</code>, <code>{DERS}</code></small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                    <input type="checkbox" id="absence-enabled" name="absenceEnabled" style="width: auto;">
                                    <label for="absence-enabled" style="margin: 0;">Bu şablonu etkinleştir</label>
                                </div>
                            </div>

                            <!-- Genel Duyuru Şablonu -->
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">📢 Genel Duyuru Şablonu</h4>
                                
                                <!-- Çocuk Üyeler İçin -->
                                <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                    <label for="template-announcement-child" style="font-weight: 600; color: #4CAF50;">👶 Çocuk Üyeler İçin (Veliye gönderilir)</label>
                                    <div style="position: relative;">
                                        <textarea id="template-announcement-child" name="announcementChild" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, Velisi olduğunuz {OGRENCI_AD_SOYAD} ile ilgili duyuru: {MESAJ}"></textarea>
                                        <button type="button" onclick="copyTemplateText('template-announcement-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                    </div>
                                    <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code>, <code>{MESAJ}</code></small>
                                </div>
                                
                                <!-- Yetişkin Üyeler İçin -->
                                <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                    <label for="template-announcement-adult" style="font-weight: 600; color: #2196F3;">👤 Yetişkin Üyeler İçin</label>
                                    <div style="position: relative;">
                                        <textarea id="template-announcement-adult" name="announcementAdult" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, Kulübümüzden duyuru: {MESAJ}"></textarea>
                                        <button type="button" onclick="copyTemplateText('template-announcement-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                    </div>
                                    <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code>, <code>{MESAJ}</code></small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                    <input type="checkbox" id="announcement-enabled" name="announcementEnabled" style="width: auto;">
                                    <label for="announcement-enabled" style="margin: 0;">Bu şablonu etkinleştir</label>
                                </div>
                            </div>

                            <!-- Yaklaşan Ödeme Hatırlatma Şablonu -->
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">⏰ Yaklaşan Ödeme Hatırlatma Şablonu</h4>
                                
                                <!-- Çocuk Üyeler İçin -->
                                <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                    <label for="template-upcomingPayment-child" style="font-weight: 600; color: #4CAF50;">👶 Çocuk Üyeler İçin (Veliye gönderilir)</label>
                                    <div style="position: relative;">
                                        <textarea id="template-upcomingPayment-child" name="upcomingPaymentChild" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, Velisi olduğunuz {OGRENCI_AD_SOYAD} için {TARIH} tarihinde {TUTAR} TL ödemeniz bulunmaktadır."></textarea>
                                        <button type="button" onclick="copyTemplateText('template-upcomingPayment-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                    </div>
                                    <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code>, <code>{TUTAR}</code>, <code>{TARIH}</code>, <code>{GUN_KALDI}</code>, <code>{DONEM_BASLANGIC}</code>, <code>{DONEM_BITIS}</code>, <code>{DERS_SAYISI}</code></small>
                                </div>
                                
                                <!-- Yetişkin Üyeler İçin -->
                                <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                    <label for="template-upcomingPayment-adult" style="font-weight: 600; color: #2196F3;">👤 Yetişkin Üyeler İçin</label>
                                    <div style="position: relative;">
                                        <textarea id="template-upcomingPayment-adult" name="upcomingPaymentAdult" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, {TARIH} tarihinde {TUTAR} TL ödemeniz bulunmaktadır."></textarea>
                                        <button type="button" onclick="copyTemplateText('template-upcomingPayment-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                    </div>
                                    <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code>, <code>{TUTAR}</code>, <code>{TARIH}</code>, <code>{GUN_KALDI}</code>, <code>{DONEM_BASLANGIC}</code>, <code>{DONEM_BITIS}</code>, <code>{DERS_SAYISI}</code></small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                    <input type="checkbox" id="upcomingPayment-enabled" name="upcomingPaymentEnabled" style="width: auto;">
                                    <label for="upcomingPayment-enabled" style="margin: 0;">Bu şablonu etkinleştir</label>
                                </div>
                            </div>

                            <!-- Bekleyen Kayıt Hatırlatma Şablonu -->
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">⏳ Bekleyen Kayıt Hatırlatma Şablonu</h4>
                                
                                <!-- Çocuk Üyeler İçin -->
                                <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                    <label for="template-pendingRegistration-child" style="font-weight: 600; color: #4CAF50;">👶 Çocuk Üyeler İçin (Veliye gönderilir)</label>
                                    <div style="position: relative;">
                                        <textarea id="template-pendingRegistration-child" name="tenis_pendingRegistrationChild" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, Kulübümüze {OGRENCI_AD_SOYAD} için ön kaydınız alınmıştır ancak kayıt işlemleriniz henüz tamamlanmamıştır."></textarea>
                                        <button type="button" onclick="copyTemplateText('template-pendingRegistration-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                    </div>
                                    <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code>, <code>{LINK}</code>, <code>{TARIH}</code></small>
                                </div>
                                
                                <!-- Yetişkin Üyeler İçin -->
                                <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                    <label for="template-pendingRegistration-adult" style="font-weight: 600; color: #2196F3;">👤 Yetişkin Üyeler İçin</label>
                                    <div style="position: relative;">
                                        <textarea id="template-pendingRegistration-adult" name="tenis_pendingRegistrationAdult" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, Kulübümüze ön kaydınız alınmıştır ancak kayıt işlemleriniz henüz tamamlanmamıştır."></textarea>
                                        <button type="button" onclick="copyTemplateText('template-pendingRegistration-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                    </div>
                                    <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code>, <code>{LINK}</code>, <code>{TARIH}</code></small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                    <input type="checkbox" id="tenis-pendingRegistration-enabled" name="tenis_pendingRegistrationEnabled" style="width: auto;">
                                    <label for="tenis-pendingRegistration-enabled" style="margin: 0;">Bu şablonu etkinleştir</label>
                                </div>
                            </div>

                            <!-- Cevapsız Çağrı Mesaj Şablonu -->
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">📞 Cevapsız Çağrı Mesaj Şablonu</h4>
                                
                                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ff9800;">
                                    <strong>ℹ️ Bilgi</strong><br>
                                    <p style="margin: 5px 0 0 0; color: #666;">Cevapsız çağrı olduğunda otomatik olarak WhatsApp mesajı göndermek için bu şablonları kullanabilirsiniz.</p>
                                </div>
                                
                                <!-- Mesai Saatleri İçinde -->
                                <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                    <label for="template-missedCall-working" style="font-weight: 600; color: #4CAF50;">🕐 Mesai Saatleri İçinde</label>
                                    <div style="position: relative;">
                                        <textarea id="template-missedCall-working" name="missedCallWorkingHours" class="form-control" rows="5" placeholder="Örn: Merhaba,\n\nSize ulaşmaya çalıştık ancak ulaşamadık.\n\n{TARIH} tarihinde bizi aramıştınız.\n\nSizinle görüşmek ve sorularınızı yanıtlamak isteriz. Lütfen uygun olduğunuzda bizi tekrar arayabilirsiniz.\n\nTeşekkürler,"></textarea>
                                        <button type="button" onclick="copyTemplateText('template-missedCall-working')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                    </div>
                                    <small style="color: #666;">Kullanılabilir: <code>{TARIH}</code> (arama tarihi)</small>
                                </div>
                                
                                <!-- Mesai Saatleri Dışında -->
                                <div class="form-group" style="border-left: 4px solid #ff9800; padding-left: 15px; margin-bottom: 20px;">
                                    <label for="template-missedCall-outside" style="font-weight: 600; color: #ff9800;">🌙 Mesai Saatleri Dışında</label>
                                    <div style="position: relative;">
                                        <textarea id="template-missedCall-outside" name="missedCallOutsideHours" class="form-control" rows="6" placeholder="Örn: Merhaba,\n\nSize ulaşmaya çalıştık ancak ulaşamadık.\n\n{TARIH} tarihinde bizi aramıştınız.\n\nŞu anda mesai saatlerimiz dışındayız. Mesai saatlerimiz: {MESAI_SAATLERI}\n\nMesai saatlerinde bizi tekrar arayabilir veya size dönüş yapabiliriz.\n\nTeşekkürler,"></textarea>
                                        <button type="button" onclick="copyTemplateText('template-missedCall-outside')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                    </div>
                                    <small style="color: #666;">Kullanılabilir: <code>{TARIH}</code> (arama tarihi), <code>{MESAI_SAATLERI}</code> (örn: 09:00 - 18:00)</small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                    <input type="checkbox" id="missedCall-enabled" name="missedCallEnabled" style="width: auto;">
                                    <label for="missedCall-enabled" style="margin: 0;">Bu şablonu etkinleştir</label>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 10px; background: #e3f2fd; padding: 12px; border-radius: 8px;">
                                    <input type="checkbox" id="missedCall-autoSend" name="missedCallAutoSend" style="width: auto;">
                                    <label for="missedCall-autoSend" style="margin: 0; font-weight: 600; color: #1976d2;">🤖 Otomatik Gönderim (Cevapsız çağrı olunca hemen mesaj gönder)</label>
                                </div>
                            </div>
                            </div>
                            <!-- TENİS BRANŞI SONU -->
                            
                            <!-- YÜZME BRANŞI ŞABLONLARI -->
                            <div id="branch-templates-yuzme" class="branch-templates-content" style="display: none;">
                                <div style="background: #e1f5fe; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #00bcd4;">
                                    <strong>🏊 Yüzme Branşı</strong><br>
                                    <p style="margin: 5px 0 0 0; color: #666;">Yüzme branşındaki üyeler için aşağıdaki mesaj şablonları kullanılacaktır.</p>
                                </div>
                                
                                <!-- Doğum Günü Şablonu -->
                                <div class="settings-subsection">
                                    <h4 class="settings-subtitle">🎂 Doğum Günü Kutlama Şablonu</h4>
                                    
                                    <!-- Çocuk Üyeler İçin -->
                                    <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                        <label for="template-yuzme-birthday-child" style="font-weight: 600; color: #4CAF50;">👶 Çocuk Üyeler İçin (Veliye gönderilir)</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-birthday-child" name="yuzme_birthdayChild" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, Yüzücümüz {OGRENCI_AD_SOYAD}'nın doğum gününü kutlarız! 🎂🏊"></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-birthday-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                        </div>
                                        <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code></small>
                                    </div>
                                    
                                    <!-- Yetişkin Üyeler İçin -->
                                    <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                        <label for="template-yuzme-birthday-adult" style="font-weight: 600; color: #2196F3;">👤 Yetişkin Üyeler İçin</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-birthday-adult" name="yuzme_birthdayAdult" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, Doğum gününüzü kutlarız! 🎂🏊"></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-birthday-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                        </div>
                                        <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code></small>
                                    </div>
                                    
                                    <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                        <input type="checkbox" id="yuzme-birthday-enabled" name="yuzme_birthdayEnabled" style="width: auto;">
                                        <label for="yuzme-birthday-enabled" style="margin: 0;">Otomatik doğum günü mesajlarını etkinleştir</label>
                                    </div>
                                </div>

                                <!-- Gecikmiş Aidat Şablonu -->
                                <div class="settings-subsection">
                                    <h4 class="settings-subtitle">💰 Gecikmiş Aidat Hatırlatma Şablonu</h4>
                                    
                                    <!-- Çocuk Üyeler İçin -->
                                    <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                        <label for="template-yuzme-payment-child" style="font-weight: 600; color: #4CAF50;">👶 Çocuk Üyeler İçin (Veliye gönderilir)</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-payment-child" name="yuzme_paymentChild" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, Yüzücümüz {OGRENCI_AD_SOYAD} için {TUTAR} TL yüzme kursu ödemeniz {TARIH} tarihinden beri gecikmiştir."></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-payment-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                        </div>
                                        <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code>, <code>{TUTAR}</code>, <code>{TARIH}</code>, <code>{DONEM_BASLANGIC}</code>, <code>{DONEM_BITIS}</code>, <code>{DERS_SAYISI}</code></small>
                                    </div>
                                    
                                    <!-- Yetişkin Üyeler İçin -->
                                    <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                        <label for="template-yuzme-payment-adult" style="font-weight: 600; color: #2196F3;">👤 Yetişkin Üyeler İçin</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-payment-adult" name="yuzme_paymentAdult" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, {TUTAR} TL yüzme kursu ödemeniz {TARIH} tarihinden beri gecikmiştir."></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-payment-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                        </div>
                                        <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code>, <code>{TUTAR}</code>, <code>{TARIH}</code>, <code>{DONEM_BASLANGIC}</code>, <code>{DONEM_BITIS}</code>, <code>{DERS_SAYISI}</code></small>
                                    </div>
                                    
                                    <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                        <input type="checkbox" id="yuzme-payment-enabled" name="yuzme_paymentEnabled" style="width: auto;">
                                        <label for="yuzme-payment-enabled" style="margin: 0;">Bu şablonu etkinleştir</label>
                                    </div>
                                </div>

                                <!-- Devamsızlık Şablonu -->
                                <div class="settings-subsection">
                                    <h4 class="settings-subtitle">📅 Devamsızlık Bildirimi Şablonu</h4>
                                    
                                    <!-- Çocuk Üyeler İçin -->
                                    <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                        <label for="template-yuzme-absence-child" style="font-weight: 600; color: #4CAF50;">👶 Çocuk Üyeler İçin (Veliye gönderilir)</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-absence-child" name="yuzme_absenceChild" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, Yüzücümüz {OGRENCI_AD_SOYAD}'nın {TARIH} tarihindeki yüzme dersine katılamadığını fark ettik..."></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-absence-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                        </div>
                                        <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code> (veli adı), <code>{OGRENCI_AD_SOYAD}</code> (öğrenci adı), <code>{TARIH}</code>, <code>{DERS}</code></small>
                                    </div>
                                    
                                    <!-- Yetişkin Üyeler İçin -->
                                    <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                        <label for="template-yuzme-absence-adult" style="font-weight: 600; color: #2196F3;">👤 Yetişkin Üyeler İçin</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-absence-adult" name="yuzme_absenceAdult" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, {TARIH} tarihindeki yüzme dersine katılamadığınızı fark ettik..."></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-absence-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                        </div>
                                        <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code> (üye adı), <code>{TARIH}</code>, <code>{DERS}</code></small>
                                    </div>
                                    
                                    <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                        <input type="checkbox" id="yuzme-absence-enabled" name="yuzme_absenceEnabled" style="width: auto;">
                                        <label for="yuzme-absence-enabled" style="margin: 0;">Bu şablonu etkinleştir</label>
                                    </div>
                                </div>

                                <!-- Genel Duyuru Şablonu -->
                                <div class="settings-subsection">
                                    <h4 class="settings-subtitle">📢 Genel Duyuru Şablonu</h4>
                                    
                                    <!-- Çocuk Üyeler İçin -->
                                    <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                        <label for="template-yuzme-announcement-child" style="font-weight: 600; color: #4CAF50;">👶 Çocuk Üyeler İçin (Veliye gönderilir)</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-announcement-child" name="yuzme_announcementChild" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, Yüzücümüz {OGRENCI_AD_SOYAD} ile ilgili duyuru: {MESAJ}"></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-announcement-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                        </div>
                                        <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code>, <code>{MESAJ}</code></small>
                                    </div>
                                    
                                    <!-- Yetişkin Üyeler İçin -->
                                    <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                        <label for="template-yuzme-announcement-adult" style="font-weight: 600; color: #2196F3;">👤 Yetişkin Üyeler İçin</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-announcement-adult" name="yuzme_announcementAdult" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, Yüzme kulübümüzden duyuru: {MESAJ}"></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-announcement-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                        </div>
                                        <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code>, <code>{MESAJ}</code></small>
                                    </div>
                                    
                                    <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                        <input type="checkbox" id="yuzme-announcement-enabled" name="yuzme_announcementEnabled" style="width: auto;">
                                        <label for="yuzme-announcement-enabled" style="margin: 0;">Bu şablonu etkinleştir</label>
                                    </div>
                                </div>

                                <!-- Yaklaşan Ödeme Hatırlatma Şablonu -->
                                <div class="settings-subsection">
                                    <h4 class="settings-subtitle">⏰ Yaklaşan Ödeme Hatırlatma Şablonu</h4>
                                    
                                    <!-- Çocuk Üyeler İçin -->
                                    <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                        <label for="template-yuzme-upcomingPayment-child" style="font-weight: 600; color: #4CAF50;">👶 Çocuk Üyeler İçin (Veliye gönderilir)</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-upcomingPayment-child" name="yuzme_upcomingPaymentChild" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, Yüzücümüz {OGRENCI_AD_SOYAD} için {TARIH} tarihinde {TUTAR} TL ödemeniz bulunmaktadır."></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-upcomingPayment-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                        </div>
                                        <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code>, <code>{TUTAR}</code>, <code>{TARIH}</code>, <code>{GUN_KALDI}</code>, <code>{DONEM_BASLANGIC}</code>, <code>{DONEM_BITIS}</code>, <code>{DERS_SAYISI}</code></small>
                                    </div>
                                    
                                    <!-- Yetişkin Üyeler İçin -->
                                    <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                        <label for="template-yuzme-upcomingPayment-adult" style="font-weight: 600; color: #2196F3;">👤 Yetişkin Üyeler İçin</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-upcomingPayment-adult" name="yuzme_upcomingPaymentAdult" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, {TARIH} tarihinde {TUTAR} TL ödemeniz bulunmaktadır."></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-upcomingPayment-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                        </div>
                                        <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code>, <code>{TUTAR}</code>, <code>{TARIH}</code>, <code>{GUN_KALDI}</code>, <code>{DONEM_BASLANGIC}</code>, <code>{DONEM_BITIS}</code>, <code>{DERS_SAYISI}</code></small>
                                    </div>
                                    
                                    <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                        <input type="checkbox" id="yuzme-upcomingPayment-enabled" name="yuzme_upcomingPaymentEnabled" style="width: auto;">
                                        <label for="yuzme-upcomingPayment-enabled" style="margin: 0;">Bu şablonu etkinleştir</label>
                                    </div>
                                </div>

                                <!-- Bekleyen Kayıt Hatırlatma Şablonu -->
                                <div class="settings-subsection">
                                    <h4 class="settings-subtitle">⏳ Bekleyen Kayıt Hatırlatma Şablonu</h4>
                                    
                                    <!-- Çocuk Üyeler İçin -->
                                    <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                        <label for="template-yuzme-pendingRegistration-child" style="font-weight: 600; color: #4CAF50;">👶 Çocuk Üyeler İçin (Veliye gönderilir)</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-pendingRegistration-child" name="yuzme_pendingRegistrationChild" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, Yüzme kulübümüze {OGRENCI_AD_SOYAD} için ön kaydınız alınmıştır ancak kayıt işlemleriniz henüz tamamlanmamıştır."></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-pendingRegistration-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                        </div>
                                        <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code>, <code>{LINK}</code>, <code>{TARIH}</code></small>
                                    </div>
                                    
                                    <!-- Yetişkin Üyeler İçin -->
                                    <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                        <label for="template-yuzme-pendingRegistration-adult" style="font-weight: 600; color: #2196F3;">👤 Yetişkin Üyeler İçin</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-pendingRegistration-adult" name="yuzme_pendingRegistrationAdult" class="form-control" rows="5" placeholder="Örn: Sayın {UYE_AD_SOYAD}, Yüzme kulübümüze ön kaydınız alınmıştır ancak kayıt işlemleriniz henüz tamamlanmamıştır."></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-pendingRegistration-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">📋</button>
                                        </div>
                                        <small style="color: #666;">Kullanılabilir: <code>{UYE_AD_SOYAD}</code>, <code>{LINK}</code>, <code>{TARIH}</code></small>
                                    </div>
                                    
                                    <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                        <input type="checkbox" id="yuzme-pendingRegistration-enabled" name="yuzme_pendingRegistrationEnabled" style="width: auto;">
                                        <label for="yuzme-pendingRegistration-enabled" style="margin: 0;">Bu şablonu etkinleştir</label>
                                    </div>
                                </div>
                            </div>
                            <!-- YÜZME BRANŞI SONU -->
                            
                            <!-- GÖREV ŞABLONLARI -->
                            <div id="branch-templates-gorev" class="branch-templates-content" style="display: none;">
                                <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #9c27b0;">
                                    <strong>📋 Görev Şablonları</strong><br>
                                    <p style="margin: 5px 0 0 0; color: #666;">Görev yönetimi için kullanılan mesaj şablonları.</p>
                                </div>
                                
                                <!-- Görev Bildirimi Şablonu -->
                                <div class="settings-subsection">
                                    <h4 class="settings-subtitle">📋 Görev Bildirimi Şablonu</h4>
                                    <div class="form-group">
                                        <label for="template-task">Mesaj Metni</label>
                                        <textarea id="template-task" name="task" class="form-control" rows="6" placeholder="Örn: Sayın {UYE_AD_SOYAD}, Size yeni bir görev atandı: {GOREV}. Açıklama: {ACIKLAMA}"></textarea>
                                        <small style="color: #666;">Kullanılabilir değişkenler: <code>{UYE_AD_SOYAD}</code>, <code>{GOREV}</code>, <code>{ACIKLAMA}</code>, <code>{TARIH}</code></small>
                                    </div>
                                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="task-enabled" name="taskEnabled" style="width: auto;">
                                        <label for="task-enabled" style="margin: 0;">Görev atandığında otomatik mesaj gönder</label>
                                    </div>
                                </div>

                                <!-- Görev Mesajı Bildirimi Şablonu -->
                                <div class="settings-subsection">
                                    <h4 class="settings-subtitle">💬 Görev Mesajı Bildirimi Şablonu</h4>
                                    <div class="form-group">
                                        <label for="template-taskMessage">Mesaj Metni</label>
                                        <textarea id="template-taskMessage" name="taskMessage" class="form-control" rows="7" placeholder="Örn: Sayın {UYE_AD_SOYAD}, {GOREV} görevi için yeni bir mesaj aldınız: {MESAJ}"></textarea>
                                        <small style="color: #666;">Kullanılabilir değişkenler: <code>{UYE_AD_SOYAD}</code>, <code>{GOREV}</code>, <code>{MESAJ}</code>, <code>{GONDEREN}</code>, <code>{TARIH}</code></small>
                                    </div>
                                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="taskMessage-enabled" name="taskMessageEnabled" style="width: auto;">
                                        <label for="taskMessage-enabled" style="margin: 0;">Görev mesajı eklendiğinde otomatik bildirim gönder</label>
                                    </div>
                                </div>
                            </div>
                            <!-- GÖREV ŞABLONLARI SONU -->

                            <button type="submit" class="btn btn-primary" style="margin-top: 20px;">💾 Şablonları Kaydet</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- WhatsApp Section -->
            <div id="whatsapp" class="section">
                <div class="card">

                    <!-- Tab Content: Mesajlaşma -->
                    <div id="whatsapp-tab-messages" class="settings-tab-content active">
                        <!-- Step 1: Cihaz Seçimi -->
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0;">📱 1. WhatsApp Cihazı Seçin</h4>
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <select id="whatsapp-active-device" class="form-control" style="flex: 1; max-width: 400px;" onchange="onDeviceSelectionChange()">
                                    <option value="">Bir cihaz seçin...</option>
                                </select>
                                <div id="whatsapp-device-info" style="flex: 1; color: #666; font-size: 14px;"></div>
                            </div>
                        </div>

                        <!-- Step 2: Mesajlaşma Alanı (Cihaz seçilince görünür) -->
                        <div id="whatsapp-messaging-area" style="display: none;">
                            <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: calc(100vh - 250px); max-height: 700px;">
                                <!-- Contacts List -->
                                <div style="border-right: 2px solid #eee; padding-right: 15px; display: flex; flex-direction: column; overflow: hidden;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-shrink: 0;">
                                        <h4 style="margin: 0;">💬 Konuşmalar</h4>
                                        <button class="btn btn-success btn-sm" onclick="toggleNewMessageForm()" title="Yeni mesaj gönder">
                                            ✉️ Yeni Mesaj
                                        </button>
                                    </div>
                                    
                                    <!-- Inline Yeni Mesaj Formu - MODERN TASARIM -->
                                    <div id="new-message-inline-form" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                            <strong style="color: white; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                                <span style="background: rgba(255,255,255,0.2); padding: 6px 10px; border-radius: 8px;">✉️</span>
                                                Yeni Mesaj
                                            </strong>
                                            <button onclick="toggleNewMessageForm()" style="background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 24px; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">×</button>
                                        </div>
                                        
                                        <!-- Telefon Numarası Input -->
                                        <div style="margin-bottom: 12px;">
                                            <input type="tel" id="new-message-phone-inline" class="form-control" placeholder="05xxxxxxxxx" style="font-size: 15px; padding: 12px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.95); border-radius: 8px; font-weight: 500;">
                                            <small style="color: rgba(255,255,255,0.9); font-size: 11px; margin-top: 5px; display: block;">📱 Örnek: 05449367543 veya 905449367543</small>
                                        </div>
                                        
                                        <!-- Mesaj Textarea (Başlangıçta gizli) -->
                                        <div id="new-message-text-area" style="display: none;">
                                            <textarea id="new-message-text-inline" class="form-control" rows="4" placeholder="💬 Mesajınızı yazın..." style="font-size: 14px; margin-bottom: 12px; padding: 12px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.95); border-radius: 8px; resize: vertical;"></textarea>
                                            <button class="btn btn-success btn-sm btn-block" onclick="sendNewMessageInline()" style="background: #25D366; border: none; padding: 12px; font-size: 15px; font-weight: 600; border-radius: 8px; box-shadow: 0 2px 8px rgba(37, 211, 102, 0.3); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(37, 211, 102, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(37, 211, 102, 0.3)'">
                                                📤 Mesajı Gönder
                                            </button>
                                        </div>
                                        
                                        <!-- Kontrol Butonu -->
                                        <button id="check-phone-btn" class="btn btn-light btn-sm btn-block" onclick="checkPhoneAndProceed()" style="background: white; border: none; color: #667eea; padding: 12px; font-size: 15px; font-weight: 600; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                                            ▶️ Devam Et
                                        </button>
                                    </div>
                                    
                                    <input type="text" id="contact-search" class="form-control" placeholder="🔍 Kişi ara..." style="margin-bottom: 15px; flex-shrink: 0;">
                                    <div id="whatsapp-contacts-list" style="flex: 1; overflow-y: auto; min-height: 0;">
                                        <p class="empty-state">Yükleniyor...</p>
                                    </div>
                                </div>

                                <!-- Messages Area -->
                                <div style="display: flex; flex-direction: column; overflow: hidden; height: 100%;">
                                    <div id="whatsapp-chat-header" style="padding: 15px; background: #f8f9fa; border-radius: 8px 8px 0 0; border-bottom: 2px solid #ddd; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                                        <div>
                                            <h4 id="whatsapp-selected-contact" style="margin: 0;">Bir kişi seçin</h4>
                                            <small id="whatsapp-selected-phone" style="color: #666;"></small>
                                        </div>
                                        <button id="refresh-messages-btn" class="btn btn-sm btn-secondary" onclick="refreshCurrentMessages()" style="display: none;">
                                            🔄 Yenile
                                        </button>
                                    </div>
                                    
                                    <div id="whatsapp-messages-header" style="display: none; padding: 12px 20px; background: linear-gradient(135deg, #075E54 0%, #128C7E 100%); border-radius: 8px 8px 0 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <!-- Left: Profile & Info -->
                                            <div style="display: flex; align-items: center; gap: 12px; flex: 1; cursor: pointer;" onclick="showContactInfo()">
                                                <!-- Profile Picture with Online Status -->
                                                <div style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                                    <span id="chat-contact-initial">U</span>
                                                </div>
                                                
                                                <!-- Name & Status -->
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="display: flex; align-items: center; gap: 6px;">
                                                        <strong id="chat-contact-name" style="color: white; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px;"></strong>
                                                        <!-- Member/CRM Badge -->
                                                        <span id="chat-contact-badge" style="display: none; font-size: 10px; padding: 2px 6px; border-radius: 10px; color: white;"></span>
                                                    </div>
                                                    <div style="display: flex; align-items: center; gap: 4px; font-size: 12px; color: rgba(255,255,255,0.8);">
                                                        <span id="chat-contact-phone"></span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Right: Action Buttons -->
                                            <div id="chat-action-buttons" style="display: flex; gap: 8px; align-items: center;">
                                                <!-- CRM'e Ekle butonu (sadece unknown tipler için - JavaScript ile eklenir) -->
                                                
                                                <!-- Search Messages -->
                                                <button onclick="searchInMessages()" title="Mesajlarda Ara" style="background: rgba(255,255,255,0.15); color: white; border: none; padding: 10px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.3s; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                                                    🔍
                                                </button>
                                                
                                                <!-- More Options -->
                                                <button onclick="showMoreOptions()" title="Daha Fazla" style="background: rgba(255,255,255,0.15); color: white; border: none; padding: 10px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.3s; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                                                    ⋮
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="whatsapp-messages-area" style="flex: 1; overflow-y: auto; overflow-x: hidden; padding: 20px; background-color: #E8DED3; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,.05) 10px, rgba(255,255,255,.05) 20px); min-height: 0;">
                                        <div class="empty-state" style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                            <p style="margin: 0; color: #666; font-size: 15px;">👈 Soldan bir kişi seçin ve Mesajlaşmaya başlayın</p>
                                        </div>
                                    </div>

                                    <div id="whatsapp-message-input" style="padding: 12px 15px; background: #F0F0F0; border-radius: 0 0 8px 8px; display: none; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); flex-shrink: 0;">
                                        <form id="whatsappSendMessageForm" style="display: flex; gap: 10px; align-items: flex-end;">
                                            <input type="hidden" id="whatsapp-selected-number" />
                                            <textarea id="whatsapp-message-text" class="form-control" rows="1" placeholder="Bir mesaj yazın..." required style="resize: none; border-radius: 20px; border: 1px solid #ddd; padding: 10px 15px; font-size: 14px; max-height: 100px; background: white;" oninput="this.style.height='auto'; this.style.height=Math.min(this.scrollHeight, 100)+'px'" onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); this.closest('form').requestSubmit();}"></textarea>
                                            <button type="submit" class="btn" style="background: #25D366; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.3s; padding: 0;" onmouseover="this.style.background='#128C7E'" onmouseout="this.style.background='#25D366'">
                                                <span style="transform: rotate(-45deg); display: inline-block;">✈️</span>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Aramalar -->
                    <!-- Tab Content: Cihazlar -->
                    <div id="whatsapp-tab-devices" class="settings-tab-content">
                        <h4 style="margin-bottom: 20px;">📱 WhatsApp Cihaz Yönetimi</h4>
                        
                        <!-- Add New Device -->
                        <div class="settings-subsection">
                            <h4 class="settings-subtitle">➕ Yeni Cihaz Ekle</h4>
                            <form id="whatsappInstanceForm-new">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="newInstanceName">Cihaz Adı *</label>
                                        <input type="text" id="newInstanceName" name="instanceName" class="form-control" placeholder="Örn: Kulup WhatsApp" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="newInstancePhone">Telefon Numarası *</label>
                                        <input type="tel" id="newInstancePhone" name="phoneNumber" class="form-control" placeholder="905xxxxxxxxx" required>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success">🔗 Cihaz Oluştur ve QR Kod Al</button>
                            </form>
                        </div>

                        <!-- Ana Hat Seçimi -->
                        <div class="settings-subsection" style="background: #fff9e6; border-left: 4px solid #ffc107;">
                            <h4 class="settings-subtitle">⭐ Ana WhatsApp Hattı</h4>
                            <p style="margin-bottom: 15px; color: #856404; font-size: 13px;">
                                📢 Otomatik bildirimlerde (görev, ödeme hatırlatma vb.) bu hat kullanılacaktır.
                            </p>
                            <div class="form-group">
                                <label for="default-whatsapp-device">Varsayılan Cihaz</label>
                                <select id="default-whatsapp-device" class="form-control" onchange="setDefaultWhatsAppDevice(this.value)">
                                    <option value="">Cihaz seçin...</option>
                                </select>
                            </div>
                        </div>

                        <!-- Send Test Message -->
                        <div class="settings-subsection" style="background: #e7f5ff; border-left: 4px solid #1890ff;">
                            <h4 class="settings-subtitle">📨 Test Mesajı Gönder</h4>
                            <p style="margin-bottom: 15px; color: #0066cc; font-size: 13px;">
                                💡 Bağlı bir cihazınız varsa buradan test mesajı gönderebilirsiniz.
                            </p>
                            <form id="testMessageForm" onsubmit="window.sendTestWhatsAppMessage(event)">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="testMessageDevice">Cihaz Seçin *</label>
                                        <select id="testMessageDevice" class="form-control" required>
                                            <option value="">Önce cihaz bağlayın...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="testMessagePhone">Alıcı Telefon Numarası *</label>
                                        <input type="tel" id="testMessagePhone" class="form-control" placeholder="905xxxxxxxxx" required>
                                        <small style="color: #666;">Örnek: 905449367543 (90 ile başlamalı)</small>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="testMessageText">Mesaj Metni *</label>
                                    <textarea id="testMessageText" class="form-control" rows="3" placeholder="Merhaba, bu bir test mesajıdır." required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">📤 Mesaj Gönder</button>
                            </form>
                        </div>

                        <!-- Connected Devices -->
                        <div class="settings-subsection">
                            <h4 class="settings-subtitle">📋 Bağlı Cihazlar</h4>
                            <div id="whatsappDevicesList-main">
                                <p class="empty-state">Henüz bağlı cihaz yok.</p>
                            </div>
                        </div>

                        <!-- ✅ Random Mesaj Bekleme Süresi Ayarları -->
                        <div class="settings-subsection">
                            <h4 class="settings-subtitle">📱 WhatsApp Mesaj Gönderim Süreleri</h4>
                            <p style="color: #666; margin-bottom: 15px;">
                                Toplu Mesaj gönderimlerinde mesajlar arasında random (rastgele) bekleme süreleri kullanılır. 
                                Bu sayede mesajlar daha doğal görünür ve WhatsApp limitlerini aşmamış olursunuz.
                            </p>
                            
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                                <div class="form-group">
                                    <label for="minWaitTime">Min Bekleme (sn) *</label>
                                    <input type="number" id="minWaitTime" name="minWaitTime" class="form-control" 
                                           min="5" max="60" value="20">
                                    <small style="color: #666; display: block; margin-top: 4px;">Minimum bekleme süresi</small>
                                </div>
                                <div class="form-group">
                                    <label for="maxWaitTime">Max Bekleme (sn) *</label>
                                    <input type="number" id="maxWaitTime" name="maxWaitTime" class="form-control" 
                                           min="10" max="120" value="50">
                                    <small style="color: #666; display: block; margin-top: 4px;">Maximum bekleme süresi</small>
                                </div>
                            </div>
                            
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                                <div class="form-group">
                                    <label for="longWaitTrigger">Uzun Bekleme Tetikleyicisi *</label>
                                    <input type="number" id="longWaitTrigger" name="longWaitTrigger" class="form-control" 
                                           min="10" max="500" value="100">
                                    <small style="color: #666; display: block; margin-top: 4px;">Her X mesajda bir uzun bekleme</small>
                                </div>
                                <div class="form-group">
                                    <label for="minLongWait">Min Uzun Bekleme (sn) *</label>
                                    <input type="number" id="minLongWait" name="minLongWait" class="form-control" 
                                           min="60" max="600" value="400">
                                    <small style="color: #666; display: block; margin-top: 4px;">Uzun beklemede minimum süre</small>
                                </div>
                                <div class="form-group">
                                    <label for="maxLongWait">Max Uzun Bekleme (sn) *</label>
                                    <input type="number" id="maxLongWait" name="maxLongWait" class="form-control" 
                                           min="120" max="1200" value="800">
                                    <small style="color: #666; display: block; margin-top: 4px;">Uzun beklemede maximum süre</small>
                                </div>
                            </div>
                            
                            <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3; margin-top: 10px;">
                                <strong>ℹ️ Örnek:</strong> 100 mesaj gönderildiğinde, her mesaj arasında 20-50 saniye beklenecek. 
                                Her 100 mesajda bir ise 400-800 saniye uzun bekleme yapılacak.
                            </div>
                        </div>

                        <!-- ✅ Çalışma Saatleri Ayarları -->
                        <div class="settings-subsection">
                            <h4 class="settings-subtitle">🕐 Mesaj Gönderim Çalışma Saatleri</h4>
                            <p style="color: #666; margin-bottom: 15px;">
                                Belirlediğiniz saat aralığı dışında gönderilmeye çalışılan mesajlar otomatik olarak sıraya alınır ve uygun saatte gönderilir.
                            </p>
                            
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="workingHoursEnabled" onchange="toggleWorkingHoursFields()">
                                    <strong>Çalışma Saatleri Aktif</strong>
                                </label>
                            </div>
                            
                            <div id="workingHoursFields" style="display: none;">
                                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                                    <div class="form-group">
                                        <label for="workingHoursStart">Başlangıç Saati</label>
                                        <input type="time" id="workingHoursStart" class="form-control" value="09:00">
                                    </div>
                                    <div class="form-group">
                                        <label for="workingHoursEnd">Bitiş Saati</label>
                                        <input type="time" id="workingHoursEnd" class="form-control" value="18:00">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Çalışma Günleri</label>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px;">
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="workDay-1" checked> Pazartesi
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="workDay-2" checked> Salı
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="workDay-3" checked> Çarşamba
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="workDay-4" checked> Perşembe
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="workDay-5" checked> Cuma
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="workDay-6"> Cumartesi
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="workDay-0"> Pazar
                                        </label>
                                    </div>
                                </div>
                                
                                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-top: 10px;">
                                    <strong>⚠️ Önemli:</strong> Çalışma saatleri dışında gönderilmeye çalışılan mesajlar sıraya alınır ve bir sonraki uygun çalışma saatinde otomatik olarak gönderilir.
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-primary" style="margin-top: 15px;" onclick="saveWhatsAppSettings()">💾 Tüm Ayarları Kaydet</button>
                        </div>

                    </div>

                    <!-- Tab Content: Toplu Mesaj -->
                    <div id="whatsapp-tab-bulk" class="settings-tab-content">
                        <h4 style="margin-bottom: 20px;">📤 Toplu Mesaj Gönderimi</h4>
                        
                        <div class="settings-subsection">
                            <form id="bulkMessageForm">
                                <!-- Step 1: Branş Seçimi -->
                                <div class="form-group">
                                    <label>1️⃣ Branş Seçin *</label>
                                    <select class="form-control" id="bulk-branch-selector" required>
                                        <option value="">Branş seçin...</option>
                                        <!-- Branşlar dinamik olarak yüklenecek -->
                                        <option value="all">✨ Tüm Branşlar</option>
                                    </select>
                                </div>
                                
                                <!-- Step 2: Grup Seçimi (Çoklu) -->
                                <div class="form-group" id="bulk-groups-container" style="display: none;">
                                    <label>2️⃣ Grupları Seçin</label>
                                    <div style="margin-bottom: 10px;">
                                        <input type="text" id="bulk-group-search" class="form-control" placeholder="🔍 Grup ara..." style="margin-bottom: 10px;" oninput="filterBulkGroups()">
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="selectAllGroups()">✓ Hepsini İşaretle</button>
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="deselectAllGroups()">✗ Temizle</button>
                                        <button type="button" class="btn btn-sm btn-primary" onclick="confirmGroupSelection()">✅ Onayla ve Devam Et</button>
                                    </div>
                                    <div id="bulk-groups-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #f8f9fa;">
                                        <!-- Gruplar buraya yüklenecek -->
                                    </div>
                                </div>
                                
                                <!-- Step 3: Seçilen Kişiler Listesi -->
                                <div class="form-group" id="bulk-recipients-container" style="display: none;">
                                    <label>3️⃣ Mesaj Alacak Kişiler <span id="bulk-recipient-count-badge" class="badge bg-primary">0</span></label>
                                    <div style="margin-bottom: 10px;">
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="selectAllRecipients()">✓ Hepsini İşaretle</button>
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="deselectAllRecipients()">✗ Temizle</button>
                                        <button type="button" class="btn btn-sm btn-success" onclick="confirmRecipientSelection()">✅ Kişileri Onayla</button>
                                    </div>
                                    <div id="bulk-recipients-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #fff;">
                                        <!-- Kişiler buraya yüklenecek -->
                                    </div>
                                </div>

                                <!-- Mesaj Metni -->
                                <div class="form-group">
                                    <label>4️⃣ Mesaj Metni *</label>
                                    <textarea class="form-control" id="bulk-message-text" rows="5" placeholder="Mesajınızı yazın..." required></textarea>
                                    <div style="margin-top: 8px; padding: 10px; background: #f0f8ff; border-radius: 6px; border: 1px solid #b3d9ff;">
                                        <strong style="color: #0066cc;">💡 Kullanılabilecek Değişkenler:</strong>
                                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                                            <code style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{UYE_AD_SOYAD}</code>
                                            <code style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{OGRENCI_AD_SOYAD}</code>
                                            <code style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{TUTAR}</code>
                                            <code style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{TARIH}</code>
                                            <code style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{MESAJ}</code>
                                        </div>
                                        <small style="color: #666; margin-top: 6px; display: block;">
                                            <strong>{UYE_AD_SOYAD}:</strong> Yetişkinde üyenin kendisi, çocukta veli adı | 
                                            <strong>{OGRENCI_AD_SOYAD}:</strong> Sadece çocuk üyelerde öğrenci adı
                                        </small>
                                    </div>
                                </div>

                                <!-- Gönderim Bilgisi -->
                                <div style="padding: 15px; background: #e7f3ff; border-radius: 8px; margin-bottom: 15px;">
                                    <strong>📊 Gönderim Özeti:</strong>
                                    <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                                        <li>Alıcı sayısı: <strong id="bulk-final-count">0</strong> kişi</li>
                                        <li>Her mesaj arası: <strong id="bulk-wait-time-display">${clubSettings.minWaitTime || 20}-${clubSettings.maxWaitTime || 50} saniye</strong> (rastgele)</li>
                                        <li>Her <strong id="bulk-long-wait-trigger">${clubSettings.longWaitTrigger || 100}</strong> mesajda bir: <strong id="bulk-long-wait-display">${clubSettings.minLongWait || 400}-${clubSettings.maxLongWait || 800} saniye</strong> uzun bekleme</li>
                                        <li>Tahmini süre: <strong id="bulk-estimated-time">-</strong></li>
                                    </ul>
                                    <small style="color: #666; margin-top: 8px; display: block;">
                                        ⚙️ Ayarları değiştirmek için WhatsApp > Cihazlar > Mesaj Gönderim Ayarları bölümüne gidin.
                                    </small>
                                </div>

                                <!-- Gönderim Durumu -->
                                <div id="bulk-sending-status" style="display: none; padding: 15px; background: #fff3cd; border-radius: 8px; margin-bottom: 15px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                        <div class="spinner-border spinner-border-sm" role="status"></div>
                                        <strong>Mesajlar gönderiliyor...</strong>
                                    </div>
                                    <div class="progress" style="height: 25px;">
                                        <div id="bulk-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0 / 0</div>
                                    </div>
                                    <div id="bulk-status-log" style="margin-top: 10px; max-height: 150px; overflow-y: auto; font-size: 12px; font-family: monospace; background: #fff; padding: 10px; border-radius: 4px;">
                                        <!-- Log mesajları buraya -->
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary btn-lg" id="bulk-send-btn">📤 Toplu Mesaj Gönder</button>
                            </form>
                        </div>
                    </div>

                    <!-- Tab Content: Kampanyalar -->
                    <div id="whatsapp-tab-campaigns" class="settings-tab-content">
                        <h4 style="margin-bottom: 20px;">📢 WhatsApp Kampanya Yönetimi</h4>
                        
                        <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
                            <strong>ℹ️ Kampanya Nedir?</strong>
                            <p style="margin: 10px 0 0 0; color: #666; font-size: 14px;">
                                Kampanyalar ile binlerce kişiye otomatik olarak mesaj gönderebilirsiniz. Sistem, mesajları belirlediğiniz sürede ve çalışma saatleri içinde parçalı olarak gönderir.
                            </p>
                        </div>
                        
                        <!-- Aktif Kampanyalar Listesi -->
                        <div id="campaigns-list" style="margin-top: 20px;">
                            <div class="loading"><div class="spinner"></div><span>Kampanyalar yükleniyor...</span></div>
                        </div>
                    </div>

                    <!-- Tab Content: Mesaj Kuyruğu -->
                    <div id="whatsapp-tab-queue" class="settings-tab-content">
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="color: white; margin: 0 0 10px 0; font-size: 28px; font-weight: 600;">📋 Bekleyen Mesaj Kuyruğu</h2>
                                <p style="color: rgba(255,255,255,0.9); margin: 0; font-size: 14px;">Gönderilmeyi bekleyen mesajları görüntüleyin ve yönetin</p>
                            </div>
                            <button class="btn" onclick="renderMessageQueue()" style="background: white; color: #f093fb; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: all 0.3s;">
                                🔄 Yenile
                            </button>
                        </div>
                        
                        <div class="settings-subsection">
                            <div id="messageQueueList">
                                <p class="empty-state">Kuyrukta bekleyen mesaj yok.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Mesaj Raporları -->
                    <div id="whatsapp-tab-reports" class="settings-tab-content">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <h2 style="color: white; margin: 0 0 10px 0; font-size: 28px; font-weight: 600;">📊 Mesaj Raporları</h2>
                            <p style="color: rgba(255,255,255,0.9); margin: 0; font-size: 14px;">WhatsApp mesajlarınızın detaylı raporlarını görüntüleyin</p>
                        </div>
                        
                        <!-- Statistics Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); position: relative; overflow: hidden;">
                                <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                                <div style="font-size: 36px; font-weight: 700; color: white; margin-bottom: 8px; position: relative; z-index: 1;" id="report-success-count">0</div>
                                <div style="font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500; position: relative; z-index: 1;">✅ Başarıyla Gönderildi</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(240, 147, 251, 0.3); position: relative; overflow: hidden;">
                                <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                                <div style="font-size: 36px; font-weight: 700; color: white; margin-bottom: 8px; position: relative; z-index: 1;" id="report-failed-count">0</div>
                                <div style="font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500; position: relative; z-index: 1;">❌ Başarısız</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #fda085 0%, #f6d365 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(253, 160, 133, 0.3); position: relative; overflow: hidden;">
                                <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                                <div style="font-size: 36px; font-weight: 700; color: white; margin-bottom: 8px; position: relative; z-index: 1;" id="report-pending-count">0</div>
                                <div style="font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500; position: relative; z-index: 1;">⏳ Sırada Bekliyor</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3); position: relative; overflow: hidden;">
                                <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                                <div style="font-size: 36px; font-weight: 700; color: white; margin-bottom: 8px; position: relative; z-index: 1;" id="report-total-count">0</div>
                                <div style="font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500; position: relative; z-index: 1;">📊 Toplam Mesaj</div>
                            </div>
                        </div>
                        
                        <!-- Filter Options -->
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 25px;">
                            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 13px;">Durum Filtresi</label>
                                    <select class="form-control" id="report-filter-status" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;" onchange="filterMessageReports()">
                                <option value="all">Tüm Durumlar</option>
                                <option value="success">✅ Gönderildi</option>
                                <option value="failed">❌ Başarısız</option>
                                <option value="pending">⏳ Bekliyor</option>
                            </select>
                        </div>
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 13px;">Tarih Filtresi</label>
                                    <input type="date" class="form-control" id="report-filter-date" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;" onchange="filterMessageReports()">
                            </div>
                                <div style="display: flex; gap: 10px; align-items: flex-end;">
                                    <button class="btn btn-secondary" onclick="exportMessageReports()" style="padding: 10px 20px; border-radius: 8px; font-weight: 600;">📥 Excel İndir</button>
                                    <button class="btn btn-danger" onclick="clearMessageReports()" style="padding: 10px 20px; border-radius: 8px; font-weight: 600;">🗑️ Temizle</button>
                            </div>
                            </div>
                        </div>
                        
                        <!-- Reports Table -->
                        <div style="overflow-x: auto; max-height: 500px; overflow-y: auto;">
                            <table class="modern-table" style="width: 100%; font-size: 14px;">
                                <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                                    <tr>
                                        <th style="width: 140px;">Tarih/Saat</th>
                                        <th style="width: 150px;">Alıcı</th>
                                        <th style="width: 120px;">Telefon</th>
                                        <th style="min-width: 200px;">Mesaj</th>
                                        <th style="width: 120px;">Cihaz</th>
                                        <th style="width: 100px;">Durum</th>
                                        <th style="width: 80px;">İşlem</th>
                                    </tr>
                                </thead>
                                <tbody id="message-reports-table">
                                    <tr><td colspan="7" class="empty-state">Mesaj raporu yükleniyor...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CRM Section -->
            <div id="crm" class="section">
                <!-- CRM Dashboard - Modern Design -->
                <div style="display: grid; gap: 20px;">
                    <!-- Branş Etiket İstatistikleri -->
                    <div class="card">
                        <div class="card-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                            <h3 style="margin: 0;">📊 Branş Bazlı Etiket Sayıları</h3>
                                <button id="toggle-branch-stats-btn" onclick="toggleBranchStats()" style="background: none; border: none; cursor: pointer; font-size: 20px; padding: 5px; transition: all 0.2s;" title="İstatistikleri Gizle/Göster">
                                    👁️
                                </button>
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="openAddLeadModal()">➕ Yeni Potansiyel Müşteri</button>
                                <button class="btn btn-success" onclick="openBulkImportModal()" title="Excel/CSV ile toplu müşteri ekle">📥 Toplu İçe Aktar</button>
                            </div>
                        </div>
                        <div id="branch-tag-stats" style="display: grid; gap: 15px;">
                            <!-- Branch tag stats will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- Günün Denemeleri & Yaklaşan Kayıt Olabilirler & Son Devamsızlıklar -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                        <div class="card">
                            <div class="card-title">
                                <h3>🎾 Bugünün Denemeleri</h3>
                            </div>
                            <div id="today-trials-list"></div>
                        </div>
                        
                        <div class="card">
                            <div class="card-title">
                                <h3>📅 Yaklaşan Kayıt Olabilirler</h3>
                            </div>
                            <div id="upcoming-registrations-list"></div>
                        </div>
                        
                        <div class="card">
                            <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                                <h3>⚠️ Son Devamsızlıklar</h3>
                                <select id="absence-period-filter" onchange="renderRecentAbsences()" class="form-control" style="width: auto; font-size: 14px;">
                                    <option value="7">Son 7 Gün</option>
                                    <option value="10">Son 10 Gün</option>
                                    <option value="30" selected>Son 30 Gün</option>
                                </select>
                            </div>
                            <div id="recent-absences-list"></div>
                        </div>
                    </div>
                    
                    <!-- Branş & Etiket Dağılımı -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                        <div class="card">
                            <div class="card-title">
                                <h3>🎯 Branş Dağılımı</h3>
                            </div>
                            <div id="branch-distribution"></div>
                        </div>
                        
                        <div class="card">
                            <div class="card-title">
                                <h3>🏷️ Etiket Dağılımı</h3>
                            </div>
                            <div id="tag-distribution"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CRM Müşteri Filtrele Section -->
            <div id="crm-filter" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="card-title" style="margin: 0;">🔍 Müşteri Filtrele</h2>
                    <button class="btn btn-primary" onclick="openAddLeadModal()">
                        ➕ Yeni Potansiyel Müşteri
                    </button>
                </div>
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 16px; margin: 0;">Filtreler</h3>
                        <button class="btn btn-sm btn-secondary" onclick="clearCRMFilters()">🔄 Temizle</button>
                    </div>

                    <!-- Filtreler -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label>Branş</label>
                            <select id="filter-branch" class="form-control" onchange="applyCustomerFilters()">
                                <option value="all">Tüm Branşlar</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Yaş Grubu</label>
                            <select id="filter-age-group" class="form-control" onchange="applyCustomerFilters()">
                                <option value="all">Tümü</option>
                                <option value="child">👶 Çocuk</option>
                                <option value="adult">👨 Yetişkin</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Etiket</label>
                            <select id="filter-tag" class="form-control" onchange="applyCustomerFilters()">
                                <option value="all">Tümü</option>
                                <!-- Etiketler buraya yüklenecek -->
                            </select>
                        </div>

                    </div>
                    
                    <!-- Son İşlem Tarihi Filtresi -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label>📅 Son İşlem Başlangıç</label>
                            <input type="date" id="filter-date-start" class="form-control" onchange="applyCustomerFilters()">
                        </div>
                        <div class="form-group">
                            <label>📅 Son İşlem Bitiş</label>
                            <input type="date" id="filter-date-end" class="form-control" onchange="applyCustomerFilters()">
                        </div>
                    </div>

                    <!-- Arama -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <input type="text" id="filter-search" class="form-control search-input" placeholder="İsim, telefon veya email ile ara..." oninput="applyCustomerFilters()">
                    </div>
                    
                    <!-- Sıralama -->
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>🔽 Sıralama</label>
                        <select id="filter-sort" class="form-control" onchange="applyCustomerFilters()">
                            <option value="date-desc">Son İşlem Tarihi (Yeni → Eski)</option>
                            <option value="date-asc">Son İşlem Tarihi (Eski → Yeni)</option>
                            <option value="age-desc">Yaş (Büyükten Küçüğe)</option>
                            <option value="age-asc">Yaş (Küçükten Büyüğe)</option>
                            <option value="name-asc">İsim (A → Z)</option>
                            <option value="name-desc">İsim (Z → A)</option>
                        </select>
                    </div>

                    <!-- İstatistikler -->
                    <div id="filter-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px; border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 20px; font-weight: bold;" id="total-filtered">0</div>
                            <div style="font-size: 11px; opacity: 0.9;">Toplam</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 12px; border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 20px; font-weight: bold;" id="new-filtered">0</div>
                            <div style="font-size: 11px; opacity: 0.9;">Yeni</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 12px; border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 20px; font-weight: bold;" id="trial-filtered">0</div>
                            <div style="font-size: 11px; opacity: 0.9;">Deneme</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 12px; border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 20px; font-weight: bold;" id="converted-filtered">0</div>
                            <div style="font-size: 11px; opacity: 0.9;">Üye Oldu</div>
                        </div>
                    </div>
                </div>

                <!-- Filtrelenmiş Müşteri Listesi -->
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 16px; margin: 0;">📋 Filtrelenmiş Müşteriler</h3>
                        <button class="btn btn-sm btn-success" onclick="exportFilteredCustomers()">📥 Dışa Aktar</button>
                    </div>
                    <div id="filtered-customers-list">
                        <div class="empty-state">
                            <h3>Filtre uygulayın</h3>
                            <p>Yukarıdaki filtrelerden müşterileri seçin</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CRM Denemeler Section -->
            <div id="crm-trials" class="section">
                <h2 class="card-title" style="margin-bottom: 20px;">🎾 Deneme Dersleri</h2>
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 16px; margin: 0;">İstatistikler</h3>
                        <button class="btn btn-sm btn-primary" onclick="openAddTrialModal()">➕ Deneme Ekle</button>
                    </div>

                    <!-- Deneme İstatistikleri -->
                    <!-- Filtreler -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <select id="trial-branch-filter" class="form-control" style="width: 150px;" onchange="renderTrials()">
                            <option value="all">Tüm Branşlar</option>
                        </select>
                        <input type="text" id="trial-search" class="form-control search-input" placeholder="Müşteri ara..." style="flex: 1; min-width: 200px;" oninput="renderTrials()">
                    </div>
                </div>

                <!-- Deneme Listesi -->
                <div class="card">
                    <div class="card-title">
                        <h3 style="font-size: 16px; margin: 0;">📋 Deneme Dersi Listesi</h3>
                    </div>
                    <div id="trials-list">
                        <div class="empty-state">
                            <h3>Henüz deneme dersi kaydı yok</h3>
                            <p>Yeni deneme eklemek için yukarıdaki butonu kullanın</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kampanya Oluştur Section -->
            <div id="campaigns" class="section">
                <div class="card">
                    <div class="card-title">
                        <h3>📢 Kampanya Oluştur</h3>
                    </div>
                    <p style="color: #666; margin-bottom: 20px;">
                        CRM'deki müşterilere Toplu Mesaj gönderin. Filtreleme seçeneklerini kullanarak hedef kitlenizi belirleyin.
                    </p>
                    
                    <div id="campaign-form">
                        <!-- Filtreler -->
                        <div class="card" style="background: #f8f9fa; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 15px; font-size: 16px;">🎯 Hedef Kitle Seçimi</h4>
                            <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                                <div class="form-group">
                                    <label>Branş Filtrele</label>
                                    <select id="campaign-branch-filter" class="form-control" onchange="updateCampaignRecipients()">
                                        <option value="all">Tüm Branşlar</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Etiket Filtrele</label>
                                    <select id="campaign-tag-filter" class="form-control" onchange="updateCampaignRecipients()">
                                        <option value="all">Tüm Etiketler</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Yaş Grubu</label>
                                    <select id="campaign-agegroup-filter" class="form-control" onchange="updateCampaignRecipients()">
                                        <option value="all">Hepsi</option>
                                        <option value="adult">Yetişkin</option>
                                        <option value="child">Çocuk</option>
                                    </select>
                                </div>
                            </div>
                            <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px;">
                                <strong>Seçilen Müşteri Sayısı:</strong> <span id="campaign-recipient-count" style="font-size: 20px; color: #667eea; font-weight: bold;">0</span>
                            </div>
                        </div>
                        
                        <!-- Mesaj Ayarları -->
                        <div class="card">
                            <h4 style="margin-bottom: 15px; font-size: 16px;">💬 Mesaj Ayarları</h4>
                            <div class="form-group">
                                <label>WhatsApp Cihazı *</label>
                                <select id="campaign-device" class="form-control" required>
                                    <option value="">Cihaz seçin...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Mesaj İçeriği *</label>
                                <textarea id="campaign-message" class="form-control" rows="6" placeholder="Mesajınızı yazın..." required></textarea>
                                <small style="color: #666;">💡 İpucu: Kişisel mesajlar için {ad} ve {telefon} değişkenlerini kullanabilirsiniz.</small>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="campaign-send-delay"> Mesajlar arası gecikme ekle (1 saniye)
                                </label>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-success" onclick="sendCampaignMessages()" style="font-size: 16px; padding: 12px 24px;">
                                📨 Kampanyayı Başlat
                            </button>
                            <button class="btn btn-secondary" onclick="resetCampaignForm()" style="font-size: 16px; padding: 12px 24px;">
                                🔄 Formu Sıfırla
                            </button>
                        </div>
                        
                        <!-- Gönderim Durumu -->
                        <div id="campaign-status" style="display: none; margin-top: 20px; padding: 20px; background: #e3f2fd; border-radius: 8px;">
                            <h4 style="margin-bottom: 10px;">📊 Gönderim Durumu</h4>
                            <div id="campaign-progress"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CRM Gelen Aramalar Section -->
            <div id="crm-incoming-calls" class="section">
                <h2 class="card-title" style="margin-bottom: 20px;">📞 Gelen Aramalar</h2>
                <div class="card">
                    <div id="incoming-calls-header" class="card-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <h3 style="font-size: 16px; margin: 0;">Son 1 Hafta İçindeki Gelen Aramalar</h3>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <button class="btn btn-sm btn-secondary" onclick="renderIncomingCallsPage()">🔄 Yenile</button>
                        </div>
                    </div>
                    
                    <!-- Sekmeler -->
                    <div style="display: flex; gap: 0; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px; margin-top: 15px; flex-wrap: wrap;">
                        <button id="tab-unanswered" class="incoming-call-tab" onclick="switchIncomingCallTab('unanswered')" style="flex: 1; min-width: 200px; padding: 12px 20px; border: none; background: #ffebee; color: #f44336; font-weight: 600; cursor: pointer; border-bottom: 3px solid #f44336; transition: all 0.3s;">
                            <span style="font-size: 16px;">📵 Cevapsız Aramalar</span>
                            <span id="count-unanswered" style="display: block; font-size: 20px; margin-top: 5px;">0</span>
                        </button>
                        <button id="tab-callback-unanswered" class="incoming-call-tab" onclick="switchIncomingCallTab('callback-unanswered')" style="flex: 1; min-width: 200px; padding: 12px 20px; border: none; background: #fff; color: #666; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s;">
                            <span style="font-size: 16px;">↩️ Dönüş Yapıldı Ama Cevapsız</span>
                            <span id="count-callback-unanswered" style="display: block; font-size: 20px; margin-top: 5px;">0</span>
                        </button>
                        <button id="tab-callback" class="incoming-call-tab" onclick="switchIncomingCallTab('callback')" style="flex: 1; min-width: 200px; padding: 12px 20px; border: none; background: #fff; color: #666; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s;">
                            <span style="font-size: 16px;">📞 Giden Aramada Cevaplanmış</span>
                            <span id="count-callback" style="display: block; font-size: 20px; margin-top: 5px;">0</span>
                        </button>
                        <button id="tab-answered" class="incoming-call-tab" onclick="switchIncomingCallTab('answered')" style="flex: 1; min-width: 200px; padding: 12px 20px; border: none; background: #fff; color: #666; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s;">
                            <span style="font-size: 16px;">✅ Gelen Aramada Cevaplanmış</span>
                            <span id="count-answered" style="display: block; font-size: 20px; margin-top: 5px;">0</span>
                        </button>
                        <button id="tab-other" class="incoming-call-tab" onclick="switchIncomingCallTab('other')" style="flex: 1; min-width: 200px; padding: 12px 20px; border: none; background: #fff; color: #666; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s;">
                            <span style="font-size: 16px;">📋 Diğer</span>
                            <span id="count-other" style="display: block; font-size: 20px; margin-top: 5px;">0</span>
                        </button>
                    </div>
                    
                    <!-- İçerik -->
                    <div id="incoming-calls-list">
                        <div class="loading"><div class="spinner"></div><span>Gelen aramalar yükleniyor...</span></div>
                    </div>
                </div>
            </div>

            <!-- CRM Giden Aramalar Section -->
            <div id="crm-outgoing-calls" class="section">
                <h2 class="card-title" style="margin-bottom: 20px;">📱 Giden Aramalar</h2>
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 16px; margin: 0;">Son 1 Hafta İçindeki Giden Aramalar</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label id="selectAllOutgoingLabel" style="display: none; align-items: center; gap: 5px; margin: 0; cursor: pointer;">
                                <input type="checkbox" id="selectAllOutgoing" onchange="toggleSelectAllOutgoing(this)" style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-size: 14px;">Tümünü Seç</span>
                            </label>
                            <button id="showDeleteModeOutgoingBtn" class="btn btn-sm btn-warning" onclick="showOutgoingDeleteMode()" title="Silme modunu aç">🗑️ Seçilenleri Sil</button>
                            <button id="confirmDeleteOutgoingBtn" class="btn btn-sm btn-danger" onclick="confirmDeleteOutgoingCalls()" title="Seçilileri sil" style="display: none;">✔️ Sil</button>
                            <button id="cancelDeleteOutgoingBtn" class="btn btn-sm btn-secondary" onclick="cancelOutgoingDeleteMode()" title="İptal" style="display: none;">✖️ İptal</button>
                            <button class="btn btn-sm btn-secondary" onclick="renderOutgoingCallsPage()">🔄 Yenile</button>
                    </div>
                    </div>
                    <div id="outgoing-calls-list">
                        <div class="loading"><div class="spinner"></div><span>Giden aramalar yükleniyor...</span></div>
                    </div>
                </div>
            </div>

            <!-- CRM Etiketler Section -->
            <div id="crm-tags" class="section">
                <h2 class="card-title" style="margin-bottom: 20px;">🏷️ Etiket Yönetimi</h2>
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 16px; margin: 0;">İstatistikler</h3>
                        <button class="btn btn-sm btn-primary" onclick="openAddTagModal()">➕ Yeni Etiket</button>
                    </div>

                    <p style="color: #666; margin-bottom: 15px; font-size: 13px;">
                        Müşterilerinizi kategorize etmek için etiketler oluşturun. Etiketler sayesinde müşterilerinizi kolayca gruplandırabilir ve filtreleyebilirsiniz.
                    </p>

                    <!-- Etiket İstatistikleri -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px; border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 22px; font-weight: bold;" id="total-tags">0</div>
                            <div style="font-size: 11px; opacity: 0.9;">Toplam Etiket</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 12px; border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 22px; font-weight: bold;" id="active-tags">0</div>
                            <div style="font-size: 11px; opacity: 0.9;">Aktif Etiket</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 12px; border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 22px; font-weight: bold;" id="tagged-customers">0</div>
                            <div style="font-size: 11px; opacity: 0.9;">Etiketli Müşteri</div>
                        </div>
                    </div>
                </div>

                <!-- Etiket Kategorileri -->
                <div class="card">
                    <div class="card-title">
                        <h3 style="font-size: 16px; margin: 0;">📂 Etiket Kategorileri</h3>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                        <!-- Durum Etiketleri -->
                        <div>
                            <h4 style="color: #667eea; margin-bottom: 12px; font-size: 14px;">📊 Durum Etiketleri</h4>
                            <div id="status-tags-list" class="tags-category-list">
                                <!-- Durum etiketleri buraya yüklenecek -->
                            </div>
                        </div>

                        <!-- Branş Etiketleri -->
                        <div>
                            <h4 style="color: #f093fb; margin-bottom: 12px; font-size: 14px;">🎾 Branş Etiketleri</h4>
                            <div id="branch-tags-list" class="tags-category-list">
                                <!-- Branş etiketleri buraya yüklenecek -->
                            </div>
                        </div>

                        <!-- Özel Etiketler -->
                        <div>
                            <h4 style="color: #43e97b; margin-bottom: 12px; font-size: 14px;">⭐ Özel Etiketler</h4>
                            <div id="custom-tags-list" class="tags-category-list">
                                <!-- Özel etiketler buraya yüklenecek -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tüm Etiketler Listesi -->
                <div class="card">
                    <div class="card-title">
                        <h3 style="font-size: 16px; margin: 0;">📋 Tüm Etiketler</h3>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="tag-search" class="form-control search-input" placeholder="Etiket ara..." style="max-width: 300px;" oninput="renderAllTags()">
                            <select id="tag-category-filter" class="form-control" style="max-width: 200px;" onchange="renderAllTags()">
                                <option value="all">Tüm Kategoriler</option>
                                <option value="status">Durum</option>
                                <option value="branch">Branş</option>
                                <option value="custom">Özel</option>
                            </select>
                        </div>
                    </div>
                    <div id="all-tags-list">
                        <div class="empty-state">
                            <h3>Henüz etiket yok</h3>
                            <p>Yeni etiket eklemek için yukarıdaki butonu kullanın</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CRM Mesaj Şablonları Section -->
            <div id="crm-templates" class="section">
                <h2 class="card-title" style="margin-bottom: 20px;">📝 Mesaj Şablonları</h2>
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 16px; margin: 0;">Hazır Mesaj Şablonları</h3>
                        <button class="btn btn-sm btn-primary" onclick="openAddTemplateModal()">➕ Yeni Şablon</button>
                    </div>
                    
                    <p style="color: #666; margin-bottom: 20px; font-size: 13px;">
                        Müşterilerinize gönderilecek mesajlar için hazır şablonlar oluşturun. Şablonlar sayesinde zaman kazanın ve tutarlı iletişim kurun.
                    </p>
                    
                    <!-- Varsayılan Şablonlar -->
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #667eea; margin-bottom: 15px; font-size: 14px;">💼 Varsayılan Şablonlar</h4>
                        <div id="default-templates-list" style="display: grid; gap: 15px;">
                            <!-- Varsayılan şablonlar buraya yüklenecek -->
                        </div>
                    </div>
                    
                    <!-- Özel Şablonlar -->
                    <div>
                        <h4 style="color: #f093fb; margin-bottom: 15px; font-size: 14px;">⭐ Özel Şablonlar</h4>
                        <div id="custom-templates-list" style="display: grid; gap: 15px;">
                            <!-- Özel şablonlar buraya yüklenecek -->
                        </div>
                    </div>
                    
                    <!-- Boş durum -->
                    <div id="no-templates" style="display: none; text-align: center; padding: 60px 20px; color: #999;">
                        <div style="font-size: 64px; margin-bottom: 20px;">📝</div>
                        <h3>Henüz özel şablon yok</h3>
                        <p>Yeni şablon eklemek için yukarıdaki butonu kullanın</p>
                    </div>
                </div>
            </div>
            
            <!-- Attendance Tracking Section -->
            <div id="attendance-tracking" class="section">
                <div class="attendance-header">
                    <h1 id="header-title-attendance" class="modern-title"></h1>
                    <a href="#" onclick="event.preventDefault(); showSection('members', document.querySelector('.nav-btn[onclick*=\'members\']'))" class="back-link" style="background: var(--primary-color); color:white;">← Üyeler Listesine Dön</a>
                </div>
                <div id="attendance-content">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Üye verileri yükleniyor...</span>
                    </div>
                </div>
            </div>

            <!-- User Activities Section -->
            <div id="user-activities" class="section">
                <h2 class="card-title">📊 Kullanıcı Hareketleri</h2>
                <div class="card">
                    <div class="card-title">
                        <h3>👥 Üye Giriş Hareketleri</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="activitySearch" class="form-control search-input" placeholder="Üye ara (İsim, Telefon)..." style="max-width: 300px;">
                            <select id="activityBranchFilter" class="form-control" style="max-width: 150px;">
                                <option value="all">Tüm Branşlar</option>
                                <option value="tenis">🎾 Tenis</option>
                                <option value="yuzme">🏊 Yüzme</option>
                            </select>
                        </div>
                    </div>
                    <div id="activitiesTableContainer">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span>Hareketler yükleniyor...</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="member-tooltip"></div>
    <div id="context-menu"></div>
    <div id="phone-context-menu">
        <button id="phone-copy-btn">Kopyala</button>
        <button id="phone-call-btn">Ara</button>
    </div>


    <!-- Zamanlanmış Mesaj Modal -->
    <div id="scheduleMessageModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('scheduleMessageModal')">&times;</span>
            <h3>⏰ Mesaj Zamanla</h3>
            <p style="color: #666; margin-bottom: 20px;">
                ✅ Tarayıcı kapalı olsa bile Firebase Cloud Functions üzerinden gönderilir
            </p>
            <form id="scheduleMessageForm" onsubmit="handleScheduleMessage(event)">
                <div class="form-group">
                    <label>Alıcı Telefon Numarası *</label>
                    <input type="tel" name="phoneNumber" class="form-control" placeholder="05xxxxxxxxx" required>
                </div>
                <div class="form-group">
                    <label>Alıcı Adı</label>
                    <input type="text" name="recipientName" class="form-control" placeholder="İsteğe bağlı">
                </div>
                <div class="form-group">
                    <label>Mesaj İçeriği *</label>
                    <textarea name="messageText" class="form-control" rows="5" placeholder="Mesajınızı yazın..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Gönderim Zamanı *</label>
                    <input type="datetime-local" name="scheduledTime" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Mesaj Tipi</label>
                    <select name="messageType" class="form-control">
                        <option value="custom">Özel Mesaj</option>
                        <option value="payment-reminder">Ödeme Hatırlatması</option>
                        <option value="birthday">Doğum Günü</option>
                        <option value="task">Görev Bildirimi</option>
                        <option value="announcement">Duyuru</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">⏰ Zamanla</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('scheduleMessageModal')">İptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Kampanya Modal -->
    <div id="campaignModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('campaignModal')">&times;</span>
            <h3>📢 Yeni Kampanya Oluştur</h3>
            <p style="color: #666; margin-bottom: 20px;">
                Toplu Mesaj gönderin - Sistem, mesajları çalışma saatleri içinde parçalı olarak gönderir
            </p>
            <form id="campaignForm" onsubmit="handleCreateCampaign(event)">
                <div class="form-group">
                    <label>Kampanya Adı *</label>
                    <input type="text" name="campaignName" class="form-control" placeholder="Örn: Mayıs 2025 Kampanyası" required>
                </div>
                
                <div class="form-group">
                    <label>Hedef Kitle *</label>
                    <select name="targetAudience" class="form-control" onchange="updateCampaignRecipientCount(this.value)" required>
                        <option value="">Seçiniz...</option>
                        <option value="all-members">👥 Tüm Üyeler</option>
                        <option value="active-members">✅ Aktif Üyeler</option>
                        <option value="inactive-members">⏸️ Pasif Üyeler</option>
                        <option value="crm-all">📋 Tüm CRM Müşterileri</option>
                        <option value="crm-by-tag">🏷️ CRM - Etikete Göre</option>
                        <option value="crm-by-branch">🎯 CRM - Branşa Göre</option>
                    </select>
                </div>
                
                <div id="campaign-tag-filter" class="form-group" style="display:none;">
                    <label>Etiket Seçin</label>
                    <select name="crmTag" class="form-control" id="campaign-tag-select"></select>
                </div>
                
                <div id="campaign-branch-filter" class="form-group" style="display:none;">
                    <label>Branş Seçin</label>
                    <select name="crmBranch" class="form-control" id="campaign-branch-select"></select>
                </div>
                
                <div class="form-group">
                    <label>Mesaj İçeriği *</label>
                    <textarea name="messageContent" class="form-control" rows="5" placeholder="Mesajınızı yazın..." required></textarea>
                    <small style="color: #666;">Değişkenler: {AD_SOYAD}, {AD}, {TELEFON}</small>
                </div>
                
                <div style="background: #fff9e6; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ffc107;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px;">📊 Parçalı Gönderim Ayarları</h4>
                    
                    <div class="form-group">
                        <label>Günlük Gönderim Limiti</label>
                        <input type="number" name="dailyLimit" class="form-control" value="200" min="10" max="1000" required>
                        <small style="color: #666;">Her gün en fazla kaç mesaj gönderilsin?</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Gönderim Başlangıç Zamanı</label>
                        <input type="datetime-local" name="startTime" class="form-control" required>
                        <small style="color: #666;">Kampanya ne zaman başlasın?</small>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="color: #666;">Toplam Alıcı:</span>
                            <strong id="campaign-recipient-count">0</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #666;">Tahmini Süre:</span>
                            <strong id="campaign-duration">-</strong>
                        </div>
                    </div>
                </div>
                
                <div style="background: #e7f3ff; padding: 12px; border-radius: 6px; margin-bottom: 20px;">
                    <strong>✅ Çalışma Saatlerine Uyum:</strong>
                    <p style="margin: 8px 0 0 0; color: #666; font-size: 13px;">
                        Mesajlar, WhatsApp > Ayarlar'da belirlediğiniz çalışma saatleri içinde gönderilir.
                    </p>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">📢 Kampanyayı Başlat</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('campaignModal')">İptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Direct Message Modal -->
    <div id="directMessageModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('directMessageModal')">&times;</span>
            <h3>💬 Mesaj Gönder</h3>
            <form id="directMessageForm" onsubmit="handleDirectMessage(event)">
                <div class="form-group">
                    <label>📱 Telefon Numarası *</label>
                    <input type="tel" id="direct-message-phone" name="phone" class="form-control" placeholder="05xxxxxxxxx" required>
                    <small style="color: #666;">Örn: 05301234567 veya 905301234567</small>
                </div>
                
                <div class="form-group">
                    <label>💬 Mesaj *</label>
                    <textarea id="direct-message-text" name="message" class="form-control" rows="6" placeholder="Mesajınızı yazın..." required></textarea>
                    <small style="color: #666;">Mesajınız hemen gönderilecektir.</small>
                </div>
                
                <div class="form-group">
                    <label>📱 Gönderici Cihaz</label>
                    <select id="direct-message-device" name="deviceId" class="form-control">
                        <option value="">Varsayılan cihaz</option>
                    </select>
                </div>
                
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">✈️ Gönder</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('directMessageModal')">❌ İptal</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add/Edit Lead Modal -->
    <div id="addLeadModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addLeadModal')">&times;</span>
            <h3>➕ Yeni Potansiyel Müşteri</h3>
            <form id="addLeadForm" onsubmit="handleAddLead(event)">
                <div class="form-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="form-group">
                        <label>Telefon *</label>
                        <input type="tel" name="phone" class="form-control" placeholder="05xxxxxxxxx" required oninput="checkExistingPhone(this.value)">
                        <div id="phone-check-message" style="font-size: 12px; margin-top: 5px;"></div>
                    </div>
                    <div class="form-group">
                        <label>Kaynak</label>
                        <select name="source" class="form-control">
                            <option value="website">🌐 Website</option>
                            <option value="phone">📞 Telefon</option>
                            <option value="referral">👥 Tavsiye</option>
                            <option value="social">📱 Sosyal Medya</option>
                            <option value="other">🔹 Diğer</option>
                        </select>
                    </div>
                </div>
                
                <!-- Branşlar Bölümü -->
                <div style="margin: 20px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; font-size: 16px;">🎯 Branşlar</h4>
                        <button type="button" class="btn btn-sm btn-success" onclick="addBranchField()">+ Branş Ekle</button>
                    </div>
                    <div id="branches-container">
                        <!-- Branşlar buraya eklenecek -->
                    </div>
                </div>
                
                
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">💾 Kaydet</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addLeadModal')">❌ İptal</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Bulk Import Modal -->
    <div id="bulkImportModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeBulkImportModal()">&times;</span>
            <h3>📥 Toplu Müşteri İçe Aktarma</h3>
            
            <div id="import-step-1" style="display: block;">
                <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #1976d2;">📋 Nasıl Hazırlanır?</h4>
                    <p style="margin: 5px 0;">1. <strong>Excel şablonunu</strong> indirin (3 ayrı sayfa: Müşteriler, Branşlar, Etiketler)</p>
                    <p style="margin: 5px 0;">2. <strong>"Branşlar"</strong> ve <strong>"Etiketler"</strong> sekmelerinden değerleri kopyalayın</p>
                    <p style="margin: 5px 0;">3. <strong>"Müşteriler"</strong> sekmesinde ilgili sütunlara yapıştırın</p>
                    <p style="margin: 5px 0;">4. Müşteri bilgilerini doldurun</p>
                    <p style="margin: 5px 0;">5. Dosyayı <strong>Excel (.xlsx)</strong> formatında kaydedin</p>
                    <p style="margin: 5px 0;">6. Aşağıdan dosyayı yükleyin</p>
                    
                    <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #2196f3;">
                        <strong>📋 Nasıl Kullanılır:</strong>
                        <br>• Excel'de <strong>Branşlar</strong> sekmesinden branş ismi kopyalayın
                        <br>• <strong>Müşteriler</strong> sekmesindeki "Branş" sütununa yapıştırın
                        <br>• Aynı şekilde <strong>Etiketler</strong> sekmesinden etiket kopyalayın
                        <br>• Bu yöntemle yazım hatası olmaz!
                    </div>
                    
                    <div style="background: #fff3cd; padding: 12px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #ffc107;">
                        <strong>⚠️ Önemli:</strong> Branş ve Etiket isimlerini <strong>tam olarak</strong> diğer sayfalardan kopyalayın.
                        <br>Elle yazarsanız yazım hatası nedeniyle yükleme başarısız olabilir!
                    </div>
                    
                    <button class="btn btn-info" onclick="downloadImportTemplate()" style="margin-top: 10px;">
                        📄 Excel Şablon İndir (Branş & Etiket Listeli)
                    </button>
                    <a href="CRM_TOPLU_EKLEME_TALIMATLARI.md" download class="btn btn-secondary" style="margin-top: 10px; margin-left: 10px;">
                        📖 Detaylı Talimatlar
                    </a>
                </div>
                
                <div style="border: 2px dashed #ccc; padding: 40px; text-align: center; border-radius: 8px; background: #fafafa; cursor: pointer;" 
                     onclick="document.getElementById('csvFileInput').click()">
                    <input type="file" id="csvFileInput" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleFileSelect(event)">
                    <div style="font-size: 48px; margin-bottom: 10px;">📁</div>
                    <p style="margin: 5px 0; font-size: 16px; font-weight: 600;">Excel/CSV Dosyasını Seçin</p>
                    <p style="margin: 5px 0; color: #666;">veya buraya sürükleyin</p>
                    <p style="margin: 10px 0 0 0; font-size: 12px; color: #999;">Desteklenen formatlar: .csv, .xlsx, .xls</p>
                </div>
            </div>
            
            <div id="import-step-2" style="display: none;">
                <div style="margin-bottom: 20px;">
                    <h4>📊 Önizleme ve Kontrol</h4>
                    <div id="import-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 15px 0;">
                        <!-- Summary stats will be here -->
                    </div>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
                    <table class="table" style="margin: 0;">
                        <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                            <tr>
                                <th style="width: 30px;">#</th>
                                <th>Telefon</th>
                                <th>Ad Soyad</th>
                                <th>Veli/Çocuk</th>
                                <th>Kaynak</th>
                                <th>Branş</th>
                                <th>Yaş Grubu</th>
                                <th>Etiket</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody id="import-preview-body">
                            <!-- Preview rows will be here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="confirmBulkImport()" id="confirmImportBtn">
                        ✅ Tümünü Ekle (<span id="valid-count">0</span> Geçerli)
                    </button>
                    <button class="btn btn-secondary" onclick="closeBulkImportModal()">❌ İptal</button>
                </div>
            </div>
            
            <div id="import-step-3" style="display: none;">
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">⏳</div>
                    <h4>İçe aktarma yapılıyor...</h4>
                    <div id="import-progress" style="margin: 20px 0;">
                        <div style="background: #e0e0e0; height: 30px; border-radius: 15px; overflow: hidden;">
                            <div id="import-progress-bar" style="background: linear-gradient(90deg, #4caf50, #8bc34a); height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <p id="import-progress-text" style="margin-top: 10px;">0 / 0</p>
                    </div>
                </div>
            </div>
            
            <div id="import-step-4" style="display: none;">
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">✅</div>
                    <h4>İçe Aktarma Tamamlandı!</h4>
                    <div id="import-result" style="margin: 20px 0; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
                        <!-- Result summary will be here -->
                    </div>
                    <button class="btn btn-primary" onclick="closeBulkImportModal()">Tamam</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('paymentModal')">&times;</span>
            <h3 id="paymentModalTitle">💰 Ödeme İşlemi</h3>
            <form id="paymentForm">
                <input type="hidden" name="paymentPreRegId">
                <input type="hidden" name="paymentNumber">
                <div id="paymentPeriodInfoStatic" style="background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; display:none;"></div>
                <div class="form-grid" id="paymentPeriodInfo" style="display:none;">
                     <div class="form-group"><label>Dönem Başlangıç</label><input type="date" class="form-control" name="periodStart"></div>
                     <div class="form-group"><label>Dönem Bitiş</label><input type="date" class="form-control" name="periodEnd"></div>
                     <div class="form-group"><label>Ders Sayısı</label><input type="number" class="form-control" name="lessonCount"></div>
                </div>
                <!-- ✅ Kaç ay daha aidat eklenecek? -->
                <div class="form-group" id="additionalMonthsField" style="display:none; margin-bottom: 20px;">
                    <label style="font-weight: 600;">📆 Bu aidattan sonra kaç ay daha aidat eklensin?</label>
                    <input type="number" class="form-control" name="additionalMonths" min="0" max="12" value="0" placeholder="Örn: 3 ay daha">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        0 girerseniz sadece bu ay eklenir. Örnek: 3 girerseniz, bu ay + 3 ay daha (toplam 4 aidat) eklenecektir.
                    </small>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Ödeme Tarihi</label>
                        <input type="date" class="form-control" name="paymentDate">
                    </div>
                    <div class="form-group">
                        <label>Tutar *</label>
                        <input type="text" class="form-control" name="paymentAmount" required>
                    </div>
                     <div class="form-group">
                        <label>Son Ödeme Tarihi *</label>
                        <input type="date" class="form-control" name="paymentDueDate" required>
                    </div>
                    <div class="form-group">
                        <label>Ödeme Yöntemi</label>
                        <select class="form-control" name="paymentMethod">
                            <option value="">Seçiniz...</option>
                            <option value="nakit">💵 Nakit</option>
                            <option value="kredi_karti">💳 Kredi Kartı</option>
                            <option value="banka_havalesi">🏦 Banka Havalesi</option>
                            <option value="eft">📱 EFT</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label>Durum</label>
                        <select class="form-control" name="paymentStatus">
                            <option value="unpaid">Ödenmedi</option>
                            <option value="paid">Ödendi</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Not</label>
                        <textarea class="form-control" name="paymentNote" rows="3" placeholder="Ek bilgiler..."></textarea>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">✅ Kaydet</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('paymentModal')">❌ İptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Schedule Modal (for new lessons) -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('scheduleModal')">&times;</span>
            <h3>📅 Yeni Ders Oluştur</h3>
            <form id="newScheduleForm">
                <input type="hidden" name="groupId">
                <div class="form-grid">
                     <div class="form-group">
                        <label>Grup</label>
                        <input type="text" class="form-control" name="groupName" readonly>
                    </div>
                    <div class="form-group">
                        <label>Başlangıç Saati *</label>
                        <input type="time" class="form-control" name="startTime" required>
                    </div>
                    <div class="form-group">
                        <label>Bitiş Saati *</label>
                        <input type="time" class="form-control" name="endTime" required>
                    </div>
                </div>
                <!-- ✅ Saha Seçimi (dinamik) -->
                <div class="form-group" id="courtSelectContainer" style="display: none;">
                    <label>Saha (opsiyonel)</label>
                    <select class="form-control" name="court" id="courtSelect">
                        <option value="">Saha Seçiniz...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Ders Günleri *</label>
                    <div id="schedule-days-checkboxes" style="display: flex; flex-wrap: wrap; gap: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px;">
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="days" value="pazartesi"> Pazartesi</label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="days" value="salı"> Salı</label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="days" value="çarşamba"> Çarşamba</label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="days" value="perşembe"> Perşembe</label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="days" value="cuma"> Cuma</label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="days" value="cumartesi"> Cumartesi</label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="days" value="pazar"> Pazar</label>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">✅ Dersi Oluştur</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('scheduleModal')">❌ İptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Group Modal -->
    <div id="groupModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('groupModal')">&times;</span>
            <h3 id="groupModalTitle">👥 Grup Yönetimi</h3>
            <form id="groupForm">
                <input type="hidden" name="groupId">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Grup Adı *</label>
                        <input type="text" class="form-control" name="groupName" placeholder="Başlangıç Grubu" required>
                    </div>
                    <div class="form-group">
                        <label>Branş *</label>
                        <select class="form-control" name="branch" required>
                            <option value="">Seçiniz...</option>
                            <option value="tenis">🎾 Tenis</option>
                            <option value="yuzme">🏊 Yüzme</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Eğitmen *</label>
                        <input type="text" class="form-control" name="instructor" placeholder="Eğitmen adı" required>
                    </div>
                    <div class="form-group">
                        <label>Maksimum Üye *</label>
                        <input type="number" class="form-control" name="maxMembers" placeholder="8" required>
                    </div>
                    <div class="form-group">
                        <label>Açıklama</label>
                        <textarea class="form-control" name="description" rows="3" placeholder="Grup açıklaması..."></textarea>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">✅ Kaydet</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('groupModal')">❌ İptal</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Payment Plan Modal -->
    <div id="paymentPlanModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('paymentPlanModal')">&times;</span>
            <h3 id="paymentPlanTitle">📅 Ödeme Planı</h3>
            <div id="paymentPlanContent"></div>
        </div>
    </div>

    <!-- Group Assignment Modal -->
    <div id="groupAssignModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('groupAssignModal')">&times;</span>
            <h3 id="groupAssignTitle">👥 Grup İşlemleri</h3>
            <div id="groupAssignContent"></div>
        </div>
    </div>
    
    <!-- Member Edit Modal -->
    <div id="memberEditModal" class="modal">
        <div class="modal-content member-edit-modal">
            <span class="close" onclick="closeModal('memberEditModal')">&times;</span>
            <div class="modal-header">
                <h2>✏️ Üye Bilgilerini Düzenle</h2>
                <p style="color: #666; font-size: 0.9em; margin: 5px 0 0 0;">Üye bilgilerini güncellemek için formu doldurun</p>
            </div>
            
            <form id="memberEditForm">
                <input type="hidden" name="memberId">
                
                <!-- Öğrenci Bilgileri Section -->
                <div class="form-section">
                    <div class="section-header">
                        <span class="section-icon">👶</span>
                        <h3 class="section-title">Öğrenci Bilgileri</h3>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Öğrenci Adı Soyadı</label>
                            <input type="text" class="form-control" name="Resit_Olmayan_Adi_Soyadi" placeholder="Boş bırakılırsa yetişkin üye">
                            <small class="form-text">Çocuk üyeler için doldurulmalıdır</small>
                        </div>
                        <div class="form-group">
                            <label>� Öğrenci TC Kimlik No</label>
                            <input type="text" class="form-control" name="studentTc" placeholder="11 haneli TC kimlik numarası" maxlength="11" pattern="[0-9]{11}">
                            <small class="form-text">Öğrenci TC kimlik numarası (11 hane)</small>
                        </div>
                        <div class="form-group">
                            <label>�🎂 Doğum Tarihi</label>
                            <input type="date" class="form-control" name="studentBirthDate">
                            <small class="form-text">Yaş hesaplaması için gereklidir</small>
                        </div>
                    </div>
                </div>
                
                <!-- Veli 1 Section -->
                <div class="form-section">
                    <div class="section-header">
                        <span class="section-icon">👨</span>
                        <h3 class="section-title">Veli 1 Bilgileri</h3>
                        <span class="required-badge">Zorunlu</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Veli 1 Adı Soyadı <span class="required-star">*</span></label>
                            <input type="text" class="form-control" name="Ad_Soyad" required>
                        </div>
                        <div class="form-group">
                            <label>🆔 Veli 1 TC Kimlik No</label>
                            <input type="text" class="form-control" name="parentTc" pattern="[0-9]{11}" maxlength="11" placeholder="11 haneli TC (opsiyonel)">
                        </div>
                        <div class="form-group">
                            <label>📞 Telefon 1 <span class="required-star">*</span></label>
                            <input type="tel" class="form-control" name="Telefon" placeholder="05xxxxxxxxx" required>
                        </div>
                    </div>
                </div>
                
                <!-- Veli 2 Section -->
                <div class="form-section">
                    <div class="section-header">
                        <span class="section-icon">👩</span>
                        <h3 class="section-title">Veli 2 Bilgileri</h3>
                        <span class="optional-badge">Opsiyonel</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Veli 2 Adı Soyadı</label>
                            <input type="text" class="form-control" name="Veli_2_Adi_Soyadi" placeholder="İkinci veli varsa">
                        </div>
                        <div class="form-group">
                            <label>📞 Telefon 2</label>
                            <input type="tel" class="form-control" name="Telefon_2" placeholder="05xxxxxxxxx">
                        </div>
                    </div>
                </div>
                
                <!-- Branş Bilgileri Section -->
                <div class="form-section">
                    <div class="section-header">
                        <span class="section-icon">🎯</span>
                        <h3 class="section-title">Branş ve Durum Bilgileri</h3>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Branş</label>
                            <select class="form-control" name="Brans" id="memberEditBrans">
                                <option value="">Seçiniz...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Durum</label>
                            <select class="form-control" name="status">
                                <option value="active">✅ Aktif</option>
                                <option value="expired">❌ Pasif</option>
                                <option value="frozen">⏸️ Dondurulmuş</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('memberEditModal')">
                        <span>❌</span> İptal
                    </button>
                    <button type="submit" class="btn btn-success">
                        <span>💾</span> Değişiklikleri Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Pre-Registration Edit Modal -->
    <div id="preRegEditModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('preRegEditModal')">&times;</span>
            <h3>✏️ Ön Kayıt Bilgilerini Düzenle</h3>
            <form id="preRegEditForm">
                <input type="hidden" name="preRegId">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Veli Adı Soyadı *</label>
                        <input type="text" class="form-control" name="parentName" required>
                    </div>
                    <div class="form-group">
                        <label id="studentNameLabelEdit">Öğrenci Adı Soyadı</label>
                        <input type="text" class="form-control" name="studentName">
                    </div>
                    <div class="form-group">
                        <label>🆔 Öğrenci TC Kimlik No</label>
                        <input type="text" class="form-control" name="studentTc" placeholder="11 haneli TC" maxlength="11" pattern="[0-9]{11}">
                    </div>
                    <div class="form-group">
                        <label>Branş *</label>
                        <select class="form-control" name="branch" required>
                            <option value="">Seçiniz...</option>
                            <option value="tenis">🎾 Tenis</option>
                            <option value="yuzme">🏊 Yüzme</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label for="preRegEditGroupSearch">Grup</label>
                        <div class="searchable-select-container">
                            <input type="text" id="preRegEditGroupSearch" class="form-control" name="groupSearch" placeholder="Grup ara..." autocomplete="off">
                            <input type="hidden" name="groupId" id="preRegEditGroupId">
                            <div class="searchable-select-results" id="preRegEditGroupResults"></div>
                        </div>
                    </div>
                </div>
                 <div class="form-group">
                    <label>Notlar</label>
                    <textarea class="form-control" name="notes" rows="3"></textarea>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">💾 Kaydet</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('preRegEditModal')">❌ İptal</button>
                </div>
            </form>
        </div>
    </div>
    
     <!-- Attendance Modal -->
    <div id="attendanceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('attendanceModal')">&times;</span>
            <h3 id="attendanceModalTitle">📝 Yoklama</h3>
            <form id="attendanceForm">
                <input type="hidden" name="groupId">
                <div class="form-group">
                    <label for="attendanceDate">Yoklama Tarihi</label>
                    <input type="date" id="attendanceDate" name="attendanceDate" class="form-control">
                </div>
                <p>Derse katılmayan öğrencilerin işaretini lütfen kaldırınız.</p>
                <div id="attendanceList" class="attendance-list"></div>
                <div class="btn-group" style="margin-top:20px;">
                    <button type="submit" class="btn btn-success">✅ Yoklamayı Gönder</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('attendanceModal')">❌ İptal</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Member Attendance Modal -->
    <div id="addMemberAttendanceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addMemberAttendanceModal')">&times;</span>
            <h3>➕ Yeni Yoklama Ekle</h3>
            <form id="addMemberAttendanceForm">
                <input type="hidden" id="singleMemberId" name="memberId">
                
                <div class="form-group">
                    <label for="singleAttendanceDate">📅 Yoklama Tarihi *</label>
                    <input type="date" id="singleAttendanceDate" name="date" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="singleAttendanceGroup">👥 Grup *</label>
                    <select id="singleAttendanceGroup" name="groupId" class="form-control" required>
                        <option value="">Grup Seçin</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="singleAttendanceStatus">✅ Durum *</label>
                    <select id="singleAttendanceStatus" name="status" class="form-control" required>
                        <option value="present">Katıldı</option>
                        <option value="absent">Katılmadı</option>
                    </select>
                </div>
                
                <div class="form-group" id="singleReasonGroup" style="display: none;">
                    <label for="singleAttendanceReason">📝 Devamsızlık Sebebi</label>
                    <input type="text" id="singleAttendanceReason" name="reason" class="form-control" placeholder="Sebep (opsiyonel)">
                </div>
                
                <div class="btn-group" style="margin-top: 20px;">
                    <button type="submit" class="btn btn-success">✅ Yoklama Kaydet</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('addMemberAttendanceModal')">❌ İptal</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('taskModal')">&times;</span>
            <h3 id="taskModalTitle">Yeni Görev Ekle</h3>
            <form id="taskForm">
                <input type="hidden" name="taskId">
                <div class="form-grid">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="taskName">Görev Açıklaması *</label>
                        <input type="text" id="taskName" class="form-control" name="taskName" required>
                    </div>
                    <div class="form-group">
                        <label for="assignedTo">Sorumlu Kişi *</label>
                        <select id="assignedTo" class="form-control" name="assignedTo" required></select>
                    </div>
                    <div class="form-group">
                        <label for="taskStatus">Aşama *</label>
                        <select id="taskStatus" class="form-control" name="status" required>
                            <option value="Bekliyor">Bekliyor</option>
                            <option value="Devam Ediyor">Devam Ediyor</option>
                            <option value="Tamamlandı">Tamamlandı</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="taskNotes">Notlar</label>
                        <textarea id="taskNotes" class="form-control" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">✅ Kaydet</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('taskModal')">❌ İptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Task Messages Modal -->
    <div id="taskMessagesModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 80vh;">
            <span class="close" onclick="closeModal('taskMessagesModal')">&times;</span>
            <h3 id="taskMessagesModalTitle">💬 Mesajlar</h3>
            <div id="taskMessagesList" style="max-height: 400px; overflow-y: auto; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;"></div>
            <form id="taskMessageForm">
                <input type="hidden" name="taskId">
                <div class="form-group">
                    <label for="messageText">Mesajınız</label>
                    <textarea id="messageText" name="messageText" class="form-control" rows="3" placeholder="Mesajınızı yazın..." required></textarea>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">📤 Gönder</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('taskMessagesModal')">İptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Edit Modal -->
    <div id="userEditModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('userEditModal')">&times;</span>
            <h3>👤 Yönetici Düzenle</h3>
            <form id="userEditForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editUserFullName">Ad Soyad *</label>
                        <input type="text" class="form-control" name="fullName" required>
                    </div>
                    <div class="form-group">
                        <label for="editUserPhone">Telefon Numarası *</label>
                        <input type="tel" class="form-control" name="phone" placeholder="5449367543" autocomplete="tel" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editUserRole">Rol</label>
                    <select name="role" class="form-control">
                        <option value="">(Belirtilmedi)</option>
                        <option value="admin">Admin</option>
                        <option value="muhasebe">Muhasebe</option>
                        <option value="antrenor">Antrenör</option>
                        <option value="crm">CRM</option>
                        <option value="viewer">Görüntüleyici</option>
                    </select>
                    <small style="color:#666;">Rol seçimi, hazır izin setlerini otomatik uygulayabilir. Seçimi değiştirdikten sonra yetkileri düzenleyebilirsiniz.</small>
                </div>
                <div class="form-group">
                    <label for="editUserPassword">Şifre *</label>
                    <input type="password" class="form-control" name="password" autocomplete="current-password" required>
                </div>
                <div class="form-group">
                    <label>Yetkiler</label>
                    <div class="checkbox-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        <strong style="grid-column: 1 / -1; color: #1976d2; margin-bottom: 5px;">💰 Finansal Yetkiler</strong>
                        <label><input type="checkbox" name="permissions" value="view_payments"> Ödemeleri Görüntüleme</label>
                        <label><input type="checkbox" name="permissions" value="edit_payments"> Ödemeleri Düzenleme</label>
                        <label><input type="checkbox" name="permissions" value="delete_payments"> Ödemeleri Silme</label>
                        <label><input type="checkbox" name="permissions" value="export_payments"> Ödemeleri Dışa Aktarma</label>
                        
                        <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">👥 Üye Yetkileri</strong>
                        <label><input type="checkbox" name="permissions" value="view_members"> Üyeleri Görüntüleme</label>
                        <label><input type="checkbox" name="permissions" value="add_members"> Üye Ekleme</label>
                        <label><input type="checkbox" name="permissions" value="edit_members"> Üye Düzenleme</label>
                        <label><input type="checkbox" name="permissions" value="delete_members"> Üye Silme</label>
                        <label><input type="checkbox" name="permissions" value="export_members"> Üyeleri Dışa Aktarma</label>
                        
                        <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">📞 CRM Yetkileri</strong>
                        <label><input type="checkbox" name="permissions" value="view_crm"> CRM Görüntüleme</label>
                        <label><input type="checkbox" name="permissions" value="add_crm"> CRM'e Ekleme</label>
                        <label><input type="checkbox" name="permissions" value="edit_crm"> CRM Düzenleme</label>
                        <label><input type="checkbox" name="permissions" value="delete_crm"> CRM'den Silme</label>
                        <label><input type="checkbox" name="permissions" value="view_calls"> Arama Kayıtlarını Görüntüleme</label>
                        
                        <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">💬 İletişim Yetkileri</strong>
                        <label><input type="checkbox" name="permissions" value="send_messages"> Mesaj Gönderme</label>
                        <label><input type="checkbox" name="permissions" value="send_bulk_messages"> Toplu Mesaj Gönderme</label>
                        <label><input type="checkbox" name="permissions" value="view_message_history"> Mesaj Geçmişini Görüntüleme</label>
                        
                        <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">📊 Raporlar ve İstatistikler</strong>
                        <label><input type="checkbox" name="permissions" value="view_stats"> İstatistikleri Görüntüleme</label>
                        <label><input type="checkbox" name="permissions" value="view_reports"> Raporları Görüntüleme</label>
                        <label><input type="checkbox" name="permissions" value="export_reports"> Raporları Dışa Aktarma</label>
                        
                        <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">⚙️ Ayarlar ve Yönetim</strong>
                        <label><input type="checkbox" name="permissions" value="manage_users"> Kullanıcı Yönetimi</label>
                        <label><input type="checkbox" name="permissions" value="manage_settings"> Ayarları Yönetme</label>
                        <label><input type="checkbox" name="permissions" value="manage_branches"> Branş Yönetimi</label>
                        <label><input type="checkbox" name="permissions" value="manage_groups"> Grup Yönetimi</label>
                        
                        <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">📋 Yoklama ve Takvim</strong>
                        <label><input type="checkbox" name="permissions" value="view_attendance"> Yoklama Görüntüleme</label>
                        <label><input type="checkbox" name="permissions" value="edit_attendance"> Yoklama Düzenleme</label>
                        <label><input type="checkbox" name="permissions" value="manage_schedule"> Takvim Yönetimi</label>
                    </div>
                </div>

                <!-- Branch selection moved into user edit modal -->
                <div class="form-group">
                    <label style="font-weight:600;">🎯 Branşlar (görüntüleme)</label>
                    <div id="userEditBranchCheckboxes" style="display:grid; grid-template-columns:1fr 1fr; gap:8px; padding:8px; border:1px solid #eee; border-radius:6px; max-height:160px; overflow:auto; background:#fafafa;">
                        <!-- Dynamically filled when opening modal -->
                    </div>
                    <small style="color:#666;">Hiçbir branş seçilmezse kullanıcı tüm branşları görebilir.</small>
                </div>

                <!-- Page access checkboxes -->
                <div class="form-group">
                    <label style="font-weight:600;">📄 Sayfa Erişimleri</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; padding:8px; border:1px solid #eee; border-radius:6px; background:#fff;">
                        <label><input type="checkbox" name="pageAccess" value="members"> Üyeler</label>
                        <label><input type="checkbox" name="pageAccess" value="preRegistrations"> Ön Kayıtlar</label>
                        <label><input type="checkbox" name="pageAccess" value="crm"> CRM</label>
                        <label><input type="checkbox" name="pageAccess" value="messages"> Mesajlar</label>
                        <label><input type="checkbox" name="pageAccess" value="payments"> Ödemeler</label>
                        <label><input type="checkbox" name="pageAccess" value="reports"> Raporlar</label>
                        <label><input type="checkbox" name="pageAccess" value="settings"> Ayarlar</label>
                        <label><input type="checkbox" name="pageAccess" value="attendance"> Yoklama</label>
                        <label><input type="checkbox" name="pageAccess" value="schedule"> Takvim</label>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">✅ Güncelle</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('userEditModal')">İptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Branch Assignment Modal -->
    <div id="branchAssignModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeModal('branchAssignModal')">&times;</span>
            <h3 style="display: flex; align-items: center; gap: 10px;">
                🎯 Branş Atama
            </h3>
            <p style="color: #666; margin-bottom: 20px;">
                Bu yöneticinin görüntüleyebileceği branşları seçin. Hiçbir branş seçilmezse tüm branşları görebilir.
            </p>
            <form id="branchAssignForm">
                <input type="hidden" name="userId">
                <div class="form-group">
                    <label style="font-weight: 600; margin-bottom: 10px; display: block;">👤 Yönetici:</label>
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                        <div id="branchAssignUserName" style="font-weight: 500;"></div>
                        <div id="branchAssignUserEmail" style="color: #666; font-size: 14px;"></div>
                    </div>
                    
                    <label style="font-weight: 600; margin-bottom: 10px; display: block;">🎯 Erişilebilir Branşlar:</label>
                    <div id="branchCheckboxes" style="display: grid; grid-template-columns: 1fr; gap: 10px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; background: #fafafa;">
                        <!-- Branşlar dinamik olarak yüklenecek -->
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <small style="color: #856404;">
                            💡 <strong>İpucu:</strong> Hiçbir branş seçilmezse yönetici <strong>tüm branşları</strong> görebilir.
                        </small>
                    </div>
                </div>
                <div class="btn-group" style="margin-top: 20px;">
                    <button type="submit" class="btn btn-success">✅ Kaydet</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('branchAssignModal')">İptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeModal('profileModal')">&times;</span>
            <h3>Profilimi Düzenle</h3>
            <form id="profileForm">
                <div class="form-group">
                    <label for="profileFullName">Ad Soyad</label>
                    <input type="text" id="profileFullName" name="fullName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="profilePhone">Telefon Numarası</label>
                    <input type="tel" id="profilePhone" name="phone" class="form-control" placeholder="5449367543" autocomplete="tel">
                    <small style="color: #666;">WhatsApp bildirimleri için gereklidir</small>
                </div>
                <div class="form-group">
                    <label for="newPassword">Yeni Şifre (değiştirmek istemiyorsanız boş bırakın)</label>
                    <input type="password" id="newPassword" name="newPassword" class="form-control" autocomplete="new-password">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Yeni Şifre Tekrar</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" autocomplete="new-password">
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">✅ Güncelle</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('profileModal')">İptal</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 id="confirmTitle">İşlemi Onayla</h3>
            <p id="confirmText" style="margin: 20px 0;">Bu işlemi gerçekleştirmek istediğinizden emin misiniz? Bu geri alınamaz.</p>
            <div class="btn-group">
                <button id="confirmYesBtn" class="btn btn-danger">Evet, Onayla</button>
                <button class="btn btn-secondary" onclick="closeModal('confirmModal')">Hayır, İptal</button>
            </div>
        </div>
    </div>

    <!-- Choice Modal -->
    <div id="choiceModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeModal('choiceModal')">&times;</span>
            <h3 id="choiceTitle">İşlemi Seçin</h3>
            <p id="choiceText" style="margin: 20px 0;"></p>
            <div class="btn-group" id="choiceButtons" style="flex-direction: row; justify-content: flex-end;">
                <!-- Buttons will be injected here by JS -->
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrCodeModal" class="modal">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <span class="close" onclick="closeModal('qrCodeModal')">&times;</span>
            <h3 id="qrCodeTitle">📱 WhatsApp QR Kod</h3>
            <p style="margin: 20px 0; color: #666;">WhatsApp telefonunuzdan bu QR kodu okutun:</p>
            <img id="qrCodeImage" src="" alt="QR Code" style="max-width: 100%; height: auto; border-radius: 8px; margin: 20px 0;">
            <p style="color: #666; font-size: 0.9em;">WhatsApp > Ayarlar > Bağlı Cihazlar > Cihaz Bağla</p>
            <button class="btn btn-secondary" onclick="closeModal('qrCodeModal')">Kapat</button>
        </div>
            </div> <!-- /admin-content -->
        </div> <!-- /main-content-wrapper -->
    </div> <!-- /main-wrapper -->

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <span class="close" onclick="closeModal('addExpenseModal')">&times;</span>
            <h3 style="margin-bottom: 25px; color: #f44336; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 32px;">💸</span>
                Yeni Gider Ekle
            </h3>
            <form id="expenseForm" onsubmit="handleExpenseFormSubmit(event)">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">💵 Tutar (₺) *</label>
                    <input type="number" id="expenseAmount" class="form-control" required step="0.01" min="0.01" placeholder="0.00" style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">📅 Tarih *</label>
                    <input type="date" id="expenseDate" class="form-control" required style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">📂 Kategori *</label>
                    <select id="expenseCategory" class="form-control" required style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                        <option value="">Seçiniz...</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">🏢 Branş *</label>
                    <select id="expenseBranch" class="form-control" required style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                        <option value="Genel">🌐 Genel (Tüm Branşlar)</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">📝 Açıklama *</label>
                    <textarea id="expenseDescription" class="form-control" required rows="3" placeholder="Gider açıklaması..." style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px; resize: vertical;"></textarea>
                </div>
                <div class="btn-group" style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addExpenseModal')">İptal</button>
                    <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #f44336 0%, #e53935 100%); border: none;">
                        ✅ Gider Ekle
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Expense Category Manager Modal -->
    <div id="expenseCategoryManagerModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('expenseCategoryManagerModal')">&times;</span>
            <h3 style="margin-bottom: 25px; color: #f44336; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 32px;">📂</span>
                Gider Kategorileri Yönetimi
            </h3>
            
            <div style="margin-bottom: 30px;">
                <h4 style="margin-bottom: 15px;">➕ Yeni Kategori Ekle</h4>
                <form id="expenseCategoryQuickForm" onsubmit="addExpenseCategoryQuick(event)">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Kategori Adı</label>
                            <input type="text" id="quickExpenseCategoryName" class="form-control" placeholder="Örn: Elektrik" required style="padding: 10px;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">İkon Seçimi</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">Hazır İkonlardan Seç</label>
                                <div id="expenseIconPicker" style="display: flex; gap: 8px; flex-wrap: wrap; padding: 10px; background: #f5f5f5; border-radius: 8px; border: 2px solid #e0e0e0;">
                                    <button type="button" class="icon-option" data-icon="💰" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('💰')">💰</button>
                                    <button type="button" class="icon-option" data-icon="💳" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('💳')">💳</button>
                                    <button type="button" class="icon-option" data-icon="💵" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('💵')">💵</button>
                                    <button type="button" class="icon-option" data-icon="🏠" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('🏠')">🏠</button>
                                    <button type="button" class="icon-option" data-icon="⚡" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('⚡')">⚡</button>
                                    <button type="button" class="icon-option" data-icon="💡" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('💡')">💡</button>
                                    <button type="button" class="icon-option" data-icon="🔧" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('🔧')">🔧</button>
                                    <button type="button" class="icon-option" data-icon="📄" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('📄')">📄</button>
                                    <button type="button" class="icon-option" data-icon="🚗" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('🚗')">🚗</button>
                                    <button type="button" class="icon-option" data-icon="🍴" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('🍴')">🍴</button>
                                    <button type="button" class="icon-option" data-icon="📱" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('📱')">📱</button>
                                    <button type="button" class="icon-option" data-icon="🌐" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('🌐')">🌐</button>
                                    <button type="button" class="icon-option" data-icon="📦" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('📦')">📦</button>
                                    <button type="button" class="icon-option" data-icon="🛠️" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('🛠️')">🛠️</button>
                                    <button type="button" class="icon-option" data-icon="🎯" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('🎯')">🎯</button>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">veya Kendi İkonunu Gir</label>
                                <input type="text" id="quickExpenseCategoryIcon" class="form-control" placeholder="⚡ veya emoji girin" style="padding: 10px; text-align: center; font-size: 20px;">
                            </div>
                            <div style="padding-top: 20px;">
                                <div id="expenseSelectedIcon" style="font-size: 32px; padding: 10px; background: #e3f2fd; border-radius: 8px; min-width: 60px; text-align: center; border: 2px solid #2196f3;">📦</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: right; padding-top: 10px; border-top: 1px solid #eee;">
                        <button type="submit" class="btn btn-primary" style="padding: 12px 30px; font-size: 16px; font-weight: 600;">
                            💾 Kaydet
                        </button>
                    </div>
                </form>
            </div>
            
            <div>
                <h4 style="margin-bottom: 15px;">📋 Kategoriler</h4>
                <div id="expenseCategoriesModalContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto;">
                    <!-- Kategoriler buraya yüklenecek -->
                </div>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee; text-align: right;">
                <button class="btn btn-secondary" onclick="closeModal('expenseCategoryManagerModal')">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Product Category Manager Modal -->
    <div id="productCategoryManagerModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('productCategoryManagerModal')">&times;</span>
            <h3 style="margin-bottom: 25px; color: #ff9800; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 32px;">📂</span>
                Ürün Kategorileri Yönetimi
            </h3>
            
            <div style="margin-bottom: 30px;">
                <h4 style="margin-bottom: 15px;">➕ Yeni Kategori Ekle</h4>
                <form id="productCategoryQuickForm" onsubmit="addProductCategoryQuick(event)">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Kategori Adı</label>
                            <input type="text" id="quickProductCategoryName" class="form-control" placeholder="Örn: Spor Ayakkabısı" required style="padding: 10px;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">İkon Seçimi</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">Hazır İkonlardan Seç</label>
                                <div id="productIconPicker" style="display: flex; gap: 8px; flex-wrap: wrap; padding: 10px; background: #f5f5f5; border-radius: 8px; border: 2px solid #e0e0e0;">
                                    <button type="button" class="icon-option" data-icon="👟" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('👟')">👟</button>
                                    <button type="button" class="icon-option" data-icon="👕" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('👕')">👕</button>
                                    <button type="button" class="icon-option" data-icon="⚽" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('⚽')">⚽</button>
                                    <button type="button" class="icon-option" data-icon="🏀" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('🏀')">🏀</button>
                                    <button type="button" class="icon-option" data-icon="🎾" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('🎾')">🎾</button>
                                    <button type="button" class="icon-option" data-icon="🏋️" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('🏋️')">🏋️</button>
                                    <button type="button" class="icon-option" data-icon="🎽" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('🎽')">🎽</button>
                                    <button type="button" class="icon-option" data-icon="🧢" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('🧢')">🧢</button>
                                    <button type="button" class="icon-option" data-icon="🧤" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('🧤')">🧤</button>
                                    <button type="button" class="icon-option" data-icon="🎒" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('🎒')">🎒</button>
                                    <button type="button" class="icon-option" data-icon="💼" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('💼')">💼</button>
                                    <button type="button" class="icon-option" data-icon="🥤" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('🥤')">🥤</button>
                                    <button type="button" class="icon-option" data-icon="🍫" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('🍫')">🍫</button>
                                    <button type="button" class="icon-option" data-icon="💳" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('💳')">💳</button>
                                    <button type="button" class="icon-option" data-icon="📦" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('📦')">📦</button>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">veya Kendi İkonunu Gir</label>
                                <input type="text" id="quickProductCategoryIcon" class="form-control" placeholder="👟 veya emoji girin" style="padding: 10px; text-align: center; font-size: 20px;">
                            </div>
                            <div style="padding-top: 20px;">
                                <div id="productSelectedIcon" style="font-size: 32px; padding: 10px; background: #fff3e0; border-radius: 8px; min-width: 60px; text-align: center; border: 2px solid #ff9800;">📦</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: right; padding-top: 10px; border-top: 1px solid #eee;">
                        <button type="submit" class="btn btn-primary" style="padding: 12px 30px; font-size: 16px; font-weight: 600;">
                            💾 Kaydet
                        </button>
                    </div>
                </form>
            </div>
            
            <div>
                <h4 style="margin-bottom: 15px;">📋 Kategoriler</h4>
                <div id="productCategoriesModalContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto;">
                    <!-- Kategoriler buraya yüklenecek -->
                </div>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee; text-align: right;">
                <button class="btn btn-secondary" onclick="closeModal('productCategoryManagerModal')">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Add Income Modal -->
    <div id="addIncomeModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <span class="close" onclick="closeModal('addIncomeModal')">&times;</span>
            <h3 style="margin-bottom: 25px; color: #4caf50; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 32px;">💰</span>
                Yeni Gelir Ekle
            </h3>
            <form id="incomeForm" onsubmit="handleIncomeFormSubmit(event)">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">💵 Tutar (₺) *</label>
                    <input type="number" id="incomeAmount" class="form-control" required step="0.01" min="0.01" placeholder="0.00" style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">📂 Kategori *</label>
                    <select id="incomeCategory" class="form-control" required style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                        <option value="">Seçiniz...</option>
                        <option value="Aidat">💳 Aidat</option>
                        <option value="Diğer Gelir">� Diğer Gelir</option>
                    </select>
                    <small style="color: #888; font-size: 12px; display: block; margin-top: 5px;">💡 Ürün satışları "Ürünler" sekmesinden yapılır</small>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">🏢 Branş *</label>
                    <select id="incomeBranch" class="form-control" required style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                        <option value="">Seçiniz...</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">📅 Tarih *</label>
                    <input type="date" id="incomeDate" class="form-control" required style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">📝 Açıklama</label>
                    <textarea id="incomeDescription" class="form-control" rows="3" placeholder="Gelir açıklaması (opsiyonel)" style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px; resize: vertical;"></textarea>
                </div>
                <div class="btn-group" style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addIncomeModal')">İptal</button>
                    <button type="submit" class="btn btn-success" style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); border: none;">
                        ✅ Gelir Ekle
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Gelir Kategori Yönetimi Modal -->
    <div id="incomeCategoryManagerModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('incomeCategoryManagerModal')">&times;</span>
            <h3 style="margin-bottom: 25px; color: #4caf50; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 32px;">📂</span>
                Gelir Kategorileri Yönetimi
            </h3>
            
            <div style="margin-bottom: 30px;">
                <h4 style="margin-bottom: 15px;">➕ Yeni Kategori Ekle</h4>
                <form id="addCategoryForm" onsubmit="handleAddIncomeCategory(event)">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Kategori Adı</label>
                            <input type="text" id="newCategoryName" class="form-control" placeholder="Örn: Kurs Ücreti" required style="padding: 10px;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">İkon Seçimi</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">Hazır İkonlardan Seç</label>
                                <div id="incomeIconPicker" style="display: flex; gap: 8px; flex-wrap: wrap; padding: 10px; background: #f5f5f5; border-radius: 8px; border: 2px solid #e0e0e0;">
                                    <button type="button" class="icon-option" data-icon="💰" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectIncomeIcon('💰')">💰</button>
                                    <button type="button" class="icon-option" data-icon="💳" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectIncomeIcon('💳')">💳</button>
                                    <button type="button" class="icon-option" data-icon="💵" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectIncomeIcon('💵')">💵</button>
                                    <button type="button" class="icon-option" data-icon="🎓" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectIncomeIcon('🎓')">🎓</button>
                                    <button type="button" class="icon-option" data-icon="🏆" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectIncomeIcon('🏆')">🏆</button>
                                    <button type="button" class="icon-option" data-icon="🎯" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectIncomeIcon('🎯')">🎯</button>
                                    <button type="button" class="icon-option" data-icon="🎪" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectIncomeIcon('🎪')">🎪</button>
                                    <button type="button" class="icon-option" data-icon="🎨" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectIncomeIcon('🎨')">🎨</button>
                                    <button type="button" class="icon-option" data-icon="📚" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectIncomeIcon('📚')">📚</button>
                                    <button type="button" class="icon-option" data-icon="🎁" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectIncomeIcon('🎁')">🎁</button>
                                    <button type="button" class="icon-option" data-icon="⚽" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectIncomeIcon('⚽')">⚽</button>
                                    <button type="button" class="icon-option" data-icon="🏃" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectIncomeIcon('🏃')">🏃</button>
                                    <button type="button" class="icon-option" data-icon="🎾" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectIncomeIcon('🎾')">🎾</button>
                                    <button type="button" class="icon-option" data-icon="🏊" style="font-size: 28px; padding: 8px; border: 2px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectIncomeIcon('🏊')">🏊</button>
                                    <button type="button" class="icon-option" data-icon="📦" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectIncomeIcon('📦')">📦</button>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">veya Kendi İkonunu Gir</label>
                                <input type="text" id="newCategoryIcon" class="form-control" placeholder="🎓 veya emoji girin" style="padding: 10px; text-align: center; font-size: 20px;">
                            </div>
                            <div style="padding-top: 20px;">
                                <div id="incomeSelectedIcon" style="font-size: 32px; padding: 10px; background: #e8f5e9; border-radius: 8px; min-width: 60px; text-align: center; border: 2px solid #4caf50;">📦</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: right; padding-top: 10px; border-top: 1px solid #eee;">
                        <button type="submit" class="btn btn-success" style="padding: 12px 30px; font-size: 16px; font-weight: 600;">
                            � Kaydet
                        </button>
                    </div>
                </form>
            </div>
            
            <div>
                <h4 style="margin-bottom: 15px;">📋 Kategoriler</h4>
                <div id="incomeCategoryList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto;">
                    <!-- Kategoriler buraya yüklenecek -->
                </div>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee; text-align: right;">
                <button class="btn btn-secondary" onclick="closeModal('incomeCategoryManagerModal')">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <span class="close" onclick="closeModal('addProductModal')">&times;</span>
            <h3 style="margin-bottom: 25px; color: #ff9800; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 32px;">🛍️</span>
                Yeni Ürün Ekle
            </h3>
            <form id="productForm" onsubmit="handleProductFormSubmit(event)">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">🏷️ Ürün Adı *</label>
                    <input type="text" id="productName" class="form-control" required placeholder="Ürün adı..." style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">📂 Kategori *</label>
                    <select id="productCategory" class="form-control" required style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                        <option value="">Seçiniz...</option>
                        <option value="Ekipman">⚽ Ekipman</option>
                        <option value="Kıyafet">👕 Kıyafet</option>
                        <option value="Abonelik">💳 Abonelik</option>
                        <option value="Diğer">📦 Diğer</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">🏢 Branş *</label>
                    <select id="productBranch" class="form-control" required style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                        <option value="Genel">🌐 Genel (Tüm Branşlar)</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">💰 Alış Fiyatı (₺)</label>
                        <input type="number" id="productCostPrice" class="form-control" step="0.01" min="0" placeholder="0.00" style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                        <small style="color: #666; display: block; margin-top: 5px;">Opsiyonel</small>
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">💵 Satış Fiyatı (₺) *</label>
                        <input type="number" id="productPrice" class="form-control" required step="0.01" min="0.01" placeholder="0.00" style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">📦 Stok Adedi</label>
                    <input type="number" id="productStock" class="form-control" step="1" min="0" placeholder="0" value="0" style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                    <small style="color: #666; display: block; margin-top: 5px;">Opsiyonel - boş bırakabilirsiniz</small>
                </div>
                <div class="btn-group" style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addProductModal')">İptal</button>
                    <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); border: none;">
                        ✅ Ürün Ekle
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Product Sale Modal -->
    <div id="productSaleModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <span class="close" onclick="closeModal('productSaleModal')">&times;</span>
            <h3 style="margin-bottom: 25px; color: #4caf50; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 32px;">💰</span>
                <span id="saleModalTitle">Ürün Satışı</span>
            </h3>
            
            <div id="saleProductInfo" style="background: #f0f7ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>
            
            <form id="productSaleForm" onsubmit="handleProductSaleFormSubmit(event)">
                <input type="hidden" id="saleProductId">
                <input type="hidden" id="saleProductPrice">
                <input type="hidden" id="saleProductStock">
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">📦 Satış Miktarı *</label>
                    <input type="number" id="saleQuantity" class="form-control" required min="1" value="1" onchange="calculateSaleTotal()" style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">💵 Birim Fiyat (₺)</label>
                    <input type="number" id="saleUnitPrice" class="form-control" required step="0.01" onchange="calculateSaleTotal()" style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">💰 Toplam Tutar</label>
                    <input type="number" id="saleTotalAmount" class="form-control" readonly style="background: #f5f5f5; font-weight: bold; font-size: 18px; color: #4caf50; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0;">
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">🏢 Branş *</label>
                    <select id="saleBranch" class="form-control" required style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                        <option value="">Seçiniz...</option>
                    </select>
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">👤 Müşteri/Alıcı</label>
                    <input type="text" id="saleCustomer" class="form-control" placeholder="Müşteri adı (opsiyonel)" style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">📝 Not</label>
                    <textarea id="saleNote" class="form-control" rows="2" placeholder="Satış notu (opsiyonel)" style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px; resize: vertical;"></textarea>
                </div>
                
                <div class="btn-group" style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('productSaleModal')">İptal</button>
                    <button type="submit" class="btn btn-success" style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); border: none;">
                        💰 Satışı Tamamla
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Message Detail Modal -->
    <div id="messageDetailModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('messageDetailModal')">&times;</span>
            <h3 id="messageDetailTitle">📩 Mesaj Detayı</h3>
            <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
                <div style="margin-bottom: 15px;">
                    <strong>👤 Alıcı:</strong> <span id="messageDetailRecipient"></span>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>📱 Telefon:</strong> <span id="messageDetailPhone"></span>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>📅 Tarih:</strong> <span id="messageDetailDate"></span>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>📡 Cihaz:</strong> <span id="messageDetailInstance"></span>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>✅ Durum:</strong> <span id="messageDetailStatus"></span>
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #ddd;">
                    <strong>💬 Mesaj İçeriği:</strong>
                    <div id="messageDetailText" style="margin-top: 10px; padding: 15px; background: white; border-radius: 8px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; font-family: inherit;"></div>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="closeModal('messageDetailModal')">Kapat</button>
        </div>
    </div>

    <!-- PDF Önizleme Fonksiyonu -->
    <script>
        window.previewContractPDF = async function() {
            try {
                // Sözleşme metnini al
                const contractText = document.getElementById('contractTemplate').value;
                
                if (!contractText || contractText.trim() === '') {
                    alert('⚠️ Lütfen önce sözleşme metnini girin!');
                    return;
                }
                
                // Kulüp bilgilerini al (önce DOM'dan, sonra global değişkenden)
                let settings = {};
                try {
                    // Kulüp adını club-title'dan al
                    const clubTitleElem = document.getElementById('club-title');
                    if (clubTitleElem) {
                        settings.clubName = clubTitleElem.textContent.replace(' - Yönetim Paneli', '').trim();
                    }
                    
                    // Form alanlarından bilgileri al
                    const clubInfoName = document.getElementById('clubInfoName');
                    const clubAddress = document.getElementById('clubAddress');
                    const clubPhone = document.getElementById('clubPhone');
                    const clubEmail = document.getElementById('clubEmail');
                    const contactName = document.getElementById('contactName');
                    const taxNo = document.getElementById('taxNo');
                    
                    if (clubInfoName && clubInfoName.value) settings.clubName = clubInfoName.value;
                    if (clubAddress && clubAddress.value) settings.address = clubAddress.value;
                    if (clubPhone && clubPhone.value) settings.phone = clubPhone.value;
                    if (clubEmail && clubEmail.value) settings.email = clubEmail.value;
                    if (contactName && contactName.value) settings.contactName = contactName.value;
                    if (taxNo && taxNo.value) settings.taxNo = taxNo.value;
                } catch (e) {
                    console.warn('DOM\'dan bilgi alınamadı:', e);
                }
                
                // Fallback olarak global değişkeni kullan
                if (typeof window.clubSettings !== 'undefined') {
                    settings = { ...window.clubSettings, ...settings };
                } else if (typeof clubSettings !== 'undefined') {
                    settings = { ...clubSettings, ...settings };
                }
                
                console.log('📋 Kullanılan ayarlar:', settings);
                
                // Örnek verilerle placeholder'ları doldur (otomatik formatlama YOK)
                let previewHTML = contractText
                    // Kulüp bilgileri
                    .replace(/\{KULUP_ADI\}/g, settings.clubName || settings.clubOfficialName || 'Örnek Spor Kulübü')
                    .replace(/\{KULUP_YETKILI\}/g, settings.contactName || 'Ahmet Yılmaz')
                    .replace(/\{YETKILI_ADI\}/g, settings.contactName || 'Ahmet Yılmaz')
                    .replace(/\{KULUP_ADRES\}/g, settings.address || settings.clubAddress || 'Örnek Mahallesi, No:123, İstanbul')
                    .replace(/\{KULUP_VERGI_NO\}/g, settings.taxNo || '1234567890')
                    .replace(/\{VERGI_NO\}/g, settings.taxNo || '1234567890')
                    .replace(/\{KULUP_TELEFON\}/g, settings.phone || settings.clubPhone || '0555 123 45 67')
                    .replace(/\{KULUP_EMAIL\}/g, settings.email || settings.clubEmail || 'info@ornek.com')
                    // Üye bilgileri
                    .replace(/\{UYE_AD_SOYAD\}/g, 'Mehmet Demir')
                    .replace(/\{Ad_Soyad\}/g, 'Mehmet Demir')
                    .replace(/\{UYE_TCKN\}/g, '12345678901')
                    .replace(/\{TC_Kimlik_No\}/g, '12345678901')
                    .replace(/\{UYE_TELEFON\}/g, '0555 987 65 43')
                    .replace(/\{Telefon\}/g, '0555 987 65 43')
                    .replace(/\{UYE_ADRES\}/g, 'Örnek Sokak No:45, Ankara')
                    .replace(/\{Adres\}/g, 'Örnek Sokak No:45, Ankara')
                    .replace(/\{UYE_DOGUM_TARIHI\}/g, '15.06.1990')
                    .replace(/\{Dogum_Tarihi\}/g, '15.06.1990')
                    .replace(/\{Veli_2_Adi_Soyadi\}/g, 'Ayşe Demir')
                    .replace(/\{Telefon_2\}/g, '0555 111 22 33')
                    // Diğer bilgiler
                    .replace(/\{BRANS\}/g, 'Tenis')
                    .replace(/\{TARIH\}/g, new Date().toLocaleDateString('tr-TR'))
                    .replace(/\{OGRENCI_BILGILERI\}/g, '<p><strong>Öğrenci:</strong> Ali Demir<br><strong>Doğum Tarihi:</strong> 10.05.2015</p>')
                    .replace(/\{OGRENCI_AD_SOYAD\}/g, 'Ali Demir')
                    .replace(/\{OGRENCI_DOGUM_TARIHI\}/g, '10.05.2015')
                    .replace(/\{AIDAT_TAKVIMI\}/g, `
                        <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                            <thead>
                                <tr style="background: #f2f2f2;">
                                    <th style="border: 1px solid #ddd; padding: 8px;">Aidat No</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Dönem</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Tutar</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">1. Aidat</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">01.01.2025 - 31.01.2025</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;"><strong>1.500₺</strong></td>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">2. Aidat</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">01.02.2025 - 28.02.2025</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;"><strong>1.500₺</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    `);
                
                // Modal oluştur
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    width: 90%;
                    max-width: 800px;
                    max-height: 90vh;
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                `;
                
                modalContent.innerHTML = `
                    <div style="padding: 20px; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; color: #333;">📄 Sözleşme PDF Önizlemesi</h3>
                        <button onclick="this.closest('[style*=fixed]').remove()" style="background: #dc3545; color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer; font-size: 14px;">
                            ✕ Kapat
                        </button>
                    </div>
                    <div style="flex: 1; overflow-y: auto; padding: 40px; background: #f8f9fa;">
                        <div style="background: white; padding: 40px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 595px; margin: 0 auto; font-family: Arial, sans-serif; font-size: 12px; line-height: 1.6; color: #333; white-space: pre-wrap;">
                            ${previewHTML}
                        </div>
                    </div>
                    <div style="padding: 20px; border-top: 2px solid #f0f0f0; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
                        <div style="color: #666; font-size: 13px;">
                            💡 <strong>Not:</strong> Bu önizleme örnek verilerle oluşturulmuştur.
                        </div>
                        <button onclick="window.downloadPreviewPDF()" class="btn btn-primary">
                            📥 PDF İndir
                        </button>
                    </div>
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // PDF indirme fonksiyonunu sakla
                window.currentPreviewHTML = previewHTML;
                
            } catch (error) {
                console.error('PDF önizleme hatası:', error);
                console.error('Hata detayları:', {
                    message: error.message,
                    stack: error.stack,
                    clubSettingsDefined: typeof clubSettings !== 'undefined',
                    windowClubSettingsDefined: typeof window.clubSettings !== 'undefined'
                });
                alert('❌ PDF önizlemesi oluşturulurken bir hata oluştu: ' + error.message);
            }
        };
        
        // PDF indirme fonksiyonu
        window.downloadPreviewPDF = async function() {
            try {
                if (!window.jspdf || !window.jspdf.jsPDF) {
                    alert('⚠️ PDF kütüphanesi yüklenemedi. Sayfayı yenileyin.');
                    return;
                }
                
                if (typeof html2canvas === 'undefined') {
                    alert('⚠️ html2canvas kütüphanesi yüklenemedi. Sayfayı yenileyin.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ unit: 'pt', format: 'a4' });
                
                // Kulüp adını al
                let clubName = 'Kulup';
                try {
                    const settings = window.clubSettings || (typeof clubSettings !== 'undefined' ? clubSettings : null);
                    if (settings && settings.clubName) {
                        clubName = settings.clubName;
                    } else {
                        const clubTitleElem = document.getElementById('club-title');
                        if (clubTitleElem) {
                            clubName = clubTitleElem.textContent.replace(' - Yönetim Paneli', '').trim();
                        }
                    }
                } catch (e) {
                    console.warn('Kulüp adı alınamadı, varsayılan kullanılıyor:', e);
                }
                
                // HTML içeriğini <hr> etiketlerine göre sayfalara böl
                const htmlContent = window.currentPreviewHTML || '';
                
                // <hr> varsa böl, yoksa tek sayfa olarak işle
                let pages = [];
                if (/<hr\s*\/?>/gi.test(htmlContent)) {
                    pages = htmlContent.split(/<hr\s*\/?>/gi);
                    console.log(`📄 ${pages.length} sayfa tespit edildi (<hr> ile bölünmüş)`);
                } else {
                    pages = [htmlContent];
                    console.log(`📄 1 sayfa tespit edildi (<hr> yok, tek sayfa)`);
                }
                
                // Boş sayfaları filtrele
                pages = pages.filter(page => page.trim().length > 0);
                console.log(`📄 ${pages.length} sayfa render edilecek`);
                
                // Her sayfa için
                for (let i = 0; i < pages.length; i++) {
                    if (i > 0) {
                        doc.addPage();
                    }
                    
                    // Kulüp adını al
                    let headerTitle = 'Spor Kulübü';
                    try {
                        const clubTitleElem = document.getElementById('club-title');
                        if (clubTitleElem) {
                            headerTitle = clubTitleElem.textContent.replace(' - Yönetim Paneli', '').trim();
                        }
                    } catch (e) {
                        console.warn('Kulüp adı alınamadı:', e);
                    }
                    
                    // Sayfa içeriğini hazırla (ornekpdf.html formatında)
                    const pageHTML = `
                        <!DOCTYPE html>
                        <html lang="tr">
                        <head>
                            <meta charset="UTF-8">
                            <style>
                                body { 
                                    font-family: 'Helvetica', 'Arial', sans-serif; 
                                    font-size: 10px; 
                                    line-height: 1.4; 
                                    color: #333; 
                                    width: 595px;
                                    margin: 0;
                                    padding: 0;
                                }
                                .pdf-page { 
                                    padding: 40px; 
                                    display: flex; 
                                    flex-direction: column; 
                                    height: 842px; 
                                    box-sizing: border-box; 
                                    background: white;
                                }
                                h1 { 
                                    font-size: 18px; 
                                    text-align: center; 
                                    margin-bottom: 15px;
                                    color: #333;
                                } 
                                h4 { 
                                    font-size: 13px; 
                                    margin-top: 15px; 
                                    margin-bottom: 8px;
                                    color: #000;
                                    font-weight: bold;
                                }
                                p {
                                    margin: 5px 0;
                                    text-align: justify;
                                    white-space: normal;
                                    word-wrap: break-word;
                                    overflow-wrap: break-word;
                                }
                                strong {
                                    font-weight: bold;
                                }
                                table {
                                    width: 100%;
                                    border-collapse: collapse;
                                    margin: 10px 0;
                                    font-size: 9px;
                                }
                                th, td {
                                    border: 1px solid #ddd;
                                    padding: 5px;
                                    text-align: left;
                                }
                                th {
                                    background-color: #f2f2f2;
                                    font-weight: bold;
                                }
                                .content { 
                                    flex-grow: 1;
                                    overflow: hidden;
                                    white-space: normal;
                                    word-wrap: break-word;
                                }
                                .footer { 
                                    text-align: center; 
                                    font-size: 9px; 
                                    color: #888; 
                                    border-top: 1px solid #ccc; 
                                    padding-top: 10px; 
                                    margin-top: auto; 
                                    display: flex; 
                                    justify-content: space-between; 
                                    align-items: flex-end;
                                    flex-shrink: 0;
                                }
                                .signature-box { 
                                    border: 2px solid #333;
                                    border-radius: 8px;
                                    padding: 12px;
                                    background: #f9f9f9;
                                    display: flex;
                                    align-items: center;
                                    gap: 15px;
                                }
                                .signature-area {
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                }
                                .signature-placeholder {
                                    width: 150px;
                                    height: 60px;
                                    border: 2px dashed #666;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: #999;
                                    font-size: 9px;
                                    background: white;
                                    border-radius: 4px;
                                }
                                .signature-info {
                                    text-align: left;
                                    border-left: 2px solid #ccc;
                                    padding-left: 15px;
                                }
                                .signature-info p { 
                                    margin: 3px 0; 
                                    font-size: 9px;
                                    color: #333;
                                }
                                .signature-info strong {
                                    font-size: 10px;
                                    color: #000;
                                }
                            </style>
                        </head>
                        <body>
                            <div class="pdf-page">
                                <h1>${headerTitle} Üyelik Sözleşmesi</h1>
                                <div class="content">${pages[i]}</div>
                                <div class="footer">
                                    <div class="signature-box">
                                        <div class="signature-area">
                                            <p style="margin-bottom: 5px; font-size: 10px;"><strong>İMZA</strong></p>
                                            <div class="signature-placeholder">[İmza Alanı]</div>
                                        </div>
                                        <div class="signature-info">
                                            <p><strong>Üye/Veli:</strong> Mehmet Demir</p>
                                            <p><strong>Tarih:</strong> ${new Date().toLocaleDateString('tr-TR', {
                                                year: 'numeric',
                                                month: '2-digit',
                                                day: '2-digit'
                                            })}</p>
                                            <p><strong>Saat:</strong> ${new Date().toLocaleTimeString('tr-TR', {
                                                hour: '2-digit',
                                                minute: '2-digit',
                                                second: '2-digit'
                                            })}</p>
                                        </div>
                                    </div>
                                    <div style="align-self: flex-end; font-size: 9px; color: #666;">Sayfa ${i + 1} / ${pages.length}</div>
                                </div>
                            </div>
                        </body>
                        </html>
                    `;
                    
                    // Geçici container oluştur
                    const tempContainer = document.createElement('div');
                    tempContainer.style.position = 'absolute';
                    tempContainer.style.left = '-9999px';
                    tempContainer.style.width = '595px';
                    tempContainer.style.height = '842px';
                    tempContainer.style.background = 'white';
                    tempContainer.innerHTML = pageHTML;
                    document.body.appendChild(tempContainer);
                    
                    console.log(`📄 Sayfa ${i + 1}/${pages.length} render ediliyor...`);
                    
                    // HTML'i canvas'a çevir - ornekpdf.html ayarları
                    const canvas = await html2canvas(tempContainer, { 
                        scale: 2, 
                        logging: false, 
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        width: 595,
                        height: 842,
                        windowWidth: 595,
                        windowHeight: 842
                    });
                    document.body.removeChild(tempContainer);
                    
                    // Canvas'ı PDF'e ekle - Tam sayfa boyutunda
                    const imgData = canvas.toDataURL('image/jpeg', 0.9);
                    const pdfWidth = doc.internal.pageSize.getWidth();
                    const pdfHeight = doc.internal.pageSize.getHeight();
                    
                    doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight, undefined, 'FAST');
                }
                
                // PDF'i indir
                clubName = clubName.replace(/[^a-zA-Z0-9]/g, '_');
                doc.save(`${clubName}_Sozlesme_Onizleme.pdf`);
                
                alert('✅ PDF başarıyla indirildi!');
                
            } catch (error) {
                console.error('PDF indirme hatası:', error);
                alert('❌ PDF indirilirken bir hata oluştu: ' + error.message);
            }
        };
    </script>
</body>
</html>












