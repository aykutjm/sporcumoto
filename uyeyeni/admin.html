<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sporcum - YÃ¶netim Paneli</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Ccircle cx=%2750%27 cy=%2750%27 r=%2748%27 fill=%27%234f46e5%27/%3E%3Ctext x=%2750%27 y=%2772%27 font-family=%27Arial,sans-serif%27 font-size=%2760%27 font-weight=%27bold%27 fill=%27white%27 text-anchor=%27middle%27%3ES%3C/text%3E%3C/svg%3E">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- PDF Libraries -->
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // âœ… INLINE SUPABASE HELPER - CACHE SORUNU Ã‡Ã–ZÃœMÃœ
        console.log('%cğŸš€ INLINE SUPABASE HELPER YÃœKLENDI!', 'background: #00ff00; color: #000; font-size: 20px; font-weight: bold; padding: 10px;');
        
        let supabaseClient = null;
        let currentUser = null;
        let currentClubId = null;

        function initSupabase(url, anonKey) {
            supabaseClient = window.supabase.createClient(url, anonKey);
            return supabaseClient;
        }

        const auth = {
            async signInWithEmailAndPassword(email, password) {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                currentUser = data.user;
                return { user: data.user };
            },
            async signOut() {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                currentUser = null;
            },
            async onAuthStateChanged(callback) {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    callback(session.user);
                }
                const { data: authListener } = supabaseClient.auth.onAuthStateChange((event, session) => {
                    currentUser = session?.user || null;
                    callback(session?.user || null);
                });
                return authListener;
            },
            async getCurrentUser() {
                const { data: { user } } = await supabaseClient.auth.getUser();
                currentUser = user;
                return user;
            }
        };

        const db = {
            collection(tableName) {
                return { tableName, query: supabaseClient.from(tableName) };
            },
            async getDocs(collectionRef, queryOptions = {}) {
                let query = supabaseClient.from(collectionRef.tableName).select('*');
                if (queryOptions.where) {
                    for (const condition of queryOptions.where) {
                        const [field, operator, value] = condition;
                        switch (operator) {
                            case '==': query = query.eq(field, value); break;
                            case '!=': query = query.neq(field, value); break;
                            case '>': query = query.gt(field, value); break;
                            case '>=': query = query.gte(field, value); break;
                            case '<': query = query.lt(field, value); break;
                            case '<=': query = query.lte(field, value); break;
                            case 'in': query = query.in(field, value); break;
                            case 'array-contains': query = query.contains(field, [value]); break;
                        }
                    }
                }
                if (queryOptions.orderBy) {
                    const [field, direction = 'asc'] = queryOptions.orderBy;
                    query = query.order(field, { ascending: direction === 'asc' });
                }
                if (queryOptions.limit) query = query.limit(queryOptions.limit);
                const { data, error } = await query;
                if (error) throw error;
                const docs = data.map(doc => ({ id: doc.id, data: () => doc, exists: () => true }));
                return { docs: docs, size: data.length, empty: data.length === 0, docChanges: () => docs.map(doc => ({ type: 'added', doc: doc })) };
            },
            async getDoc(docRef) {
                const { data, error } = await supabaseClient.from(docRef.tableName).select('*').eq('id', docRef.id).maybeSingle();
                if (error) throw error;
                return { id: docRef.id, data: () => data || {}, exists: () => !!data };
            },
            async addDoc(collectionRef, data) {
                if (currentClubId && !data.clubId) data.clubId = currentClubId;
                if (!data.id) data.id = `${collectionRef.tableName}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const { data: result, error } = await supabaseClient.from(collectionRef.tableName).insert([data]).select().maybeSingle();
                if (error) throw error;
                return { id: result.id, data: () => result };
            },
            async updateDoc(docRef, data) {
                console.log('ğŸ”§ updateDoc called:', { table: docRef.tableName, id: docRef.id, dataKeys: Object.keys(data) });
                const processedData = {};
                for (const [key, value] of Object.entries(data)) {
                    if (value && typeof value === 'object' && value._type) {
                        console.log(`ğŸ” Array operation: ${value._type} on "${key}"`);
                        const { data: currentDoc } = await supabaseClient.from(docRef.tableName).select(key).eq('id', docRef.id).maybeSingle();
                        console.log(`ğŸ“¥ Current ${key}:`, currentDoc?.[key]);
                        let currentArray = currentDoc?.[key] || [];
                        if (!Array.isArray(currentArray)) currentArray = [];
                        if (value._type === 'arrayUnion') {
                            const newElements = value.elements.filter(el => !currentArray.includes(el));
                            processedData[key] = [...currentArray, ...newElements];
                            console.log(`â• arrayUnion: Adding ${newElements.length} elements to ${key}`);
                        } else if (value._type === 'arrayRemove') {
                            processedData[key] = currentArray.filter(el => !value.elements.includes(el));
                            console.log(`â– arrayRemove: Removing ${value.elements.length} elements from ${key}`);
                        }
                    } else {
                        processedData[key] = value;
                    }
                }
                console.log('ğŸ“¤ Sending to Supabase:', processedData);
                const { data: result, error } = await supabaseClient.from(docRef.tableName).update(processedData).eq('id', docRef.id).select().maybeSingle();
                if (error) { console.error('âŒ Supabase error:', error); throw error; }
                console.log('âœ… Update successful:', result);
                return result;
            },
            async deleteDoc(docRef) {
                const { error } = await supabaseClient.from(docRef.tableName).delete().eq('id', docRef.id);
                if (error) throw error;
            },
            async setDoc(docRef, data) {
                data.id = docRef.id;
                const { data: result, error } = await supabaseClient.from(docRef.tableName).upsert([data], { onConflict: 'id' }).select().maybeSingle();
                if (error) throw error;
                return result;
            },
            doc(tableName, id) {
                return { tableName, id };
            },
            query(collectionRef, ...conditions) {
                const queryOptions = { where: [], orderBy: null, limit: null };
                conditions.forEach(condition => {
                    if (condition.type === 'where') queryOptions.where.push([condition.field, condition.operator, condition.value]);
                    else if (condition.type === 'orderBy') queryOptions.orderBy = [condition.field, condition.direction];
                    else if (condition.type === 'limit') queryOptions.limit = condition.value;
                });
                return { ...collectionRef, queryOptions };
            },
            onSnapshot(collectionRef, callback, errorCallback) {
                const tableName = collectionRef.tableName;
                let previousDocs = [];
                const createSnapshot = (docs) => {
                    const changes = [];
                    const previousIds = new Set(previousDocs.map(d => d.id));
                    const currentIds = new Set(docs.map(d => d.id));
                    docs.forEach(doc => {
                        if (!previousIds.has(doc.id)) changes.push({ type: 'added', doc: doc });
                        else {
                            const prev = previousDocs.find(d => d.id === doc.id);
                            if (prev && JSON.stringify(prev.data()) !== JSON.stringify(doc.data())) changes.push({ type: 'modified', doc: doc });
                        }
                    });
                    previousDocs.forEach(doc => { if (!currentIds.has(doc.id)) changes.push({ type: 'removed', doc: doc }); });
                    previousDocs = docs;
                    return { docs: docs, size: docs.length, empty: docs.length === 0, docChanges: () => changes };
                };
                this.getDocs(collectionRef, collectionRef.queryOptions || {}).then(result => callback(createSnapshot(result.docs))).catch(err => errorCallback && errorCallback(err));
                const subscription = supabaseClient.channel(`public:${tableName}`).on('postgres_changes', { event: '*', schema: 'public', table: tableName }, (payload) => {
                    this.getDocs(collectionRef, collectionRef.queryOptions || {}).then(result => callback(createSnapshot(result.docs))).catch(err => errorCallback && errorCallback(err));
                }).subscribe();
                return () => { subscription.unsubscribe(); };
            }
        };

        function where(field, operator, value) { return { type: 'where', field, operator, value }; }
        function orderBy(field, direction = 'asc') { return { type: 'orderBy', field, direction }; }
        function limit(value) { return { type: 'limit', value }; }
        const arrayUnion = (...elements) => ({ _type: 'arrayUnion', elements });
        const arrayRemove = (...elements) => ({ _type: 'arrayRemove', elements });
        function setCurrentClubId(clubId) { currentClubId = clubId; }

        window.supabaseHelper = { initSupabase, auth, db, where, orderBy, limit, arrayUnion, arrayRemove, setCurrentClubId };
    </script>
    <script type="module">
        // IMPORTANT: Replace with your actual Supabase configuration
        const SUPABASE_URL = 'https://supabase.edu-ai.online';
        const SUPABASE_ANON_KEY = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJzdXBhYmFzZSIsImlhdCI6MTc2MjEwNTMyMCwiZXhwIjo0OTE3Nzc4OTIwLCJyb2xlIjoiYW5vbiJ9.HXUza0GT82-trWkx0WWKe-nY7KsGrIjIHSOJPKsOHjs';
        
        // Initialize Supabase
        const supabase = window.supabaseHelper.initSupabase(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Create Firebase-compatible API wrappers
        const auth = window.supabaseHelper.auth;
        const db = window.supabaseHelper.db;
        
        // Make available globally (for compatibility with existing code)
        window.db = db;
        window.auth = auth;
        window.supabase = supabase;
        window.firebase = {
            // collection() 1 veya 2 parametre alabilir (Firebase uyumluluÄŸu iÃ§in)
            collection: (dbRefOrName, collectionName) => {
                const tableName = collectionName || dbRefOrName;
                return db.collection(tableName);
            },
            addDoc: (collectionRef, data) => db.addDoc(collectionRef, data),
            // getDocs() queryOptions'Ä± da geÃ§meli
            getDocs: (collectionRef) => db.getDocs(collectionRef, collectionRef.queryOptions),
            getDoc: (docRef) => db.getDoc(docRef),
            updateDoc: (docRef, data) => db.updateDoc(docRef, data),
            deleteDoc: (docRef) => db.deleteDoc(docRef),
            // doc() 2 veya 3 parametre alabilir
            doc: (dbRefOrName, collectionOrId, id) => {
                const tableName = id ? collectionOrId : dbRefOrName;
                const docId = id || collectionOrId;
                return db.doc(tableName, docId);
            },
            onSnapshot: (collectionRef, callback, errorCallback) => db.onSnapshot(collectionRef, callback, errorCallback),
            query: (collectionRef, ...conditions) => db.query(collectionRef, ...conditions),
            where: window.supabaseHelper.where,
            orderBy: window.supabaseHelper.orderBy,
            limit: window.supabaseHelper.limit,
            arrayUnion: window.supabaseHelper.arrayUnion,
            arrayRemove: window.supabaseHelper.arrayRemove,
            setDoc: (docRef, data) => db.setDoc(docRef, data)
        };

        // --- GLOBAL STATE ---
        let currentSection = 'dashboard', preRegistrations = [], members = [], schedules = [], groups = [], holidays = [], users = [], attendanceRecords = [], tasks = [], isLoading = false;
        let clubSettings = { 
            clubName: 'Sporcum',
            // âœ… Random bekleme sÃ¼resi ayarlarÄ±
            minWaitTime: 20,
            maxWaitTime: 50,
            longWaitTrigger: 100,
            minLongWait: 400,
            maxLongWait: 800
        };
        let branches = []; // BranÅŸlar listesi (kulÃ¼p bazÄ±nda)
        let paymentFilter = 'all'; // Default payment filter
        let selectedBranchForGroups = null;
        let selectedBranchForSchedule = null;
        let currentUser = null;
        let currentClubId = null; // Åu anki kulÃ¼bÃ¼n ID'si
        
        // CRM iÃ§in global state
        let crmLeads = []; // Potansiyel mÃ¼ÅŸteriler
        let deletedCalls = []; // Silinen Ã§aÄŸrÄ±lar (localStorage'da saklanÄ±yor - kalÄ±cÄ±)
        let hiddenCalls = []; // Gizlenen Ã§aÄŸrÄ±lar
        let showDeletedCalls = false; // Silinenleri gÃ¶ster/gizle
        let selectedIncomingCalls = new Set(); // SeÃ§ili gelen aramalar
        let selectedOutgoingCalls = new Set(); // SeÃ§ili giden aramalar
        
        // Silinen Ã§aÄŸrÄ±larÄ± localStorage'dan yÃ¼kle
        function loadDeletedCalls() {
            try {
                const stored = localStorage.getItem(`deletedCalls_${currentClubId}`);
                if (stored) {
                    deletedCalls = JSON.parse(stored);
                }
            } catch (error) {
                console.error('Silinen Ã§aÄŸrÄ±lar yÃ¼klenirken hata:', error);
                deletedCalls = [];
            }
        }
        
        // Silinen Ã§aÄŸrÄ±larÄ± localStorage'a kaydet
        function saveDeletedCalls() {
            try {
                localStorage.setItem(`deletedCalls_${currentClubId}`, JSON.stringify(deletedCalls));
            } catch (error) {
                console.error('Silinen Ã§aÄŸrÄ±lar kaydedilirken hata:', error);
            }
        }
        let crmTemplates = []; // CRM mesaj ÅŸablonlarÄ±
        let crmStatuses = [
            { id: 'new', name: 'Yeni', icon: 'ğŸ†•', color: '#4CAF50' },
            { id: 'contacted', name: 'Ä°letiÅŸime GeÃ§ildi', icon: 'ğŸ“', color: '#2196F3' },
            { id: 'trial', name: 'Deneme Randevusu', icon: 'ğŸ¾', color: '#FF9800' },
            { id: 'negotiating', name: 'GÃ¶rÃ¼ÅŸme AÅŸamasÄ±nda', icon: 'ğŸ’¬', color: '#9C27B0' },
            { id: 'converted', name: 'Ãœye Oldu', icon: 'âœ…', color: '#4CAF50' },
            { id: 'lost', name: 'KayÄ±p', icon: 'âŒ', color: '#F44336' }
        ];
        let ageSortDirection = 'none'; // 'none', 'asc', 'desc'
        let membersCurrentPage = 1;
        let membersItemsPerPage = 10;
        let whatsappDevices = []; // WhatsApp devices stored in Firebase
        let defaultWhatsAppDevice = null; // Default device for notifications
        let selectedWhatsAppDevice = null; // Currently selected WhatsApp device
        let sentMessages = []; // Message history
        let userActivities = []; // User activity logs
        let incomingMessages = []; // Incoming WhatsApp messages from webhook
        let autoRefreshInterval = null; // Auto-refresh interval
        let lastMessageSentTime = 0; // âœ… Track last message sent time for rate limiting
        let totalMessagesSent = 0; // âœ… Track total messages sent in session for long wait triggers
        
        // âœ… Cache functions for ultra-fast loading
        function applyDataFromCache(data) {
            preRegistrations = data.preRegistrations || [];
            members = data.members || [];
            schedules = data.schedules || [];
            groups = data.groups || [];
            holidays = data.holidays || [];
            users = data.users || [];
            attendanceRecords = data.attendanceRecords || [];
            clubSettings = data.clubSettings || {};
            tasks = data.tasks || [];
            whatsappDevices = data.whatsappDevices || [];
            defaultWhatsAppDevice = data.defaultWhatsAppDevice || null;
            sentMessages = data.sentMessages || [];
            userActivities = data.userActivities || [];
            branches = data.branches || [];
            incomingMessages = data.incomingMessages || [];
            crmLeads = data.crmLeads || [];
            hiddenCalls = data.hiddenCalls || [];
            
            // UI gÃ¼ncelle
            const clubName = clubSettings.clubName || currentUser.clubName || 'Sporcum';
            document.getElementById('club-title').textContent = clubName;
            const clubTitleHeader = document.getElementById('club-title-header');
            if (clubTitleHeader) clubTitleHeader.textContent = `${clubName} - YÃ¶netim Paneli`;
            document.title = `${clubName} - YÃ¶netim Paneli`;
            
            updateBranchDropdowns();
            updateCRMMenuVisibility();
            renderCurrentSection();
            
            // Dashboard'Ä± hemen gÃ¼ncelle (cache'ten veri geldiÄŸinde)
            if (currentSection === 'dashboard') {
                updateDashboard();
            }
        }
        
        function updateCRMMenuVisibility() {
            // CRM menÃ¼sÃ¼ her zaman gÃ¶rÃ¼nÃ¼r - EriÅŸim kontrolÃ¼ iÃ§erikte yapÄ±lacak
            const crmMenuDropdown = document.getElementById('crm-menu-dropdown');
            if (crmMenuDropdown) {
                crmMenuDropdown.style.display = 'block';
            }
        }
        
        function saveDataToCache() {
            const cacheKey = `clubData_${currentClubId}`;
            const data = {
                timestamp: Date.now(),
                preRegistrations,
                members,
                schedules,
                groups,
                holidays,
                users,
                attendanceRecords,
                clubSettings,
                tasks,
                whatsappDevices,
                defaultWhatsAppDevice,
                sentMessages,
                userActivities,
                branches,
                incomingMessages,
                crmLeads,
                hiddenCalls
            };
            
            try {
                localStorage.setItem(cacheKey, JSON.stringify(data));
                console.log('ğŸ’¾ Data cached successfully');
            } catch (e) {
                console.warn('âš ï¸ Cache save error:', e);
                if (e.name === 'QuotaExceededError') {
                    // Storage full, temizle
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('clubData_') && key !== cacheKey) {
                            localStorage.removeItem(key);
                        }
                    }
                }
            }
        }


        // --- AUTHENTICATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            // âœ… Check if user came from giris.html with valid session
            const sessionUser = sessionStorage.getItem('currentUser');
            const userType = sessionStorage.getItem('userType');
            
            if (sessionUser && userType === 'admin') {
                // User logged in from giris.html, skip login screen
                try {
                    currentUser = JSON.parse(sessionUser);
                    currentClubId = currentUser.clubId; // Set club ID from user data
                    window.supabaseHelper.setCurrentClubId(currentClubId); // âœ… Set for Supabase queries
                    
                    if (!currentClubId) {
                        alert('âŒ Bu kullanÄ±cÄ± bir kulÃ¼be atanmamÄ±ÅŸ! LÃ¼tfen SuperAdmin ile iletiÅŸime geÃ§in.');
                        sessionStorage.clear();
                        window.location.replace('giris');
                        return;
                    }
                    
                    console.log('âœ… Session found, auto-login:', currentUser.email || currentUser.fullName);
                    console.log('ğŸ¢ Club ID:', currentClubId, '- Club Name:', currentUser.clubName);
                    
                    // âœ… SayfayÄ± gÃ¶rÃ¼nÃ¼r yap (login ekranÄ± atlandÄ±)
                    document.body.style.visibility = 'visible';
                    
                    // Start app directly (no login overlay needed)
                    startApp();
                    return;
                } catch (error) {
                    console.error('Session parse error:', error);
                    sessionStorage.clear();
                }
            }
            
            // âŒ No valid session, redirect to login page (sayfayÄ± gÃ¶stermeden!)
            console.log('âŒ No valid admin session found, redirecting to giris...');
            sessionStorage.clear();
            
            // Mevcut sayfayÄ± return URL olarak kaydet
            const returnUrl = window.location.pathname + window.location.search;
            window.location.replace('giris?return=' + encodeURIComponent(returnUrl));
        });


        function handleLogout() {
            console.log('ğŸšª Logging out...');
            
            // Stop auto-refresh
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('âœ… Auto-refresh stopped');
            }
            
            // Clear cache for this club
            if (currentClubId) {
                const cacheKey = `clubData_${currentClubId}`;
                localStorage.removeItem(cacheKey);
                console.log('âœ… Cache cleared');
            }
            
            // Clear ALL storage
            sessionStorage.clear();
            console.log('âœ… Storage cleared');
            
            currentUser = null;
            currentClubId = null;
            
            // Force redirect to login page
            console.log('âœ… Redirecting to login...');
            window.location.replace('giris');
        }

        async function startApp() {
            if (!window.firebase || !window.db) return showAlert('Firebase baÄŸlantÄ±sÄ± kurulamadÄ±.', 'danger');
            
            console.log('ğŸš€ Starting app...');
            const appStartTime = performance.now();
            
            // Display user name safely
            const displayName = currentUser?.fullName || currentUser?.email || 'YÃ¶netici';
            document.querySelector('.current-user-display').textContent = `HoÅŸgeldiniz, ${displayName}`;
            
            applyRolePermissions();
            
            // ğŸš€ HIZLI BAÅLANGIÃ‡ - Sadece minimum veri yÃ¼kle
            await loadData(true, true); // quickStart mode = true
            
            setupEventListeners();
            // Initial setup for the form
            toggleParentStudentFields(document.getElementById('preRegistrationForm'));
            
            const appEndTime = performance.now();
            const appLoadTime = (appEndTime - appStartTime).toFixed(2);
            console.log(`ğŸ‰ App ready in ${appLoadTime}ms`);
            
            // ğŸ”„ ARKA PLAN - DiÄŸer her ÅŸeyi yÃ¼kle
            setTimeout(async () => {
                console.log('ğŸ“¦ Arka plan yÃ¼klemeleri baÅŸlÄ±yor...');
                
                await Promise.all([
                    loadMessageTemplates(),
                    loadClubInfo()
                ]);
                
                // Bildirim izni iste ve otomatik kontrolÃ¼ baÅŸlat
                requestNotificationPermission();
                startMissedCallsAutoCheck();
                
                // Dashboard ve CRM istatistik gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ kontrol et
                checkDashboardAmountsVisibility();
                checkPaymentVisibility();
                
                // WhatsApp otomatik baÅŸlat (ilk yÃ¼kleme bildirimi iÃ§in)
                autoStartWhatsApp();
                
                console.log('âœ… Arka plan yÃ¼klemeleri tamamlandÄ±');
            }, 50);
        }
        
        // WhatsApp'Ä± otomatik baÅŸlat (connected cihaz varsa)
        async function autoStartWhatsApp() {
            // KÄ±sa bir gecikme ile cihazlarÄ±n yÃ¼klenmesini bekle
            setTimeout(async () => {
                if (whatsappDevices && whatsappDevices.length > 0) {
                    // Connected cihaz bul
                    const connectedDevice = whatsappDevices.find(d => d.status === 'connected');
                    
                    if (connectedDevice) {
                        console.log('ğŸ“± WhatsApp otomatik baÅŸlatÄ±lÄ±yor:', connectedDevice.instanceName);
                        
                        // CihazÄ± seÃ§
                        selectedWhatsAppDevice = connectedDevice;
                        
                        // âœ… Dropdown'Ä± gÃ¼ncelle (varsa) - biraz bekle ki render olsun
                        setTimeout(() => {
                            const deviceSelect = document.getElementById('whatsapp-active-device');
                            if (deviceSelect) {
                                deviceSelect.value = connectedDevice.instanceName;
                                console.log('âœ… WhatsApp cihazÄ± dropdown\'da seÃ§ildi:', connectedDevice.instanceName);
                                
                                // Cihaz seÃ§imini trigger et (messaging area'yÄ± aÃ§mak iÃ§in)
                                if (window.onDeviceSelectionChange) {
                                    window.onDeviceSelectionChange();
                                }
                            } else {
                                console.warn('âš ï¸ whatsapp-active-device bulunamadÄ± (WhatsApp sayfasÄ± aÃ§Ä±k deÄŸil)');
                            }
                        }, 1500); // 1.5 saniye bekle (WhatsApp sayfasÄ± render olsun)
                        
                        // ğŸ”¥ Firebase realtime listeners baÅŸlat (Ã¶ncelik - anlÄ±k bildirimler)
                        if (window.startWhatsAppRealtimeListeners) {
                            startWhatsAppRealtimeListeners();
                            console.log('ğŸ”¥ WhatsApp realtime listeners baÅŸlatÄ±ldÄ±');
                        }
                        
                        // KontaktlarÄ± yÃ¼kle (bu ilk yÃ¼kleme bildirimi tetikleyecek)
                        await loadWhatsAppContacts();
                        
                        // â±ï¸ Fallback polling baÅŸlat (10 saniyede bir)
                        if (window.startWhatsAppAutoRefresh) {
                            startWhatsAppAutoRefresh();
                            console.log('â±ï¸ WhatsApp fallback polling baÅŸlatÄ±ldÄ±');
                        }
                        
                        console.log('âœ… WhatsApp otomatik baÅŸlatÄ±ldÄ± ve bildirimler hazÄ±r');
                    } else {
                        console.log('â„¹ï¸ BaÄŸlÄ± WhatsApp cihazÄ± yok, bildirimler devre dÄ±ÅŸÄ±');
                    }
                } else {
                    console.log('â„¹ï¸ WhatsApp cihazÄ± bulunamadÄ±');
                }
            }, 500);
        }
        
        function setupEventListeners() {
            // âœ… AudioContext'i ilk kullanÄ±cÄ± tÄ±klamasÄ±nda baÅŸlat (tarayÄ±cÄ± izni iÃ§in)
            document.addEventListener('click', function initAudioContext() {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('ğŸ”Š AudioContext kullanÄ±cÄ± tÄ±klamasÄ± ile baÅŸlatÄ±ldÄ±');
                }
                // Bir kez baÅŸlatÄ±nca listener'Ä± kaldÄ±r
                document.removeEventListener('click', initAudioContext);
            }, { once: true });
            
            // âœ… Ã‡Ä±kÄ±ÅŸ butonu
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
                console.log('âœ… Logout button initialized');
            }
            
            // âœ… Sidebar logout button
            const logoutBtnSidebar = document.getElementById('logout-btn-sidebar');
            if (logoutBtnSidebar) {
                logoutBtnSidebar.addEventListener('click', handleLogout);
            }
            
            document.getElementById('preRegistrationForm').addEventListener('submit', (e) => handleRegistration(e, 'pending'));
            
            document.getElementById('paymentForm').addEventListener('submit', handlePayment);
            document.getElementById('newScheduleForm').addEventListener('submit', handleNewSchedule);
            document.getElementById('groupForm').addEventListener('submit', handleGroup);
            document.getElementById('memberEditForm').addEventListener('submit', handleMemberUpdate);
            document.getElementById('preRegEditForm').addEventListener('submit', handlePreRegUpdate);
            document.getElementById('attendanceForm').addEventListener('submit', handleAttendanceSubmit);
            document.getElementById('settingsForm').addEventListener('submit', handleSettingsUpdate);
            document.getElementById('userForm').addEventListener('submit', handleUserSubmit);
            document.getElementById('userEditForm').addEventListener('submit', handleUserUpdate);
            document.getElementById('taskForm').addEventListener('submit', handleTaskSubmit);
            document.getElementById('taskMessageForm').addEventListener('submit', sendTaskMessage);
            document.getElementById('profileForm').addEventListener('submit', handleProfileUpdate);
            // WhatsApp instance form moved to devices tab
            const whatsappInstanceForm = document.getElementById('whatsappInstanceForm-new');
            if (whatsappInstanceForm) {
                whatsappInstanceForm.addEventListener('submit', handleWhatsAppInstanceCreate);
            }
            
            document.getElementById('memberTypePre').addEventListener('change', () => toggleParentStudentFields(document.getElementById('preRegistrationForm')));
            
            document.getElementById('memberSearch').addEventListener('input', () => {
                membersCurrentPage = 1;
                renderMembersTable();
            });
            document.getElementById('paymentSearch').addEventListener('input', () => renderPaymentsList());
            document.getElementById('groupSearch').addEventListener('input', () => renderGroupsList());

            document.querySelector('#userForm [name="phone"]').addEventListener('input', (e) => {
                const phone = e.target.value.replace(/\D/g, '');
                e.target.value = phone;
                document.querySelector('#userForm [name="username"]').value = phone;
            });
            
            document.querySelector('#userEditForm [name="phone"]').addEventListener('input', (e) => {
                const phone = e.target.value.replace(/\D/g, '');
                e.target.value = phone;
            });
            
            document.querySelector('#profileForm [name="phone"]').addEventListener('input', (e) => {
                const phone = e.target.value.replace(/\D/g, '');
                e.target.value = phone;
            });
            
            // --- Searchable Group Dropdown Logic ---
            const preRegBranchSelect = document.getElementById('preRegBranchPre');
            const groupSearchInput = document.getElementById('preRegGroupSearch');
            const groupHiddenInput = document.getElementById('preRegGroupId');
            const groupResultsContainer = document.getElementById('preRegGroupResults');
            let availableGroupsForSearch = [];

            preRegBranchSelect.addEventListener('change', (e) => {
                const branch = e.target.value;
                groupSearchInput.value = '';
                groupHiddenInput.value = '';
                groupResultsContainer.innerHTML = '';
                if(branch) {
                    const actualGroups = groups.filter(g => {
                         const memberCount = members.filter(m => Array.isArray(g.members) && g.members.includes(m.id) && m.status !== 'expired').length;
                         return g.branch === branch && memberCount < g.maxMembers;
                    });
                    availableGroupsForSearch = actualGroups;
                    groupSearchInput.disabled = false;
                    groupSearchInput.placeholder = "Grup ara...";
                } else {
                    availableGroupsForSearch = [];
                    groupSearchInput.disabled = true;
                    groupSearchInput.placeholder = "Ã–nce branÅŸ seÃ§in";
                }
            });

            groupSearchInput.addEventListener('input', () => {
                const searchTerm = groupSearchInput.value.toLowerCase();
                groupHiddenInput.value = ''; // Clear hidden ID if user types again
                const filtered = availableGroupsForSearch.filter(g => g.groupName.toLowerCase().includes(searchTerm));
                
                groupResultsContainer.innerHTML = filtered.length > 0 ? filtered.map(g => {
                    const memberCount = members.filter(m => Array.isArray(g.members) && g.members.includes(m.id) && m.status !== 'expired').length;
                    return `<div class="searchable-select-item" data-id="${g.id}" data-name="${g.groupName}">${g.groupName} - (${memberCount}/${g.maxMembers})</div>`
                }).join('') : '<div class="searchable-select-item disabled">SonuÃ§ bulunamadÄ±</div>';
                groupResultsContainer.classList.add('active');
            });

            groupResultsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('searchable-select-item') && e.target.dataset.id) {
                    groupHiddenInput.value = e.target.dataset.id;
                    groupSearchInput.value = e.target.dataset.name;
                    groupResultsContainer.classList.remove('active');
                }
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.searchable-select-container')) {
                    groupResultsContainer.classList.remove('active');
                }
            });

            // Generic setup for form inputs
            const form = document.getElementById('preRegistrationForm');
            form.querySelector('[name="phone"]').addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '');
            });
            form.querySelector('[name="phone2"]').addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '');
            });
            const previewInputs = ['firstPeriodStart', 'firstPeriodEnd', 'firstInstallmentAmount', 'firstDueDate', 'installments', 'subsequentInstallmentAmount', 'dueDay', 'firstLessonCount'];
            previewInputs.forEach(id => {
                const element = form.querySelector(`[name=${id}]`);
                if(element) element.addEventListener('input', () => previewPaymentPlan(form));
            });
            const dateInputs = ['firstPeriodStart', 'firstPeriodEnd'];
            dateInputs.forEach(id => {
                form.querySelector(`[name=${id}]`).addEventListener('change', () => autoCalculateLessonCount(form));
            });
            const today = getTodayString();
            form.querySelector('[name="firstPeriodStart"]').value = today;
            form.querySelector('[name="firstDueDate"]').value = today;

            // Set max date for birth date fields (today)
            const studentBirthDatePre = document.getElementById('studentBirthDatePre');
            if (studentBirthDatePre) studentBirthDatePre.setAttribute('max', today);
            
            const studentBirthdates = document.querySelectorAll('.student-birthdate');
            studentBirthdates.forEach(field => field.setAttribute('max', today));

            // Currency formatting listeners
            document.querySelector('#preRegistrationForm [name="firstInstallmentAmount"]').addEventListener('input', (e) => formatCurrency(e.target));
            document.querySelector('#preRegistrationForm [name="subsequentInstallmentAmount"]').addEventListener('input', (e) => formatCurrency(e.target));
            document.querySelector('#paymentForm [name="paymentAmount"]').addEventListener('input', (e) => formatCurrency(e.target));


            // Close modal on outside click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });
            
            // Close actions menu on outside click
            document.addEventListener('click', (e) => closeAllMenus(e));
            
            // WhatsApp forms
            const whatsappNewForm = document.getElementById('whatsappInstanceForm-new');
            if (whatsappNewForm) {
                whatsappNewForm.addEventListener('submit', handleWhatsAppInstanceCreate);
            }
            
            const whatsappSendForm = document.getElementById('whatsappSendMessageForm');
            if (whatsappSendForm) {
                whatsappSendForm.addEventListener('submit', handleWhatsAppSendMessage);
            }
            
            const bulkMessageForm = document.getElementById('bulkMessageForm');
            if (bulkMessageForm) {
                bulkMessageForm.addEventListener('submit', handleBulkMessageSend);
            }
            
            const contactSearch = document.getElementById('contact-search');
            if (contactSearch) {
                contactSearch.addEventListener('input', (e) => {
                    renderWhatsAppContactsList(e.target.value);
                });
            }
            
            const bulkBranchSelector = document.getElementById('bulk-branch-selector');
            if (bulkBranchSelector) {
                bulkBranchSelector.addEventListener('change', onBulkBranchChange);
            }
        }

        // âœ… Pasif Ã¼yeleri gruplardan otomatik temizle
        async function cleanupExpiredMembersFromGroups() {
            try {
                const expiredMemberIds = members.filter(m => m.status === 'expired').map(m => m.id);
                if (expiredMemberIds.length === 0) return;
                
                let updatedGroupsCount = 0;
                
                for (const group of groups) {
                    if (!group.members || group.members.length === 0) continue;
                
                    const originalMemberCount = group.members.length;
                    const cleanedMembers = group.members.filter(memberId => !expiredMemberIds.includes(memberId));
                    
                    if (cleanedMembers.length < originalMemberCount) {
                        await window.firebase.updateDoc(
                            window.firebase.doc(window.db, 'groups', group.id),
                            { members: cleanedMembers }
                        );
                        updatedGroupsCount++;
                        group.members = cleanedMembers; // Update local cache
                        console.log(`ğŸ§¹ Grup "${group.groupName}"dan ${originalMemberCount - cleanedMembers.length} pasif Ã¼ye temizlendi`);
                    }
                }
                
                if (updatedGroupsCount > 0) {
                    console.log(`âœ… Toplamda ${updatedGroupsCount} gruptan pasif Ã¼yeler temizlendi`);
                }
            } catch (error) {
                console.error('âŒ Pasif Ã¼yeleri temizlerken hata:', error);
            }
        }

        // Sessiz yenileme - deÄŸiÅŸiklik varsa yenile
        async function checkAndRefreshIfNeeded() {
            try {
                const currentClubId = window.currentClubId;
                if (!currentClubId) return;
                
                // Mevcut veri sayÄ±larÄ±nÄ± sakla
                const oldCounts = {
                    members: members.length,
                    preRegistrations: preRegistrations.length,
                    crmLeads: crmLeads.length
                };
                
                // Firestore'dan gÃ¼ncel sayÄ±larÄ± al (sessizce)
                const [membersSnapshot, preRegsSnapshot, crmLeadsSnapshot] = await Promise.all([
                    getDocs(query(collection(window.db, 'members'), where('clubId', '==', currentClubId))),
                    getDocs(query(collection(window.db, 'preRegistrations'), where('clubId', '==', currentClubId))),
                    getDocs(query(collection(window.db, 'crmLeads'), where('clubId', '==', currentClubId)))
                ]);
                
                const newCounts = {
                    members: membersSnapshot.size,
                    preRegistrations: preRegsSnapshot.size,
                    crmLeads: crmLeadsSnapshot.size
                };
                
                // DeÄŸiÅŸiklik var mÄ± kontrol et
                const hasChanges = 
                    oldCounts.members !== newCounts.members ||
                    oldCounts.preRegistrations !== newCounts.preRegistrations ||
                    oldCounts.crmLeads !== newCounts.crmLeads;
                
                if (hasChanges) {
                    console.log('ğŸ”„ Veri deÄŸiÅŸikliÄŸi tespit edildi, yenileniyor...');
                    await loadData(false); // Cache kullanmadan yenile
                    
                    // Mesaj kuyruÄŸunu iÅŸle
                    await processMessageQueue();
                    
                    // Mevcut section'Ä± yenile
                    renderCurrentSection();
                } else {
                    console.log('âœ“ Veri deÄŸiÅŸikliÄŸi yok');
                }
            } catch (error) {
                console.error('Sessiz yenileme hatasÄ±:', error);
            }
        }

        async function loadData(useCache = true, quickStart = false) {
            if (isLoading && !quickStart) return;
            if (!quickStart) isLoading = true;
            
            if (!currentClubId) {
                console.error('âŒ No club ID found!');
                alert('KulÃ¼p bilgisi bulunamadÄ±! LÃ¼tfen tekrar giriÅŸ yapÄ±n.');
                handleLogout();
                return;
            }
            
            const startTime = performance.now();
            
            // âœ… CACHE CHECK - AnÄ±nda yÃ¼kleme!
            if (useCache && !quickStart) {
                const cacheKey = `clubData_${currentClubId}`;
                const cachedData = localStorage.getItem(cacheKey);
                if (cachedData) {
                    try {
                        const data = JSON.parse(cachedData);
                        const cacheAge = Date.now() - (data.timestamp || 0);
                        
                        // Cache 5 dakikadan yeniyse kullan
                        if (cacheAge < 300000) { // 5 minutes
                            console.log('âš¡ Loading from cache...');
                            applyDataFromCache(data);
                            
                            const cacheTime = performance.now() - startTime;
                            console.log(`ğŸ’¨ Data loaded from cache in ${cacheTime.toFixed(2)}ms`);
                            
                            isLoading = false;
                            
                            // Arka planda fresh data yÃ¼kle
                            setTimeout(() => loadData(false), 1000);
                            return;
                        }
                    } catch (e) {
                        console.warn('âš ï¸ Cache parse error:', e);
                    }
                }
            }
            
            // ğŸš€ QUICK START MODE - Sadece temel bilgileri yÃ¼kle (hÄ±zlÄ± dashboard)
            if (quickStart) {
                console.log('ğŸš€ Quick start mode: Dashboard iÃ§in minimum veri yÃ¼kleniyor...');
                try {
                    const { getDoc, doc } = window.firebase;
                    
                    // Sadece temel ayarlar ve kulÃ¼p bilgisi
                    const [clubSettingsDoc, clubDoc, branchesData] = await Promise.all([
                        getDoc(doc(window.db, 'settings', `club_${currentClubId}`)),
                        getDoc(doc(window.db, 'clubs', currentClubId)),
                        supabase.from('branches').select('*').eq('clubId', currentClubId).eq('isActive', true).order('branchName', { ascending: true })
                    ]);
                    
                    // Temel ayarlar
                    if (clubSettingsDoc.exists()) {
                        clubSettings = clubSettingsDoc.data();
                    }
                    
                    // CRM durumu
                    if (clubDoc && clubDoc.exists && clubDoc.exists()) {
                        const clubData = clubDoc.data();
                        clubSettings.crmEnabled = clubData.crmEnabled !== false;
                    }
                    
                    // KulÃ¼p baÅŸlÄ±ÄŸÄ±nÄ± ayarla
                    const clubName = clubSettings.clubName || currentUser.clubName || 'Sporcum';
                    document.getElementById('club-title').textContent = clubName;
                    const clubTitleHeader = document.getElementById('club-title-header');
                    if (clubTitleHeader) clubTitleHeader.textContent = `${clubName} - YÃ¶netim Paneli`;
                    document.title = `${clubName} - YÃ¶netim Paneli`;
                    
                    // BranÅŸlarÄ± yÃ¼kle
                    if (branchesData && branchesData.data && branchesData.data.length > 0) {
                        branches = branchesData.data.map(b => ({
                            id: b.branchId || b.id,
                            name: b.branchName,
                            icon: b.icon || 'âš½',
                            color: b.color || '#4A90E2',
                            lessonName: b.lessonName || b.branchName,
                            courts: b.courts || []
                        }));
                    } else {
                        branches = [];
                    }
                    
                    // BoÅŸ arrayler ile baÅŸla (dashboard istatistikler 0 gÃ¶sterecek)
                    members = [];
                    preRegistrations = [];
                    groups = [];
                    crmLeads = [];
                    
                    const quickTime = performance.now() - startTime;
                    console.log(`âš¡ Quick start tamamlandÄ±: ${quickTime.toFixed(2)}ms`);
                    console.log('ğŸ“Š Arka planda tÃ¼m veri yÃ¼kleniyor...');
                    
                    // âœ… Dashboard'a yÃ¼kleniyor gÃ¶ster (sayÄ±lar gÃ¶rÃ¼nmesin)
                    const dashboardSection = document.getElementById('dashboard');
                    if (dashboardSection) {
                        dashboardSection.style.opacity = '0.5';
                        dashboardSection.style.pointerEvents = 'none';
                    }
                    
                    // HEMEN arka planda tam veriyi yÃ¼kle
                    setTimeout(() => loadData(false, false), 100);
                    
                    return;
                } catch (error) {
                    console.error('âŒ Quick start hatasÄ±:', error);
                    // Hata olursa normal yÃ¼klemeye geÃ§
                }
            }
            
            try {
                console.log('ğŸ“Š Loading fresh data for club:', currentClubId);
                const { getDocs, query, collection, orderBy, doc, getDoc, where, limit: queryLimit } = window.firebase;
                
                // âš¡ KRÄ°TÄ°K VERÄ°LER - Ã–nce bunlar yÃ¼klensin (hÄ±zlÄ±)
                const queryStartTime = performance.now();
                const criticalQueries = [
                    getDocs(query(collection(window.db, 'preRegistrations'), where('clubId', '==', currentClubId))),
                    getDocs(query(collection(window.db, 'members'), where('clubId', '==', currentClubId))),
                    getDocs(query(collection(window.db, 'groups'), where('clubId', '==', currentClubId))),
                    getDoc(doc(window.db, 'settings', `club_${currentClubId}`)),
                    getDoc(doc(window.db, 'clubs', currentClubId)),
                    supabase.from('branches').select('*').eq('clubId', currentClubId).eq('isActive', true)
                ];
                
                const criticalResults = await Promise.all(criticalQueries);
                const criticalTime = performance.now() - queryStartTime;
                console.log(`âš¡ Kritik veriler yÃ¼klendi: ${criticalTime.toFixed(0)}ms`);
                
                // ğŸ“Š SECONDARY VERÄ°LER - Arka planda yÃ¼klensin (daha az kritik)
                const secondaryStartTime = performance.now();
                const secondaryQueries = [
                    getDocs(query(collection(window.db, 'schedules'), where('clubId', '==', currentClubId))),
                    getDoc(doc(window.db, 'settings', `holidays_${currentClubId}`)),
                    getDocs(query(collection(window.db, 'users'), where('clubId', '==', currentClubId))),
                    // âš¡ LIMIT: Son 100 yoklama kaydÄ± - TARÄ°HE GÃ–RE SIRALI!
                    getDocs(query(collection(window.db, 'attendanceRecords'), where('clubId', '==', currentClubId), orderBy('date', 'desc'), limit(100))),
                    getDocs(query(collection(window.db, 'tasks'), where('clubId', '==', currentClubId))),
                    getDocs(query(collection(window.db, 'whatsappDevices'), where('clubId', '==', currentClubId))),
                    getDoc(doc(window.db, 'settings', `whatsapp_${currentClubId}`)),
                    // âš¡ LIMIT: Son 50 mesaj yeterli (zaten slice(50) yapÄ±yoruz)
                    getDocs(query(collection(window.db, 'sentMessages'), where('clubId', '==', currentClubId), limit(50))),
                    // âš¡ LIMIT: Son 100 aktivite yeterli
                    getDocs(query(collection(window.db, 'userActivities'), where('clubId', '==', currentClubId), limit(100))),
                    // âš¡ LIMIT: Son 200 gelen mesaj
                    getDocs(query(collection(window.db, 'whatsappIncomingMessages'), where('clubId', '==', currentClubId), limit(200))),
                    getDocs(query(collection(window.db, 'crmLeads'), where('clubId', '==', currentClubId)))
                ];
                
                const secondaryResults = await Promise.all(secondaryQueries);
                const secondaryTime = performance.now() - secondaryStartTime;
                console.log(`ğŸ“Š Ä°kincil veriler yÃ¼klendi: ${secondaryTime.toFixed(0)}ms`);
                
                // SonuÃ§larÄ± birleÅŸtir
                const results = [...criticalResults, ...secondaryResults];

                // === KRÄ°TÄ°K VERÄ°LER (0-5) ===
                preRegistrations = results[0].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                preRegistrations.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
                
                members = results[1].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                members.sort((a, b) => new Date(b.registrationDate || b.createdAt || 0) - new Date(a.registrationDate || a.createdAt || 0));
                
                groups = results[2].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // KulÃ¼p ayarlarÄ±
                const clubSettingsDoc = results[3];
                if (clubSettingsDoc.exists()) {
                    clubSettings = clubSettingsDoc.data();
                } else {
                    clubSettings = { clubName: currentUser.clubName || 'Sporcum', clubId: currentClubId };
                    await window.firebase.setDoc(window.firebase.doc(window.db, 'settings', `club_${currentClubId}`), clubSettings);
                }
                
                // KulÃ¼p bilgisi (CRM durumu)
                const clubDoc = results[4];
                if (clubDoc && clubDoc.exists && clubDoc.exists()) {
                    const clubData = clubDoc.data();
                    clubSettings.crmEnabled = clubData.crmEnabled !== false;
                    if (clubData.expenseCategories) clubSettings.expenseCategories = clubData.expenseCategories;
                    if (clubData.productCategories) clubSettings.productCategories = clubData.productCategories;
                } else {
                    clubSettings.crmEnabled = true;
                }
                
                // BranÅŸlar (Supabase)
                const branchesData = results[5];
                if (branchesData && branchesData.data && branchesData.data.length > 0) {
                    branches = branchesData.data.map(b => ({
                        id: b.branchId || b.id,
                        name: b.branchName,
                        icon: b.icon || 'âš½',
                        color: b.color || '#4A90E2',
                        lessonName: b.lessonName || b.branchName,
                        courts: b.courts || []
                    }));
                } else {
                    branches = [];
                }
                
                // KulÃ¼p baÅŸlÄ±ÄŸÄ±
                const clubName = clubSettings.clubName || currentUser.clubName || 'Sporcum';
                document.getElementById('club-title').textContent = clubName;
                const clubTitleHeader = document.getElementById('club-title-header');
                if (clubTitleHeader) clubTitleHeader.textContent = `${clubName} - YÃ¶netim Paneli`;
                document.title = `${clubName} - YÃ¶netim Paneli`;
                
                // === SECONDARY VERÄ°LER (6-16) ===
                schedules = results[6].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Holidays
                const holidaysDoc = results[7];
                if (holidaysDoc.exists()) {
                    holidays = holidaysDoc.data().off_days || [];
                } else {
                    holidays = [];
                    await window.firebase.setDoc(
                        window.firebase.doc(window.db, 'settings', `holidays_${currentClubId}`),
                        { off_days: [], clubId: currentClubId }
                    );
                }
                
                users = results[8].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                attendanceRecords = results[9].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('Attendance Records loaded:', {
                    total: attendanceRecords.length,
                    sample: attendanceRecords.slice(0, 3),
                    absentCount: attendanceRecords.filter(r => r.status === 'absent').length
                });
                
                tasks = results[10].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Manuel sÄ±ralama (Firebase index gerektirmemek iÃ§in)
                tasks.sort((a, b) => {
                    const dateA = new Date(a.createdAt || 0);
                    const dateB = new Date(b.createdAt || 0);
                    return dateB - dateA; // Yeniden eskiye
                });
                
                whatsappDevices = results[11].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // WhatsApp config
                const whatsappConfigDoc = results[12];
                if (whatsappConfigDoc.exists()) {
                    defaultWhatsAppDevice = whatsappConfigDoc.data().defaultDevice || null;
                } else {
                    defaultWhatsAppDevice = null;
                    await window.firebase.setDoc(
                        window.firebase.doc(window.db, 'settings', `whatsapp_${currentClubId}`),
                        { defaultDevice: null, clubId: currentClubId }
                    );
                }
                
                sentMessages = results[13].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                sentMessages.sort((a, b) => new Date(b.sentAt || 0) - new Date(a.sentAt || 0));
                
                userActivities = results[14].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                userActivities.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));
                
                incomingMessages = results[15].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                incomingMessages.sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));
                
                crmLeads = results[16].docs.map(doc => ({ id: doc.id, ...doc.data() }));
                crmLeads.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
                
                // âœ… CRM Etiketlerini yÃ¼kle (sayfa aÃ§Ä±lÄ±ÅŸÄ±nda)
                await loadCRMTags();
                
                console.log('âœ… Loaded data summary:');
                console.log('  - Members:', members.length);
                console.log('  - Groups:', groups.length);
                console.log('  - Branches:', branches.length);
                console.log('  - Pre-registrations:', preRegistrations.length);
                console.log('  - CRM Leads:', crmLeads.length);
                
                // âœ… Pasif Ã¼yeleri gruplardan otomatik temizle
                await cleanupExpiredMembersFromGroups();
                
                // âœ… CRITICAL: BranÅŸ dropdown'larÄ±nÄ± hemen gÃ¼ncelle
                updateBranchDropdowns();
                
                // âœ… CRITICAL: CRM menÃ¼ gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ gÃ¼ncelle
                updateCRMMenuVisibility();
                
                // âœ… CRITICAL: Mevcut sekmeyi render et
                renderCurrentSection();
                
                // âœ… Dashboard aktifse devamsÄ±zlÄ±klarÄ± gÃ¼ncelle (quick start sonrasÄ±)
                if (currentSection === 'dashboard' && attendanceRecords.length > 0) {
                    setTimeout(() => {
                        if (typeof renderRecentAbsences === 'function') {
                            renderRecentAbsences();
                        }
                    }, 100);
                }
                
                // âœ… CACHE: Fresh data'yÄ± cache'e kaydet
                if (!useCache) {
                    saveDataToCache();
                }
                
                // âœ… NON-CRITICAL: Sessiz otomatik yenileme - deÄŸiÅŸiklik varsa yenile
                if (!autoRefreshInterval) {
                    setTimeout(() => {
                        autoRefreshInterval = setInterval(async () => {
                            await checkAndRefreshIfNeeded();
                        }, 60000); // 60 seconds
                        console.log('âœ… Sessiz otomatik yenileme baÅŸlatÄ±ldÄ± (her 60 saniyede)');
                    }, 5000); // 5 saniye sonra baÅŸlat
                }
                
                // âœ… Mesaj kuyruÄŸunu ilk kez yÃ¼kle
                setTimeout(() => {
                    renderMessageQueue();
                    processMessageQueue(); // Ä°lk kontrol
                }, 3000);
                
                // âœ… NON-CRITICAL: DoÄŸum gÃ¼nÃ¼ kontrolÃ¼nÃ¼ lazy load
                setTimeout(() => {
                    checkAndSendBirthdayMessages();
                    
                    // Her gÃ¼n saat 9'da kontrol et
                    setInterval(() => {
                        const now = new Date();
                        if (now.getHours() === 9 && now.getMinutes() === 0) {
                            console.log('ğŸ‚ Running daily birthday check...');
                            checkAndSendBirthdayMessages();
                        }
                    }, 60000); // Check every minute
                }, 10000); // 10 saniye sonra baÅŸlat
                
            } catch (error) {
                console.error('Veri yÃ¼klenirken hata:', error);
                showAlert('Veri yÃ¼klenirken hata oluÅŸtu', 'danger');
            } finally { 
                isLoading = false;
                const endTime = performance.now();
                const loadTime = (endTime - startTime).toFixed(2);
                console.log(`âš¡ Data loaded in ${loadTime}ms`);
                
                // YavaÅŸ yÃ¼kleme uyarÄ±sÄ±
                if (loadTime > 3000) {
                    console.warn(`âš ï¸ Slow loading detected: ${loadTime}ms (should be < 3000ms)`);
                }
                
                // âœ… Dashboard'u aktif hale getir (quick start sonrasÄ±)
                const dashboardSection = document.getElementById('dashboard');
                if (dashboardSection) {
                    dashboardSection.style.opacity = '1';
                    dashboardSection.style.pointerEvents = 'auto';
                }
                
                // Silinen Ã§aÄŸrÄ±larÄ± localStorage'dan yÃ¼kle
                loadDeletedCalls();
            }
        }
        
        // âœ… TÃ¼m branÅŸ dropdown'larÄ±nÄ± gÃ¼ncelle
        function updateBranchDropdowns() {
            const branchOptions = '<option value="">SeÃ§iniz...</option>' + 
                branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
            
            // 1. KayÄ±t formundaki branÅŸ dropdown
            const preRegBranchSelect = document.getElementById('preRegBranchPre');
            if (preRegBranchSelect) {
                const currentValue = preRegBranchSelect.value;
                preRegBranchSelect.innerHTML = branchOptions;
                if (currentValue) preRegBranchSelect.value = currentValue;
            }
            
            // 2. Toplu mesaj branÅŸ seÃ§imi (kulÃ¼p bazÄ±nda)
            const bulkBranchSelector = document.getElementById('bulk-branch-selector');
            if (bulkBranchSelector) {
                const currentValue = bulkBranchSelector.value;
                // Sadece bu kulÃ¼bÃ¼n branÅŸlarÄ±nÄ± gÃ¶ster
                const clubBranches = branches.filter(b => !b.clubId || b.clubId === currentClubId);
                bulkBranchSelector.innerHTML = '<option value="">BranÅŸ seÃ§in...</option>' + 
                    clubBranches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('') + 
                    '<option value="all">âœ¨ TÃ¼m BranÅŸlar</option>';
                if (currentValue) bulkBranchSelector.value = currentValue;
                console.log('âœ… Toplu mesaj branÅŸ dropdown gÃ¼ncellendi:', clubBranches.length, 'branÅŸ');
            }
            
            // 3. Aktivite filtresi
            const activityBranchFilter = document.getElementById('activityBranchFilter');
            if (activityBranchFilter) {
                const currentValue = activityBranchFilter.value;
                activityBranchFilter.innerHTML = '<option value="all">TÃ¼m BranÅŸlar</option>' + 
                    branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
                if (currentValue) activityBranchFilter.value = currentValue;
            }
            
            // 4. Grup formu branÅŸ seÃ§imleri (birden fazla olabilir)
            document.querySelectorAll('select[name="branch"]').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = branchOptions;
                if (currentValue) select.value = currentValue;
            });
            
            console.log('âœ… TÃ¼m dropdown\'lar gÃ¼ncellendi:', branches.length, 'branÅŸ');
        }
        
        function renderCurrentSection() {
            // âœ… Otomatik yenileyicileri durdur
            stopMembersAutoRefresh();
            
            // âœ… CRM EriÅŸim KontrolÃ¼ - Ã–nce sections objesini kontrol et
            console.log('ğŸ” renderCurrentSection:', currentSection, 'CRM Enabled:', clubSettings.crmEnabled);
            
            // CRM aktif deÄŸilse ve CRM section'larÄ±ndan birine eriÅŸmeye Ã§alÄ±ÅŸÄ±yorsa
            if ((currentSection === 'crm' || currentSection.startsWith('crm-')) && clubSettings.crmEnabled !== true) {
                console.log('âš ï¸ CRM aktif deÄŸil, bilgilendirme mesajÄ± gÃ¶steriliyor');
                
                // TÃ¼m section'larÄ± gizle
                document.querySelectorAll('.section').forEach(sec => sec.style.display = 'none');
                
                // CRM section'Ä±nÄ± gÃ¶ster ve mesajÄ± yaz
                let crmSection = document.getElementById('crm');
                if (crmSection) {
                    crmSection.style.display = 'block';
                    crmSection.innerHTML = `
                        <div style="display: flex; justify-content: center; align-items: center; min-height: 400px;">
                            <div style="text-align: center; max-width: 500px; padding: 40px; background: #fff3cd; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                <div style="font-size: 64px; margin-bottom: 20px;">ğŸ”’</div>
                                <h2 style="color: #856404; margin-bottom: 15px;">CRM ModÃ¼lÃ¼ Aktif DeÄŸil</h2>
                                <p style="font-size: 16px; color: #856404; margin-bottom: 20px;">
                                    CRM modÃ¼lÃ¼nÃ¼ kullanmak iÃ§in lÃ¼tfen iletiÅŸime geÃ§iniz.
                                </p>
                                <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
                                    <a href="tel:03623630063" style="font-size: 24px; color: #007bff; text-decoration: none; font-weight: bold;">
                                        ğŸ“ 0362 363 00 63
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                }
                return;
            }
            
            const sections = {
                dashboard: () => {
                    updateDashboard();
                    renderCRMDashboard(); // CRM Dashboard widget'larÄ± (Son DevamsÄ±zlÄ±klar dahil)
                }, 
                'registration-procedures': () => {
                    renderPreRegistrationTable();
                    renderInactiveMembersTable();
                },
                members: renderMembersTable, 
                payments: renderPaymentsList,
                schedule: renderScheduleGrid, 
                groups: renderGroupsList,
                tasks: renderTasksPage,
                whatsapp: renderWhatsAppPage,
                crm: () => {
                    renderCRMDashboard();
                    renderCRMLeads();
                    loadCRMTags();
                },
                'crm-filter': () => {
                    // BranÅŸ filtresini doldur
                    const branchFilter = document.getElementById('filter-branch');
                    if (branchFilter) {
                        branchFilter.innerHTML = '<option value="all">TÃ¼m BranÅŸlar</option>' +
                            branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
                    }
                    loadCRMTags();
                    // âŒ Ä°lk aÃ§Ä±lÄ±ÅŸta mÃ¼ÅŸterileri gÃ¶sterme (filtre seÃ§ilmediÄŸi sÃ¼rece)
                    // applyCustomerFilters();
                },
                'crm-trials': () => {
                    // BranÅŸ filtresini doldur
                    const branchFilter = document.getElementById('trial-branch-filter');
                    if (branchFilter) {
                        branchFilter.innerHTML = '<option value="all">TÃ¼m BranÅŸlar</option>' +
                            branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
                    }
                    renderTrials();
                },
                'crm-tags': () => {
                    loadCRMTags();
                },
                'crm-templates': renderCRMTemplatesPage,
                'crm-incoming-calls': () => {
                    renderIncomingCallsPage();
                    // Gelen aramalar otomatik yenileme baÅŸlat
                    if (window.startIncomingCallsAutoRefresh) {
                        startIncomingCallsAutoRefresh();
                    }
                },
                'crm-outgoing-calls': renderOutgoingCallsPage,
                'accounting-summary': renderAccountingSummary,
                'expenses': renderExpensesPage,
                'products': renderProductsPage,
                settings: renderSettings,
                'attendance-tracking': renderAllAbsences,
                'user-activities': renderUserActivitiesPage,
                'inactive-members': loadInactiveMembers,
                'campaigns': renderCampaignsPage,
                'whatsapp-balance': renderWhatsAppBalancePage,
                'members': () => {
                    renderMembersTable();
                    startMembersAutoRefresh();
                }
            };
            if (sections[currentSection]) {
                if (typeof sections[currentSection] === 'function') {
                    sections[currentSection]();
                }
            }
        }
        
        function renderAllAbsences() {
            const container = document.getElementById('attendance-content');
            const titleEl = document.getElementById('header-title-attendance');
            
            if (!container) return;
            
            titleEl.textContent = 'ğŸ“‹ TÃ¼m DevamsÄ±zlÄ±klar';
            
            const allAbsences = attendanceRecords.filter(rec => rec.status === 'absent').sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allAbsences.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>DevamsÄ±zlÄ±k kaydÄ± bulunmuyor.</h3></div>';
                return;
            }
            
            container.innerHTML = `
                <div class="card">
                    <h3 class="card-title">Toplam ${allAbsences.length} DevamsÄ±zlÄ±k KaydÄ±</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ã–ÄŸrenci</th>
                                    <th>Telefon</th>
                                    <th>Tarih</th>
                                    <th>Sebep</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allAbsences.map(absence => {
                                    const member = members.find(m => m.id === absence.memberId);
                                    if (!member) return '';
                                    const memberName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad;
                                    return `
                                        <tr style="cursor: pointer;" onclick="showMemberAttendancePage('${member.id}')">
                                            <td><strong>${memberName}</strong></td>
                                            <td>${member.Telefon}</td>
                                            <td>${formatDate(absence.date)}</td>
                                            <td>${absence.reason || '<i>Sebep belirtilmedi</i>'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // User Activities Page
        function renderUserActivitiesPage() {
            const searchInput = document.getElementById('activitySearch');
            const branchFilter = document.getElementById('activityBranchFilter');
            
            // Setup event listeners
            if (searchInput) {
                searchInput.removeEventListener('input', filterActivities);
                searchInput.addEventListener('input', filterActivities);
            }
            if (branchFilter) {
                branchFilter.removeEventListener('change', filterActivities);
                branchFilter.addEventListener('change', filterActivities);
            }
            
            filterActivities();
        }
        
        function filterActivities() {
            const searchText = document.getElementById('activitySearch')?.value.toLowerCase() || '';
            const selectedBranch = document.getElementById('activityBranchFilter')?.value || 'all';
            
            let filtered = userActivities;
            
            // Filter by search text
            if (searchText) {
                const searchNoSpaces = searchText.replace(/\s/g, '');
                filtered = filtered.filter(activity => 
                    activity.memberName?.toLowerCase().includes(searchText) ||
                    activity.phone?.toLowerCase().includes(searchText) ||
                    activity.phone?.replace(/\s/g, '').includes(searchNoSpaces)
                );
            }
            
            // Filter by branch
            if (selectedBranch !== 'all') {
                filtered = filtered.filter(activity => activity.branch === selectedBranch);
            }
            
            displayActivitiesTable(filtered);
        }
        
        function displayActivitiesTable(activities) {
            const container = document.getElementById('activitiesTableContainer');
            
            if (!activities || activities.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>KullanÄ±cÄ± hareketi bulunmuyor.</h3></div>';
                return;
            }
            
            const tableHtml = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Tarih/Saat</th>
                                <th>Ä°sim</th>
                                <th>Telefon</th>
                                <th>BranÅŸ</th>
                                <th>Tip</th>
                                <th>Hareket</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${activities.map(activity => {
                                const date = new Date(activity.timestamp);
                                const formattedDate = date.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                                const formattedTime = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                                const branchIcon = activity.branch === 'tenis' ? 'ğŸ¾' : activity.branch === 'yuzme' ? 'ğŸŠ' : '';
                                const activityType = activity.type === 'staff' ? 'ğŸ‘¨â€ğŸ’¼ Personel' : 'ğŸ‘¤ Ãœye';
                                const displayName = activity.memberName || activity.staffName || 'Bilinmiyor';
                                
                                return `
                                    <tr>
                                        <td>${formattedDate} ${formattedTime}</td>
                                        <td><strong>${displayName}</strong></td>
                                        <td><a href="#" class="phone-link" onclick="handlePhoneClick(event, '${activity.phone}')">${activity.phone || '-'}</a></td>
                                        <td>${branchIcon} ${capitalize(activity.branch || '-')}</td>
                                        <td><span class="status-badge ${activity.type === 'staff' ? 'status-pending' : 'status-active'}">${activityType}</span></td>
                                        <td><span class="status-badge status-active">${activity.activity}</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        }
        
        async function refreshUserActivities() {
            try {
                const { getDocs, query, collection, orderBy } = window.firebase;
                const activitiesSnapshot = await getDocs(query(collection(window.db, 'userActivities'), orderBy('timestamp', 'desc')));
                userActivities = activitiesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filterActivities();
                showAlert('KullanÄ±cÄ± hareketleri gÃ¼ncellendi.', 'success');
            } catch (error) {
                console.error('Error refreshing activities:', error);
                showAlert('Hareketler yÃ¼klenirken hata oluÅŸtu.', 'danger');
            }
        }
        
        window.refreshUserActivities = refreshUserActivities;

        // âœ… Sidebar Toggle Function
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            
            if (sidebar) {
                sidebar.classList.toggle('collapsed');
                const isCollapsed = sidebar.classList.contains('collapsed');
                
                // Sidebar kapanÄ±rken tÃ¼m dropdown'larÄ± kapat
                if (isCollapsed) {
                    document.querySelectorAll('.dropdown-content.show').forEach(content => {
                        content.classList.remove('show');
                    });
                    document.querySelectorAll('.dropdown-toggle.open').forEach(toggle => {
                        toggle.classList.remove('open');
                    });
                }
                
                // LocalStorage'a kaydet
                localStorage.setItem('sidebarCollapsed', isCollapsed);
            }
        }
        
        window.toggleSidebar = toggleSidebar;
        
        // Sayfa yÃ¼klendiÄŸinde sidebar durumunu geri yÃ¼kle
        // Sidebar toggle iÃ§in DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.querySelector('.sidebar');
            
            // Mobilde varsayÄ±lan olarak kapalÄ±
            const isMobile = window.innerWidth <= 768;
            const savedState = localStorage.getItem('sidebarCollapsed');
            
            if (isMobile && savedState === null) {
                // Mobilde ilk aÃ§Ä±lÄ±ÅŸta kapalÄ±
                sidebar?.classList.add('collapsed');
            } else if (savedState === 'true') {
                sidebar?.classList.add('collapsed');
            }
        });
        
        // Dropdown event listener'larÄ± iÃ§in window.load kullan
        window.addEventListener('load', () => {
            const dropdownButtons = document.querySelectorAll('.dropdown-toggle');
            
            dropdownButtons.forEach((button) => {
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    const sidebar = document.querySelector('.sidebar');
                    const isCollapsed = sidebar && sidebar.classList.contains('collapsed');
                    const dropdown = this.parentElement;
                    const dropdownContent = dropdown.querySelector('.dropdown-content');
                    
                    // Sidebar kapalÄ±ysa, sidebar'Ä± aÃ§ VE dropdown'u da aÃ§
                    if (isCollapsed) {
                        sidebar.classList.remove('collapsed');
                        localStorage.setItem('sidebarCollapsed', 'false');
                        
                        // Sidebar aÃ§Ä±lma animasyonu bittikten sonra dropdown'u aÃ§
                        setTimeout(() => {
                            // TÃ¼m dropdown'larÄ± kapat
                            document.querySelectorAll('.dropdown-content.show').forEach(content => {
                                content.classList.remove('show');
                            });
                            document.querySelectorAll('.dropdown-toggle.open').forEach(toggle => {
                                toggle.classList.remove('open');
                            });
                            
                            // Bu dropdown'u aÃ§
                            if (dropdownContent) {
                                dropdownContent.classList.add('show');
                                this.classList.add('open');
                            }
                        }, 300); // CSS transition sÃ¼resi kadar bekle
                        return;
                    }
                    
                    // Sidebar aÃ§Ä±ksa normal dropdown davranÄ±ÅŸÄ±
                    const isOpen = dropdownContent && dropdownContent.classList.contains('show');
                    
                    // TÃ¼m dropdown'larÄ± kapat
                    document.querySelectorAll('.dropdown-content.show').forEach(content => {
                        content.classList.remove('show');
                    });
                    document.querySelectorAll('.dropdown-toggle.open').forEach(toggle => {
                        toggle.classList.remove('open');
                    });
                    
                    // Bu dropdown'Ä± aÃ§/kapat
                    if (!isOpen && dropdownContent) {
                        dropdownContent.classList.add('show');
                        this.classList.add('open');
                    }
                });
            });
        });

        async function showSection(sectionId, element) {
            // âœ… CRM yetkisi kontrolÃ¼ - isSuperAdmin VEYA view_crm yetkisi varsa eriÅŸebilir
            if (sectionId === 'crm' && currentUser && currentUser.permissions && !currentUser.isSuperAdmin && !currentUser.permissions.view_crm) {
                showAlert('Bu bÃ¶lÃ¼me eriÅŸim yetkiniz yok.', 'danger');
                return;
            }

            // Ã–nceki section'dan Ã§Ä±karken temizlik yap
            if (currentSection === 'crm-incoming-calls' && sectionId !== 'crm-incoming-calls') {
                // Gelen aramalar otomatik yenileme durdur
                if (window.stopIncomingCallsAutoRefresh) {
                    stopIncomingCallsAutoRefresh();
                }
            }

            currentSection = sectionId;
            console.log('ğŸ“ Switching to section:', sectionId);
            
            // TÃ¼m section'larÄ± gizle ve nav butonlarÄ±nÄ± pasif yap
            document.querySelectorAll('.section').forEach(s => {
                s.classList.remove('active');
                s.style.display = 'none';
            });
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            // GÃ¶sterilecek section'Ä± bul ve gÃ¶ster
            const sectionToShow = document.getElementById(sectionId);
            if(sectionToShow) {
                sectionToShow.classList.add('active');
                sectionToShow.style.display = 'block';
            } else {
                console.warn('âš ï¸ Section not found:', sectionId);
            }
            if (element) element.classList.add('active');
            
            // WhatsApp section'a girildiÄŸinde Ã¶zel iÅŸlem yapma
            // (Bildirimler artÄ±k otomatik Ã§alÄ±ÅŸÄ±yor)
            
            renderCurrentSection();
        }
        
        // Dropdown menÃ¼ toggle
        function toggleDropdown(button, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const dropdown = button.parentElement;
            const dropdownContent = dropdown.querySelector('.dropdown-content');
            const isOpen = dropdownContent && dropdownContent.classList.contains('show');
            
            // TÃ¼m dropdown'larÄ± kapat
            document.querySelectorAll('.dropdown-content.show').forEach(content => {
                content.classList.remove('show');
            });
            document.querySelectorAll('.dropdown-toggle.open').forEach(toggle => {
                toggle.classList.remove('open');
            });
            
            // Bu dropdown'Ä± aÃ§/kapat
            if (!isOpen && dropdownContent) {
                dropdownContent.classList.add('show');
                button.classList.add('open');
            }
        }
        
        window.toggleDropdown = toggleDropdown;
        
        function renderBranchesTable() {
            const tbody = document.getElementById('branchesTable');
            if (!tbody) return;
            
            if (branches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">HenÃ¼z branÅŸ eklenmemiÅŸ.</td></tr>';
                return;
            }
            
            tbody.innerHTML = branches.map(branch => {
                const courtsList = (branch.courts && branch.courts.length > 0) 
                    ? branch.courts.map(c => c.name).join(', ') 
                    : '<span style="color: #999;">-</span>';
                    
                return `
                    <tr>
                        <td style="font-size: 28px; text-align: center;">${branch.icon}</td>
                        <td><code>${branch.id}</code></td>
                        <td><strong>${branch.name}</strong></td>
                        <td>${branch.lessonName}</td>
                        <td>${courtsList}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editBranch('${branch.id}')" style="margin-right: 5px;">âœï¸</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteBranch('${branch.id}')">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        window.addBranch = async function(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const idInput = form.querySelector('[name="branchId"]');
            const isEditing = idInput.getAttribute('data-editing') === 'true';
            
            console.log('ğŸ”µ addBranch Ã§aÄŸrÄ±ldÄ±, editing mode:', isEditing);
            
            // âœ… EÄŸer dÃ¼zenleme modundaysa, saveBranchEdit Ã§aÄŸÄ±r
            if (isEditing) {
                console.log('â¡ï¸ saveBranchEdit Ã§aÄŸrÄ±lÄ±yor...');
                return await saveBranchEdit(event);
            }
            
            console.log('â¡ï¸ Yeni branÅŸ ekleme modu');
            const branchId = formData.get('branchId').toLowerCase().trim();
            
            const icon = formData.get('branchIcon').trim();
            
            // âœ… SahalarÄ± al (virgÃ¼lle ayrÄ±lmÄ±ÅŸ)
            const courtsInput = formData.get('branchCourts').trim();
            const courts = courtsInput ? courtsInput.split(',').map((c, idx) => ({
                id: idx + 1,
                name: c.trim()
            })).filter(c => c.name) : [];
            
            const newBranch = {
                id: branchId,
                name: formData.get('branchName').trim(),
                icon: icon || 'âš½', // âœ… Ä°kon opsiyonel - varsayÄ±lan emoji
                lessonName: formData.get('branchLessonName').trim(),
                courts: courts // âœ… Sahalar
            };
            
            // Check if branch ID already exists
            if (branches.find(b => b.id === newBranch.id)) {
                showAlert('Bu branÅŸ ID zaten mevcut!', 'danger');
                return;
            }
            
            try {
                // âœ… Supabase branches tablosuna kaydet
                const insertData = {
                    clubId: currentClubId,
                    branchId: newBranch.id,
                    branchName: newBranch.name,
                    icon: newBranch.icon || 'âš½',
                    color: '#4CAF50', // VarsayÄ±lan renk
                    courts: newBranch.courts || [],
                    isActive: true,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                // lessonName'i ekle (eÄŸer kolon varsa)
                if (newBranch.lessonName) {
                    insertData.lessonName = newBranch.lessonName;
                }
                
                const { data: supabaseData, error: supabaseError } = await supabase
                    .from('branches')
                    .insert([insertData]);
                
                if (supabaseError) {
                    console.error('âŒ Supabase branÅŸ ekleme hatasÄ±:', supabaseError);
                    showAlert('âŒ BranÅŸ eklenirken hata oluÅŸtu!', 'danger');
                    return;
                }
                
                branches.push(newBranch);
                showAlert('âœ… BranÅŸ baÅŸarÄ±yla eklendi!', 'success');
                form.reset();
                renderBranchesTable();
                
                // âœ… TÃ¼m verileri yeniden yÃ¼kle ki branÅŸlar her yerde gÃ¶rÃ¼nsÃ¼n
                await loadData();
            } catch (error) {
                console.error('Error adding branch:', error);
                showAlert('âŒ BranÅŸ eklenirken hata oluÅŸtu!', 'danger');
            }
        };
        
        // âœ… Formu temizle ve yeni ekleme moduna geÃ§
        window.resetBranchForm = function() {
            const form = document.getElementById('branchForm');
            form.reset();
            
            const idInput = form.querySelector('[name="branchId"]');
            idInput.readOnly = false;
            idInput.style.backgroundColor = '';
            idInput.style.cursor = '';
            idInput.removeAttribute('data-editing');
            
            document.getElementById('branchFormTitle').textContent = 'â• Yeni BranÅŸ Ekle';
            document.getElementById('branchSubmitBtn').innerHTML = 'â• Ekle';
        };
        
        window.editBranch = async function(branchId) {
            const branch = branches.find(b => b.id === branchId);
            if (!branch) return;
            
            // âœ… Modal ile dÃ¼zenleme (daha kullanÄ±cÄ± dostu)
            const form = document.getElementById('branchForm');
            form.reset();
            
            // Form alanlarÄ±nÄ± doldur
            const idInput = form.querySelector('[name="branchId"]');
            idInput.value = branch.id;
            form.querySelector('[name="branchName"]').value = branch.name;
            form.querySelector('[name="branchIcon"]').value = branch.icon || '';
            form.querySelector('[name="branchLessonName"]').value = branch.lessonName;
            
            // Sahalar (virgÃ¼lle ayrÄ±lmÄ±ÅŸ string)
            const courtsStr = (branch.courts || []).map(c => c.name).join(', ');
            form.querySelector('[name="branchCourts"]').value = courtsStr;
            
            // âœ… ID alanÄ±nÄ± readonly yap (disabled deÄŸil, Ã§Ã¼nkÃ¼ disabled form submit'te gelmez)
            idInput.readOnly = true;
            idInput.style.backgroundColor = '#f0f0f0';
            idInput.style.cursor = 'not-allowed';
            idInput.setAttribute('data-editing', 'true'); // âœ… DÃ¼zenleme flag'i
            
            // âœ… BaÅŸlÄ±k ve butonu deÄŸiÅŸtir
            document.getElementById('branchFormTitle').textContent = 'âœï¸ BranÅŸ DÃ¼zenle';
            document.getElementById('branchSubmitBtn').innerHTML = 'ğŸ’¾ GÃ¼ncelle';
            
            // Forma scroll yap
            form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // Ä°lk input'a focus
            form.querySelector('[name="branchName"]').focus();
        };
        
        window.saveBranchEdit = async function(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const branchId = formData.get('branchId');
            console.log('ğŸ’¾ saveBranchEdit Ã§aÄŸrÄ±ldÄ±, branchId:', branchId);
            
            const branch = branches.find(b => b.id === branchId);
            if (!branch) {
                console.error('âŒ BranÅŸ bulunamadÄ±:', branchId);
                showAlert('BranÅŸ bulunamadÄ±!', 'danger');
                return;
            }
            
            console.log('âœ… BranÅŸ bulundu, gÃ¼ncelleniyor...', branch);
            
            const icon = formData.get('branchIcon').trim();
            const courtsInput = formData.get('branchCourts').trim();
            const courts = courtsInput ? courtsInput.split(',').map((c, idx) => ({
                id: idx + 1,
                name: c.trim()
            })).filter(c => c.name) : [];
            
            try {
                const index = branches.findIndex(b => b.id === branchId);
                const updatedBranch = {
                    ...branches[index],
                    name: formData.get('branchName').trim(),
                    icon: icon || 'âš½',
                    lessonName: formData.get('branchLessonName').trim(),
                    courts: courts
                };
                
                // âœ… Supabase'de gÃ¼ncelle
                const updateData = {
                    branchName: updatedBranch.name,
                    icon: updatedBranch.icon,
                    courts: updatedBranch.courts || [],
                    updatedAt: new Date().toISOString()
                };
                
                // lessonName'i ekle (eÄŸer kolon varsa)
                if (updatedBranch.lessonName) {
                    updateData.lessonName = updatedBranch.lessonName;
                }
                
                const { error: supabaseError } = await supabase
                    .from('branches')
                    .update(updateData)
                    .eq('clubId', currentClubId)
                    .eq('branchId', branchId);
                
                if (supabaseError) {
                    console.error('âŒ Supabase branÅŸ gÃ¼ncelleme hatasÄ±:', supabaseError);
                    showAlert('âŒ BranÅŸ gÃ¼ncellenirken hata oluÅŸtu!', 'danger');
                    return;
                }
                
                branches[index] = updatedBranch;
                showAlert('âœ… BranÅŸ baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
                
                // âœ… Formu temizle ve normal moda Ã§evir
                const idInput = form.querySelector('[name="branchId"]');
                idInput.readOnly = false;
                idInput.style.backgroundColor = '';
                idInput.style.cursor = '';
                idInput.removeAttribute('data-editing');
                
                form.reset();
                renderBranchesTable();
                
                // âœ… BaÅŸlÄ±k ve butonu geri al
                document.getElementById('branchFormTitle').textContent = 'â• Yeni BranÅŸ Ekle';
                document.getElementById('branchSubmitBtn').innerHTML = 'â• Ekle';
                
                // âœ… TÃ¼m verileri yeniden yÃ¼kle
                await loadData();
            } catch (error) {
                console.error('Error updating branch:', error);
                showAlert('âŒ BranÅŸ gÃ¼ncellenirken hata oluÅŸtu!', 'danger');
            }
        };
        
        window.deleteBranch = async function(branchId) {
            if (!confirm(`"${branchId}" branÅŸÄ±nÄ± silmek istediÄŸinizden emin misiniz?\n\nDikkat: Bu branÅŸa ait gruplar ve Ã¼yeler etkilenebilir!`)) {
                return;
            }
            
            try {
                // âœ… Supabase'den sil (soft delete - isActive = false)
                const { error: supabaseError } = await supabase
                    .from('branches')
                    .update({
                        isActive: false,
                        updatedAt: new Date().toISOString()
                    })
                    .eq('clubId', currentClubId)
                    .eq('branchId', branchId);
                
                if (supabaseError) {
                    console.error('âŒ Supabase branÅŸ silme hatasÄ±:', supabaseError);
                    showAlert('âŒ BranÅŸ silinirken hata oluÅŸtu!', 'danger');
                    return;
                }
                
                branches = branches.filter(b => b.id !== branchId);
                showAlert('âœ… BranÅŸ baÅŸarÄ±yla silindi!', 'success');
                renderBranchesTable();
                
                // âœ… TÃ¼m verileri yeniden yÃ¼kle
                await loadData();
            } catch (error) {
                console.error('Error deleting branch:', error);
                showAlert('âŒ BranÅŸ silinirken hata oluÅŸtu!', 'danger');
            }
        };
        
        async function loadClubInfo() {
            try {
                const { getDoc, doc } = window.firebase;
                const clubInfoDoc = await getDoc(doc(window.db, 'settings', `club_${currentClubId}`));
                
                if (clubInfoDoc.exists()) {
                    const data = clubInfoDoc.data();
                    
                    // Populate form (null check ekleyelim - form sadece settings bÃ¶lÃ¼mÃ¼nde mevcut)
                    const setValueSafe = (id, value) => {
                        const elem = document.getElementById(id);
                        if (elem) elem.value = value || '';
                    };
                    
                    setValueSafe('clubInfoName', data.clubName);
                    setValueSafe('clubIcon', data.clubIcon);
                    setValueSafe('clubDescription', data.clubDescription);
                    setValueSafe('clubAddress', data.clubAddress);
                    setValueSafe('clubCity', data.clubCity);
                    setValueSafe('clubPhone', data.clubPhone);
                    setValueSafe('clubEmail', data.clubEmail);
                    setValueSafe('clubWebsite', data.clubWebsite);
                    setValueSafe('clubInstagram', data.clubInstagram);
                    setValueSafe('clubFacebook', data.clubFacebook);
                    setValueSafe('clubTwitter', data.clubTwitter);
                    setValueSafe('clubFounded', data.clubFounded);
                    setValueSafe('clubTimezone', data.clubTimezone || 'Europe/Istanbul');
                    setValueSafe('clubCurrency', data.clubCurrency || 'TRY');
                    setValueSafe('clubLanguage', data.clubLanguage || 'tr');
                    setValueSafe('contractTemplate', data.contractTemplate);
                    // âœ… IBAN bilgileri
                    if (data.iban) {
                        console.log('ğŸ“¦ IBAN yÃ¼kleniyor:', data.iban);
                        if (data.iban.tenis) {
                            setValueSafe('ibanTenisName', data.iban.tenis.name);
                            setValueSafe('ibanTenisIban', data.iban.tenis.iban);
                            setValueSafe('ibanTenisBankName', data.iban.tenis.bankName);
                        }
                        if (data.iban.yuzme) {
                            setValueSafe('ibanYuzmeName', data.iban.yuzme.name);
                            setValueSafe('ibanYuzmeIban', data.iban.yuzme.iban);
                            setValueSafe('ibanYuzmeBankName', data.iban.yuzme.bankName);
                        }
                    } else {
                        console.warn('âš ï¸ IBAN bilgisi yok');
                    }
                    
                    console.log('âœ… Club info loaded');
                } else {
                    // Ä°lk kez, kulÃ¼pten gelen bilgileri kullan
                    const elem = document.getElementById('clubInfoName');
                    if (elem) elem.value = currentUser.clubName || clubSettings.clubName || '';
                    console.log('â„¹ï¸ No club info found, using defaults');
                }
                // KayÄ±t linkini oluÅŸtur ve gÃ¶ster (setTimeout ile DOM hazÄ±r olduÄŸundan emin ol)
                setTimeout(() => {
                    if (typeof generateRegistrationLink === 'function') {
                        generateRegistrationLink();
                    }
                }, 100);
                
                // âœ… SÃ¶zleÅŸme ÅŸablonu textarea'sÄ±nÄ± dinamik olarak ekle (eÄŸer yoksa)
                ensureContractTemplateField();
            } catch (error) {
                console.error('Error loading club info:', error);
            }
        }
        
        // âœ… SÃ¶zleÅŸme ÅŸablonu ve kulÃ¼p detay alanlarÄ±nÄ± dinamik olarak ekle
        function ensureContractTemplateField() {
            // EÄŸer zaten varsa ekleme
            if (document.getElementById('contractTemplate')) {
                return;
            }
            
            // clubLanguage alanÄ±nÄ± bul
            const clubLanguageInput = document.getElementById('clubLanguage');
            if (!clubLanguageInput) {
                console.warn('âš ï¸ clubLanguage input bulunamadÄ±, sÃ¶zleÅŸme ÅŸablonu alanÄ± eklenemiyor');
                return;
            }
            
            // Parent container'Ä± bul
            const parentDiv = clubLanguageInput.closest('.form-group') || clubLanguageInput.parentElement;
            if (!parentDiv || !parentDiv.parentElement) {
                console.warn('âš ï¸ Parent container bulunamadÄ±');
                return;
            }
            
            // Yeni textarea container oluÅŸtur
            const newFieldContainer = document.createElement('div');
            newFieldContainer.className = 'form-group';
            newFieldContainer.style.gridColumn = '1 / -1'; // Full width
            newFieldContainer.innerHTML = `
                <label for="contractTemplate">
                    ğŸ“„ SÃ¶zleÅŸme Åablonu (HTML)
                    <small style="display: block; color: #666; font-weight: normal; margin-top: 5px;">
                        KayÄ±t sayfasÄ±nda mÃ¼ÅŸteriye gÃ¶sterilecek sÃ¶zleÅŸme metni. 
                        <br><strong>âš ï¸ NOT:</strong> KulÃ¼p bilgilerini (yetkili, adres, vergi no vb.) direkt metin olarak yazÄ±n, deÄŸiÅŸken kullanmayÄ±n!
                        <br>
                        <br><strong>ğŸ“„ PDF Sayfalama Ä°pucu:</strong>
                        <br>â€¢ SÃ¶zleÅŸmenizde manuel sayfa sonlarÄ± eklemek iÃ§in <code>&lt;hr&gt;</code> etiketi kullanÄ±n
                        <br>â€¢ Ã–rnek: <code>&lt;p&gt;Madde 5...&lt;/p&gt;&lt;hr&gt;&lt;h4&gt;6. MADDE&lt;/h4&gt;</code>
                        <br>â€¢ <strong>âš ï¸ 10'dan fazla &lt;hr&gt; kullanmayÄ±n!</strong> Her &lt;hr&gt; yeni sayfa baÅŸlatÄ±r.
                        <br>â€¢ EÄŸer &lt;hr&gt; kullanmazsanÄ±z, sistem otomatik sayfalama yapar (4000 karakter/sayfa)
                        <br>
                        <br><strong>KullanÄ±labilir deÄŸiÅŸkenler (sadece Ã¼ye/veli bilgileri iÃ§in):</strong> 
                        <br>â€¢ {UYE_AD_SOYAD} veya {Ad_Soyad} - Veli/Ã¼ye adÄ±
                        <br>â€¢ {UYE_TCKN} veya {TC_Kimlik_No} - TC kimlik numarasÄ±
                        <br>â€¢ {UYE_TELEFON} veya {Telefon} - Telefon
                        <br>â€¢ {UYE_ADRES} veya {Adres} - Adres
                        <br>â€¢ {UYE_DOGUM_TARIHI} veya {Dogum_Tarihi} - DoÄŸum tarihi (otomatik formatlanÄ±r)
                        <br>â€¢ {Veli_2_Adi_Soyadi} - Ä°kinci veli adÄ±
                        <br>â€¢ {Telefon_2} - Ä°kinci telefon
                        <br>â€¢ {Ogrenci_Bilgileri} - Ã–ÄŸrenci bilgileri (Ã§ocuk kayÄ±tlarÄ±nda otomatik eklenir)
                    </small>
                </label>
                <textarea 
                    id="contractTemplate" 
                    name="contractTemplate" 
                    rows="20" 
                    style="font-family: monospace; font-size: 13px; line-height: 1.6;"
                    placeholder="<h3>ÃœYELÄ°K SÃ–ZLEÅMESÄ°</h3>

<h4>1-) TARAFLAR</h4>

<p><strong>A-KULÃœP</strong></p>
<p>AdÄ±-SoyadÄ± : Aykut YILDIRIM</p>
<p>ÃœnvanÄ± : Atakum Tenis</p>
<p>Adres : Derecik Mahallesi 1444. Sokak No:1 Ä°lkadÄ±m/Samsun</p>
<p>Vergi No : 9540639540</p>
<p>Telefon : 0362 363 00 64</p>
<p>E-mail : y.aykut7455@gmail.com</p>
<p>Bu sÃ¶zleÅŸmede bundan sonra &quot;EÄÄ°TMEN/KULÃœP&quot; olarak anÄ±lacaktÄ±r.</p>

<p><strong>B-ÃœYE/VELÄ°</strong></p>
<p>AdÄ±-SoyadÄ± : {UYE_AD_SOYAD}</p>
<p>DoÄŸum Tarihi : {UYE_DOGUM_TARIHI}</p>
<p>Adres : {UYE_ADRES}</p>
<p>TCKN : {UYE_TCKN}</p>
<p>Telefon : {UYE_TELEFON}</p>
<p>Bu sÃ¶zleÅŸmede bundan sonra &quot;ÃœYE/VELÄ°&quot; olarak anÄ±lacaktÄ±r.</p>

{Ogrenci_Bilgileri}

<h4>2-) SÃ–ZLEÅME KONUSU VE KAPSAMI</h4>
<p>...</p>"
                ></textarea>
            `;
            
            // clubLanguage alanÄ±ndan sonra ekle
            parentDiv.parentElement.insertBefore(newFieldContainer, parentDiv.nextSibling);
            console.log('âœ… SÃ¶zleÅŸme ÅŸablonu alanÄ± eklendi');
        }

        // Slug oluÅŸtur (kayit.html ile aynÄ±)
        function createSlug(text) {
            if (!text) return '';
            
            const trMap = {
                'Ã§': 'c', 'Ã‡': 'c',
                'ÄŸ': 'g', 'Ä': 'g',
                'Ä±': 'i', 'Ä°': 'i',
                'Ã¶': 'o', 'Ã–': 'o',
                'ÅŸ': 's', 'Å': 's',
                'Ã¼': 'u', 'Ãœ': 'u'
            };
            
            return text
                .split('')
                .map(char => trMap[char] || char)
                .join('')
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '')
                .replace(/^-+|-+$/g, '');
        }
        
        // KayÄ±t linkini oluÅŸtur ve gÃ¶ster
        function generateRegistrationLink() {
            const clubName = document.getElementById('clubInfoName').value;
            if (!clubName) return;
            
            const slug = createSlug(clubName);
            
            // Base URL - direkt domain kullan, /uyeyeni/ ekleme
            const baseUrl = window.location.origin;
            const registrationUrl = `${baseUrl}/kayit?club=${slug}`;
            
            document.getElementById('registrationLinkDisplay').value = registrationUrl;
            document.getElementById('registrationLinkSection').style.display = 'block';
            
            return registrationUrl;
        }
        
        // Linki kopyala
        window.copyRegistrationLink = function() {
            const linkInput = document.getElementById('registrationLinkDisplay');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999); // Mobil iÃ§in
            
            navigator.clipboard.writeText(linkInput.value).then(() => {
                showAlert('âœ… KayÄ±t linki kopyalandÄ±!', 'success');
            }).catch(() => {
                document.execCommand('copy');
                showAlert('âœ… KayÄ±t linki kopyalandÄ±!', 'success');
            });
        };
        
        // Linki yeni sekmede aÃ§
        window.openRegistrationLink = function() {
            const linkInput = document.getElementById('registrationLinkDisplay');
            window.open(linkInput.value, '_blank');
        };
        
        window.saveClubInfo = async function(event) {
            event.preventDefault();
            const form = event.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'â³ Kaydediliyor...';
                
                // âœ… IBAN bilgilerini topla
                const ibanData = {};
                const ibanTenisName = document.getElementById('ibanTenisName');
                const ibanTenisIban = document.getElementById('ibanTenisIban');
                const ibanTenisBankName = document.getElementById('ibanTenisBankName');
                const ibanYuzmeName = document.getElementById('ibanYuzmeName');
                const ibanYuzmeIban = document.getElementById('ibanYuzmeIban');
                const ibanYuzmeBankName = document.getElementById('ibanYuzmeBankName');
                
                if (ibanTenisName && ibanTenisIban) {
                    ibanData.tenis = {
                        name: ibanTenisName.value || '',
                        iban: ibanTenisIban.value || '',
                        bankName: ibanTenisBankName ? ibanTenisBankName.value : ''
                    };
                }
                
                if (ibanYuzmeName && ibanYuzmeIban) {
                    ibanData.yuzme = {
                        name: ibanYuzmeName.value || '',
                        iban: ibanYuzmeIban.value || '',
                        bankName: ibanYuzmeBankName ? ibanYuzmeBankName.value : ''
                    };
                }
                
                // âœ… GÃ¼venli element okuma helper
                const getValueSafe = (id) => {
                    const elem = document.getElementById(id);
                    return elem ? elem.value : '';
                };
                
                const clubInfoData = {
                    clubName: getValueSafe('clubInfoName'),
                    clubIcon: getValueSafe('clubIcon'),
                    clubDescription: getValueSafe('clubDescription'),
                    clubAddress: getValueSafe('clubAddress'),
                    clubCity: getValueSafe('clubCity'),
                    clubPhone: getValueSafe('clubPhone'),
                    clubEmail: getValueSafe('clubEmail'),
                    clubWebsite: getValueSafe('clubWebsite'),
                    clubInstagram: getValueSafe('clubInstagram'),
                    clubFacebook: getValueSafe('clubFacebook'),
                    clubTwitter: getValueSafe('clubTwitter'),
                    clubFounded: getValueSafe('clubFounded'),
                    clubTimezone: getValueSafe('clubTimezone'),
                    clubCurrency: getValueSafe('clubCurrency'),
                    clubLanguage: getValueSafe('clubLanguage'),
                    contractTemplate: getValueSafe('contractTemplate'),
                    // âœ… IBAN bilgileri
                    iban: ibanData,
                    clubId: currentClubId,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.email
                };
                
                console.log('ğŸ’¾ Kaydedilecek veri:', clubInfoData);
                console.log('ğŸ“¦ IBAN verisi:', ibanData);
                
                const { setDoc, doc } = window.firebase;
                // Sadece club_${clubId} kullanÄ±yoruz (clubInfo_ yerine)
                await setDoc(doc(window.db, 'settings', `club_${currentClubId}`), clubInfoData);
                
                console.log('âœ… Veri Supabase\'e kaydedildi');
                
                // Update global clubSettings
                clubSettings.clubName = clubInfoData.clubName;
                
                // Update title
                document.getElementById('club-title').textContent = clubInfoData.clubName;
                const clubTitleHeader = document.getElementById('club-title-header');
                if (clubTitleHeader) clubTitleHeader.textContent = `${clubInfoData.clubName} - YÃ¶netim Paneli`;
                document.title = `${clubInfoData.clubName} - YÃ¶netim Paneli`;
                
                // KayÄ±t linkini gÃ¶ster
                generateRegistrationLink();
                
                showAlert('âœ… KulÃ¼p bilgileri baÅŸarÄ±yla kaydedildi!', 'success');
                console.log('âœ… Club info saved');
                
            } catch (error) {
                console.error('Error saving club info:', error);
                showAlert('âŒ KulÃ¼p bilgileri kaydedilirken hata oluÅŸtu!', 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸ’¾ KulÃ¼p Bilgilerini Kaydet';
            }
        };
        
        // âœ… Webhook AyarlarÄ± YÃ¼kleme - REMOVED (Now in SuperAdmin)
        // Webhook management is now handled by SuperAdmin panel
        // OLD WEBHOOK FUNCTIONS - REMOVED (loadWebhookSettings moved to line ~10701)
        async function _oldLoadWebhookSettings() {
            try {
                const webhooksCollection = window.firebase.collection(window.db, 'webhooks');
                const q = window.firebase.query(webhooksCollection, window.firebase.where('clubId', '==', currentClubId));
                const querySnapshot = await window.firebase.getDocs(q);
                
                const webhookList = document.getElementById('webhookList');
                
                if (querySnapshot.empty) {
                    webhookList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p style="font-size: 48px; margin: 0;">ğŸ”—</p>
                            <p>HenÃ¼z tanÄ±mlÄ± webhook bulunmuyor</p>
                            <p style="font-size: 14px;">Yeni webhook eklemek iÃ§in yukarÄ±daki butonu kullanÄ±n</p>
                        </div>
                    `;
                    return;
                }
                
                let tableHtml = `
                    <table class="data-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Durum</th>
                                <th>Webhook AdÄ±</th>
                                <th>URL</th>
                                <th>Olaylar</th>
                                <th>GÃ¼ncelleme</th>
                                <th style="width: 150px;">Ä°ÅŸlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                querySnapshot.forEach(doc => {
                    const webhook = doc.data();
                    const statusBadge = webhook.active 
                        ? '<span style="background: #28a745; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px;">âœ“ Aktif</span>'
                        : '<span style="background: #6c757d; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px;">â—‹ Pasif</span>';
                    
                    const eventIcons = {
                        'whatsapp_message': 'ğŸ’¬',
                        'new_member': 'ğŸ‘¤',
                        'payment': 'ğŸ’°',
                        'attendance': 'ğŸ“‹',
                        'contract_signed': 'ğŸ“'
                    };
                    
                    const eventsHtml = (webhook.eventTypes || [])
                        .map(e => eventIcons[e] || e)
                        .join(' ');
                    
                    const updatedDate = webhook.updatedAt 
                        ? new Date(webhook.updatedAt).toLocaleDateString('tr-TR')
                        : '-';
                    
                    tableHtml += `
                        <tr>
                            <td>${statusBadge}</td>
                            <td><strong>${webhook.name}</strong></td>
                            <td style="font-size: 12px; font-family: monospace; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${webhook.url}">${webhook.url}</td>
                            <td>${eventsHtml || '-'}</td>
                            <td style="font-size: 13px;">${updatedDate}</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="testWebhookById('${doc.id}')" title="Test Et">ğŸ§ª</button>
                                <button class="btn btn-sm btn-warning" onclick="editWebhook('${doc.id}')" title="DÃ¼zenle">âœï¸</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteWebhook('${doc.id}', '${webhook.name}')" title="Sil">ğŸ—‘ï¸</button>
                            </td>
                        </tr>
                    `;
                });
                
                tableHtml += '</tbody></table>';
                webhookList.innerHTML = tableHtml;
                
                console.log(`âœ… ${querySnapshot.size} webhook yÃ¼klendi`);
                
            } catch (error) {
                console.error('Error loading webhooks:', error);
                showAlert('Webhook\'lar yÃ¼klenirken hata oluÅŸtu.', 'danger');
            }
        }
        
        // âœ… Webhook Ekleme/DÃ¼zenleme ModalÄ± GÃ¶ster
        window.showWebhookAddModal = function() {
            document.getElementById('webhookModalTitle').textContent = 'â• Yeni Webhook Ekle';
            document.getElementById('webhookForm').reset();
            document.getElementById('webhookId').value = '';
            document.getElementById('webhookActive').checked = true;
            
            // Default olarak bazÄ± event'leri iÅŸaretle
            document.querySelectorAll('input[name="webhookEventTypes"]').forEach(cb => {
                cb.checked = ['whatsapp_message', 'new_member', 'payment', 'contract_signed'].includes(cb.value);
            });
            
            document.getElementById('webhookModal').style.display = 'block';
        };
        
        // âœ… Webhook DÃ¼zenleme
        window.editWebhook = async function(webhookId) {
            try {
                const webhookDoc = await window.firebase.getDoc(
                    window.firebase.doc(window.db, 'webhooks', webhookId)
                );
                
                if (!webhookDoc.exists()) {
                    showAlert('Webhook bulunamadÄ±!', 'danger');
                    return;
                }
                
                const webhook = webhookDoc.data();
                
                document.getElementById('webhookModalTitle').textContent = 'âœï¸ Webhook DÃ¼zenle';
                document.getElementById('webhookId').value = webhookId;
                document.getElementById('webhookName').value = webhook.name || '';
                document.getElementById('webhookUrl').value = webhook.url || '';
                document.getElementById('webhookActive').checked = webhook.active !== false;
                
                // Event types
                document.querySelectorAll('input[name="webhookEventTypes"]').forEach(cb => {
                    cb.checked = (webhook.eventTypes || []).includes(cb.value);
                });
                
                document.getElementById('webhookModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading webhook:', error);
                showAlert('Webhook yÃ¼klenirken hata oluÅŸtu!', 'danger');
            }
        };
        
        // âœ… Modal Kapatma
        window.closeWebhookModal = function() {
            document.getElementById('webhookModal').style.display = 'none';
            document.getElementById('webhookForm').reset();
        };
        
        // âœ… Webhook Kaydetme (Yeni veya GÃ¼ncelleme)
        window.saveWebhook = async function(event) {
            event.preventDefault();
            
            const form = event.target;
            const webhookId = form.webhookId.value;
            const webhookName = form.webhookName.value.trim();
            const webhookUrl = form.webhookUrl.value.trim();
            const active = form.webhookActive.checked;
            
            if (!webhookName || !webhookUrl) {
                showAlert('LÃ¼tfen webhook adÄ± ve URL\'ini girin.', 'warning');
                return;
            }
            
            // Get selected event types
            const eventTypes = Array.from(form.querySelectorAll('input[name="webhookEventTypes"]:checked'))
                .map(cb => cb.value);
            
            const webhookData = {
                name: webhookName,
                url: webhookUrl,
                active: active,
                eventTypes: eventTypes,
                clubId: currentClubId,
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser.fullName || currentUser.email
            };
            
            try {
                if (webhookId) {
                    // Update existing
                    await window.firebase.updateDoc(
                        window.firebase.doc(window.db, 'webhooks', webhookId),
                        webhookData
                    );
                    showAlert('âœ… Webhook baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
                } else {
                    // Create new
                    webhookData.createdAt = new Date().toISOString();
                    await window.firebase.addDoc(
                        window.firebase.collection(window.db, 'webhooks'),
                        webhookData
                    );
                    showAlert('âœ… Webhook baÅŸarÄ±yla eklendi!', 'success');
                }
                
                closeWebhookModal();
                loadWebhookSettings();
                
            } catch (error) {
                console.error('Error saving webhook:', error);
                showAlert('âŒ Webhook kaydedilirken hata oluÅŸtu!', 'danger');
            }
        };
        
        // âœ… Webhook Silme
        window.deleteWebhook = async function(webhookId, webhookName) {
            if (!confirm(`"${webhookName}" webhook'unu silmek istediÄŸinize emin misiniz?`)) {
                return;
            }
            
            try {
                await window.firebase.deleteDoc(
                    window.firebase.doc(window.db, 'webhooks', webhookId)
                );
                
                showAlert('âœ… Webhook baÅŸarÄ±yla silindi!', 'success');
                loadWebhookSettings();
                
            } catch (error) {
                console.error('Error deleting webhook:', error);
                showAlert('âŒ Webhook silinirken hata oluÅŸtu!', 'danger');
            }
        };
        
        // âœ… Webhook Test (ID ile)
        window.testWebhookById = async function(webhookId) {
            try {
                const webhookDoc = await window.firebase.getDoc(
                    window.firebase.doc(window.db, 'webhooks', webhookId)
                );
                
                if (!webhookDoc.exists()) {
                    showAlert('Webhook bulunamadÄ±!', 'danger');
                    return;
                }
                
                const webhook = webhookDoc.data();
                
                if (!webhook.active) {
                    if (!confirm('Bu webhook pasif durumda. Test etmek istiyor musunuz?')) {
                        return;
                    }
                }
                
                const testPayload = {
                    event: 'test',
                    clubId: currentClubId,
                    clubName: clubInfo.clubName || 'Test KulÃ¼bÃ¼',
                    timestamp: new Date().toISOString(),
                    message: 'Bu bir test mesajÄ±dÄ±r',
                    webhookName: webhook.name
                };
                
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                showAlert('ğŸ”„ Test ediliyor...', 'info');
                
                const response = await fetch(webhook.url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(testPayload)
                });
                
                if (response.ok) {
                    const responseText = await response.text();
                    showAlert(`âœ… Webhook test baÅŸarÄ±lÄ±! (${response.status})`, 'success');
                    console.log('Webhook test response:', responseText);
                } else {
                    showAlert(`âŒ Webhook test baÅŸarÄ±sÄ±z! (${response.status} ${response.statusText})`, 'danger');
                }
                
            } catch (error) {
                console.error('Webhook test error:', error);
                showAlert(`âŒ Webhook test hatasÄ±: ${error.message}`, 'danger');
            }
        };
        
        // âœ… SÃ¶zleÅŸme Linki Kopyalama
        window.copyContractLink = function() {
            const linkInput = document.getElementById('contractLink');
            linkInput.select();
            document.execCommand('copy');
            showAlert('âœ… SÃ¶zleÅŸme linki kopyalandÄ±!', 'success');
        };
        
        // âœ… KayÄ±t tamamlandÄ± mesajÄ± Ã¶nizlemesini gÃ¼ncelle
        window.updateSuccessPreview = function() {
            const title = document.getElementById('contract-success-title')?.value || 'KayÄ±t Ä°ÅŸleminiz TamamlandÄ±!';
            const message = document.getElementById('contract-success-message')?.value || 'TeÅŸekkÃ¼r ederiz! KayÄ±t iÅŸleminiz baÅŸarÄ±yla tamamlandÄ±.';
            
            const previewTitle = document.getElementById('preview-title');
            const previewMessage = document.getElementById('preview-message');
            
            if (previewTitle) {
                previewTitle.textContent = title;
            }
            
            if (previewMessage) {
                previewMessage.textContent = message;
            }
        };
        
        // âœ… Dinamik branÅŸ IBAN alanlarÄ±nÄ± oluÅŸtur
        function renderDynamicBranchIbanFields() {
            const container = document.getElementById('dynamic-branch-iban-container');
            if (!container || !branches || branches.length === 0) {
                if (container) container.innerHTML = '<p style="color: #999;">HenÃ¼z branÅŸ eklenmemiÅŸ. LÃ¼tfen Ã¶nce branÅŸ ekleyin.</p>';
                return;
            }
            
            const colors = ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#F44336', '#00BCD4'];
            
            container.innerHTML = branches.map((branch, index) => {
                const branchId = branch.id;
                const color = colors[index % colors.length];
                
                return `
                    <div style="background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid ${color};">
                        <h5 style="color: ${color}; margin-bottom: 15px;">${branch.icon || 'ğŸ“'} ${branch.name} BranÅŸÄ±</h5>
                        
                        <div class="form-group">
                            <label for="iban_name_${branchId}">Hesap Sahibi</label>
                            <input type="text" id="iban_name_${branchId}" class="form-control" 
                                   placeholder="Ã–rn: Ã–mer Bulut">
                            <small style="color: #666;">Ãœyelere gÃ¶sterilecek hesap sahibi adÄ±</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="iban_${branchId}">IBAN NumarasÄ±</label>
                            <input type="text" id="iban_${branchId}" class="form-control" 
                                   placeholder="TR00 0000 0000 0000 0000 0000 00"
                                   maxlength="32">
                            <small style="color: #666;">TÃ¼rkiye IBAN formatÄ±nda giriniz</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="payment_instructions_${branchId}">Ã–deme TalimatlarÄ± (Ä°steÄŸe BaÄŸlÄ±)</label>
                            <textarea id="payment_instructions_${branchId}" class="form-control" rows="2" 
                                      placeholder="Ã–deme yaparken aÃ§Ä±klama kÄ±smÄ±na Ã¼ye adÄ±nÄ±zÄ± yazÄ±nÄ±z"></textarea>
                            <small style="color: #666;">Ãœyelere gÃ¶sterilecek ek Ã¶deme talimatlarÄ±</small>
                        </div>
                    </div>
                `;
            }).join('');
            
            console.log('âœ… Dinamik IBAN alanlarÄ± oluÅŸturuldu:', branches.length, 'branÅŸ');
        }
        
        // âœ… SÃ¶zleÅŸme Åablonu YÃ¼kleme
        async function loadContractTemplate() {
            try {
                // KulÃ¼p adÄ±nÄ± al
                const clubName = clubSettings?.clubName || currentUser?.clubName || 'KulÃ¼p';
                
                // URL-friendly slug oluÅŸtur
                const clubSlug = createSlug(clubName);
                
                // KulÃ¼be Ã¶zel linki oluÅŸtur ve gÃ¶ster (slug ile)
                // Base URL - direkt domain kullan, /uyeyeni/ ekleme
                const baseUrl = window.location.origin;
                const contractLink = `${baseUrl}/kayit?club=${clubSlug}`;
                document.getElementById('contractLink').value = contractLink;
                document.getElementById('contractLinkOpen').href = contractLink;
                
                // KulÃ¼p adÄ±nÄ± gÃ¶ster (okunabilir halde)
                const clubNameEl = document.getElementById('contractClubName');
                if (clubNameEl) {
                    clubNameEl.textContent = clubName;
                }
                
                const contractDoc = await window.firebase.getDoc(
                    window.firebase.doc(window.db, 'settings', `contract_${currentClubId}`)
                );
                
                // âœ… Dinamik branÅŸ IBAN alanlarÄ±nÄ± oluÅŸtur
                renderDynamicBranchIbanFields();
                
                if (contractDoc.exists()) {
                    const data = contractDoc.data();
                    
                    // âœ… SÃ¶zleÅŸme iÃ§eriÄŸini olduÄŸu gibi yÃ¼kle (kulÃ¼p bilgileri elle yazÄ±lmalÄ±)
                    document.getElementById('contractTemplate').value = data.text || '';
                    document.getElementById('contract-enabled').checked = data.enabled || false;
                    
                    // Sayfa baÅŸlÄ±klarÄ±
                    document.getElementById('contract-page-title').value = data.pageTitle || 'Spor KulÃ¼bÃ¼';
                    document.getElementById('contract-page-subtitle').value = data.pageSubtitle || 'Ãœyelik SÃ¶zleÅŸmesi';
                    
                    // Checkbox metinleri
                    document.getElementById('contract-checkbox1-text').value = data.checkbox1Text || 'Ãœyelik sÃ¶zleÅŸmesini okudum, anladÄ±m ve kabul ediyorum.';
                    document.getElementById('contract-checkbox2-text').value = data.checkbox2Text || 'ÃœyeliÄŸiniz iptal edilene kadar devam etmektedir. Her ayÄ±n 14\'Ã¼, yeni dÃ¶nem iÃ§in kayÄ±t iptali yapÄ±labilecek son gÃ¼ndÃ¼r. Bu tarihe kadar iptal edilmeyen kayÄ±tlar, devam eden dÃ¶nem iÃ§in geÃ§erli sayÄ±lÄ±r.';
                    
                    // KayÄ±t tamamlandÄ± mesajÄ±
                    document.getElementById('contract-success-title').value = data.successTitle || 'KayÄ±t Ä°ÅŸleminiz TamamlandÄ±!';
                    document.getElementById('contract-success-message').value = data.successMessage || 'Ailemize hoÅŸ geldiniz! Ãœyelik sÃ¶zleÅŸmeniz kulÃ¼bÃ¼mÃ¼ze baÅŸarÄ±yla ulaÅŸmÄ±ÅŸtÄ±r. En kÄ±sa sÃ¼rede sizinle iletiÅŸime geÃ§eceÄŸiz.';
                    
                    // Ã–nizlemeyi gÃ¼ncelle
                    if (typeof window.updateSuccessPreview === 'function') {
                        window.updateSuccessPreview();
                    }
                    
                    // âœ… Dinamik branÅŸ IBAN bilgilerini yÃ¼kle
                    if (data.branchPayments) {
                        console.log('ğŸ’¾ BranÅŸ Ã¶deme bilgileri yÃ¼kleniyor:', data.branchPayments);
                        
                        branches.forEach(branch => {
                            const branchId = branch.id;
                            const branchPayment = data.branchPayments[branchId];
                            
                            if (branchPayment) {
                                const nameInput = document.getElementById(`iban_name_${branchId}`);
                                const ibanInput = document.getElementById(`iban_${branchId}`);
                                const instructionsInput = document.getElementById(`payment_instructions_${branchId}`);
                                
                                if (nameInput) nameInput.value = branchPayment.name || '';
                                if (ibanInput) ibanInput.value = branchPayment.iban || '';
                                if (instructionsInput) instructionsInput.value = branchPayment.paymentInstructions || '';
                                
                                console.log(`âœ… ${branch.name} IBAN bilgileri yÃ¼klendi`);
                            }
                        });
                    } else {
                        console.log('â„¹ï¸ BranÅŸ Ã¶deme bilgisi bulunamadÄ± (yeni kullanÄ±cÄ±)');
                    }
                } else {
                    // VarsayÄ±lan ÅŸablon - HTML etiketli
                    document.getElementById('contractTemplate').value = `<h4>1. TARAFLAR</h4>

<p><strong>A-KULÃœP</strong><br>
AdÄ±-SoyadÄ±: {KULUP_YETKILI}<br>
ÃœnvanÄ±: {KULUP_ADI}<br>
Adres: {KULUP_ADRES}<br>
Vergi No: {KULUP_VERGI_NO}<br>
Telefon: {KULUP_TELEFON}<br>
E-mail: {KULUP_EMAIL}<br>
Bu sÃ¶zleÅŸmede bundan sonra "EÄÄ°TMEN/KULÃœP" olarak anÄ±lacaktÄ±r.</p>

<p><strong>B-ÃœYE/VELÄ°</strong><br>
AdÄ±-SoyadÄ±: {UYE_AD_SOYAD}<br>
DoÄŸum Tarihi: {UYE_DOGUM_TARIHI}<br>
Adres: {UYE_ADRES}<br>
TCKN: {UYE_TCKN}<br>
Telefon: {UYE_TELEFON}<br>
BranÅŸ: {BRANS}<br>
Bu sÃ¶zleÅŸmede bundan sonra "ÃœYE/VELÄ°" olarak anÄ±lacaktÄ±r.</p>

<p>Ãœye/Veli iÅŸbu sÃ¶zleÅŸmeyi onaylamasÄ± sÄ±rasÄ±nda EÄŸitmen tarafÄ±ndan kendisinden talep edilen her tÃ¼rlÃ¼ bilgiyi eksiksiz ve doÄŸru olarak EÄŸitmene vermeyi kabul etmektedir.</p>

<hr>

<h4>2. KONU</h4>
<p>Ä°ÅŸbu Ã¼yelik sÃ¶zleÅŸmesi, Ã¼yelik iÅŸlemlerinin gerÃ§ekleÅŸtirilmesi ile iÅŸbu sÃ¶zleÅŸmenin onaylanmasÄ± suretiyle, EÄŸitmen tarafÄ±ndan sunulacak hizmetin ÅŸartlarÄ±nÄ± ve taraflarÄ±n karÅŸÄ±lÄ±klÄ± hak ve yÃ¼kÃ¼mlÃ¼lÃ¼klerini dÃ¼zenlemektedir.</p>

<hr>

<h4>3. Ã–DEME PLANI</h4>
{AIDAT_TAKVIMI}

<p>Ã–demelerin her ayÄ±n 20'sine kadar belirtilen hesaba yapÄ±lmasÄ± gerekmektedir. Ã–demelerin zamanÄ±nda yapÄ±lmamasÄ± durumunda; Ãœye/Veli, yapacaÄŸÄ± Ã¶demenin %25'i tutarÄ±nda cezai ÅŸart Ã¶demeyi kabul ve taahhÃ¼t eder.</p>

<hr>

<h4>4. ÃœYELÄ°K Ä°PTALLERÄ°</h4>
<p>Her ayÄ±n 14'Ã¼ kayÄ±t sildirme iÃ§in son gÃ¼ndÃ¼r. Bu tarihler sonrasÄ±nda yapÄ±lan kayÄ±t sildirmelerde yeni dÃ¶nem Ã¼creti tahsil edilir.</p>

<hr>

<h4>5. GENEL HÃœKÃœMLER</h4>
<p>KulÃ¼be veya kulÃ¼p tesislerine zarar verici davranÄ±ÅŸlarda bulunulmasÄ± durumunda kulÃ¼p Ã¼yeliÄŸi sonlandÄ±rÄ±labilir. EÄŸitmen, her tÃ¼rlÃ¼ Ã¼yelik talebini hiÃ§bir gerekÃ§e gÃ¶stermeksizin tek taraflÄ± olarak reddetme hakkÄ±na sahiptir.</p><br>
2) EÄŸitmenden, suÃ§ iÅŸlememiÅŸ ve herhangi bir yÃ¼z kÄ±zartÄ±cÄ± suÃ§tan sabÄ±ka kaydÄ± bulunmayan T.C. vatandaÅŸlarÄ± ile yabancÄ± uyruklu kiÅŸiler ders alabilir.<br>
3) Ãœye/Veli, Ã¼yelik iÃ§in gerekli olan her tÃ¼rlÃ¼ belgeyi eksiksiz ve doÄŸru bir ÅŸekilde temin edecektir.<br>
4) Ãœyelerin spor faaliyetine katÄ±lmak iÃ§in gerekli saÄŸlÄ±k ÅŸartlarÄ±nÄ± taÅŸÄ±yÄ±p taÅŸÄ±madÄ±klarÄ±, tÄ±bbi kontrollerini yaptÄ±rÄ±p yaptÄ±rmadÄ±klarÄ± sorumluluÄŸu Ãœye/Veliye aittir.<br>
5) Ãœyelerin, ders veya aktivitelerden faydalanmamalarÄ± halinde dahi belirlenen bedelleri zamanÄ±nda ve tam olarak Ã¶demeleri zorunludur.<br>
6) Ãœye/Veli, kendisinin veya misafirlerinin ÅŸahsi kusurlarÄ±, dikkatsizliÄŸi veya ihmalleri ile kulÃ¼be veya 3. kiÅŸilere ait eÅŸyalar Ã¼zerinde meydana getirecekleri tÃ¼m hasar ve zarardan sorumludur.</p>

<p>B) KULÃœP KURALLARI<br>
a) Grup dersleri aylÄ±k 8 derstir.<br>
b) Grup derslerinde ders bir kez iÅŸlendiÄŸinden, Ã¼yenin katÄ±lamadÄ±ÄŸÄ± dersler iÃ§in telafi yapÄ±lmaz.<br>
c) Ã–zel ders paketleri 1 aylÄ±k sÃ¼reyle geÃ§erlidir. Bu sÃ¼re iÃ§inde kullanÄ±lmayan ders haklarÄ± bir sonraki aya devredilmez.<br>
d) Spor branÅŸlarÄ±nda herhangi bir kaza, yaralanma veya saÄŸlÄ±k problemi durumunda sorumluluk tamamen Ãœye/Veliye aittir.<br>
e) Ãœyelerin derse zamanÄ±nda, uygun kÄ±yafetle ve hazÄ±r ÅŸekilde gelmesi Ãœye/Velilerin sorumluluÄŸundadÄ±r.</p>

<p>C) GENEL KURALLAR<br>
1) KulÃ¼p bÃ¼nyesinde Ãœye/Veliler genel nezaket kurallarÄ±na uymakla yÃ¼kÃ¼mlÃ¼dÃ¼rler. Kort iÃ§inde veya dÄ±ÅŸÄ±nda nezaket kurallarÄ±na uymayan davranÄ±ÅŸlarda bulunan, huzuru kaÃ§Ä±ran, hakaret, kÃ¼fÃ¼r kullanan Ãœye/Velilerin Ãœye/Velilikleri herhangi bir uyarÄ±ya gerek kalmadan resen iptal edilebilir.<br>
2) KayÄ±p eÅŸyalardan KulÃ¼p sorumlu deÄŸildir.<br>
3) KulÃ¼p iÃ§ine dÄ±ÅŸarÄ±dan yiyecek iÃ§ecek getirmek yasaktÄ±r.<br>
4) KulÃ¼p sÄ±nÄ±rlarÄ± iÃ§erisinde sigara iÃ§mek yasaktÄ±r.</p>

<p><strong>8-) KÄ°ÅÄ°SEL VERÄ°LERÄ°N Ä°ÅLENMESÄ°</strong><br>
Ãœye/Veli, iÅŸbu sÃ¶zleÅŸmeye taraf olma suretiyle, verdiÄŸi tÃ¼m bilgilerin ve kiÅŸisel verilerinin, KVKK kapsamÄ±nda iÅŸlenmesine aÃ§Ä±kÃ§a rÄ±za gÃ¶sterdiÄŸini kabul eder.</p>

<p><strong>9-) SON HÃœKÃœMLER</strong><br>
1) Bu anlaÅŸmanÄ±n uygulanmasÄ±ndan kaynaklanan tÃ¼m ihtilaflar yerel mahkemeler ve icra dairelerinde Ã§Ã¶zÃ¼lecektir.<br>
2) Ãœye/Veli, adres ve iletiÅŸim bilgilerindeki deÄŸiÅŸiklikleri EÄŸitmene bildirmekle yÃ¼kÃ¼mlÃ¼dÃ¼r.</p>

<p><strong>SÃ¶zleÅŸme Tarihi:</strong> {TARIH}</p>

{OGRENCI_BILGILERI}

<p>ÃœYE/VELÄ° (Otomatik Doldurulur)<br>
AdÄ± SoyadÄ±: {UYE_AD_SOYAD}<br>
Ä°mza: _________________</p>

<p>EÄÄ°TMEN/KULÃœP<br>
AdÄ± SoyadÄ±: <strong>[Buraya yetkili adÄ± soyadÄ±nÄ± yazÄ±n]</strong><br>
Ä°mza: _________________</p>`;
                    document.getElementById('contract-enabled').checked = false;
                }
                
            } catch (error) {
                console.error('Error loading contract template:', error);
                showAlert('SÃ¶zleÅŸme ÅŸablonu yÃ¼klenirken hata oluÅŸtu.', 'danger');
            }
        }
        
        // âœ… SÃ¶zleÅŸme Åablonu Kaydetme
        window.saveContractTemplate = async function(event) {
            event.preventDefault();
            
            const form = event.target;
            const contractText = form.contractText.value.trim();
            const enabled = form.contractEnabled.checked;
            
            if (!contractText) {
                showAlert('LÃ¼tfen sÃ¶zleÅŸme metnini girin.', 'warning');
                return;
            }
            
            try {
                const contractData = {
                    text: contractText,
                    enabled: enabled,
                    clubId: currentClubId,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.fullName || currentUser.email,
                    
                    // Sayfa baÅŸlÄ±klarÄ±
                    pageTitle: form.pageTitle.value.trim(),
                    pageSubtitle: form.pageSubtitle.value.trim(),
                    
                    // Onay checkbox metinleri
                    checkbox1Text: form.checkbox1Text.value.trim(),
                    checkbox2Text: form.checkbox2Text.value.trim(),
                    
                    // KayÄ±t tamamlandÄ± mesajÄ±
                    successTitle: form.successTitle.value.trim(),
                    successMessage: form.successMessage.value.trim()
                };
                
                
                console.log('ğŸ’¾ saveContractTemplate Ã§alÄ±ÅŸtÄ± - Form verileri:', contractData);
                console.log('ğŸ“¦ Mevcut branÅŸlar:', branches);
                
                // Dinamik branÅŸ bazlÄ± IBAN bilgilerini topla
                contractData.branchPayments = {};
                
                branches.forEach(branch => {
                    const branchId = branch.id;
                    console.log(`ğŸ” BranÅŸ iÅŸleniyor: ${branch.name} (ID: ${branchId})`);
                    
                    const ibanInput = document.getElementById(`iban_${branchId}`);
                    const nameInput = document.getElementById(`iban_name_${branchId}`);
                    const instructionsInput = document.getElementById(`payment_instructions_${branchId}`);
                    
                    console.log(`   iban input: ${ibanInput ? 'bulundu âœ…' : 'YOK âŒ'}`);
                    console.log(`   name input: ${nameInput ? 'bulundu âœ…' : 'YOK âŒ'}`);
                    console.log(`   instructions input: ${instructionsInput ? 'bulundu âœ…' : 'YOK âŒ'}`);
                    
                    if (ibanInput || nameInput || instructionsInput) {
                        const ibanValue = ibanInput?.value?.trim() || '';
                        const nameValue = nameInput?.value?.trim() || '';
                        const instructionsValue = instructionsInput?.value?.trim() || '';
                        
                        console.log(`   ğŸ“ DeÄŸerler - IBAN: "${ibanValue}", Name: "${nameValue}", Instructions: "${instructionsValue}"`);
                        
                        if (ibanValue || nameValue || instructionsValue) {
                            contractData.branchPayments[branchId] = {
                                branchName: branch.name,
                                iban: ibanValue,
                                name: nameValue,
                                paymentInstructions: instructionsValue
                            };
                            console.log(`   âœ… BranÅŸ Ã¶deme bilgisi eklendi!`);
                        } else {
                            console.log(`   âš ï¸ TÃ¼m alanlar boÅŸ, eklenmedi`);
                        }
                    } else {
                        console.log(`   âŒ HiÃ§bir input bulunamadÄ±!`);
                    }
                });
                
                console.log('ğŸ’¾ Kaydedilecek branchPayments:', contractData.branchPayments);
                console.log('ğŸ“¤ Kaydedilecek TÃœM contractData:', contractData);
                
                await window.firebase.setDoc(
                    window.firebase.doc(window.db, 'settings', `contract_${currentClubId}`),
                    contractData
                );
                
                showAlert('âœ… SÃ¶zleÅŸme ÅŸablonu baÅŸarÄ±yla kaydedildi! TÃ¼m ayarlarÄ±nÄ±z gÃ¼ncellendi.', 'success');
            } catch (error) {
                console.error('Error saving contract template:', error);
                showAlert('âŒ SÃ¶zleÅŸme ÅŸablonu kaydedilirken hata oluÅŸtu!', 'danger');
            }
        };
        
        
        function switchSettingsTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.settings-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.settings-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(`settings-tab-${tabName}`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Activate button
            event.target.classList.add('active');
            
            // Load data
            switchSettingsTabLoadData(tabName);
        }
        
        // BranÅŸ ÅŸablon tab switching
        window.switchBranchTemplateTab = function(branchName) {
            // Hide all branch template sections
            document.querySelectorAll('.branch-templates-content').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remove active class from all branch tab buttons
            const templatesTabs = document.getElementById('settings-tab-templates');
            if (templatesTabs) {
                templatesTabs.querySelectorAll('.settings-tab').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to clicked button  
                event.target.classList.add('active');
            }
            
            // Show selected branch template section
            const selectedSection = document.getElementById(`branch-templates-${branchName}`);
            if (selectedSection) {
                selectedSection.style.display = 'block';
            }
        };
        
        // Åablon metnini kopyalama fonksiyonu
        window.copyTemplateText = function(textareaId) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) return;
            
            // Textarea'yÄ± seÃ§
            textarea.select();
            textarea.setSelectionRange(0, 99999); // Mobil cihazlar iÃ§in
            
            // Clipboard'a kopyala
            try {
                document.execCommand('copy');
                
                // BaÅŸarÄ±lÄ± bildirim gÃ¶ster
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = 'âœ“';
                button.style.background = '#4CAF50';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '#667eea';
                }, 1500);
            } catch (err) {
                console.error('Kopyalama hatasÄ±:', err);
                alert('Kopyalama baÅŸarÄ±sÄ±z oldu.');
            }
            
            // SeÃ§imi kaldÄ±r
            window.getSelection().removeAllRanges();
        };
        
        // Dinamik branÅŸ ÅŸablonlarÄ±nÄ± render et
        function renderBranchTemplates() {
            const tabsContainer = document.getElementById('branchTemplateTabsContainer');
            const templatesContainer = document.getElementById('dynamicBranchTemplatesContainer');
            
            if (!tabsContainer || !templatesContainer) return;
            
            // BranÅŸ sekmelerini oluÅŸtur
            let tabsHtml = '';
            branches.forEach((branch, index) => {
                tabsHtml += `<button type="button" class="settings-tab ${index === 0 ? 'active' : ''}" onclick="switchBranchTemplateTab('${branch.id}')">${branch.icon} ${branch.name}</button>`;
            });
            tabsHtml += `<button type="button" class="settings-tab" onclick="switchBranchTemplateTab('gorev')">ğŸ“‹ GÃ¶rev ÅablonlarÄ±</button>`;
            tabsContainer.innerHTML = tabsHtml;
            
            // BranÅŸ ÅŸablonlarÄ±nÄ± oluÅŸtur
            let templatesHtml = '';
            
            branches.forEach((branch, index) => {
                const branchId = branch.id;
                const branchName = branch.name;
                const branchIcon = branch.icon;
                
                templatesHtml += `
                    <div id="branch-templates-${branchId}" class="branch-templates-content" style="display: ${index === 0 ? 'block' : 'none'};">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; color: white;">
                            <strong>${branchIcon} ${branchName} BranÅŸÄ±</strong><br>
                            <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">${branchName} branÅŸÄ±ndaki Ã¼yeler iÃ§in mesaj ÅŸablonlarÄ±</p>
                        </div>
                        ${generateTemplateTypes(branchId, branchName)}
                    </div>
                `;
            });
            
            // GÃ¶rev ÅŸablonlarÄ±nÄ± ekle
            templatesHtml += `
                <div id="branch-templates-gorev" class="branch-templates-content" style="display: none;">
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; color: white;">
                        <strong>ğŸ“‹ GÃ¶rev ÅablonlarÄ±</strong><br>
                        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">GÃ¶rev yÃ¶netimi iÃ§in mesaj ÅŸablonlarÄ±</p>
                    </div>
                    ${generateTaskTemplates()}
                </div>
            `;
            
            templatesContainer.innerHTML = templatesHtml;
        }
        
        // Åablon tÃ¼rlerini oluÅŸtur (yatay layout ile)
        function generateTemplateTypes(branchId, branchName) {
            const sportName = branchName === 'Tenis' ? 'TenisÃ§imiz' : branchName === 'YÃ¼zme' ? 'YÃ¼zÃ¼cÃ¼mÃ¼z' : 'Ã–ÄŸrencimiz';
            const templates = [
                {
                    id: 'birthday',
                    icon: 'ğŸ‚',
                    title: 'DoÄŸum GÃ¼nÃ¼ Kutlama',
                    childDefault: `Sevgili {UYE_AD_SOYAD},

${sportName} {OGRENCI_AD_SOYAD}'nÄ±n doÄŸum gÃ¼nÃ¼nÃ¼ en iÃ§ten dileklerimizle kutlar, saÄŸlÄ±k ve mutluluk dolu nice yÄ±llar dileriz! ğŸ‚ğŸ‰

${branchName} ailemizin bir parÃ§asÄ± olduÄŸunuz iÃ§in Ã§ok mutluyuz.

Ä°yi ki doÄŸdun! ğŸˆ`,
                    adultDefault: `Sevgili {UYE_AD_SOYAD},

DoÄŸum gÃ¼nÃ¼nÃ¼zÃ¼ en iÃ§ten dileklerimizle kutlar, saÄŸlÄ±k ve mutluluk dolu nice yÄ±llar dileriz! ğŸ‚ğŸ‰

${branchName} ailemizin bir parÃ§asÄ± olduÄŸunuz iÃ§in Ã§ok mutluyuz.

Ä°yi ki doÄŸdunuz! ğŸˆ`,
                    variables: '{UYE_AD_SOYAD}, {OGRENCI_AD_SOYAD}'
                },
                {
                    id: 'payment',
                    icon: 'ğŸ’°',
                    title: 'GecikmiÅŸ Aidat HatÄ±rlatma',
                    childDefault: `SayÄ±n {UYE_AD_SOYAD},

Velisi olduÄŸunuz {OGRENCI_AD_SOYAD} iÃ§in {TUTAR} TL tutarÄ±ndaki Ã¶demeniz {TARIH} tarihinden beri gecikmiÅŸ durumdadÄ±r.

ğŸ“… DÃ¶nem: {DONEM_BASLANGIC} - {DONEM_BITIS}
ğŸ“š Ders SayÄ±sÄ±: {DERS_SAYISI}

En kÄ±sa sÃ¼rede Ã¶demenizi yapmanÄ±zÄ± rica ederiz.

TeÅŸekkÃ¼r ederiz.
${branchName}`,
                    adultDefault: `SayÄ±n {UYE_AD_SOYAD},

{TUTAR} TL tutarÄ±ndaki Ã¶demeniz {TARIH} tarihinden beri gecikmiÅŸ durumdadÄ±r.

ğŸ“… DÃ¶nem: {DONEM_BASLANGIC} - {DONEM_BITIS}
ğŸ“š Ders SayÄ±sÄ±: {DERS_SAYISI}

En kÄ±sa sÃ¼rede Ã¶demenizi yapmanÄ±zÄ± rica ederiz.

TeÅŸekkÃ¼r ederiz.
${branchName}`,
                    variables: '{UYE_AD_SOYAD}, {OGRENCI_AD_SOYAD}, {TUTAR}, {TARIH}, {DONEM_BASLANGIC}, {DONEM_BITIS}, {DERS_SAYISI}'
                },
                {
                    id: 'absence',
                    icon: 'ğŸ“…',
                    title: 'DevamsÄ±zlÄ±k Bildirimi',
                    childDefault: `SayÄ±n {UYE_AD_SOYAD},

Velisi olduÄŸunuz {OGRENCI_AD_SOYAD}'nÄ±n {TARIH} tarihindeki {DERS} dersine katÄ±lamadÄ±ÄŸÄ±nÄ± fark ettik.

UmarÄ±z her ÅŸey yolundadÄ±r. Herhangi bir sorun varsa bizimle iletiÅŸime geÃ§ebilirsiniz.

GeÃ§miÅŸ olsun.
${branchName}`,
                    adultDefault: `SayÄ±n {UYE_AD_SOYAD},

{TARIH} tarihindeki {DERS} dersine katÄ±lamadÄ±ÄŸÄ±nÄ±zÄ± fark ettik.

UmarÄ±z her ÅŸey yolundadÄ±r. Herhangi bir sorun varsa bizimle iletiÅŸime geÃ§ebilirsiniz.

GeÃ§miÅŸ olsun.
${branchName}`,
                    variables: '{UYE_AD_SOYAD}, {OGRENCI_AD_SOYAD}, {TARIH}, {DERS}'
                },
                {
                    id: 'announcement',
                    icon: 'ğŸ“¢',
                    title: 'Genel Duyuru',
                    childDefault: `SayÄ±n {UYE_AD_SOYAD},

Velisi olduÄŸunuz {OGRENCI_AD_SOYAD} ile ilgili kulÃ¼bÃ¼mÃ¼zden Ã¶nemli bir duyuru:

{MESAJ}

Bilgilerinize sunarÄ±z.
${branchName}`,
                    adultDefault: `SayÄ±n {UYE_AD_SOYAD},

KulÃ¼bÃ¼mÃ¼zden Ã¶nemli bir duyuru:

{MESAJ}

Bilgilerinize sunarÄ±z.
${branchName}`,
                    variables: '{UYE_AD_SOYAD}, {OGRENCI_AD_SOYAD}, {MESAJ}'
                },
                {
                    id: 'upcomingPayment',
                    icon: 'â°',
                    title: 'YaklaÅŸan Ã–deme HatÄ±rlatma',
                    childDefault: `SayÄ±n {UYE_AD_SOYAD},

Velisi olduÄŸunuz {OGRENCI_AD_SOYAD} iÃ§in {TARIH} tarihinde {TUTAR} TL tutarÄ±nda Ã¶demeniz bulunmaktadÄ±r. ({GUN_KALDI} gÃ¼n kaldÄ±)

ğŸ“… DÃ¶nem: {DONEM_BASLANGIC} - {DONEM_BITIS}
ğŸ“š Ders SayÄ±sÄ±: {DERS_SAYISI}

ZamanÄ±nda Ã¶demenizi hatÄ±rlatmak isteriz.

TeÅŸekkÃ¼r ederiz.
${branchName}`,
                    adultDefault: `SayÄ±n {UYE_AD_SOYAD},

{TARIH} tarihinde {TUTAR} TL tutarÄ±nda Ã¶demeniz bulunmaktadÄ±r. ({GUN_KALDI} gÃ¼n kaldÄ±)

ğŸ“… DÃ¶nem: {DONEM_BASLANGIC} - {DONEM_BITIS}
ğŸ“š Ders SayÄ±sÄ±: {DERS_SAYISI}

ZamanÄ±nda Ã¶demenizi hatÄ±rlatmak isteriz.

TeÅŸekkÃ¼r ederiz.
${branchName}`,
                    variables: '{UYE_AD_SOYAD}, {OGRENCI_AD_SOYAD}, {TUTAR}, {TARIH}, {GUN_KALDI}, {DONEM_BASLANGIC}, {DONEM_BITIS}, {DERS_SAYISI}'
                },
                {
                    id: 'pendingRegistration',
                    icon: 'â³',
                    title: 'Bekleyen KayÄ±t HatÄ±rlatma',
                    childDefault: `SayÄ±n {UYE_AD_SOYAD},

KulÃ¼bÃ¼mÃ¼ze {OGRENCI_AD_SOYAD} iÃ§in Ã¶n kaydÄ±nÄ±z alÄ±nmÄ±ÅŸtÄ±r. ğŸ‰

Ancak kayÄ±t iÅŸlemleriniz henÃ¼z tamamlanmamÄ±ÅŸtÄ±r. KayÄ±t formunuz hazÄ±rlanmÄ±ÅŸtÄ±r.

KaydÄ±nÄ±zÄ± tamamlamak iÃ§in lÃ¼tfen aÅŸaÄŸÄ±daki linke tÄ±klayÄ±n:
{LINK}

SorularÄ±nÄ±z iÃ§in bize ulaÅŸabilirsiniz.

TeÅŸekkÃ¼r ederiz.
${branchName}`,
                    adultDefault: `SayÄ±n {UYE_AD_SOYAD},

KulÃ¼bÃ¼mÃ¼ze Ã¶n kaydÄ±nÄ±z alÄ±nmÄ±ÅŸtÄ±r. ğŸ‰

Ancak kayÄ±t iÅŸlemleriniz henÃ¼z tamamlanmamÄ±ÅŸtÄ±r. KayÄ±t formunuz hazÄ±rlanmÄ±ÅŸtÄ±r.

KaydÄ±nÄ±zÄ± tamamlamak iÃ§in lÃ¼tfen aÅŸaÄŸÄ±daki linke tÄ±klayÄ±n:
{LINK}

SorularÄ±nÄ±z iÃ§in bize ulaÅŸabilirsiniz.

TeÅŸekkÃ¼r ederiz.
${branchName}`,
                    variables: '{UYE_AD_SOYAD}, {OGRENCI_AD_SOYAD}, {LINK}, {TARIH}'
                },
                {
                    id: 'trialReminder',
                    icon: 'ğŸ¯',
                    title: 'Deneme Dersi HatÄ±rlatma',
                    childDefault: `Merhaba {UYE_AD_SOYAD},

${branchIcon} ${branchName} deneme dersiniz iÃ§in sizi bekliyoruz!

ğŸ“… Tarih: {TARIH}
ğŸ• Saat: {SAAT}
ğŸ“ Adres: {ADRES}

YanÄ±nÄ±zda spor kÄ±yafeti ve iÃ§ecek getirmeyi unutmayÄ±n.

GÃ¶rÃ¼ÅŸmek Ã¼zere!
{KULUP_ADI}`,
                    adultDefault: `Merhaba {UYE_AD_SOYAD},

${branchIcon} ${branchName} deneme dersiniz iÃ§in sizi bekliyoruz!

ğŸ“… Tarih: {TARIH}
ğŸ• Saat: {SAAT}
ğŸ“ Adres: {ADRES}

YanÄ±nÄ±zda spor kÄ±yafeti ve iÃ§ecek getirmeyi unutmayÄ±n.

GÃ¶rÃ¼ÅŸmek Ã¼zere!
{KULUP_ADI}`,
                    variables: '{UYE_AD_SOYAD}, {TARIH}, {SAAT}, {ADRES}, {KULUP_ADI}'
                }
            ];
            
            let html = '';
            templates.forEach(template => {
                html += `
                    <div class="settings-subsection" style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
                        <h4 class="settings-subtitle">${template.icon} ${template.title}</h4>
                        
                        <!-- Yatay Layout: Ã‡ocuk ve YetiÅŸkin Yan Yana -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                            <!-- Ã‡ocuk Ãœyeler -->
                            <div style="border-left: 4px solid #4CAF50; padding-left: 10px;">
                                <label style="font-weight: 600; color: #4CAF50; margin-bottom: 8px; display: block;">ğŸ‘¶ Ã‡ocuk Ãœyeler (Veliye gÃ¶nderilir)</label>
                                <div style="position: relative;">
                                    <textarea 
                                        id="template-${branchId}-${template.id}-child" 
                                        name="${branchId}_${template.id}Child" 
                                        class="form-control" 
                                        rows="6" 
                                        style="width: 100%; padding: 8px; padding-right: 45px; resize: vertical; min-height: 120px; box-sizing: border-box;"
                                    >${template.childDefault || ''}</textarea>
                                    <button type="button" onclick="copyTemplateText('template-${branchId}-${template.id}-child')" style="position: absolute; top: 8px; right: 8px; padding: 4px 8px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;" title="Kopyala">ğŸ“‹</button>
                                </div>
                            </div>
                            
                            <!-- YetiÅŸkin Ãœyeler -->
                            <div style="border-left: 4px solid #2196F3; padding-left: 10px;">
                                <label style="font-weight: 600; color: #2196F3; margin-bottom: 8px; display: block;">ğŸ‘¤ YetiÅŸkin Ãœyeler</label>
                                <div style="position: relative;">
                                    <textarea 
                                        id="template-${branchId}-${template.id}-adult" 
                                        name="${branchId}_${template.id}Adult" 
                                        class="form-control" 
                                        rows="6" 
                                        style="width: 100%; padding: 8px; padding-right: 45px; resize: vertical; min-height: 120px; box-sizing: border-box;"
                                    >${template.adultDefault || ''}</textarea>
                                    <button type="button" onclick="copyTemplateText('template-${branchId}-${template.id}-adult')" style="position: absolute; top: 8px; right: 8px; padding: 4px 8px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;" title="Kopyala">ğŸ“‹</button>
                                </div>
                            </div>
                        </div>
                        
                        <small style="color: #666; display: block; margin-bottom: 10px;">KullanÄ±labilir deÄŸiÅŸkenler: <code>${template.variables}</code></small>
                        
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="${branchId}-${template.id}-enabled" name="${branchId}_${template.id}Enabled" style="width: auto;">
                            <label for="${branchId}-${template.id}-enabled" style="margin: 0;">Bu ÅŸablonu etkinleÅŸtir</label>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        // GÃ¶rev ÅŸablonlarÄ±nÄ± oluÅŸtur
        function generateTaskTemplates() {
            return `
                <div class="settings-subsection" style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
                    <h4 class="settings-subtitle">ğŸ“‹ GÃ¶rev Bildirimi Åablonu</h4>
                    <div style="position: relative; margin-bottom: 15px;">
                        <textarea id="template-task" name="task" class="form-control" rows="6" style="width: 100%; padding: 8px; padding-right: 45px; resize: vertical; min-height: 120px; box-sizing: border-box;">SayÄ±n {UYE_AD_SOYAD},

Size yeni bir gÃ¶rev atandÄ±:

ğŸ“‹ GÃ¶rev: {GOREV}
ğŸ“ AÃ§Ä±klama: {ACIKLAMA}
ğŸ“… Tarih: {TARIH}

Ä°yi Ã§alÄ±ÅŸmalar dileriz.</textarea>
                        <button type="button" onclick="copyTemplateText('template-task')" style="position: absolute; top: 8px; right: 8px; padding: 4px 8px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;" title="Kopyala">ğŸ“‹</button>
                    </div>
                    <small style="color: #666; display: block; margin-bottom: 10px;">KullanÄ±labilir deÄŸiÅŸkenler: <code>{UYE_AD_SOYAD}, {GOREV}, {ACIKLAMA}, {TARIH}</code></small>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="task-enabled" name="taskEnabled" style="width: auto;">
                        <label for="task-enabled" style="margin: 0;">GÃ¶rev atandÄ±ÄŸÄ±nda otomatik mesaj gÃ¶nder</label>
                    </div>
                </div>
                
                <div class="settings-subsection" style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
                    <h4 class="settings-subtitle">â° GÃ¶rev HatÄ±rlatma Åablonu</h4>
                    <div style="position: relative; margin-bottom: 15px;">
                        <textarea id="template-taskReminder" name="taskReminder" class="form-control" rows="6" style="width: 100%; padding: 8px; padding-right: 45px; resize: vertical; min-height: 120px; box-sizing: border-box;">SayÄ±n {UYE_AD_SOYAD},

"{GOREV}" gÃ¶revi iÃ§in hatÄ±rlatma:

ğŸ“‹ GÃ¶rev: {GOREV}

ğŸ“ AÃ§Ä±klama: {ACIKLAMA}

GÃ¶revin tamamlanmasÄ±nÄ± bekliyoruz.

Ä°yi Ã§alÄ±ÅŸmalar dileriz.</textarea>
                        <button type="button" onclick="copyTemplateText('template-taskReminder')" style="position: absolute; top: 8px; right: 8px; padding: 4px 8px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;" title="Kopyala">ğŸ“‹</button>
                    </div>
                    <small style="color: #666; display: block; margin-bottom: 10px;">KullanÄ±labilir deÄŸiÅŸkenler: <code>{UYE_AD_SOYAD}, {GOREV}, {ACIKLAMA}, {TARIH}, {GUN_KALDI}</code></small>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="taskReminder-enabled" name="taskReminderEnabled" style="width: auto;">
                        <label for="taskReminder-enabled" style="margin: 0;">GÃ¶rev hatÄ±rlatmasÄ± iÃ§in otomatik mesaj gÃ¶nder</label>
                    </div>
                </div>
                
                <div class="settings-subsection" style="margin-bottom: 30px;">
                    <h4 class="settings-subtitle">ğŸ’¬ GÃ¶rev MesajÄ± Bildirimi Åablonu</h4>
                    <div style="position: relative; margin-bottom: 15px;">
                        <textarea id="template-taskMessage" name="taskMessage" class="form-control" rows="6" style="width: 100%; padding: 8px; padding-right: 45px; resize: vertical; min-height: 120px; box-sizing: border-box;">SayÄ±n {UYE_AD_SOYAD},

"{GOREV}" gÃ¶revi iÃ§in yeni bir mesaj aldÄ±nÄ±z:

ğŸ’¬ {MESAJ}
ğŸ“¤ GÃ¶nderen: {GONDEREN}
ğŸ“… Tarih: {TARIH}

GÃ¶rev detaylarÄ±nÄ± kontrol ediniz.</textarea>
                        <button type="button" onclick="copyTemplateText('template-taskMessage')" style="position: absolute; top: 8px; right: 8px; padding: 4px 8px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;" title="Kopyala">ğŸ“‹</button>
                    </div>
                    <small style="color: #666; display: block; margin-bottom: 10px;">KullanÄ±labilir deÄŸiÅŸkenler: <code>{UYE_AD_SOYAD}, {GOREV}, {MESAJ}, {GONDEREN}, {TARIH}</code></small>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="taskMessage-enabled" name="taskMessageEnabled" style="width: auto;">
                        <label for="taskMessage-enabled" style="margin: 0;">GÃ¶rev mesajÄ± eklendiÄŸinde otomatik bildirim gÃ¶nder</label>
                    </div>
                </div>
            `;
        }
        
        function switchSettingsTabLoadData(tabName) {
            // Load data when switching tabs
            if (tabName === 'club') {
                loadClubInfo();
            } else if (tabName === 'contract') {
                loadContractTemplate();
            } else if (tabName === 'templates') {
                // Render dynamic branch templates
                renderBranchTemplates();
                // Load template data
                loadMessageTemplates();
            } else if (tabName === 'webhook') {
                loadWebhookSettings();
            } else if (tabName === 'general') {
                loadWhatsAppSettings(); // Bulutfon ve diÄŸer genel ayarlarÄ± yÃ¼kle
            }
            
            // Load WhatsApp instances if switching to WhatsApp tab
            if (tabName === 'whatsapp') {
                loadWhatsAppInstances();
            }
            
            // Load message templates if switching to templates tab
            if (tabName === 'templates') {
                loadMessageTemplates();
            }
            
            // Load branches when switching to branches tab
            if (tabName === 'branches') {
                renderBranchesTable();
            }
            
            // Load users when switching to users tab
            if (tabName === 'users') {
                renderUsersTable();
            }
        }
        
        // --- MESSAGE TEMPLATES FUNCTIONS ---
        let messageTemplates = {};
        
        async function loadMessageTemplates() {
            try {
                // Ã–nce branÅŸ bazlÄ± ÅŸablonlarÄ± dene
                const branchTemplatesDoc = await window.firebase.getDoc(
                    window.firebase.doc(window.db, 'settings', `messageTemplates_${currentClubId}`)
                );
                
                if (branchTemplatesDoc.exists()) {
                    messageTemplates = branchTemplatesDoc.data();
                } else {
                    // Eski yapÄ±yÄ± kontrol et
                    const oldTemplatesDoc = await window.firebase.getDoc(
                        window.firebase.doc(window.db, 'settings', 'messageTemplates')
                    );
                    
                    if (oldTemplatesDoc.exists()) {
                        messageTemplates = oldTemplatesDoc.data();
                    } else {
                    // Default templates - varsayÄ±lan oluÅŸtur ve kaydet
                    messageTemplates = {
                        birthday: {
                            textChild: 'SayÄ±n {UYE_AD_SOYAD},\n\nVelisi olduÄŸunuz {OGRENCI_AD_SOYAD}\'nÄ±n doÄŸum gÃ¼nÃ¼nÃ¼ en iÃ§ten dileklerimizle kutlar, saÄŸlÄ±k ve mutluluk dolu nice yÄ±llar dileriz! ğŸ‰ğŸ‚\n\nSizinle birlikte olmaktan mutluluk duyuyoruz.',
                            textAdult: 'SayÄ±n {UYE_AD_SOYAD},\n\nDoÄŸum gÃ¼nÃ¼nÃ¼zÃ¼ en iÃ§ten dileklerimizle kutlar, saÄŸlÄ±k ve mutluluk dolu nice yÄ±llar dileriz! ğŸ‰ğŸ‚\n\nSizinle birlikte olmaktan mutluluk duyuyoruz.',
                            text: 'SayÄ±n {UYE_AD_SOYAD}, DoÄŸum gÃ¼nÃ¼nÃ¼zÃ¼ kutlarÄ±z!',
                            enabled: false
                        },
                        payment: {
                            textChild: 'SayÄ±n {UYE_AD_SOYAD},\n\nVelisi olduÄŸunuz {OGRENCI_AD_SOYAD} iÃ§in {TUTAR} TL tutarÄ±ndaki Ã¶demeniz {TARIH} tarihinden beri gecikmiÅŸ durumdadÄ±r.\n\nğŸ“… DÃ¶nem: {DONEM_BASLANGIC} - {DONEM_BITIS}\nğŸ“š Ders SayÄ±sÄ±: {DERS_SAYISI}\n\nEn kÄ±sa sÃ¼rede Ã¶demenizi yapmanÄ±zÄ± rica ederiz.\n\nTeÅŸekkÃ¼r ederiz.',
                            textAdult: 'SayÄ±n {UYE_AD_SOYAD},\n\n{TUTAR} TL tutarÄ±ndaki Ã¶demeniz {TARIH} tarihinden beri gecikmiÅŸ durumdadÄ±r.\n\nğŸ“… DÃ¶nem: {DONEM_BASLANGIC} - {DONEM_BITIS}\nğŸ“š Ders SayÄ±sÄ±: {DERS_SAYISI}\n\nEn kÄ±sa sÃ¼rede Ã¶demenizi yapmanÄ±zÄ± rica ederiz.\n\nTeÅŸekkÃ¼r ederiz.',
                            text: 'SayÄ±n {UYE_AD_SOYAD}, Ã¶demeniz gecikmiÅŸtir.',
                            enabled: false
                        },
                        absence: {
                            textChild: 'SayÄ±n {UYE_AD_SOYAD},\n\nVelisi olduÄŸunuz {OGRENCI_AD_SOYAD}\'nÄ±n {TARIH} tarihindeki {DERS} dersine katÄ±lamadÄ±ÄŸÄ±nÄ± fark ettik.\n\nUmarÄ±z her ÅŸey yolundadÄ±r. Herhangi bir sorun varsa bizimle iletiÅŸime geÃ§ebilirsiniz.\n\nGeÃ§miÅŸ olsun.',
                            textAdult: 'SayÄ±n {UYE_AD_SOYAD},\n\n{TARIH} tarihindeki {DERS} dersine katÄ±lamadÄ±ÄŸÄ±nÄ±zÄ± fark ettik.\n\nUmarÄ±z her ÅŸey yolundadÄ±r. Herhangi bir sorun varsa bizimle iletiÅŸime geÃ§ebilirsiniz.\n\nGeÃ§miÅŸ olsun.',
                            text: 'DevamsÄ±zlÄ±k bildirimi',
                            enabled: false
                        },
                        announcement: {
                            textChild: 'SayÄ±n {UYE_AD_SOYAD},\n\nVelisi olduÄŸunuz {OGRENCI_AD_SOYAD} ile ilgili kulÃ¼bÃ¼mÃ¼zden Ã¶nemli bir duyuru:\n\n{MESAJ}\n\nBilgilerinize sunarÄ±z.',
                            textAdult: 'SayÄ±n {UYE_AD_SOYAD},\n\nKulÃ¼bÃ¼mÃ¼zden Ã¶nemli bir duyuru:\n\n{MESAJ}\n\nBilgilerinize sunarÄ±z.',
                            text: 'Duyuru',
                            enabled: false
                        },
                        task: {
                            text: 'SayÄ±n {UYE_AD_SOYAD},\n\nSize yeni bir gÃ¶rev atandÄ±:\n\nğŸ“‹ GÃ¶rev: {GOREV}\nğŸ“ AÃ§Ä±klama: {ACIKLAMA}\nğŸ“… Tarih: {TARIH}\n\nÄ°yi Ã§alÄ±ÅŸmalar dileriz.',
                            enabled: false
                        },
                        taskReminder: {
                            text: 'SayÄ±n {UYE_AD_SOYAD},\n\n"{GOREV}" gÃ¶revi iÃ§in hatÄ±rlatma:\n\nğŸ“‹ GÃ¶rev: {GOREV}\n\nğŸ“ AÃ§Ä±klama: {ACIKLAMA}\n\nGÃ¶revin tamamlanmasÄ±nÄ± bekliyoruz.\n\nÄ°yi Ã§alÄ±ÅŸmalar dileriz.',
                            enabled: false
                        },
                        upcomingPayment: {
                            textChild: 'SayÄ±n {UYE_AD_SOYAD},\n\nVelisi olduÄŸunuz {OGRENCI_AD_SOYAD} iÃ§in {TARIH} tarihinde {TUTAR} TL tutarÄ±nda Ã¶demeniz bulunmaktadÄ±r. ({GUN_KALDI} gÃ¼n kaldÄ±)\n\nğŸ“… DÃ¶nem: {DONEM_BASLANGIC} - {DONEM_BITIS}\nğŸ“š Ders SayÄ±sÄ±: {DERS_SAYISI}\n\nZamanÄ±nda Ã¶demenizi hatÄ±rlatmak isteriz.\n\nTeÅŸekkÃ¼r ederiz.',
                            textAdult: 'SayÄ±n {UYE_AD_SOYAD},\n\n{TARIH} tarihinde {TUTAR} TL tutarÄ±nda Ã¶demeniz bulunmaktadÄ±r. ({GUN_KALDI} gÃ¼n kaldÄ±)\n\nğŸ“… DÃ¶nem: {DONEM_BASLANGIC} - {DONEM_BITIS}\nğŸ“š Ders SayÄ±sÄ±: {DERS_SAYISI}\n\nZamanÄ±nda Ã¶demenizi hatÄ±rlatmak isteriz.\n\nTeÅŸekkÃ¼r ederiz.',
                            text: 'YaklaÅŸan Ã¶deme',
                            enabled: false
                        },
                        taskMessage: {
                            text: 'SayÄ±n {UYE_AD_SOYAD},\n\n"{GOREV}" gÃ¶revi iÃ§in yeni bir mesaj aldÄ±nÄ±z:\n\nğŸ’¬ {MESAJ}\nğŸ“¤ GÃ¶nderen: {GONDEREN}\nğŸ“… Tarih: {TARIH}\n\nGÃ¶rev detaylarÄ±nÄ± kontrol ediniz.',
                            enabled: false
                        },
                        pendingRegistration: {
                            textChild: 'SayÄ±n {UYE_AD_SOYAD},\n\nKulÃ¼bÃ¼mÃ¼ze {OGRENCI_AD_SOYAD} iÃ§in Ã¶n kaydÄ±nÄ±z alÄ±nmÄ±ÅŸtÄ±r. ğŸ‰\n\nAncak kayÄ±t iÅŸlemleriniz henÃ¼z tamamlanmamÄ±ÅŸtÄ±r. KayÄ±t formunuz hazÄ±rlanmÄ±ÅŸtÄ±r.\n\nKaydÄ±nÄ±zÄ± tamamlamak iÃ§in lÃ¼tfen aÅŸaÄŸÄ±daki linke tÄ±klayÄ±n:\n{LINK}\n\nSorularÄ±nÄ±z iÃ§in bize ulaÅŸabilirsiniz.\n\nTeÅŸekkÃ¼r ederiz.',
                            textAdult: 'SayÄ±n {UYE_AD_SOYAD},\n\nKulÃ¼bÃ¼mÃ¼ze Ã¶n kaydÄ±nÄ±z alÄ±nmÄ±ÅŸtÄ±r. ğŸ‰\n\nAncak kayÄ±t iÅŸlemleriniz henÃ¼z tamamlanmamÄ±ÅŸtÄ±r. KayÄ±t formunuz hazÄ±rlanmÄ±ÅŸtÄ±r.\n\nKaydÄ±nÄ±zÄ± tamamlamak iÃ§in lÃ¼tfen aÅŸaÄŸÄ±daki linke tÄ±klayÄ±n:\n{LINK}\n\nSorularÄ±nÄ±z iÃ§in bize ulaÅŸabilirsiniz.\n\nTeÅŸekkÃ¼r ederiz.',
                            text: 'SayÄ±n {UYE_AD_SOYAD}, KayÄ±t hatÄ±rlatma',
                            enabled: false
                        }
                    };
                    
                    // âœ… VarsayÄ±lan ÅŸablonlarÄ± veritabanÄ±na kaydet
                    await window.firebase.setDoc(
                        window.firebase.doc(window.db, 'settings', `messageTemplates_${currentClubId}`),
                        { ...messageTemplates, clubId: currentClubId }
                    );
                    console.log('âœ… Message templates settings oluÅŸturuldu');
                }
                }
                
                // Fill form with templates - Dinamik branÅŸ ÅŸablonlarÄ± iÃ§in
                const templateTypes = ['birthday', 'payment', 'absence', 'announcement', 'upcomingPayment', 'pendingRegistration', 'trialReminder', 'registrationComplete'];
                
                branches.forEach(branch => {
                    templateTypes.forEach(templateType => {
                        const branchTemplates = messageTemplates[branch.id];
                        const childElem = document.getElementById(`template-${branch.id}-${templateType}-child`);
                        const adultElem = document.getElementById(`template-${branch.id}-${templateType}-adult`);
                        const enabledElem = document.getElementById(`${branch.id}-${templateType}-enabled`);
                        
                        // EÄŸer veritabanÄ±nda kayÄ±tlÄ± deÄŸer varsa onu kullan
                        if (childElem && branchTemplates?.[templateType]?.textChild) {
                            childElem.value = branchTemplates[templateType].textChild;
                        }
                        // DeÄŸilse default deÄŸer zaten textarea iÃ§inde var
                        
                        if (adultElem && branchTemplates?.[templateType]?.textAdult) {
                            adultElem.value = branchTemplates[templateType].textAdult;
                        }
                        
                        if (enabledElem) {
                            enabledElem.checked = branchTemplates?.[templateType]?.enabled || false;
                        }
                    });
                });
                
                // GÃ¶rev ÅŸablonlarÄ± (BranÅŸ baÄŸÄ±msÄ±z)
                const taskElem = document.getElementById('template-task');
                const taskEnabledElem = document.getElementById('task-enabled');
                if (taskElem && messageTemplates.task?.text) {
                    taskElem.value = messageTemplates.task.text;
                }
                if (taskEnabledElem) {
                    taskEnabledElem.checked = messageTemplates.task?.enabled || false;
                }
                
                const taskReminderElem = document.getElementById('template-taskReminder');
                const taskReminderEnabledElem = document.getElementById('taskReminder-enabled');
                if (taskReminderElem && messageTemplates.taskReminder?.text) {
                    taskReminderElem.value = messageTemplates.taskReminder.text;
                }
                if (taskReminderEnabledElem) {
                    taskReminderEnabledElem.checked = messageTemplates.taskReminder?.enabled || false;
                }
                
                const taskMessageElem = document.getElementById('template-taskMessage');
                const taskMessageEnabledElem = document.getElementById('taskMessage-enabled');
                if (taskMessageElem && messageTemplates.taskMessage?.text) {
                    taskMessageElem.value = messageTemplates.taskMessage.text;
                }
                if (taskMessageEnabledElem) {
                    taskMessageEnabledElem.checked = messageTemplates.taskMessage?.enabled || false;
                }
                
            } catch (error) {
                showAlert('Åablonlar yÃ¼klenirken hata oluÅŸtu.', 'danger');
            }
        }
        
        window.saveMessageTemplates = async function(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            const templates = {
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser?.email || 'admin'
            };
            
            // Her branÅŸ iÃ§in ÅŸablonlarÄ± kaydet
            const templateTypes = ['birthday', 'payment', 'absence', 'announcement', 'upcomingPayment', 'pendingRegistration', 'trialReminder', 'registrationComplete'];
            
            branches.forEach(branch => {
                const branchId = branch.id;
                templates[branchId] = {};
                
                templateTypes.forEach(templateType => {
                    const childKey = `${branchId}_${templateType}Child`;
                    const adultKey = `${branchId}_${templateType}Adult`;
                    const enabledKey = `${branchId}_${templateType}Enabled`;
                    
                    const childValue = formData.get(childKey);
                    const adultValue = formData.get(adultKey);
                    const enabledValue = formData.get(enabledKey);
                    
                    templates[branchId][templateType] = {
                        textChild: childValue ? childValue.trim() : '',
                        textAdult: adultValue ? adultValue.trim() : '',
                        text: childValue ? childValue.trim() : '', // Backward compatibility
                        enabled: enabledValue === 'on'
                    };
                });
            });
            
            // GÃ¶rev ÅŸablonlarÄ± (branÅŸ baÄŸÄ±msÄ±z)
            templates.task = {
                text: formData.get('task') ? formData.get('task').trim() : '',
                enabled: formData.get('taskEnabled') === 'on'
            };
            
            templates.taskReminder = {
                text: formData.get('taskReminder') ? formData.get('taskReminder').trim() : '',
                enabled: formData.get('taskReminderEnabled') === 'on'
            };
            
            templates.taskMessage = {
                text: formData.get('taskMessage') ? formData.get('taskMessage').trim() : '',
                enabled: formData.get('taskMessageEnabled') === 'on'
            };
            
            try {
                await window.firebase.setDoc(
                    window.firebase.doc(window.db, 'settings', `messageTemplates_${currentClubId}`),
                    templates
                );
                
                messageTemplates = templates;
                showAlert('âœ… Åablonlar baÅŸarÄ±yla kaydedildi!', 'success');
            } catch (error) {
                console.error('Åablon kaydetme hatasÄ±:', error);
                showAlert('âŒ Åablonlar kaydedilirken hata oluÅŸtu.', 'danger');
            }
        };
        
        // --- WHATSAPP EVOLUTION API FUNCTIONS ---
        const EVOLUTION_API_URL = "https://evo-2.edu-ai.online";
        const EVOLUTION_API_KEY = "iHAF8gWNA1axdRDY9e98UKpork00dBO2";
        
        // WhatsApp Header Actions
        
        window.searchInMessages = function() {
            if (!currentWhatsAppContact) return;
            const searchTerm = prompt('ğŸ” Mesajlarda ara:', '');
            if (!searchTerm) return;
            
            // TODO: Implement message search
            showAlert(`"${searchTerm}" aranÄ±yor...\n\n(Arama Ã¶zelliÄŸi yakÄ±nda eklenecek)`, 'info');
        };
        
        window.showContactInfo = function() {
            if (!currentWhatsAppContact) return;
            
            const contact = currentWhatsAppContact;
            const phone = formatPhoneDisplay(contact.phone);
            
            let info = `ğŸ‘¤ ${contact.name}\nğŸ“± ${phone}\n`;
            
            if (contact.type === 'member') {
                info += `\nâœ… Bu kiÅŸi kayÄ±tlÄ± bir Ã¼yedir`;
                if (contact.memberId) {
                    setTimeout(() => {
                        showMemberAttendancePage(contact.memberId);
                    }, 500);
                }
            } else if (contact.type === 'crm') {
                info += `\nğŸ“‹ Bu kiÅŸi CRM kaydÄ±nda`;
                if (contact.leadId) {
                    setTimeout(() => {
                        openCrmLeadDetail(contact.leadId);
                    }, 500);
                }
            } else {
                info += `\nâ• Bu kiÅŸi henÃ¼z kayÄ±tlÄ± deÄŸil`;
            }
            
            showAlert(info, 'info');
        };
        
        window.showMoreOptions = function() {
            if (!currentWhatsAppContact) return;
            
            const options = [
                'ğŸ“‹ KiÅŸi Bilgileri',
                'ğŸ”„ Sohbeti Yenile',
                'ğŸ—‘ï¸ Sohbeti Temizle',
                'ğŸ”‡ Bildirimleri Kapat',
                'â­ Favori Olarak Ä°ÅŸaretle'
            ];
            
            showAlert('Daha fazla seÃ§enek:\n\n' + options.join('\n') + '\n\n(Ã–zellikler yakÄ±nda eklenecek)', 'info');
        };
        
        // ğŸ§ª Debug sent messages
        window.debugSentMessages = function(phone) {
            const normalizedPhone = formatPhoneForWhatsApp(phone || currentWhatsAppContact?.phone);
            
            console.log('ğŸ” DEBUG SENT MESSAGES');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸ“± Aranan telefon:', phone || currentWhatsAppContact?.phone);
            console.log('ğŸ“± Normalize edilmiÅŸ:', normalizedPhone);
            console.log('ğŸ”§ SeÃ§ili cihaz:', selectedWhatsAppDevice?.instanceName);
            console.log('ğŸ“¦ Toplam sentMessages:', sentMessages.length);
            console.log('');
            
            if (sentMessages.length > 0) {
                console.log('ğŸ“ Ä°lk 5 mesaj:');
                sentMessages.slice(0, 5).forEach((m, i) => {
                    const recipientNormalized = formatPhoneForWhatsApp(m.recipientPhone || '');
                    const phoneMatch = recipientNormalized === normalizedPhone;
                    const instanceMatch = m.instanceName === selectedWhatsAppDevice?.instanceName;
                    
                    console.log(`\n${i + 1}. Mesaj:`);
                    console.log('   recipientPhone:', m.recipientPhone);
                    console.log('   normalized:', recipientNormalized);
                    console.log('   instanceName:', m.instanceName);
                    console.log('   message:', m.message?.substring(0, 50));
                    console.log('   sentAt:', m.sentAt);
                    console.log('   âœ“ Phone match:', phoneMatch);
                    console.log('   âœ“ Instance match:', instanceMatch);
                    console.log('   âœ“ WOULD SHOW:', phoneMatch && instanceMatch);
                });
            }
            
            // Åimdi filtrelemeyi test et
            const filtered = sentMessages.filter(m => {
                const recipientNormalized = formatPhoneForWhatsApp(m.recipientPhone || '');
                return recipientNormalized === normalizedPhone && 
                       m.instanceName === selectedWhatsAppDevice?.instanceName;
            });
            
            console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log(`âœ… EÅŸleÅŸen mesaj sayÄ±sÄ±: ${filtered.length}`);
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
            
            return filtered;
        };
        
        
        
        async function handleWhatsAppInstanceCreate(e) {
            e.preventDefault();
            const form = e.target;
            const instanceName = form.instanceName.value.trim();
            const phoneNumber = document.getElementById('newInstancePhone').value.trim();
            
            // âœ… Sabit API deÄŸerleri kullanÄ±lÄ±yor
            const evolutionUrl = EVOLUTION_API_URL;
            const apiKey = EVOLUTION_API_KEY;
            
            if (!instanceName) {
                return showAlert('Cihaz adÄ± zorunludur.', 'warning');
            }
            
            if (!phoneNumber) {
                return showAlert('Telefon numarasÄ± zorunludur.', 'warning');
            }
            
            // Show loading state
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'â³ Cihaz oluÅŸturuluyor...';
            
            try {
                // Create instance via Evolution API (using user-provided URL and API Key)
                const response = await fetch(`${evolutionUrl}/instance/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': apiKey
                    },
                    body: JSON.stringify({
                        instanceName: instanceName,
                        number: phoneNumber,
                        owner: phoneNumber,
                        qrcode: true,
                        integration: "WHATSAPP-BAILEYS",
                        // âœ… Webhook event'lerini ekle (mesajlar ve Ã§aÄŸrÄ±lar iÃ§in)
                        webhook: {
                            enabled: true,
                            url: clubSettings?.evolutionWebhookUrl || '', // Webhook URL'i ayarlardan Ã§ek
                            events: [
                                "MESSAGES_UPSERT",
                                "MESSAGES_UPDATE",
                                "MESSAGES_DELETE",
                                "SEND_MESSAGE",
                                "CALL_UPSERT",       // âœ… Ã‡aÄŸrÄ± event'i
                                "CALL_OFFER",        // âœ… Ã‡aÄŸrÄ± teklifi
                                "CALL_REJECT",       // âœ… Ã‡aÄŸrÄ± reddi
                                "CALL_ACCEPT"        // âœ… Ã‡aÄŸrÄ± kabul
                            ],
                            webhookByEvents: false,
                            webhookBase64: false
                        }
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Save to Firebase with Evolution URL and API Key
                    const deviceData = {
                        instanceName: instanceName,
                        phoneNumber: phoneNumber,
                        evolutionUrl: evolutionUrl,
                        apiKey: apiKey,
                        status: 'pending', // pending, connected, disconnected
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser?.email || 'unknown',
                        lastUpdated: new Date().toISOString(),
                        clubId: currentClubId // âœ… KulÃ¼p ID'si eklendi
                    };
                    
                    const docRef = await window.firebase.addDoc(
                        window.firebase.collection(window.db, 'whatsappDevices'),
                        deviceData
                    );
                    
                    whatsappDevices.push({ id: docRef.id, ...deviceData });
                    
                    showAlert('âœ… Cihaz baÅŸarÄ±yla oluÅŸturuldu! QR kodu yÃ¼kleniyor...', 'success');
                    form.reset();
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    
                    // Show loading modal first
                    showQRLoadingModal(instanceName);
                    
                    // Always fetch QR code from API after creation
                    setTimeout(() => {
                        fetchAndShowQR(instanceName, docRef.id);
                    }, 500);
                    
                    // Reload instances after a delay
                    setTimeout(() => loadWhatsAppInstances(), 800);
                } else {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    
                    let errorMsg = '';
                    if (response.status === 403) {
                        errorMsg = 'ğŸ”’ EriÅŸim HatasÄ±: Cihaz oluÅŸturma yetkiniz yok.';
                    } else {
                        errorMsg = `âŒ Hata (${response.status}): ${data.message || data.error || 'Cihaz oluÅŸturulamadÄ±.'}`;
                    }
                    
                    showAlert(errorMsg, 'danger');
                }
            } catch (error) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
                showAlert(`âŒ Cihaz oluÅŸturulurken hata oluÅŸtu.`, 'danger');
            }
        }
        
        function showQRLoadingModal(instanceName) {
            const modal = document.getElementById('qrCodeModal');
            if (!modal) return;
            
            const modalContent = modal.querySelector('.modal-content');
            if (!modalContent) return;
            
            document.getElementById('qrCodeTitle').textContent = `ğŸ“± ${instanceName} - QR Kod HazÄ±rlanÄ±yor`;
            
            const qrImage = document.getElementById('qrCodeImage');
            if (qrImage) {
                qrImage.src = '';
                qrImage.style.display = 'none';
            }
            
            // Add loading spinner
            const existingLoader = modalContent.querySelector('.qr-loading');
            if (!existingLoader) {
                const loader = document.createElement('div');
                loader.className = 'qr-loading';
                loader.innerHTML = '<div class="spinner"></div><p>QR kod oluÅŸturuluyor, lÃ¼tfen bekleyin...</p>';
                modalContent.insertBefore(loader, qrImage);
            }
            
            openModal('qrCodeModal');
        }
        
        async function loadWhatsAppInstances() {
            const container = document.getElementById('whatsappDevicesList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Cihazlar yÃ¼kleniyor...</span></div>';
            
            try {
                // Load from Firebase instead of API
                if (whatsappDevices.length === 0) {
                    container.innerHTML = '<p class="empty-state">HenÃ¼z baÄŸlÄ± cihaz yok. YukarÄ±dan yeni cihaz ekleyebilirsiniz.</p>';
                } else {
                    container.innerHTML = whatsappDevices.map(device => {
                        const statusClass = device.status === 'connected' ? 'status-active' : (device.status === 'disconnected' ? 'status-inactive' : 'status-pending');
                        const statusText = device.status === 'connected' ? 'ğŸŸ¢ BaÄŸlÄ±' : (device.status === 'disconnected' ? 'ğŸ”´ BaÄŸlantÄ± Kesildi' : 'ğŸŸ¡ Beklemede');
                        return `
                            <div class="whatsapp-device-card">
                                <div class="device-info">
                                    <h4>${device.instanceName}</h4>
                                    <p><span class="status-badge ${statusClass}">${statusText}</span></p>
                                    <p><small>ğŸ“± ${device.phoneNumber}</small></p>
                                    <p><small>ğŸ“… ${formatDate(device.createdAt)}</small></p>
                                </div>
                                    <div class="device-actions">
                                        ${device.status !== 'connected' ? `<button class="btn btn-info btn-sm" onclick="window.showInstanceQR('${device.instanceName}')">ğŸ“· QR Kod</button>` : ''}
                                        ${device.status === 'pending' ? `<button class="btn btn-success btn-sm" onclick="window.manualCheckConnection('${device.instanceName}', '${device.id}')">âœ”ï¸ Durumu Kontrol Et</button>` : ''}
                                        <button class="btn btn-warning btn-sm" onclick="window.restartInstance('${device.instanceName}', '${device.id}')">ğŸ”„ Yeniden BaÅŸlat</button>
                                        <button class="btn btn-danger btn-sm" onclick="window.deleteInstance('${device.instanceName}', '${device.id}')">ğŸ—‘ï¸ Sil</button>
                                    </div>
                            </div>
                        `;
                    }).join('');
                }
                
                // Update test message device dropdown
                updateTestMessageDeviceDropdown();
                updateDefaultDeviceDropdown();
                loadSentMessagesLog();
            } catch (error) {
                container.innerHTML = '<p class="empty-state">Cihazlar yÃ¼klenirken hata oluÅŸtu.</p>';
            }
        }
        
        function updateTestMessageDeviceDropdown() {
            const select = document.getElementById('testMessageDevice');
            if (!select) return;
            
            const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
            
            if (connectedDevices.length === 0) {
                select.innerHTML = '<option value="">Ã–nce cihaz baÄŸlayÄ±n...</option>';
                select.disabled = true;
            } else {
                select.disabled = false;
                select.innerHTML = '<option value="">Cihaz seÃ§in...</option>' + 
                    connectedDevices.map(device => 
                        `<option value="${device.instanceName}">${device.instanceName} (${device.phoneNumber})</option>`
                    ).join('');
            }
        }
        
        function updateDefaultDeviceDropdown() {
            const select = document.getElementById('defaultWhatsAppDevice');
            if (!select) return;
            
            const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
            
            if (connectedDevices.length === 0) {
                select.innerHTML = '<option value="">Ã–nce cihaz baÄŸlayÄ±n...</option>';
                select.disabled = true;
            } else {
                select.disabled = false;
                select.innerHTML = '<option value="">Cihaz seÃ§in...</option>' + 
                    connectedDevices.map(device => {
                        const isDefault = defaultWhatsAppDevice === device.instanceName;
                        return `<option value="${device.instanceName}" ${isDefault ? 'selected' : ''}>${device.instanceName} ${isDefault ? 'â­' : ''} (${device.phoneNumber})</option>`;
                    }).join('');
            }
        }
        
        window.setDefaultWhatsAppDevice = async function(instanceName) {
            if (!instanceName) return;
            
            try {
                await window.firebase.setDoc(
                    window.firebase.doc(window.db, 'settings', 'whatsappConfig'),
                    {
                        defaultDevice: instanceName,
                        updatedAt: new Date().toISOString(),
                        updatedBy: currentUser?.email || 'admin'
                    }
                );
                
                defaultWhatsAppDevice = instanceName;
                showAlert('âœ… Ana WhatsApp hattÄ± ayarlandÄ±!', 'success');
                updateDefaultDeviceDropdown();
            } catch (error) {
                showAlert('âŒ Ayar kaydedilemedi.', 'danger');
            }
        };
        
        function loadSentMessagesLog() {
            const container = document.getElementById('sentMessagesLog');
            if (!container) return;
            
            if (sentMessages.length === 0) {
                container.innerHTML = '<p class="empty-state">HenÃ¼z mesaj gÃ¶nderilmedi.</p>';
                return;
            }
            
            container.innerHTML = `
                <div class="table-container">
                    <table class="data-table" style="font-size: 12px;">
                        <thead>
                            <tr>
                                <th>Tarih/Saat</th>
                                <th>AlÄ±cÄ±</th>
                                <th>Mesaj</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sentMessages.map((msg, index) => `
                                <tr style="cursor: pointer;" onclick="showMessageDetail(${index})">
                                    <td style="white-space: nowrap;">${formatDate(msg.sentAt)}</td>
                                    <td>${msg.recipient}</td>
                                    <td style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        ${msg.message.substring(0, 50)}${msg.message.length > 50 ? '...' : ''}
                                    </td>
                                    <td>
                                        ${msg.success ? '<span style="color: green;">âœ“ GÃ¶nderildi</span>' : '<span style="color: red;">âœ— BaÅŸarÄ±sÄ±z</span>'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        window.showMessageDetail = function(index) {
            const msg = sentMessages[index];
            if (!msg) return;
            
            const modal = document.getElementById('messageDetailModal');
            document.getElementById('messageDetailTitle').textContent = `ğŸ“© Mesaj DetayÄ± - ${msg.recipient}`;
            document.getElementById('messageDetailRecipient').textContent = msg.recipient;
            document.getElementById('messageDetailPhone').textContent = msg.recipientPhone || '-';
            document.getElementById('messageDetailDate').textContent = formatDate(msg.sentAt);
            document.getElementById('messageDetailStatus').innerHTML = msg.success 
                ? '<span style="color: green; font-weight: bold;">âœ“ GÃ¶nderildi</span>' 
                : '<span style="color: red; font-weight: bold;">âœ— BaÅŸarÄ±sÄ±z</span>';
            document.getElementById('messageDetailText').textContent = msg.message;
            document.getElementById('messageDetailInstance').textContent = msg.instanceName || '-';
            
            openModal('messageDetailModal');
        }
        
        // ===== WHATSAPP PAGE FUNCTIONS =====
        let currentWhatsAppContact = null;
        let whatsappMessages = {}; // { phoneNumber: [messages] }
        let whatsappContacts = []; // KiÅŸi listesi
        
        let unreadMessagesCount = 0;
        let lastWhatsAppUnreadCount = -1; // Ä°lk yÃ¼kleme kontrolÃ¼ iÃ§in (-1 = henÃ¼z yÃ¼klenmedÄ±)
        
        // selectedWhatsAppDevice zaten yukarÄ±da tanÄ±mlandÄ± (satÄ±r 118)
        
        function renderWhatsAppPage() {
            loadWhatsAppDevicesMain();
            updateActiveDeviceDropdown();
            updateTestMessageDeviceDropdown();
            updateDefaultDeviceDropdown();
            loadSentMessagesLog();
            updateBulkMessageSettings();
            loadWhatsAppSettings(); // AyarlarÄ± inputlara yÃ¼kle
            renderMessageQueue(); // Mesaj kuyruÄŸunu gÃ¶ster
            
            // ğŸ”¥ Start Firebase realtime listeners (Priority)
            startWhatsAppRealtimeListeners();
            
            // Start auto-refresh for live updates (Fallback)
            startWhatsAppAutoRefresh();
            
            // âœ… Otomatik olarak ana cihazÄ± seÃ§
            if (!selectedWhatsAppDevice && defaultWhatsAppDevice) {
                const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
                const defaultDevice = connectedDevices.find(d => d.instanceName === defaultWhatsAppDevice);
                
                if (defaultDevice) {
                    selectedWhatsAppDevice = defaultDevice; // âœ… FIX: Obje atanmalÄ±, string deÄŸil!
                    console.log('âœ… Ana WhatsApp cihazÄ± otomatik seÃ§ildi:', defaultWhatsAppDevice);
                    
                    // Dropdown'Ä± gÃ¼ncelle
                    const deviceSelect = document.getElementById('whatsapp-device-selector');
                    if (deviceSelect) {
                        deviceSelect.value = defaultWhatsAppDevice;
                    }
                    
                    // MesajlaÅŸma alanÄ±nÄ± gÃ¶ster
                    const messagingArea = document.getElementById('whatsapp-messaging-area');
                    if (messagingArea) {
                        messagingArea.style.display = 'block';
                    }
                    
                    // KontaklarÄ± yÃ¼kle
                    loadWhatsAppContacts();
                }
            } else if (selectedWhatsAppDevice) {
                // Load contacts if device is already selected
                loadWhatsAppContacts();
            }
        }
        
        // AyarlarÄ± inputlara yÃ¼kle
        function loadWhatsAppSettings() {
            // Ã‡alÄ±ÅŸma saatleri ayarlarÄ±
            try {
                if (clubSettings.workingHoursEnabled) {
                    const enabledCheckbox = document.getElementById('workingHoursEnabled');
                    const fieldsDiv = document.getElementById('workingHoursFields');
                    if (enabledCheckbox) enabledCheckbox.checked = true;
                    if (fieldsDiv) fieldsDiv.style.display = 'block';
                }
                
                if (clubSettings.workingHoursStart) {
                    const startInput = document.getElementById('workingHoursStart');
                    if (startInput) startInput.value = clubSettings.workingHoursStart;
                }
                if (clubSettings.workingHoursEnd) {
                    const endInput = document.getElementById('workingHoursEnd');
                    if (endInput) endInput.value = clubSettings.workingHoursEnd;
                }
                
                // Ã‡alÄ±ÅŸma gÃ¼nleri
                if (clubSettings.workingDays) {
                    clubSettings.workingDays.forEach(day => {
                        const checkbox = document.getElementById(`workDay-${day}`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
                
                // Bulutfon ayarlarÄ±
                if (clubSettings.bulutfonEnabled) {
                    const bulutfonCheckbox = document.getElementById('bulutfonEnabled');
                    const bulutfonSettings = document.getElementById('bulutfon-api-settings');
                    if (bulutfonCheckbox) bulutfonCheckbox.checked = true;
                    if (bulutfonSettings) bulutfonSettings.style.display = 'block';
                }
                
                if (clubSettings.bulutfonApiKey) {
                    const apiKeyInput = document.getElementById('bulutfonApiKey');
                    if (apiKeyInput) apiKeyInput.value = clubSettings.bulutfonApiKey;
                }
            } catch (error) {
                console.warn('loadWhatsAppSettings error (non-critical):', error);
            }
        }
        
        // âœ… Toplu mesaj Ã¶zetini ayarlara gÃ¶re gÃ¼ncelle
        function updateBulkMessageSettings() {
            const waitTimeDisplay = document.getElementById('bulk-wait-time-display');
            const longWaitTrigger = document.getElementById('bulk-long-wait-trigger');
            const longWaitDisplay = document.getElementById('bulk-long-wait-display');
            
            if (waitTimeDisplay) {
                waitTimeDisplay.textContent = `${clubSettings.minWaitTime || 20}-${clubSettings.maxWaitTime || 50} saniye`;
            }
            if (longWaitTrigger) {
                longWaitTrigger.textContent = clubSettings.longWaitTrigger || 100;
            }
            if (longWaitDisplay) {
                longWaitDisplay.textContent = `${clubSettings.minLongWait || 400}-${clubSettings.maxLongWait || 800} saniye`;
            }
        }
        
        // Switch WhatsApp Tabs
        function switchWhatsAppTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('#whatsapp .settings-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('#whatsapp .settings-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(`whatsapp-tab-${tabName}`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Set active class on clicked tab
            event.target.classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'devices') {
                loadWhatsAppDevicesMain();
            } else if (tabName === 'campaigns') {
                loadCampaigns();
            } else if (tabName === 'calls') {
                loadWhatsAppCalls();
            } else if (tabName === 'queue') {
                renderMessageQueue();
            }
        }
        
        window.switchWhatsAppTab = switchWhatsAppTab;
        
        // === WHATSAPP BALANCE PAGE ===
        
        async function renderWhatsAppBalancePage() {
            const container = document.getElementById('whatsapp-balance-content');
            if (!container) {
                console.error('WhatsApp balance container not found!');
                return;
            }
            
            // Check if Supabase is initialized
            if (!window.supabase) {
                console.error('Supabase not initialized!');
                container.innerHTML = `<div class="card"><p style="color: red;">âŒ Supabase baÄŸlantÄ±sÄ± kurulamadÄ±. SayfayÄ± yenileyin.</p></div>`;
                return;
            }
            
            // Check if currentClubId exists
            if (!currentClubId) {
                console.error('currentClubId is not defined!');
                container.innerHTML = `<div class="card"><p style="color: red;">âŒ KulÃ¼p ID bulunamadÄ±. LÃ¼tfen tekrar giriÅŸ yapÄ±n.</p></div>`;
                return;
            }
            
            console.log('Loading WhatsApp balance for club:', currentClubId);
            container.innerHTML = '<div class="loading" style="text-align: center; padding: 40px;"><div class="spinner"></div><span>YÃ¼kleniyor...</span></div>';
            
            try {
                // Load current balance
                const { data: clubData, error: clubError } = await window.supabase
                    .from('clubs')
                    .select('whatsapp_balance')
                    .eq('id', currentClubId)
                    .single();
                
                if (clubError) throw clubError;
                
                const currentBalance = clubData?.whatsapp_balance || 0;
                
                // Load available packages
                const { data: packages, error: packagesError } = await window.supabase
                    .from('whatsapp_packages')
                    .select('*')
                    .eq('is_active', true)
                    .order('message_count', { ascending: true });
                
                if (packagesError) throw packagesError;
                
                // Load recent transactions
                const { data: logs, error: logsError } = await window.supabase
                    .from('whatsapp_balance_logs')
                    .select('*')
                    .eq('club_id', currentClubId)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (logsError) throw logsError;
                
                // Update sidebar balance display
                const sidebarBalance = document.getElementById('whatsapp-balance');
                if (sidebarBalance) {
                    sidebarBalance.textContent = currentBalance.toLocaleString('tr-TR');
                }
                
                // Render page
                container.innerHTML = `
                    <!-- Current Balance Card -->
                    <div class="card" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 20px rgba(37, 211, 102, 0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                            <div>
                                <div style="font-size: 16px; opacity: 0.9; margin-bottom: 10px;">Mevcut Mesaj Bakiyeniz</div>
                                <div style="font-size: 48px; font-weight: 700; margin-bottom: 5px;">${currentBalance.toLocaleString('tr-TR')}</div>
                                <div style="font-size: 14px; opacity: 0.8;">WhatsApp mesajÄ±</div>
                            </div>
                            <div style="text-align: right;">
                                ${currentBalance < 100 ? `
                                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 12px; backdrop-filter: blur(10px);">
                                        <div style="font-size: 24px; margin-bottom: 5px;">âš ï¸</div>
                                        <div style="font-size: 13px; opacity: 0.95;">Bakiyeniz dÃ¼ÅŸÃ¼k!</div>
                                        <div style="font-size: 13px; opacity: 0.95;">LÃ¼tfen paket satÄ±n alÄ±n</div>
                                    </div>
                                ` : `
                                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 12px; backdrop-filter: blur(10px);">
                                        <div style="font-size: 24px; margin-bottom: 5px;">âœ…</div>
                                        <div style="font-size: 13px; opacity: 0.95;">Bakiyeniz yeterli</div>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Available Packages -->
                    <div class="card">
                        <h3 class="card-title">ğŸ“¦ Mesaj Paketleri</h3>
                        <p style="color: #666; margin-bottom: 25px;">WhatsApp mesaj hakkÄ±nÄ±zÄ± artÄ±rmak iÃ§in aÅŸaÄŸÄ±daki paketlerden birini seÃ§ebilirsiniz.</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            ${packages.length === 0 ? `
                                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">
                                    Åu anda aktif paket bulunmuyor
                                </div>
                            ` : packages.map(pkg => {
                                const pricePerMessage = (parseFloat(pkg.price) / pkg.message_count).toFixed(4);
                                const isPopular = pkg.message_count >= 2500 && pkg.message_count <= 5000;
                                
                                return `
                                    <div class="card" style="position: relative; border: 2px solid ${isPopular ? '#25D366' : '#e0e0e0'}; padding: 25px; border-radius: 12px; transition: all 0.3s; cursor: pointer; background: ${isPopular ? '#f0fdf4' : 'white'};" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                                        ${isPopular ? `
                                            <div style="position: absolute; top: -12px; right: 20px; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: 600; box-shadow: 0 2px 8px rgba(37, 211, 102, 0.4);">
                                                â­ PopÃ¼ler
                                            </div>
                                        ` : ''}
                                        
                                        <div style="text-align: center;">
                                            <h4 style="margin: 0 0 10px 0; font-size: 20px; color: #333;">${pkg.name}</h4>
                                            <div style="font-size: 36px; font-weight: 700; color: ${isPopular ? '#25D366' : '#667eea'}; margin: 15px 0;">
                                                ${pkg.message_count.toLocaleString('tr-TR')}
                                            </div>
                                            <div style="font-size: 14px; color: #666; margin-bottom: 15px;">mesaj</div>
                                            
                                            <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin: 15px 0;">
                                                <div style="font-size: 28px; font-weight: 700; color: #28a745;">
                                                    â‚º${parseFloat(pkg.price).toLocaleString('tr-TR', {minimumFractionDigits: 2})}
                                                </div>
                                                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                                    (Mesaj baÅŸÄ±na â‚º${pricePerMessage})
                                                </div>
                                            </div>
                                            
                                            ${pkg.description ? `
                                                <p style="font-size: 13px; color: #666; margin: 15px 0; min-height: 40px;">${pkg.description}</p>
                                            ` : ''}
                                            
                                            <button onclick="purchasePackage('${pkg.id}', '${pkg.name}', ${pkg.message_count}, ${pkg.price})" class="btn btn-primary" style="width: 100%; margin-top: 10px; background: ${isPopular ? 'linear-gradient(135deg, #25D366 0%, #128C7E 100%)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}; border: none; padding: 12px; font-weight: 600;">
                                                ğŸ’³ SatÄ±n Al
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 25px; border-left: 4px solid #ffc107;">
                            <strong>â„¹ï¸ Not:</strong> Paket satÄ±n alma iÅŸlemleri iÃ§in lÃ¼tfen iletiÅŸime geÃ§iniz: 
                            <a href="tel:03623630063" style="color: #007bff; text-decoration: none; font-weight: 600;">ğŸ“ 0362 363 00 63</a>
                        </div>
                    </div>
                    
                    <!-- Transaction History -->
                    <div class="card">
                        <h3 class="card-title">ğŸ“Š Ä°ÅŸlem GeÃ§miÅŸi</h3>
                        
                        ${logs && logs.length > 0 ? `
                            <div style="overflow-x: auto;">
                                <table class="table" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                            <th style="padding: 12px; text-align: left;">Tarih</th>
                                            <th style="padding: 12px; text-align: left;">Ä°ÅŸlem Tipi</th>
                                            <th style="padding: 12px; text-align: center;">Miktar</th>
                                            <th style="padding: 12px; text-align: center;">Ã–nceki Bakiye</th>
                                            <th style="padding: 12px; text-align: center;">Yeni Bakiye</th>
                                            <th style="padding: 12px; text-align: left;">Not</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${logs.map(log => {
                                            const actionTypes = {
                                                'manual_add': 'ğŸ‘¨â€ğŸ’¼ Manuel Ekleme',
                                                'purchase': 'ğŸ’³ Paket SatÄ±n Alma',
                                                'send': 'ğŸ“¤ Mesaj GÃ¶nderimi',
                                                'add': 'â• Ekleme',
                                                'refund': 'â†©ï¸ Ä°ade'
                                            };
                                            
                                            return `
                                                <tr style="border-bottom: 1px solid #dee2e6;">
                                                    <td style="padding: 12px; font-size: 13px;">
                                                        ${new Date(log.created_at).toLocaleDateString('tr-TR', {
                                                            day: '2-digit',
                                                            month: 'short',
                                                            year: 'numeric',
                                                            hour: '2-digit',
                                                            minute: '2-digit'
                                                        })}
                                                    </td>
                                                    <td style="padding: 12px; font-size: 13px;">
                                                        ${actionTypes[log.action_type] || log.action_type}
                                                    </td>
                                                    <td style="padding: 12px; text-align: center; font-weight: 600; color: ${log.amount > 0 ? '#28a745' : '#dc3545'}; font-size: 14px;">
                                                        ${log.amount > 0 ? '+' : ''}${log.amount.toLocaleString('tr-TR')}
                                                    </td>
                                                    <td style="padding: 12px; text-align: center; font-size: 13px; color: #6c757d;">
                                                        ${log.previous_balance.toLocaleString('tr-TR')}
                                                    </td>
                                                    <td style="padding: 12px; text-align: center; font-weight: 600; font-size: 14px;">
                                                        ${log.new_balance.toLocaleString('tr-TR')}
                                                    </td>
                                                    <td style="padding: 12px; font-size: 13px; color: #6c757d;">
                                                        ${log.note || '-'}
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 40px; color: #999;">
                                HenÃ¼z iÅŸlem geÃ§miÅŸi bulunmuyor
                            </div>
                        `}
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading WhatsApp balance page:', error);
                container.innerHTML = `
                    <div class="card">
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <h3>âŒ YÃ¼klenirken Hata OluÅŸtu</h3>
                            <p>${error.message}</p>
                            <button class="btn btn-primary" onclick="renderWhatsAppBalancePage()">ğŸ”„ Tekrar Dene</button>
                        </div>
                    </div>
                `;
            }
        }
        
        window.purchasePackage = async function(packageId, packageName, messageCount, price) {
            // Åimdilik sadece iletiÅŸim bilgisi gÃ¶ster
            showAlert(`
                <div style="text-align: center;">
                    <h3 style="margin-bottom: 15px;">ğŸ“¦ ${packageName}</h3>
                    <p style="font-size: 16px; margin-bottom: 10px;">
                        <strong>${messageCount.toLocaleString('tr-TR')}</strong> mesaj hakkÄ±
                    </p>
                    <p style="font-size: 20px; color: #28a745; font-weight: 700; margin-bottom: 20px;">
                        â‚º${parseFloat(price).toLocaleString('tr-TR', {minimumFractionDigits: 2})}
                    </p>
                    <hr style="margin: 20px 0;">
                    <p style="margin-bottom: 15px;">SatÄ±n alma iÅŸlemi iÃ§in lÃ¼tfen bizimle iletiÅŸime geÃ§in:</p>
                    <a href="tel:03623630063" style="display: inline-block; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; padding: 15px 30px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 18px; margin-top: 10px;">
                        ğŸ“ 0362 363 00 63
                    </a>
                </div>
            `, 'info');
        };
        
        // === WHATSAPP CALLS FUNCTIONS ===
        
        async function loadWhatsAppCalls() {
            const container = document.getElementById('whatsapp-calls-list');
            if (!container) return;
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>WhatsApp aramalarÄ± yÃ¼kleniyor...</span></div>';
            
            console.log('ğŸ“ WhatsApp aramalarÄ± Firebase\'den yÃ¼kleniyor...');
            console.log('â„¹ï¸ Not: Evolution API\'de direkt call history endpoint\'i yok, webhook ile Firebase\'e kaydediliyor');
            
            try {
                // Firebase'den Ã§ekelim
                const callsRef = window.firebase.collection(window.db, 'whatsappIncomingCalls');
                let callsSnapshot;
                
                // Ã–nce index'li sorguyu dene
                try {
                    console.log('ğŸ” Index\'li sorgu deneniyor (clubId + timestamp)...');
                    const callsQuery = window.firebase.query(
                        callsRef,
                        window.firebase.where('clubId', '==', currentClubId),
                        window.firebase.orderBy('timestamp', 'desc'),
                        window.firebase.limit(100)
                    );
                    callsSnapshot = await window.firebase.getDocs(callsQuery);
                    console.log('âœ… Index\'li sorgu baÅŸarÄ±lÄ±:', callsSnapshot.docs.length, 'arama bulundu');
                } catch (indexError) {
                    // Index yoksa sadece clubId ile filtrele
                    console.warn('âš ï¸ Index hatasÄ±, basit sorgu deneniyor...', indexError.message);
                    const simpleQuery = window.firebase.query(
                        callsRef,
                        window.firebase.where('clubId', '==', currentClubId)
                    );
                    callsSnapshot = await window.firebase.getDocs(simpleQuery);
                    console.log('âœ… Basit sorgu baÅŸarÄ±lÄ±:', callsSnapshot.docs.length, 'arama bulundu');
                }
                
                // TÃ¼m dÃ¶kÃ¼manlarÄ± da kontrol et (debug iÃ§in)
                console.log('ğŸ” TÃ¼m whatsappIncomingCalls dÃ¶kÃ¼manlarÄ± kontrol ediliyor...');
                const allCallsSnapshot = await window.firebase.getDocs(callsRef);
                console.log(`ğŸ“Š Toplam ${allCallsSnapshot.docs.length} WhatsApp arama dÃ¶kÃ¼manÄ± var (tÃ¼m clublar dahil)`);
                
                if (allCallsSnapshot.docs.length > 0) {
                    console.log('ğŸ” Ä°lk dÃ¶kÃ¼man Ã¶rneÄŸi:', allCallsSnapshot.docs[0].data());
                    
                    // Bu club'a ait kaÃ§ tane var?
                    const thisClubCalls = allCallsSnapshot.docs.filter(doc => doc.data().clubId === currentClubId);
                    console.log(`ğŸ“Š Bu club'a ait ${thisClubCalls.length} arama var`);
                    
                    if (thisClubCalls.length === 0) {
                        console.warn('âš ï¸ Firebase\'de WhatsApp aramasÄ± var ama clubId eÅŸleÅŸmiyor!');
                        console.log('Mevcut clubId:', currentClubId);
                        console.log('Ä°lk dÃ¶kÃ¼manÄ±n clubId\'si:', allCallsSnapshot.docs[0].data().clubId);
                    }
                }
                
                if (callsSnapshot.empty) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p style="padding: 40px; color: #999;">ğŸ“ Bu club iÃ§in WhatsApp aramasÄ± bulunmadÄ±</p>
                            <p style="color: #666; font-size: 14px;">Club ID: ${currentClubId}</p>
                            <p style="color: #666; font-size: 14px;">Toplam sistemdeki aramalar: ${allCallsSnapshot.docs.length}</p>
                            <button class="btn btn-secondary" onclick="loadWhatsAppCalls()">ğŸ”„ Tekrar Dene</button>
                        </div>
                    `;
                    return;
                }
                
                const calls = [];
                callsSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    calls.push({
                        id: doc.id,
                        ...data
                    });
                });
                
                console.log(`ğŸ“ ${calls.length} WhatsApp aramasÄ± yÃ¼klendi`);
                
                // Ä°lk aramayÄ± konsola yazdÄ±r (debug iÃ§in)
                if (calls.length > 0) {
                    console.log('ğŸ” Ä°lk arama detayÄ±:', calls[0]);
                    console.log('  - from:', calls[0].from);
                    console.log('  - caller:', calls[0].caller);
                    console.log('  - timestamp:', calls[0].timestamp);
                    console.log('  - instanceName:', calls[0].instanceName);
                    console.log('  - is_missing_call:', calls[0].is_missing_call);
                    console.log('  - isVideo:', calls[0].isVideo);
                }
                
                // AramalarÄ± tarihe gÃ¶re sÄ±rala (eÄŸer index sorgusu Ã§alÄ±ÅŸmadÄ±ysa)
                calls.sort((a, b) => {
                    const dateA = new Date(a.timestamp);
                    const dateB = new Date(b.timestamp);
                    return dateB - dateA;
                });
                
                // AramalarÄ± render et
                container.innerHTML = calls.map(call => {
                    const caller = call.from || call.caller || 'Bilinmeyen';
                    const formattedCaller = formatPhoneDisplay(caller);
                    const callTime = new Date(call.timestamp);
                    const timeStr = callTime.toLocaleString('tr-TR', { 
                        day: '2-digit', 
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit', 
                        minute: '2-digit'
                    });
                    
                    // Zaman farkÄ± hesapla
                    const now = new Date();
                    const diffMs = now - callTime;
                    const diffMins = Math.floor(diffMs / 60000);
                    let timeSinceStr = '';
                    if (diffMins < 60) {
                        timeSinceStr = `${diffMins} dakika Ã¶nce`;
                    } else if (diffMins < 1440) {
                        timeSinceStr = `${Math.floor(diffMins / 60)} saat ${diffMins % 60} dakika Ã¶nce`;
                    } else {
                        timeSinceStr = `${Math.floor(diffMins / 1440)} gÃ¼n Ã¶nce`;
                    }
                    
                    // Durum
                    const isMissed = call.is_missing_call === true || call.is_missing_call === 'true';
                    const statusText = isMissed ? 'CevapsÄ±z' : 'CevaplandÄ±';
                    const statusColor = isMissed ? '#f44336' : '#4caf50';
                    const statusIcon = isMissed ? 'ğŸ“µ' : 'âœ…';
                    
                    // Video/Ses
                    const isVideo = call.isVideo === true;
                    const callTypeIcon = isVideo ? 'ğŸ“¹' : 'ğŸ“';
                    const callTypeText = isVideo ? 'Video Arama' : 'Ses Arama';
                    
                    // CRM'de veya Ã¼yelerde var mÄ± kontrol et
                    const leadMatch = crmLeads.find(l => phonesMatch(l.phone, caller));
                    const memberMatch = members.find(m => phonesMatch(m.Telefon, caller) || phonesMatch(m.Telefon_2, caller));
                    
                    let personInfo = '';
                    let actionButtons = '';
                    
                    if (memberMatch) {
                        personInfo = `
                            <div style="font-size: 14px; color: #25D366; font-weight: 600; margin-top: 5px;">
                                ğŸ‘¤ ${memberMatch.Resit_Olmayan_Adi_Soyadi || memberMatch.Ad_Soyad}
                                <span style="background: #25D366; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px;">ÃœYE</span>
                            </div>
                        `;
                        actionButtons = `
                            <button class="btn btn-sm btn-info" onclick="showMemberAttendancePage('${memberMatch.id}')" title="Ãœye detaylarÄ±nÄ± gÃ¶rÃ¼ntÃ¼le">
                                ğŸ‘¤ Ãœye DetayÄ±
                            </button>
                        `;
                    } else if (leadMatch) {
                        personInfo = `
                            <div style="font-size: 14px; color: #ff9800; font-weight: 600; margin-top: 5px;">
                                ğŸ’¼ ${leadMatch.fullName}
                                <span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px;">CRM</span>
                            </div>
                        `;
                        actionButtons = `
                            <button class="btn btn-sm btn-warning" onclick="openCustomerDetail('${leadMatch.id}')" title="CRM detaylarÄ±nÄ± gÃ¶rÃ¼ntÃ¼le">
                                ğŸ’¼ CRM DetayÄ±
                            </button>
                        `;
                    } else {
                        actionButtons = `
                            <button class="btn btn-sm btn-primary" onclick="quickAddToCRM('${caller}')" title="CRM'e ekle">
                                â• CRM'e Ekle
                            </button>
                        `;
                    }
                    
                    return `
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid ${statusColor}; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                        <span style="font-size: 24px;">${callTypeIcon}</span>
                                        <div>
                                            <div style="font-size: 16px; font-weight: 600; color: #333;">
                                                ${formattedCaller}
                                            </div>
                                            <div style="font-size: 12px; color: #666;">
                                                ${callTypeText} â€¢ ${call.instanceName || 'WhatsApp'}
                                            </div>
                                        </div>
                                    </div>
                                    ${personInfo}
                                    <div style="font-size: 12px; color: #999; margin-top: 8px;">
                                        ğŸ“… ${timeStr} (${timeSinceStr})
                                    </div>
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: end; gap: 8px;">
                                    <div style="font-size: 14px; font-weight: 600; color: ${statusColor};">
                                        ${statusIcon} ${statusText}
                                    </div>
                                    ${actionButtons}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('âŒ WhatsApp aramalarÄ± yÃ¼klenirken hata:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="padding: 40px; color: #f44336;">
                            âŒ Aramalar yÃ¼klenirken bir hata oluÅŸtu
                        </p>
                        <p style="color: #666; font-size: 14px;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        window.loadWhatsAppCalls = loadWhatsAppCalls;
        
        // Debug fonksiyonu - Firebase'deki tÃ¼m WhatsApp aramalarÄ±nÄ± gÃ¶ster
        async function debugWhatsAppCalls() {
            const debugContainer = document.getElementById('whatsapp-calls-debug');
            if (!debugContainer) return;
            
            debugContainer.style.display = 'block';
            debugContainer.innerHTML = '<p>ğŸ” Firebase kontrol ediliyor...</p>';
            
            try {
                const callsRef = window.firebase.collection(window.db, 'whatsappIncomingCalls');
                const allCallsSnapshot = await window.firebase.getDocs(callsRef);
                
                let debugInfo = `
                    <h4 style="margin-bottom: 10px;">ğŸ“Š Firebase Debug Bilgileri</h4>
                    <p><strong>Toplam WhatsApp aramasÄ±:</strong> ${allCallsSnapshot.docs.length}</p>
                    <p><strong>Mevcut Club ID:</strong> ${currentClubId}</p>
                    <hr style="margin: 10px 0;">
                `;
                
                if (allCallsSnapshot.docs.length === 0) {
                    debugInfo += '<p style="color: red;">âŒ Firebase\'de hiÃ§ WhatsApp aramasÄ± yok!</p>';
                    debugInfo += '<p>Webhook\'unuzun doÄŸru Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin olun.</p>';
                } else {
                    // Bu club'a ait aramalarÄ± filtrele
                    const thisClubCalls = allCallsSnapshot.docs.filter(doc => doc.data().clubId === currentClubId);
                    debugInfo += `<p><strong>Bu club'a ait aramalar:</strong> ${thisClubCalls.length}</p>`;
                    
                    // TÃ¼m farklÄ± clubId'leri gÃ¶ster
                    const allClubIds = [...new Set(allCallsSnapshot.docs.map(doc => doc.data().clubId))];
                    debugInfo += `<p><strong>Sistemdeki Club ID'ler:</strong> ${allClubIds.join(', ')}</p>`;
                    
                    debugInfo += '<hr style="margin: 10px 0;">';
                    debugInfo += '<h5>Son 5 Arama Ã–rneÄŸi:</h5>';
                    
                    allCallsSnapshot.docs.slice(0, 5).forEach((doc, index) => {
                        const data = doc.data();
                        debugInfo += `
                            <div style="background: white; padding: 10px; margin: 10px 0; border-radius: 4px; border-left: 4px solid ${data.clubId === currentClubId ? '#4caf50' : '#ff9800'};">
                                <p><strong>Arama ${index + 1}:</strong></p>
                                <p style="margin: 5px 0;"><strong>ID:</strong> ${doc.id}</p>
                                <p style="margin: 5px 0;"><strong>from:</strong> ${data.from || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>caller:</strong> ${data.caller || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>instanceName:</strong> ${data.instanceName || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>timestamp:</strong> ${data.timestamp || 'N/A'}</p>
                                <p style="margin: 5px 0;"><strong>clubId:</strong> ${data.clubId || 'N/A'} ${data.clubId === currentClubId ? 'âœ… (EÅŸleÅŸiyor)' : 'âŒ (EÅŸleÅŸmiyor)'}</p>
                                <p style="margin: 5px 0;"><strong>is_missing_call:</strong> ${data.is_missing_call}</p>
                                <p style="margin: 5px 0;"><strong>isVideo:</strong> ${data.isVideo}</p>
                            </div>
                        `;
                    });
                    
                    if (thisClubCalls.length === 0 && allCallsSnapshot.docs.length > 0) {
                        debugInfo += `
                            <div style="background: #fff3cd; padding: 15px; margin: 15px 0; border-radius: 4px; border-left: 4px solid #ffc107;">
                                <p style="color: #856404; margin: 0;"><strong>âš ï¸ UYARI:</strong></p>
                                <p style="color: #856404; margin: 5px 0;">Firebase'de aramalar var ama clubId eÅŸleÅŸmiyor!</p>
                                <p style="color: #856404; margin: 5px 0;">Webhook'unuzda clubId'nin doÄŸru gÃ¶nderildiÄŸinden emin olun.</p>
                            </div>
                        `;
                    }
                }
                
                debugContainer.innerHTML = debugInfo;
                
            } catch (error) {
                console.error('Debug hatasÄ±:', error);
                debugContainer.innerHTML = `
                    <p style="color: red;">âŒ Hata oluÅŸtu: ${error.message}</p>
                    <pre style="background: white; padding: 10px; border-radius: 4px; overflow-x: auto;">${error.stack}</pre>
                `;
            }
        }
        
        window.debugWhatsAppCalls = debugWhatsAppCalls;
        
        // Mevcut instance'larÄ±n webhook ayarlarÄ±nÄ± gÃ¼ncelle (Ã§aÄŸrÄ± event'lerini aktif et)
        async function updateInstanceWebhookEvents(instanceName) {
            try {
                const device = whatsappDevices.find(d => d.instanceName === instanceName);
                if (!device) {
                    throw new Error('Cihaz bulunamadÄ±');
                }
                
                const evolutionUrl = device.evolutionUrl || EVOLUTION_API_URL;
                const apiKey = device.apiKey || EVOLUTION_API_KEY;
                
                console.log(`ğŸ”„ ${instanceName} iÃ§in webhook event'leri gÃ¼ncelleniyor...`);
                
                const webhookUrl = clubSettings?.evolutionWebhookUrl || device.webhookUrl || '';
                
                // Evolution API'de webhook ayarlarÄ±nÄ± gÃ¼ncelle
                // Ã–nce /webhook/set endpoint'ini dene
                let response = await fetch(`${evolutionUrl}/webhook/set/${instanceName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': apiKey
                    },
                    body: JSON.stringify({
                        enabled: true,
                        url: webhookUrl,
                        webhookByEvents: false,
                        webhookBase64: false,
                        events: [
                            "MESSAGES_UPSERT",
                            "MESSAGES_UPDATE",
                            "MESSAGES_DELETE",
                            "SEND_MESSAGE",
                            "CALL_UPSERT",
                            "CALL_OFFER",
                            "CALL_REJECT",
                            "CALL_ACCEPT"
                        ]
                    })
                });
                
                // EÄŸer 400 hatasÄ± alÄ±rsak, alternatif format dene
                if (response.status === 400) {
                    console.log(`âš ï¸ Ä°lk format baÅŸarÄ±sÄ±z, alternatif format deneniyor...`);
                    response = await fetch(`${evolutionUrl}/webhook/set/${instanceName}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': apiKey
                        },
                        body: JSON.stringify({
                            webhook: {
                                enabled: true,
                                url: webhookUrl,
                                webhookByEvents: false,
                                webhookBase64: false,
                                events: [
                                    "MESSAGES_UPSERT",
                                    "MESSAGES_UPDATE",
                                    "MESSAGES_DELETE",
                                    "SEND_MESSAGE",
                                    "CALL_UPSERT",
                                    "CALL_OFFER",
                                    "CALL_REJECT",
                                    "CALL_ACCEPT"
                                ]
                            }
                        })
                    });
                }
                
                // Hala baÅŸarÄ±sÄ±z olursa instance settings Ã¼zerinden dene
                if (response.status === 400 || response.status === 404) {
                    console.log(`âš ï¸ Webhook endpoint baÅŸarÄ±sÄ±z, instance settings Ã¼zerinden deneniyor...`);
                    response = await fetch(`${evolutionUrl}/instance/update/${instanceName}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': apiKey
                        },
                        body: JSON.stringify({
                            webhook: {
                                enabled: true,
                                url: webhookUrl,
                                webhookByEvents: false,
                                webhookBase64: false,
                                events: [
                                    "MESSAGES_UPSERT",
                                    "MESSAGES_UPDATE",
                                    "MESSAGES_DELETE",
                                    "SEND_MESSAGE",
                                    "CALL_UPSERT",
                                    "CALL_OFFER",
                                    "CALL_REJECT",
                                    "CALL_ACCEPT"
                                ]
                            }
                        })
                    });
                }
                
                if (response.ok) {
                    const result = await response.json();
                    console.log(`âœ… ${instanceName} webhook event'leri gÃ¼ncellendi:`, result);
                    showAlert(`âœ… ${instanceName} iÃ§in Ã§aÄŸrÄ± event'leri aktif edildi`, 'success');
                    return true;
                } else {
                    let errorMessage = 'Bilinmeyen hata';
                    try {
                        const error = await response.json();
                        console.error(`âŒ Webhook gÃ¼ncelleme hatasÄ± (${response.status}):`, error);
                        errorMessage = error.message || error.error || JSON.stringify(error);
                    } catch (e) {
                        const errorText = await response.text();
                        console.error(`âŒ Webhook gÃ¼ncelleme hatasÄ± (${response.status}):`, errorText);
                        errorMessage = errorText || `HTTP ${response.status}`;
                    }
                    showAlert(`âŒ Webhook gÃ¼ncellenemedi: ${errorMessage}`, 'danger');
                    return false;
                }
            } catch (error) {
                console.error('Webhook gÃ¼ncelleme hatasÄ±:', error);
                showAlert(`âŒ Hata: ${error.message}`, 'danger');
                return false;
            }
        }
        
        window.updateInstanceWebhookEvents = updateInstanceWebhookEvents;
        
        // TÃ¼m instance'lar iÃ§in webhook event'lerini gÃ¼ncelle
        async function updateAllInstancesWebhookEvents() {
            if (!confirm('TÃ¼m WhatsApp cihazlarÄ±nÄ±z iÃ§in Ã§aÄŸrÄ± event\'lerini aktif etmek istediÄŸinizden emin misiniz?')) {
                return;
            }
            
            const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
            
            if (connectedDevices.length === 0) {
                showAlert('âš ï¸ BaÄŸlÄ± cihaz bulunamadÄ±', 'warning');
                return;
            }
            
            showAlert(`ğŸ”„ ${connectedDevices.length} cihaz gÃ¼ncelleniyor...`, 'info');
            
            let successCount = 0;
            let failCount = 0;
            
            for (const device of connectedDevices) {
                const success = await updateInstanceWebhookEvents(device.instanceName);
                if (success) {
                    successCount++;
                } else {
                    failCount++;
                }
                // API'ye spam yapmamak iÃ§in kÄ±sa bir bekleme
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            showAlert(`âœ… GÃ¼ncelleme tamamlandÄ±: ${successCount} baÅŸarÄ±lÄ±, ${failCount} baÅŸarÄ±sÄ±z`, successCount > 0 ? 'success' : 'danger');
        }
        
        window.updateAllInstancesWebhookEvents = updateAllInstancesWebhookEvents;
        
        // === INCOMING MESSAGES FUNCTIONS ===
        
        function renderIncomingMessages() {
            const container = document.getElementById('incoming-messages-container');
            if (!container) return;
            
            if (incomingMessages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>ğŸ“­ HenÃ¼z gelen mesaj yok</h3>
                        <p>Webhook'unuzu yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ±zda, gelen mesajlar burada gÃ¶rÃ¼necektir.</p>
                        <p style="margin-top: 15px;">
                            <a href="#" onclick="switchWhatsAppTab('devices'); return false;" class="btn btn-primary">
                                ğŸ“± WhatsApp CihazlarÄ±nÄ± YapÄ±landÄ±r
                            </a>
                        </p>
                    </div>
                `;
                return;
            }
            
            filterIncomingMessages();
        }
        
        function filterIncomingMessages() {
            const searchTerm = document.getElementById('incoming-search')?.value.toLowerCase() || '';
            const filterType = document.getElementById('incoming-filter')?.value || 'all';
            
            let filtered = [...incomingMessages];
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(msg => 
                    msg.fromName?.toLowerCase().includes(searchTerm) ||
                    msg.from?.includes(searchTerm) ||
                    msg.message?.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply type filter
            if (filterType === 'members') {
                filtered = filtered.filter(msg => msg.memberInfo && msg.memberInfo.id);
            } else if (filterType === 'non-members') {
                filtered = filtered.filter(msg => !msg.memberInfo || !msg.memberInfo.id);
            } else if (filterType === 'unread') {
                filtered = filtered.filter(msg => !msg.processed);
            }
            
            displayIncomingMessages(filtered);
        }
        
        function displayIncomingMessages(messages) {
            const container = document.getElementById('incoming-messages-container');
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="empty-state"><h3>ğŸ” AramanÄ±za uygun mesaj bulunamadÄ±</h3></div>';
                return;
            }
            
            const tableHtml = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Tarih/Saat</th>
                                <th>GÃ¶nderen</th>
                                <th>Telefon</th>
                                <th>Mesaj</th>
                                <th>Ãœye Durumu</th>
                                <th>Durum</th>
                                <th>Ä°ÅŸlem</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${messages.map(msg => {
                                const date = new Date(msg.timestamp);
                                const formattedDate = date.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                                const formattedTime = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                                const isMember = msg.memberInfo && msg.memberInfo.id;
                                const memberBadge = isMember 
                                    ? `<span class="status-badge status-active" title="${msg.memberInfo.name}">âœ… Ãœye</span>`
                                    : `<span class="status-badge status-pending">âŒ Ãœye DeÄŸil</span>`;
                                const processedBadge = msg.processed 
                                    ? `<span class="status-badge status-completed">âœ“ Ä°ÅŸlendi</span>`
                                    : `<span class="status-badge status-pending">â³ Bekliyor</span>`;
                                
                                return `
                                    <tr>
                                        <td style="white-space: nowrap;">${formattedDate}<br><small>${formattedTime}</small></td>
                                        <td><strong>${msg.fromName || 'Bilinmiyor'}</strong></td>
                                        <td><a href="#" class="phone-link" onclick="handlePhoneClick(event, '${msg.from}')">${msg.from}</a></td>
                                        <td style="max-width: 300px; white-space: normal; word-wrap: break-word;">
                                            <div style="max-height: 60px; overflow: hidden; text-overflow: ellipsis;">
                                                ${msg.message || '<i>Mesaj iÃ§eriÄŸi yok</i>'}
                                            </div>
                                        </td>
                                        <td>${memberBadge}</td>
                                        <td>${processedBadge}</td>
                                        <td>
                                            <button class="btn btn-info btn-sm" onclick="viewIncomingMessage('${msg.id}')" title="DetaylarÄ± GÃ¶r">
                                                ğŸ‘ï¸
                                            </button>
                                            ${!msg.processed ? `
                                            <button class="btn btn-success btn-sm" onclick="markMessageProcessed('${msg.id}')" title="Ä°ÅŸlendi olarak iÅŸaretle">
                                                âœ“
                                            </button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        }
        
        async function refreshIncomingMessages() {
            try {
                const { getDocs, query, collection, orderBy } = window.firebase;
                const snapshot = await getDocs(query(collection(window.db, 'whatsappIncomingMessages'), orderBy('timestamp', 'desc')));
                incomingMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                showAlert('âœ… Gelen mesajlar gÃ¼ncellendi!', 'success');
                renderIncomingMessages();
            } catch (error) {
                console.error('Error refreshing incoming messages:', error);
                showAlert('Mesajlar yÃ¼klenirken hata oluÅŸtu: ' + error.message, 'danger');
            }
        }
        
        function viewIncomingMessage(messageId) {
            const msg = incomingMessages.find(m => m.id === messageId);
            if (!msg) return;
            
            const date = new Date(msg.timestamp);
            const formattedDate = date.toLocaleString('tr-TR');
            const isMember = msg.memberInfo && msg.memberInfo.id;
            
            const modalContent = `
                <div style="padding: 20px;">
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="margin: 0 0 10px 0;">ğŸ“¨ Mesaj DetayÄ±</h4>
                        <p style="margin: 5px 0;"><strong>GÃ¶nderen:</strong> ${msg.fromName || 'Bilinmiyor'}</p>
                        <p style="margin: 5px 0;"><strong>Telefon:</strong> ${msg.from}</p>
                        <p style="margin: 5px 0;"><strong>Tarih:</strong> ${formattedDate}</p>
                        <p style="margin: 5px 0;"><strong>Ãœye Durumu:</strong> ${isMember ? `âœ… Ãœye (${msg.memberInfo.name})` : 'âŒ Ãœye DeÄŸil'}</p>
                    </div>
                    <div style="padding: 20px; background: white; border: 1px solid #ddd; border-radius: 8px; min-height: 100px;">
                        <strong>Mesaj:</strong><br>
                        <p style="margin-top: 10px; white-space: pre-wrap; font-size: 15px;">${msg.message || '<i>Mesaj iÃ§eriÄŸi yok</i>'}</p>
                    </div>
                </div>
            `;
            
            showAlert(modalContent, 'info');
        }
        
        async function markMessageProcessed(messageId) {
            try {
                await window.firebase.updateDoc(
                    window.firebase.doc(window.db, 'incomingMessages', messageId),
                    { processed: true, processedAt: new Date().toISOString() }
                );
                
                // Update local data
                const msg = incomingMessages.find(m => m.id === messageId);
                if (msg) {
                    msg.processed = true;
                }
                
                showAlert('âœ… Mesaj iÅŸlendi olarak iÅŸaretlendi', 'success');
                filterIncomingMessages();
            } catch (error) {
                console.error('Error marking message:', error);
                showAlert('Ä°ÅŸlem baÅŸarÄ±sÄ±z: ' + error.message, 'danger');
            }
        }
        
        window.refreshIncomingMessages = refreshIncomingMessages;
        window.filterIncomingMessages = filterIncomingMessages;
        window.viewIncomingMessage = viewIncomingMessage;
        window.markMessageProcessed = markMessageProcessed;
        
        // Add event listener for search input
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('incoming-search');
            if (searchInput) {
                searchInput.addEventListener('input', filterIncomingMessages);
            }
        });
        
        function updateActiveDeviceDropdown() {
            const dropdown = document.getElementById('whatsapp-active-device');
            if (!dropdown) return;
            
            const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
            
            dropdown.innerHTML = '<option value="">Bir cihaz seÃ§in...</option>' + 
                connectedDevices.map(d => 
                    `<option value="${d.instanceName}">${d.instanceName} (${d.phoneNumber})</option>`
                ).join('');
            
            // âœ… Otomatik olarak ana cihazÄ± seÃ§ (eÄŸer henÃ¼z seÃ§ilmemiÅŸse)
            if (!selectedWhatsAppDevice && defaultWhatsAppDevice) {
                const defaultDevice = connectedDevices.find(d => d.instanceName === defaultWhatsAppDevice);
                if (defaultDevice) {
                    dropdown.value = defaultWhatsAppDevice;
                    selectedWhatsAppDevice = defaultDevice; // âœ… FIX: Obje atanmalÄ±, string deÄŸil!
                    
                    // MesajlaÅŸma alanÄ±nÄ± gÃ¶ster
                    const messagingArea = document.getElementById('whatsapp-messaging-area');
                    if (messagingArea) {
                        messagingArea.style.display = 'block';
                    }
                    
                    console.log('âœ… Ana WhatsApp cihazÄ± dropdown\'da otomatik seÃ§ildi:', defaultWhatsAppDevice);
                }
            } else if (selectedWhatsAppDevice) {
                // EÄŸer zaten seÃ§ilmiÅŸse dropdown'da gÃ¶ster
                dropdown.value = selectedWhatsAppDevice.instanceName || selectedWhatsAppDevice; // âœ… FIX: Obje ise instanceName al
            }
        }
        
        window.onDeviceSelectionChange = function() {
            const dropdown = document.getElementById('whatsapp-active-device');
            const deviceInfo = document.getElementById('whatsapp-device-info');
            const messagingArea = document.getElementById('whatsapp-messaging-area');
            
            const selectedInstance = dropdown.value;
            
            if (!selectedInstance) {
                deviceInfo.textContent = '';
                messagingArea.style.display = 'none';
                selectedWhatsAppDevice = null;
                return;
            }
            
            // Find selected device
            const device = whatsappDevices.find(d => d.instanceName === selectedInstance);
            if (!device) return;
            
            selectedWhatsAppDevice = device;
            
            // Update info
            deviceInfo.innerHTML = `
                <span style="color: green; font-weight: 500;">âœ“ BaÄŸlÄ±</span> | 
                Telefon: <strong>${device.phoneNumber}</strong> | 
                OluÅŸturulma: ${device.createdBy}
            `;
            
            // Show messaging area
            messagingArea.style.display = 'block';
            
            // Load contacts for this device
            loadWhatsAppContacts();
        };
        
        window.switchWhatsAppTab = function(tabName) {
            // Hide all tabs
            document.querySelectorAll('#whatsapp .settings-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#whatsapp .settings-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`whatsapp-tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
            
            // Load data for tab
            if (tabName === 'devices') {
                loadWhatsAppDevicesMain();
            } else if (tabName === 'bulk') {
                loadBulkMessageForm();
            } else if (tabName === 'queue') {
                renderMessageQueue();
            } else if (tabName === 'reports') {
                loadMessageReports();
            }
        };

        // Yeni mesaj inline form fonksiyonlarÄ±
        window.toggleNewMessageForm = function() {
            const activeDevice = document.getElementById('whatsapp-active-device')?.value;
            if (!activeDevice) {
                showAlert('âš ï¸ Ã–nce bir WhatsApp cihazÄ± seÃ§in!', 'warning');
                return;
            }

            const form = document.getElementById('new-message-inline-form');
            const phoneInput = document.getElementById('new-message-phone-inline');
            const textArea = document.getElementById('new-message-text-area');
            const checkBtn = document.getElementById('check-phone-btn');
            const messageTextarea = document.getElementById('new-message-text-inline');

            if (form.style.display === 'none' || !form.style.display) {
                // Formu aÃ§
                form.style.display = 'block';
                phoneInput.value = '';
                messageTextarea.value = '';
                textArea.style.display = 'none';
                checkBtn.style.display = 'block';
                phoneInput.focus();
            } else {
                // Formu kapat
                form.style.display = 'none';
                phoneInput.value = '';
                messageTextarea.value = '';
                textArea.style.display = 'none';
                checkBtn.style.display = 'block';
            }
        };

        window.checkPhoneAndProceed = async function() {
            let phone = document.getElementById('new-message-phone-inline')?.value.trim();
            
            if (!phone) {
                showAlert('âš ï¸ LÃ¼tfen telefon numarasÄ± girin!', 'warning');
                return;
            }

            // 0 ile baÅŸlÄ±yorsa 90 yap
            if (phone.startsWith('0')) {
                phone = '90' + phone.substring(1);
            }

            // Numara formatÄ±nÄ± kontrol et (90 ile baÅŸlamalÄ±, toplam 12 hane)
            if (!/^90\d{10}$/.test(phone)) {
                showAlert('âš ï¸ GeÃ§ersiz telefon numarasÄ± formatÄ±! (05xxxxxxxxx veya 905xxxxxxxxx)', 'warning');
                return;
            }

            try {
                // Bu numarayla konuÅŸma var mÄ± kontrol et (global whatsappContacts kullan)
                const existingContact = whatsappContacts?.find(c => c.phone === phone);
                
                if (existingContact) {
                    // KonuÅŸma varsa, o konuÅŸmayÄ± aÃ§
                    
                    // Soldaki listede seÃ§ili yapma
                    document.querySelectorAll('.whatsapp-contact-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // Ä°lgili contact item'Ä± bul ve seÃ§ili yap
                    const contactItems = document.querySelectorAll('.whatsapp-contact-item');
                    contactItems.forEach(item => {
                        const itemPhone = item.getAttribute('data-phone');
                        if (itemPhone === existingContact.phone) {
                            item.classList.add('active');
                            item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    });
                    
                    // Global currentWhatsAppContact'Ä± gÃ¼ncelle
                    currentWhatsAppContact = {
                        phone: existingContact.phone,
                        name: existingContact.name,
                        type: existingContact.type || 'unknown',
                        memberId: existingContact.memberId,
                        leadId: existingContact.leadId
                    };
                    
                    // Header bilgilerini gÃ¼ncelle
                    const displayPhone = existingContact.phone.replace(/^90/, '0').replace(/(\d{4})(\d{3})(\d{2})(\d{2})/, '$1 $2 $3 $4');
                    
                    // Old header
                    const oldHeaderContact = document.getElementById('whatsapp-selected-contact');
                    const oldHeaderPhone = document.getElementById('whatsapp-selected-phone');
                    if (oldHeaderContact) oldHeaderContact.textContent = existingContact.name;
                    if (oldHeaderPhone) oldHeaderPhone.textContent = displayPhone;
                    
                    // New header
                    const newHeader = document.getElementById('whatsapp-messages-header');
                    const chatContactName = document.getElementById('chat-contact-name');
                    const chatContactPhone = document.getElementById('chat-contact-phone');
                    const chatContactInitial = document.getElementById('chat-contact-initial');
                    const chatContactBadge = document.getElementById('chat-contact-badge');
                    
                    if (newHeader) newHeader.style.display = 'block';
                    if (chatContactName) chatContactName.textContent = existingContact.name;
                    if (chatContactPhone) chatContactPhone.textContent = displayPhone;
                    if (chatContactInitial) {
                        const firstLetter = existingContact.name.trim().charAt(0).toUpperCase();
                        chatContactInitial.textContent = firstLetter;
                    }
                    
                    // Badge
                    if (chatContactBadge) {
                        if (existingContact.type === 'member') {
                            chatContactBadge.textContent = 'ÃœYE';
                            chatContactBadge.style.background = '#25D366';
                            chatContactBadge.style.display = 'inline';
                        } else if (existingContact.type === 'crm') {
                            chatContactBadge.textContent = 'CRM';
                            chatContactBadge.style.background = '#667eea';
                            chatContactBadge.style.display = 'inline';
                        } else {
                            chatContactBadge.style.display = 'none';
                        }
                    }
                    
                    // Message input gÃ¶rÃ¼nÃ¼r yap
                    const messageInput = document.getElementById('whatsapp-message-input');
                    if (messageInput) messageInput.style.display = 'block';
                    
                    // MesajlarÄ± yÃ¼kle
                    await loadMessagesForContact(existingContact.phone);
                    
                    showAlert('âœ… Mevcut konuÅŸma aÃ§Ä±ldÄ±', 'success');
                    toggleNewMessageForm(); // Formu kapat
                } else {
                    // Yeni konuÅŸma - mesaj textarea'sÄ±nÄ± gÃ¶ster
                    document.getElementById('new-message-text-area').style.display = 'block';
                    document.getElementById('check-phone-btn').style.display = 'none';
                    document.getElementById('new-message-text-inline').focus();
                    showAlert('ğŸ“ Yeni konuÅŸma - MesajÄ±nÄ±zÄ± yazÄ±n', 'info');
                }
            } catch (error) {
                console.error('KonuÅŸma kontrol hatasÄ±:', error);
                showAlert('âŒ Hata oluÅŸtu: ' + error.message, 'danger');
            }
        };

        window.sendNewMessageInline = async function() {
            let phone = document.getElementById('new-message-phone-inline')?.value.trim();
            const messageText = document.getElementById('new-message-text-inline')?.value.trim();

            if (!messageText) {
                showAlert('âš ï¸ LÃ¼tfen mesaj yazÄ±n!', 'warning');
                return;
            }

            // 0 ile baÅŸlÄ±yorsa 90 yap
            if (phone.startsWith('0')) {
                phone = '90' + phone.substring(1);
            }

            try {
                // selectedWhatsAppDevice kullan (global deÄŸiÅŸken)
                if (!selectedWhatsAppDevice) {
                    showAlert('âŒ Cihaz seÃ§ilmemiÅŸ', 'danger');
                    return;
                }

                // evolutionUrl veya EVOLUTION_API_URL kullan
                const apiUrl = selectedWhatsAppDevice.evolutionUrl || window.EVOLUTION_API_URL;
                const apiKey = selectedWhatsAppDevice.apiKey || window.EVOLUTION_API_KEY;
                
                if (!apiUrl) {
                    showAlert('âŒ API URL tanÄ±mlÄ± deÄŸil', 'danger');
                    console.error('selectedWhatsAppDevice:', selectedWhatsAppDevice);
                    return;
                }

                const endpoint = `${apiUrl}/message/sendText/${selectedWhatsAppDevice.instanceName}`;
                
                console.log('ğŸ“¤ Mesaj gÃ¶nderiliyor:', { 
                    endpoint, 
                    phone, 
                    messageText,
                    instanceName: selectedWhatsAppDevice.instanceName,
                    apiUrl 
                });
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'apikey': apiKey 
                    },
                    body: JSON.stringify({ 
                        number: phone + '@s.whatsapp.net',
                        text: messageText 
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Mesaj gÃ¶nderilemedi');
                }

                const result = await response.json();
                console.log('âœ… Mesaj gÃ¶nderildi:', result);

                showAlert('âœ… Mesaj gÃ¶nderildi!', 'success');
                toggleNewMessageForm(); // Formu kapat

                // KonuÅŸmalar listesini yenile
                setTimeout(() => {
                    loadWhatsAppContacts();
                }, 1000);
            } catch (error) {
                console.error('Mesaj gÃ¶nderme hatasÄ±:', error);
                showAlert('âŒ Mesaj gÃ¶nderilemedi: ' + error.message, 'danger');
            }
        };
        
        window.filterMessageReports = function() {
            loadMessageReports();
        };
        
        window.exportMessageReports = function() {
            alert('Excel indirme Ã¶zelliÄŸi yakÄ±nda eklenecek!');
        };
        
        window.clearMessageReports = async function() {
            if (!confirm('TÃ¼m mesaj raporlarÄ± silinecek. Emin misiniz?')) return;
            
            try {
                console.log('Deleting messages:', sentMessages.length);
                
                // Delete all messages from Firebase
                const { getDocs, collection, deleteDoc, doc } = window.firebase;
                const messagesSnapshot = await getDocs(collection(window.db, 'sentMessages'));
                
                const deletePromises = [];
                messagesSnapshot.forEach(docSnapshot => {
                    deletePromises.push(deleteDoc(docSnapshot.ref));
                });
                
                await Promise.all(deletePromises);
                
                // Clear local array
                sentMessages = [];
                
                // Reload reports
                loadMessageReports();
                showAlert(`${deletePromises.length} mesaj raporu silindi!`, 'success');
            } catch (error) {
                console.error('Error clearing reports:', error);
                showAlert('Raporlar temizlenirken hata oluÅŸtu: ' + error.message, 'danger');
            }
        };
        
        function loadMessageReports() {
            const statusFilter = document.getElementById('report-filter-status')?.value || 'all';
            const dateFilter = document.getElementById('report-filter-date')?.value;
            
            let filtered = [...sentMessages];
            
            // Filter by status
            if (statusFilter === 'success') {
                filtered = filtered.filter(m => m.success === true);
            } else if (statusFilter === 'failed') {
                filtered = filtered.filter(m => m.success === false);
            } else if (statusFilter === 'pending') {
                filtered = filtered.filter(m => m.success === undefined || m.success === null);
            }
            
            // Filter by date
            if (dateFilter) {
                filtered = filtered.filter(m => m.sentAt?.startsWith(dateFilter));
            }
            
            // Sort by date (newest first)
            filtered.sort((a, b) => new Date(b.sentAt) - new Date(a.sentAt));
            
            // Update statistics
            const successCount = sentMessages.filter(m => m.success === true).length;
            const failedCount = sentMessages.filter(m => m.success === false).length;
            
            // âœ… BEKLEYEN MESAJLARI messageQueue'dan al (sentMessages'ta deÄŸil!)
            let pendingCount = 0;
            
            // messageQueue'daki pending mesajlarÄ± say
            const loadPendingCount = async () => {
                try {
                    const messagesRef = window.firebase.collection(window.db, 'messageQueue');
                    const pendingQuery = window.firebase.query(
                        messagesRef,
                        window.firebase.where('clubId', '==', currentClubId),
                        window.firebase.where('status', '==', 'pending')
                    );
                    const pendingSnapshot = await window.firebase.getDocs(pendingQuery);
                    pendingCount = pendingSnapshot.size;
                    
                    // âœ… Toplam = BaÅŸarÄ±lÄ± + BaÅŸarÄ±sÄ±z + Bekleyen
                    const totalCount = successCount + failedCount + pendingCount;
                    
                    // Update UI
                    document.getElementById('report-success-count').textContent = successCount;
                    document.getElementById('report-failed-count').textContent = failedCount;
                    document.getElementById('report-pending-count').textContent = pendingCount;
                    document.getElementById('report-total-count').textContent = totalCount;
                } catch (error) {
                    console.error('Bekleyen mesaj sayÄ±sÄ± alÄ±namadÄ±:', error);
                    // Hata durumunda bekleyen 0, toplam = baÅŸarÄ±lÄ± + baÅŸarÄ±sÄ±z
                    const totalCount = successCount + failedCount;
                    document.getElementById('report-success-count').textContent = successCount;
                    document.getElementById('report-failed-count').textContent = failedCount;
                    document.getElementById('report-pending-count').textContent = 0;
                    document.getElementById('report-total-count').textContent = totalCount;
                }
            };
            
            loadPendingCount();
            
            // Render table
            const tbody = document.getElementById('message-reports-table');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Mesaj raporu bulunamadÄ±</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map((msg, index) => {
                const statusBadge = msg.success === true 
                    ? '<span class="badge bg-success">âœ… GÃ¶nderildi</span>'
                    : msg.success === false
                    ? '<span class="badge bg-danger">âŒ BaÅŸarÄ±sÄ±z</span>'
                    : '<span class="badge bg-warning">â³ Bekliyor</span>';
                
                const shortMessage = msg.message?.length > 50 
                    ? msg.message.substring(0, 50) + '...' 
                    : msg.message;
                
                return `
                    <tr>
                        <td>${formatDate(msg.sentAt)}</td>
                        <td>${msg.recipient || '-'}</td>
                        <td>${msg.recipientPhone || '-'}</td>
                        <td><span style="cursor: pointer;" onclick="showMessageDetail(${sentMessages.indexOf(msg)})" title="${escapeHtml(msg.message)}">${shortMessage}</span></td>
                        <td><small>${msg.instanceName || '-'}</small></td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="showMessageDetail(${sentMessages.indexOf(msg)})">ğŸ‘ï¸</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        async function loadWhatsAppContacts() {
            whatsappContacts = [];
            
            console.log('ğŸ“± Loading WhatsApp contacts from Evolution API...');
            
            // âœ… Otomatik cihaz seÃ§imi (eÄŸer henÃ¼z seÃ§ilmemiÅŸse)
            if (!selectedWhatsAppDevice && defaultWhatsAppDevice && whatsappDevices.length > 0) {
                const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
                const defaultDevice = connectedDevices.find(d => d.instanceName === defaultWhatsAppDevice);
                
                if (defaultDevice) {
                    selectedWhatsAppDevice = defaultDevice; // âœ… FIX: Obje atanmalÄ±, string deÄŸil!
                    console.log('âœ… Ana WhatsApp cihazÄ± otomatik seÃ§ildi:', defaultWhatsAppDevice);
                    
                    // Dropdown'Ä± gÃ¼ncelle
                    const deviceSelect = document.getElementById('whatsapp-device-selector');
                    if (deviceSelect) {
                        deviceSelect.value = defaultWhatsAppDevice;
                    }
                    
                    // MesajlaÅŸma alanÄ±nÄ± gÃ¶ster
                    const messagingArea = document.getElementById('whatsapp-messaging-area');
                    if (messagingArea) {
                        messagingArea.style.display = 'block';
                    }
                }
            }
            
            if (!selectedWhatsAppDevice) {
                console.warn('âš ï¸ No device selected');
                renderWhatsAppContactsList();
                return;
            }
            
            try {
                // âœ… selectedWhatsAppDevice artÄ±k bir obje (device object)
                const device = selectedWhatsAppDevice;
                
                if (!device || !device.instanceName) {
                    console.error('âŒ Device not valid:', selectedWhatsAppDevice);
                    renderWhatsAppContactsList();
                    return;
                }
                
                const evolutionUrl = device.evolutionUrl || EVOLUTION_API_URL;
                const apiKey = device.apiKey || EVOLUTION_API_KEY;
                
                const response = await fetch(`${evolutionUrl}/chat/findChats/${device.instanceName}`, {
                    method: 'POST',
                    headers: {
                        'apikey': apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        where: {}
                    })
                });
                
                if (response.ok) {
                    const chats = await response.json();
                    console.log(`âœ… Evolution API'den ${chats.length} sohbet yÃ¼klendi`);
                    
                    // Debug: Show first chat object structure
                    if (chats.length > 0) {
                    console.log('ğŸ” Ä°lk chat objesi yapÄ±sÄ±:', chats[0]);
                    console.log('ğŸ” Ä°lk 5 chat ID Ã¶rneÄŸi:', chats.slice(0, 5).map(c => c.id));
                        if (chats[0].lastMessage) {
                            console.log('ğŸ” Ä°lk lastMessage yapÄ±sÄ±:', chats[0].lastMessage);
                            console.log('  - fromMe:', chats[0].lastMessage.key?.fromMe);
                            console.log('  - messageTimestamp:', chats[0].lastMessage.messageTimestamp);
                        }
                    }
                    
                    let skippedGroups = 0;
                    let skippedInvalid = 0;
                    let processedPhones = 0;
                    
                    // Process each chat
                    for (const chat of chats) {
                        // Use remoteJid instead of id for phone number
                        const remoteJid = chat.remoteJid || chat.id;
                        
                        if (!remoteJid || remoteJid.includes('@g.us') || remoteJid.includes('@broadcast')) {
                            skippedGroups++;
                            continue; // Skip groups and broadcasts
                        }
                        
                        // Extract phone number from remoteJid
                        let phone = remoteJid.replace('@s.whatsapp.net', '').replace('@c.us', '').replace('@lid', '');
                        
                        // Check if this is a phone number (should only contain digits and optional leading +)
                        // Skip if contains letters (newsletters, special IDs, etc.)
                        const originalPhone = phone;
                        if (/[a-zA-Z]/.test(originalPhone)) {
                            // Contains letters, not a phone number - skip silently
                            skippedInvalid++;
                            continue;
                        }
                        
                        // Remove all non-digits
                        phone = phone.replace(/\D/g, '');
                        
                        // Skip if too short (not a valid phone)
                        if (phone.length < 10) {
                            skippedInvalid++;
                            continue; // Skip silently
                        }
                        
                        // Fix phone format for Turkish numbers
                        if (phone.startsWith('0') && phone.length === 11) {
                            // 05449367543 â†’ 905449367543
                            phone = '90' + phone.substring(1);
                        } else if (!phone.startsWith('90') && phone.length === 10) {
                            // 5449367543 â†’ 905449367543
                            phone = '90' + phone;
                        } else if (phone.startsWith('90') && phone.length === 12) {
                            // Already correct: 905449367543
                            // Do nothing
                        } else if (phone.length >= 10 && phone.length <= 15) {
                            // International number - keep as is
                            console.log(`ğŸŒ International number detected: ${phone}`);
                        } else {
                            // Invalid length
                            skippedInvalid++;
                            continue;
                        }
                        
                        // More flexible validation - accept any phone with 10-15 digits
                        if (phone.length < 10 || phone.length > 15) {
                            skippedInvalid++;
                            continue;
                        }
                        
                        processedPhones++;
                        
                        // Get contact name from Evolution API or use phone number
                        let contactName = chat.name || chat.pushName || phone;
                        
                        // Check if contact exists in members/CRM
                        const member = members.find(m => {
                            const memberPhone = formatPhoneForWhatsApp(m.Telefon || m.phone || '');
                            const memberPhone2 = formatPhoneForWhatsApp(m.Telefon_2 || m.phone2 || '');
                            return memberPhone === phone || memberPhone2 === phone;
                        });
                        
                        const crmLead = crmLeads.find(l => {
                            const leadPhone = formatPhoneForWhatsApp(l.phone || '');
                            return leadPhone === phone;
                        });
                        
                        // Determine contact type and name
                        let type = 'unknown';
                        let extraData = {};
                        
                        // âœ… YÃ¶netici kontrolÃ¼ ekle
                        const user = users.find(u => {
                            const userPhone = formatPhoneForWhatsApp(u.phone || u.phoneNumber || '');
                            return userPhone === phone;
                        });
                        
                        if (member) {
                            contactName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad || contactName;
                            type = 'member';
                            extraData.memberId = member.id;
                        } else if (user) {
                            contactName = user.fullName || user.email || contactName;
                            type = 'user';
                            extraData.userId = user.id;
                        } else if (crmLead) {
                            contactName = crmLead.name || contactName;
                            type = 'crm';
                            extraData.leadId = crmLead.id;
                        }
                        
                        // Get last message info
                        const lastMessage = chat.lastMessage || {};
                        const lastMessageTime = lastMessage.messageTimestamp 
                            ? new Date(lastMessage.messageTimestamp * 1000) 
                            : new Date(0);
                        
                        // Extract message text
                        let lastMessageText = '';
                        if (lastMessage.message) {
                            lastMessageText = lastMessage.message?.conversation || 
                                            lastMessage.message?.extendedTextMessage?.text || 
                                            lastMessage.message?.imageMessage?.caption ||
                                            (lastMessage.message?.imageMessage ? 'ğŸ“· FotoÄŸraf' : '') ||
                                            (lastMessage.message?.videoMessage ? 'ğŸ¥ Video' : '') ||
                                            (lastMessage.message?.audioMessage ? 'ğŸµ Ses' : '') ||
                                            (lastMessage.message?.documentMessage ? 'ğŸ“„ Dosya' : '') ||
                                            (lastMessage.message?.stickerMessage ? 'ğŸ¨ Sticker' : '') ||
                                            '';
                        }
                        
                        // Check if message is from me
                        const fromMe = lastMessage.key?.fromMe === true || lastMessage.fromMe === true;
                        
                        whatsappContacts.push({
                            name: contactName,
                            phone: phone,
                            type: type,
                            lastMessage: lastMessageText,
                            lastMessageFromMe: fromMe,
                            lastMessageTime: lastMessageTime,
                            unreadCount: chat.unreadCount || 0,
                            instanceName: device.instanceName || device.name,
                            ...extraData
                        });
                    }
                    
                    // Sort by last message time (newest first)
                    whatsappContacts.sort((a, b) => b.lastMessageTime - a.lastMessageTime);
                    
                    console.log(`ğŸ“Š Ä°ÅŸlem Ã–zeti: ${chats.length} sohbet yÃ¼klendi â†’ ${skippedGroups} grup atlandÄ±, ${skippedInvalid} geÃ§ersiz atlandÄ±, ${processedPhones} telefon iÅŸlendi`);
                    console.log(`ğŸ“Š Toplam ${whatsappContacts.length} konuÅŸma (${whatsappContacts.filter(c => c.type === 'member').length} Ã¼ye, ${whatsappContacts.filter(c => c.type === 'crm').length} CRM, ${whatsappContacts.filter(c => c.type === 'unknown').length} diÄŸer)`);
                } else {
                    console.error('âŒ Evolution API chat fetch failed:', response.status);
                }
            } catch (error) {
                console.error('âŒ Error fetching chats from Evolution API:', error);
            }
            
            // âœ… Ä°lk yÃ¼klemede okunmamÄ±ÅŸ mesaj varsa bildirim gÃ¶ster
            const currentUnreadCount = whatsappContacts.reduce((sum, c) => sum + (c.unreadCount || 0), 0);
            
            if (lastWhatsAppUnreadCount === -1) {
                // Ä°lk yÃ¼kleme
                lastWhatsAppUnreadCount = currentUnreadCount;
                console.log(`ğŸ“Š Ä°lk yÃ¼kleme: ${currentUnreadCount} okunmamÄ±ÅŸ WhatsApp mesajÄ± tespit edildi`);
                
                // EÄŸer okunmamÄ±ÅŸ mesaj varsa bildirim gÃ¶ster
                if (currentUnreadCount > 0) {
                    console.log(`ğŸ”” Ä°lk yÃ¼kleme bildirimi: ${currentUnreadCount} okunmamÄ±ÅŸ mesaj mevcut`);
                    
                    // En son mesajÄ± olan contact'Ä± bul
                    const latestContact = whatsappContacts
                        .filter(c => c.unreadCount > 0)
                        .sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0))[0];
                    
                    if (latestContact) {
                        const sender = latestContact.name || formatPhoneDisplay(latestContact.phone);
                        const messagePreview = latestContact.lastMessage || '';
                        await showWhatsAppMessageNotification(currentUnreadCount, sender, messagePreview, latestContact.instanceName);
                    } else {
                        await showWhatsAppMessageNotification(currentUnreadCount);
                    }
                }
            }
            
            renderWhatsAppContactsList();
        }
        
        function renderWhatsAppContactsList(searchTerm = '') {
            const container = document.getElementById('whatsapp-contacts-list');
            
            let filtered = whatsappContacts;
            if (searchTerm) {
                const searchNoSpaces = searchTerm.replace(/\s/g, '');
                filtered = whatsappContacts.filter(c => 
                    c.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    c.phone.includes(searchTerm) ||
                    c.phone.replace(/\s/g, '').includes(searchNoSpaces)
                );
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p class="empty-state" style="padding: 20px; text-align: center; color: #666;">KiÅŸi bulunamadÄ±</p>';
                return;
            }
            
            container.innerHTML = filtered.map(contact => {
                const safeName = (contact.name || 'Ä°simsiz').replace(/'/g, "\\'");
                let displayName = contact.name || 'Ä°simsiz';
                const displayPhone = formatPhoneDisplay(contact.phone);
                
                // âœ… Ãœye, CRM mÃ¼ÅŸterileri ve YÃ¶neticiler iÃ§in Ad - Soyad formatÄ±nda gÃ¶ster
                if (contact.type === 'member' && contact.memberId) {
                    const member = members.find(m => m.id === contact.memberId);
                    if (member) {
                        const firstName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad || '';
                        const nameParts = firstName.trim().split(/\s+/);
                        if (nameParts.length >= 2) {
                            displayName = `${nameParts[0]} - ${nameParts.slice(1).join(' ')}`;
                        } else {
                            displayName = firstName;
                        }
                    }
                } else if (contact.type === 'user' && contact.userId) {
                    // âœ… YÃ¶neticiler de Ad - Soyad formatÄ±nda
                    const user = users.find(u => u.id === contact.userId);
                    if (user && user.fullName) {
                        const nameParts = user.fullName.trim().split(/\s+/);
                        if (nameParts.length >= 2) {
                            displayName = `${nameParts[0]} - ${nameParts.slice(1).join(' ')}`;
                        } else {
                            displayName = user.fullName;
                        }
                    }
                } else if (contact.type === 'crm' && contact.leadId) {
                    // âœ… CRM mÃ¼ÅŸterileri de Ad - Soyad formatÄ±nda
                    const lead = crmLeads.find(l => l.id === contact.leadId);
                    if (lead && lead.fullName) {
                        const nameParts = lead.fullName.trim().split(/\s+/);
                        if (nameParts.length >= 2) {
                            displayName = `${nameParts[0]} - ${nameParts.slice(1).join(' ')}`;
                        } else {
                            displayName = lead.fullName;
                        }
                    }
                }
                
                const firstLetter = displayName.charAt(0).toUpperCase();
                
                // Contact type styling
                let avatarColor = '#25D366'; // Default green
                let statusBadge = '';
                let actionButton = '';
                let crmTagBadge = ''; // âœ… CRM etiketi
                
                if (contact.type === 'member') {
                    avatarColor = '#128C7E';
                    statusBadge = '<span style="font-size: 10px; background: #25D366; color: white; padding: 2px 6px; border-radius: 10px; margin-left: 5px;">Ãœye</span>';
                    actionButton = `<button onclick="event.stopPropagation(); window.location.hash='members'; setTimeout(() => showMemberAttendancePage('${contact.memberId}'), 100);" style="padding: 4px 8px; font-size: 11px; background: #128C7E; color: white; border: none; border-radius: 4px; cursor: pointer;">GÃ¶rÃ¼ntÃ¼le</button>`;
                    
                    // âœ… CRM'de etiket var mÄ± kontrol et
                    const crmLead = crmLeads.find(l => phonesMatch(l.phone, contact.phone));
                    if (crmLead && crmLead.branches && crmLead.branches.length > 0) {
                        // TÃ¼m branÅŸlarÄ±n etiketlerini topla
                        const tags = crmLead.branches
                            .map(b => b.selectedTag)
                            .filter(tag => tag && tag !== 'Yok')
                            .join(', ');
                        if (tags) {
                            crmTagBadge = `<div style="font-size: 10px; color: #667eea; margin-top: 2px;">ğŸ·ï¸ ${tags}</div>`;
                        }
                    }
                } else if (contact.type === 'user') {
                    avatarColor = '#9C27B0';
                    statusBadge = '<span style="font-size: 10px; background: #9C27B0; color: white; padding: 2px 6px; border-radius: 10px; margin-left: 5px;">YÃ¶netici</span>';
                    actionButton = `<button onclick="event.stopPropagation();" style="padding: 4px 8px; font-size: 11px; background: #9C27B0; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ‘¤ YÃ¶netici</button>`;
                } else if (contact.type === 'crm') {
                    avatarColor = '#FFA500';
                    statusBadge = '<span style="font-size: 10px; background: #FFA500; color: white; padding: 2px 6px; border-radius: 10px; margin-left: 5px;">CRM</span>';
                    actionButton = `<button onclick="event.stopPropagation(); openCrmLeadDetail('${contact.leadId}');" style="padding: 4px 8px; font-size: 11px; background: #FFA500; color: white; border: none; border-radius: 4px; cursor: pointer;">GÃ¶rÃ¼ntÃ¼le</button>`;
                    
                    // âœ… CRM etiketlerini gÃ¶ster
                    const crmLead = crmLeads.find(l => l.id === contact.leadId);
                    if (crmLead && crmLead.branches && crmLead.branches.length > 0) {
                        const tags = crmLead.branches
                            .map(b => b.selectedTag)
                            .filter(tag => tag && tag !== 'Yok')
                            .join(', ');
                        if (tags) {
                            crmTagBadge = `<div style="font-size: 10px; color: #667eea; margin-top: 2px;">ğŸ·ï¸ ${tags}</div>`;
                        }
                    }
                } else {
                    avatarColor = '#9E9E9E';
                    actionButton = `<button onclick="event.stopPropagation(); addToCRM('${contact.phone}', '${safeName}');" style="padding: 4px 8px; font-size: 11px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">+ CRM'e Ekle</button>`;
                }
                
                // Last message preview
                let lastMsgPreview = '';
                if (contact.lastMessage) {
                    // EÄŸer mesaj benden gÃ¶nderildiyse "Sen: " prefix'i ekle
                    const messagePrefix = contact.lastMessageFromMe ? 'âœ“ Sen: ' : '';
                    const messageText = contact.lastMessage.substring(0, 35) + (contact.lastMessage.length > 35 ? '...' : '');
                    
                    // OkunmamÄ±ÅŸ mesajlarÄ± bold yap
                    const textStyle = contact.unreadCount > 0 ? 'font-weight: 600; color: #111;' : 'color: #667781;';
                    
                    lastMsgPreview = `<div style="font-size: 12px; ${textStyle} margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${messagePrefix}${messageText}</div>`;
                }
                
                // Time display
                const timeDisplay = contact.lastMessageTime && contact.lastMessageTime.getTime() > 0
                    ? formatTimeAgo(contact.lastMessageTime)
                    : '';
                
                // Unread badge
                const unreadBadge = contact.unreadCount > 0 
                    ? `<span style="background: #25D366; color: white; border-radius: 50%; min-width: 20px; height: 20px; padding: 0 6px; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold;">${contact.unreadCount}</span>`
                    : '';
                
                return `
                    <div class="whatsapp-contact-item ${currentWhatsAppContact?.phone === contact.phone ? 'active' : ''}" 
                         data-phone="${contact.phone}"
                         onclick="selectWhatsAppContact('${contact.phone}', '${safeName}', ${JSON.stringify(contact).replace(/"/g, '&quot;')})"
                         style="padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.2s;"
                         onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=this.classList.contains('active')?'#E8F5E9':'white'">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 50px; height: 50px; border-radius: 50%; background: ${avatarColor}; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; font-weight: bold; flex-shrink: 0;">
                                ${firstLetter}
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: ${contact.unreadCount > 0 ? '600' : '500'}; color: #111; font-size: 15px;">${displayName} ${statusBadge}</div>
                                        <div style="font-size: 11px; color: #999; margin-top: 1px;">${displayPhone}</div>
                                        ${crmTagBadge}
                                    </div>
                                    <div style="font-size: 11px; color: ${contact.unreadCount > 0 ? '#25D366' : '#667781'}; font-weight: ${contact.unreadCount > 0 ? '600' : 'normal'};">${timeDisplay}</div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                                    <div style="flex: 1; min-width: 0;">${lastMsgPreview}</div>
                                    ${unreadBadge}
                                </div>
                                <div style="margin-top: 6px;">${actionButton}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (seconds < 60) return 'Åimdi';
            if (minutes < 60) return `${minutes} dk`;
            if (hours < 24) return `${hours} sa`;
            if (days < 7) return `${days} gÃ¼n`;
            return date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
        }
        
        window.addToCRM = async function(phone, name) {
            // Telefonu formatla (05xxx formatÄ±na)
            const cleanPhone = phone.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            console.log(`ğŸ“ CRM'e ekleniyor: ${name} - Telefon: ${phone} â†’ ${formattedPhone}`);
            
            // Yeni potansiyel mÃ¼ÅŸteri modalÄ±nÄ± aÃ§
            openAddLeadModal();
            
            // Verileri doldur
            setTimeout(() => {
                const nameInput = document.querySelector('#addLeadModal input[name="name"]');
                const phoneInput = document.querySelector('#addLeadModal input[name="phone"]');
                if (nameInput) nameInput.value = name || '';
                if (phoneInput) {
                    phoneInput.value = formattedPhone;
                    // Telefon kontrolÃ¼nÃ¼ tetikle
                    phoneInput.dispatchEvent(new Event('blur'));
                }
                
                showAlert(`ğŸ“ CRM formu ${name} iÃ§in hazÄ±rlandÄ±`, 'success');
            }, 300);
        };
        
        // WhatsApp notification sound - Web Audio API ile basit bir bildirim sesi oluÅŸtur
        let audioContext = null;
        let whatsappNotificationSound = null;
        
        function createNotificationSound() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                return audioContext;
            } catch (e) {
                console.warn('AudioContext desteklenmiyor:', e);
                return null;
            }
        }
        
        async function playNotificationSound() {
            try {
                const ctx = createNotificationSound();
                if (!ctx) {
                    console.warn('Ses Ã§alÄ±namÄ±yor - AudioContext yok');
                    return;
                }
                
                // AudioContext suspended ise resume et
                if (ctx.state === 'suspended') {
                    await ctx.resume();
                }
                
                // Hala suspended ise ses Ã§alamazsÄ±n (kullanÄ±cÄ± etkileÅŸimi gerekli)
                if (ctx.state !== 'running') {
                    console.log('â„¹ï¸ Ses Ã§almak iÃ§in kullanÄ±cÄ± etkileÅŸimi gerekli (ilk tÄ±klamadan sonra Ã§alÄ±ÅŸacak)');
                    return;
                }
                
                // Basit bir bildirim sesi oluÅŸtur (beep)
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                // Ses ayarlarÄ±
                oscillator.frequency.value = 800; // Frekans (Hz)
                oscillator.type = 'sine'; // SinÃ¼s dalgasÄ±
                
                // Ses seviyesi
                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                
                // Sesi Ã§al
                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + 0.5);
                
                console.log('âœ… Bildirim sesi Ã§alÄ±ndÄ±');
            } catch (e) {
                console.log('â„¹ï¸ Ses Ã§alÄ±namadÄ± (kullanÄ±cÄ± etkileÅŸimi sonrasÄ± Ã§alÄ±ÅŸacak):', e.message);
            }
        }
        
        // Ses izni iste
        let audioPermissionGranted = false;
        
        async function requestAudioPermission() {
            if (audioPermissionGranted) {
                return true; // Zaten verilmiÅŸ
            }
            
            try {
                // AudioContext'i baÅŸlat
                const ctx = createNotificationSound();
                if (ctx && ctx.state === 'suspended') {
                    await ctx.resume();
                }
                audioPermissionGranted = true;
                console.log('âœ… Ses izni verildi');
                showAlert('âœ… Ses izni verildi', 'success');
                return true;
            } catch (e) {
                console.warn('âš ï¸ Ses izni verilmedi:', e);
                audioPermissionGranted = false;
                return false;
            }
        }
        
        // Ses testi fonksiyonu
        window.testWhatsAppSound = async function() {
            try {
                await playNotificationSound();
                audioPermissionGranted = true;
                console.log('âœ… WhatsApp bildirim sesi Ã§alÄ±ndÄ±');
                showAlert('ğŸ”” WhatsApp bildirim sesi Ã§alÄ±ndÄ±!', 'success', 2000);
            } catch (e) {
                console.error('âŒ Ses Ã§alÄ±namadÄ±:', e);
                showAlert('âŒ Ses Ã§alÄ±namadÄ±: ' + e.message + '\n\nTarayÄ±cÄ±nÄ±zÄ±n ses ayarlarÄ±nÄ± kontrol edin.', 'danger', 4000);
                audioPermissionGranted = false;
            }
        };
        
        // Sayfa yÃ¼klendiÄŸinde ses izni kontrolÃ¼
        window.checkAndRequestAudioPermission = async function() {
            console.log('ğŸ”Š Ses izni hazÄ±r');
            // Ä°lk kullanÄ±cÄ± etkileÅŸiminde AudioContext baÅŸlatÄ±lacak
        };
        
        // Bildirim panelini gÃ¼ncelle
        window.updateNotificationPanel = function() {
            const statusText = document.getElementById('notification-status');
            const permissionBtn = document.getElementById('request-permission-btn');
            const panel = document.getElementById('whatsapp-notification-panel');
            
            if (!statusText || !permissionBtn || !panel) return;
            
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    panel.style.borderColor = '#4CAF50';
                    panel.style.background = '#e8f5e9';
                    statusText.innerHTML = 'âœ… Bildirimler aktif! Yeni mesajlardan haberdar olacaksÄ±nÄ±z.';
                    statusText.style.color = '#2e7d32';
                    permissionBtn.style.display = 'none'; // Ä°zin butonu gizle
                } else if (Notification.permission === 'denied') {
                    panel.style.borderColor = '#f44336';
                    panel.style.background = '#ffebee';
                    statusText.innerHTML = 'âŒ Bildirim izni reddedildi. TarayÄ±cÄ± ayarlarÄ±ndan izin vermeniz gerekiyor.';
                    statusText.style.color = '#c62828';
                    permissionBtn.textContent = 'âš™ï¸ Ayarlar';
                    permissionBtn.onclick = () => {
                        alert('Bildirim izni tarayÄ±cÄ± ayarlarÄ±ndan verilmelidir:\n\n1. TarayÄ±cÄ±nÄ±zÄ±n adres Ã§ubuÄŸundaki kilit simgesine tÄ±klayÄ±n\n2. "Site ayarlarÄ±" veya "Ä°zinler" bÃ¶lÃ¼mÃ¼ne gidin\n3. "Bildirimler" iznini "Ä°zin ver" olarak ayarlayÄ±n\n4. SayfayÄ± yenileyin');
                    };
                } else {
                    // default - izin istenmemiÅŸ
                    permissionBtn.style.display = 'inline-block';
                }
            } else {
                statusText.innerHTML = 'âš ï¸ TarayÄ±cÄ±nÄ±z bildirimleri desteklemiyor.';
                permissionBtn.style.display = 'none';
            }
        };
        
        // Bildirim izni iste
        window.requestNotificationPermission = async function() {
            if (!('Notification' in window)) {
                showAlert('âš ï¸ TarayÄ±cÄ±nÄ±z bildirimlarÄ± desteklemiyor.', 'warning');
                return false;
            }
            
            if (Notification.permission === 'granted') {
                showAlert('âœ… Bildirim izni zaten verilmiÅŸ!', 'success', 2000);
                // Paneli gÃ¼ncelle
                if (window.updateNotificationPanel) updateNotificationPanel();
                return true;
            }
            
            if (Notification.permission === 'denied') {
                showAlert('âŒ Bildirim izni reddedilmiÅŸ. LÃ¼tfen tarayÄ±cÄ± ayarlarÄ±ndan izin verin.', 'danger', 5000);
                // Paneli gÃ¼ncelle
                if (window.updateNotificationPanel) updateNotificationPanel();
                return false;
            }
            
            try {
                console.log('ğŸ”” Bildirim izni isteniyor...');
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    console.log('âœ… Bildirim izni verildi');
                    showAlert('âœ… Bildirim izni baÅŸarÄ±yla verildi!', 'success', 2000);
                    // Paneli gÃ¼ncelle
                    if (window.updateNotificationPanel) updateNotificationPanel();
                    return true;
                } else {
                    console.log('âŒ Bildirim izni reddedildi');
                    showAlert('âŒ Bildirim izni reddedildi', 'warning');
                    // Paneli gÃ¼ncelle
                    if (window.updateNotificationPanel) updateNotificationPanel();
                    return false;
                }
            } catch (error) {
                console.error('Bildirim izni hatasÄ±:', error);
                showAlert('âŒ Bildirim izni alÄ±namadÄ±: ' + error.message, 'danger');
                return false;
            }
        };
        
        // Global variables for live updates
        let whatsappAutoRefreshInterval = null;
        let lastContactsCount = 0;
        
        // Gelen aramalar otomatik yenileme
        let incomingCallsAutoRefreshInterval = null;
        let lastIncomingCallsData = null;
        
        // Gelen aramalar otomatik yenileme baÅŸlat
        function startIncomingCallsAutoRefresh() {
            // EÄŸer zaten Ã§alÄ±ÅŸÄ±yorsa durdur
            if (incomingCallsAutoRefreshInterval) {
                clearInterval(incomingCallsAutoRefreshInterval);
            }
            
            console.log('ğŸ”„ Gelen aramalar otomatik yenileme baÅŸlatÄ±ldÄ± (2 dakika)');
            
            incomingCallsAutoRefreshInterval = setInterval(async () => {
                // Sadece gelen aramalar sekmesi aÃ§Ä±ksa yenile
                const container = document.getElementById('incoming-calls-list');
                if (!container || container.offsetParent === null) {
                    // Sayfa gÃ¶rÃ¼nÃ¼r deÄŸil, yenileme yapmayalÄ±m
                    return;
                }
                
                console.log('ğŸ“ Gelen aramalar arka planda yenileniyor...');
                
                try {
                    // Mevcut veriyi kaydet
                    const oldData = window.incomingCallsCategories ? JSON.stringify(window.incomingCallsCategories) : null;
                    
                    // Yenile
                    await renderIncomingCallsPage();
                    
                    // Yeni veriyi kontrol et
                    const newData = window.incomingCallsCategories ? JSON.stringify(window.incomingCallsCategories) : null;
                    
                    // DeÄŸiÅŸiklik varsa bildir
                    if (oldData && newData && oldData !== newData) {
                        console.log('âœ… Gelen aramalarda deÄŸiÅŸiklik tespit edildi, liste gÃ¼ncellendi');
                        
                        // KÄ±sa bir bildirim gÃ¶ster (opsiyonel)
                        const notification = document.createElement('div');
                        notification.style.cssText = 'position: fixed; top: 70px; right: 20px; background: #4CAF50; color: white; padding: 10px 20px; border-radius: 8px; z-index: 10000; animation: fadeIn 0.3s;';
                        notification.textContent = 'ğŸ”„ Gelen aramalar gÃ¼ncellendi';
                        document.body.appendChild(notification);
                        
                        setTimeout(() => {
                            notification.style.opacity = '0';
                            notification.style.transition = 'opacity 0.5s';
                            setTimeout(() => notification.remove(), 500);
                        }, 2000);
                    }
                } catch (error) {
                    console.error('âŒ Gelen aramalar otomatik yenileme hatasÄ±:', error);
                }
            }, 120000); // 2 dakikada bir (120 saniye)
        }
        
        // Gelen aramalar otomatik yenileme durdur
        function stopIncomingCallsAutoRefresh() {
            if (incomingCallsAutoRefreshInterval) {
                clearInterval(incomingCallsAutoRefreshInterval);
                incomingCallsAutoRefreshInterval = null;
                console.log('â¸ï¸ Gelen aramalar otomatik yenileme durduruldu');
            }
        }
        
        window.startIncomingCallsAutoRefresh = startIncomingCallsAutoRefresh;
        window.stopIncomingCallsAutoRefresh = stopIncomingCallsAutoRefresh;
        
        // Start auto-refresh when WhatsApp section is opened
        function startWhatsAppAutoRefresh() {
            if (whatsappAutoRefreshInterval) {
                clearInterval(whatsappAutoRefreshInterval);
            }
            
            whatsappAutoRefreshInterval = setInterval(async () => {
                const oldContacts = [...whatsappContacts];
                const oldContactsCount = whatsappContacts.length;
                
                // Toplam okunmamÄ±ÅŸ mesaj sayÄ±sÄ±nÄ± hesapla (Ã¶nceki)
                const oldTotalUnread = oldContacts.reduce((sum, c) => sum + (c.unreadCount || 0), 0);
                
                await loadWhatsAppContacts();
                
                // Toplam okunmamÄ±ÅŸ mesaj sayÄ±sÄ±nÄ± hesapla (yeni)
                const newTotalUnread = whatsappContacts.reduce((sum, c) => sum + (c.unreadCount || 0), 0);
                
                // Yeni mesaj geldi mi kontrol et (yeni kiÅŸi veya okunmamÄ±ÅŸ artÄ±ÅŸÄ±)
                const hasNewMessage = whatsappContacts.length > oldContactsCount || newTotalUnread > oldTotalUnread;
                
                // Play notification sound if new messages detected
                if (hasNewMessage) {
                    try {
                        const newMessagesCount = Math.max(1, newTotalUnread - oldTotalUnread);
                        console.log(`ğŸ”” Yeni mesaj bildirimi! (+${newMessagesCount} okunmamÄ±ÅŸ mesaj)`);
                        
                        // En son mesaj gelen contact'Ä± bul
                        const latestContact = whatsappContacts
                            .filter(c => c.unreadCount > 0)
                            .sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0))[0];
                        
                        if (latestContact) {
                            const sender = latestContact.name || formatPhoneDisplay(latestContact.phone);
                            const messagePreview = latestContact.lastMessage || '';
                            // Show WhatsApp notification with details
                            await showWhatsAppMessageNotification(newMessagesCount, sender, messagePreview, latestContact.instanceName);
                        } else {
                            // Fallback if no contact found
                            await showWhatsAppMessageNotification(newMessagesCount);
                        }
                    } catch (e) {
                        console.log('Bildirim sesi Ã§alÄ±namadÄ±:', e);
                    }
                }
                
                // Refresh current chat if open
                if (currentWhatsAppContact) {
                    const currentPhone = currentWhatsAppContact.phone;
                    const updatedContact = whatsappContacts.find(c => c.phone === currentPhone);
                    if (updatedContact && updatedContact.unreadCount > 0) {
                        // Silently reload messages
                        await loadMessagesForContact(currentPhone);
                    }
                }
            }, 120000); // Check every 2 minutes (120 seconds)
            
            console.log('âœ… WhatsApp fallback polling baÅŸlatÄ±ldÄ± (2 dakikada bir)');
            
            // âœ… WhatsApp Ã§aÄŸrÄ±larÄ± iÃ§in de polling baÅŸlat
            startWhatsAppCallsPolling();
        }
        
        function stopWhatsAppAutoRefresh() {
            if (whatsappAutoRefreshInterval) {
                clearInterval(whatsappAutoRefreshInterval);
                whatsappAutoRefreshInterval = null;
                console.log('â¸ï¸ WhatsApp otomatik yenileme durduruldu');
            }
            
            // Ã‡aÄŸrÄ± polling'ini de durdur
            if (whatsappCallsPollingInterval) {
                clearInterval(whatsappCallsPollingInterval);
                whatsappCallsPollingInterval = null;
                console.log('â¸ï¸ WhatsApp Ã§aÄŸrÄ± polling durduruldu');
            }
        }
        
        // âœ… WhatsApp Ã‡aÄŸrÄ±larÄ± Polling Sistemi
        let whatsappCallsPollingInterval = null;
        let lastProcessedCallId = null;
        
        async function startWhatsAppCallsPolling() {
            console.log('ğŸ“ WhatsApp Ã§aÄŸrÄ± polling baÅŸlatÄ±lÄ±yor...');
            
            // Ä°lk kontrolÃ¼ hemen yap
            await fetchAndSaveWhatsAppCalls();
            
            // Her 20 saniyede bir kontrol et (Ã§aÄŸrÄ±lar daha az sÄ±klÄ±kta geliyor)
            whatsappCallsPollingInterval = setInterval(async () => {
                await fetchAndSaveWhatsAppCalls();
            }, 20000); // 20 saniye
            
            console.log('âœ… WhatsApp Ã§aÄŸrÄ± polling baÅŸlatÄ±ldÄ± (20 saniyede bir)');
        }
        
        async function fetchAndSaveWhatsAppCalls() {
            if (!clubSettings.whatsappDevices || clubSettings.whatsappDevices.length === 0) {
                return;
            }
            
            try {
                // Firebase'den mevcut Ã§aÄŸrÄ±larÄ± al (tekrar kaydetmemek iÃ§in)
                const existingCalls = new Set();
                try {
                    const callsRef = window.firebase.collection(window.db, 'whatsappIncomingCalls');
                    const callsQuery = window.firebase.query(
                        callsRef,
                        window.firebase.where('clubId', '==', currentClubId)
                    );
                    const callsSnapshot = await window.firebase.getDocs(callsQuery);
                    callsSnapshot.docs.forEach(doc => {
                        const data = doc.data();
                        const callKey = `${data.from}_${data.timestamp}`;
                        existingCalls.add(callKey);
                    });
                    console.log(`ğŸ“Š Firebase'de ${existingCalls.size} WhatsApp Ã§aÄŸrÄ±sÄ± bulundu`);
                } catch (error) {
                    console.warn('âš ï¸ Mevcut Ã§aÄŸrÄ±lar kontrol edilemedi:', error);
                }
                
                let newCallsCount = 0;
                const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
                
                // Her cihaz iÃ§in Ã§aÄŸrÄ±larÄ± kontrol et
                for (const device of clubSettings.whatsappDevices) {
                    try {
                        // Evolution API'den instance bilgilerini Ã§ek (Ã§aÄŸrÄ± olaylarÄ± iÃ§in)
                        // Not: Evolution API'nin call history endpoint'i yoksa, webhook ile alÄ±nmalÄ±
                        // Åimdilik Firebase'e manuel kayÄ±t iÃ§in hazÄ±rlÄ±k yapÄ±yoruz
                        
                        console.log(`âœ… Cihaz ${device.instanceName} hazÄ±r (Ã§aÄŸrÄ±lar webhook ile gelecek)`);
                        
                        // Alternatif: n8n workflow'undan gelen Ã§aÄŸrÄ±larÄ± kontrol et
                        // Bu kÄ±sÄ±m webhook kurulduktan sonra Ã§alÄ±ÅŸacak
                        
                    } catch (deviceError) {
                        console.error(`âŒ Cihaz ${device.instanceName} hatasÄ±:`, deviceError);
                    }
                }
                
                if (newCallsCount > 0) {
                    console.log(`âœ… ${newCallsCount} yeni WhatsApp Ã§aÄŸrÄ±sÄ± Firebase'e kaydedildi`);
                    
                    // Gelen aramalarÄ± yenile
                    if (document.getElementById('incoming-calls-list')) {
                        await renderIncomingCallsPage();
                    }
                }
                
            } catch (error) {
                console.error('âŒ WhatsApp Ã§aÄŸrÄ±larÄ± polling hatasÄ±:', error);
            }
        }
        
        // âœ… Webhook'tan gelen WhatsApp Ã§aÄŸrÄ±sÄ±nÄ± Firebase'e kaydet
        window.saveWhatsAppCallToFirebase = async function(callData) {
            try {
                // Telefon numarasÄ±nÄ± temizle ve formatla
                const from = (callData.from || callData.data?.from || '').replace('@lid', '').replace('@s.whatsapp.net', '');
                const caller = from.startsWith('90') ? '0' + from.substring(2) : from;
                
                // Ã‡aÄŸrÄ± verisi
                const whatsappCall = {
                    from: from,
                    caller: caller,
                    to: callData.instance,
                    instanceName: callData.instance,
                    timestamp: callData.data?.date || callData.date_time || new Date().toISOString(),
                    status: callData.data?.status || 'unknown',
                    isVideo: callData.data?.isVideo || false,
                    callId: callData.data?.id || Date.now().toString(),
                    is_missing_call: ['ringing', 'missed'].includes(callData.data?.status || ''),
                    clubId: currentClubId,
                    createdAt: new Date().toISOString()
                };
                
                // Firebase'e kaydet
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'whatsappIncomingCalls'),
                    whatsappCall
                );
                
                console.log('WhatsApp Ã§aÄŸrÄ±sÄ± Firebase e kaydedildi:', whatsappCall);
                
                // Gelen aramalarÄ± yenile (eÄŸer o sayfadaysak)
                if (document.getElementById('incoming-calls-list')) {
                    await renderIncomingCallsPage();
                }
                
                return true;
            } catch (error) {
                console.error('WhatsApp Ã§aÄŸrÄ±sÄ± Firebase e kaydedilemedi:', error);
                return false;
            }
        };
        
        // ğŸ”¥ Firebase Realtime Listeners (Multi-Tenant)
        let whatsappMessageListener = null;
        let whatsappCallListener = null;
        
        function startWhatsAppRealtimeListeners() {
            if (!currentClubId) {
                console.error('âŒ Club ID bulunamadÄ±, realtime listeners baÅŸlatÄ±lamadÄ±');
                return;
            }
            
            console.log(`ğŸ”¥ Firebase realtime listeners baÅŸlatÄ±lÄ±yor (Club: ${currentClubId})...`);
            
            try {
                // 1. ğŸ“¨ Mesaj Listener
                const messagesRef = window.firebase.collection(window.db, 'whatsappIncomingMessages');
                const messagesQuery = window.firebase.query(
                    messagesRef,
                    window.firebase.where('clubId', '==', currentClubId),
                    window.firebase.orderBy('timestamp', 'desc'),
                    window.firebase.limit(50)
                );
                
                whatsappMessageListener = window.firebase.onSnapshot(messagesQuery, (snapshot) => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === 'added') {
                            const message = { id: change.doc.id, ...change.doc.data() };
                            
                            // Skip old messages on first load
                            const messageTime = new Date(message.timestamp || message.messageTimestamp * 1000);
                            if (Date.now() - messageTime.getTime() > 10000) return; // Skip >10s old
                            
                            console.log('ğŸ“¨ Yeni mesaj geldi (realtime):', message);
                            
                            // If chat is open with this contact, refresh messages immediately
                            if (currentWhatsAppContact && message.remoteJid) {
                                const messagePhone = message.remoteJid.replace('@s.whatsapp.net', '');
                                if (formatPhoneForWhatsApp(messagePhone) === currentWhatsAppContact.phone) {
                                    setTimeout(() => loadMessagesForContact(currentWhatsAppContact.phone), 200);
                                }
                            }
                            
                            // Refresh contact list immediately for faster updates
                            setTimeout(() => loadWhatsAppContacts(), 50);
                            
                            // Show notification with sender name and message content
                            const sender = message.pushName || formatPhoneDisplay(message.remoteJid?.replace('@s.whatsapp.net', ''));
                            const messageText = message.message?.conversation || 
                                              message.message?.extendedTextMessage?.text || 
                                              (message.message?.imageMessage ? 'ğŸ“· FotoÄŸraf' : '') ||
                                              (message.message?.videoMessage ? 'ğŸ¥ Video' : '') ||
                                              (message.message?.audioMessage ? 'ğŸµ Ses' : '') ||
                                              (message.message?.documentMessage ? 'ğŸ“„ Dosya' : '') ||
                                              'Mesaj';
                            await showWhatsAppMessageNotification(1, sender, messageText, message.instanceName);
                        }
                    });
                }, (error) => {
                    console.error('âŒ Message listener error:', error);
                    
                    // Check if it's an index error
                    if (error.code === 'failed-precondition' || error.message?.includes('index')) {
                        console.warn('âš ï¸ Firebase index gerekli! LÃ¼tfen aÅŸaÄŸÄ±daki linke tÄ±klayÄ±p index oluÅŸturun:');
                        console.warn(error.message);
                        
                        // Show user-friendly alert
                        const indexMatch = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]+/);
                        if (indexMatch) {
                            let indexUrl = indexMatch[0];
                            
                            // Remove trailing characters that might break the URL
                            indexUrl = indexUrl.replace(/[\)\]}\s]+$/, '');
                            
                            showAlert(
                                'âš ï¸ Firebase Index Gerekli!\n\n' +
                                'WhatsApp mesajlarÄ± iÃ§in Firebase index oluÅŸturmanÄ±z gerekiyor.\n\n' +
                                'F12 basÄ±p Console\'da mavi linke TIKLAYIN.\n\n' +
                                'Åimdilik fallback polling (30s) aktif.',
                                'warning',
                                10000
                            );
                            console.log('%c\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'color: orange; font-weight: bold;');
                            console.log('%cğŸ“‹ INDEX LÄ°NKÄ° (Messages) - Bu linke TIKLAYIN:', 'color: red; font-size: 18px; font-weight: bold;');
                            console.log('%c' + indexUrl, 'color: blue; font-size: 16px; text-decoration: underline; cursor: pointer;');
                            console.log('%cYukarÄ±daki mavi linke SAÄA TIK yapÄ±p "Open in new tab" seÃ§in', 'color: green; font-size: 14px;');
                            console.log('%câ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n', 'color: orange; font-weight: bold;');
                        }
                    }
                });
                
                // 2. ğŸ“ Arama Listener (GEÃ‡Ä°CÄ° DEVRE DIÅI - Index beklemeden Ã§alÄ±ÅŸmak iÃ§in)
                // TODO: Index tamamlandÄ±ÄŸÄ±nda aktif et
                console.log('â¸ï¸ Arama listener geÃ§ici olarak devre dÄ±ÅŸÄ± (Index beklemek yerine)');
                /*
                const callsRef = window.firebase.collection(window.db, 'whatsappIncomingCalls');
                const callsQuery = window.firebase.query(
                    callsRef,
                    window.firebase.where('clubId', '==', currentClubId),
                    window.firebase.orderBy('timestamp', 'desc'),
                    window.firebase.limit(20)
                );
                
                whatsappCallListener = window.firebase.onSnapshot(callsQuery, (snapshot) => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === 'added') {
                            const call = { id: change.doc.id, ...change.doc.data() };
                            
                            // Skip old calls on first load
                            const callTime = new Date(call.timestamp || call.callTimestamp * 1000);
                            if (Date.now() - callTime.getTime() > 10000) return; // Skip >10s old
                            
                            console.log('ğŸ“ Yeni arama geldi (realtime):', call);
                            
                            // Notification sound
                            try {
                                await playNotificationSound();
                            } catch (e) {}
                            
                            // Show call notification
                            const callType = call.isVideo ? 'ğŸ“¹ GÃ¶rÃ¼ntÃ¼lÃ¼' : 'ğŸ“ Sesli';
                            const callStatus = call.status === 'offer' ? 'Gelen Arama' : call.status;
                            const caller = call.pushName || formatPhoneDisplay(call.remoteJid?.replace('@s.whatsapp.net', ''));
                            
                            showAlert(`${callType} ${callStatus}!\n${caller}`, 'warning', 5000);
                            
                            // Refresh contact list
                            setTimeout(() => loadWhatsAppContacts(), 500);
                        }
                    });
                }, (error) => {
                    console.error('âŒ Call listener error:', error);
                    
                    // Check if it's an index error
                    if (error.code === 'failed-precondition' || error.message?.includes('index')) {
                        console.warn('âš ï¸ Firebase index gerekli! LÃ¼tfen aÅŸaÄŸÄ±daki linke tÄ±klayÄ±p index oluÅŸturun:');
                        console.warn(error.message);
                        
                        // Show user-friendly alert
                        const indexMatch = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]+/);
                        if (indexMatch) {
                            let indexUrl = indexMatch[0];
                            
                            // Remove trailing characters that might break the URL
                            indexUrl = indexUrl.replace(/[\)\]}\s]+$/, '');
                            
                            showAlert(
                                'âš ï¸ Firebase Index Gerekli!\n\n' +
                                'WhatsApp Ã§aÄŸrÄ±larÄ± iÃ§in Firebase index oluÅŸturmanÄ±z gerekiyor.\n\n' +
                                'F12 basÄ±p Console\'da mavi linke TIKLAYIN.\n\n' +
                                'Åimdilik fallback polling (30s) aktif.',
                                'warning',
                                10000
                            );
                            console.log('%c\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'color: orange; font-weight: bold;');
                            console.log('%cğŸ“‹ INDEX LÄ°NKÄ° (Calls) - Bu linke TIKLAYIN:', 'color: red; font-size: 18px; font-weight: bold;');
                            console.log('%c' + indexUrl, 'color: blue; font-size: 16px; text-decoration: underline; cursor: pointer;');
                            console.log('%cYukarÄ±daki mavi linke SAÄA TIK yapÄ±p "Open in new tab" seÃ§in', 'color: green; font-size: 14px;');
                            console.log('%câ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n', 'color: orange; font-weight: bold;');
                        }
                    }
                });
                */
                
                console.log('âœ… Firebase realtime listeners aktif (Sadece Mesajlar - Aramalar devre dÄ±ÅŸÄ±)');
            } catch (error) {
                console.error('âŒ Realtime listeners baÅŸlatÄ±lamadÄ±:', error);
            }
        }
        
        function stopWhatsAppRealtimeListeners() {
            if (whatsappMessageListener) {
                whatsappMessageListener();
                whatsappMessageListener = null;
            }
            if (whatsappCallListener) {
                whatsappCallListener();
                whatsappCallListener = null;
            }
            console.log('â¸ï¸ Firebase realtime listeners durduruldu');
        }
        
        window.selectWhatsAppContact = function(phone, name, contactData) {
            // Normalize phone for storage and API calls
            const normalizedPhone = formatPhoneForWhatsApp(phone);
            currentWhatsAppContact = { 
                phone: normalizedPhone, 
                name,
                type: contactData?.type || 'unknown',
                memberId: contactData?.memberId,
                leadId: contactData?.leadId
            };
            
            // Format phone for display (05xxx xxx xxxx)
            const displayPhone = formatPhoneDisplay(normalizedPhone);
            
            // Update old header (keep for backwards compatibility)
            const oldHeaderContact = document.getElementById('whatsapp-selected-contact');
            const oldHeaderPhone = document.getElementById('whatsapp-selected-phone');
            if (oldHeaderContact) oldHeaderContact.textContent = name;
            if (oldHeaderPhone) oldHeaderPhone.textContent = displayPhone;
            document.getElementById('whatsapp-selected-number').value = normalizedPhone;
            
            // Update new header with initial
            const newHeader = document.getElementById('whatsapp-messages-header');
            const chatContactName = document.getElementById('chat-contact-name');
            const chatContactPhone = document.getElementById('chat-contact-phone');
            const chatContactInitial = document.getElementById('chat-contact-initial');
            const chatContactBadge = document.getElementById('chat-contact-badge');
            
            if (newHeader) newHeader.style.display = 'block';
            if (chatContactName) chatContactName.textContent = name;
            if (chatContactPhone) chatContactPhone.textContent = displayPhone;
            if (chatContactInitial) {
                // Get first letter of first name
                const firstLetter = name.trim().charAt(0).toUpperCase();
                chatContactInitial.textContent = firstLetter;
            }
            
            // Set badge based on type
            if (chatContactBadge && contactData) {
                if (contactData.type === 'member') {
                    chatContactBadge.textContent = 'ÃœYE';
                    chatContactBadge.style.background = '#25D366';
                    chatContactBadge.style.display = 'inline-block';
                } else if (contactData.type === 'crm') {
                    chatContactBadge.textContent = 'CRM';
                    chatContactBadge.style.background = '#FFA500';
                    chatContactBadge.style.display = 'inline-block';
                } else {
                    chatContactBadge.style.display = 'none';
                }
            }
            
            // Show message input
            document.getElementById('whatsapp-message-input').style.display = 'block';
            const refreshBtn = document.getElementById('refresh-messages-btn');
            if (refreshBtn) refreshBtn.style.display = 'none'; // Hide old refresh button
            
            // Highlight selected contact
            document.querySelectorAll('.whatsapp-contact-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.whatsapp-contact-item')?.classList.add('active');
            
            // Load messages with normalized phone
            loadMessagesForContact(normalizedPhone);
        };
        
        window.refreshCurrentMessages = async function() {
            if (!currentWhatsAppContact) {
                showAlert('LÃ¼tfen bir kiÅŸi seÃ§in!', 'warning');
                return;
            }
            
            const btn = document.getElementById('refresh-messages-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'â³ Yenileniyor...';
            btn.disabled = true;
            
            await loadMessagesForContact(currentWhatsAppContact.phone);
            
            btn.innerHTML = originalText;
            btn.disabled = false;
            showAlert('Mesajlar yenilendi!', 'success');
        };
        
        window.testFetchMessages = async function() {
            if (!currentWhatsAppContact) {
                showAlert('LÃ¼tfen bir kiÅŸi seÃ§in!', 'warning');
                return;
            }
            
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ” WhatsApp Debug Test BaÅŸlatÄ±ldÄ±');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ“ Telefon:', currentWhatsAppContact.phone);
            console.log('ğŸ‘¤ Ä°sim:', currentWhatsAppContact.name);
            console.log('ğŸ“± SeÃ§ili Cihaz:', selectedWhatsAppDevice?.instanceName);
            console.log('ğŸ”— Evolution URL:', selectedWhatsAppDevice?.evolutionUrl || EVOLUTION_API_URL);
            console.log('ğŸ”‘ API Key Var mÄ±:', selectedWhatsAppDevice?.apiKey ? 'Evet' : 'HayÄ±r');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            showAlert('ğŸ” Debug bilgileri konsola yazdÄ±rÄ±lÄ±yor, F12 ile konsolunuzu aÃ§Ä±n...', 'info');
            
            // Wait a bit so user can open console
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Test fetch
            console.log('ğŸ“¡ Mesajlar Ã§ekiliyor...');
            await loadMessagesForContact(currentWhatsAppContact.phone);
            
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('âœ… Test TamamlandÄ±');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            showAlert('âœ… Test tamamlandÄ±! Konsol Ã§Ä±ktÄ±larÄ±nÄ± kontrol edin (F12)', 'success');
        };
        
        window.syncMessagesToFirebase = async function() {
            if (!currentWhatsAppContact) {
                showAlert('LÃ¼tfen bir kiÅŸi seÃ§in!', 'warning');
                return;
            }
            
            if (!selectedWhatsAppDevice) {
                showAlert('LÃ¼tfen bir cihaz seÃ§in!', 'warning');
                return;
            }
            
            const confirmSync = confirm(`${currentWhatsAppContact.name} ile olan tÃ¼m mesajlar Firebase'e kaydedilecek. Devam etmek istiyor musunuz?`);
            if (!confirmSync) return;
            
            try {
                showAlert('ğŸ“¡ Mesajlar Evolution API\'den Ã§ekiliyor...', 'info');
                
                // Fetch messages from Evolution API
                const receivedMessages = await fetchReceivedMessages(currentWhatsAppContact.phone);
                
                if (receivedMessages.length === 0) {
                    showAlert('âš ï¸ Kaydedilecek mesaj bulunamadÄ±.', 'warning');
                    return;
                }
                
                showAlert(`ğŸ’¾ ${receivedMessages.length} mesaj Firebase'e kaydediliyor...`, 'info');
                
                let savedCount = 0;
                let errorCount = 0;
                
                // Save each message to Firebase
                for (const msg of receivedMessages) {
                    try {
                        await window.firebase.addDoc(
                            window.firebase.collection(window.db, 'whatsappMessages'),
                            {
                                phone: currentWhatsAppContact.phone,
                                contactName: currentWhatsAppContact.name,
                                message: msg.message,
                                timestamp: msg.timestamp,
                                messageId: msg.messageId,
                                fromMe: msg.fromMe || false,
                                instanceName: selectedWhatsAppDevice.instanceName,
                                clubId: currentUser.clubId,
                                savedAt: new Date().toISOString(),
                                source: 'evolution_api_sync'
                            }
                        );
                        savedCount++;
                    } catch (saveError) {
                        console.error('Error saving message:', saveError);
                        errorCount++;
                    }
                }
                
                // Also save sent messages if any
                const ourMessages = sentMessages.filter(m => 
                    m.recipientPhone === currentWhatsAppContact.phone && 
                    m.instanceName === selectedWhatsAppDevice.instanceName
                );
                
                for (const msg of ourMessages) {
                    try {
                        // Check if already saved
                        const existingQuery = window.firebase.query(
                            window.firebase.collection(window.db, 'whatsappMessages'),
                            window.firebase.where('timestamp', '==', msg.sentAt),
                            window.firebase.where('fromMe', '==', true),
                            window.firebase.where('phone', '==', currentWhatsAppContact.phone)
                        );
                        const existingDocs = await window.firebase.getDocs(existingQuery);
                        
                        if (existingDocs.empty) {
                            await window.firebase.addDoc(
                                window.firebase.collection(window.db, 'whatsappMessages'),
                                {
                                    phone: currentWhatsAppContact.phone,
                                    contactName: currentWhatsAppContact.name,
                                    message: msg.message,
                                    timestamp: msg.sentAt,
                                    messageId: msg.messageId || null,
                                    fromMe: true,
                                    instanceName: selectedWhatsAppDevice.instanceName,
                                    clubId: currentUser.clubId,
                                    savedAt: new Date().toISOString(),
                                    success: msg.success,
                                    source: 'admin_panel_sent'
                                }
                            );
                            savedCount++;
                        }
                    } catch (saveError) {
                        console.error('Error saving sent message:', saveError);
                        errorCount++;
                    }
                }
                
                showAlert(`âœ… BaÅŸarÄ±lÄ±! ${savedCount} mesaj Firebase'e kaydedildi${errorCount > 0 ? `, ${errorCount} hata` : ''}.`, 'success');
                
                console.log(`ğŸ“Š Firebase Sync Sonucu: ${savedCount} baÅŸarÄ±lÄ±, ${errorCount} hata`);
                
            } catch (error) {
                console.error('Sync error:', error);
                showAlert('âŒ Mesajlar kaydedilirken hata oluÅŸtu: ' + error.message, 'danger');
            }
        };
        
        async function loadMessagesForContact(phone) {
            const messagesArea = document.getElementById('whatsapp-messages-area');
            messagesArea.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #667781;"><div style="text-align: center;"><div class="spinner" style="width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #25D366; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div><p>Mesajlar yÃ¼kleniyor...</p></div></div>';
            
            if (!selectedWhatsAppDevice) {
                messagesArea.innerHTML = '<div class="empty-state" style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"><p style="margin: 0; color: #666;">LÃ¼tfen Ã¶nce bir cihaz seÃ§in</p></div>';
                return;
            }
            
            try {
                // Normalize phone number for comparison
                const normalizedPhone = formatPhoneForWhatsApp(phone);
                
                console.log(`ğŸ” Mesaj arama: ${phone} â†’ ${normalizedPhone}`);
                console.log(`ğŸ“¦ sentMessages array'de toplam ${sentMessages.length} mesaj var`);
                
                // Debug: Show first few sent messages
                if (sentMessages.length > 0) {
                    console.log('ğŸ“ Ä°lk gÃ¶nderilen mesaj Ã¶rneÄŸi:', {
                        recipientPhone: sentMessages[0].recipientPhone,
                        normalized: formatPhoneForWhatsApp(sentMessages[0].recipientPhone || ''),
                        instanceName: sentMessages[0].instanceName,
                        currentInstance: selectedWhatsAppDevice.instanceName
                    });
                }
                
                // Get messages from sentMessages (our sent messages)
                const ourMessages = sentMessages.filter(m => {
                    const recipientNormalized = formatPhoneForWhatsApp(m.recipientPhone || '');
                    const matches = recipientNormalized === normalizedPhone && 
                                   m.instanceName === selectedWhatsAppDevice.instanceName;
                    
                    // Debug: Log filtering
                    if (recipientNormalized === normalizedPhone && !matches) {
                        console.log(`âš ï¸ Telefon eÅŸleÅŸti ama instance farklÄ±: ${m.instanceName} vs ${selectedWhatsAppDevice.instanceName}`);
                    }
                    
                    return matches;
                }).map(m => ({
                    type: 'sent',
                    message: m.message,
                    timestamp: m.sentAt,
                    success: m.success
                }));
                
                console.log(`ğŸ’¬ GÃ¶nderilen mesajlar (Firebase): ${ourMessages.length} adet (${normalizedPhone} iÃ§in)`);
                
                // Get ALL messages from Evolution API (including sent and received)
                const evolutionMessages = await fetchReceivedMessages(phone);
                console.log(`ğŸ“¡ Evolution API mesajlarÄ±: ${evolutionMessages.length} adet (${evolutionMessages.filter(m => m.type === 'sent').length} gÃ¶nderilen, ${evolutionMessages.filter(m => m.type === 'received').length} alÄ±nan)`);
                
                // Evolution API'den gelen mesajlarÄ± kullan (zaten type'larÄ± var)
                const receivedMessages = evolutionMessages.filter(m => !m.fromMe).map(m => ({
                    type: 'received',
                    message: m.message,
                    timestamp: m.timestamp,
                    sender: m.sender
                }));
                
                const sentFromEvolution = evolutionMessages.filter(m => m.fromMe).map(m => ({
                    type: 'sent',
                    message: m.message,
                    timestamp: m.timestamp,
                    success: true
                }));
                
                // Combine and sort all messages by timestamp
                // Use Evolution API sent messages + Firebase fallback + received messages
                const allMessages = [
                    ...sentFromEvolution,  // â† Evolution API'den gelen sent mesajlar (Ã¶ncelikli)
                    ...ourMessages,        // â† Firebase'den gelen sent mesajlar (fallback)
                    ...receivedMessages    // â† Evolution API'den gelen received mesajlar
                ]
                .filter((msg, index, self) => {
                    // Remove duplicates based on timestamp and message
                    return index === self.findIndex(m => 
                        Math.abs(new Date(m.timestamp) - new Date(msg.timestamp)) < 2000 && // 2 saniye tolerans
                        m.message === msg.message
                    );
                })
                .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                console.log(`ğŸ“Š Toplam ${allMessages.length} mesaj (Evolution: ${sentFromEvolution.length} sent + ${receivedMessages.length} received, Firebase: ${ourMessages.length} sent)`);
                
                // Debug: Log all message types
                console.log('ğŸ“ Mesaj detaylarÄ±:', {
                    sentFromEvolution: sentFromEvolution.slice(0, 3),
                    ourMessages: ourMessages.slice(0, 3),
                    receivedMessages: receivedMessages.slice(0, 3),
                    allMessages: allMessages.slice(0, 5)
                });
                
                if (allMessages.length === 0) {
                    messagesArea.innerHTML = `
                        <div class="empty-state">
                            <p>HenÃ¼z mesaj yok. Ä°lk mesajÄ± gÃ¶nderin! ğŸ‘‹</p>
                        </div>
                    `;
                    return;
                }
                
                // Group messages by date
                const messagesByDate = {};
                allMessages.forEach(msg => {
                    const date = new Date(msg.timestamp).toLocaleDateString('tr-TR');
                    if (!messagesByDate[date]) messagesByDate[date] = [];
                    messagesByDate[date].push(msg);
                });
                
                // Render messages
                messagesArea.innerHTML = Object.keys(messagesByDate).map(date => {
                    const msgs = messagesByDate[date];
                    return `
                        <div style="text-align: center; margin: 15px 0;">
                            <span class="message-date-divider">${date}</span>
                        </div>
                        ${msgs.map(msg => {
                            const msgDate = new Date(msg.timestamp);
                            const timeStr = formatTime(msg.timestamp);
                            const dateStr = msgDate.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                            const fullDateTime = `${dateStr} ${timeStr}`;
                            
                            if (msg.type === 'sent') {
                                return `
                                    <div class="whatsapp-message-wrapper sent">
                                        <div class="whatsapp-message sent">
                                            <div class="message-content">${escapeHtml(msg.message)}</div>
                                            <div class="message-time">
                                                ${timeStr} ${msg.success ? '<span class="message-check">âœ“âœ“</span>' : 'âœ—'}
                                                <span style="font-size: 9px; color: rgba(0,0,0,0.35); margin-left: 6px;">${dateStr}</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else {
                                return `
                                    <div class="whatsapp-message-wrapper received">
                                        <div class="whatsapp-message received">
                                            <div class="message-content">${escapeHtml(msg.message)}</div>
                                            <div class="message-time">
                                                ${timeStr}
                                                <span style="font-size: 9px; color: rgba(0,0,0,0.35); margin-left: 6px;">${dateStr}</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        }).join('')}
                    `;
                }).join('');
                
                // Scroll to bottom
                messagesArea.scrollTop = messagesArea.scrollHeight;
            } catch (error) {
                console.error('Error loading messages:', error);
                messagesArea.innerHTML = `
                    <div class="empty-state">
                        <p style="color: #f44336;">âš ï¸ Mesajlar yÃ¼klenirken hata oluÅŸtu.</p>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }
        
        async function fetchReceivedMessages(phone) {
            try {
                // Use the selected device
                if (!selectedWhatsAppDevice) {
                    console.log('No device selected for fetching messages');
                    return [];
                }
                
                const device = selectedWhatsAppDevice;
                const evolutionUrl = device.evolutionUrl || EVOLUTION_API_URL;
                const apiKey = device.apiKey || EVOLUTION_API_KEY;
                
                console.log(`ğŸ“± Fetching messages for ${phone} from device ${device.instanceName}`);
                console.log(`ğŸ”— Using Evolution API: ${evolutionUrl}`);
                
                // Format phone number correctly
                let formattedPhone = phone.replace(/\D/g, '');
                
                // Ensure phone starts with country code (12 digits: 905449367543)
                if (formattedPhone.startsWith('0') && formattedPhone.length === 11) {
                    // 05449367543 â†’ 905449367543
                    formattedPhone = '90' + formattedPhone.substring(1);
                } else if (!formattedPhone.startsWith('90') && formattedPhone.length === 10) {
                    // 5449367543 â†’ 905449367543
                    formattedPhone = '90' + formattedPhone;
                } else if (formattedPhone.startsWith('90') && formattedPhone.length === 12) {
                    // Already correct: 905449367543
                    // Do nothing
                } else {
                    console.warn(`âš ï¸ GeÃ§ersiz telefon formatÄ±: ${phone} â†’ ${formattedPhone} (${formattedPhone.length} hane)`);
                }
                
                const remoteJid = `${formattedPhone}@s.whatsapp.net`;
                
                console.log(`ğŸ“ Remote JID: ${remoteJid} (${formattedPhone.length} hane)`);
                
                // âœ… Evolution API v2.x endpoints
                const endpoints = [
                    // Method 1: Chat messages endpoint (recommended)
                    {
                        url: `${evolutionUrl}/chat/findMessages/${device.instanceName}`,
                        body: {
                            where: {
                                key: {
                                    remoteJid: remoteJid
                                }
                            },
                            limit: 100
                        }
                    },
                    // Method 2: Message fetch endpoint
                    {
                        url: `${evolutionUrl}/message/find/${device.instanceName}`,
                        body: {
                            where: {
                                key: {
                                    remoteJid: remoteJid
                                }
                            },
                            limit: 100
                        }
                    },
                    // Method 3: Chat find with messages
                    {
                        url: `${evolutionUrl}/chat/find/${device.instanceName}`,
                        body: {
                            where: {
                                id: remoteJid
                            }
                        }
                    }
                ];
                
                let allMessages = [];
                
                for (const endpoint of endpoints) {
                    try {
                        console.log(`ğŸ” Trying endpoint: ${endpoint.url}`);
                        
                        const response = await fetch(endpoint.url, {
                            method: 'POST',
                            headers: {
                                'apikey': apiKey,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(endpoint.body)
                        });
                        
                        console.log(`ğŸ“Š Response status: ${response.status}`);
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log(`âœ… Success with endpoint, data structure:`, Object.keys(data));
                            console.log(`ğŸ“¦ Full data (JSON):`, JSON.stringify(data, null, 2));
                            
                            // Parse different response structures
                            let messages = [];
                            
                            // Evolution API v2 Response Formats:
                            
                            // Format 1: Direct array of messages
                            if (Array.isArray(data)) {
                                console.log(`ğŸ” Format 1: Direct array, length: ${data.length}`);
                                
                                // Check if it's array of chat objects with messages inside
                                if (data.length > 0 && data[0].messages) {
                                    console.log(`ğŸ” Format 1a: Array of chat objects`);
                                    // Merge all messages from all chats
                                    data.forEach(chat => {
                                        if (chat.messages && Array.isArray(chat.messages)) {
                                            messages.push(...chat.messages);
                                        }
                                    });
                                } else if (data.length > 0 && data[0].key) {
                                    // Direct array of message objects
                                    console.log(`ğŸ” Format 1b: Direct message array`);
                                    messages = data;
                                } else {
                                    console.log(`ğŸ” Format 1c: Unknown array structure`, data[0]);
                                }
                            }
                            // Format 2: data.messages.records array (Evolution API v2 paginated)
                            else if (data.messages && data.messages.records && Array.isArray(data.messages.records)) {
                                console.log(`ğŸ” Format 2a: data.messages.records (paginated response)`);
                                console.log(`ğŸ“Š Total messages available: ${data.messages.total}, Current page: ${data.messages.currentPage}/${data.messages.pages}`);
                                messages = data.messages.records;
                            }
                            // Format 2b: data.messages array
                            else if (data.messages && Array.isArray(data.messages)) {
                                console.log(`ğŸ” Format 2b: data.messages array`);
                                messages = data.messages;
                            }
                            // Format 3: data.data array
                            else if (data.data && Array.isArray(data.data)) {
                                console.log(`ğŸ” Format 3: data.data array`);
                                messages = data.data;
                            }
                            // Format 4: Wrapped response
                            else if (data.response && Array.isArray(data.response)) {
                                console.log(`ğŸ” Format 4: data.response array`);
                                messages = data.response;
                            }
                            // Format 5: Single chat object
                            else if (data.id && data.messages) {
                                console.log(`ğŸ” Format 5: Single chat object`);
                                messages = data.messages;
                            }
                            
                            console.log(`ğŸ“ Found ${messages.length} total messages`);
                            console.log(`ğŸ“ Sample message structure:`, messages[0]);
                            
                            // Extract message content
                            const parsedMessages = messages
                                .map(m => {
                                    // Extract message text from various formats
                                    let messageText = '';
                                    if (m.message) {
                                        messageText = m.message.conversation 
                                            || m.message.extendedTextMessage?.text
                                            || m.message.imageMessage?.caption
                                            || m.message.videoMessage?.caption
                                            || m.message.documentMessage?.caption
                                            || '';
                                    }
                                    
                                    if (!messageText) return null;
                                    
                                    // Check if this is from us (fromMe: true)
                                    const isFromMe = m.key?.fromMe === true;
                                    
                                    return {
                                        message: messageText,
                                        timestamp: m.messageTimestamp 
                                            ? new Date(m.messageTimestamp * 1000).toISOString() 
                                            : new Date().toISOString(),
                                        sender: phone,
                                        messageId: m.key?.id || Math.random().toString(36),
                                        fromMe: isFromMe,
                                        type: isFromMe ? 'sent' : 'received' // â† Yeni!
                                    };
                                })
                                .filter(m => m !== null);
                            
                            console.log(`âœ… Parsed ${parsedMessages.length} messages (${parsedMessages.filter(m => m.type === 'sent').length} sent, ${parsedMessages.filter(m => m.type === 'received').length} received)`);
                            
                            if (parsedMessages.length > 0) {
                                allMessages = parsedMessages;
                                break; // Success, stop trying other endpoints
                            }
                        } else {
                            const errorText = await response.text();
                            console.log(`âŒ Endpoint failed: ${response.status} - ${errorText}`);
                        }
                    } catch (endpointError) {
                        console.error(`âŒ Endpoint error:`, endpointError);
                    }
                }
                
                if (allMessages.length === 0) {
                    console.warn('âš ï¸ No messages found from any endpoint');
                    console.log('ğŸ’¡ Tip: Make sure webhook is configured and messages are being stored in Evolution API');
                }
                
                return allMessages;
            } catch (error) {
                console.error('âŒ Error fetching received messages:', error);
                return [];
            }
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function loadWhatsAppDevicesMain() {
            const container = document.getElementById('whatsappDevicesList-main');
            
            const userDevices = currentUser.isSuperAdmin 
                ? whatsappDevices 
                : whatsappDevices.filter(d => d.createdBy === currentUser.email);
            
            if (userDevices.length === 0) {
                container.innerHTML = '<p class="empty-state">HenÃ¼z baÄŸlÄ± cihaz yok.</p>';
                return;
            }
            
            container.innerHTML = userDevices.map(device => `
                <div class="settings-subsection" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 5px 0;">${device.instanceName}</h4>
                            <small style="color: #666;">ğŸ“ ${device.phoneNumber}</small><br>
                            <small style="color: #666;">ğŸ†” ${device.instanceName}</small><br>
                            <small>Durum: <span class="badge ${device.status === 'connected' ? 'bg-success' : device.status === 'pending' ? 'bg-warning' : 'bg-danger'}">${device.status === 'connected' ? 'ğŸŸ¢ BaÄŸlÄ±' : device.status === 'pending' ? 'ğŸŸ¡ Beklemede' : 'ğŸ”´ BaÄŸlÄ± DeÄŸil'}</span></small>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                            ${device.status !== 'connected' ? `<button class="btn btn-sm btn-primary" onclick="window.showInstanceQR('${device.instanceName}')">ğŸ“± QR GÃ¶ster</button>` : ''}
                            <button class="btn btn-sm btn-secondary" onclick="window.checkConnectionStatus('${device.instanceName}', '${device.id}')">âœ”ï¸ Durum</button>
                            <button class="btn btn-sm btn-warning" onclick="window.restartInstance('${device.instanceName}', '${device.id}')">ğŸ”„ Yenile</button>
                            <button class="btn btn-sm btn-danger" onclick="window.deleteInstance('${device.instanceName}', '${device.id}')">ğŸ—‘ï¸ Sil</button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Update webhook device dropdown
            updateWebhookDeviceDropdown();
            
            // âœ… Load WhatsApp settings into form fields
            document.getElementById('minWaitTime').value = clubSettings.minWaitTime || 20;
            document.getElementById('maxWaitTime').value = clubSettings.maxWaitTime || 50;
            document.getElementById('longWaitTrigger').value = clubSettings.longWaitTrigger || 100;
            document.getElementById('minLongWait').value = clubSettings.minLongWait || 400;
            document.getElementById('maxLongWait').value = clubSettings.maxLongWait || 800;
        }
        
        // Edit Device
        function editDevice(deviceId) {
            const device = whatsappDevices.find(d => d.id === deviceId);
            if (!device) {
                showAlert('Cihaz bulunamadÄ±', 'danger');
                return;
            }
            
            const modalHtml = `
                <div style="padding: 20px;">
                    <h3 style="margin-bottom: 20px;">âœï¸ Cihaz DÃ¼zenle: ${device.instanceName}</h3>
                    <form id="editDeviceForm" onsubmit="saveDeviceEdit(event, '${deviceId}')">
                        <div class="form-group">
                            <label>Cihaz AdÄ±</label>
                            <input type="text" id="edit_instanceName" class="form-control" value="${device.instanceName}" readonly>
                            <small style="color: #666;">Cihaz adÄ± deÄŸiÅŸtirilemez</small>
                        </div>
                        <div class="form-group">
                            <label>Telefon NumarasÄ±</label>
                            <input type="tel" id="edit_phoneNumber" class="form-control" value="${device.phoneNumber}" readonly>
                            <small style="color: #666;">Telefon numarasÄ± deÄŸiÅŸtirilemez</small>
                        </div>
                        <div class="form-group">
                            <label>Evolution API URL *</label>
                            <input type="url" id="edit_evolutionUrl" class="form-control" value="${device.evolutionUrl || ''}" placeholder="https://evo.example.com" required>
                            <small style="color: #666;">Evolution API sunucunuzun adresi</small>
                        </div>
                        <div class="form-group">
                            <label>API Key *</label>
                            <input type="text" id="edit_apiKey" class="form-control" value="${device.apiKey || ''}" placeholder="your-api-key" required>
                            <small style="color: #666;">Evolution API anahtarÄ±nÄ±z</small>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-success">ğŸ’¾ Kaydet</button>
                            <button type="button" class="btn btn-secondary" onclick="closeAlert()">Ä°ptal</button>
                        </div>
                    </form>
                </div>
            `;
            
            showAlert(modalHtml, 'info');
        }
        
        async function saveDeviceEdit(event, deviceId) {
            event.preventDefault();
            
            const evolutionUrl = document.getElementById('edit_evolutionUrl').value.trim();
            const apiKey = document.getElementById('edit_apiKey').value.trim();
            
            if (!evolutionUrl || !apiKey) {
                showAlert('LÃ¼tfen tÃ¼m alanlarÄ± doldurun', 'danger');
                return;
            }
            
            try {
                const { updateDoc, doc } = window.firebase;
                await updateDoc(doc(window.db, 'whatsappDevices', deviceId), {
                    evolutionUrl: evolutionUrl,
                    apiKey: apiKey,
                    updatedAt: new Date().toISOString()
                });
                
                // Update local data
                const device = whatsappDevices.find(d => d.id === deviceId);
                if (device) {
                    device.evolutionUrl = evolutionUrl;
                    device.apiKey = apiKey;
                }
                
                showAlert('âœ… Cihaz bilgileri gÃ¼ncellendi!', 'success');
                loadWhatsAppDevicesMain();
            } catch (error) {
                console.error('Error updating device:', error);
                showAlert('GÃ¼ncelleme hatasÄ±: ' + error.message, 'danger');
            }
        }
        
        window.editDevice = editDevice;
        window.saveDeviceEdit = saveDeviceEdit;
        
        // === WEBHOOK MANAGEMENT FUNCTIONS ===
        
        function updateWebhookDeviceDropdown() {
            const select = document.getElementById('webhookDevice');
            if (!select) return;
            
            const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
            
            if (connectedDevices.length === 0) {
                select.innerHTML = '<option value="">Ã–nce cihaz baÄŸlayÄ±n...</option>';
                return;
            }
            
            select.innerHTML = '<option value="">Cihaz seÃ§in...</option>' +
                connectedDevices.map(d => `<option value="${d.instanceName}">${d.instanceName} (${d.phoneNumber})</option>`).join('');
        }
        
        async function loadWebhookForDevice(instanceName) {
            if (!instanceName) {
                document.getElementById('webhookUrl').value = '';
                document.getElementById('webhookEnabled').checked = true;
                document.getElementById('webhookStatus').style.display = 'none';
                return;
            }
            
            const device = whatsappDevices.find(d => d.instanceName === instanceName);
            if (!device) return;
            
            // Check if evolutionUrl exists
            if (!device.evolutionUrl || device.evolutionUrl === 'undefined') {
                showAlert('âš ï¸ Bu cihazÄ±n Evolution API URL\'si tanÄ±mlanmamÄ±ÅŸ. LÃ¼tfen WhatsApp ayarlarÄ±ndan cihazÄ± dÃ¼zenleyin ve Evolution API URL\'sini ekleyin.', 'danger');
                console.error('Device missing evolutionUrl:', device);
                return;
            }
            
            try {
                // Fetch current webhook config from Evolution API
                const response = await fetch(`${device.evolutionUrl}/webhook/find/${instanceName}`, {
                    method: 'GET',
                    headers: {
                        'apikey': device.apiKey
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update form fields
                    document.getElementById('webhookUrl').value = data.url || '';
                    document.getElementById('webhookEnabled').checked = data.enabled !== false;
                    
                    // Update event checkboxes
                    document.querySelectorAll('input[name="webhookEvents"]').forEach(cb => {
                        cb.checked = data.events && data.events.includes(cb.value);
                    });
                    
                    // Show webhook status
                    showWebhookStatus(data);
                } else {
                    console.log('No webhook configured for this device yet');
                    document.getElementById('webhookUrl').value = '';
                    document.getElementById('webhookEnabled').checked = true;
                    document.getElementById('webhookStatus').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading webhook:', error);
                showAlert('Webhook bilgileri yÃ¼klenirken hata oluÅŸtu: ' + error.message, 'danger');
            }
        }
        
        async function saveWebhookConfig(event) {
            event.preventDefault();
            
            const instanceName = document.getElementById('webhookDevice').value;
            const webhookUrl = document.getElementById('webhookUrl').value;
            const enabled = document.getElementById('webhookEnabled').checked;
            
            if (!instanceName) {
                showAlert('LÃ¼tfen bir cihaz seÃ§in.', 'danger');
                return;
            }
            
            const device = whatsappDevices.find(d => d.instanceName === instanceName);
            if (!device) {
                showAlert('Cihaz bulunamadÄ±.', 'danger');
                return;
            }
            
            // Check if evolutionUrl exists
            if (!device.evolutionUrl || device.evolutionUrl === 'undefined') {
                showAlert('âš ï¸ Bu cihazÄ±n Evolution API URL\'si tanÄ±mlanmamÄ±ÅŸ. LÃ¼tfen WhatsApp ayarlarÄ±ndan cihazÄ± dÃ¼zenleyin ve Evolution API URL\'sini ekleyin.', 'danger');
                console.error('Device missing evolutionUrl:', device);
                return;
            }
            
            // Get selected events
            const selectedEvents = Array.from(document.querySelectorAll('input[name="webhookEvents"]:checked'))
                .map(cb => cb.value);
            
            if (selectedEvents.length === 0) {
                showAlert('En az bir event seÃ§melisiniz.', 'danger');
                return;
            }
            
            try {
                const response = await fetch(`${device.evolutionUrl}/webhook/set/${instanceName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': device.apiKey
                    },
                    body: JSON.stringify({
                        enabled: enabled,
                        url: webhookUrl,
                        webhookByEvents: false,
                        webhookBase64: true,
                        events: selectedEvents
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showAlert('âœ… Webhook baÅŸarÄ±yla kaydedildi!', 'success');
                    showWebhookStatus(data.webhook || {
                        enabled: enabled,
                        url: webhookUrl,
                        events: selectedEvents
                    });
                    
                    // Save to Firebase for tracking
                    await window.firebase.updateDoc(
                        window.firebase.doc(window.db, 'whatsappDevices', device.id),
                        {
                            webhookUrl: webhookUrl,
                            webhookEnabled: enabled,
                            webhookEvents: selectedEvents,
                            webhookLastUpdated: new Date().toISOString()
                        }
                    );
                } else {
                    const error = await response.text();
                    throw new Error(error || 'Webhook kaydedilemedi');
                }
            } catch (error) {
                console.error('Error saving webhook:', error);
                showAlert('Webhook kaydedilirken hata oluÅŸtu: ' + error.message, 'danger');
            }
        }
        
        function showWebhookStatus(webhookData) {
            const statusDiv = document.getElementById('webhookStatus');
            const contentDiv = document.getElementById('webhookStatusContent');
            
            if (!webhookData || !webhookData.url) {
                statusDiv.style.display = 'none';
                return;
            }
            
            const statusHtml = `
                <div style="display: grid; gap: 10px;">
                    <div>
                        <strong>Webhook URL:</strong><br>
                        <code style="background: #f0f0f0; padding: 5px 10px; border-radius: 4px; display: inline-block; margin-top: 5px; word-break: break-all;">
                            ${webhookData.url}
                        </code>
                    </div>
                    <div>
                        <strong>Durum:</strong> 
                        <span class="badge ${webhookData.enabled ? 'bg-success' : 'bg-secondary'}">
                            ${webhookData.enabled ? 'âœ… Etkin' : 'âŒ Devre DÄ±ÅŸÄ±'}
                        </span>
                    </div>
                    <div>
                        <strong>Ä°zlenen Event'ler:</strong><br>
                        ${(webhookData.events || []).map(e => `<span class="badge bg-info" style="margin-right: 5px;">${e}</span>`).join('')}
                    </div>
                </div>
            `;
            
            contentDiv.innerHTML = statusHtml;
            statusDiv.style.display = 'block';
        }
        
        async function testWebhook() {
            const instanceName = document.getElementById('webhookDevice').value;
            const webhookUrl = document.getElementById('webhookUrl').value;
            
            if (!instanceName || !webhookUrl) {
                showAlert('LÃ¼tfen cihaz ve webhook URL seÃ§in.', 'danger');
                return;
            }
            
            try {
                // Send a test POST request to the webhook URL
                const testData = {
                    event: "webhook_test",
                    instance: instanceName,
                    data: {
                        message: "Bu bir test mesajÄ±dÄ±r",
                        timestamp: new Date().toISOString(),
                        from: "Admin Panel"
                    }
                };
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                if (response.ok) {
                    showAlert('âœ… Webhook test baÅŸarÄ±lÄ±! URL\'niz Ã§alÄ±ÅŸÄ±yor.', 'success');
                } else {
                    showAlert(`âš ï¸ Webhook yanÄ±t verdi ama hata kodu dÃ¶ndÃ¼: ${response.status}`, 'warning');
                }
            } catch (error) {
                console.error('Webhook test error:', error);
                showAlert('âŒ Webhook test baÅŸarÄ±sÄ±z. URL eriÅŸilebilir deÄŸil: ' + error.message, 'danger');
            }
        }
        
        window.loadWebhookForDevice = loadWebhookForDevice;
        window.saveWebhookConfig = saveWebhookConfig;
        window.testWebhook = testWebhook;
        
        function loadBulkMessageForm() {
            // This function is now handled by onBulkBranchChange
            // Groups are loaded dynamically based on selected branch
        }
        
        function formatPhoneForWhatsApp(phone) {
            if (!phone) return '';
            phone = phone.replace(/\D/g, '');
            if (phone.startsWith('0')) {
                phone = '90' + phone.substring(1);
            } else if (!phone.startsWith('90')) {
                phone = '90' + phone;
            }
            return phone;
        }
        
        // Telefon numarasÄ±nÄ± gÃ¶rsel formatlama (05xx xxx xxxx)
        function formatPhoneDisplay(phone) {
            if (!phone) return '';
            
            // TÃ¼m rakam olmayan karakterleri temizle
            let cleaned = phone.replace(/\D/g, '');
            
            // 90 ile baÅŸlÄ±yorsa 0'a Ã§evir
            if (cleaned.startsWith('90') && cleaned.length === 12) {
                cleaned = '0' + cleaned.substring(2);
            }
            
            // 0 ile baÅŸlayan 11 haneli TÃ¼rkiye numarasÄ± formatÄ±
            if (cleaned.startsWith('0') && cleaned.length === 11) {
                return `${cleaned.substring(0, 4)} ${cleaned.substring(4, 7)} ${cleaned.substring(7, 9)} ${cleaned.substring(9)}`;
            }
            
            // DiÄŸer formatlar iÃ§in olduÄŸu gibi dÃ¶ndÃ¼r
            return phone;
        }
        
        async function handleWhatsAppSendMessage(e) {
            e.preventDefault();
            const form = e.target;
            const phone = form.querySelector('#whatsapp-selected-number').value;
            const message = form.querySelector('#whatsapp-message-text').value.trim();
            
            if (!phone || !message) {
                showAlert('Telefon numarasÄ± ve mesaj gerekli!', 'danger');
                return;
            }
            
            // Use the selected device from the main dropdown
            if (!selectedWhatsAppDevice) {
                showAlert('LÃ¼tfen Ã¶nce bir WhatsApp cihazÄ± seÃ§in!', 'danger');
                return;
            }
            
            const device = selectedWhatsAppDevice;
            
            // Send message
            console.log(`ğŸ“¤ Sending message from device: ${device.instanceName} (${device.phoneNumber})`);
            const result = await sendWhatsAppMessage(device.instanceName, phone, message, currentWhatsAppContact.name);
            const success = result?.success || result === true; // Handle both object and boolean return
            
            if (success) {
                const textarea = form.querySelector('#whatsapp-message-text');
                textarea.value = '';
                textarea.style.height = 'auto'; // Reset height
                showAlert(`âœ… Mesaj gÃ¶nderildi!`, 'success');
                
                // Reload sent messages from Firebase first
                console.log('ğŸ”„ Reloading sent messages...');
                try {
                    const messagesSnapshot = await window.firebase.getDocs(
                        window.firebase.query(
                            window.firebase.collection(window.db, 'sentMessages'),
                            window.firebase.where('clubId', '==', currentClubId),
                            window.firebase.orderBy('sentAt', 'desc')
                        )
                    );
                    sentMessages = messagesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).slice(0, 50); // ArtÄ±k 50 mesaj
                    console.log(`âœ… Reloaded ${sentMessages.length} sent messages`);
                } catch (e) {
                    console.warn('âš ï¸ Could not reload sent messages:', e);
                }
                
                // Reload messages and scroll to bottom
                setTimeout(() => {
                    loadMessagesForContact(phone);
                }, 500);
            } else {
                showAlert('âŒ Mesaj gÃ¶nderilemedi!', 'danger');
            }
        }
        
        let selectedBulkGroups = [];
        let currentBranchGroups = []; // Arama iÃ§in mevcut gruplarÄ± sakla
        
        function onBulkBranchChange() {
            const branch = document.getElementById('bulk-branch-selector').value;
            selectedBulkGroups = [];
            
            if (!branch) {
                document.getElementById('bulk-groups-container').style.display = 'none';
                document.getElementById('bulk-recipients-container').style.display = 'none';
                return;
            }
            
            // Show groups for selected branch
            const branchGroups = branch === 'all' 
                ? groups 
                : groups.filter(g => g.branch === branch);
            
            currentBranchGroups = branchGroups; // Arama iÃ§in sakla
            renderBulkGroups(branchGroups);
            
            document.getElementById('bulk-groups-container').style.display = 'block';
            document.getElementById('bulk-group-search').value = ''; // Arama kutusunu temizle
            
            // Hide recipients container until groups are confirmed
            document.getElementById('bulk-recipients-container').style.display = 'none';
        }
        
        function renderBulkGroups(groupsToRender) {
            const groupsListHTML = groupsToRender.map(g => {
                const memberCount = members.filter(m => Array.isArray(g.members) && g.members.includes(m.id) && m.status === 'active').length;
                return `
                    <div class="form-check bulk-group-item" data-group-name="${g.groupName.toLowerCase()}" style="padding: 10px; border-bottom: 1px solid #eee;">
                        <input class="form-check-input bulk-group-checkbox" type="checkbox" value="${g.id}" id="bulkGroup${g.id}" onchange="updateBulkRecipients()">
                        <label class="form-check-label" for="bulkGroup${g.id}" style="cursor: pointer; width: 100%;">
                            <strong>${g.groupName}</strong> <span style="color: #666;">(${memberCount} kiÅŸi)</span>
                            <br><small style="color: #999;">${g.branch === 'tenis' ? 'ğŸ¾' : 'ğŸŠ'} ${g.branch}</small>
                        </label>
                    </div>
                `;
            }).join('');
            
            document.getElementById('bulk-groups-list').innerHTML = groupsListHTML || '<p class="empty-state">Bu branÅŸta grup bulunamadÄ±</p>';
        }
        
        window.filterBulkGroups = function() {
            const searchTerm = document.getElementById('bulk-group-search').value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderBulkGroups(currentBranchGroups);
                return;
            }
            
            const filteredGroups = currentBranchGroups.filter(g => 
                g.groupName.toLowerCase().includes(searchTerm)
            );
            
            renderBulkGroups(filteredGroups);
        };
        
        window.selectAllGroups = function() {
            document.querySelectorAll('.bulk-group-checkbox').forEach(cb => {
                cb.checked = true;
            });
        };
        
        window.deselectAllGroups = function() {
            document.querySelectorAll('.bulk-group-checkbox').forEach(cb => {
                cb.checked = false;
            });
        };
        
        window.confirmGroupSelection = function() {
            const selectedCheckboxes = document.querySelectorAll('.bulk-group-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                showAlert('LÃ¼tfen en az bir grup seÃ§in!', 'warning');
                return;
            }
            
            selectedBulkGroups = Array.from(selectedCheckboxes).map(cb => cb.value);
            showAlert(`${selectedBulkGroups.length} grup seÃ§ildi! Åimdi kiÅŸileri seÃ§in.`, 'success');
            loadBulkRecipients();
        };
        
        window.selectAllRecipients = function() {
            document.querySelectorAll('.bulk-recipient-checkbox').forEach(cb => {
                cb.checked = true;
            });
            updateRecipientCount();
        };
        
        window.deselectAllRecipients = function() {
            document.querySelectorAll('.bulk-recipient-checkbox').forEach(cb => {
                cb.checked = false;
            });
            updateRecipientCount();
        };
        
        window.confirmRecipientSelection = function() {
            const selectedCheckboxes = document.querySelectorAll('.bulk-recipient-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                showAlert('LÃ¼tfen en az bir kiÅŸi seÃ§in!', 'warning');
                return;
            }
            
            const count = selectedCheckboxes.length;
            showAlert(`${count} kiÅŸi seÃ§ildi! ArtÄ±k mesajÄ±nÄ±zÄ± yazÄ±p gÃ¶nderebilirsiniz.`, 'success');
            updateFinalRecipientCount();
        };
        
        function loadBulkRecipients() {
            // Get all members from selected groups
            const recipientMembers = members.filter(m => 
                (m.status === 'active' || m.status === 'pending') &&
                (m.Telefon || m.Telefon_2) &&
                selectedBulkGroups.some(groupId => {
                    const group = groups.find(g => g.id === groupId);
                    return group && Array.isArray(group.members) && group.members.includes(m.id);
                })
            );
            
            // Build recipients list including both parent phones
            const uniqueRecipients = [];
            const seenPhones = new Set();
            
            recipientMembers.forEach(m => {
                const memberName = m.Resit_Olmayan_Adi_Soyadi || m.Ad_Soyad || 'Ä°simsiz';
                
                // Add first parent (Telefon)
                if (m.Telefon) {
                    const phone1 = formatPhoneForWhatsApp(m.Telefon);
                    if (!seenPhones.has(phone1)) {
                        seenPhones.add(phone1);
                        uniqueRecipients.push({
                            memberId: m.id,
                            memberName: memberName,
                            phone: phone1,
                            parentName: m.Ad_Soyad || memberName,
                            label: '1. Veli',
                            isChild: !!m.Resit_Olmayan_Adi_Soyadi
                        });
                    }
                }
                
                // Add second parent (Telefon_2)
                if (m.Telefon_2 && m.Telefon_2.trim() !== '') {
                    const phone2 = formatPhoneForWhatsApp(m.Telefon_2);
                    if (!seenPhones.has(phone2)) {
                        seenPhones.add(phone2);
                        uniqueRecipients.push({
                            memberId: m.id,
                            memberName: memberName,
                            phone: phone2,
                            parentName: m.Veli_2_Adi_Soyadi || m.Ad_Soyad || memberName,
                            label: '2. Veli',
                            isChild: !!m.Resit_Olmayan_Adi_Soyadi
                        });
                    }
                }
            });
            
            if (uniqueRecipients.length === 0) {
                document.getElementById('bulk-recipients-list').innerHTML = '<p class="empty-state">SeÃ§ilen gruplarda telefon numarasÄ± olan kiÅŸi bulunamadÄ±</p>';
                document.getElementById('bulk-recipients-container').style.display = 'block';
                return;
            }
            
            // Show recipients list with checkboxes
            const recipientsHTML = uniqueRecipients.map((recipient, index) => {
                return `
                <div class="form-check" style="padding: 8px; border-bottom: 1px solid #f0f0f0;">
                    <input class="form-check-input bulk-recipient-checkbox" type="checkbox" value="${recipient.memberId}" data-phone="${recipient.phone}" data-name="${recipient.parentName}" id="bulkRecipient${index}" onchange="updateRecipientCount()">
                    <label class="form-check-label" for="bulkRecipient${index}" style="cursor: pointer; width: 100%;">
                        <span style="color: #666; font-size: 12px;">${index + 1}.</span>
                        <strong>${recipient.parentName}</strong>
                        ${recipient.isChild ? `<span style="color: #999; font-size: 0.85em;">(${recipient.memberName} - ${recipient.label})</span>` : ''}
                        <small style="color: #666; margin-left: 10px;">ğŸ“ ${recipient.phone}</small>
                    </label>
                    <span class="badge bg-secondary recipient-status-badge" data-index="${index}">Bekliyor</span>
                </div>
            `}).join('');
            
            document.getElementById('bulk-recipients-list').innerHTML = recipientsHTML;
            document.getElementById('bulk-recipients-container').style.display = 'block';
            document.getElementById('bulk-recipient-count-badge').textContent = uniqueRecipients.length;
            
            // Auto-select all recipients by default
            setTimeout(() => {
                selectAllRecipients();
                updateRecipientCount();
            }, 100);
        }
        
        function updateRecipientCount() {
            const selectedCount = document.querySelectorAll('.bulk-recipient-checkbox:checked').length;
            document.getElementById('bulk-recipient-count-badge').textContent = selectedCount;
        }
        
        function updateFinalRecipientCount() {
            const selectedCount = document.querySelectorAll('.bulk-recipient-checkbox:checked').length;
            document.getElementById('bulk-final-count').textContent = selectedCount;
            
            // Calculate estimated time (5-45 seconds per message, average 25 seconds)
            const avgTime = 25;
            const totalSeconds = selectedCount * avgTime;
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            document.getElementById('bulk-estimated-time').textContent = `~${minutes} dk ${seconds} sn`;
        }
        
        async function handleBulkMessageSend(e) {
            e.preventDefault();
            const form = e.target;
            const messageTemplate = document.getElementById('bulk-message-text').value.trim();
            
            if (!messageTemplate) {
                showAlert('Mesaj metni gerekli!', 'danger');
                return;
            }
            
            // Get selected recipients from checkboxes
            const selectedCheckboxes = document.querySelectorAll('.bulk-recipient-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                showAlert('LÃ¼tfen en az bir kiÅŸi seÃ§in!', 'danger');
                return;
            }
            
            // Find connected device
            let device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
            if (!device) {
                device = whatsappDevices.find(d => d.status === 'connected');
            }
            
            if (!device) {
                showAlert('BaÄŸlÄ± WhatsApp cihazÄ± bulunamadÄ±!', 'danger');
                return;
            }
            
            // Build recipients list from selected checkboxes
            const uniqueRecipients = Array.from(selectedCheckboxes).map(cb => ({
                name: cb.dataset.name,
                phone: cb.dataset.phone,
                memberId: cb.value
            }));
            
            // Confirm
            if (!confirm(`${uniqueRecipients.length} kiÅŸiye mesaj gÃ¶nderilecek. Devam edilsin mi?`)) {
                return;
            }
            
            // Show status panel
            document.getElementById('bulk-sending-status').style.display = 'block';
            document.getElementById('bulk-send-btn').disabled = true;
            document.getElementById('bulk-status-log').innerHTML = '';
            
            let successCount = 0;
            let failCount = 0;
            
            function addLog(message, type = 'info') {
                const logContainer = document.getElementById('bulk-status-log');
                const timestamp = new Date().toLocaleTimeString('tr-TR');
                const color = type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue';
                logContainer.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            addLog(`ğŸš€ GÃ¶nderim baÅŸladÄ±! Toplam ${uniqueRecipients.length} kiÅŸi`);
            
            // Find which checkbox index corresponds to each recipient
            const checkboxes = Array.from(selectedCheckboxes);
            
            for (let i = 0; i < uniqueRecipients.length; i++) {
                const recipient = uniqueRecipients[i];
                const checkbox = checkboxes[i];
                const checkboxIndex = Array.from(document.querySelectorAll('.bulk-recipient-checkbox')).indexOf(checkbox);
                
                // Update status badge
                const statusBadge = document.querySelector(`.recipient-status-badge[data-index="${checkboxIndex}"]`);
                if (statusBadge) {
                    statusBadge.textContent = 'ğŸ“¤ GÃ¶nderiliyor...';
                    statusBadge.className = 'badge bg-info recipient-status-badge';
                    statusBadge.dataset.index = checkboxIndex;
                }
                
                // Personalize message
                let personalizedMessage = messageTemplate;
                const uyeName = recipient.isChild ? recipient.parentName : recipient.parentName;
                const ogrenciName = recipient.isChild ? recipient.memberName : '';
                
                personalizedMessage = personalizedMessage.replace(/{UYE_AD_SOYAD}/g, uyeName);
                personalizedMessage = personalizedMessage.replace(/{OGRENCI_AD_SOYAD}/g, ogrenciName);
                // Backward compatibility for old templates
                personalizedMessage = personalizedMessage.replace(/{VELI_AD_SOYAD}/g, recipient.parentName);
                personalizedMessage = personalizedMessage.replace(/{AD_SOYAD}/g, uyeName).replace(/{AD}/g, uyeName);
                
                addLog(`ğŸ“¨ ${i + 1}/${uniqueRecipients.length}: ${recipient.parentName} (${recipient.phone})`);
                
                // Send message
                const result = await sendWhatsAppMessage(device.instanceName, recipient.phone, personalizedMessage, recipient.name);
                const success = result.success || result === true; // Backward compatibility
                
                if (success) {
                    successCount++;
                    if (statusBadge) {
                        statusBadge.textContent = 'âœ… GÃ¶nderildi';
                        statusBadge.className = 'badge bg-success recipient-status-badge';
                        statusBadge.dataset.index = checkboxIndex;
                    }
                    addLog(`âœ… BaÅŸarÄ±lÄ±: ${recipient.name}`, 'success');
                } else {
                    failCount++;
                    const errorMsg = result.errorReason ? ` - ${result.errorReason}` : '';
                    if (statusBadge) {
                        statusBadge.textContent = 'âŒ BaÅŸarÄ±sÄ±z';
                        statusBadge.className = 'badge bg-danger recipient-status-badge';
                        statusBadge.dataset.index = checkboxIndex;
                        statusBadge.title = errorMsg ? result.errorReason : 'Bilinmeyen hata';
                    }
                    addLog(`âŒ BaÅŸarÄ±sÄ±z: ${recipient.name}${errorMsg}`, 'error');
                }
                
                // Update progress bar
                const progress = ((i + 1) / uniqueRecipients.length) * 100;
                const progressBar = document.getElementById('bulk-progress-bar');
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${i + 1} / ${uniqueRecipients.length}`;
                
                // âœ… Random wait time (ayarlardan)
                if (i < uniqueRecipients.length - 1) {
                    const messageCount = i + 1;
                    let waitTime;
                    
                    // Her X mesajda bir uzun bekleme
                    const shouldLongWait = (messageCount % (clubSettings.longWaitTrigger || 100)) === 0;
                    
                    if (shouldLongWait) {
                        const min = clubSettings.minLongWait || 400;
                        const max = clubSettings.maxLongWait || 800;
                        waitTime = Math.floor(Math.random() * (max - min + 1)) + min;
                        addLog(`â³ UZUN BEKLEME: Sonraki mesaj iÃ§in ${waitTime} saniye bekleniyor... (Her ${clubSettings.longWaitTrigger} mesajda bir)`, 'info');
                    } else {
                        const min = clubSettings.minWaitTime || 20;
                        const max = clubSettings.maxWaitTime || 50;
                        waitTime = Math.floor(Math.random() * (max - min + 1)) + min;
                        addLog(`â³ Sonraki mesaj iÃ§in ${waitTime} saniye bekleniyor...`);
                    }
                    
                    // Show countdown
                    for (let countdown = waitTime; countdown > 0; countdown--) {
                        if (statusBadge) {
                            statusBadge.textContent = `â³ ${countdown}s`;
                            statusBadge.className = 'badge bg-warning recipient-status-badge';
                            statusBadge.dataset.index = checkboxIndex;
                        }
                        await new Promise(resolve => setTimeout(resolve, 400));
                    }
                }
            }
            
            addLog(`ğŸ‰ GÃ¶nderim tamamlandÄ±! BaÅŸarÄ±lÄ±: ${successCount}, BaÅŸarÄ±sÄ±z: ${failCount}`, 'success');
            
            showAlert(`Toplu mesaj gÃ¶nderimi tamamlandÄ±! âœ… ${successCount} baÅŸarÄ±lÄ±, âŒ ${failCount} baÅŸarÄ±sÄ±z`, 'success');
            
            document.getElementById('bulk-send-btn').disabled = false;
            
            // Reset form after 5 seconds
            setTimeout(() => {
                document.getElementById('bulk-sending-status').style.display = 'none';
            }, 5000);
        }
        
        async function fetchAndShowQR(instanceName, deviceId) {
            try {
                const response = await fetch(`${EVOLUTION_API_URL}/instance/connect/${instanceName}`, {
                    method: 'GET',
                    headers: {
                        'apikey': EVOLUTION_API_KEY
                    }
                });
                
                const data = await response.json();
                
                // Try different response formats
                let qrBase64 = null;
                
                if (data.qrcode && data.qrcode.base64) {
                    qrBase64 = data.qrcode.base64;
                } else if (data.base64) {
                    qrBase64 = data.base64;
                } else if (data.code) {
                    qrBase64 = data.code;
                } else if (typeof data === 'string' && data.startsWith('data:image')) {
                    qrBase64 = data;
                }
                
                if (qrBase64) {
                    showQRCodeModal(instanceName, qrBase64, deviceId);
                } else {
                    closeModal('qrCodeModal');
                    showAlert('âš ï¸ QR kod alÄ±namadÄ±. Cihaz listesinden "QR Kod" butonuna tÄ±klayÄ±n.', 'warning');
                }
            } catch (error) {
                closeModal('qrCodeModal');
                showAlert('âš ï¸ QR kod yÃ¼klenemedi. LÃ¼tfen cihaz listesinden tekrar deneyin.', 'danger');
            }
        }
        
        async function showInstanceQR(instanceName) {
            const device = whatsappDevices.find(d => d.instanceName === instanceName);
            const deviceId = device ? device.id : null;
            
            showQRLoadingModal(instanceName);
            await fetchAndShowQR(instanceName, deviceId);
        }
        
        function showQRCodeModal(instanceName, base64QR, deviceId = null) {
            const modal = document.getElementById('qrCodeModal');
            if (!modal) return;
            
            const modalContent = modal.querySelector('.modal-content');
            const qrImage = document.getElementById('qrCodeImage');
            
            // Remove loading spinner if exists
            if (modalContent) {
                const loader = modalContent.querySelector('.qr-loading');
                if (loader) {
                    loader.remove();
                }
            }
            
            // Update title and show QR
            document.getElementById('qrCodeTitle').textContent = `ğŸ“± ${instanceName} - QR Kod`;
            
            if (qrImage) {
                qrImage.src = base64QR;
                qrImage.style.display = 'block';
            }
            
            // If modal not already open, open it
            if (!modal.classList.contains('active')) {
                openModal('qrCodeModal');
            }
            
            // Start polling for connection if deviceId is provided
            if (deviceId) {
                startConnectionPolling(instanceName, deviceId);
            }
        }
        
        // Poll Evolution API to check if instance is connected
        let pollingIntervals = {};
        
        async function checkConnectionStatus(instanceName, deviceId) {
            try {
                // Try multiple endpoints to check connection
                let isConnected = false;
                
                // Method 1: Check connection state
                try {
                    const stateResponse = await fetch(`${EVOLUTION_API_URL}/instance/connectionState/${instanceName}`, {
                        method: 'GET',
                        headers: { 'apikey': EVOLUTION_API_KEY }
                    });
                    const stateData = await stateResponse.json();
                    
                    if (stateData.state === 'open' || stateData.instance?.state === 'open') {
                        isConnected = true;
                    }
                } catch (e) {}
                
                // Method 2: Check fetch instances
                if (!isConnected) {
                    try {
                        const instancesResponse = await fetch(`${EVOLUTION_API_URL}/instance/fetchInstances`, {
                            method: 'GET',
                            headers: { 'apikey': EVOLUTION_API_KEY }
                        });
                        const instances = await instancesResponse.json();
                        
                        if (Array.isArray(instances)) {
                            const instance = instances.find(i => i.instanceName === instanceName);
                            if (instance && instance.state === 'open') {
                                isConnected = true;
                            }
                        }
                    } catch (e) {}
                }
                
                if (isConnected) {
                    // Update Firebase
                    await window.firebase.updateDoc(
                        window.firebase.doc(window.db, 'whatsappDevices', deviceId),
                        {
                            status: 'connected',
                            lastUpdated: new Date().toISOString()
                        }
                    );
                    
                    // Update local state
                    const deviceIndex = whatsappDevices.findIndex(d => d.id === deviceId);
                    if (deviceIndex !== -1) {
                        whatsappDevices[deviceIndex].status = 'connected';
                        whatsappDevices[deviceIndex].lastUpdated = new Date().toISOString();
                    }
                    
                    return true;
                }
                
                return false;
            } catch (error) {
                return false;
            }
        }
        
        async function startConnectionPolling(instanceName, deviceId) {
            // Clear existing polling for this instance
            if (pollingIntervals[instanceName]) {
                clearInterval(pollingIntervals[instanceName]);
            }
            
            let attempts = 0;
            const maxAttempts = 60; // Poll for 2 minutes (60 attempts * 2 seconds)
            
            pollingIntervals[instanceName] = setInterval(async () => {
                attempts++;
                
                const isConnected = await checkConnectionStatus(instanceName, deviceId);
                
                if (isConnected) {
                    // Connection successful!
                    clearInterval(pollingIntervals[instanceName]);
                    delete pollingIntervals[instanceName];
                    
                    // Close QR modal and show success
                    closeModal('qrCodeModal');
                    showAlert('âœ… WhatsApp baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±! Cihaz kullanÄ±ma hazÄ±r.', 'success');
                    
                    // Reload instances
                    loadWhatsAppInstances();
                    
                } else if (attempts >= maxAttempts) {
                    // Timeout
                    clearInterval(pollingIntervals[instanceName]);
                    delete pollingIntervals[instanceName];
                    showAlert('â±ï¸ QR kod okutma zaman aÅŸÄ±mÄ±na uÄŸradÄ±. Manuel olarak kontrol edin.', 'warning');
                }
            }, 3000); // Check every 3 seconds
        }
        
        async function restartInstance(instanceName, deviceId) {
            showConfirmModal(`${instanceName} cihazÄ±nÄ± yeniden baÅŸlatmak istediÄŸinizden emin misiniz?`, async () => {
                closeModal('confirmModal');
                try {
                    const response = await fetch(`${EVOLUTION_API_URL}/instance/restart/${instanceName}`, {
                        method: 'PUT',
                        headers: {
                            'apikey': EVOLUTION_API_KEY
                        }
                    });
                    
                    if (response.ok) {
                        // Update status to pending in Firebase
                        await window.firebase.updateDoc(
                            window.firebase.doc(window.db, 'whatsappDevices', deviceId),
                            {
                                status: 'pending',
                                lastUpdated: new Date().toISOString()
                            }
                        );
                        
                        // Update local state
                        const deviceIndex = whatsappDevices.findIndex(d => d.id === deviceId);
                        if (deviceIndex !== -1) {
                            whatsappDevices[deviceIndex].status = 'pending';
                            whatsappDevices[deviceIndex].lastUpdated = new Date().toISOString();
                        }
                        
                        showAlert('Cihaz yeniden baÅŸlatÄ±lÄ±yor...', 'success');
                        setTimeout(() => loadWhatsAppInstances(), 800);
                    } else {
                        showAlert('Cihaz yeniden baÅŸlatÄ±lamadÄ±.', 'danger');
                    }
                } catch (error) {
                    console.error('Restart instance error:', error);
                    showAlert('Ä°ÅŸlem sÄ±rasÄ±nda hata oluÅŸtu.', 'danger');
                }
            });
        }
        
        async function deleteInstance(instanceName, deviceId) {
            showConfirmModal(`${instanceName} cihazÄ±nÄ± kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?`, async () => {
                closeModal('confirmModal');
                try {
                    // Delete from Evolution API
                    const response = await fetch(`${EVOLUTION_API_URL}/instance/delete/${instanceName}`, {
                        method: 'DELETE',
                        headers: {
                            'apikey': EVOLUTION_API_KEY
                        }
                    });
                    
                    const data = await response.json();
                    
                    // Delete from Firebase regardless of API response
                    await window.firebase.deleteDoc(
                        window.firebase.doc(window.db, 'whatsappDevices', deviceId)
                    );
                    
                    // Remove from local state
                    const deviceIndex = whatsappDevices.findIndex(d => d.id === deviceId);
                    if (deviceIndex !== -1) {
                        whatsappDevices.splice(deviceIndex, 1);
                    }
                    
                    // Stop polling if any
                    if (pollingIntervals[instanceName]) {
                        clearInterval(pollingIntervals[instanceName]);
                        delete pollingIntervals[instanceName];
                    }
                    
                    showAlert('âœ… Cihaz baÅŸarÄ±yla silindi.', 'success');
                    loadWhatsAppInstances();
                } catch (error) {
                    console.error('Delete instance error:', error);
                    showAlert('Ä°ÅŸlem sÄ±rasÄ±nda hata oluÅŸtu.', 'danger');
                }
            });
        }

        // --- HANDLER FUNCTIONS ---
        async function handleRegistration(e, initialStatus) {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            
            // Butonu devre dÄ±ÅŸÄ± bÄ±rak (Ã§ift tÄ±klama Ã¶nleme)
            if (submitBtn) {
                if (submitBtn.disabled) return; // Zaten iÅŸlem yapÄ±lÄ±yorsa Ã§Ä±k
                submitBtn.disabled = true;
                submitBtn.textContent = 'â³ Kaydediliyor...';
            }
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const memberType = data.memberType;
                let parentName = data.parentName;

                if (memberType === 'child' && !parentName) {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'ğŸ“ KayÄ±t OluÅŸtur';
                    }
                    return showAlert('Ã‡ocuk kayÄ±tlarÄ± iÃ§in Veli AdÄ± SoyadÄ± zorunludur.', 'warning');
                }
                if (memberType === 'adult') {
                    parentName = '';
                }

                // âœ… Ã–ÄŸrenci listesini topla
                let students = [];
                if (memberType === 'child') {
                    // Ã‡oklu Ã§ocuk desteÄŸi
                    const studentFields = form.querySelectorAll('.student-field-group');
                    studentFields.forEach((field, index) => {
                        const studentName = formData.get(`studentName_${index}`);
                        const studentBirthDate = formData.get(`studentBirthDate_${index}`) || null; // âœ… BoÅŸ string yerine null
                        if (studentName) {
                            students.push({ studentName, studentBirthDate, index });
                        }
                    });
                    
                    if (students.length === 0) {
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'ğŸ“ KayÄ±t OluÅŸtur';
                        }
                        return showAlert('En az bir Ã¶ÄŸrenci eklemelisiniz.', 'warning');
                    }
                } else {
                    // YetiÅŸkin iÃ§in tek Ã¶ÄŸrenci
                    students.push({
                        studentName: data.studentName,
                        studentBirthDate: data.studentBirthDate || null // âœ… BoÅŸ string yerine null
                    });
                }

                const subsequentInstallments = parseInt(data.installments);
                if (isNaN(subsequentInstallments)) throw new Error("Taksit sayÄ±sÄ± geÃ§ersiz.");
                const totalInstallments = subsequentInstallments + 1;
                
                const firstAmount = parseFloat(unformatCurrency(data.firstInstallmentAmount) || '0');
                const subsequentAmount = parseFloat(unformatCurrency(data.subsequentInstallmentAmount) || '0');

                const paymentSchedule = generatePaymentSchedule(
                    new Date(data.firstPeriodStart), new Date(data.firstPeriodEnd), new Date(data.firstDueDate),
                    totalInstallments, firstAmount, subsequentAmount,
                    parseInt(data.dueDay), parseInt(data.firstLessonCount)
                );

                if (paymentSchedule.length === 0) {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'ğŸ“ KayÄ±t OluÅŸtur';
                    }
                    return showAlert('Ã–deme planÄ± oluÅŸturulamadÄ±. LÃ¼tfen tarihleri ve tutarlarÄ± kontrol edin.', 'warning');
                }

                const finalEndDate = paymentSchedule[paymentSchedule.length - 1].period.end;
                const isChild = memberType === 'child';

                // âœ… Her Ã¶ÄŸrenci iÃ§in kayÄ±t oluÅŸtur
                let createdCount = 0;
                for (const student of students) {
                    // âœ… Ã‡Ã–ZÃœM: Her Ã¶ÄŸrenci iÃ§in Ã¶deme planÄ±nÄ±n baÄŸÄ±msÄ±z bir kopyasÄ±nÄ± oluÅŸtur
                    const independentPaymentSchedule = JSON.parse(JSON.stringify(paymentSchedule));
                    
                    const preRegData = {
                        parentName,
                        parentName2: data.parentName2 || '',
                        phone2: data.phone2 || '',
                        studentName: student.studentName,
                        studentBirthDate: student.studentBirthDate,
                        phone: data.phone,
                        branch: data.branch,
                        periodStart: data.firstPeriodStart,
                        periodEnd: finalEndDate,
                        paymentSchedule: independentPaymentSchedule,
                        status: 'pending_contract',
                        createdAt: new Date().toISOString(),
                        notes: data.notes,
                        clubId: currentClubId
                    };

                    const preRegRef = await window.firebase.addDoc(window.firebase.collection(window.db, 'preRegistrations'), preRegData);
                    
                    const memberData = {
                        Ad_Soyad: isChild ? parentName : student.studentName,
                        Veli_2_Adi_Soyadi: data.parentName2 || '',
                        Telefon_2: data.phone2 || '',
                        Resit_Olmayan_Adi_Soyadi: isChild ? student.studentName : '',
                        Telefon: data.phone,
                        Brans: data.branch,
                        studentBirthDate: student.studentBirthDate,
                        status: initialStatus,
                        registrationDate: new Date().toISOString(),
                        preRegistrationId: preRegRef.id,
                        clubId: currentClubId
                    };
                    
                    let memberIdToAssign = null;
                    const existingMember = members.find(m => m.Telefon === data.phone && (m.Resit_Olmayan_Adi_Soyadi || m.Ad_Soyad) === student.studentName);

                    if(!existingMember) {
                        const memberRef = await window.firebase.addDoc(window.firebase.collection(window.db, 'members'), memberData);
                        memberIdToAssign = memberRef.id;
                    } else {
                        memberIdToAssign = existingMember.id;
                        const { preRegistrationId, ...memberDataWithoutPreRegId } = memberData;
                        await window.firebase.updateDoc(window.firebase.doc(window.db, 'members', existingMember.id), memberDataWithoutPreRegId);
                    }

                    if(data.groupId && memberIdToAssign) {
                         await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', data.groupId), {
                             members: window.firebase.arrayUnion(memberIdToAssign)
                        });
                    }
                    
                    createdCount++;
                }
                
                showAlert(`âœ… ${createdCount} Ã¶ÄŸrenci iÃ§in kayÄ±t baÅŸarÄ±lÄ±! "Bekleyen KayÄ±tlar" listesine eklendi.`, 'success');
                form.reset();
                toggleParentStudentFields(form);
                previewPaymentPlan(form);
                await loadData();
            } catch (error) { 
                console.error(error); 
                showAlert(`KayÄ±t oluÅŸturulurken hata oluÅŸtu: ${error.message}`, 'danger'); 
            } finally {
                // Butonu tekrar aktif et
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ğŸ“ KayÄ±t OluÅŸtur';
                }
            }
        }

        function recalculateSubsequentPayments(schedule, startIndex) {
            for (let i = startIndex + 1; i < schedule.length; i++) {
                const prevPayment = schedule[i - 1];
                const currentPayment = schedule[i];

                let newStartDate = new Date(prevPayment.period.end);
                newStartDate.setDate(newStartDate.getDate() + 1);
                currentPayment.period.start = newStartDate.toISOString().split('T')[0];

                let newEndDate = new Date(newStartDate);
                newEndDate.setDate(newEndDate.getDate() + 27); 
                currentPayment.period.end = newEndDate.toISOString().split('T')[0];
                
                let newDueDate = new Date(prevPayment.dueDate + 'T12:00:00');
                newDueDate.setMonth(newDueDate.getMonth() + 1);
                currentPayment.dueDate = newDueDate.toISOString().split('T')[0];
            }
            return schedule;
        }

        async function handlePayment(e) {
            e.preventDefault();
            const form = e.target;
            const preRegId = form.paymentPreRegId.value;
            const paymentNumber = parseInt(form.paymentNumber.value);
            const isNewPayment = form.dataset.mode === 'new';
            
            try {
                const preReg = preRegistrations.find(p => p.id === preRegId);
                if (!preReg || !preReg.paymentSchedule) throw new Error("Ã–deme planÄ± bulunamadÄ±.");
                
                let updatedSchedule = [...preReg.paymentSchedule];
                let totalPaymentsToAdd = 1; // âœ… Declare outside if block to avoid scope issue

                if (isNewPayment) {
                    // âœ… KaÃ§ ay daha aidat eklenecek?
                    const additionalMonths = parseInt(form.additionalMonths.value) || 0;
                    totalPaymentsToAdd = additionalMonths + 1; // Bu ay + ek aylar
                    
                    const baseAmount = parseFloat(unformatCurrency(form.paymentAmount.value) || '0');
                    const basePeriodStart = new Date(form.periodStart.value);
                    const basePeriodEnd = new Date(form.periodEnd.value);
                    const baseDueDate = new Date(form.paymentDueDate.value);
                    const baseLessonCount = parseInt(form.lessonCount.value) || 8;
                    
                    // âœ… Birden fazla aidat oluÅŸtur
                    for (let i = 0; i < totalPaymentsToAdd; i++) {
                        let periodStart, periodEnd, dueDate;
                        
                        if (i === 0) {
                            // Ä°lk aidat - formdan gelen deÄŸerler
                            periodStart = new Date(basePeriodStart);
                            periodEnd = new Date(basePeriodEnd);
                            dueDate = new Date(baseDueDate);
                        } else {
                            // Sonraki aidatlar - otomatik hesaplama
                            const prevPayment = updatedSchedule[updatedSchedule.length - 1];
                            periodStart = new Date(prevPayment.period.end);
                            periodStart.setDate(periodStart.getDate() + 1);
                            
                            periodEnd = new Date(periodStart);
                            periodEnd.setDate(periodEnd.getDate() + 27); // ~4 hafta
                            
                            dueDate = new Date(baseDueDate);
                            dueDate.setMonth(dueDate.getMonth() + i);
                        }
                        
                        const newPayment = {
                            paymentNumber: updatedSchedule.length + 1,
                            amount: baseAmount,
                            dueDate: dueDate.toISOString().split('T')[0],
                            status: form.paymentStatus.value,
                            note: i === 0 ? form.paymentNote.value : `Otomatik oluÅŸturuldu (${i + 1}/${totalPaymentsToAdd})`,
                            method: form.paymentMethod.value,
                            paymentDate: form.paymentDate.value || null,
                            period: {
                                start: periodStart.toISOString().split('T')[0],
                                end: periodEnd.toISOString().split('T')[0],
                                lessonCount: baseLessonCount
                            }
                        };
                        updatedSchedule.push(newPayment);
                    }
                    
                    updatedSchedule.sort((a,b) => new Date(a.period.start) - new Date(b.period.start));
                    
                    // Ã–deme numaralarÄ±nÄ± yeniden dÃ¼zenle
                    updatedSchedule.forEach((p, idx) => {
                        p.paymentNumber = idx + 1;
                    });
                } else {
                    const paymentIndex = updatedSchedule.findIndex(p => p.paymentNumber === paymentNumber);
                    if (paymentIndex === -1) throw new Error("DÃ¼zenlenecek Ã¶deme bulunamadÄ±.");

                    const originalPayment = updatedSchedule[paymentIndex];
                    const updatedPaymentData = { ...originalPayment };
                    updatedPaymentData.amount = parseFloat(unformatCurrency(form.paymentAmount.value) || '0');
                    updatedPaymentData.dueDate = form.paymentDueDate.value;
                    updatedPaymentData.status = form.paymentStatus.value;
                    updatedPaymentData.note = form.paymentNote.value;
                    if (form.paymentDate.value) updatedPaymentData.paymentDate = form.paymentDate.value;
                    if (form.paymentMethod.value) updatedPaymentData.method = form.paymentMethod.value;
                     // Update period info only if the fields exist in the form
                    if(form.periodStart && form.periodEnd && form.lessonCount){
                        updatedPaymentData.period = {
                            start: form.periodStart.value,
                            end: form.periodEnd.value,
                            lessonCount: parseInt(form.lessonCount.value) || 0
                        };
                    }


                    updatedSchedule[paymentIndex] = updatedPaymentData;

                    // Recalculate subsequent payments
                    updatedSchedule = recalculateSubsequentPayments(updatedSchedule, paymentIndex);
                }

                // Renumber payments to ensure they are sequential
                updatedSchedule.forEach((p, index) => {
                    p.paymentNumber = index + 1;
                });

                await window.firebase.updateDoc(window.firebase.doc(window.db, 'preRegistrations', preRegId), { paymentSchedule: updatedSchedule });
                
                closeModal('paymentModal');
                
                // âœ… KaÃ§ tane Ã¶deme eklendiÄŸini gÃ¶ster
                const successMessage = isNewPayment 
                    ? (totalPaymentsToAdd > 1 ? `${totalPaymentsToAdd} aidat baÅŸarÄ±yla eklendi` : 'Ã–deme baÅŸarÄ±yla eklendi')
                    : 'Ã–deme baÅŸarÄ±yla gÃ¼ncellendi';
                showAlert(successMessage, 'success');
                
                await loadData();
                
                // âœ… Ä°statistikleri ve listeyi gÃ¼ncelle (gecikmiÅŸ Ã¶demeler iÃ§in)
                if (typeof updatePaymentStats === 'function') {
                    updatePaymentStats();
                }
                if (typeof renderPaymentsList === 'function' && currentSection === 'payments') {
                    renderPaymentsList();
                }
                
                viewPaymentPlan(preRegId); 

            } catch (error) { 
                console.error("Payment update error:", error);
                showAlert(`Ã–deme ${isNewPayment ? 'eklenirken' : 'gÃ¼ncellenirken'} hata oluÅŸtu: ${error.message}`, 'danger'); 
            }
        }


        async function handleNewSchedule(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const selectedDays = formData.getAll('days');

            if (selectedDays.length === 0) {
                return showAlert('LÃ¼tfen en az bir ders gÃ¼nÃ¼ seÃ§in.', 'warning');
            }

            const group = groups.find(g => g.id === data.groupId);
            if (!group) return showAlert('GeÃ§ersiz grup.', 'danger');
            
            try {
                const schedulePromises = selectedDays.map(day => {
                    const scheduleData = {
                        groupId: data.groupId, 
                        day: day, 
                        startTime: data.startTime, 
                        endTime: data.endTime,
                        branch: group.branch,
                        court: data.court || null, // âœ… Saha bilgisi
                        clubId: currentClubId
                    };
                    return window.firebase.addDoc(window.firebase.collection(window.db, 'schedules'), scheduleData);
                });

                await Promise.all(schedulePromises);
                showAlert(`${selectedDays.length} ders baÅŸarÄ±yla oluÅŸturuldu`, 'success');
                closeModal('scheduleModal');
                await loadData();
            } catch (error) { 
                console.error('Error creating schedules:', error);
                showAlert('Dersler oluÅŸturulurken hata oluÅŸtu', 'danger'); 
            }
        }

        async function handleGroup(e) {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());
            const groupId = data.groupId;
            delete data.groupId;

            try {
                if(groupId){
                     await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', groupId), data);
                     showAlert('Grup baÅŸarÄ±yla gÃ¼ncellendi', 'success');
                } else {
                    await window.firebase.addDoc(window.firebase.collection(window.db, 'groups'), { 
                        ...data, 
                        members: [], 
                        createdAt: new Date().toISOString(),
                        clubId: currentClubId // âœ… KulÃ¼p ID'si eklendi
                    });
                    showAlert('Grup baÅŸarÄ±yla oluÅŸturuldu', 'success');
                }
                closeModal('groupModal');
                form.reset();
                await loadData();
            } catch (error) { showAlert('Grup kaydedilirken hata oluÅŸtu', 'danger'); }
        }

        async function handleMemberUpdate(e) {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());
            const memberId = data.memberId;
            
            if (!memberId) {
                showAlert('âŒ Ãœye ID bulunamadÄ±!', 'danger');
                return;
            }
            
            delete data.memberId;
            
            // âœ… DoÄŸum tarihini hem studentBirthDate hem DogumTarihi olarak kaydet
            if (data.studentBirthDate && data.studentBirthDate !== '') {
                data.DogumTarihi = data.studentBirthDate;
            }
            
            // âœ… BoÅŸ deÄŸerleri null olarak iÅŸaretle (silme yerine)
            Object.keys(data).forEach(key => {
                if (data[key] === '' && key !== 'Resit_Olmayan_Adi_Soyadi' && key !== 'Veli_2_Adi_Soyadi' && key !== 'Telefon_2' && key !== 'studentBirthDate' && key !== 'Brans') {
                    // Zorunlu alanlar boÅŸ olamaz
                    if (key === 'Ad_Soyad' || key === 'Telefon') {
                        // Bu alanlar form validation ile zaten kontrol ediliyor
                    } else {
                        delete data[key];
                    }
                } else if (data[key] === '') {
                    // Opsiyonel alanlarÄ± temizle
                    delete data[key];
                }
            });

            console.log('Updating member:', memberId, 'with data:', data);

            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'members', memberId), data);
                showAlert('âœ… Ãœye bilgileri baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
                closeModal('memberEditModal');
                await loadData();
                
                // âœ… EÄŸer member detail modalÄ± aÃ§Ä±ksa onu kapat
                const memberDetailModal = document.getElementById('memberDetailModal');
                if (memberDetailModal) {
                    closeMemberDetail();
                }
                
                // âœ… Ãœyeler tablosunu gÃ¼ncelle
                if (typeof renderMembersTable === 'function') {
                    renderMembersTable();
                }
            } catch (error) {
                console.error('Member update error:', error);
                showAlert('âŒ Ãœye bilgileri gÃ¼ncellenirken hata oluÅŸtu: ' + error.message, 'danger');
            }
        }

        async function handlePreRegUpdate(e) {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());
            const preRegId = data.preRegId;
            const newGroupId = data.groupId;
            delete data.preRegId;
            delete data.groupId;
            delete data.groupSearch; // remove search text from data
            
            console.log('PreReg Update - Form Data:', { preRegId, newGroupId, data });
            
            const member = members.find(m => m.preRegistrationId === preRegId);
            console.log('PreReg Update - Found member:', member);
            
            // If it's an adult registration, ensure parentName is cleared
            if(member && !member.Resit_Olmayan_Adi_Soyadi) {
                 data.parentName = '';
            }

            try {
                // Update pre-registration text fields
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'preRegistrations', preRegId), data);

                // Handle group change - only if member exists and newGroupId is provided
                if (member && newGroupId && newGroupId.trim() !== '') {
                    console.log('PreReg Update - Adding member to group:', { memberId: member.id, groupId: newGroupId });
                    
                    // Find current groups this member is in
                    const currentGroups = groups.filter(g => Array.isArray(g.members) && g.members.includes(member.id));
                    console.log('PreReg Update - Current groups:', currentGroups.map(g => g.id));
                    
                    // Remove from old groups (except the new one)
                    for (const oldGroup of currentGroups) {
                        if (oldGroup.id !== newGroupId) {
                            console.log('PreReg Update - Removing from old group:', oldGroup.id);
                            await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', oldGroup.id), {
                                members: window.firebase.arrayRemove(member.id)
                            });
                        }
                    }
                    
                    // Add to new group
                    await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', newGroupId), {
                        members: window.firebase.arrayUnion(member.id)
                    });
                    console.log('PreReg Update - Successfully added to group');
                } else {
                    console.log('PreReg Update - Skipping group update:', { 
                        hasMember: !!member, 
                        hasGroupId: !!newGroupId,
                        groupIdValue: newGroupId 
                    });
                }

                showAlert('Ã–n kayÄ±t bilgileri gÃ¼ncellendi.', 'success');
                closeModal('preRegEditModal');
                await loadData();
            } catch (error) {
                console.error("Pre-registration update error:", error);
                showAlert('Ã–n kayÄ±t gÃ¼ncellenirken bir hata oluÅŸtu.', 'danger');
            }
        }
        
        async function handleAttendanceSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const groupId = formData.get('groupId');
            const presentMemberIds = formData.getAll('presentMembers');
            const attendanceDate = formData.get('attendanceDate'); // NEW: Get date from form
            if (!attendanceDate) {
                return showAlert('LÃ¼tfen yoklama tarihini seÃ§in.', 'warning');
            }
            
            const group = groups.find(g => g.id === groupId);
            if(!group) return showAlert('Grup bulunamadÄ±', 'danger');

            const groupMembers = members.filter(m => Array.isArray(group.members) && group.members.includes(m.id) && m.status === 'active');


            for (const member of groupMembers) {
                const isPresent = presentMemberIds.includes(member.id);
                const status = isPresent ? 'present' : 'absent';
                const reason = formData.get(`reason_${member.id}`) || '';

                const record = {
                    memberId: member.id,
                    groupId: groupId,
                    date: attendanceDate,
                    status: status,
                    reason: reason,
                    recordedBy: currentUser.fullName || currentUser.username,
                    clubId: currentClubId // âœ… KulÃ¼p ID'si eklendi
                };

                // Ã¢Å“â€¦ Supabase ile mevcut kaydÃ„Â± kontrol et
                const { data: existingRecords, error: queryError } = await supabase
                    .from('attendanceRecords')
                    .select('id')
                    .eq('memberId', member.id)
                    .eq('groupId', groupId)
                    .eq('date', attendanceDate)
                    .eq('clubId', currentClubId);
                
                if (queryError) {
                    console.error('Yoklama sorgu hatasÃ„Â±:', queryError);
                    throw queryError;
                }
                
                // Mevcut kayÃ„Â±t varsa gÃƒÂ¼ncelle, yoksa yeni ekle
                if (existingRecords && existingRecords.length > 0) {
                    attendancePromises.push(
                        supabase
                            .from('attendanceRecords')
                            .update(record)
                            .eq('id', existingRecords[0].id)
                    );
                } else {
                    attendancePromises.push(
                        supabase
                            .from('attendanceRecords')
                            .insert(record)
                    );
                }
            }

            try {
                // Ã¢Å“â€¦ Supabase upsert ile tek seferde kaydet (onConflict: id ile gÃƒÂ¼nceller)
                const { error: upsertError } = await supabase
                    .from('attendanceRecords')
                    .upsert(records, { onConflict: 'id' });
                
                if (upsertError) {
                    console.error('Yoklama kaydetme hatasÃ„Â±:', upsertError);
                    throw upsertError;
                }
                
                // DevamsÄ±zlÄ±k mesajlarÄ± gÃ¶nder (sebep belirtilmemiÅŸ olanlar iÃ§in)
                const absenceMessagesToSend = [];
                for (const member of groupMembers) {
                    const isPresent = presentMemberIds.includes(member.id);
                    const reason = formData.get(`reason_${member.id}`) || '';
                    
                    // EÄŸer devamsÄ±z ve sebep boÅŸsa mesaj gÃ¶nder
                    if (!isPresent && !reason) {
                        absenceMessagesToSend.push({
                            member: member,
                            date: attendanceDate,
                            groupName: group.groupName
                        });
                    }
                }
                
                // MesajlarÄ± arka planda gÃ¶nder (await etmeden)
                if (absenceMessagesToSend.length > 0) {
                    console.log(`ğŸ“§ ${absenceMessagesToSend.length} devamsÄ±zlÄ±k mesajÄ± gÃ¶nderiliyor...`);
                    sendAbsenceNotifications(absenceMessagesToSend).catch(err => {
                        console.error('DevamsÄ±zlÄ±k mesajlarÄ± gÃ¶nderilirken hata:', err);
                    });
                }
                
                showAlert(`${group.groupName} iÃ§in yoklama kaydedildi.${absenceMessagesToSend.length > 0 ? ` (${absenceMessagesToSend.length} devamsÄ±zlÄ±k mesajÄ± gÃ¶nderiliyor)` : ''}`, 'success');
                closeModal('attendanceModal');
                await loadData();
            } catch(error) {
                console.error("Attendance save error:", error);
                showAlert('Yoklama kaydedilirken bir hata oluÅŸtu.', 'danger');
            }
        }
        
        async function handleSettingsUpdate(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const off_days = formData.getAll('holidays');
            const newClubName = formData.get('clubName');
            
            // Bulutfon ayarlarÄ±
            const bulutfonEnabled = document.getElementById('bulutfonEnabled')?.checked || false;
            const bulutfonApiKey = document.getElementById('bulutfonApiKey')?.value || '';

            // âœ… Webhook ayarlarÄ±
            const webhookEnabled = document.getElementById('webhookEnabled')?.checked || false;
            const webhookUrl = document.getElementById('webhookUrl')?.value || '';

            try {
                await window.firebase.setDoc(window.firebase.doc(window.db, 'settings', `holidays_${currentClubId}`), { off_days });
                
                // âœ… AyarlarÄ± club settings'e kaydet
                const updatedSettings = {
                    clubName: newClubName || clubSettings.clubName,
                    bulutfonEnabled: bulutfonEnabled,
                    bulutfonApiKey: bulutfonApiKey,
                    updatedAt: new Date().toISOString()
                };
                
                await window.firebase.setDoc(
                    window.firebase.doc(window.db, 'settings', `club_${currentClubId}`), 
                    updatedSettings,
                    { merge: true }
                );
                
                // âœ… Webhook ayarlarÄ±nÄ± kaydet
                const webhookData = {
                    active: webhookEnabled,
                    url: webhookUrl,
                    eventType: 'contract_signed',
                    clubId: currentClubId,
                    updatedAt: new Date().toISOString()
                };
                
                await window.firebase.setDoc(
                    window.firebase.doc(window.db, 'webhooks', `contract_${currentClubId}`),
                    webhookData,
                    { merge: true }
                );
                
                // Local state gÃ¼ncelle
                clubSettings = { ...clubSettings, ...updatedSettings };
                
                showAlert('âœ… Ayarlar baÅŸarÄ±yla gÃ¼ncellendi.', 'success');
                await loadData();
            } catch (error) {
                console.error("Error updating settings:", error);
                showAlert('Ayarlar gÃ¼ncellenirken bir hata oluÅŸtu.', 'danger');
            }
        }
        
        // âœ… WhatsApp Mesaj GÃ¶nderim AyarlarÄ±nÄ± Kaydet
        window.saveWhatsAppSettings = async function() {
            try {
                // Ã‡alÄ±ÅŸma saatleri ayarlarÄ±
                const workingHoursEnabled = document.getElementById('workingHoursEnabled').checked;
                const workingDays = [];
                for (let i = 0; i <= 6; i++) {
                    const checkbox = document.getElementById(`workDay-${i}`);
                    if (checkbox && checkbox.checked) {
                        workingDays.push(i);
                    }
                }
                
                const settings = {
                    minWaitTime: parseInt(document.getElementById('minWaitTime').value) || 20,
                    maxWaitTime: parseInt(document.getElementById('maxWaitTime').value) || 50,
                    longWaitTrigger: parseInt(document.getElementById('longWaitTrigger').value) || 100,
                    minLongWait: parseInt(document.getElementById('minLongWait').value) || 400,
                    maxLongWait: parseInt(document.getElementById('maxLongWait').value) || 800,
                    workingHoursEnabled: workingHoursEnabled,
                    workingHoursStart: document.getElementById('workingHoursStart').value || '09:00',
                    workingHoursEnd: document.getElementById('workingHoursEnd').value || '18:00',
                    workingDays: workingDays
                };
                
                await window.firebase.setDoc(
                    window.firebase.doc(window.db, 'settings', `club_${currentClubId}`), 
                    settings,
                    { merge: true }
                );
                
                // Local state gÃ¼ncelle
                clubSettings = { ...clubSettings, ...settings };
                
                // âœ… Toplu mesaj Ã¶zetini gÃ¼ncelle
                updateBulkMessageSettings();
                
                showAlert('âœ… WhatsApp ayarlarÄ± baÅŸarÄ±yla gÃ¼ncellendi.', 'success');
            } catch (error) {
                console.error("Error updating WhatsApp settings:", error);
                showAlert('Ayarlar gÃ¼ncellenirken bir hata oluÅŸtu.', 'danger');
            }
        };
        
        // Ã‡alÄ±ÅŸma saatleri toggle
        window.toggleWorkingHoursFields = function() {
            const enabled = document.getElementById('workingHoursEnabled').checked;
            document.getElementById('workingHoursFields').style.display = enabled ? 'block' : 'none';
        };
        
        // Bulutfon toggle
        window.toggleBulutfonFields = function() {
            const enabled = document.getElementById('bulutfonEnabled').checked;
            const settingsDiv = document.getElementById('bulutfon-api-settings');
            if (settingsDiv) {
                settingsDiv.style.display = enabled ? 'block' : 'none';
            }
        };
        
        // Bulutfon ayarlarÄ±nÄ± kaydet
        window.saveBulutfonSettings = async function() {
            try {
                const enabled = document.getElementById('bulutfonEnabled').checked;
                const apiKey = document.getElementById('bulutfonApiKey').value;
                
                if (enabled && !apiKey) {
                    showAlert('âš ï¸ LÃ¼tfen Bulutfon API Key\'ini girin.', 'warning');
                    return;
                }
                
                const settings = {
                    bulutfonEnabled: enabled,
                    bulutfonApiKey: apiKey
                };
                
                await window.firebase.setDoc(
                    window.firebase.doc(window.db, 'settings', `club_${currentClubId}`), 
                    settings,
                    { merge: true }
                );
                
                clubSettings = { ...clubSettings, ...settings };
                
                showAlert('âœ… Bulutfon ayarlarÄ± baÅŸarÄ±yla kaydedildi.', 'success');
            } catch (error) {
                console.error("Error saving Bulutfon settings:", error);
                showAlert('Bulutfon ayarlarÄ± kaydedilirken bir hata oluÅŸtu.', 'danger');
            }
        };
        
        // Bulutfon API baÄŸlantÄ±sÄ±nÄ± test et
        window.testBulutfonConnection = async function() {
            const apiKey = document.getElementById('bulutfonApiKey').value;
            const resultDiv = document.getElementById('bulutfonTestResult');
            
            if (!apiKey) {
                showAlert('âš ï¸ LÃ¼tfen Ã¶nce API Key\'i girin.', 'warning');
                return;
            }
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><span>API baÄŸlantÄ±sÄ± test ediliyor...</span></div>';
            
            try {
                console.log('ğŸ” Bulutfon API testi baÅŸlatÄ±lÄ±yor...');
                
                // Firebase Functions proxy Ã¼zerinden Ã§aÄŸÄ±r (CORS sorunu Ã§Ã¶zÃ¼mÃ¼)
                // API key query parameter olarak gÃ¶nderiliyor
                const response = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${apiKey}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('ğŸ“¡ API Response Status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    
                    let errorDetail = '';
                    if (response.status === 401 || response.status === 403) {
                        errorDetail = 'API Key geÃ§ersiz veya yetkilendirme hatasÄ±.';
                    } else if (response.status === 500) {
                        errorDetail = 'Bulutfon sunucu hatasÄ±. HesabÄ±nÄ±zda CDR (Arama KayÄ±tlarÄ±) yetkisi olmayabilir.';
                    } else {
                        errorDetail = response.statusText;
                    }
                    
                    throw new Error(`API HatasÄ± ${response.status}: ${errorDetail}`);
                }
                
                const data = await response.json();
                console.log('âœ… API Response Data:', data);
                console.log('ğŸ“Š Data Keys:', Object.keys(data));
                console.log('ğŸ“¦ Full Response:', JSON.stringify(data, null, 2));
                
                // Bulutfon v2 API'den gelen data yapÄ±sÄ±nÄ± kontrol et
                const records = Array.isArray(data) ? data : (data.cdrs || data.data || []);
                const recordCount = records.length;
                
                resultDiv.innerHTML = `
                    <div style="padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px;">
                        <div style="color: #155724; font-weight: 600; margin-bottom: 8px;">
                            âœ… BaÄŸlantÄ± baÅŸarÄ±lÄ±!
                        </div>
                        <div style="color: #155724; font-size: 13px;">
                            ğŸ“Š Bulutfon API'den ${recordCount} adet gÃ¶rÃ¼ÅŸme kaydÄ± alÄ±ndÄ±.<br>
                            ğŸ”— API Key geÃ§erli ve Ã§alÄ±ÅŸÄ±yor.
                        </div>
                        ${recordCount > 0 ? `
                            <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 6px; font-size: 12px;">
                                <strong>Son gÃ¶rÃ¼ÅŸme:</strong><br>
                                ğŸ“ ${records[0].caller || records[0].src || 'N/A'} â†’ ${records[0].callee || records[0].dst || 'N/A'}<br>
                                ğŸ“… ${new Date(records[0].call_Time || records[0].call_date).toLocaleString('tr-TR')}<br>
                                â±ï¸ ${records[0].duration ? records[0].duration + ' sn' : (records[0].billsec ? Math.floor(records[0].billsec / 60) + ':' + (records[0].billsec % 60).toString().padStart(2, '0') : '0:00')}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                showAlert('âœ… Bulutfon API baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±!', 'success');
            } catch (error) {
                console.error('âŒ Bulutfon API test hatasÄ±:', error);
                
                resultDiv.innerHTML = `
                    <div style="padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px;">
                        <div style="color: #721c24; font-weight: 600; margin-bottom: 8px;">
                            âŒ BaÄŸlantÄ± baÅŸarÄ±sÄ±z!
                        </div>
                        <div style="color: #721c24; font-size: 13px;">
                            <strong>Hata:</strong> ${error.message}<br><br>
                            <strong>Kontrol listesi:</strong><br>
                            â€¢ Bulutfon panelinden aldÄ±ÄŸÄ±nÄ±z API Key'i doÄŸru girdikten emin olun<br>
                            â€¢ API Key'in aktif olduÄŸundan emin olun<br>
                            â€¢ Bulutfon hesabÄ±nÄ±zda <strong>CDR (Call Detail Records)</strong> yetkisinin olduÄŸunu kontrol edin<br>
                            â€¢ Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin<br>
                            â€¢ Sorun devam ederse Bulutfon destek ekibiyle iletiÅŸime geÃ§in
                        </div>
                    </div>
                `;
                
                showAlert('âŒ Bulutfon API baÄŸlantÄ±sÄ± baÅŸarÄ±sÄ±z: ' + error.message, 'danger');
            }
        };
        
        // ============================================
        // âœ… Ã‡ALIÅMA SAATLERÄ° VE MESAJ KUYRUÄU
        // ============================================
        
        // Ã‡alÄ±ÅŸma saatleri iÃ§inde mi kontrol et
        function isWithinWorkingHours() {
            if (!clubSettings || !clubSettings.workingHoursEnabled) {
                return true; // Ã‡alÄ±ÅŸma saatleri devre dÄ±ÅŸÄ±ysa her zaman true
            }
            
            const now = new Date();
            const currentDay = now.getDay(); // 0 = Pazar, 1 = Pazartesi, ...
            const currentTime = now.getHours() * 60 + now.getMinutes(); // Dakika cinsinden
            
            // Ã‡alÄ±ÅŸma gÃ¼nÃ¼ mÃ¼?
            if (!clubSettings.workingDays || !clubSettings.workingDays.includes(currentDay)) {
                return false;
            }
            
            // Ã‡alÄ±ÅŸma saati iÃ§inde mi?
            const [startHour, startMin] = (clubSettings.workingHoursStart || '09:00').split(':').map(Number);
            const [endHour, endMin] = (clubSettings.workingHoursEnd || '18:00').split(':').map(Number);
            const startTime = startHour * 60 + startMin;
            const endTime = endHour * 60 + endMin;
            
            return currentTime >= startTime && currentTime < endTime;
        }
        
        // MesajÄ± kuyruÄŸa ekle
        async function addMessageToQueue(phone, message, deviceId) {
            try {
                const queueItem = {
                    phone: phone,
                    message: message,
                    deviceId: deviceId,
                    clubId: currentClubId,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    scheduledFor: getNextWorkingHour()
                };
                
                console.log('ğŸ“ KuyruÄŸa eklenecek mesaj:', {
                    phone,
                    deviceId,
                    clubId: currentClubId,
                    status: 'pending',
                    scheduledFor: queueItem.scheduledFor
                });
                
                const docRef = await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'messageQueue'),
                    queueItem
                );
                
                console.log('âœ… Mesaj kuyruÄŸa eklendi:', { 
                    docId: docRef.id, 
                    path: docRef.path,
                    clubId: currentClubId,
                    data: queueItem 
                });
                return docRef.id;
            } catch (error) {
                console.error('âŒ Mesaj kuyruÄŸa eklenirken hata:', error);
                throw error;
            }
        }
        
        // Bir sonraki Ã§alÄ±ÅŸma saatini bul
        function getNextWorkingHour() {
            if (!clubSettings || !clubSettings.workingHoursEnabled) {
                return new Date().toISOString();
            }
            
            const now = new Date();
            let checkDate = new Date(now);
            
            // Maksimum 7 gÃ¼n ileri kontrol et
            for (let i = 0; i < 7; i++) {
                const dayOfWeek = checkDate.getDay();
                
                if (clubSettings.workingDays && clubSettings.workingDays.includes(dayOfWeek)) {
                    const [startHour, startMin] = (clubSettings.workingHoursStart || '09:00').split(':').map(Number);
                    checkDate.setHours(startHour, startMin, 0, 0);
                    
                    // EÄŸer bu saat gelecekteyse, bu saati dÃ¶ndÃ¼r
                    if (checkDate > now) {
                        return checkDate.toISOString();
                    }
                }
                
                // Bir sonraki gÃ¼ne geÃ§
                checkDate.setDate(checkDate.getDate() + 1);
                checkDate.setHours(0, 0, 0, 0);
            }
            
            return new Date().toISOString();
        }
        
        // Mesaj kuyruÄŸunu gÃ¶ster
        async function renderMessageQueue() {
            try {
                console.log('ğŸ”„ Mesaj kuyruÄŸu yÃ¼kleniyor...', { clubId: currentClubId });
                
                const container = document.getElementById('messageQueueList');
                if (!container) {
                    console.error('âŒ messageQueueList container bulunamadÄ±!');
                    return;
                }
                
                container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Kuyruk yÃ¼kleniyor...</span></div>';
                
                // 1ï¸âƒ£ PENDING MESAJLAR
                const messagesRef = window.firebase.collection(window.db, 'messageQueue');
                const pendingQuery = window.firebase.query(
                    messagesRef,
                    window.firebase.where('clubId', '==', currentClubId),
                    window.firebase.where('status', '==', 'pending')
                );
                
                const pendingSnapshot = await window.firebase.getDocs(pendingQuery);
                
                // 2ï¸âƒ£ FAILED MESAJLAR
                const failedQuery = window.firebase.query(
                    messagesRef,
                    window.firebase.where('clubId', '==', currentClubId),
                    window.firebase.where('status', '==', 'failed')
                );
                
                const failedSnapshot = await window.firebase.getDocs(failedQuery);
                
                console.log('ğŸ“Š Kuyruk sorgusu tamamlandÄ±:', { 
                    pending: pendingSnapshot.size,
                    failed: failedSnapshot.size
                });
                
                let html = '';
                
                // âœ… BEKLEYEN MESAJLAR
                if (!pendingSnapshot.empty) {
                    const pendingMessages = [];
                    pendingSnapshot.docs.forEach(doc => {
                        pendingMessages.push({ id: doc.id, ...doc.data() });
                    });
                    
                    pendingMessages.sort((a, b) => {
                        const dateA = new Date(a.scheduledFor || 0);
                        const dateB = new Date(b.scheduledFor || 0);
                        return dateA - dateB;
                    });
                    
                    html += '<h4 style="color: #f57c00; margin-bottom: 15px;">â³ Bekleyen Mesajlar (' + pendingMessages.length + ')</h4>';
                    html += '<div style="display: grid; gap: 10px; margin-bottom: 30px;">';
                    
                    pendingMessages.slice(0, 20).forEach(message => {
                        const scheduledDate = new Date(message.scheduledFor);
                        const dateStr = scheduledDate.toLocaleString('tr-TR');
                        
                        html += `
                            <div style="padding: 12px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 4px;">ğŸ“ ${message.phone}</div>
                                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">${message.message.substring(0, 100)}...</div>
                                        <div style="font-size: 11px; color: #888;">ğŸ• GÃ¶nderilecek: ${dateStr}</div>
                                    </div>
                                    <button onclick="removeFromQueue('${message.id}')" class="btn btn-sm btn-danger" style="margin-left: 10px;">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                // âŒ BAÅARISIZ MESAJLAR
                if (!failedSnapshot.empty) {
                    const failedMessages = [];
                    failedSnapshot.docs.forEach(doc => {
                        failedMessages.push({ id: doc.id, ...doc.data() });
                    });
                    
                    failedMessages.sort((a, b) => {
                        const dateA = new Date(a.createdAt || 0);
                        const dateB = new Date(b.createdAt || 0);
                        return dateB - dateA; // En yeni Ã¶nce
                    });
                    
                    html += '<h4 style="color: #d32f2f; margin-bottom: 15px;">âŒ BaÅŸarÄ±sÄ±z Mesajlar (' + failedMessages.length + ')</h4>';
                    html += '<div style="display: grid; gap: 10px;">';
                    
                    failedMessages.slice(0, 20).forEach(message => {
                        const createdDate = new Date(message.createdAt);
                        const dateStr = createdDate.toLocaleString('tr-TR');
                        const errorMsg = message.error || 'Bilinmeyen hata';
                        
                        html += `
                            <div style="padding: 12px; background: #ffebee; border-left: 4px solid #d32f2f; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 4px;">ğŸ“ ${message.phone}</div>
                                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">${message.message.substring(0, 100)}...</div>
                                        <div style="font-size: 11px; color: #d32f2f; margin-bottom: 4px;">âš ï¸ Hata: ${errorMsg}</div>
                                        <div style="font-size: 11px; color: #888;">ğŸ• Deneme: ${dateStr}</div>
                                    </div>
                                    <button onclick="removeFromQueue('${message.id}')" class="btn btn-sm btn-danger" style="margin-left: 10px;">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                }
                
                // HiÃ§ mesaj yoksa
                if (pendingSnapshot.empty && failedSnapshot.empty) {
                    html = '<p class="empty-state">Kuyrukta mesaj yok.</p>';
                }
                
                container.innerHTML = html;
                console.log('âœ… Mesaj kuyruÄŸu baÅŸarÄ±yla render edildi:', {
                    pending: pendingSnapshot.size,
                    failed: failedSnapshot.size
                });
            } catch (error) {
                console.error('Mesaj kuyruÄŸu yÃ¼klenirken hata:', error);
                const container = document.getElementById('messageQueueList');
                if (container) {
                    container.innerHTML = `<p class="empty-state" style="color: red;">âŒ Hata: ${error.message}</p>`;
                }
            }
        }
        
        window.renderMessageQueue = renderMessageQueue;
        
        // Kuyruktan mesaj sil
        window.removeFromQueue = async function(queueId) {
            if (!confirm('Bu mesajÄ± kuyruktan Ã§Ä±karmak istediÄŸinize emin misiniz?')) return;
            
            try {
                // MesajÄ± sil
                await window.firebase.deleteDoc(
                    window.firebase.doc(window.db, 'messageQueue', queueId)
                );
                
                // Listeyi yenile (await ile bekle)
                await renderMessageQueue();
                
                // BaÅŸarÄ± mesajÄ±
                showAlert('âœ… Mesaj kuyruktan Ã§Ä±karÄ±ldÄ±.', 'success');
            } catch (error) {
                console.error('âŒ Mesaj silinirken hata:', error);
                showAlert('âŒ Mesaj silinirken bir hata oluÅŸtu: ' + error.message, 'danger');
            }
        };
        
        // Mesaj kuyruk iÅŸleyicisi (her 1 dakikada Ã§alÄ±ÅŸÄ±r)
        async function processMessageQueue() {
            try {
                // âœ… Ã‡alÄ±ÅŸma saati kontrolÃ¼ kaldÄ±rÄ±ldÄ± - scheduledFor zamanÄ± zaten Ã§alÄ±ÅŸma saatleri iÃ§inde ayarlanmÄ±ÅŸ olmalÄ±
                // BÃ¶ylece mesajlar zamanÄ± geldiÄŸinde gÃ¶nderilir
                
                const messagesRef = window.firebase.collection(window.db, 'messageQueue');
                // âœ… Index hatasÄ± iÃ§in sadeleÅŸtirilmiÅŸ query - orderBy kaldÄ±rÄ±ldÄ±
                const q = window.firebase.query(
                    messagesRef,
                    window.firebase.where('clubId', '==', currentClubId),
                    window.firebase.where('status', '==', 'pending')
                );
                
                const snapshot = await window.firebase.getDocs(q);
                
                if (snapshot.empty) return;
                
                // Sadece zamanÄ± gelmiÅŸ mesajlarÄ± iÅŸle ve tarihe gÃ¶re sÄ±rala (client-side)
                const now = new Date().toISOString();
                const pendingMessages = snapshot.docs
                    .filter(doc => {
                        const data = doc.data();
                        return data.scheduledFor <= now;
                    })
                    .sort((a, b) => {
                        const timeA = a.data().scheduledFor;
                        const timeB = b.data().scheduledFor;
                        return timeA.localeCompare(timeB);
                    });
                
                if (pendingMessages.length === 0) return;
                
                // Ä°lk 5 mesajÄ± iÅŸle
                let processedCount = 0;
                const maxToProcess = 5;
                
                for (const doc of pendingMessages) {
                    if (processedCount >= maxToProcess) break;
                    processedCount++;
                    
                    const data = doc.data();
                    
                    try {
                        // MesajÄ± gÃ¶nder
                        await sendWhatsAppMessageDirect(data.phone, data.message, data.deviceId);
                        
                        // Durumu gÃ¼ncelle
                        await window.firebase.updateDoc(
                            window.firebase.doc(window.db, 'messageQueue', doc.id),
                            {
                                status: 'sent',
                                sentAt: new Date().toISOString()
                            }
                        );
                        
                        console.log('âœ… Kuyruktaki mesaj gÃ¶nderildi:', data.phone);
                    } catch (error) {
                        console.error('âŒ Kuyruk mesajÄ± gÃ¶nderilirken hata:', error);
                        
                        // Hata durumunu kaydet
                        await window.firebase.updateDoc(
                            window.firebase.doc(window.db, 'messageQueue', doc.id),
                            {
                                status: 'failed',
                                error: error.message,
                                failedAt: new Date().toISOString()
                            }
                        );
                    }
                }
                
                // KuyruÄŸu yeniden render et
                renderMessageQueue();
            } catch (error) {
                console.error('Mesaj kuyruÄŸu iÅŸlenirken hata:', error);
            }
        }
        
        // ============================================
        // âœ… BULUTFON API ENTEGRASYONU
        // ============================================
        
        // Bulutfon API ile gÃ¶rÃ¼ÅŸme kayÄ±tlarÄ±nÄ± Ã§ek
        async function fetchBulutfonCallRecords(phoneNumber) {
            if (!clubSettings || !clubSettings.bulutfonEnabled || !clubSettings.bulutfonApiKey) {
                console.log('âš ï¸ Bulutfon entegrasyonu aktif deÄŸil veya API key eksik');
                return [];
            }
            
            try {
                // Telefon numarasÄ±nÄ± temizle ve farklÄ± formatlarÄ± hazÄ±rla
                let cleanPhone = phoneNumber.replace(/[^\d]/g, '');
                
                // 0 ile baÅŸlÄ±yorsa 90 yap
                if (cleanPhone.startsWith('0')) {
                    cleanPhone = '90' + cleanPhone.substring(1);
                } else if (!cleanPhone.startsWith('90') && cleanPhone.length === 10) {
                    cleanPhone = '90' + cleanPhone;
                }
                
                console.log('ğŸ“ Bulutfon API Ã§aÄŸrÄ±sÄ± yapÄ±lÄ±yor...', cleanPhone);
                
                // Firebase Functions proxy Ã¼zerinden CDR listesini Ã§ek (CORS sorunu Ã§Ã¶zÃ¼mÃ¼)
                // API key query parameter olarak gÃ¶nderiliyor
                const response = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${clubSettings.bulutfonApiKey}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ Bulutfon API hatasÄ±:', response.status, response.statusText, errorText);
                    
                    let errorMsg = 'Bulutfon API baÄŸlantÄ± hatasÄ±: ';
                    if (response.status === 401 || response.status === 403) {
                        errorMsg += 'API key geÃ§ersiz veya yetkilendirme hatasÄ±. LÃ¼tfen API key\'inizi kontrol edin.';
                    } else if (response.status === 500) {
                        errorMsg += 'Bulutfon sunucu hatasÄ±. Bulutfon panelinde CDR (Arama KayÄ±tlarÄ±) eriÅŸiminizin aktif olduÄŸundan emin olun.';
                    } else {
                        errorMsg += `Hata kodu ${response.status}. LÃ¼tfen Bulutfon hesabÄ±nÄ±zÄ± ve API ayarlarÄ±nÄ±zÄ± kontrol edin.`;
                    }
                    
                    showAlert(errorMsg, 'danger');
                    return { error: errorMsg };
                }
                
                const data = await response.json();
                console.log('âœ… Bulutfon API response:', data);
                
                // Bulutfon v2 API'den gelen data yapÄ±sÄ±nÄ± kontrol et
                const allRecords = Array.isArray(data) ? data : (data.cdrs || data.data || []);
                
                if (allRecords.length === 0) {
                    console.log('âš ï¸ Bulutfon\'dan kayÄ±t gelmedi');
                    return [];
                }
                
                // MÃ¼ÅŸteri numarasÄ±yla eÅŸleÅŸen kayÄ±tlarÄ± filtrele - phonesMatch kullan
                // Hem caller/src (kaynak) hem callee/dst (hedef) alanlarÄ±na bak
                const matchingRecords = allRecords.filter(record => {
                    const caller = record.caller || record.src || '';
                    const callee = record.callee || record.dst || '';
                    
                    // phonesMatch ile gÃ¼Ã§lÃ¼ eÅŸleÅŸtirme (boÅŸluk, tire, +90 vs fark etmez)
                    return phonesMatch(caller, phoneNumber) || phonesMatch(callee, phoneNumber);
                });
                
                console.log(`ğŸ“Š ${matchingRecords.length} adet gÃ¶rÃ¼ÅŸme kaydÄ± bulundu`);
                
                // DEBUG: Ä°lk kaydÄ±n detaylarÄ±nÄ± gÃ¶ster
                if (matchingRecords.length > 0) {
                    console.log('ğŸ” Ä°lk kayÄ±t detayÄ±:', matchingRecords[0]);
                    console.log('ğŸ” Ä°lk kayÄ±tta bulunan field\'lar:', Object.keys(matchingRecords[0]));
                    console.log('ğŸ” call_record:', matchingRecords[0].call_record);
                    console.log('ğŸ” uuid:', matchingRecords[0].uuid);
                    console.log('ğŸ” direction:', matchingRecords[0].direction);
                    console.log('ğŸ” hangup_state:', matchingRecords[0].hangup_state);
                    console.log('ğŸ” hangup_cause:', matchingRecords[0].hangup_cause, '(ANSWERED=cevaplanan)');
                    console.log('ğŸ” is_missing_call:', matchingRecords[0].is_missing_call, `(type: ${typeof matchingRecords[0].is_missing_call}, true=cevapsÄ±z, false=cevaplanan)`);
                    console.log('ğŸ” answer_time:', matchingRecords[0].answer_time);
                }
                
                return matchingRecords;
            } catch (error) {
                console.error('âŒ Bulutfon gÃ¶rÃ¼ÅŸme kayÄ±tlarÄ± alÄ±nÄ±rken hata:', error);
                showAlert('Bulutfon gÃ¶rÃ¼ÅŸme kayÄ±tlarÄ± alÄ±nÄ±rken hata oluÅŸtu: ' + error.message, 'danger');
                return [];
            }
        }
        
        // GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ±nÄ± gÃ¶ster
        async function renderCallRecords(phoneNumber, containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error('âŒ Container bulunamadÄ±:', containerId);
                return;
            }
            
            console.log('ğŸ“ GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ± yÃ¼kleniyor:', phoneNumber);
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ± yÃ¼kleniyor...</span></div>';
            
            // Bulutfon aktif deÄŸilse bilgi gÃ¶ster
            if (!clubSettings || !clubSettings.bulutfonEnabled) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; background: #f5f5f5; border-radius: 8px;">
                        <p style="color: #666; margin-bottom: 10px;">ğŸ“ Bulutfon entegrasyonu aktif deÄŸil</p>
                        <p style="color: #999; font-size: 12px;">GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ±nÄ± gÃ¶rmek iÃ§in WhatsApp > Ayarlar > Bulutfon API Entegrasyonu bÃ¶lÃ¼mÃ¼nden aktif edin.</p>
                    </div>
                `;
                return;
            }
            
            const records = await fetchBulutfonCallRecords(phoneNumber);
            
            // Hata durumunu kontrol et
            if (records && records.error) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; background: #ffebee; border-radius: 8px; border-left: 4px solid #f44336;">
                        <p style="color: #c62828; margin-bottom: 10px; font-weight: 600;">âŒ Bulutfon API BaÄŸlantÄ± HatasÄ±</p>
                        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">${records.error}</p>
                        <div style="background: white; padding: 15px; border-radius: 6px; margin-top: 15px; text-align: left;">
                            <p style="font-weight: 600; color: #333; margin-bottom: 10px;">ğŸ”§ Ã‡Ã¶zÃ¼m Ã–nerileri:</p>
                            <ul style="margin: 0; padding-left: 20px; color: #666; font-size: 12px;">
                                <li>Bulutfon panelinden aldÄ±ÄŸÄ±nÄ±z API key'i doÄŸru girdiÄŸinizden emin olun</li>
                                <li>Bulutfon hesabÄ±nÄ±zda <strong>CDR (Call Detail Records - Arama KayÄ±tlarÄ±)</strong> Ã¶zelliÄŸinin aktif olmasÄ± gerekiyor</li>
                                <li>"API BaÄŸlantÄ±sÄ±nÄ± Test Et" butonuna basarak baÄŸlantÄ±yÄ± test edin</li>
                                <li>API key'i yeni oluÅŸturduysanÄ±z, birkaÃ§ dakika bekleyip tekrar deneyin</li>
                                <li>Bulutfon hesap yÃ¶neticinizle iletiÅŸime geÃ§erek API eriÅŸim yetkilerinizi kontrol edin</li>
                            </ul>
                        </div>
                    </div>
                `;
                return;
            }
            
            if (!records || records.length === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <p style="color: #666; margin-bottom: 10px;">ğŸ“‹ Bu numara iÃ§in gÃ¶rÃ¼ÅŸme kaydÄ± bulunamadÄ±</p>
                        <p style="color: #888; font-size: 12px;">Aranan numara: ${phoneNumber}</p>
                        <p style="color: #999; font-size: 11px; margin-top: 10px;">
                            ğŸ’¡ Bulutfon sisteminde bu numarayla yapÄ±lmÄ±ÅŸ bir gÃ¶rÃ¼ÅŸme yoksa veya kayÄ±tlar silinmiÅŸ olabilir.
                        </p>
                    </div>
                `;
                return;
            }
            
            // KayÄ±tlarÄ± gelen ve giden olarak ayÄ±r
            const incomingCalls = records.filter(r => r.direction === 'IN');
            const outgoingCalls = records.filter(r => r.direction === 'OUT');
            
            const uniqueId = container.id; // Her container iÃ§in benzersiz ID
            
            let html = `
                <div>
                    <div class="customer-tabs">
                        <button class="tab-button active" onclick="switchCallTab(0, '${uniqueId}')">ğŸ“ Gelen Aramalar (${incomingCalls.length})</button>
                        <button class="tab-button" onclick="switchCallTab(1, '${uniqueId}')">ğŸ“± Giden Aramalar (${outgoingCalls.length})</button>
                    </div>
                    
                    <div class="call-tab-content active" style="padding: 15px; background: white; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 8px 8px;">
                        <div style="display: grid; gap: 10px;">
            `;
            
            // Gelen Aramalar
            incomingCalls.forEach((record, idx) => {
                html += renderCallRecord(record, 'in-' + idx);
            });
            
            html += `
                        </div>
                    </div>
                    
                    <div class="call-tab-content" style="padding: 15px; background: white; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 8px 8px; display: none;">
                        <div style="display: grid; gap: 10px;">
            `;
            
            // Giden Aramalar
            outgoingCalls.forEach((record, idx) => {
                html += renderCallRecord(record, 'out-' + idx);
            });
            
            html += `
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ± sekmelerini deÄŸiÅŸtir
        window.switchCallTab = function(tabIndex, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const tabs = container.querySelectorAll('.tab-button');
            const contents = container.querySelectorAll('.call-tab-content');
            
            tabs.forEach((btn, idx) => {
                if (idx === tabIndex) {
                    btn.classList.add('active');
                    contents[idx].style.display = 'block';
                } else {
                    btn.classList.remove('active');
                    contents[idx].style.display = 'none';
                }
            });
        };
        
        // Tek bir gÃ¶rÃ¼ÅŸme kaydÄ±nÄ± render et
        function renderCallRecord(record, idx) {
            // Bulutfon v2 API field'larÄ± (call_time, caller, callee, duration, call_record)
            const callTime = record.call_time || record.call_Time || record.call_date;
            const date = new Date(callTime);
            date.setHours(date.getHours() - 3); // âœ… UTC'den TÃ¼rkiye saatine Ã§evir
            const dateStr = date.toLocaleString('tr-TR');
            
            // SÃ¼re hesaplama - duration (saniye) veya billsec
            let duration = '00:00';
            if (record.duration) {
                duration = `${record.duration} sn`;
            } else if (record.billsec) {
                duration = `${Math.floor(record.billsec / 60)}:${(record.billsec % 60).toString().padStart(2, '0')}`;
            }
            
            // YÃ¶n belirleme
            const directionIcon = record.direction === 'IN' ? 'ğŸ“ Gelen' : 'ğŸ“± Giden';
            
            // âœ… Durum belirleme - Gelen ve Giden aramalar iÃ§in farklÄ± kontrol
            let isAnswered = false;
            let isMissed = false;
            
            if (record.direction === 'IN') {
                // GELEN ARAMALAR: is_missing_call parametresi kullan
                if (record.is_missing_call !== undefined && record.is_missing_call !== null) {
                    const isMissingCall = record.is_missing_call === true || record.is_missing_call === "true" || record.is_missing_call === 1;
                    isMissed = isMissingCall;
                    isAnswered = !isMissingCall;
                } else {
                    const hangupCause = (record.hangup_cause || '').toUpperCase();
                    isAnswered = hangupCause === 'ANSWERED';
                    isMissed = !isAnswered;
                }
            } else {
                // GÄ°DEN ARAMALAR: answer_time kontrolÃ¼ (Ã¶ncelikli)
                if (record.answer_time !== undefined) {
                    isAnswered = record.answer_time && record.answer_time !== null && record.answer_time !== '';
                    isMissed = !isAnswered;
                } else {
                    // Fallback: hangup_cause veya talking_seconds
                    const hangupCause = (record.hangup_cause || '').toUpperCase();
                    if (hangupCause) {
                        isAnswered = hangupCause === 'ANSWERED';
                    } else {
                        const talkingSeconds = parseInt(record.talking_seconds) || 0;
                        isAnswered = talkingSeconds > 0;
                    }
                    isMissed = !isAnswered;
                }
            }
            
            const statusColor = isAnswered ? '#4CAF50' : '#f44336';
            const statusText = isAnswered ? 'CevaplandÄ±' : 'CevaplanmadÄ±';
            
            // Arayan ve aranan numaralar - Formatla
            const caller = formatPhoneDisplay(record.caller || record.src || 'N/A');
            const callee = formatPhoneDisplay(record.callee || record.dst || 'N/A');
            
            // Ses kaydÄ± kontrolÃ¼ - call_record field'Ä± veya UUID
            const recordingUrl = record.call_record; // EÄŸer doÄŸrudan URL ise
            const hasRecordingUrl = recordingUrl && recordingUrl !== null && recordingUrl !== '';
            const hasUuid = record.uuid || record.call_uuid;
            const canPlayRecording = hasRecordingUrl || (hasUuid && isAnswered);
            
            // âœ… Ses kaydÄ± bÃ¶lÃ¼mÃ¼nÃ¼ her zaman gÃ¶ster (cevaplanan aramalar iÃ§in)
            let recordingSection = '';
            if (isAnswered) {
                if (hasRecordingUrl) {
                    // Direkt URL varsa audio player gÃ¶ster
                    recordingSection = `
                        <div style="margin-top: 12px; padding: 10px; background: #e3f2fd; border-radius: 6px; border-left: 3px solid #2196f3;">
                            <div style="font-size: 12px; font-weight: 600; color: #1976d2; margin-bottom: 8px;">ğŸ§ Ses KaydÄ±</div>
                            <audio controls style="width: 100%; height: 32px;">
                                <source src="${recordingUrl}" type="audio/mpeg">
                                TarayÄ±cÄ±nÄ±z ses oynatmayÄ± desteklemiyor.
                            </audio>
                        </div>
                    `;
                } else if (hasUuid) {
                    // UUID varsa dinle butonu gÃ¶ster
                    recordingSection = `
                        <div style="margin-top: 12px; padding: 10px; background: #e3f2fd; border-radius: 6px; border-left: 3px solid #2196f3;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-size: 12px; font-weight: 600; color: #1976d2;">ğŸ§ Ses KaydÄ±</span>
                                <button onclick="playRecording('${hasUuid}', 'audio-${idx}')" class="btn btn-sm btn-primary" style="font-size: 11px; padding: 4px 8px;">
                                    â–¶ï¸ Dinle
                                </button>
                            </div>
                            <div id="audio-container-${idx}" style="display: none; margin-top: 8px;">
                                <audio id="audio-${idx}" controls style="width: 100%; height: 32px;">
                                    <source id="audio-source-${idx}" type="audio/mpeg">
                                    TarayÄ±cÄ±nÄ±z ses oynatmayÄ± desteklemiyor.
                                </audio>
                                <div style="font-size: 10px; color: #1976d2; margin-top: 4px; text-align: center;">
                                    ğŸ’¡ Ses kaydÄ± yÃ¼kleniyor... BirkaÃ§ saniye sÃ¼rebilir
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Ne URL ne UUID var - bilgilendirme gÃ¶ster
                    recordingSection = `
                        <div style="margin-top: 12px; padding: 8px; background: #fff3e0; border-radius: 6px; border-left: 3px solid #ff9800;">
                            <div style="font-size: 11px; color: #f57c00;">
                                ğŸ§ Ses kaydÄ± bulunamadÄ± (UUID eksik)
                            </div>
                        </div>
                    `;
                }
            } else {
                // CevaplanmamÄ±ÅŸ aramalar iÃ§in bilgi gÃ¶ster
                recordingSection = `
                    <div style="margin-top: 12px; padding: 8px; background: #ffebee; border-radius: 6px; border-left: 3px solid #f44336;">
                        <div style="font-size: 11px; color: #c62828;">
                            ğŸ“µ CevapsÄ±z arama - Ses kaydÄ± yok
                        </div>
                    </div>
                `;
            }
            
            return `
                    <div style="padding: 12px; background: white; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <div style="font-weight: 600;">${directionIcon}</div>
                            <div style="font-size: 11px; color: #888;">${dateStr}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 12px;">
                                <span style="color: #666;">ğŸ“</span> <strong>${caller}</strong> â†’ <strong>${callee}</strong>
                            </div>
                            <div style="font-size: 12px;">
                                <span style="color: #666;">â±ï¸</span> <strong>${duration}</strong>
                            </div>
                        </div>
                        ${statusText ? `
                            <div style="margin-top: 6px; font-size: 11px;">
                                <span style="padding: 2px 8px; background: ${statusColor}; color: white; border-radius: 4px;">${statusText}</span>
                            </div>
                        ` : ''}
                        
                        ${recordingSection}
                    </div>
                `;
        }
        
        // Ses kaydÄ±nÄ± Ã§al
        window.playRecording = async function(recordingId, audioElementId) {
            try {
                const audioContainer = document.getElementById(`audio-container-${audioElementId.split('-')[1]}`);
                const audioElement = document.getElementById(audioElementId);
                const audioSource = document.getElementById(`audio-source-${audioElementId.split('-')[1]}`);
                
                if (!clubSettings || !clubSettings.bulutfonApiKey) {
                    showAlert('âš ï¸ Bulutfon API Key tanÄ±mlÄ± deÄŸil!', 'warning');
                    return;
                }
                
                console.log('ğŸ§ Ses kaydÄ± yÃ¼kleniyor, UUID:', recordingId);
                
                // Audio elementi gÃ¶ster
                audioContainer.style.display = 'block';
                
                // Loading gÃ¶ster
                const buttonIdx = audioElementId.split('-')[1];
                const button = document.querySelector(`button[onclick*="audio-${buttonIdx}"]`);
                if (button) {
                    button.disabled = true;
                    button.innerHTML = 'â³ YÃ¼kleniyor...';
                }
                
                // Ses dosyasÄ±nÄ± yÃ¼kle
                try {
                    // Firebase Functions proxy Ã¼zerinden ses kaydÄ±nÄ± al (CORS sorunu Ã§Ã¶zÃ¼mÃ¼)
                    const recordingUrl = `https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonRecordingProxy?apikey=${clubSettings.bulutfonApiKey}&uuid=${recordingId}`;
                    
                    const response = await fetch(recordingUrl, {
                        method: 'GET'
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'Bilinmeyen hata' }));
                        console.error('âŒ Ses kaydÄ± API hatasÄ±:', response.status, errorData);
                        
                        if (response.status === 404) {
                            throw new Error('Bu gÃ¶rÃ¼ÅŸme iÃ§in ses kaydÄ± bulunamadÄ±. KayÄ±t edilmemiÅŸ olabilir.');
                        } else {
                            throw new Error(errorData.message || 'Ses kaydÄ± alÄ±namadÄ±');
                        }
                    }
                    
                    // Blob olarak al ve object URL oluÅŸtur
                    const blob = await response.blob();
                    const blobUrl = URL.createObjectURL(blob);
                    
                    console.log('âœ… Ses kaydÄ± yÃ¼klendi, boyut:', blob.size, 'bytes');
                    
                    // Audio source'a ata ve oynat
                    audioSource.src = blobUrl;
                    audioElement.load();
                    await audioElement.play();
                    
                    showAlert('ğŸ§ Ses kaydÄ± baÅŸarÄ±yla yÃ¼klendi', 'success');
                    
                    // Butonu gizle
                    if (button) {
                        button.style.display = 'none';
                    }
                    
                } catch (error) {
                    console.error('Ses kaydÄ± yÃ¼klenirken hata:', error);
                    showAlert(`âŒ ${error.message}`, 'danger');
                    audioContainer.style.display = 'none';
                    
                    // Butonu eski haline getir
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = 'â–¶ï¸ Dinle';
                    }
                }
            } catch (error) {
                console.error('Ses oynatma hatasÄ±:', error);
                showAlert('Ses kaydÄ± oynatÄ±lÄ±rken bir hata oluÅŸtu.', 'danger');
            }
        };
         async function handleUserSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const selectedPermissions = formData.getAll('permissions');

            const userData = {
                fullName: data.fullName,
                phone: data.phone,
                phoneNumber: data.phone, // For WhatsApp notifications
                username: data.phone,
                password: data.password, 
                email: data.phone + '@kulup.local', // For task assignment
                permissions: {
                    // Finansal Yetkiler
                    view_payments: selectedPermissions.includes('view_payments'),
                    edit_payments: selectedPermissions.includes('edit_payments'),
                    delete_payments: selectedPermissions.includes('delete_payments'),
                    export_payments: selectedPermissions.includes('export_payments'),
                    
                    // Ãœye Yetkiler
                    view_members: selectedPermissions.includes('view_members'),
                    add_members: selectedPermissions.includes('add_members'),
                    edit_members: selectedPermissions.includes('edit_members'),
                    delete_members: selectedPermissions.includes('delete_members'),
                    export_members: selectedPermissions.includes('export_members'),
                    
                    // CRM Yetkileri
                    view_crm: selectedPermissions.includes('view_crm'),
                    add_crm: selectedPermissions.includes('add_crm'),
                    edit_crm: selectedPermissions.includes('edit_crm'),
                    delete_crm: selectedPermissions.includes('delete_crm'),
                    view_calls: selectedPermissions.includes('view_calls'),
                    
                    // Ä°letiÅŸim Yetkileri
                    send_messages: selectedPermissions.includes('send_messages'),
                    send_bulk_messages: selectedPermissions.includes('send_bulk_messages'),
                    view_message_history: selectedPermissions.includes('view_message_history'),
                    
                    // Raporlar ve Ä°statistikler
                    view_stats: selectedPermissions.includes('view_stats'),
                    view_reports: selectedPermissions.includes('view_reports'),
                    export_reports: selectedPermissions.includes('export_reports'),
                    
                    // Ayarlar ve YÃ¶netim
                    manage_users: selectedPermissions.includes('manage_users'),
                    manage_settings: selectedPermissions.includes('manage_settings'),
                    manage_branches: selectedPermissions.includes('manage_branches'),
                    manage_groups: selectedPermissions.includes('manage_groups'),
                    
                    // Yoklama ve Takvim
                    view_attendance: selectedPermissions.includes('view_attendance'),
                    edit_attendance: selectedPermissions.includes('edit_attendance'),
                    manage_schedule: selectedPermissions.includes('manage_schedule')
                },
                clubId: currentClubId // âœ… KulÃ¼p ID'si eklendi
            };

            try {
                await window.firebase.addDoc(window.firebase.collection(window.db, 'users'), userData);
                showAlert('Yeni yÃ¶netici baÅŸarÄ±yla eklendi.', 'success');
                form.reset();
                await loadData();
            } catch (error) {
                console.error('Error adding user:', error);
                showAlert('YÃ¶netici eklenirken bir hata oluÅŸtu.', 'danger');
            }
        }

        async function openTaskMessagesModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return showAlert('GÃ¶rev bulunamadÄ±.', 'danger');
            
            const modal = document.getElementById('taskMessagesModal');
            const modalTitle = document.getElementById('taskMessagesModalTitle');
            const messagesList = document.getElementById('taskMessagesList');
            const messageForm = document.getElementById('taskMessageForm');
            
            modalTitle.textContent = `ğŸ’¬ Mesajlar - ${task.taskName}`;
            messageForm.taskId.value = taskId;
            
            // Mark messages as read
            const unreadMessages = (task.messages || []).filter(m => !m.read && m.sender !== currentUser.fullName);
            if (unreadMessages.length > 0) {
                const updatedMessages = (task.messages || []).map(m => {
                    if (!m.read && m.sender !== currentUser.fullName) {
                        return { ...m, read: true };
                    }
                    return m;
                });
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'tasks', taskId), { messages: updatedMessages });
                task.messages = updatedMessages;
            }
            
            // Render messages
            const messages = task.messages || [];
            messagesList.innerHTML = messages.length === 0 
                ? '<p class="empty-state">HenÃ¼z mesaj yok.</p>'
                : messages.map((msg, index) => {
                    const isMine = msg.sender === currentUser.fullName;
                    const canDelete = currentUser.isSuperAdmin;
                    const deleteBtn = canDelete ? `<button class="task-message-delete" onclick="deleteTaskMessage('${taskId}', ${index})" title="MesajÄ± Sil">Ã—</button>` : '';
                    return `
                        <div class="task-message ${isMine ? 'task-message-mine' : 'task-message-other'}">
                            ${deleteBtn}
                            <div class="task-message-header">
                                <strong>${msg.sender}</strong>
                                <span class="task-message-time">${formatDate(msg.timestamp)}</span>
                            </div>
                            <div class="task-message-body">${msg.message}</div>
                        </div>
                    `;
                }).join('');
            
            // Scroll to bottom
            setTimeout(() => {
                messagesList.scrollTop = messagesList.scrollHeight;
            }, 50);
            
            openModal('taskMessagesModal');
        }
        
        async function sendTaskMessage(e) {
            e.preventDefault();
            const form = e.target;
            const taskId = form.taskId.value;
            const messageText = form.messageText.value.trim();
            
            if (!messageText) return showAlert('Mesaj boÅŸ olamaz.', 'warning');
            
            const task = tasks.find(t => t.id === taskId);
            if (!task) return showAlert('GÃ¶rev bulunamadÄ±.', 'danger');
            
            const newMessage = {
                sender: currentUser.fullName,
                message: messageText,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            const updatedMessages = [...(task.messages || []), newMessage];
            
            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'tasks', taskId), { messages: updatedMessages });
                task.messages = updatedMessages;
                form.messageText.value = '';
                openTaskMessagesModal(taskId); // Refresh messages
                showAlert('Mesaj gÃ¶nderildi.', 'success');
                
                // Send WhatsApp notification
                const notificationSent = await sendTaskMessageNotification(task, messageText, currentUser.fullName);
                if (notificationSent) {
                    console.log('âœ… WhatsApp bildirimi gÃ¶nderildi');
                } else {
                    console.log('âš ï¸ WhatsApp bildirimi gÃ¶nderilemedi (ÅŸablon kapalÄ± veya ayarlar eksik olabilir)');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showAlert('Mesaj gÃ¶nderilirken hata oluÅŸtu.', 'danger');
            }
        }
        
        // Send WhatsApp notification when a task message is added
        async function sendTaskMessageNotification(task, messageText, sender) {
            try {
                // Check if template is enabled
                if (!messageTemplates.taskMessage || !messageTemplates.taskMessage.enabled) {
                    console.log('Task message notification: Template not enabled');
                    return false;
                }
                
                // Find the user assigned to this task
                let assignedUser = users.find(u => u.email === task.assignedTo);
                if (!assignedUser) {
                    assignedUser = users.find(u => u.fullName === task.assignedTo);
                }
                
                if (!assignedUser) {
                    console.log('Task message notification: Assigned user not found', task.assignedTo);
                    return false;
                }
                
                // Don't send notification to the sender
                if (assignedUser.fullName === sender) {
                    console.log('Task message notification: Skipping - user is sender');
                    return false;
                }
                
                // Check if user has phone number
                let phoneNumber = assignedUser.phoneNumber || assignedUser.phone;
                if (!phoneNumber) {
                    console.log('Task message notification: User has no phone number', assignedUser.fullName);
                    return false;
                }
                
                // Format phone number to 905xxxxxxxxx
                phoneNumber = phoneNumber.replace(/\D/g, '');
                if (phoneNumber.startsWith('0')) {
                    phoneNumber = '90' + phoneNumber.substring(1);
                } else if (!phoneNumber.startsWith('90')) {
                    phoneNumber = '90' + phoneNumber;
                }
                
                // Get connected WhatsApp device
                let connectedDevice;
                if (defaultWhatsAppDevice) {
                    connectedDevice = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
                }
                if (!connectedDevice) {
                    connectedDevice = whatsappDevices.find(d => d.status === 'connected');
                }
                if (!connectedDevice) {
                    console.log('Task message notification: No connected device');
                    return false;
                }
                
                // Prepare message from template
                let message = messageTemplates.taskMessage.text || '';
                if (!message || message.trim() === '') {
                    message = `SayÄ±n {VELI_AD_SOYAD},\n\n"{GOREV}" gÃ¶revi iÃ§in yeni bir mesaj aldÄ±nÄ±z:\n\nğŸ’¬ {MESAJ}\nğŸ“¤ GÃ¶nderen: {GONDEREN}\nğŸ“… Tarih: {TARIH}\n\nGÃ¶rev detaylarÄ±nÄ± kontrol ediniz.`;
                }
                
                const userName = assignedUser.fullName || assignedUser.email;
                message = message.replace(/{UYE_AD_SOYAD}/g, userName);
                message = message.replace(/{OGRENCI_AD_SOYAD}/g, '');
                // Backward compatibility
                message = message.replace(/{VELI_AD_SOYAD}/g, userName);
                message = message.replace(/{AD_SOYAD}/g, userName).replace(/{AD}/g, userName);
                
                message = message.replace(/{GOREV}/g, task.taskName);
                message = message.replace(/{MESAJ}/g, messageText.substring(0, 100) + (messageText.length > 100 ? '...' : ''));
                message = message.replace(/{GONDEREN}/g, sender);
                message = message.replace(/{TARIH}/g, formatDate(new Date().toISOString()));
                
                console.log('Task message notification: Sending to', assignedUser.fullName, phoneNumber);
                
                // Send message
                const result = await sendWhatsAppMessage(connectedDevice.instanceName, phoneNumber, message, assignedUser.fullName || assignedUser.email);
                const success = result.success || result === true;
                console.log('Task message notification sent:', success);
                
                return success;
            } catch (error) {
                console.error('Task message notification error:', error);
                return false;
            }
        }
        
        async function deleteTaskMessage(taskId, messageIndex) {
            if (!currentUser.isSuperAdmin) {
                return showAlert('Bu iÅŸlem iÃ§in yetkiniz yok.', 'danger');
            }
            
            showConfirmModal('Bu mesajÄ± silmek istediÄŸinizden emin misiniz?', async () => {
                closeModal('confirmModal');
                try {
                    const task = tasks.find(t => t.id === taskId);
                    if (!task) return showAlert('GÃ¶rev bulunamadÄ±.', 'danger');
                    
                    const updatedMessages = [...(task.messages || [])];
                    updatedMessages.splice(messageIndex, 1);
                    
                    await window.firebase.updateDoc(window.firebase.doc(window.db, 'tasks', taskId), { messages: updatedMessages });
                    task.messages = updatedMessages;
                    openTaskMessagesModal(taskId); // Refresh
                    showAlert('Mesaj silindi.', 'success');
                } catch (error) {
                    console.error('Error deleting message:', error);
                    showAlert('Mesaj silinirken hata oluÅŸtu.', 'danger');
                }
            });
        }

        async function handleTaskSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const taskId = data.taskId;
            delete data.taskId;

            const taskData = {
                taskName: data.taskName,
                assignedTo: data.assignedTo,
                status: data.status,
                notes: data.notes || '',
                clubId: currentClubId // âœ… KulÃ¼p ID'si eklendi
            };

            try {
                if (taskId) { // Editing existing task
                    // âœ… Eski gÃ¶revi bul (atama deÄŸiÅŸikliÄŸini kontrol etmek iÃ§in)
                    const oldTask = tasks.find(t => t.id === taskId);
                    const assigneeChanged = oldTask && oldTask.assignedTo !== taskData.assignedTo;
                    
                    if (taskData.status === 'TamamlandÄ±') {
                        taskData.completedAt = new Date().toISOString();
                    } else {
                        taskData.completedAt = null;
                    }
                    await window.firebase.updateDoc(window.firebase.doc(window.db, 'tasks', taskId), taskData);
                    showAlert('GÃ¶rev gÃ¼ncellendi.', 'success');
                    
                    // âœ… Atanan kiÅŸi deÄŸiÅŸtiyse yeni kiÅŸiye bildirim gÃ¶nder
                    if (assigneeChanged) {
                        console.log('ğŸ“¢ GÃ¶rev atamasÄ± deÄŸiÅŸti:', oldTask.assignedTo, 'â†’', taskData.assignedTo);
                        sendTaskNotification(taskData).catch(err => {
                            console.error('Task notification failed:', err);
                        });
                    }
                } else { // Creating new task
                    taskData.createdAt = new Date().toISOString();
                    taskData.completedAt = null;
                    if (taskData.status === 'TamamlandÄ±') {
                       taskData.completedAt = new Date().toISOString();
                    }
                    await window.firebase.addDoc(window.firebase.collection(window.db, 'tasks'), taskData);
                    showAlert('Yeni gÃ¶rev eklendi.', 'success');
                    
                    // Send WhatsApp notification in background (don't wait)
                    sendTaskNotification(taskData).catch(err => {
                        console.error('Task notification failed:', err);
                    });
                }
                closeModal('taskModal');
                await loadData();
            } catch (error) {
                showAlert('GÃ¶rev kaydedilirken hata oluÅŸtu.', 'danger');
            }
        }
        
        // --- WHATSAPP NOTIFICATION FUNCTIONS ---
        async function sendTaskNotification(taskData) {
            try {
                // Check if template is enabled
                if (!messageTemplates.task || !messageTemplates.task.enabled) {
                    console.log('Task notification: Template not enabled');
                    return false;
                }
                
                // Find assigned user by email or fullName
                let assignedUser = users.find(u => u.email === taskData.assignedTo);
                if (!assignedUser) {
                    // Try finding by fullName
                    assignedUser = users.find(u => u.fullName === taskData.assignedTo);
                }
                
                if (!assignedUser) {
                    console.log('Task notification: User not found', taskData.assignedTo);
                    return false;
                }
                
                // Check if user has phone number
                let phoneNumber = assignedUser.phoneNumber || assignedUser.phone;
                if (!phoneNumber) {
                    console.log('Task notification: User has no phone number', assignedUser.fullName);
                    return false;
                }
                
                // Format phone number to 905xxxxxxxxx
                phoneNumber = phoneNumber.replace(/\D/g, ''); // Remove non-digits
                if (phoneNumber.startsWith('0')) {
                    phoneNumber = '90' + phoneNumber.substring(1); // Replace leading 0 with 90
                } else if (!phoneNumber.startsWith('90')) {
                    phoneNumber = '90' + phoneNumber; // Add 90 prefix
                }
                
                // Get default WhatsApp device
                let connectedDevice;
                
                // First try to use default device
                if (defaultWhatsAppDevice) {
                    connectedDevice = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
                }
                
                // If no default or default not connected, use any connected device
                if (!connectedDevice) {
                    connectedDevice = whatsappDevices.find(d => d.status === 'connected');
                }
                
                if (!connectedDevice) {
                    console.log('Task notification: No connected device');
                    return false;
                }
                
                console.log('Task notification: Sending to', assignedUser.fullName, phoneNumber);
                console.log('Message templates:', messageTemplates);
                console.log('Task template:', messageTemplates.task);
                
                // Prepare message from template
                let message = messageTemplates.task?.text || '';
                
                // If no template text, use default
                if (!message || message.trim() === '') {
                    message = `SayÄ±n {VELI_AD_SOYAD}, Size yeni bir gÃ¶rev atandÄ±:\n\nğŸ“‹ GÃ¶rev: {GOREV}\nğŸ“ AÃ§Ä±klama: {ACIKLAMA}\nğŸ“… Tarih: {TARIH}\n\nÄ°yi Ã§alÄ±ÅŸmalar dileriz.`;
                    console.warn('Using default task template as saved template is empty');
                }
                
                const userName = assignedUser.fullName || assignedUser.email;
                message = message.replace(/{UYE_AD_SOYAD}/g, userName);
                message = message.replace(/{OGRENCI_AD_SOYAD}/g, '');
                // Backward compatibility
                message = message.replace(/{VELI_AD_SOYAD}/g, userName);
                message = message.replace(/{AD_SOYAD}/g, userName).replace(/{AD}/g, userName);
                
                message = message.replace(/{GOREV}/g, taskData.taskName);
                message = message.replace(/{ACIKLAMA}/g, taskData.notes || 'AÃ§Ä±klama bulunmamaktadÄ±r');
                message = message.replace(/{TARIH}/g, formatDate(taskData.createdAt));
                
                console.log('Final message to send:', message);
                
                // Send message
                const result = await sendWhatsAppMessage(connectedDevice.instanceName, phoneNumber, message, assignedUser.fullName || assignedUser.email);
                const success = result.success || result === true;
                console.log('Task notification sent:', success);
                
                // Show notification to user
                if (success) {
                    setTimeout(() => {
                        showAlert(`ğŸ“¨ WhatsApp bildirimi ${assignedUser.fullName}'a gÃ¶nderildi`, 'success');
                    }, 200);
                } else {
                    setTimeout(() => {
                        const errorMsg = result.errorReason ? ` (${result.errorReason})` : '';
                        showAlert(`âš ï¸ WhatsApp bildirimi gÃ¶nderilemedi${errorMsg}`, 'warning');
                    }, 200);
                }
                
                return success;
                
            } catch (error) {
                console.error('Task notification error:', error);
                setTimeout(() => {
                    showAlert(`âš ï¸ WhatsApp bildirimi gÃ¶nderilemedi: ${error.message}`, 'warning');
                }, 200);
                return false;
            }
        }
        
        async function sendWhatsAppMessage(instanceName, phoneNumber, message, logRecipient = 'Bilinmeyen') {
            let success = false;
            let formattedPhone = '';
            let errorReason = '';
            
            try {
                // âœ… Ã‡alÄ±ÅŸma saatleri kontrolÃ¼
                if (!isWithinWorkingHours()) {
                    console.log('â° Ã‡alÄ±ÅŸma saatleri dÄ±ÅŸÄ±nda, mesaj kuyruÄŸa ekleniyor...');
                    await addMessageToQueue(phoneNumber, message, instanceName);
                    showAlert(`ğŸ“‹ Mesaj Ã§alÄ±ÅŸma saatleri dÄ±ÅŸÄ±nda olduÄŸu iÃ§in kuyruÄŸa eklendi. ${getNextWorkingHour().split('T')[0]} tarihinde gÃ¶nderilecek.`, 'info');
                    return true; // KuyruklamanÄ±n baÅŸarÄ±lÄ± olduÄŸunu belirt
                }
                
                // âœ… Apply rate limiting with random delays for all messages
                const now = Date.now();
                const timeSinceLastMessage = now - lastMessageSentTime;
                
                // Calculate required wait time based on message count
                const shouldLongWait = (totalMessagesSent % (clubSettings.longWaitTrigger || 100)) === 0 && totalMessagesSent > 0;
                let requiredWaitTime;
                
                if (shouldLongWait) {
                    const min = (clubSettings.minLongWait || 400) * 1000;
                    const max = (clubSettings.maxLongWait || 800) * 1000;
                    requiredWaitTime = Math.floor(Math.random() * (max - min + 1)) + min;
                    console.log(`â³ UZUN BEKLEME: ${(requiredWaitTime / 1000).toFixed(1)}s (Her ${clubSettings.longWaitTrigger} mesajda bir)`);
                } else {
                    const min = (clubSettings.minWaitTime || 20) * 1000;
                    const max = (clubSettings.maxWaitTime || 50) * 1000;
                    requiredWaitTime = Math.floor(Math.random() * (max - min + 1)) + min;
                    if (totalMessagesSent > 0) {
                        console.log(`â³ Mesaj arasÄ± bekleme: ${(requiredWaitTime / 1000).toFixed(1)}s`);
                    }
                }
                
                // If not enough time has passed, wait
                if (timeSinceLastMessage < requiredWaitTime) {
                    const remainingWait = requiredWaitTime - timeSinceLastMessage;
                    await new Promise(resolve => setTimeout(resolve, remainingWait));
                }
                
                // Update tracking
                lastMessageSentTime = Date.now();
                totalMessagesSent++;
                
                // Format phone number for WhatsApp
                formattedPhone = phoneNumber.replace(/\D/g, '');
                if (formattedPhone.startsWith('0') && formattedPhone.length === 11) {
                    // 05449367543 â†’ 905449367543
                    formattedPhone = '90' + formattedPhone.substring(1);
                } else if (formattedPhone.startsWith('0')) {
                    formattedPhone = formattedPhone.substring(1);
                }
                if (!formattedPhone.startsWith('90')) {
                    formattedPhone = '90' + formattedPhone;
                }
                
                console.log(`ğŸ“¤ Sending WhatsApp message to: ${formattedPhone}@s.whatsapp.net via ${instanceName}`);
                
                // Try multiple formats for compatibility
                const formats = [
                    // Format 1: With @s.whatsapp.net (most common)
                    {
                        number: `${formattedPhone}@s.whatsapp.net`,
                        text: message
                    },
                    // Format 2: Without @s.whatsapp.net
                    {
                        number: formattedPhone,
                        text: message
                    }
                ];
                
                let response = null;
                let responseData = null;
                let lastError = null;
                
                // Try each format until one works
                for (let i = 0; i < formats.length && !success; i++) {
                    console.log(`Trying format ${i + 1}:`, JSON.stringify(formats[i]));
                    
                    try {
                        // Create AbortController for timeout
                        const controller = new AbortController();
                        // 2 dakika timeout - API'nin cevap vermesi iÃ§in yeterli sÃ¼re
                        const timeoutId = setTimeout(() => controller.abort(), 120000);
                        
                        response = await fetch(`${EVOLUTION_API_URL}/message/sendText/${instanceName}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': EVOLUTION_API_KEY
                            },
                            body: JSON.stringify(formats[i]),
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        responseData = await response.json().catch(() => ({}));
                        console.log('WhatsApp API response:', response.status, responseData);
                        
                        if (response.ok) {
                            success = true;
                            console.log('âœ… Message sent successfully with format', i + 1);
                            break;
                        } else {
                            console.warn(`Format ${i + 1} failed (HTTP ${response.status}), trying next...`);
                            lastError = responseData;
                            if (responseData.response) {
                                console.error('Error details:', JSON.stringify(responseData.response, null, 2));
                            }
                            // EÄŸer HTTP hatasÄ± varsa (404, 401, 500 vs) bir sonraki formatÄ± dene
                            // Timeout deÄŸilse devam et
                        }
                    } catch (fetchError) {
                        console.log(`Format ${i + 1} fetch error:`, fetchError.message);
                        if (fetchError.name === 'AbortError') {
                            console.warn('â±ï¸ Request timeout (2 dakika), trying next format...');
                            errorReason = 'Ä°stek zaman aÅŸÄ±mÄ±na uÄŸradÄ± (2 dakika)';
                        } else {
                            errorReason = `BaÄŸlantÄ± hatasÄ±: ${fetchError.message}`;
                        }
                        lastError = { message: fetchError.message };
                    }
                }
                
                // If all formats failed, set error reason
                if (!success && response) {
                    if (response.status === 500) {
                        errorReason = 'Sunucu hatasÄ± (500)';
                    } else if (response.status === 404) {
                        errorReason = 'Instance bulunamadÄ± (404)';
                    } else if (response.status === 401 || response.status === 403) {
                        errorReason = 'Yetki hatasÄ± (401/403)';
                    } else if (lastError && lastError.message) {
                        errorReason = lastError.message;
                    } else if (lastError && lastError.error) {
                        errorReason = lastError.error;
                    } else {
                        errorReason = `HTTP ${response.status}`;
                    }
                }
            } catch (error) {
                console.error('WhatsApp message error:', error);
                success = false;
                errorReason = `Ä°stek hatasÄ±: ${error.message}`;
            }
            
            // Log message to Firebase
            try {
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'sentMessages'),
                    {
                        recipient: logRecipient,
                        recipientPhone: formattedPhone,
                        message: message,
                        instanceName: instanceName,
                        success: success,
                        sentAt: new Date().toISOString(),
                        sentBy: currentUser?.email || 'system',
                        clubId: currentClubId // âœ… KulÃ¼p ID'si eklendi
                    }
                );
                
                // Reload messages in background
                const messagesSnapshot = await window.firebase.getDocs(
                    window.firebase.query(
                        window.firebase.collection(window.db, 'sentMessages'),
                        window.firebase.where('clubId', '==', currentClubId),
                        window.firebase.orderBy('sentAt', 'desc')
                    )
                );
                sentMessages = messagesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).slice(0, 50);
                loadSentMessagesLog();
            } catch (error) {
                // Ignore log errors
            }
            
            return { success, errorReason, formattedPhone };
        }

        window.sendBirthdayMessage = async function(memberId) {
            if (!messageTemplates.birthday || !messageTemplates.birthday.enabled) {
                showAlert('DoÄŸum gÃ¼nÃ¼ ÅŸablonu etkinleÅŸtirilmemiÅŸ! LÃ¼tfen ayarlardan etkinleÅŸtirin.', 'warning');
                return;
            }

            const member = members.find(m => m.id === memberId);
            if (!member) {
                showAlert('Ãœye bulunamadÄ±!', 'danger');
                return;
            }

            if (!member.Telefon) {
                showAlert('Ãœye telefon numarasÄ± bulunamadÄ±!', 'danger');
                return;
            }

            // Find connected device
            let device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
            if (!device) {
                device = whatsappDevices.find(d => d.status === 'connected');
            }
            
            if (!device) {
                showAlert('BaÄŸlÄ± WhatsApp cihazÄ± bulunamadÄ±!', 'danger');
                return;
            }

            try {
                const isChild = !!member.Resit_Olmayan_Adi_Soyadi;
                
                // Get template text based on member type
                let message = '';
                if (isChild) {
                    message = messageTemplates.birthday.textChild || messageTemplates.birthday.text || '';
                } else {
                    message = messageTemplates.birthday.textAdult || messageTemplates.birthday.text || '';
                }
                
                if (!message || message.trim() === '') {
                    showAlert('Mesaj ÅŸablonu boÅŸ! LÃ¼tfen ayarlardan dÃ¼zenleyin.', 'warning');
                    return;
                }

                // Replace template variables
                const studentName = member.Resit_Olmayan_Adi_Soyadi || '';
                const parentName = member.Ad_Soyad || 'DeÄŸerli Ãœyemiz';
                const uyeName = isChild ? parentName : parentName;
                
                message = message.replace(/{UYE_AD_SOYAD}/g, uyeName);
                message = message.replace(/{OGRENCI_AD_SOYAD}/g, studentName);
                // Backward compatibility
                message = message.replace(/{VELI_AD_SOYAD}/g, parentName);
                message = message.replace(/{AD_SOYAD}/g, uyeName).replace(/{AD}/g, uyeName);

                // Confirm before sending
                const memberName = isChild ? studentName : parentName;
                if (!confirm(`${memberName} iÃ§in doÄŸum gÃ¼nÃ¼ mesajÄ± gÃ¶nderilsin mi?\n\nMesaj:\n${message}`)) {
                    return;
                }

                // Send message
                const result = await sendWhatsAppMessage(device.instanceName, member.Telefon, message, memberName, 'birthday');
                
                if (result.success || result === true) {
                    showAlert('ğŸ‚ DoÄŸum gÃ¼nÃ¼ mesajÄ± baÅŸarÄ±yla gÃ¶nderildi!', 'success');
                } else {
                    showAlert('âŒ Mesaj gÃ¶nderilemedi!', 'danger');
                }
            } catch (error) {
                console.error('Error sending birthday message:', error);
                showAlert('Hata: ' + error.message, 'danger');
            }
        };

        async function checkAndSendBirthdayMessages() {
            if (!messageTemplates.birthday || !messageTemplates.birthday.enabled) {
                console.log('ğŸ‚ DoÄŸum gÃ¼nÃ¼ ÅŸablonu etkin deÄŸil');
                return;
            }

            // Find connected device
            let device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
            if (!device) {
                device = whatsappDevices.find(d => d.status === 'connected');
            }
            
            if (!device) {
                console.log('âš ï¸ BaÄŸlÄ± WhatsApp cihazÄ± yok, doÄŸum gÃ¼nÃ¼ mesajlarÄ± gÃ¶nderilemedi.');
                return;
            }

            // Get today's date (day and month)
            const today = new Date();
            const todayDay = today.getDate();
            const todayMonth = today.getMonth() + 1; // 0-indexed

            let birthdayCount = 0;

            // Check all members
            for (const member of members) {
                if (!member.Telefon || member.status !== 'active') continue;

                // Check if member has birthday
                const birthdayField = member.Dogum_Tarihi || member.dogumTarihi || member.birthday;
                if (!birthdayField) continue;

                // Parse birthday
                const birthday = new Date(birthdayField);
                const birthdayDay = birthday.getDate();
                const birthdayMonth = birthday.getMonth() + 1;

                // Check if today is birthday
                if (birthdayDay === todayDay && birthdayMonth === todayMonth) {
                    // Check if message already sent today
                    const sentToday = sentMessages.some(msg => {
                        const msgDate = new Date(msg.sentAt);
                        return msg.recipientPhone === member.Telefon && 
                               msg.type === 'birthday' &&
                               msgDate.getDate() === todayDay &&
                               msgDate.getMonth() === todayMonth &&
                               msgDate.getFullYear() === today.getFullYear();
                    });

                    if (sentToday) {
                        console.log(`ğŸ‚ ${member.Ad_Soyad || member.Resit_Olmayan_Adi_Soyadi}: BugÃ¼n zaten mesaj gÃ¶nderilmiÅŸ`);
                        continue;
                    }

                    // Send birthday message
                    try {
                        const isChild = !!member.Resit_Olmayan_Adi_Soyadi;
                        
                        // Get template text based on member type
                        let message = '';
                        if (isChild) {
                            message = messageTemplates.birthday.textChild || messageTemplates.birthday.text || '';
                        } else {
                            message = messageTemplates.birthday.textAdult || messageTemplates.birthday.text || '';
                        }
                        
                        if (!message || message.trim() === '') {
                            console.log('âš ï¸ DoÄŸum gÃ¼nÃ¼ mesaj ÅŸablonu boÅŸ!');
                            continue;
                        }

                        // Replace template variables
                        const studentName = member.Resit_Olmayan_Adi_Soyadi || '';
                        const parentName = member.Ad_Soyad || 'DeÄŸerli Ãœyemiz';
                        const uyeName = isChild ? parentName : parentName;
                        
                        message = message.replace(/{UYE_AD_SOYAD}/g, uyeName);
                        message = message.replace(/{OGRENCI_AD_SOYAD}/g, studentName);
                        // Backward compatibility
                        message = message.replace(/{VELI_AD_SOYAD}/g, parentName);
                        message = message.replace(/{AD_SOYAD}/g, uyeName).replace(/{AD}/g, uyeName);

                        // Send message
                        const memberName = isChild ? studentName : parentName;
                        const result = await sendWhatsAppMessage(device.instanceName, member.Telefon, message, memberName, 'birthday');
                        
                        if (result.success || result === true) {
                            console.log(`ğŸ‚âœ… DoÄŸum gÃ¼nÃ¼ mesajÄ± gÃ¶nderildi: ${memberName}`);
                            birthdayCount++;
                        } else {
                            console.log(`ğŸ‚âŒ DoÄŸum gÃ¼nÃ¼ mesajÄ± gÃ¶nderilemedi: ${memberName}`);
                        }

                        // Small delay between messages
                        await new Promise(resolve => setTimeout(resolve, 500));

                    } catch (error) {
                        console.error('DoÄŸum gÃ¼nÃ¼ mesajÄ± gÃ¶nderme hatasÄ±:', error);
                    }
                }
            }

            if (birthdayCount > 0) {
                console.log(`ğŸ‰ ${birthdayCount} doÄŸum gÃ¼nÃ¼ mesajÄ± gÃ¶nderildi!`);
                showAlert(`ğŸ‚ ${birthdayCount} doÄŸum gÃ¼nÃ¼ mesajÄ± baÅŸarÄ±yla gÃ¶nderildi!`, 'success');
            } else {
                console.log('ğŸ‚ BugÃ¼n doÄŸum gÃ¼nÃ¼ olan Ã¼ye yok');
            }
        }

        async function sendAbsenceNotifications(absenceList) {
            if (!messageTemplates.absence || !messageTemplates.absence.enabled) {
                console.log('âš ï¸ DevamsÄ±zlÄ±k ÅŸablonu etkin deÄŸil, mesaj gÃ¶nderilmedi.');
                return;
            }

            // Find connected device
            let device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
            if (!device) {
                device = whatsappDevices.find(d => d.status === 'connected');
            }
            
            if (!device) {
                console.log('âš ï¸ BaÄŸlÄ± WhatsApp cihazÄ± yok, devamsÄ±zlÄ±k mesajlarÄ± gÃ¶nderilemedi.');
                return;
            }

            let successCount = 0;
            let failCount = 0;

            for (const absence of absenceList) {
                try {
                    const member = absence.member;
                    
                    // Check if member has phone
                    if (!member.Telefon) {
                        console.log(`âš ï¸ ${member.Ad_Soyad || member.Resit_Olmayan_Adi_Soyadi}: Telefon numarasÄ± yok`);
                        failCount++;
                        continue;
                    }

                    // Check if member is a child
                    const isChild = !!member.Resit_Olmayan_Adi_Soyadi;
                    
                    // Get template text based on member type
                    let message = '';
                    if (isChild) {
                        message = messageTemplates.absence.textChild || messageTemplates.absence.text || '';
                    } else {
                        message = messageTemplates.absence.textAdult || messageTemplates.absence.text || '';
                    }
                    
                    if (!message || message.trim() === '') {
                        console.log('âš ï¸ DevamsÄ±zlÄ±k mesaj ÅŸablonu boÅŸ!');
                        failCount++;
                        continue;
                    }

                    // Replace template variables
                    const studentName = member.Resit_Olmayan_Adi_Soyadi || '';
                    const parentName = member.Ad_Soyad || 'DeÄŸerli Ãœyemiz';
                    const uyeName = isChild ? parentName : parentName;
                    
                    // Get lesson name from branch
                    const group = groups.find(g => g.groupName === absence.groupName);
                    const branchId = group ? group.branch : null;
                    const branch = branches.find(b => b.id === branchId);
                    const lessonName = branch ? branch.lessonName : absence.groupName;
                    
                    message = message.replace(/{UYE_AD_SOYAD}/g, uyeName);
                    message = message.replace(/{OGRENCI_AD_SOYAD}/g, studentName);
                    message = message.replace(/{TARIH}/g, formatDate(absence.date));
                    message = message.replace(/{DERS}/g, lessonName);
                    // Backward compatibility
                    message = message.replace(/{VELI_AD_SOYAD}/g, parentName);
                    message = message.replace(/{AD_SOYAD}/g, uyeName).replace(/{AD}/g, uyeName);

                    // Send message
                    const memberName = isChild ? studentName : parentName;
                    const result = await sendWhatsAppMessage(device.instanceName, member.Telefon, message, memberName);
                    
                    if (result.success || result === true) {
                        console.log(`âœ… DevamsÄ±zlÄ±k mesajÄ± gÃ¶nderildi: ${memberName}`);
                        successCount++;
                    } else {
                        console.log(`âŒ DevamsÄ±zlÄ±k mesajÄ± gÃ¶nderilemedi: ${memberName}`);
                        failCount++;
                    }

                    // Small delay between messages
                    await new Promise(resolve => setTimeout(resolve, 1000));

                } catch (error) {
                    console.error('DevamsÄ±zlÄ±k mesajÄ± gÃ¶nderme hatasÄ±:', error);
                    failCount++;
                }
            }

            console.log(`ğŸ“Š DevamsÄ±zlÄ±k MesajlarÄ±: ${successCount} baÅŸarÄ±lÄ±, ${failCount} baÅŸarÄ±sÄ±z`);
            
            if (successCount > 0) {
                setTimeout(() => {
                    showAlert(`âœ… ${successCount} devamsÄ±zlÄ±k mesajÄ± baÅŸarÄ±yla gÃ¶nderildi!`, 'success');
                }, 500);
            }
        }

        window.sendPendingRegistrationReminder = async function(preRegId) {
            try {
                // Find the preRegistration
                const preReg = preRegistrations.find(p => p.id === preRegId);
                if (!preReg) {
                    showAlert('KayÄ±t bulunamadÄ±!', 'danger');
                    return;
                }

                if (!preReg.phone) {
                    showAlert('Telefon numarasÄ± bulunamadÄ±!', 'danger');
                    return;
                }

                // Check if template is enabled
                if (!messageTemplates.pendingRegistration || !messageTemplates.pendingRegistration.enabled) {
                    showAlert('Bekleyen kayÄ±t hatÄ±rlatma ÅŸablonu etkinleÅŸtirilmemiÅŸ! LÃ¼tfen ayarlardan etkinleÅŸtirin.', 'warning');
                    return;
                }

                // âœ… Determine if child or adult - daha doÄŸru kontrol
                const isChild = !!(preReg.parentName && preReg.studentName && preReg.parentName !== preReg.studentName);
                
                // Get template text based on type
                let message = '';
                if (isChild) {
                    message = messageTemplates.pendingRegistration.textChild || messageTemplates.pendingRegistration.text || '';
                } else {
                    message = messageTemplates.pendingRegistration.textAdult || messageTemplates.pendingRegistration.text || '';
                }
                
                if (!message || message.trim() === '') {
                    showAlert('Mesaj ÅŸablonu boÅŸ! LÃ¼tfen ayarlardan dÃ¼zenleyin.', 'warning');
                    return;
                }

                // âœ… Replace template variables - yetiÅŸkin iÃ§in studentName kullan
                const parentName = preReg.parentName || 'DeÄŸerli Velimiz';
                const studentName = preReg.studentName || '';
                const uyeName = isChild ? parentName : studentName; // YetiÅŸkin iÃ§in studentName
                
                // âœ… KulÃ¼p adÄ±nÄ± link'e ekle (URL-friendly slug)
                const clubName = clubInfo?.name || clubSettings?.clubName || currentUser?.clubName || 'KulÃ¼p';
                const clubSlug = createSlug(clubName);
                const registrationLink = window.location.origin + '/uyeyeni/kayit?club=' + clubSlug;
                
                message = message.replace(/{UYE_AD_SOYAD}/g, uyeName);
                message = message.replace(/{OGRENCI_AD_SOYAD}/g, studentName);
                message = message.replace(/{LINK}/g, registrationLink);
                message = message.replace(/{TARIH}/g, formatDate(new Date().toISOString()));
                // Backward compatibility
                message = message.replace(/{VELI_AD_SOYAD}/g, parentName);
                message = message.replace(/{AD_SOYAD}/g, uyeName);

                // Find connected device
                let device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
                if (!device) {
                    device = whatsappDevices.find(d => d.status === 'connected');
                }
                
                if (!device) {
                    showAlert('BaÄŸlÄ± WhatsApp cihazÄ± bulunamadÄ±!', 'danger');
                    return;
                }

                // Confirm before sending - doÄŸru ismi gÃ¶ster
                const displayName = isChild ? `${parentName} (Veli - ${studentName})` : studentName;
                if (!confirm(`${displayName} iÃ§in kayÄ±t hatÄ±rlatma mesajÄ± gÃ¶nderilsin mi?\n\nMesaj:\n${message}`)) {
                    return;
                }

                // Send message
                const result = await sendWhatsAppMessage(device.instanceName, preReg.phone, message, displayName);
                const success = result.success || result === true;

                if (success) {
                    showAlert('âœ… KayÄ±t hatÄ±rlatma mesajÄ± baÅŸarÄ±yla gÃ¶nderildi!', 'success');
                } else {
                    showAlert('âŒ Mesaj gÃ¶nderilemedi!', 'danger');
                }
            } catch (error) {
                console.error('Error sending registration reminder:', error);
                showAlert('Hata: ' + error.message, 'danger');
            }
        };

        window.sendPaymentReminderMessage = async function(preRegId, paymentNumber, reminderType) {
            try {
                // Find the preRegistration
                const preReg = preRegistrations.find(p => p.id === preRegId);
                if (!preReg) {
                    showAlert('Ã–deme planÄ± bulunamadÄ±!', 'danger');
                    return;
                }

                // Find the specific payment
                const payment = preReg.paymentSchedule.find(p => p.paymentNumber === paymentNumber);
                if (!payment) {
                    showAlert('Ã–deme bulunamadÄ±!', 'danger');
                    return;
                }

                // Find the member
                const member = members.find(m => m.preRegistrationId === preRegId || m.Telefon === preReg.phone);
                if (!member || !member.Telefon) {
                    showAlert('Ãœye telefon numarasÄ± bulunamadÄ±!', 'danger');
                    return;
                }

                // Check if template is enabled
                const templateKey = reminderType === 'overdue' ? 'payment' : 'upcomingPayment';
                if (!messageTemplates[templateKey] || !messageTemplates[templateKey].enabled) {
                    showAlert(`${reminderType === 'overdue' ? 'GecikmiÅŸ' : 'YaklaÅŸan'} Ã¶deme ÅŸablonu etkinleÅŸtirilmemiÅŸ! LÃ¼tfen ayarlardan etkinleÅŸtirin.`, 'warning');
                    return;
                }

                // Check if member is a child
                const isChild = !!member.Resit_Olmayan_Adi_Soyadi;
                
                console.log('=== Ã–DEME HATÄ°RLATMA DEBUG ===');
                console.log('Member:', member);
                console.log('isChild:', isChild);
                console.log('Resit_Olmayan_Adi_Soyadi:', member.Resit_Olmayan_Adi_Soyadi);
                console.log('Ad_Soyad:', member.Ad_Soyad);
                console.log('Template Key:', templateKey);
                console.log('Available templates:', messageTemplates[templateKey]);
                
                // Get template text based on member type
                let message = '';
                if (isChild) {
                    message = messageTemplates[templateKey].textChild || messageTemplates[templateKey].text || '';
                    console.log('Using CHILD template');
                } else {
                    message = messageTemplates[templateKey].textAdult || messageTemplates[templateKey].text || '';
                    console.log('Using ADULT template');
                }
                
                console.log('Message template:', message.substring(0, 100));
                
                if (!message || message.trim() === '') {
                    showAlert('Mesaj ÅŸablonu boÅŸ! LÃ¼tfen ayarlardan dÃ¼zenleyin.', 'warning');
                    return;
                }

                // Calculate days until/since due date
                const today = new Date();
                today.setHours(0,0,0,0);
                const dueDate = new Date(payment.dueDate + 'T00:00:00');
                const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

                // Replace template variables
                const studentName = member.Resit_Olmayan_Adi_Soyadi || '';
                const parentName = member.Ad_Soyad || 'DeÄŸerli Ãœyemiz';
                const uyeName = isChild ? parentName : parentName; // YetiÅŸkinde kendisi, Ã§ocukta veli
                const memberName = isChild ? studentName : parentName; // GÃ¶rÃ¼nen isim
                
                message = message.replace(/{UYE_AD_SOYAD}/g, uyeName);
                message = message.replace(/{OGRENCI_AD_SOYAD}/g, studentName);
                // Backward compatibility
                message = message.replace(/{VELI_AD_SOYAD}/g, parentName);
                message = message.replace(/{AD_SOYAD}/g, uyeName).replace(/{AD}/g, uyeName);
                
                message = message.replace(/{TUTAR}/g, payment.amount.toLocaleString('tr-TR'));
                message = message.replace(/{TARIH}/g, formatDate(payment.dueDate));
                message = message.replace(/{VADE_TARIHI}/g, formatDate(payment.dueDate));
                message = message.replace(/{GUN_KALDI}/g, Math.abs(daysDiff).toString());
                message = message.replace(/{DONEM_BASLANGIC}/g, formatDate(payment.period.start));
                message = message.replace(/{DONEM_BITIS}/g, formatDate(payment.period.end));
                message = message.replace(/{DERS_SAYISI}/g, payment.period.lessonCount.toString());

                // Find connected device
                let device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
                if (!device) {
                    device = whatsappDevices.find(d => d.status === 'connected');
                }
                
                if (!device) {
                    showAlert('BaÄŸlÄ± WhatsApp cihazÄ± bulunamadÄ±!', 'danger');
                    return;
                }

                // Confirm before sending
                if (!confirm(`${memberName} iÃ§in ${reminderType === 'overdue' ? 'gecikmiÅŸ' : 'yaklaÅŸan'} Ã¶deme hatÄ±rlatma mesajÄ± gÃ¶nderilsin mi?\n\nMesaj:\n${message}`)) {
                    return;
                }

                // Send message
                const result = await sendWhatsAppMessage(device.instanceName, member.Telefon, message, memberName);
                const success = result.success || result === true;
                
                if (success) {
                    showAlert('Mesaj baÅŸarÄ±yla gÃ¶nderildi! âœ…', 'success');
                } else {
                    const errorMsg = result.errorReason ? ` Neden: ${result.errorReason}` : '';
                    showAlert(`Mesaj gÃ¶nderilemedi.${errorMsg}`, 'danger');
                }
            } catch (error) {
                console.error('Error sending payment reminder:', error);
                showAlert('Mesaj gÃ¶nderilirken hata oluÅŸtu: ' + error.message, 'danger');
            }
        };

        // âœ… GecikmiÅŸ Ã¶demelere toplu mesaj gÃ¶nderme
        window.sendBulkOverdueReminders = async function() {
            try {
                // Check if template is enabled
                if (!messageTemplates.payment || !messageTemplates.payment.enabled) {
                    showAlert('GecikmiÅŸ Ã¶deme ÅŸablonu etkinleÅŸtirilmemiÅŸ! LÃ¼tfen ayarlardan etkinleÅŸtirin.', 'warning');
                    return;
                }

                // Find connected device
                let device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice && d.status === 'connected');
                if (!device) {
                    device = whatsappDevices.find(d => d.status === 'connected');
                }
                
                if (!device) {
                    showAlert('BaÄŸlÄ± WhatsApp cihazÄ± bulunamadÄ±!', 'danger');
                    return;
                }

                // Find all members with overdue payments
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const overdueList = [];
                
                for (const member of members) {
                    const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                    if (!preReg || !preReg.paymentSchedule || !member.Telefon) continue;
                    
                    const overduePayments = preReg.paymentSchedule.filter(p => {
                        const dueDate = new Date(p.dueDate + 'T00:00:00');
                        return p.status === 'unpaid' && dueDate < today;
                    });
                    
                    if (overduePayments.length > 0) {
                        overdueList.push({
                            member,
                            preReg,
                            payments: overduePayments,
                            oldestPayment: overduePayments[0] // En eski gecikmiÅŸ Ã¶deme
                        });
                    }
                }
                
                if (overdueList.length === 0) {
                    showAlert('GecikmiÅŸ Ã¶demesi olan Ã¼ye bulunamadÄ±.', 'info');
                    return;
                }
                
                // Calculate total overdue amount
                const totalOverdueAmount = overdueList.reduce((sum, item) => {
                    return sum + item.payments.reduce((paymentSum, p) => paymentSum + p.amount, 0);
                }, 0);
                
                // Confirm before sending
                const confirmMsg = `${overdueList.length} Ã¼yeye gecikmiÅŸ Ã¶deme hatÄ±rlatmasÄ± gÃ¶nderilecek.\n\nToplam gecikmiÅŸ tutar: ${totalOverdueAmount.toLocaleString('tr-TR')}â‚º\n\nDevam etmek istiyor musunuz?`;
                if (!confirm(confirmMsg)) {
                    return;
                }
                
                // Show progress
                showAlert(`${overdueList.length} Ã¼yeye mesaj gÃ¶nderiliyor...`, 'info');
                
                let successCount = 0;
                let failCount = 0;
                
                // âœ… Helper function - Random bekleme sÃ¼resi hesaplama
                const getRandomWaitTime = (messageCount) => {
                    const shouldLongWait = (messageCount % clubSettings.longWaitTrigger) === 0 && messageCount > 0;
                    
                    if (shouldLongWait) {
                        // Uzun bekleme
                        const min = clubSettings.minLongWait * 1000;
                        const max = clubSettings.maxLongWait * 1000;
                        return Math.floor(Math.random() * (max - min + 1)) + min;
                    } else {
                        // Normal bekleme
                        const min = clubSettings.minWaitTime * 1000;
                        const max = clubSettings.maxWaitTime * 1000;
                        return Math.floor(Math.random() * (max - min + 1)) + min;
                    }
                };
                
                // Send messages
                let messageCount = 0;
                for (const item of overdueList) {
                    try {
                        const { member, preReg, oldestPayment } = item;
                        const isChild = !!member.Resit_Olmayan_Adi_Soyadi;
                        
                        // Get template text based on member type
                        let message = isChild 
                            ? (messageTemplates.payment.textChild || messageTemplates.payment.text || '')
                            : (messageTemplates.payment.textAdult || messageTemplates.payment.text || '');
                        
                        if (!message || message.trim() === '') {
                            failCount++;
                            continue;
                        }
                        
                        // Calculate days overdue
                        const dueDate = new Date(oldestPayment.dueDate + 'T00:00:00');
                        const daysDiff = Math.ceil((today - dueDate) / (1000 * 60 * 60 * 24));
                        
                        // Replace template variables
                        const studentName = member.Resit_Olmayan_Adi_Soyadi || '';
                        const parentName = member.Ad_Soyad || 'DeÄŸerli Ãœyemiz';
                        const uyeName = isChild ? parentName : parentName;
                        const memberName = isChild ? studentName : parentName;
                        
                        message = message.replace(/{UYE_AD_SOYAD}/g, uyeName);
                        message = message.replace(/{OGRENCI_AD_SOYAD}/g, studentName);
                        message = message.replace(/{VELI_AD_SOYAD}/g, parentName);
                        message = message.replace(/{AD_SOYAD}/g, uyeName).replace(/{AD}/g, uyeName);
                        message = message.replace(/{TUTAR}/g, oldestPayment.amount.toLocaleString('tr-TR'));
                        message = message.replace(/{TARIH}/g, formatDate(oldestPayment.dueDate));
                        message = message.replace(/{VADE_TARIHI}/g, formatDate(oldestPayment.dueDate));
                        message = message.replace(/{GUN_KALDI}/g, daysDiff.toString());
                        message = message.replace(/{DONEM_BASLANGIC}/g, formatDate(oldestPayment.period.start));
                        message = message.replace(/{DONEM_BITIS}/g, formatDate(oldestPayment.period.end));
                        message = message.replace(/{DERS_SAYISI}/g, oldestPayment.period.lessonCount.toString());
                        
                        // Send message
                        const result = await sendWhatsAppMessage(device.instanceName, member.Telefon, message, memberName);
                        const success = result.success || result === true;
                        
                        if (success) {
                            successCount++;
                            messageCount++;
                        } else {
                            failCount++;
                        }
                        
                        // âœ… Random bekleme sÃ¼resi (ayarlardan)
                        if (messageCount < overdueList.length) {
                            const waitTime = getRandomWaitTime(messageCount);
                            const waitSeconds = (waitTime / 1000).toFixed(1);
                            console.log(`â³ ${waitSeconds} saniye bekleniyor... (${messageCount}/${overdueList.length})`);
                            await new Promise(resolve => setTimeout(resolve, waitTime));
                        }
                        
                    } catch (error) {
                        console.error('Error sending message to member:', item.member.id, error);
                        failCount++;
                    }
                }
                
                // Show results
                const resultMsg = `Toplu mesaj gÃ¶nderimi tamamlandÄ±!\n\nâœ… BaÅŸarÄ±lÄ±: ${successCount}\nâŒ BaÅŸarÄ±sÄ±z: ${failCount}`;
                showAlert(resultMsg, successCount > 0 ? 'success' : 'warning');
                
            } catch (error) {
                console.error('Error in bulk overdue reminders:', error);
                showAlert('Toplu mesaj gÃ¶nderilirken hata oluÅŸtu: ' + error.message, 'danger');
            }
        };

        async function handleProfileUpdate(e) {
            e.preventDefault();
            const form = e.target;
            const fullName = form.fullName.value;
            const phone = form.phone.value.replace(/\D/g, ''); // Remove non-digits
            const newPassword = form.newPassword.value;
            const confirmPassword = form.confirmPassword.value;

            if (newPassword && newPassword !== confirmPassword) {
                return showAlert('Åifreler eÅŸleÅŸmiyor.', 'warning');
            }
            
            const updateData = { 
                fullName,
                phone: phone,
                phoneNumber: phone, // For WhatsApp notifications
                username: phone || currentUser.username
            };
            
            if (newPassword) {
                updateData.password = newPassword;
            }

            try {
                const userDoc = users.find(u => u.username === currentUser.username);
                if (!userDoc) throw new Error("Current user document not found.");

                await window.firebase.updateDoc(window.firebase.doc(window.db, 'users', userDoc.id), updateData);
                
                // Update local current user object
                currentUser.fullName = fullName;
                currentUser.phone = phone;
                currentUser.phoneNumber = phone;
                if(newPassword) currentUser.password = newPassword;
                document.querySelector('.current-user-display').textContent = `HoÅŸgeldiniz, ${currentUser.fullName}`;

                showAlert('Profiliniz baÅŸarÄ±yla gÃ¼ncellendi.', 'success');
                closeModal('profileModal');
                await loadData(); // Reload all users data
            } catch (error) {
                console.error("Profile update error:", error);
                showAlert('Profil gÃ¼ncellenirken bir hata oluÅŸtu.', 'danger');
            }
        }
        
        // --- RENDER FUNCTIONS ---
        function renderPreRegistrationTable() {
            const tbody = document.getElementById('preRegistrationTable');
            if (!tbody) return;
            
            // SADECE pending_contract durumundaki preRegistration kayÄ±tlarÄ±nÄ± gÃ¶ster
            const pendingPreRegs = preRegistrations.filter(p => p.status === 'pending_contract');
            
            if (pendingPreRegs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="empty-state"><h3>Beklemede olan kayÄ±t bulunmuyor.</h3></td></tr>`;
                return;
            }
            
            // âœ… PERFORMANCE: Member'larÄ± preRegId ve phone'a gÃ¶re indexle (O(1) lookup)
            const normalizePhone = (phone) => phone ? phone.replace(/\D/g, '').replace(/^0/, '').replace(/^90/, '') : '';
            const memberByPreRegId = new Map();
            const memberByPhone = new Map();
            members.forEach(m => {
                if (m.preRegistrationId) memberByPreRegId.set(m.preRegistrationId, m);
                if (m.Telefon) memberByPhone.set(normalizePhone(m.Telefon), m);
            });
            
            // âœ… PERFORMANCE: Groups'larÄ± member ID'sine gÃ¶re indexle (O(1) lookup)
            const groupsByMemberId = new Map();
            groups.forEach(g => {
                if (g.members && Array.isArray(g.members)) {
                    g.members.forEach(memberId => {
                        if (!groupsByMemberId.has(memberId)) groupsByMemberId.set(memberId, []);
                        groupsByMemberId.get(memberId).push(g);
                    });
                }
            });
            
            tbody.innerHTML = '';
            pendingPreRegs.forEach(preReg => {
                // âœ… PERFORMANCE: O(1) member lookup
                const member = memberByPreRegId.get(preReg.id) || 
                               (preReg.phone ? memberByPhone.get(normalizePhone(preReg.phone)) : null);
                
                // âœ… Sadece aktif veya pasif Ã¼yeleri atla, bekliyor durumundakileri gÃ¶ster
                if (member && member.status === 'active') {
                    return; // Aktif Ã¼yeleri atla
                }
                if (member && member.status === 'expired') {
                    return; // Pasif Ã¼yeleri atla
                }
                // member.status === 'pending' olanlar veya member olmayan Ã¶n kayÄ±tlar gÃ¶sterilecek
                
                // âœ… PERFORMANCE: O(1) groups lookup
                const memberGroups = member && member.id ? (groupsByMemberId.get(member.id) || []) : [];
                
                const row = document.createElement('tr');
                const dropdownItems = [];
                
                if (member && member.id) {
                    dropdownItems.push(`<button onclick="event.stopPropagation(); window.assignToGroup('${member.id}')">ğŸ‘¥ Grup Ata</button>`);
                    dropdownItems.push(`<button onclick="event.stopPropagation(); window.openMemberEditForm('${member.id}')">âœï¸ Ãœye DÃ¼zenle</button>`);
                }
                dropdownItems.push(`<button onclick="event.stopPropagation(); window.openPreRegEditModal('${preReg.id}')">âœï¸ Ã–n KayÄ±t DÃ¼zenle</button>`);
                dropdownItems.push(`<button onclick="event.stopPropagation(); window.viewPaymentPlan('${preReg.id}')">ğŸ’° Ã–deme PlanÄ±</button>`);
                // KayÄ±t hatÄ±rlatma butonu
                if (preReg.phone) {
                    dropdownItems.push(`<button style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="event.stopPropagation(); window.sendPendingRegistrationReminder('${preReg.id}')">ğŸ“§ KayÄ±t HatÄ±rlat</button>`);
                }
                if (member && member.id) {
                    dropdownItems.push(`<button class="danger" onclick="event.stopPropagation(); window.deleteItem('members', '${member.id}')">ğŸ—‘ï¸ Ãœyeyi Sil</button>`);
                }
                dropdownItems.push(`<button class="danger" onclick="event.stopPropagation(); window.deleteItem('preRegistrations', '${preReg.id}')">ğŸ—‘ï¸ Ã–n KaydÄ± Sil</button>`);
                
                const displayName = preReg.studentName || preReg.parentName || 'Ä°simsiz';
                const parentName = preReg.studentName && preReg.parentName ? preReg.parentName : '-';
                const phone = preReg.phone || (member ? member.Telefon : '-');
                const branch = preReg.branch || (member ? member.Brans : '-');
                const statusValue = member ? member.status : 'pending';
                
                row.innerHTML = `
                    <td>${displayName}</td>
                    <td>${parentName}</td>
                    <td><a href="#" class="phone-link">${formatPhoneDisplay(phone)}</a></td>
                    <td>${branch === 'tenis' ? 'ğŸ¾' : 'ğŸŠ'} ${capitalize(branch)}</td>
                    <td>
                        ${member ? `<select class="status-badge status-${statusValue} member-status-select" data-member-id="${member.id}">
                            <option value="pending" ${statusValue === 'pending' ? 'selected' : ''}>Bekliyor</option>
                            <option value="active" ${statusValue === 'active' ? 'selected' : ''}>Aktif</option>
                            <option value="expired" ${statusValue === 'expired' ? 'selected' : ''}>Pasif</option>
                        </select>` : `<span class="status-badge status-pending">Ãœye OluÅŸturulmamÄ±ÅŸ</span>`}
                    </td>
                    <td>${memberGroups.length > 0 ? memberGroups.map(g => g.groupName).join('<br>') : 'âŒ AtanmamÄ±ÅŸ'}</td>
                    <td class="actions-cell">
                        <div class="actions-dropdown">
                            <button class="actions-dropdown-btn" type="button">âš™ï¸ Ä°ÅŸlemler â–¼</button>
                            <div class="actions-dropdown-content">
                                ${dropdownItems.join('')}
                            </div>
                        </div>
                    </td>
                `;
                
                // Event listeners
                const phoneLink = row.querySelector('.phone-link');
                if (phoneLink && phone !== '-') {
                    phoneLink.addEventListener('click', (e) => handlePhoneClick(e, phone));
                }
                
                const statusSelect = row.querySelector('.member-status-select');
                if (statusSelect && member) {
                    statusSelect.addEventListener('change', function(e) {
                        e.stopPropagation();
                        const memberId = this.dataset.memberId || member.id;
                        const newStatus = this.value;
                        console.log('Durum deÄŸiÅŸtiriliyor:', memberId, newStatus);
                        updateMemberStatus(memberId, newStatus);
                    });
                }
                
                tbody.appendChild(row);
            });
        }

        function loadInactiveMembers() {
            renderInactiveMembersTable();
        }
        
        window.loadInactiveMembers = loadInactiveMembers;
        
        function renderInactiveMembersTable() {
            // Render Bekleyen Ãœyeler (pending)
            const pendingTbody = document.getElementById('pendingMembersTable');
            if (pendingTbody) {
                const pendingMembers = members.filter(m => m.status === 'pending');
                pendingTbody.innerHTML = pendingMembers.length === 0
                    ? `<tr><td colspan="6" class="empty-state"><h3>Bekleyen Ã¼ye bulunmuyor.</h3></td></tr>`
                    : pendingMembers.map(member => {
                        const dropdownItems = [];
                        dropdownItems.push(`<button onclick="event.stopPropagation(); window.openMemberEditForm('${member.id}')">âœï¸ Ãœye DÃ¼zenle</button>`);
                        dropdownItems.push(`<button onclick="event.stopPropagation(); window.showMemberAttendancePage('${member.id}')">ğŸ“‹ Yoklama KayÄ±tlarÄ±</button>`);
                        const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                        if (preReg && preReg.id) {
                            dropdownItems.push(`<button onclick="event.stopPropagation(); window.viewPaymentPlan('${preReg.id}')">ğŸ’° Ã–deme PlanÄ±</button>`);
                            // KayÄ±t hatÄ±rlatma butonu
                            if (member.Telefon) {
                                dropdownItems.push(`<button style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="event.stopPropagation(); window.sendPendingRegistrationReminder('${preReg.id}')">ğŸ“§ KayÄ±t HatÄ±rlat</button>`);
                            }
                        }
                        dropdownItems.push(`<button class="danger" onclick="event.stopPropagation(); window.deleteItem('members', '${member.id}')">ğŸ—‘ï¸ Sil</button>`);
                        
                        return `
                        <tr>
                            <td>${member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad}</td>
                            <td>${member.Ad_Soyad && member.Resit_Olmayan_Adi_Soyadi ? member.Ad_Soyad : '-'}</td>
                            <td><a href="#" class="phone-link" onclick="window.handlePhoneClick(event, '${member.Telefon}')">${member.Telefon}</a></td>
                            <td>${member.Brans === 'tenis' ? 'ğŸ¾' : 'ğŸŠ'} ${capitalize(member.Brans)}</td>
                            <td>
                                <select class="status-badge status-pending" onchange="window.updateMemberStatus('${member.id}', this.value)">
                                    <option value="pending" selected>Bekliyor</option>
                                    <option value="active">Aktif</option>
                                    <option value="expired">Pasif</option>
                                </select>
                            </td>
                            <td class="actions-cell">
                                <div class="actions-dropdown">
                                    <button class="actions-dropdown-btn" type="button">âš™ï¸ Ä°ÅŸlemler â–¼</button>
                                    <div class="actions-dropdown-content">
                                        ${dropdownItems.join('')}
                                    </div>
                                </div>
                            </td>
                        </tr>`}).join('');
            }
            
            // Render Pasif Ãœyeler (expired)
            const inactiveTbody = document.getElementById('inactiveMembersTable');
            if (inactiveTbody) {
                const inactiveMembers = members.filter(m => m.status === 'expired');
                inactiveTbody.innerHTML = inactiveMembers.length === 0
                    ? `<tr><td colspan="6" class="empty-state"><h3>Pasif Ã¼ye bulunmuyor.</h3></td></tr>`
                    : inactiveMembers.map(member => {
                        const dropdownItems = [];
                        dropdownItems.push(`<button onclick="event.stopPropagation(); window.openMemberEditForm('${member.id}')">âœï¸ Ãœye DÃ¼zenle</button>`);
                        dropdownItems.push(`<button onclick="event.stopPropagation(); window.showMemberAttendancePage('${member.id}')">ğŸ“‹ Yoklama KayÄ±tlarÄ±</button>`);
                        const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                        if (preReg && preReg.id) {
                            dropdownItems.push(`<button onclick="event.stopPropagation(); window.viewPaymentPlan('${preReg.id}')">ğŸ’° Ã–deme PlanÄ±</button>`);
                        }
                        dropdownItems.push(`<button class="danger" onclick="event.stopPropagation(); window.deleteItem('members', '${member.id}')">ğŸ—‘ï¸ Sil</button>`);
                        
                        return `
                        <tr>
                            <td>${member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad}</td>
                            <td>${member.Ad_Soyad && member.Resit_Olmayan_Adi_Soyadi ? member.Ad_Soyad : '-'}</td>
                            <td><a href="#" class="phone-link" onclick="window.handlePhoneClick(event, '${member.Telefon}')">${member.Telefon}</a></td>
                            <td>${member.Brans === 'tenis' ? 'ğŸ¾' : 'ğŸŠ'} ${capitalize(member.Brans)}</td>
                            <td>
                                <select class="status-badge status-expired" onchange="window.updateMemberStatus('${member.id}', this.value)">
                                    <option value="pending">Bekliyor</option>
                                    <option value="active">Aktif</option>
                                    <option value="expired" selected>Pasif</option>
                                </select>
                            </td>
                            <td class="actions-cell">
                                <div class="actions-dropdown">
                                    <button class="actions-dropdown-btn" type="button">âš™ï¸ Ä°ÅŸlemler â–¼</button>
                                    <div class="actions-dropdown-content">
                                        ${dropdownItems.join('')}
                                    </div>
                                </div>
                            </td>
                        </tr>`}).join('');
            }
        }
        
        // âœ… Ãœye listesi otomatik yenileme ve bildirim
        let membersAutoRefreshInterval = null;
        let lastMemberCount = 0;
        
        function startMembersAutoRefresh() {
            if (membersAutoRefreshInterval) return;
            
            lastMemberCount = members.length;
            console.log('ğŸ”„ Ãœye listesi otomatik yenileme baÅŸlatÄ±ldÄ±');
            
            membersAutoRefreshInterval = setInterval(async () => {
                if (currentSection !== 'members') return;
                
                const oldCount = members.length;
                await loadData(false); // Cache kullanma, fresh data al
                const newCount = members.length;
                
                if (newCount > oldCount) {
                    const diff = newCount - oldCount;
                    console.log(`ğŸ†• ${diff} yeni Ã¼ye eklendi!`);
                    
                    // Bildirim gÃ¶ster
                    showAlert(`ğŸ‰ ${diff} yeni Ã¼ye eklendi!`, 'success');
                    
                    // Listeyi yenile
                    renderMembersTable();
                }
            }, 30000); // 30 saniyede bir
        }
        
        function stopMembersAutoRefresh() {
            if (membersAutoRefreshInterval) {
                clearInterval(membersAutoRefreshInterval);
                membersAutoRefreshInterval = null;
                console.log('â¹ï¸ Ãœye listesi otomatik yenileme durduruldu');
            }
        }
        
        function renderMembersTable() {
            const tbody = document.getElementById('membersTable');
            const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
            if (!tbody) return;

            // Combine members and pending preRegistrations
            // Create pseudo-members from pending preRegistrations
            const pendingPreRegs = preRegistrations.filter(p => {
                if (p.status !== 'pending_contract') return false;
                
                // EÄŸer bu preReg iÃ§in zaten member varsa ekleme
                const existingMember = members.find(m => 
                    m.preRegistrationId === p.id || 
                    (m.Telefon && p.phone && m.Telefon.replace(/\D/g, '').replace(/^0/, '') === p.phone.replace(/\D/g, '').replace(/^0/, ''))
                );
                
                return !existingMember;
            }).map(p => ({
                id: 'prereg_' + p.id,
                preRegistrationId: p.id,
                Ad_Soyad: p.parentName || 'BelirtilmemiÅŸ',
                Resit_Olmayan_Adi_Soyadi: p.studentName || '',
                Telefon: p.phone || '',
                Telefon_2: '',
                Brans: p.branch || '',
                status: 'pending',
                studentBirthDate: null,
                isPseudoMember: true // Flag to identify pseudo-members
            }));
            
            // Combine actual members with pseudo-members from preRegs
            const combinedMembers = [...members, ...pendingPreRegs];

            // 1. Filtering (Search) - Happens first on the entire dataset
            let filteredMembers = combinedMembers.filter(member => {
                const name = member.Ad_Soyad || '';
                const studentName = member.Resit_Olmayan_Adi_Soyadi || '';
                const phone = member.Telefon || '';
                return name.toLowerCase().includes(searchTerm) || 
                       studentName.toLowerCase().includes(searchTerm) ||
                       phone.includes(searchTerm);
            });

            // Separate passive members
            const passiveMembers = filteredMembers.filter(m => m.status === 'expired');
            let activeAndPendingMembers = filteredMembers.filter(m => m.status !== 'expired');

            // 2. Sorting (apply only to non-passive members)
            const ageHeader = document.querySelector('#membersTable thead th[onclick*="sortMembersByAge"]');
            if (ageHeader) {
                ageHeader.innerHTML = 'YaÅŸ'; // Reset header
                if (ageSortDirection === 'asc') {
                    ageHeader.innerHTML += ' â–²';
                    activeAndPendingMembers.sort((a, b) => {
                        const ageA = a.studentBirthDate ? calculateAge(a.studentBirthDate) : Infinity;
                        const ageB = b.studentBirthDate ? calculateAge(b.studentBirthDate) : Infinity;
                        return ageA - ageB;
                    });
                } else if (ageSortDirection === 'desc') {
                    ageHeader.innerHTML += ' â–¼';
                    activeAndPendingMembers.sort((a, b) => {
                        const ageA = a.studentBirthDate ? calculateAge(a.studentBirthDate) : -Infinity;
                        const ageB = b.studentBirthDate ? calculateAge(b.studentBirthDate) : -Infinity;
                        return ageB - ageA;
                    });
                }
            }
            
            // Re-combine the lists with passive members at the end
            const sortedMembers = [...activeAndPendingMembers, ...passiveMembers];

            // 3. Pagination
            const totalPages = Math.ceil(sortedMembers.length / membersItemsPerPage);
            const startIndex = (membersCurrentPage - 1) * membersItemsPerPage;
            const endIndex = startIndex + membersItemsPerPage;
            const paginatedMembers = sortedMembers.slice(startIndex, endIndex);


            // Update pagination controls UI
            document.getElementById('pageInfo').textContent = `Sayfa ${membersCurrentPage} / ${totalPages > 0 ? totalPages : 1}`;
            document.getElementById('prevPageBtn').disabled = membersCurrentPage === 1;
            document.getElementById('nextPageBtn').disabled = membersCurrentPage >= totalPages;


            tbody.innerHTML = paginatedMembers.length === 0 
                ? `<tr><td colspan="8" class="empty-state"><h3>Ãœye bulunamadÄ±.</h3></td></tr>`
                : paginatedMembers.map(member => {
                    const memberGroups = groups.filter(g => Array.isArray(g.members) && g.members.includes(member.id));
                    
                    let nameCell, parentCell, ageCell;
                    let phoneHtml = `<div style="white-space: nowrap;"><a href="#" class="phone-link" onclick="handlePhoneClick(event, '${member.Telefon}')">${formatPhoneDisplay(member.Telefon)}</a></div>`;
                    if(member.Telefon_2) {
                        phoneHtml += `<div style="white-space: nowrap; margin-top: 4px;"><a href="#" class="phone-link" onclick="handlePhoneClick(event, '${member.Telefon_2}')">${formatPhoneDisplay(member.Telefon_2)}</a></div>`;
                    }


                    if (member.Resit_Olmayan_Adi_Soyadi && member.Resit_Olmayan_Adi_Soyadi.trim() !== '') { // It's a child
                        let veliHtml = capitalizeWords(member.Ad_Soyad);
                        if (member.Veli_2_Adi_Soyadi) {
                            veliHtml += `<br>${capitalizeWords(member.Veli_2_Adi_Soyadi)}`;
                        }
                        // Pseudo-member iÃ§in tÄ±klanabilir link olmasÄ±n
                        if (member.isPseudoMember) {
                            nameCell = `<td><strong>${capitalizeWords(member.Resit_Olmayan_Adi_Soyadi)}</strong></td>`;
                        } else {
                            nameCell = `<td><a href="#" class="member-name-link" onclick="event.preventDefault(); showMemberAttendancePage('${member.id}')"><strong>${capitalizeWords(member.Resit_Olmayan_Adi_Soyadi)}</strong></a></td>`;
                        }
                        parentCell = `<td>${veliHtml}</td>`;
                        const birthDate = member.studentBirthDate;
                        const age = birthDate ? calculateAge(birthDate) : null; 
                        ageCell = `<td>${age !== null ? age : 'Ã‡ocuk'}</td>`;
                    } else { // It's an adult
                        // Pseudo-member iÃ§in tÄ±klanabilir link olmasÄ±n
                        if (member.isPseudoMember) {
                            nameCell = `<td><strong>${capitalizeWords(member.Ad_Soyad)}</strong></td>`;
                        } else {
                            nameCell = `<td><a href="#" class="member-name-link" onclick="event.preventDefault(); showMemberAttendancePage('${member.id}')"><strong>${capitalizeWords(member.Ad_Soyad)}</strong></a></td>`;
                        }
                        parentCell = `<td>-</td>`;
                        ageCell = `<td>YetiÅŸkin</td>`;
                    }
                    
                    // Pseudo-member (pending preRegistration) iÃ§in farklÄ± UI
                    const statusCell = member.isPseudoMember 
                        ? `<td><span class="status-badge status-pending">â³ Bekleyen KayÄ±t</span></td>`
                        : `<td><select class="status-badge status-${member.status || 'pending'}" onchange="updateMemberStatus('${member.id}', this.value)">
                                <option value="pending" ${member.status === 'pending' ? 'selected' : ''}>Bekliyor</option>
                                <option value="active" ${member.status === 'active' ? 'selected' : ''}>Aktif</option>
                                <option value="expired" ${member.status === 'expired' ? 'selected' : ''}>Pasif</option>
                            </select></td>`;
                    
                    const actionsCell = member.isPseudoMember
                        ? `<td>
                            <div class="actions-dropdown">
                                <button class="actions-dropdown-btn" onclick="event.stopPropagation();">âš™ï¸ Ä°ÅŸlemler</button>
                                <div class="actions-dropdown-content">
                                    <button onclick="event.stopPropagation(); window.openPreRegEditModal('${member.preRegistrationId}'); setTimeout(() => { document.querySelector('.actions-dropdown-content').style.display = 'none'; }, 100);">âœï¸ Ã–n KayÄ±t DÃ¼zenle</button>
                                    <button onclick="event.stopPropagation(); window.deleteItem('preRegistration', '${member.preRegistrationId}'); setTimeout(() => { document.querySelector('.actions-dropdown-content').style.display = 'none'; }, 100);">ğŸ—‘ï¸ Sil</button>
                                </div>
                            </div>
                        </td>`
                        : `<td>
                            <div class="actions-container">
                                <button class="btn btn-secondary btn-sm actions-toggle"
                                    data-type="member"
                                    data-member-id="${member.id}"
                                    onclick="toggleActionsMenu(event)">â€¢â€¢â€¢</button>
                            </div>
                        </td>`;
                    
                    return `
                        <tr>
                            ${nameCell}
                            ${parentCell}
                            <td>${phoneHtml}</td>
                             ${ageCell}
                            <td>${member.Brans === 'tenis' ? 'ğŸ¾' : 'ğŸŠ'} ${capitalize(member.Brans)}</td>
                            ${statusCell}
                            <td>${memberGroups.length > 0 ? memberGroups.map(g => g.groupName).join('<br>') : 'âŒ AtanmamÄ±ÅŸ'}</td>
                            ${actionsCell}
                        </tr>`;
                }).join('');
        }

        function renderPaymentsList() {
            const container = document.getElementById('member-payment-list');
            const searchTerm = document.getElementById('paymentSearch').value.toLowerCase();
            if (!container) return;
            
            // âœ… KARDEÅ KORUMALI SYNC CHECK
            // Sadece preRegistrationId yok veya geÃ§ersiz olan Ã¼yeler iÃ§in Ã§alÄ±ÅŸÄ±r
            // Mevcut geÃ§erli preRegistrationId'lere ASLA dokunmaz (kardeÅŸ korumasÄ±)
            const syncLog = { protected: 0, assigned: 0, skipped: 0 };
            
            members.forEach(member => {
                if (!member.Telefon) return;
                
                // â­ KARDEÅ KORUMASI: Mevcut preReg geÃ§erli mi kontrol et
                if (member.preRegistrationId) {
                    const existingPreReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                    if (existingPreReg) {
                        // GeÃ§erli preReg var, DOKUNMA!
                        syncLog.protected++;
                        return;
                    }
                    // preReg bulunamadÄ± (silinmiÅŸ), aÅŸaÄŸÄ±da yenisini bul
                }
                
                // Buraya kadar geldiysek: preRegistrationId yok VEYA silinmiÅŸ
                // Telefona gÃ¶re uygun preReg bul
                const normalizedPhone = member.Telefon.replace(/\D/g, '');
                const matchingPreRegs = preRegistrations.filter(p => {
                    if (!p.phone) return false;
                    const pPhone = p.phone.replace(/\D/g, '');
                    return pPhone === normalizedPhone || 
                           pPhone === '90' + normalizedPhone ||
                           pPhone === normalizedPhone.replace(/^90/, '') ||
                           pPhone === normalizedPhone.replace(/^0/, '');
                });
                
                if (matchingPreRegs.length === 0) {
                    syncLog.skipped++;
                    return; // EÅŸleÅŸme yok
                }
                
                // Tek eÅŸleÅŸme varsa, direkt ata
                if (matchingPreRegs.length === 1) {
                    member.preRegistrationId = matchingPreRegs[0].id;
                    syncLog.assigned++;
                } 
                // Birden fazla eÅŸleÅŸme (KARDEÅLER) - isim eÅŸleÅŸmesine gÃ¶re bul
                else {
                    const memberName = (member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad || '').toLowerCase().trim();
                    const bestMatch = matchingPreRegs.find(p => {
                        const studentName = (p.studentName || '').toLowerCase().trim();
                        const parentName = (p.parentName || p.name || '').toLowerCase().trim();
                        return studentName === memberName || parentName === memberName;
                    });
                    
                    if (bestMatch) {
                        member.preRegistrationId = bestMatch.id;
                        syncLog.assigned++;
                    } else {
                        syncLog.skipped++;
                    }
                    // Ä°sim eÅŸleÅŸmesi yoksa, mevcut preReg'i koru (hiÃ§bir ÅŸey yapma)
                }
            });
            
            console.log('ğŸ›¡ï¸ Sync Check Ã–zeti:', {
                'Korunan (deÄŸiÅŸtirilmedi)': syncLog.protected,
                'Yeni atanan': syncLog.assigned,
                'AtlanadÄ±': syncLog.skipped
            });
            
            // âœ… Sync check sonrasÄ± istatistik hesapla (doÄŸru verilerle)
            updatePaymentStats();
            
            // âœ… Ä°STATÄ°STÄ°K Ä°LE AYNI LÄ°STE: activeMembers kullan (istatistik hesaplama ile tutarlÄ±lÄ±k iÃ§in)
            // SADECE aktif/pending Ã¼yeleri ve preReg'i olanlarÄ± gÃ¶ster
            const activeMembersForFilter = members.filter(member => {
                // Silinen, olmayan veya pasif Ã¼yeleri gÃ¶sterme
                if (!member || !member.id) return false;
                if (member.status !== 'active' && member.status !== 'pending') return false;
                
                // PreReg kontrolÃ¼ - preReg'i olmayan Ã¼yeleri gÃ¶sterme
                if (!member.preRegistrationId) return false;
                const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                // âœ… Ä°STATÄ°STÄ°K Ä°LE AYNI FÄ°LTRE: paymentSchedule.length > 0 kontrolÃ¼
                if (!preReg || !preReg.paymentSchedule || preReg.paymentSchedule.length === 0) return false;
                return true;
            });
            
            // Arama filtresini ayrÄ±ca uygula
            let allMembers = activeMembersForFilter.filter(member => {
                // Arama filtresi - boÅŸ ise tÃ¼mÃ¼nÃ¼ gÃ¶ster
                if (!searchTerm || searchTerm === '') return true;
                
                const name = (member.Ad_Soyad || '').toLowerCase();
                const studentName = (member.Resit_Olmayan_Adi_Soyadi || '').toLowerCase();
                const phone = (member.Telefon || '').toLowerCase();
                const searchLower = searchTerm.toLowerCase();
                
                return name.includes(searchLower) || 
                       studentName.includes(searchLower) ||
                       phone.includes(searchLower);
            });


            let filteredMembers = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const memberHasRelevantPayment = (member, condition) => {
                const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                return preReg && preReg.paymentSchedule && preReg.paymentSchedule.some(condition);
            };

            if (paymentFilter === 'overdue') {
                // âœ… Ä°STATÄ°STÄ°K Ä°LE AYNI MANTIK: activeMembersForFilter kullan (arama filtresi olmadan)
                // Ã–nce arama filtresi olmadan gecikmiÅŸ Ã¶demesi olanlarÄ± bul
                const overdueMembers = activeMembersForFilter.filter(m => {
                    const preReg = preRegistrations.find(p => p.id === m.preRegistrationId);
                    if (!preReg || !preReg.paymentSchedule) return false;
                    return preReg.paymentSchedule.some(p => p.status === 'unpaid' && new Date(p.dueDate + 'T00:00:00') < today);
                });
                
                // Sonra arama filtresini uygula
                filteredMembers = overdueMembers.filter(member => {
                    // Arama filtresi - boÅŸ ise tÃ¼mÃ¼nÃ¼ gÃ¶ster
                    if (!searchTerm || searchTerm === '') return true;
                    
                    const name = (member.Ad_Soyad || '').toLowerCase();
                    const studentName = (member.Resit_Olmayan_Adi_Soyadi || '').toLowerCase();
                    const phone = (member.Telefon || '').toLowerCase();
                    const searchLower = searchTerm.toLowerCase();
                    
                    return name.includes(searchLower) || 
                           studentName.includes(searchLower) ||
                           phone.includes(searchLower);
                });
                
                // Debug iÃ§in
                const debugOverdue = [];
                activeMembersForFilter.forEach(m => {
                    const preReg = preRegistrations.find(p => p.id === m.preRegistrationId);
                    if (preReg && preReg.paymentSchedule) {
                        const hasOverdue = preReg.paymentSchedule.some(p => p.status === 'unpaid' && new Date(p.dueDate + 'T00:00:00') < today);
                        debugOverdue.push({
                            name: m.Ad_Soyad,
                            hasOverdue: hasOverdue,
                            preRegId: m.preRegistrationId,
                            scheduleLength: preReg.paymentSchedule.length
                        });
                    }
                });
                
                console.log('ğŸ” [LÄ°STE] GecikmiÅŸ Ã¶deme filtresi:', {
                    'Toplam aktif Ã¼ye (arama filtresi olmadan)': activeMembersForFilter.length,
                    'GecikmiÅŸ Ã¶demesi olan Ã¼ye sayÄ±sÄ± (arama filtresi olmadan)': overdueMembers.length,
                    'Arama filtresi sonrasÄ± gÃ¶sterilen Ã¼ye sayÄ±sÄ±': filteredMembers.length,
                    'Ãœye isimleri': filteredMembers.map(m => m.Ad_Soyad),
                    'Ãœye ID\'leri': filteredMembers.map(m => m.id),
                    'Debug - TÃ¼m Ã¼yeler': debugOverdue
                });
            } else if (paymentFilter === 'finished') {
                filteredMembers = allMembers.filter(m => {
                    const preReg = preRegistrations.find(p => p.id === m.preRegistrationId);
                    return preReg && preReg.paymentSchedule && preReg.paymentSchedule.every(p => p.status === 'paid');
                });
            } else if (paymentFilter === 'paidThisMonth') {
                // Bu ay Ã¶deme yapan Ã¼yeleri gÃ¶ster (paymentDate bu ayda olanlar)
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                filteredMembers = allMembers.filter(m => {
                    const preReg = preRegistrations.find(p => p.id === m.preRegistrationId);
                    if (!preReg || !preReg.paymentSchedule) return false;
                    return preReg.paymentSchedule.some(p => {
                        if (p.status === 'paid' && p.paymentDate) {
                            const paymentDate = new Date(p.paymentDate);
                            return paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear;
                        }
                        return false;
                    });
                });
            } else { // 'all'
                filteredMembers = allMembers;
            }

            // GecikmiÅŸ Ã¶demeler istatistikleri updatePaymentStats'da hesaplanÄ±yor, burada tekrar hesaplamaya gerek yok
            
            container.innerHTML = filteredMembers.length === 0 
                ? `<div class="empty-state"><h3>Filtreye uygun Ã¼ye bulunamadÄ±.</h3></div>`
                : filteredMembers.map(member => {
                    const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                    const group = groups.find(g => Array.isArray(g.members) && g.members.includes(member.id));
                    let statusHtml = '<span class="status-badge status-pending">Plan Yok</span>';
                    let subStatusHtml = '';

                    if (group) {
                        subStatusHtml += `<div class="sub-status group-name">${group.groupName}</div>`;
                    }
                    if (member.status === 'pending') {
                         subStatusHtml += `<div class="sub-status pending">Beklemede</div>`;
                    }
                     if (member.status === 'expired') {
                        subStatusHtml += `<div class="sub-status expired">Pasif</div>`;
                    }
                    

                    if (preReg && preReg.paymentSchedule) {
                        const overdueCount = preReg.paymentSchedule.filter(p => p.status === 'unpaid' && new Date(p.dueDate + 'T00:00:00') < today).length;
                        if (overdueCount > 0) {
                            statusHtml = `<span class="status-badge status-overdue">${overdueCount} GecikmiÅŸ</span>`;
                        } else {
                            const unpaidCount = preReg.paymentSchedule.filter(p => p.status === 'unpaid').length;
                            if (unpaidCount === 0) {
                                statusHtml = `<span class="status-badge status-completed">TÃ¼mÃ¼ Ã–dendi</span>`;
                            } else {
                                statusHtml = ``;
                            }
                        }
                    }
                    return `
                        <div class="payment-member-item">
                            <div class="payment-member-header">
                                <div class="payment-member-info" onclick="togglePaymentDetails('${member.id}')">
                                    <strong>${member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad} ${member.Resit_Olmayan_Adi_Soyadi ? `(${member.Ad_Soyad})` : ''}</strong>
                                    <div style="font-size: 0.9em; color: #555;">ğŸ“ <a href="#" class="phone-link" onclick="handlePhoneClick(event, '${member.Telefon || ''}')">${member.Telefon || 'Numara Yok'}</a></div>
                                </div>
                                 <div class="status-container" onclick="togglePaymentDetails('${member.id}')">
                                     ${statusHtml}
                                     ${subStatusHtml}
                                </div>
                            </div>
                            <div class="payment-details" id="payment-details-${member.id}">
                                 ${preReg ? `
                                    <div class="payment-details-header">
                                        <h4>Ã–deme PlanÄ±</h4>
                                        <div style="display: flex; gap: 8px;">
                                            ${currentUser?.permissions?.edit_payments ? `
                                                <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteSelectedPayments('${preReg.id}')">ğŸ—‘ï¸ SeÃ§ilenleri Sil</button>
                                                <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); openPaymentEditModal('${preReg.id}', null, true)">+ Yeni Taksit Ekle</button>
                                            ` : ''}
                                        </div>
                                    </div>
                                    ${renderPaymentDetailsTable(preReg)}
                                 ` : '<p class="empty-state">Bu Ã¼yeye ait Ã¶deme planÄ± bulunamadÄ±.</p>'}
                            </div>
                        </div>`;
                }).join('');
            
            // Ã–deme tutarlarÄ±nÄ± maskele (eÄŸer gizli ise) - titreme Ã¶nleme iÃ§in hemen uygula
            requestAnimationFrame(() => applyPaymentVisibility());
        }
        
        // âœ… Ders planÄ± iÃ§in branÅŸ ve saha seÃ§imi
        let selectedCourtForSchedule = null; // Yeni: SeÃ§ili saha
        
        window.selectBranchForSchedule = function(branchId) {
            selectedBranchForSchedule = branchId;
            selectedCourtForSchedule = null; // BranÅŸ deÄŸiÅŸince sahayÄ± sÄ±fÄ±rla
            renderScheduleGrid();
        };
        
        window.selectCourtForSchedule = function(courtName) {
            selectedCourtForSchedule = courtName;
            renderScheduleGrid();
        };
        
        function renderScheduleGrid() {
            const grid = document.getElementById('scheduleGrid');
            const unassignedContainer = document.getElementById('unassigned-groups-container');
            if(!grid || !unassignedContainer) return;
            
            // âœ… Ä°lk aÃ§Ä±lÄ±ÅŸta otomatik olarak ilk branÅŸÄ± seÃ§
            if (!selectedBranchForSchedule && branches.length > 0) {
                selectedBranchForSchedule = branches[0].id;
            }
            
            // âœ… BranÅŸ seÃ§im butonlarÄ±nÄ± render et
            const branchButtonsContainer = document.getElementById('schedule-branch-buttons');
            if (branchButtonsContainer) {
                let buttonsHtml = branches.map(b => {
                    const isActive = selectedBranchForSchedule === b.id;
                    const btnStyle = isActive 
                        ? 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: 2px solid #667eea;'
                        : 'background: #f8f9fa; color: #333; border: 1px solid #ddd;';
                    return `<button class="btn btn-sm" 
                             style="${btnStyle} margin: 3px; padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer; transition: all 0.3s;"
                             onmouseover="if('${isActive}' === 'false') this.style.background='#e9ecef'"
                             onmouseout="if('${isActive}' === 'false') this.style.background='#f8f9fa'"
                             onclick="selectBranchForSchedule('${b.id}')">
                        ${b.icon} ${b.name}
                    </button>`;
                }).join('');
                
                // âœ… SeÃ§ili branÅŸÄ±n sahalarÄ± varsa, saha butonlarÄ±nÄ± ekle
                if (selectedBranchForSchedule) {
                    const selectedBranch = branches.find(b => b.id === selectedBranchForSchedule);
                    if (selectedBranch && selectedBranch.courts && selectedBranch.courts.length > 0) {
                        // Otomatik ilk sahayÄ± seÃ§
                        if (!selectedCourtForSchedule) {
                            selectedCourtForSchedule = selectedBranch.courts[0].name;
                        }
                        
                        buttonsHtml += '<div style="width: 100%; height: 1px; background: #ddd; margin: 10px 0;"></div>';
                        buttonsHtml += selectedBranch.courts.map(c => {
                            const isActive = selectedCourtForSchedule === c.name;
                            const btnStyle = isActive 
                                ? 'background: linear-gradient(135deg, #FF6B6B 0%, #EE5A6F 100%); color: white; border: 2px solid #FF6B6B;'
                                : 'background: #fff; color: #666; border: 1px solid #ccc;';
                            return `<button class="btn btn-sm" 
                                     style="${btnStyle} margin: 3px; padding: 6px 14px; border-radius: 15px; font-weight: 500; cursor: pointer; transition: all 0.3s; font-size: 0.9em;"
                                     onmouseover="if('${isActive}' === 'false') this.style.background='#f5f5f5'"
                                     onmouseout="if('${isActive}' === 'false') this.style.background='#fff'"
                                     onclick="selectCourtForSchedule('${c.name}')">
                                ğŸ“ ${c.name}
                            </button>`;
                        }).join('');
                    }
                }
                
                branchButtonsContainer.innerHTML = buttonsHtml;
            }

            // âœ… BranÅŸ yoksa uyarÄ± gÃ¶ster
            if (branches.length === 0) {
                 grid.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;"><h3>HenÃ¼z branÅŸ tanÄ±mlanmamÄ±ÅŸ. Ayarlar > BranÅŸlar'dan ekleyebilirsiniz.</h3></div>`;
                 unassignedContainer.innerHTML = '';
                 return;
            }
            
            if (!selectedBranchForSchedule) {
                 grid.innerHTML = `<div class="empty-state" style="grid-column: 1 / -1;"><h3>LÃ¼tfen bir branÅŸ seÃ§in.</h3></div>`;
                 unassignedContainer.innerHTML = '';
                 return;
            }

            const filteredUnassignedGroups = groups.filter(g => g.branch === selectedBranchForSchedule);
            let filteredSchedules = schedules.filter(s => s.branch === selectedBranchForSchedule);
            
            // âœ… Saha seÃ§iliyse, sadece o sahaya ait dersleri gÃ¶ster
            if (selectedCourtForSchedule) {
                filteredSchedules = filteredSchedules.filter(s => s.court === selectedCourtForSchedule);
            }

            const allDays = ['pazartesi', 'salÄ±', 'Ã§arÅŸamba', 'perÅŸembe', 'cuma', 'cumartesi', 'pazar'];
            const weekdays = allDays.slice(0, 5);
            const weekends = allDays.slice(5, 7);

            const visibleWeekdays = weekdays.filter(day => !holidays.includes(day));
            const visibleWeekends = weekends.filter(day => !holidays.includes(day));
            
            // âœ… Dinamik branÅŸ ikonu
            unassignedContainer.innerHTML = filteredUnassignedGroups.length > 0 
                ? filteredUnassignedGroups.map(g => {
                    const branchInfo = branches.find(b => b.id === g.branch);
                    const branchIcon = branchInfo ? branchInfo.icon : 'âš½';
                    return `<div class="unassigned-group" draggable="true" ondragstart="drag(event, '${g.id}', true)" onclick="openScheduleModalForGroup('${g.id}')">${branchIcon} ${g.groupName}</div>`;
                }).join('')
                : '<p class="empty-state" style="padding:0;font-size:0.9em;">Bu branÅŸta atanacak grup bulunmuyor.</p>';

            grid.innerHTML = ''; // Clear previous content

            const createLessonBlock = (schedule, group) => {
                const isTrial = group.groupName.toLowerCase().includes('deneme');
                const blockClass = `lesson-block ${isTrial ? 'trial-lesson' : ''}`;
                
                // âœ… BranÅŸÄ±n sahalarÄ± var mÄ± kontrol et
                const branchInfo = branches.find(b => b.id === group.branch);
                const hasCourts = branchInfo && branchInfo.courts && branchInfo.courts.length > 0;
                
                // âœ… Saha bilgisi: Sadece branÅŸÄ±n sahalarÄ± varsa gÃ¶ster
                let courtInfo = '';
                if (hasCourts) {
                    if (schedule.court) {
                        courtInfo = `<div style="font-size: 0.85em; color: #666; cursor: pointer;" onclick="event.stopPropagation(); editScheduleCourt('${schedule.id}')" title="SahayÄ± deÄŸiÅŸtir">ğŸ“ ${schedule.court}</div>`;
                    } else {
                        courtInfo = `<div style="font-size: 0.75em; color: #999; cursor: pointer; font-style: italic;" onclick="event.stopPropagation(); editScheduleCourt('${schedule.id}')" title="Saha ekle">+ Saha ekle</div>`;
                    }
                }
                
                return `
                <div class="${blockClass}">
                    <button class="delete-lesson-btn" onclick="event.stopPropagation(); deleteSchedule(event, '${schedule.id}')" title="Dersi sil">&times;</button>
                    <button class="delete-lesson-btn" onclick="event.stopPropagation(); openScheduleModalForGroup('${group.id}')" title="Dersi dÃ¼zenle" style="right: 30px; background: #4CAF50;">âœï¸</button>
                    <div onclick="openAttendanceModal('${group.id}')" style="cursor: pointer;">
                        <div><strong>${schedule.startTime} - ${schedule.endTime}</strong></div>
                        <div>${group.groupName}</div>
                        ${courtInfo}
                    </div>
                </div>`;
            }

            const createEmptySlotBlock = (start, end, day) => `
                <div class="lesson-block empty-slot" ondrop="drop(event, '${day}', '${start}')" ondragover="allowDrop(event)">
                    <div><strong>${start} - ${end}</strong></div>
                    <div>BoÅŸ</div>
                </div>`;

            const generateDayHtml = (day) => {
                // Only include schedules where the group still exists
                const daySchedules = filteredSchedules
                    .filter(s => s.day === day && groups.find(g => g.id === s.groupId))
                    .sort((a, b) => a.startTime.localeCompare(b.startTime));
                
                let allBlocksHtml = '';

                if (daySchedules.length > 0) {
                    // Add first lesson
                    const firstGroup = groups.find(g => g.id === daySchedules[0].groupId);
                    allBlocksHtml += createLessonBlock(daySchedules[0], firstGroup);

                    // Add gaps ONLY between consecutive lessons
                    for (let i = 1; i < daySchedules.length; i++) {
                        const prevSchedule = daySchedules[i - 1];
                        const currentSchedule = daySchedules[i];
                        const currentGroup = groups.find(g => g.id === currentSchedule.groupId);

                        // Calculate gap between lessons
                        const prevEndMinutes = timeToMinutes(prevSchedule.endTime);
                        const currentStartMinutes = timeToMinutes(currentSchedule.startTime);

                        // Add empty slot ONLY if there's a gap between two actual lessons
                        if (currentStartMinutes > prevEndMinutes) {
                            const gapStart = minutesToTime(prevEndMinutes);
                            const gapEnd = minutesToTime(currentStartMinutes);
                            allBlocksHtml += createEmptySlotBlock(gapStart, gapEnd, day);
                        }
                        
                        // Add current lesson
                        allBlocksHtml += createLessonBlock(currentSchedule, currentGroup);
                    }
                }

                return `<div class="schedule-day" ondrop="drop(event, '${day}')" ondragover="allowDrop(event)"><h4>${capitalize(day)}</h4>${allBlocksHtml}</div>`;
            };

            if (visibleWeekdays.length > 0) {
                const weekdayContainer = document.createElement('div');
                weekdayContainer.className = 'schedule-row weekday-row';
                weekdayContainer.innerHTML = visibleWeekdays.map(generateDayHtml).join('');
                grid.appendChild(weekdayContainer);
            }

            if (visibleWeekends.length > 0) {
                const weekendContainer = document.createElement('div');
                weekendContainer.className = 'schedule-row weekend-row';
                weekendContainer.innerHTML = visibleWeekends.map(generateDayHtml).join('');
                grid.appendChild(weekendContainer);
            }
        }

        // âœ… Grup yÃ¶netimi iÃ§in branÅŸ seÃ§imi
        window.selectBranchForGroups = function(branchId) {
            selectedBranchForGroups = branchId;
            renderGroupsList();
            
            // Yeni grup butonunu gÃ¶ster/gizle
            const newGroupBtn = document.getElementById('newGroupBtn');
            if (newGroupBtn) {
                newGroupBtn.style.display = branchId ? 'inline-block' : 'none';
            }
        };

        function renderGroupsList() {
            const container = document.getElementById('groupsList');
            const searchTerm = document.getElementById('groupSearch')?.value.toLowerCase() || '';
            if (!container) return;
            
            // âœ… Ä°lk aÃ§Ä±lÄ±ÅŸta otomatik olarak ilk branÅŸÄ± seÃ§
            if (!selectedBranchForGroups && branches.length > 0) {
                selectedBranchForGroups = branches[0].id;
                // Yeni grup butonunu gÃ¶ster
                const newGroupBtn = document.getElementById('newGroupBtn');
                if (newGroupBtn) newGroupBtn.style.display = 'inline-block';
            }
            
            // âœ… BranÅŸ seÃ§im butonlarÄ±nÄ± render et
            const branchButtonsContainer = document.getElementById('groups-branch-buttons');
            if (branchButtonsContainer) {
                branchButtonsContainer.innerHTML = branches.map(b => {
                    const isActive = selectedBranchForGroups === b.id;
                    const btnStyle = isActive 
                        ? 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: 2px solid #667eea;'
                        : 'background: #f8f9fa; color: #333; border: 1px solid #ddd;';
                    return `<button class="btn btn-sm" 
                             style="${btnStyle} margin: 3px; padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer; transition: all 0.3s;"
                             onmouseover="if('${isActive}' === 'false') this.style.background='#e9ecef'"
                             onmouseout="if('${isActive}' === 'false') this.style.background='#f8f9fa'"
                             onclick="selectBranchForGroups('${b.id}')">
                        ${b.icon} ${b.name}
                    </button>`;
                }).join('');
            }

            // âœ… BranÅŸ yoksa uyarÄ± gÃ¶ster
            if (branches.length === 0) {
                container.innerHTML = `<div class="empty-state"><h3>HenÃ¼z branÅŸ tanÄ±mlanmamÄ±ÅŸ. Ayarlar > BranÅŸlar'dan ekleyebilirsiniz.</h3></div>`;
                return;
            }

            if (!selectedBranchForGroups) {
                container.innerHTML = `<div class="empty-state"><h3>LÃ¼tfen bir branÅŸ seÃ§in.</h3></div>`;
                return;
            }

            const filteredGroups = groups.filter(g => g.branch === selectedBranchForGroups && g.groupName.toLowerCase().includes(searchTerm));

            const childGroups = [];
            const adultGroups = [];
            const emptyGroups = [];

            filteredGroups.forEach(group => {
                // âœ… GÃ¼venli kontrol: members yoksa boÅŸ array kabul et
                const memberIds = Array.isArray(group.members) ? group.members : [];
                const groupMembers = members.filter(m => memberIds.includes(m.id) && m.status !== 'expired');
                if (groupMembers.length === 0) {
                    emptyGroups.push(group);
                    return;
                }

                const isChildGroup = groupMembers.some(m => m.Resit_Olmayan_Adi_Soyadi && m.Resit_Olmayan_Adi_Soyadi.trim() !== '');
                if (isChildGroup) {
                    childGroups.push(group);
                } else {
                    adultGroups.push(group);
                }
            });

            let finalHtml = '';
            
            if (childGroups.length > 0) {
                finalHtml += `<h2 class="group-category-title">Ã‡ocuk GruplarÄ±</h2>`;
                finalHtml += childGroups.map(renderGroupCard).join('');
            }
            if (adultGroups.length > 0) {
                finalHtml += `<h2 class="group-category-title">YetiÅŸkin GruplarÄ±</h2>`;
                finalHtml += adultGroups.map(renderGroupCard).join('');
            }
            if (emptyGroups.length > 0) {
                finalHtml += `<h2 class="group-category-title">BoÅŸ Gruplar</h2>`;
                finalHtml += emptyGroups.map(renderGroupCard).join('');
            }

            if (finalHtml === '') {
                container.innerHTML = `<div class="empty-state"><h3>Grup bulunamadÄ±.</h3></div>`;
            } else {
                container.innerHTML = finalHtml;
            }
        }

        function renderGroupCard(group) {
             const isTrial = group.groupName.toLowerCase().includes('deneme');
             const cardClass = `group-card ${isTrial ? 'group-card-trial' : ''}`;
             // âœ… GÃ¼venli kontrol: members yoksa boÅŸ array kabul et
             const groupMembers = group.members || [];
             const memberIds = Array.isArray(groupMembers) ? groupMembers : [];
             
             // ğŸ” Debug: Grup Ã¼yelik bilgisini gÃ¶ster
             console.log(`ğŸ” Grup KartÄ±: ${group.groupName}`, {
                 groupId: group.id,
                 membersField: group.members,
                 isArray: Array.isArray(group.members),
                 memberIds: memberIds,
                 memberCount: memberIds.length,
                 allMembers: members.length
             });
             
             const activeMembers = members.filter(m => memberIds.includes(m.id) && m.status !== 'expired');
             
             // ğŸ” Debug: FiltrelenmiÅŸ Ã¼yeleri gÃ¶ster
             if (memberIds.length > 0) {
                 console.log(`  â†’ ${memberIds.length} member ID, ${activeMembers.length} aktif Ã¼ye`);
                 if (memberIds.length !== activeMembers.length) {
                     const missingIds = memberIds.filter(id => !members.find(m => m.id === id));
                     const expiredMembers = memberIds.filter(id => {
                         const m = members.find(mem => mem.id === id);
                         return m && m.status === 'expired';
                     });
                     console.log(`  âš ï¸ ${missingIds.length} Ã¼ye bulunamadÄ±, ${expiredMembers.length} Ã¼ye expired`);
                 }
             }
             
             const memberCount = activeMembers.length;

            return `
                <div class="${cardClass}" onclick="openGroupEditModal('${group.id}')" style="cursor: pointer;">
                    <div>
                        <h4>${group.groupName}</h4>
                        <p><strong>BranÅŸ:</strong> ${group.branch === 'tenis' ? 'ğŸ¾' : 'ğŸŠ'} ${capitalize(group.branch)}</p>
                        <p><strong>EÄŸitmen:</strong> ğŸ‘¨â€ğŸ« ${group.instructor}</p>
                        <p><strong>Ãœye SayÄ±sÄ±:</strong> ğŸ‘¥ ${memberCount}/${group.maxMembers}</p>
                    </div>
                    <div class="group-members">${activeMembers.map(member => {
                        return `<span class="member-tag">${member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad}</span>`
                    }).join('') || '<span class="member-tag">Aktif Ã¼ye yok</span>'}</div>
                    <div class="group-card-actions">
                        <button class="btn btn-warning btn-sm" onclick="event.stopPropagation(); assignToGroup(null, '${group.id}')">ğŸ‘¥ Ãœye Ekle/Ã‡Ä±kar</button>
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteItem('groups', '${group.id}')">ğŸ—‘ï¸ Sil</button>
                    </div>
                </div>`;
        }
        
        function renderSettings() {
            const holidayContainer = document.getElementById('holiday-settings');
            const allDays = ['pazartesi', 'salÄ±', 'Ã§arÅŸamba', 'perÅŸembe', 'cuma', 'cumartesi', 'pazar'];
            holidayContainer.innerHTML = allDays.map(day => `
                <label>
                    <input type="checkbox" name="holidays" value="${day}" ${holidays.includes(day) ? 'checked' : ''}>
                    ${capitalize(day)}
                </label>
            `).join('');

            const clubNameInput = document.querySelector('#settingsForm [name="clubName"]');
            if(clubNameInput) {
                clubNameInput.value = clubSettings.clubName;
            }
            
            // âœ… Random bekleme sÃ¼resi ayarlarÄ±nÄ± formda gÃ¶ster
            const minWaitInput = document.getElementById('minWaitTime');
            const maxWaitInput = document.getElementById('maxWaitTime');
            const longWaitTriggerInput = document.getElementById('longWaitTrigger');
            const minLongWaitInput = document.getElementById('minLongWait');
            const maxLongWaitInput = document.getElementById('maxLongWait');
            
            if (minWaitInput) minWaitInput.value = clubSettings.minWaitTime || 20;
            if (maxWaitInput) maxWaitInput.value = clubSettings.maxWaitTime || 50;
            if (longWaitTriggerInput) longWaitTriggerInput.value = clubSettings.longWaitTrigger || 100;
            if (minLongWaitInput) minLongWaitInput.value = clubSettings.minLongWait || 400;
            if (maxLongWaitInput) maxLongWaitInput.value = clubSettings.maxLongWait || 800;
            
            loadExpenseCategories();
            renderUsersTable();
        }
        
        // Gider kategorileri yÃ¶netimi
        window.addExpenseCategory = async function(event) {
            event.preventDefault();
            
            const nameInput = document.getElementById('newExpenseCategoryName');
            const iconInput = document.getElementById('newExpenseCategoryIcon');
            
            const name = nameInput.value.trim();
            const icon = iconInput.value.trim() || 'ğŸ“¦';
            
            if (!name) {
                showAlert('âŒ Kategori adÄ± gerekli', 'danger');
                return;
            }
            
            // KulÃ¼p ayarlarÄ±na ekle
            if (!clubSettings.expenseCategories) {
                clubSettings.expenseCategories = [];
            }
            
            // AynÄ± isimde kategori var mÄ± kontrol et
            if (clubSettings.expenseCategories.find(cat => cat.name === name)) {
                showAlert('âŒ Bu kategori zaten mevcut', 'danger');
                return;
            }
            
            clubSettings.expenseCategories.push({ name, icon });
            
            // Firebase'e kaydet
            try {
                await window.firebase.updateDoc(
                    window.firebase.doc(window.db, 'clubs', currentClubId),
                    { expenseCategories: clubSettings.expenseCategories }
                );
                
                showAlert('âœ… Kategori baÅŸarÄ±yla eklendi', 'success');
                nameInput.value = '';
                iconInput.value = '';
                loadExpenseCategories();
            } catch (error) {
                console.error('Kategori eklenirken hata:', error);
                showAlert('âŒ Kategori eklenirken bir hata oluÅŸtu', 'danger');
            }
        };
        
        async function loadExpenseCategories() {
            const container = document.getElementById('expenseCategoriesContainer');
            if (!container) return;
            
            const customCategories = clubSettings.expenseCategories || [];
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">';
            
            // VarsayÄ±lan kategoriler
            const defaults = [
                { name: 'Kira', icon: 'ğŸ ' },
                { name: 'MaaÅŸ', icon: 'ğŸ’°' },
                { name: 'Fatura', icon: 'ğŸ“„' },
                { name: 'Malzeme', icon: 'ğŸ”§' },
                { name: 'DiÄŸer', icon: 'ğŸ“¦' }
            ];
            
            defaults.forEach(cat => {
                html += `
                    <div class="expense-category-card" data-category="${cat.name}">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">${cat.icon}</span>
                            <span style="font-weight: 600;">${cat.name}</span>
                        </div>
                        <span style="font-size: 11px; color: #666; margin-top: 5px;">VarsayÄ±lan</span>
                    </div>
                `;
            });
            
            // Ã–zel kategoriler
            customCategories.forEach(cat => {
                html += `
                    <div class="expense-category-card" data-category="${cat.name}">
                        <button class="delete-category-btn" onclick="deleteExpenseCategory('${cat.name}')" title="Sil">Ã—</button>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">${cat.icon}</span>
                            <span style="font-weight: 600;">${cat.name}</span>
                        </div>
                        <span style="font-size: 11px; color: #4caf50; margin-top: 5px;">Ã–zel</span>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        window.deleteExpenseCategory = async function(categoryName) {
            if (!confirm(`"${categoryName}" kategorisini silmek istediÄŸinize emin misiniz?`)) return;
            
            clubSettings.expenseCategories = clubSettings.expenseCategories.filter(cat => cat.name !== categoryName);
            
            try {
                await window.firebase.updateDoc(
                    window.firebase.doc(window.db, 'clubs', currentClubId),
                    { expenseCategories: clubSettings.expenseCategories }
                );
                
                showAlert('âœ… Kategori silindi', 'success');
                loadExpenseCategories();
                loadExpenseCategoriesModal();
            } catch (error) {
                console.error('Kategori silinirken hata:', error);
                showAlert('âŒ Kategori silinirken bir hata oluÅŸtu', 'danger');
            }
        };
        
        // Gider kategorisi yÃ¶netimi modal'Ä± aÃ§
        window.openExpenseCategoryManager = function() {
            loadExpenseCategoriesModal();
            openModal('expenseCategoryManagerModal');
            
            // Formu sÄ±fÄ±rla
            const form = document.getElementById('expenseCategoryQuickForm');
            if (form) form.reset();
            
            // SeÃ§ili ikonu varsayÄ±lana Ã§evir
            const selectedIconDisplay = document.getElementById('expenseSelectedIcon');
            if (selectedIconDisplay) selectedIconDisplay.textContent = 'ğŸ“¦';
            
            // TÃ¼m ikon seÃ§imlerini temizle
            document.querySelectorAll('#expenseIconPicker .icon-option').forEach(btn => {
                btn.style.border = '2px solid transparent';
                btn.style.background = 'white';
            });
            
            // Event listener'larÄ± baÅŸlat
            setTimeout(initExpenseIconListeners, 100);
        };
        
        // Modal iÃ§inde kategorileri yÃ¼kle
        function loadExpenseCategoriesModal() {
            const container = document.getElementById('expenseCategoriesModalContainer');
            if (!container) return;
            
            const customCategories = clubSettings.expenseCategories || [];
            const defaults = [
                { name: 'Kira', icon: 'ğŸ ' },
                { name: 'MaaÅŸ', icon: 'ğŸ’°' },
                { name: 'Fatura', icon: 'ğŸ“„' },
                { name: 'Malzeme', icon: 'ğŸ”§' },
                { name: 'DiÄŸer', icon: 'ğŸ“¦' }
            ];
            
            let html = '';
            
            // VarsayÄ±lan kategoriler
            defaults.forEach(cat => {
                html += `
                    <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">${cat.icon}</span>
                        <span style="font-weight: 600; flex: 1;">${cat.name}</span>
                        <span style="font-size: 10px; color: #666;">VarsayÄ±lan</span>
                    </div>
                `;
            });
            
            // Ã–zel kategoriler
            customCategories.forEach(cat => {
                html += `
                    <div style="background: white; border: 2px solid #4caf50; padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">${cat.icon}</span>
                        <span style="font-weight: 600; flex: 1;">${cat.name}</span>
                        <button onclick="deleteExpenseCategory('${cat.name}')" style="background: #f44336; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">Sil</button>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p style="text-align: center; color: #666;">HenÃ¼z Ã¶zel kategori yok</p>';
        }
        
        // HÄ±zlÄ± kategori ekleme (modal iÃ§inden)
        window.addExpenseCategoryQuick = async function(event) {
            event.preventDefault();
            
            const nameInput = document.getElementById('quickExpenseCategoryName');
            const iconInput = document.getElementById('quickExpenseCategoryIcon');
            
            const name = nameInput.value.trim();
            const icon = iconInput.value.trim() || 'ğŸ“¦';
            
            if (!name) {
                showAlert('âŒ Kategori adÄ± gerekli', 'danger');
                return;
            }
            
            if (!clubSettings.expenseCategories) {
                clubSettings.expenseCategories = [];
            }
            
            if (clubSettings.expenseCategories.find(cat => cat.name === name)) {
                showAlert('âŒ Bu kategori zaten mevcut', 'danger');
                return;
            }
            
            clubSettings.expenseCategories.push({ name, icon });
            
            try {
                await window.firebase.updateDoc(
                    window.firebase.doc(window.db, 'clubs', currentClubId),
                    { expenseCategories: clubSettings.expenseCategories }
                );
                
                showAlert('âœ… Kategori eklendi', 'success');
                
                // Modal'Ä± kapat
                closeModal('expenseCategoryManagerModal');
                
                // Kategorileri yeniden yÃ¼kle
                loadExpenseCategories();
            } catch (error) {
                console.error('Kategori eklenirken hata:', error);
                showAlert('âŒ Kategori eklenirken bir hata oluÅŸtu', 'danger');
            }
        };
        
        // Ä°kon seÃ§me fonksiyonlarÄ±
        window.selectExpenseIcon = function(icon) {
            const iconInput = document.getElementById('quickExpenseCategoryIcon');
            const selectedIconDisplay = document.getElementById('expenseSelectedIcon');
            
            if (iconInput) iconInput.value = icon;
            if (selectedIconDisplay) selectedIconDisplay.textContent = icon;
            
            // TÃ¼m ikon butonlarÄ±ndan seÃ§ili stilini kaldÄ±r
            document.querySelectorAll('#expenseIconPicker .icon-option').forEach(btn => {
                btn.style.border = '2px solid transparent';
                btn.style.background = 'white';
            });
            
            // SeÃ§ilen ikona stil ekle
            const selectedBtn = document.querySelector(`#expenseIconPicker .icon-option[data-icon="${icon}"]`);
            if (selectedBtn) {
                selectedBtn.style.border = '2px solid #2196f3';
                selectedBtn.style.background = '#e3f2fd';
            }
        };
        
        // Ä°kon input event listener'larÄ±
        function initExpenseIconListeners() {
            const expenseIconInput = document.getElementById('quickExpenseCategoryIcon');
            if (expenseIconInput) {
                // Remove existing listeners by replacing element
                const newInput = expenseIconInput.cloneNode(true);
                expenseIconInput.parentNode.replaceChild(newInput, expenseIconInput);
                
                newInput.addEventListener('input', function(e) {
                    const selectedIconDisplay = document.getElementById('expenseSelectedIcon');
                    if (selectedIconDisplay) {
                        selectedIconDisplay.textContent = e.target.value || 'ğŸ“¦';
                    }
                    
                    // TÃ¼m ikon butonlarÄ±ndan seÃ§ili stilini kaldÄ±r
                    document.querySelectorAll('#expenseIconPicker .icon-option').forEach(btn => {
                        btn.style.border = '2px solid transparent';
                        btn.style.background = 'white';
                    });
                });
            }
        }
        
        // ÃœrÃ¼n kategorisi yÃ¶netimi modal'Ä± aÃ§
        window.openProductCategoryManager = function() {
            loadProductCategoriesModal();
            openModal('productCategoryManagerModal');
            
            // Formu sÄ±fÄ±rla
            const form = document.getElementById('productCategoryQuickForm');
            if (form) form.reset();
            
            // SeÃ§ili ikonu varsayÄ±lana Ã§evir
            const selectedIconDisplay = document.getElementById('productSelectedIcon');
            if (selectedIconDisplay) selectedIconDisplay.textContent = 'ğŸ“¦';
            
            // TÃ¼m ikon seÃ§imlerini temizle
            document.querySelectorAll('#productIconPicker .icon-option').forEach(btn => {
                btn.style.border = '2px solid transparent';
                btn.style.background = 'white';
            });
            
            // Event listener'larÄ± baÅŸlat
            setTimeout(initProductIconListeners, 100);
        };
        
        // ÃœrÃ¼n kategorileri modal'da yÃ¼kle
        function loadProductCategoriesModal() {
            const container = document.getElementById('productCategoriesModalContainer');
            if (!container) return;
            
            const customCategories = clubSettings.productCategories || [];
            const defaults = [
                { name: 'Ekipman', icon: 'âš½' },
                { name: 'KÄ±yafet', icon: 'ğŸ‘•' },
                { name: 'Abonelik', icon: 'ğŸ’³' },
                { name: 'DiÄŸer', icon: 'ğŸ“¦' }
            ];
            
            let html = '';
            
            // VarsayÄ±lan kategoriler
            defaults.forEach(cat => {
                html += `
                    <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">${cat.icon}</span>
                        <span style="font-weight: 600; flex: 1;">${cat.name}</span>
                        <span style="font-size: 10px; color: #666;">VarsayÄ±lan</span>
                    </div>
                `;
            });
            
            // Ã–zel kategoriler
            customCategories.forEach(cat => {
                html += `
                    <div style="background: white; border: 2px solid #ff9800; padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 20px;">${cat.icon}</span>
                        <span style="font-weight: 600; flex: 1;">${cat.name}</span>
                        <button onclick="deleteProductCategory('${cat.name}')" style="background: #f44336; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">Sil</button>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p style="text-align: center; color: #666;">HenÃ¼z Ã¶zel kategori yok</p>';
        }
        
        // HÄ±zlÄ± Ã¼rÃ¼n kategorisi ekleme
        window.addProductCategoryQuick = async function(event) {
            event.preventDefault();
            
            const nameInput = document.getElementById('quickProductCategoryName');
            const iconInput = document.getElementById('quickProductCategoryIcon');
            
            const name = nameInput.value.trim();
            const icon = iconInput.value.trim() || 'ğŸ“¦';
            
            if (!name) {
                showAlert('âŒ Kategori adÄ± gerekli', 'danger');
                return;
            }
            
            if (!clubSettings.productCategories) {
                clubSettings.productCategories = [];
            }
            
            if (clubSettings.productCategories.find(cat => cat.name === name)) {
                showAlert('âŒ Bu kategori zaten mevcut', 'danger');
                return;
            }
            
            clubSettings.productCategories.push({ name, icon });
            
            try {
                await window.firebase.updateDoc(
                    window.firebase.doc(window.db, 'clubs', currentClubId),
                    { productCategories: clubSettings.productCategories }
                );
                
                showAlert('âœ… Kategori eklendi', 'success');
                
                // Modal'Ä± kapat
                closeModal('productCategoryManagerModal');
            } catch (error) {
                console.error('Kategori eklenirken hata:', error);
                showAlert('âŒ Kategori eklenirken bir hata oluÅŸtu', 'danger');
            }
        };
        
        // ÃœrÃ¼n iÃ§in ikon seÃ§me fonksiyonu
        window.selectProductIcon = function(icon) {
            const iconInput = document.getElementById('quickProductCategoryIcon');
            const selectedIconDisplay = document.getElementById('productSelectedIcon');
            
            if (iconInput) iconInput.value = icon;
            if (selectedIconDisplay) selectedIconDisplay.textContent = icon;
            
            // TÃ¼m ikon butonlarÄ±ndan seÃ§ili stilini kaldÄ±r
            document.querySelectorAll('#productIconPicker .icon-option').forEach(btn => {
                btn.style.border = '2px solid transparent';
                btn.style.background = 'white';
            });
            
            // SeÃ§ilen ikona stil ekle
            const selectedBtn = document.querySelector(`#productIconPicker .icon-option[data-icon="${icon}"]`);
            if (selectedBtn) {
                selectedBtn.style.border = '2px solid #ff9800';
                selectedBtn.style.background = '#fff3e0';
            }
        };
        
        // ÃœrÃ¼n ikon input event listener'larÄ±
        function initProductIconListeners() {
            const productIconInput = document.getElementById('quickProductCategoryIcon');
            if (productIconInput) {
                // Remove existing listeners by replacing element
                const newInput = productIconInput.cloneNode(true);
                productIconInput.parentNode.replaceChild(newInput, productIconInput);
                
                newInput.addEventListener('input', function(e) {
                    const selectedIconDisplay = document.getElementById('productSelectedIcon');
                    if (selectedIconDisplay) {
                        selectedIconDisplay.textContent = e.target.value || 'ğŸ“¦';
                    }
                    
                    // TÃ¼m ikon butonlarÄ±ndan seÃ§ili stilini kaldÄ±r
                    document.querySelectorAll('#productIconPicker .icon-option').forEach(btn => {
                        btn.style.border = '2px solid transparent';
                        btn.style.background = 'white';
                    });
                });
            }
        }
        
        // ÃœrÃ¼n kategorisi silme
        window.deleteProductCategory = async function(categoryName) {
            if (!confirm(`"${categoryName}" kategorisini silmek istediÄŸinize emin misiniz?`)) return;
            
            clubSettings.productCategories = clubSettings.productCategories.filter(cat => cat.name !== categoryName);
            
            try {
                await window.firebase.updateDoc(
                    window.firebase.doc(window.db, 'clubs', currentClubId),
                    { productCategories: clubSettings.productCategories }
                );
                
                showAlert('âœ… Kategori silindi', 'success');
                loadProductCategoriesModal();
            } catch (error) {
                console.error('Kategori silinirken hata:', error);
                showAlert('âŒ Kategori silinirken bir hata oluÅŸtu', 'danger');
            }
        };

        function renderUsersTable() {
            const tbody = document.getElementById('usersTable');
            if (!tbody) return;
            tbody.innerHTML = users.map(user => {
                const permissionLabels = {
                    // Finansal
                    'view_payments': 'Ã–demeleri GÃ¶rÃ¼ntÃ¼leme',
                    'edit_payments': 'Ã–demeleri DÃ¼zenleme',
                    'delete_payments': 'Ã–demeleri Silme',
                    'export_payments': 'Ã–demeleri DÄ±ÅŸa Aktarma',
                    // Ãœye
                    'view_members': 'Ãœyeleri GÃ¶rÃ¼ntÃ¼leme',
                    'add_members': 'Ãœye Ekleme',
                    'edit_members': 'Ãœye DÃ¼zenleme',
                    'delete_members': 'Ãœye Silme',
                    'export_members': 'Ãœyeleri DÄ±ÅŸa Aktarma',
                    // CRM
                    'view_crm': 'CRM GÃ¶rÃ¼ntÃ¼leme',
                    'add_crm': 'CRM\'e Ekleme',
                    'edit_crm': 'CRM DÃ¼zenleme',
                    'delete_crm': 'CRM\'den Silme',
                    'view_calls': 'AramalarÄ± GÃ¶rÃ¼ntÃ¼leme',
                    // Ä°letiÅŸim
                    'send_messages': 'Mesaj GÃ¶nderme',
                    'send_bulk_messages': 'Toplu Mesaj',
                    'view_message_history': 'Mesaj GeÃ§miÅŸi',
                    // Raporlar
                    'view_stats': 'Ä°statistikler',
                    'view_reports': 'Raporlar',
                    'export_reports': 'Rapor DÄ±ÅŸa Aktarma',
                    // Ayarlar
                    'manage_users': 'KullanÄ±cÄ± YÃ¶netimi',
                    'manage_settings': 'Ayarlar',
                    'manage_branches': 'BranÅŸ YÃ¶netimi',
                    'manage_groups': 'Grup YÃ¶netimi',
                    // Yoklama
                    'view_attendance': 'Yoklama GÃ¶rÃ¼ntÃ¼leme',
                    'edit_attendance': 'Yoklama DÃ¼zenleme',
                    'manage_schedule': 'Takvim YÃ¶netimi'
                };
                
                const permissionsText = Object.entries(user.permissions || {})
                    .filter(([key, value]) => value)
                    .map(([key]) => permissionLabels[key] || key)
                    .join(', ') || 'Yok';
                
                const editButton = `<button class="btn btn-primary btn-sm" onclick="openUserEditModal('${user.id}')">âœï¸ DÃ¼zenle</button>`;
                const deleteButton = user.isSuperAdmin 
                    ? '' 
                    : `<button class="btn btn-danger btn-sm" onclick="deleteItem('users', '${user.id}')">ğŸ—‘ï¸ Sil</button>`;

                return `<tr>
                    <td>${user.fullName || 'N/A'}</td>
                    <td><a href="#" class="phone-link" onclick="handlePhoneClick(event, '${user.phone || ''}')">${user.phone || user.username}</a></td>
                    <td>${permissionsText}</td>
                    <td>
                        ${editButton}
                        ${deleteButton}
                    </td>
                </tr>`;
            }).join('');
        }

        function openUserEditModal(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            const modal = document.getElementById('userEditModal');
            const form = document.getElementById('userEditForm');
            
            form.elements['fullName'].value = user.fullName || '';
            form.elements['phone'].value = user.phone || '';
            form.elements['password'].value = user.password || '';
            
            // Set permissions checkboxes
            const permissionsCheckboxes = form.querySelectorAll('input[name="permissions"]');
            permissionsCheckboxes.forEach(checkbox => {
                checkbox.checked = user.permissions && user.permissions[checkbox.value];
            });
            
            form.dataset.userId = userId;
            modal.style.display = 'block';
        }

        async function handleUserUpdate(e) {
            e.preventDefault();
            const form = e.target;
            const userId = form.dataset.userId;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const selectedPermissions = formData.getAll('permissions');

            const userData = {
                fullName: data.fullName,
                phone: data.phone,
                phoneNumber: data.phone, // For WhatsApp notifications
                username: data.phone,
                password: data.password, 
                email: data.phone + '@kulup.local', // For task assignment
                permissions: {
                    // Finansal Yetkiler
                    view_payments: selectedPermissions.includes('view_payments'),
                    edit_payments: selectedPermissions.includes('edit_payments'),
                    delete_payments: selectedPermissions.includes('delete_payments'),
                    export_payments: selectedPermissions.includes('export_payments'),
                    
                    // Ãœye Yetkiler
                    view_members: selectedPermissions.includes('view_members'),
                    add_members: selectedPermissions.includes('add_members'),
                    edit_members: selectedPermissions.includes('edit_members'),
                    delete_members: selectedPermissions.includes('delete_members'),
                    export_members: selectedPermissions.includes('export_members'),
                    
                    // CRM Yetkileri
                    view_crm: selectedPermissions.includes('view_crm'),
                    add_crm: selectedPermissions.includes('add_crm'),
                    edit_crm: selectedPermissions.includes('edit_crm'),
                    delete_crm: selectedPermissions.includes('delete_crm'),
                    view_calls: selectedPermissions.includes('view_calls'),
                    
                    // Ä°letiÅŸim Yetkileri
                    send_messages: selectedPermissions.includes('send_messages'),
                    send_bulk_messages: selectedPermissions.includes('send_bulk_messages'),
                    view_message_history: selectedPermissions.includes('view_message_history'),
                    
                    // Raporlar ve Ä°statistikler
                    view_stats: selectedPermissions.includes('view_stats'),
                    view_reports: selectedPermissions.includes('view_reports'),
                    export_reports: selectedPermissions.includes('export_reports'),
                    
                    // Ayarlar ve YÃ¶netim
                    manage_users: selectedPermissions.includes('manage_users'),
                    manage_settings: selectedPermissions.includes('manage_settings'),
                    manage_branches: selectedPermissions.includes('manage_branches'),
                    manage_groups: selectedPermissions.includes('manage_groups'),
                    
                    // Yoklama ve Takvim
                    view_attendance: selectedPermissions.includes('view_attendance'),
                    edit_attendance: selectedPermissions.includes('edit_attendance'),
                    manage_schedule: selectedPermissions.includes('manage_schedule')
                }
            };

            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'users', userId), userData);
                showAlert('YÃ¶netici baÅŸarÄ±yla gÃ¼ncellendi.', 'success');
                closeModal('userEditModal');
                await loadData();
                renderUsersTable();
            } catch (error) {
                console.error('Error updating user:', error);
                showAlert('YÃ¶netici gÃ¼ncellenirken bir hata oluÅŸtu.', 'danger');
            }
        }

        window.openUserEditModal = openUserEditModal;

        // ========== CRM FUNCTIONS ==========
        
        // CRM Dashboard Ä°statistikleri
        function renderCRMDashboard() {
            // ğŸš€ HIZLI BAÅLANGIÃ‡ - Veriler yÃ¼klenirken CRM dashboard'u atla
            if (crmLeads.length === 0 && members.length === 0) {
                console.log('âš¡ CRM Dashboard loading state - atlanÄ±yor');
                return;
            }
            
            renderCRMStats();
            renderTodayTrials();
            renderUpcomingRegistrations();
            renderMissedCalls();
            renderBranchDistribution();
            renderTagDistribution();
            renderAccumulationAnalysis();
        }
        
        function renderBranchTagStats() {
            const statsContainer = document.getElementById('branch-tag-stats');
            if (!statsContainer) return;
            
            // âœ… CRM etiketlerini dinamik olarak al (tÃ¼m etiketler dahil)
            const tagsList = crmTags
                .filter(tag => tag.isActive !== false) // Sadece aktif etiketler
                .sort((a, b) => (a.order || 999) - (b.order || 999)) // SÄ±raya gÃ¶re
                .map(tag => tag.name); // Sadece isimleri al
            
            // EÄŸer hiÃ§ etiket yoksa, varsayÄ±lan liste kullan
            if (tagsList.length === 0) {
                tagsList.push('AranmadÄ±', 'Mesaj AtÄ±lacak', 'Denemeye Gelecek', 'KayÄ±t Olabilir', 'KayÄ±t Oldu');
            }
            
            // Her branÅŸ iÃ§in etiket sayÄ±larÄ±nÄ± hesapla
            const branchStats = {};
            branches.forEach(branch => {
                branchStats[branch.id] = {
                    name: branch.name,
                    icon: branch.icon,
                    ageGroups: {
                        child: {},
                        adult: {}
                    }
                };
                
                // Her etiket iÃ§in sayaÃ§larÄ± baÅŸlat
                tagsList.forEach(tag => {
                    branchStats[branch.id].ageGroups.child[tag] = 0;
                    branchStats[branch.id].ageGroups.adult[tag] = 0;
                });
            });
            
            // CRM leads Ã¼zerinden etiket sayÄ±larÄ±nÄ± hesapla
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        if (branchStats[br.branchId]) {
                            if (br.ageGroup === 'adult' && br.selectedTag) {
                                branchStats[br.branchId].ageGroups.adult[br.selectedTag] = 
                                    (branchStats[br.branchId].ageGroups.adult[br.selectedTag] || 0) + 1;
                            }
                            
                            if (br.ageGroup === 'child' && br.children) {
                                br.children.forEach(child => {
                                    if (child.selectedTag) {
                                        branchStats[br.branchId].ageGroups.child[child.selectedTag] = 
                                            (branchStats[br.branchId].ageGroups.child[child.selectedTag] || 0) + 1;
                                    }
                                });
                            }
                        }
                    });
                }
            });
            
            // Modern gÃ¶rÃ¼nÃ¼m ile render et
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';
            
            branches.forEach(branch => {
                const stats = branchStats[branch.id];
                
                html += `
                    <div style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 15px 0; font-size: 18px; color: #333;">${branch.icon} ${branch.name}</h4>
                        
                        <!-- Ã‡ocuk Grubu -->
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 12px;">
                            <div style="font-weight: 600; color: #667eea; margin-bottom: 10px; font-size: 14px;">ğŸ‘¶ Ã‡ocuk</div>
                            <div style="display: flex; flex-direction: column; gap: 6px;">
                `;
                
                // AranmadÄ± her zaman en Ã¼stte
                const childAranmadiCount = stats.ageGroups.child['AranmadÄ±'] || 0;
                if (childAranmadiCount > 0) {
                    html += `
                        <div onclick="filterByBranchAndTag('${branch.id}', 'child', 'AranmadÄ±')" style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: #fff3cd; border-radius: 6px; border-left: 3px solid #ffc107; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#ffe4a3'" onmouseout="this.style.background='#fff3cd'">
                            <span style="font-size: 13px; color: #555; font-weight: 600;">AranmadÄ±</span>
                            <span style="font-weight: 700; color: #ff9800; font-size: 14px;">${childAranmadiCount}</span>
                        </div>
                    `;
                }
                
                // DiÄŸer etiketler
                tagsList.forEach(tag => {
                    if (tag === 'AranmadÄ±') return; // AranmadÄ±'yÄ± atla, zaten Ã¼stte gÃ¶sterildi
                    const count = stats.ageGroups.child[tag] || 0;
                    if (count > 0) {
                        html += `
                            <div onclick="filterByBranchAndTag('${branch.id}', 'child', '${tag}')" style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: #f8f9fa; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                <span style="font-size: 13px; color: #555;">${tag}</span>
                                <span style="font-weight: 700; color: #667eea; font-size: 14px;">${count}</span>
                            </div>
                        `;
                    }
                });
                
                html += `
                            </div>
                        </div>
                        
                        <!-- YetiÅŸkin Grubu -->
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-weight: 600; color: #f093fb; margin-bottom: 10px; font-size: 14px;">ğŸ‘¨ YetiÅŸkin</div>
                            <div style="display: flex; flex-direction: column; gap: 6px;">
                `;
                
                // AranmadÄ± her zaman en Ã¼stte
                const adultAranmadiCount = stats.ageGroups.adult['AranmadÄ±'] || 0;
                if (adultAranmadiCount > 0) {
                    html += `
                        <div onclick="filterByBranchAndTag('${branch.id}', 'adult', 'AranmadÄ±')" style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: #fff3cd; border-radius: 6px; border-left: 3px solid #ffc107; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#ffe4a3'" onmouseout="this.style.background='#fff3cd'">
                            <span style="font-size: 13px; color: #555; font-weight: 600;">AranmadÄ±</span>
                            <span style="font-weight: 700; color: #ff9800; font-size: 14px;">${adultAranmadiCount}</span>
                        </div>
                    `;
                }
                
                // DiÄŸer etiketler
                tagsList.forEach(tag => {
                    if (tag === 'AranmadÄ±') return; // AranmadÄ±'yÄ± atla, zaten Ã¼stte gÃ¶sterildi
                    const count = stats.ageGroups.adult[tag] || 0;
                    if (count > 0) {
                        html += `
                            <div onclick="filterByBranchAndTag('${branch.id}', 'adult', '${tag}')" style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: #f8f9fa; border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                <span style="font-size: 13px; color: #555;">${tag}</span>
                                <span style="font-weight: 700; color: #f093fb; font-size: 14px;">${count}</span>
                            </div>
                        `;
                    }
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            statsContainer.innerHTML = html;
            
            // CRM branÅŸ filtresi dropdown'unu gÃ¼ncelle
            const crmBranchFilter = document.getElementById('crm-branch-filter');
            if (crmBranchFilter) {
                const currentValue = crmBranchFilter.value;
                crmBranchFilter.innerHTML = '<option value="all">TÃ¼m BranÅŸlar</option>' + 
                    branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
                if (currentValue) crmBranchFilter.value = currentValue;
            }
        }
        
        // Backward compatibility - renderCRMStats artÄ±k renderBranchTagStats'Ä± Ã§aÄŸÄ±racak
        function renderCRMStats() {
            renderBranchTagStats();
            // Ä°statistik gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ kontrol et
            checkBranchStatsVisibility();
        }
        
        // Ä°statistikleri gizle/gÃ¶ster fonksiyonu
        window.toggleBranchStats = function() {
            const statsContainer = document.getElementById('branch-tag-stats');
            const toggleBtn = document.getElementById('toggle-branch-stats-btn');
            if (!statsContainer || !toggleBtn) return;
            
            const isHidden = statsContainer.style.display === 'none';
            
            if (isHidden) {
                // GÃ¶ster
                statsContainer.style.display = 'grid';
                toggleBtn.innerHTML = 'ğŸ‘ï¸';
                toggleBtn.title = 'Ä°statistikleri Gizle/GÃ¶ster';
                localStorage.setItem('branchStatsHidden', 'false');
            } else {
                // Gizle
                statsContainer.style.display = 'none';
                toggleBtn.innerHTML = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
                toggleBtn.title = 'Ä°statistikleri GÃ¶ster';
                localStorage.setItem('branchStatsHidden', 'true');
            }
        };
        
        // Sayfa yÃ¼klendiÄŸinde istatistik gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ kontrol et
        function checkBranchStatsVisibility() {
            const statsContainer = document.getElementById('branch-tag-stats');
            const toggleBtn = document.getElementById('toggle-branch-stats-btn');
            if (!statsContainer || !toggleBtn) return;
            
            const isHidden = localStorage.getItem('branchStatsHidden') === 'true';
            
            if (isHidden) {
                statsContainer.style.display = 'none';
                toggleBtn.innerHTML = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
                toggleBtn.title = 'Ä°statistikleri GÃ¶ster';
            } else {
                statsContainer.style.display = 'grid';
                toggleBtn.innerHTML = 'ğŸ‘ï¸';
                toggleBtn.title = 'Ä°statistikleri Gizle/GÃ¶ster';
            }
        }
        
        // Dashboard istatistiklerini gizle/gÃ¶ster fonksiyonu
        window.toggleDashboardStats = function() {
            const statsContainer = document.getElementById('dashboard-stats-grid');
            const toggleBtn = document.getElementById('toggle-dashboard-stats-btn');
            if (!statsContainer || !toggleBtn) return;
            
            const isHidden = statsContainer.style.display === 'none';
            
            if (isHidden) {
                // GÃ¶ster
                statsContainer.style.display = 'grid';
                toggleBtn.innerHTML = 'ğŸ‘ï¸';
                toggleBtn.title = 'Ä°statistikleri Gizle/GÃ¶ster';
                localStorage.setItem('dashboardStatsHidden', 'false');
            } else {
                // Gizle
                statsContainer.style.display = 'none';
                toggleBtn.innerHTML = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
                toggleBtn.title = 'Ä°statistikleri GÃ¶ster';
                localStorage.setItem('dashboardStatsHidden', 'true');
            }
        };
        
        // Sayfa yÃ¼klendiÄŸinde dashboard istatistik gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ kontrol et
        function checkDashboardStatsVisibility() {
            const statsContainer = document.getElementById('dashboard-stats-grid');
            const toggleBtn = document.getElementById('toggle-dashboard-stats-btn');
            if (!statsContainer || !toggleBtn) return;
            
            const isHidden = localStorage.getItem('dashboardStatsHidden') === 'true';
            
            if (isHidden) {
                statsContainer.style.display = 'none';
                toggleBtn.innerHTML = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
                toggleBtn.title = 'Ä°statistikleri GÃ¶ster';
            } else {
                statsContainer.style.display = 'grid';
                toggleBtn.innerHTML = 'ğŸ‘ï¸';
                toggleBtn.title = 'Ä°statistikleri Gizle/GÃ¶ster';
            }
        }
        
        // Dashboard ana sayfa istatistiklerini gizle/gÃ¶ster fonksiyonu
        let dashboardAmountsHidden = false;
        
        window.toggleDashboardAmounts = function() {
            dashboardAmountsHidden = !dashboardAmountsHidden;
            const toggleBtn = document.getElementById('toggle-dashboard-amounts-btn');
            
            if (dashboardAmountsHidden) {
                // Gizle
                toggleBtn.innerHTML = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
                toggleBtn.title = 'TutarlarÄ± GÃ¶ster';
                localStorage.setItem('dashboardAmountsHidden', 'true');
            } else {
                // GÃ¶ster
                toggleBtn.innerHTML = 'ğŸ‘ï¸';
                toggleBtn.title = 'TutarlarÄ± Gizle/GÃ¶ster';
                localStorage.setItem('dashboardAmountsHidden', 'false');
            }
            
            // TutarlarÄ± gÃ¼ncelle
            applyDashboardAmountsVisibility();
        };
        
        // Dashboard tutarlarÄ±na maskeleme uygula
        function applyDashboardAmountsVisibility() {
            const statNumbers = document.querySelectorAll('#dashboard .stat-number');
            statNumbers.forEach(el => {
                // Orijinal deÄŸeri sakla
                if (el.dataset.originalValue === undefined) {
                    el.dataset.originalValue = el.textContent;
                }
                
                if (dashboardAmountsHidden) {
                    // Gizle - Sadece sayÄ±larÄ± iÃ§eriyorsa maskele
                    if (el.dataset.originalValue.match(/\d/)) {
                        const currencyMatch = el.dataset.originalValue.match(/[â‚º$â‚¬]/);
                        el.textContent = '****' + (currencyMatch ? currencyMatch[0] : '');
                    }
                } else {
                    // GÃ¶ster - Orijinal deÄŸeri geri yÃ¼kle
                    el.textContent = el.dataset.originalValue;
                }
            });
        }
        
        // Sayfa yÃ¼klendiÄŸinde dashboard tutar gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ kontrol et
        function checkDashboardAmountsVisibility() {
            const toggleBtn = document.getElementById('toggle-dashboard-amounts-btn');
            if (!toggleBtn) return;
            
            const isHidden = localStorage.getItem('dashboardAmountsHidden') === 'true';
            dashboardAmountsHidden = isHidden;
            
            if (isHidden) {
                toggleBtn.innerHTML = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
                toggleBtn.title = 'TutarlarÄ± GÃ¶ster';
                applyDashboardAmountsVisibility();
            } else {
                toggleBtn.innerHTML = 'ğŸ‘ï¸';
                toggleBtn.title = 'TutarlarÄ± Gizle/GÃ¶ster';
            }
        }
        
        // Ã–deme tutarlarÄ±nÄ± gizle/gÃ¶ster fonksiyonu
        let paymentAmountsHidden = false;
        
        window.togglePaymentVisibility = function() {
            paymentAmountsHidden = !paymentAmountsHidden;
            const toggleBtn = document.getElementById('toggle-payment-visibility-btn');
            
            if (paymentAmountsHidden) {
                // Gizle
                toggleBtn.innerHTML = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
                toggleBtn.title = 'TutarlarÄ± GÃ¶ster';
                localStorage.setItem('paymentAmountsHidden', 'true');
            } else {
                // GÃ¶ster
                toggleBtn.innerHTML = 'ğŸ‘ï¸';
                toggleBtn.title = 'TutarlarÄ± Gizle/GÃ¶ster';
                localStorage.setItem('paymentAmountsHidden', 'false');
            }
            
            // TutarlarÄ± gÃ¼ncelle
            applyPaymentVisibility();
        };
        
        // Ã–deme tutarlarÄ±na maskeleme uygula
        function applyPaymentVisibility() {
            // Ä°statistik kartlarÄ±ndaki tutarlarÄ± maskele/gÃ¶ster
            const statNumbers = document.querySelectorAll('#payments .stat-number');
            statNumbers.forEach(el => {
                // Orijinal deÄŸeri sakla
                if (el.dataset.originalValue === undefined) {
                    el.dataset.originalValue = el.textContent;
                }
                
                if (paymentAmountsHidden) {
                    // Gizle - Sadece sayÄ±larÄ± iÃ§eriyorsa maskele
                    if (el.dataset.originalValue.match(/\d/)) {
                        const currencyMatch = el.dataset.originalValue.match(/[â‚º$â‚¬]/);
                        el.textContent = '****' + (currencyMatch ? currencyMatch[0] : '');
                    }
                } else {
                    // GÃ¶ster - Orijinal deÄŸeri geri yÃ¼kle
                    el.textContent = el.dataset.originalValue;
                }
            });
            
            // Tablodaki tÃ¼m tutarlarÄ± bul ve maskele/gÃ¶ster
            const paymentElements = document.querySelectorAll('#member-payment-list [style*="font-weight: bold"]');
            paymentElements.forEach(el => {
                const text = el.textContent.trim();
                // Sadece TL iÃ§eren elementleri iÅŸle
                if (text.includes('â‚º') || text.includes('TL')) {
                    // Orijinal deÄŸeri sakla
                    if (el.dataset.originalValue === undefined) {
                        el.dataset.originalValue = el.textContent;
                    }
                    
                    if (paymentAmountsHidden) {
                        // Gizle
                        if (el.dataset.originalValue.match(/\d/)) {
                            el.textContent = '****â‚º';
                        }
                    } else {
                        // GÃ¶ster - Orijinal deÄŸeri geri yÃ¼kle
                        el.textContent = el.dataset.originalValue;
                    }
                }
            });
        }
        
        // Sayfa yÃ¼klendiÄŸinde Ã¶deme gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ kontrol et
        function checkPaymentVisibility() {
            const toggleBtn = document.getElementById('toggle-payment-visibility-btn');
            if (!toggleBtn) return;
            
            const isHidden = localStorage.getItem('paymentAmountsHidden') === 'true';
            paymentAmountsHidden = isHidden;
            
            if (isHidden) {
                toggleBtn.innerHTML = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
                toggleBtn.title = 'TutarlarÄ± GÃ¶ster';
            } else {
                toggleBtn.innerHTML = 'ğŸ‘ï¸';
                toggleBtn.title = 'TutarlarÄ± Gizle/GÃ¶ster';
            }
        }
        
        // BranÅŸ ve etikete gÃ¶re filtreleme yap
        window.filterByBranchAndTag = function(branchId, ageGroup, tag) {
            // CRM filtre sayfasÄ±na git
            showSection('crm-filter');
            
            // Filtre deÄŸerlerini ayarla
            setTimeout(() => {
                const branchFilter = document.getElementById('filter-branch');
                const ageGroupFilter = document.getElementById('filter-age-group');
                const tagFilter = document.getElementById('filter-tag');
                
                if (branchFilter) branchFilter.value = branchId;
                if (ageGroupFilter) ageGroupFilter.value = ageGroup;
                if (tagFilter) tagFilter.value = tag;
                
                // Filtrelemeyi Ã§alÄ±ÅŸtÄ±r
                applyCustomerFilters();
            }, 100);
        };
        
        // Panoya kopyala fonksiyonu
        window.copyToClipboard = function(text, message = 'KopyalandÄ±!') {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showAlert(message, 'success');
                }).catch(err => {
                    console.error('Kopyalama hatasÄ±:', err);
                    fallbackCopyToClipboard(text, message);
                });
            } else {
                fallbackCopyToClipboard(text, message);
            }
        };
        
        // Eski tarayÄ±cÄ±lar iÃ§in alternatif kopyalama
        function fallbackCopyToClipboard(text, message) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showAlert(message, 'success');
            } catch (err) {
                console.error('Kopyalama hatasÄ±:', err);
                showAlert('Kopyalama baÅŸarÄ±sÄ±z oldu', 'error');
            }
            document.body.removeChild(textArea);
        }
        
        function renderRecentAbsences() {
            const container = document.getElementById('recent-absences-list');
            if (!container) return;
            
            // âœ… Veriler henÃ¼z yÃ¼klenmediyse bekle
            if (!attendanceRecords || attendanceRecords.length === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">DevamsÄ±zlÄ±k verileri yÃ¼kleniyor...</p></div>';
                return;
            }
            
            // SeÃ§ili gÃ¼n sayÄ±sÄ±nÄ± al
            const periodSelect = document.getElementById('absence-period-filter');
            const dayCount = periodSelect ? parseInt(periodSelect.value) : 30;
            
            // Son X gÃ¼nÃ¼n devamsÄ±zlÄ±klarÄ±nÄ± al - basitÃ§e filter ve sort
            const targetDate = new Date();
            targetDate.setDate(targetDate.getDate() - dayCount);
            targetDate.setHours(0, 0, 0, 0);
            
            const recentAbsences = attendanceRecords
                .filter(rec => {
                    if (rec.status !== 'absent') return false;
                    if (!rec.date) return false;
                    const recordDate = new Date(rec.date);
                    recordDate.setHours(0, 0, 0, 0);
                    return recordDate >= targetDate;
                })
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 20);
            
            if (recentAbsences.length === 0) {
                container.innerHTML = `<div class="empty-state"><p style="padding: 20px; color: #999;">Son ${dayCount} gÃ¼nde devamsÄ±zlÄ±k yok âœ…</p></div>`;
                return;
            }
            
            container.innerHTML = recentAbsences.map(record => {
                const member = members.find(m => m.id === record.memberId);
                if (!member) return '';
                
                const memberName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad || 'Ä°simsiz';
                const dateStr = new Date(record.date).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
                const reason = record.reason || 'BelirtilmemiÅŸ';
                
                return `
                    <div style="padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border-left: 4px solid #f44336; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 13px; color: #333; margin-bottom: 2px;">${memberName}</div>
                                <div style="font-size: 11px; color: #666; margin-bottom: 4px;">
                                    <span style="background: #fff; padding: 2px 8px; border-radius: 4px; margin-right: 5px;">ğŸ“… ${dateStr}</span>
                                    ${member.Brans ? `<span style="background: #fff; padding: 2px 8px; border-radius: 4px;">${member.Brans}</span>` : ''}
                                </div>
                                <div style="font-size: 11px; color: #d32f2f; font-style: italic;">Sebep: ${reason}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Global olarak eriÅŸilebilir yap
        window.renderRecentAbsences = renderRecentAbsences;
        
        function renderTodayTrials() {
            // Son devamsÄ±zlÄ±klarÄ± render et
            renderRecentAbsences();
            
            const container = document.getElementById('today-trials-list');
            if (!container) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            let todayTrials = [];
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        if (br.ageGroup === 'adult' && br.denemeDate) {
                            const trialDate = new Date(br.denemeDate);
                            if (trialDate >= today && trialDate < tomorrow) {
                                todayTrials.push({ lead, branch: br, type: 'adult', date: trialDate });
                            }
                        }
                        if (br.ageGroup === 'child' && br.children) {
                            br.children.forEach(c => {
                                if (c.denemeDate) {
                                    const trialDate = new Date(c.denemeDate);
                                    if (trialDate >= today && trialDate < tomorrow) {
                                        todayTrials.push({ lead, branch: br, child: c, type: 'child', date: trialDate });
                                    }
                                }
                            });
                        }
                    });
                }
            });
            
            todayTrials.sort((a, b) => a.date - b.date);
            
            if (todayTrials.length === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">BugÃ¼n deneme dersi yok</p></div>';
                return;
            }
            
            container.innerHTML = todayTrials.map(trial => {
                const branch = branches.find(b => b.id === trial.branch.branchId);
                const timeStr = trial.date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                const name = trial.type === 'child' ? trial.child.name : trial.branch.fullName || trial.lead.fullName;
                const parentInfo = trial.type === 'child' ? `<div style="font-size: 11px; color: #888;">Veli: ${trial.branch.parentName || '-'}</div>` : '';
                
                // âœ… BranÅŸa gÃ¶re renk paleti
                const branchColors = {
                    'tenis': { bg: 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)', border: '#4caf50', text: '#2e7d32', icon: 'ğŸ¾' },
                    'yuzme': { bg: 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)', border: '#2196f3', text: '#1565c0', icon: 'ğŸŠ' },
                    'default': { bg: 'linear-gradient(135deg, #fff9e6 0%, #fff3cc 100%)', border: '#ffc107', text: '#ff9800', icon: 'ğŸ¯' }
                };
                
                const branchStyle = branchColors[branch?.id] || branchColors['default'];
                
                return `
                    <div style="padding: 15px; margin-bottom: 10px; background: ${branchStyle.bg}; border-left: 4px solid ${branchStyle.border}; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onclick="openCustomerDetail('${trial.lead.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 14px; color: #333; margin-bottom: 4px;">${name}</div>
                                ${parentInfo}
                                <div style="font-size: 12px; color: #666;">ğŸ“ <a href="#" class="phone-link" onclick="event.stopPropagation(); handlePhoneClick(event, '${trial.lead.phone}')">${trial.lead.phone}</a></div>
                                <div style="font-size: 12px; color: ${branchStyle.text}; margin-top: 4px; font-weight: 600;">${branch ? branch.icon + ' ' + branch.name : 'BranÅŸ'}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 18px; font-weight: 700; color: ${branchStyle.text};">${timeStr}</div>
                                <div style="font-size: 11px; color: #888;">${branchStyle.icon} Deneme</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderUpcomingRegistrations() {
            const container = document.getElementById('upcoming-registrations-list');
            if (!container) return;
            
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);
            
            let upcomingRegs = [];
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        if (br.selectedTag === 'KayÄ±t Olabilir' && br.kayitOlabilirDate) {
                            const regDate = new Date(br.kayitOlabilirDate);
                            if (regDate >= today && regDate <= nextWeek) {
                                upcomingRegs.push({ lead, branch: br, type: 'adult', date: regDate });
                            }
                        }
                        if (br.ageGroup === 'child' && br.children) {
                            br.children.forEach(c => {
                                if (c.selectedTag === 'KayÄ±t Olabilir' && c.kayitOlabilirDate) {
                                    const regDate = new Date(c.kayitOlabilirDate);
                                    if (regDate >= today && regDate <= nextWeek) {
                                        upcomingRegs.push({ lead, branch: br, child: c, type: 'child', date: regDate });
                                    }
                                }
                            });
                        }
                    });
                }
            });
            
            upcomingRegs.sort((a, b) => a.date - b.date);
            
            if (upcomingRegs.length === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">YaklaÅŸan kayÄ±t olabilir yok</p></div>';
                return;
            }
            
            container.innerHTML = upcomingRegs.map(reg => {
                const branch = branches.find(b => b.id === reg.branch.branchId);
                const dateStr = reg.date.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' });
                const name = reg.type === 'child' ? reg.child.name : reg.branch.fullName || reg.lead.fullName;
                const parentInfo = reg.type === 'child' ? `<div style="font-size: 11px; color: #888;">Veli: ${reg.branch.parentName || '-'}</div>` : '';
                
                // âœ… BranÅŸa gÃ¶re renk paleti  
                const branchColors = {
                    'tenis': { bg: 'linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%)', border: '#9c27b0', text: '#6a1b9a', icon: 'ğŸ¾' },
                    'yuzme': { bg: 'linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%)', border: '#00acc1', text: '#00838f', icon: 'ğŸŠ' },
                    'default': { bg: 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)', border: '#4caf50', text: '#2e7d32', icon: 'ğŸ“' }
                };
                
                const branchStyle = branchColors[branch?.id] || branchColors['default'];
                
                return `
                    <div style="padding: 15px; margin-bottom: 10px; background: ${branchStyle.bg}; border-left: 4px solid ${branchStyle.border}; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onclick="openCustomerDetail('${reg.lead.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 14px; color: #333; margin-bottom: 4px;">${name}</div>
                                ${parentInfo}
                                <div style="font-size: 12px; color: #666;">ğŸ“ <a href="#" class="phone-link" onclick="event.stopPropagation(); handlePhoneClick(event, '${reg.lead.phone}')">${reg.lead.phone}</a></div>
                                <div style="font-size: 12px; color: ${branchStyle.text}; margin-top: 4px; font-weight: 600;">${branch ? branch.icon + ' ' + branch.name : 'BranÅŸ'}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 16px; font-weight: 700; color: ${branchStyle.text};">${dateStr}</div>
                                <div style="font-size: 11px; color: #888;">${branchStyle.icon} KayÄ±t</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // CevapsÄ±z Ã§aÄŸrÄ±larÄ± render et
        async function renderMissedCalls() {
            const container = document.getElementById('missed-calls-list');
            if (!container) return;
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>CevapsÄ±z Ã§aÄŸrÄ±lar yÃ¼kleniyor...</span></div>';
            
            let missedCalls = await fetchBulutfonMissedCalls();
            
            // âœ… CevaplandÄ± olarak iÅŸaretlenenleri filtrele
            const answeredCalls = JSON.parse(localStorage.getItem('answeredMissedCalls') || '[]');
            missedCalls = missedCalls.filter(call => {
                const caller = call.caller || '';
                // Telefon numarasÄ±nÄ± normalize et
                const cleanCaller = caller.replace(/\D/g, '');
                let formattedCaller = cleanCaller;
                if (cleanCaller.startsWith('90') && cleanCaller.length === 12) {
                    formattedCaller = '0' + cleanCaller.slice(2);
                } else if (!cleanCaller.startsWith('0') && cleanCaller.length === 10) {
                    formattedCaller = '0' + cleanCaller;
                }
                
                // CevaplandÄ± listesinde olup olmadÄ±ÄŸÄ±nÄ± kontrol et
                const isMarked = answeredCalls.some(item => {
                    // Eski format desteÄŸi (string)
                    if (typeof item === 'string') {
                        return item === formattedCaller;
                    }
                    // Yeni format (object)
                    return item.phone === formattedCaller;
                });
                
                // âœ… "DiÄŸer"e atÄ±lmÄ±ÅŸsa FAKAT son arama "diÄŸer"e atÄ±lma tarihinden SONRAYSA â†’ gÃ¶ster
                if (isMarked) {
                    const markedEntry = answeredCalls.find(item => {
                        if (typeof item === 'string') return item === formattedCaller;
                        return item.phone === formattedCaller;
                    });
                    
                    // Tarih kontrolÃ¼ - eÄŸer bu arama "diÄŸer"e atÄ±lma tarihinden sonraysa gÃ¶ster
                    if (typeof markedEntry === 'object' && markedEntry.markedDate) {
                        const markedDate = new Date(markedEntry.markedDate);
                        const callDate = new Date(call.call_time);
                        
                        if (callDate > markedDate) {
                            return true; // GÃ¶ster - yeni arama
                        }
                    }
                    
                    return false; // GÃ¶sterme - "diÄŸer"e atÄ±lmÄ±ÅŸ
                }
                
                return true; // GÃ¶ster - hiÃ§ iÅŸaretlenmemiÅŸ
            });
            
            // Silinenleri filtrele (showDeletedCalls false ise)
            if (!showDeletedCalls) {
                missedCalls = missedCalls.filter(call => !isCallDeleted(call.caller, 'incoming', call.call_time));
            }
            
            if (!missedCalls || missedCalls.length === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">CevapsÄ±z Ã§aÄŸrÄ± yok</p></div>';
                return;
            }
            
            container.innerHTML = missedCalls.map(call => {
                const caller = call.caller || 'Bilinmeyen';
                const formattedCaller = formatPhoneDisplay(caller);
                const callee = call.callee || 'Bilinmeyen';
                const formattedCallee = formatPhoneDisplay(callee);
                // Bulutfon API UTC formatÄ±nda veriyor, 3 saat Ã§Ä±karmalÄ±yÄ±z
                const callTime = new Date(call.lastCall.call_time);
                callTime.setHours(callTime.getHours() - 3); // UTC'den TÃ¼rkiye saatine Ã§evir
                const timeStr = callTime.toLocaleString('tr-TR', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit'
                });
                
                // DÃ¶nÃ¼ÅŸ yapÄ±lmama sÃ¼resi
                const minutesSince = call.minutesSinceMissed || 0;
                let timeSinceStr = '';
                if (minutesSince < 60) {
                    timeSinceStr = `${minutesSince} dakika Ã¶nce`;
                } else if (minutesSince < 1440) {
                    timeSinceStr = `${Math.floor(minutesSince / 60)} saat ${minutesSince % 60} dakika Ã¶nce`;
                } else {
                    timeSinceStr = `${Math.floor(minutesSince / 1440)} gÃ¼n Ã¶nce`;
                }
                
                // KaÃ§ kere aradÄ±
                const callCount = call.callCount || 1;
                const callCountStr = callCount > 1 ? `<div style="font-size: 12px; color: #d32f2f; font-weight: 600; margin-top: 4px;">ğŸ” ${callCount} kere aradÄ±</div>` : '';
                
                // TÃ¼m arama tarihlerini listele (en fazla 5 tane)
                let allCallTimesStr = '';
                if (call.allCallTimes && call.allCallTimes.length > 1) {
                    const times = call.allCallTimes.slice(0, 5).map((t, idx) => {
                        const time = new Date(t);
                        time.setHours(time.getHours() - 3); // UTC'den TÃ¼rkiye saatine Ã§evir
                        const today = new Date();
                        const isToday = time.getDate() === today.getDate() && 
                                       time.getMonth() === today.getMonth() && 
                                       time.getFullYear() === today.getFullYear();
                        
                        if (isToday) {
                            return `${idx + 1}. BugÃ¼n ${time.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}`;
                        } else {
                            return `${idx + 1}. ${time.toLocaleDateString('tr-TR', { day: '2-digit', month: 'short' })} ${time.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}`;
                        }
                    });
                    allCallTimesStr = `<div style="font-size: 10px; color: #666; margin-top: 6px; background: rgba(0,0,0,0.05); padding: 6px; border-radius: 4px;">ğŸ“… ${times.join(' â€¢ ')}</div>`;
                }
                
                // CRM'de veya Ã¼yelerde var mÄ± kontrol et - GÃœÃ‡LENDÄ°RÄ°LMÄ°Å EÅLEÅTME
                const leadMatch = crmLeads.find(l => phonesMatch(l.phone, caller));
                const memberMatch = members.find(m => phonesMatch(m.Telefon, caller) || phonesMatch(m.Telefon_2, caller));
                
                let personInfo = '';
                let clickAction = '';
                let actionButtons = '';
                let backgroundColor = '#fff3e0'; // Default: cevapsÄ±z Ã§aÄŸrÄ± rengi
                let borderColor = '#ff9800';
                
                // Ä°kili durum: Hem CRM'de hem cevapsÄ±z Ã§aÄŸrÄ±
                const isInCRM = !!leadMatch;
                const isMissedCall = true; // Bu zaten cevapsÄ±z Ã§aÄŸrÄ±lar sayfasÄ±
                
                // Ä°kili renk sistemi
                if (isInCRM && isMissedCall) {
                    // Gradient: yarÄ± CRM (mavi), yarÄ± cevapsÄ±z (turuncu)
                    backgroundColor = 'linear-gradient(90deg, #e3f2fd 0%, #e3f2fd 50%, #fff3e0 50%, #fff3e0 100%)';
                    borderColor = '#ff9800';
                }
                
                if (leadMatch) {
                    personInfo = `<div style="font-weight: 600; color: #1976d2; margin-bottom: 4px;">ğŸ‘¤ ${leadMatch.fullName} <span style="background: #4caf50; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">CRM'de</span> <span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">CevapsÄ±z</span></div>`;
                    clickAction = `onclick="openCustomerDetail('${leadMatch.id}')"`;
                    actionButtons = `
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1);">
                            <div class="dropdown" style="display: inline-block; position: relative; z-index: 1000;">
                                <button class="btn btn-sm btn-primary dropdown-toggle" type="button" onclick="event.stopPropagation();" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="font-size: 11px; padding: 4px 8px;">
                                    âš¡ Ä°ÅŸlemler
                            </button>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); openCustomerDetail('${leadMatch.id}');">ğŸ“‹ GÃ¶rÃ¼ntÃ¼le</a>
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); updateCRMFromMissedCall('${leadMatch.id}');">âœï¸ GÃ¼ncelle</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); markAsUnreachableWithMessage('${caller}', '${timeStr}');">ğŸš« UlaÅŸÄ±lamadÄ± + Mesaj</a>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (memberMatch) {
                    const memberName = memberMatch.Resit_Olmayan_Adi_Soyadi || memberMatch.Ad_Soyad;
                    personInfo = `<div style="font-weight: 600; color: #388e3c; margin-bottom: 4px;">âœ… Ãœye: ${memberName}</div>`;
                    clickAction = `onclick="showMemberAttendancePage('${memberMatch.id}')"`;
                    actionButtons = `
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1);">
                            <div class="dropdown" style="display: inline-block; position: relative; z-index: 1000;">
                                <button class="btn btn-sm btn-success dropdown-toggle" type="button" onclick="event.stopPropagation();" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="font-size: 11px; padding: 4px 8px;">
                                    âš¡ Ä°ÅŸlemler
                            </button>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); showMemberAttendancePage('${memberMatch.id}');">ğŸ“‹ Ãœye Bilgileri</a>
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); sendMissedCallMessage('${memberMatch.Telefon || caller}', '${memberName}');">ğŸ’¬ Mesaj GÃ¶nder</a>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Sistemde yok - CRM'e ekle, UlaÅŸÄ±lamadÄ± ve Manuel CevaplandÄ± butonlarÄ±
                    actionButtons = `
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1);">
                            <div class="dropdown" style="display: inline-block; position: relative; z-index: 1000;">
                                <button class="btn btn-sm btn-primary dropdown-toggle" type="button" onclick="event.stopPropagation();" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="font-size: 11px; padding: 4px 8px;">
                                    âš¡ Ä°ÅŸlemler
                            </button>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); addToCRMFromMissedCall('${caller}');">â• CRM'e Ekle</a>
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); markMissedCallAsAnswered('${caller}', '${timeStr}');">âœ… CevaplandÄ±</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); markAsUnreachableWithMessage('${caller}', '${timeStr}');">ğŸš« UlaÅŸÄ±lamadÄ± + Mesaj</a>
                                    <a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); sendMissedCallMessage('${caller}', '${timeStr}');">ğŸ’¬ Mesaj GÃ¶nder</a>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div style="position: relative; padding: 12px; margin-bottom: 10px; background: ${backgroundColor}; border-left: 4px solid ${borderColor}; border-radius: 6px; cursor: ${clickAction ? 'pointer' : 'default'};" ${clickAction} onmouseover="this.style.zIndex='100';" onmouseout="this.style.zIndex='1';">
                        ${personInfo}
                        <div style="font-size: 13px; color: #666;">ğŸ“ Arayan: ${formattedCaller}</div>
                        <div style="font-size: 12px; color: #888; margin-top: 2px;">ğŸ“± Aranan: ${formattedCallee}</div>
                        ${callCountStr}
                        <div style="font-size: 11px; color: #999; margin-top: 4px;">ğŸ• Son arama: ${timeStr}</div>
                        ${allCallTimesStr}
                        <div style="font-size: 11px; color: #ff5722; margin-top: 4px; font-weight: 600;">â° DÃ¶nÃ¼ÅŸ yapÄ±lmadÄ±: ${timeSinceStr}</div>
                        ${!personInfo ? '<div style="font-size: 11px; color: #d32f2f; margin-top: 4px;">âš ï¸ CRM\'de kayÄ±tlÄ± deÄŸil</div>' : ''}
                        ${actionButtons}
                    </div>
                `;
            }).join('');
        }
        
        // Bulutfon'dan cevapsÄ±z Ã§aÄŸrÄ±larÄ± Ã§ek
        async function fetchBulutfonMissedCalls() {
            if (!clubSettings || !clubSettings.bulutfonEnabled || !clubSettings.bulutfonApiKey) {
                console.log('âš ï¸ Bulutfon entegrasyonu aktif deÄŸil');
                return [];
            }
            
            try {
                console.log('ğŸ“ CevapsÄ±z Ã§aÄŸrÄ±lar yÃ¼kleniyor...');
                
                const response = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${clubSettings.bulutfonApiKey}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    console.error('âŒ Bulutfon API hatasÄ±:', response.status);
                    return [];
                }
                
                const data = await response.json();
                const allRecords = Array.isArray(data) ? data : (data.cdrs || data.data || []);
                
                if (allRecords.length === 0) {
                    return [];
                }
                
                // âœ… CevapsÄ±z Ã§aÄŸrÄ±larÄ± filtrele (is_missing_call kullan - API dokÃ¼mantasyonuna gÃ¶re)
                let missedCalls = allRecords.filter(record => {
                    if (record.direction !== 'IN') return false;
                    
                    // API'den gelen is_missing_call parametresini kullan
                    // is_missing_call: true â†’ KaÃ§an/cevapsÄ±z Ã§aÄŸrÄ±
                    // is_missing_call: false â†’ Cevaplanan Ã§aÄŸrÄ±
                    if (record.is_missing_call !== undefined && record.is_missing_call !== null) {
                        // Boolean veya string olabilir ("true"/"false")
                        const isMissing = record.is_missing_call === true || record.is_missing_call === "true" || record.is_missing_call === 1;
                        return isMissing;
                    }
                    
                    // Fallback: is_missing_call yoksa hangup_cause kontrol et
                    // API dokÃ¼mantasyonuna gÃ¶re: ANSWERED = CevaplandÄ±
                    const hangupCause = (record.hangup_cause || '').toUpperCase();
                    const isAnswered = hangupCause === 'ANSWERED';
                    
                    return !isAnswered; // CevapsÄ±z olanlarÄ± al
                });
                
                // Son 72 saat iÃ§indeki Ã§aÄŸrÄ±larÄ± al
                const threeDaysAgo = new Date();
                threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
                missedCalls = missedCalls.filter(record => {
                    const callTime = new Date(record.call_time);
                    return callTime >= threeDaysAgo;
                });
                
                // AynÄ± numaradan gelen tÃ¼m cevapsÄ±z Ã§aÄŸrÄ±larÄ± grupla
                const callsByNumber = {};
                
                for (const missedCall of missedCalls) {
                    const caller = missedCall.caller?.replace(/\D/g, '');
                    if (!caller) continue;
                    
                    if (!callsByNumber[caller]) {
                        callsByNumber[caller] = [];
                    }
                    callsByNumber[caller].push(missedCall);
                }
                
                // Her numara iÃ§in sonraki gelen veya giden aramayÄ± kontrol et
                const filteredMissedCalls = [];
                
                for (const [caller, calls] of Object.entries(callsByNumber)) {
                    // En son arama zamanÄ±nÄ± al (UTC olarak)
                    const lastCallTime = new Date(Math.max(...calls.map(c => new Date(c.call_time))));
                    
                    // Debug iÃ§in Ã¶zel numara kontrolÃ¼
                    const isDebugNumber = caller.includes('5321646303');
                    if (isDebugNumber) {
                        console.log(`ğŸ” DEBUG - ${caller} iÃ§in kontrol baÅŸlÄ±yor:`, {
                            missedCallsCount: calls.length,
                            lastCallTime: lastCallTime.toISOString()
                        });
                    }
                    
                    // Bu numaradan sonraki aramalar var mÄ± kontrol et (is_missing_call veya hangup_cause kullan)
                    const hasFollowUp = allRecords.some(record => {
                        const recordTime = new Date(record.call_time);
                        const recordCaller = (record.caller || '').replace(/\D/g, '');
                        const recordCallee = (record.callee || '').replace(/\D/g, '');
                        
                        // AynÄ± numara ve en son cevapsÄ±z Ã§aÄŸrÄ±dan sonra (UTC bazÄ±nda karÅŸÄ±laÅŸtÄ±r)
                        if (recordTime > lastCallTime) {
                            const sameNumber = (recordCaller === caller) || (recordCallee === caller);
                            
                            // Cevaplanan arama mÄ± kontrol et
                            let wasAnswered = false;
                            
                            // 1. Ã–nce is_missing_call kontrol et
                            if (record.is_missing_call !== undefined && record.is_missing_call !== null) {
                                const isMissing = record.is_missing_call === true || record.is_missing_call === "true" || record.is_missing_call === 1;
                                wasAnswered = !isMissing; // is_missing_call false ise cevaplandÄ± demektir
                            } 
                            // 2. is_missing_call yoksa hangup_cause kontrol et
                            else {
                                const hangupCause = (record.hangup_cause || '').toUpperCase();
                                wasAnswered = hangupCause === 'ANSWERED';
                            }
                            
                            // Debug log
                            if (isDebugNumber && sameNumber) {
                                console.log(`  âœ“ Sonraki arama bulundu: time=${recordTime.toISOString()}, direction=${record.direction}, is_missing_call=${record.is_missing_call}, wasAnswered=${wasAnswered}`);
                            }
                            
                            return sameNumber && wasAnswered;
                        }
                        return false;
                    });
                    
                    // Debug log
                    if (isDebugNumber) {
                        console.log(`  â†’ hasFollowUp: ${hasFollowUp} (true ise listeden Ã§Ä±kar, false ise listede kalÄ±r)`);
                    }
                    
                    // EÄŸer sonrasÄ±nda cevaplanan bir arama yoksa listeye ekle
                    if (!hasFollowUp) {
                        // TÃ¼m aramalarÄ± tarihe gÃ¶re sÄ±rala
                        calls.sort((a, b) => new Date(b.call_time) - new Date(a.call_time));
                        
                        // Åu ana kadar geÃ§en sÃ¼reyi hesapla (en son aramadan)
                        // Bulutfon UTC veriyor, 3 saat Ã§Ä±karmalÄ±yÄ±z
                        const now = new Date();
                        const adjustedLastCallTime = new Date(lastCallTime);
                        adjustedLastCallTime.setHours(adjustedLastCallTime.getHours() - 3);
                        const timeDiff = Math.floor((now - adjustedLastCallTime) / 1000 / 60); // dakika
                        
                        // Ä°lk (en son) aramayÄ± al ve ek bilgiler ekle
                        const mainCall = calls[0];
                        mainCall.minutesSinceMissed = timeDiff;
                        mainCall.callCount = calls.length; // KaÃ§ kere aradÄ±
                        mainCall.allCallTimes = calls.map(c => c.call_time); // TÃ¼m arama zamanlarÄ±
                        
                        filteredMissedCalls.push(mainCall);
                    }
                }
                
                // En yeniden eskiye sÄ±rala
                filteredMissedCalls.sort((a, b) => new Date(b.call_time) - new Date(a.call_time));
                
                console.log(`ğŸ“µ ${filteredMissedCalls.length} cevapsÄ±z Ã§aÄŸrÄ± bulundu (is_missing_call ve hangup_cause kontrolleri yapÄ±ldÄ±)`);
                
                // Debug: TÃ¼m kayÄ±tlarÄ±n detaylÄ± kontrolÃ¼
                if (allRecords.length > 0) {
                    const incomingCalls = allRecords.filter(r => r.direction === 'IN');
                    console.log(`ğŸ” Toplam ${allRecords.length} kayÄ±t, ${incomingCalls.length} tanesi gelen arama (IN)`);
                    
                    const answeredCalls = incomingCalls.filter(r => 
                        (r.is_missing_call === false || r.is_missing_call === "false" || r.is_missing_call === 0) ||
                        (r.hangup_cause && r.hangup_cause.toUpperCase() === 'ANSWERED')
                    );
                    const missedCallsDebug = incomingCalls.filter(r => 
                        (r.is_missing_call === true || r.is_missing_call === "true" || r.is_missing_call === 1)
                    );
                    
                    console.log(`ğŸ“Š Gelen aramalardan: ${answeredCalls.length} cevaplanan, ${missedCallsDebug.length} cevapsÄ±z`);
                    
                    // Ä°lk 5 gelen aramayÄ± detaylÄ± gÃ¶ster
                    console.log('ğŸ” Ä°lk 5 gelen arama detayÄ±:');
                    incomingCalls.slice(0, 5).forEach((record, idx) => {
                        console.log(`  ${idx + 1}. is_missing_call: ${record.is_missing_call}, hangup_cause: ${record.hangup_cause}, caller: ${record.caller}, call_time: ${record.call_time}`);
                    });
                    
                    // EÄŸer cevaplanan arama varsa, ilkini gÃ¶ster
                    if (answeredCalls.length > 0) {
                        console.log('âœ… Ã–rnek cevaplanan arama:', answeredCalls[0]);
                    }
                    
                    // DEBUG: Belirli numaralarÄ±n tÃ¼m aramalarÄ±nÄ± gÃ¶ster
                    const debugNumbers = ['905321646303', '5321646303']; // 0532 164 63 03
                    debugNumbers.forEach(debugNum => {
                        const debugCalls = allRecords.filter(r => {
                            const caller = (r.caller || '').replace(/\D/g, '');
                            const callee = (r.callee || '').replace(/\D/g, '');
                            return caller.includes(debugNum) || callee.includes(debugNum) || 
                                   caller === debugNum || callee === debugNum;
                        });
                        if (debugCalls.length > 0) {
                            console.log(`ğŸ” Debug: ${debugNum} numaralÄ± tÃ¼m aramalar (${debugCalls.length} adet):`);
                            debugCalls.forEach((call, idx) => {
                                console.log(`  ${idx + 1}. direction: ${call.direction}, is_missing_call: ${call.is_missing_call}, hangup_cause: ${call.hangup_cause}, call_time: ${call.call_time}`);
                            });
                        }
                    });
                }
                
                return filteredMissedCalls.slice(0, 20); // En fazla 20 tane gÃ¶ster
                
            } catch (error) {
                console.error('âŒ CevapsÄ±z Ã§aÄŸrÄ±lar alÄ±nÄ±rken hata:', error);
                return [];
            }
        }
        
        // CevapsÄ±z Ã§aÄŸrÄ±larÄ± yenile (dashboard iÃ§in)
        window.refreshMissedCalls = async function() {
            await renderMissedCalls();
        };
        
        // CRM ana sayfa: CevapsÄ±z Ã§aÄŸrÄ±larÄ± minimal liste olarak gÃ¶ster (sadece telefon numarasÄ±)
        window.renderMissedCalls = async function() {
            const container = document.getElementById('missed-calls-list');
            if (!container) return;
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>CevapsÄ±z Ã§aÄŸrÄ±lar yÃ¼kleniyor...</span></div>';

            const missedCalls = await fetchBulutfonMissedCalls();
            if (!missedCalls || missedCalls.length === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">ğŸ“µ Son 72 saatte cevapsÄ±z Ã§aÄŸrÄ± yok</p></div>';
                return;
            }

            container.innerHTML = missedCalls.map(call => {
                const caller = call.caller || 'Bilinmeyen';
                // Sadece numara gÃ¶ster (formatlanmadan, daha temiz gÃ¶rÃ¼nÃ¼m iÃ§in)
                const displayNumber = caller.replace(/\D/g, '');
                const formattedNumber = displayNumber.startsWith('90') && displayNumber.length === 12 
                    ? '0' + displayNumber.substring(2) 
                    : displayNumber;
                
                return `
                    <div style="padding: 10px 12px; margin-bottom: 8px; background: #fff8e1; border-left: 4px solid #ffa726; border-radius: 6px; cursor: pointer; font-family: monospace; font-size: 14px;" 
                         onclick="showIncomingCallsForNumber('${formattedNumber}')" 
                         title="TÄ±klayarak bu numaranÄ±n tÃ¼m gelen aramalarÄ±nÄ± gÃ¶rÃ¼n">
                        ğŸ“ ${formattedNumber}
                        ${call.callCount > 1 ? `<span style="background: #ff6b6b; color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; margin-left: 8px;">${call.callCount}x</span>` : ''}
                    </div>
                `;
            }).join('');
        };
        
        // Belirli bir numaraya ait gelen aramalarÄ± gÃ¶ster
        window.showIncomingCallsForNumber = function(phoneNumber) {
            // Gelen aramalar sayfasÄ±na git
            showSection('crm-incoming-calls', document.querySelector('.nav-btn[onclick*=\'crm-incoming-calls\']'));
            
            // KÄ±sa bir gecikme sonra filtreyi uygula
            setTimeout(() => {
                // Telefon filtre inputunu bul ve numara ile doldur
                const phoneFilterInput = document.getElementById('incomingPhoneFilter');
                if (phoneFilterInput) {
                    phoneFilterInput.value = phoneNumber;
                    // Filtreyi tetikle
                    filterIncomingCalls();
                }
            }, 300);
        };
        
        // CevapsÄ±z Ã§aÄŸrÄ±lar sayfasÄ±nÄ± yenile (artÄ±k gelen aramalara yÃ¶nlendiriyor)
        window.refreshMissedCallsPage = async function() {
            await renderIncomingCallsPage();
        };
        
        // CRM ana sayfa - cevapsÄ±z Ã§aÄŸrÄ±larÄ± yenile
        window.refreshMissedCalls = async function() {
            await renderMissedCalls();
        };
        
        // Gelen aramalar sayfasÄ±nÄ± render et
        window.renderIncomingCallsPage = async function() {
            const container = document.getElementById('incoming-calls-list');
            if (!container) return;
            
            // SeÃ§imleri temizle
            selectedIncomingCalls.clear();
            const selectAllCheckbox = document.getElementById('selectAllIncoming');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Gelen aramalar yÃ¼kleniyor...</span></div>';
            
            // Bulutfon kontrolÃ¼ - API Key'e gÃ¶re kontrol et
            if (!clubSettings || !clubSettings.bulutfonApiKey) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <h3 style="color: #856404; margin-bottom: 15px;">ğŸ“ Bulutfon Entegrasyonu Gerekli</h3>
                        <p style="color: #666; margin-bottom: 20px;">
                            Gelen aramalarÄ± gÃ¶rÃ¼ntÃ¼lemek iÃ§in Bulutfon API entegrasyonunu aktif etmeniz gerekiyor.
                        </p>
                        <button class="btn btn-primary" onclick="showSection('settings', document.querySelector('.nav-btn[onclick*=\\'settings\\']')); setTimeout(() => switchSettingsTab('general'), 500);">
                            âš™ï¸ Ayarlara Git
                        </button>
                    </div>
                `;
                return;
            }
            
            console.log('ğŸ“ Bulutfon API Key mevcut, aramalar yÃ¼kleniyor...');
            
            try {
                const response = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${clubSettings.bulutfonApiKey}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const allRecords = Array.isArray(data) ? data : (data.cdrs || data.data || []);
                
                // Gelen aramalarÄ± filtrele (direction: 'IN')
                let incomingCalls = allRecords.filter(record => record.direction === 'IN');
                
                // âœ… WhatsApp gelen Ã§aÄŸrÄ±larÄ±nÄ± da ekle (Index olmadan da Ã§alÄ±ÅŸsÄ±n)
                try {
                    const whatsappCallsRef = window.firebase.collection(window.db, 'whatsappIncomingCalls');
                    
                    // Ã–nce index'li sorguyu dene
                    let whatsappSnapshot;
                    try {
                        const whatsappQuery = window.firebase.query(
                            whatsappCallsRef,
                            window.firebase.where('clubId', '==', currentClubId),
                            window.firebase.orderBy('callTime', 'desc'),
                            window.firebase.limit(100)
                        );
                        whatsappSnapshot = await window.firebase.getDocs(whatsappQuery);
                        console.log(`ğŸ“± ${whatsappSnapshot.docs.length} WhatsApp Ã§aÄŸrÄ±sÄ± bulundu (index'li sorgu)`);
                    } catch (indexError) {
                        // Index yoksa sadece clubId ile filtrele
                        console.log('âš ï¸ WhatsApp index yok, basit sorgu deneniyor...');
                        const simpleQuery = window.firebase.query(
                            whatsappCallsRef,
                            window.firebase.where('clubId', '==', currentClubId)
                        );
                        whatsappSnapshot = await window.firebase.getDocs(simpleQuery);
                        console.log(`ğŸ“± ${whatsappSnapshot.docs.length} WhatsApp Ã§aÄŸrÄ±sÄ± bulundu (basit sorgu)`);
                    }
                    
                    whatsappSnapshot.docs.forEach(doc => {
                        const whatsappCall = doc.data();
                        // Bulutfon formatÄ±na Ã§evir
                        incomingCalls.push({
                            caller: whatsappCall.from || whatsappCall.caller,
                            callee: whatsappCall.to || whatsappCall.callee,
                            call_time: whatsappCall.timestamp || whatsappCall.call_time,
                            direction: 'IN',
                            is_missing_call: whatsappCall.is_missing_call !== false,
                            hangup_cause: whatsappCall.is_missing_call === false ? 'ANSWERED' : 'NO_ANSWER',
                            isWhatsApp: true, // âœ… WhatsApp bayraÄŸÄ±
                            instanceName: whatsappCall.instanceName || 'WhatsApp'
                        });
                    });
                } catch (whatsappError) {
                    console.error('âš ï¸ WhatsApp Ã§aÄŸrÄ±larÄ± yÃ¼klenirken hata:', whatsappError);
                    console.error('Hata detayÄ±:', whatsappError.message);
                    // Hata olsa da devam et (Bulutfon aramalarÄ± gÃ¶sterilir)
                }
                
                // Son 1 hafta iÃ§indeki Ã§aÄŸrÄ±larÄ± al
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                incomingCalls = incomingCalls.filter(record => {
                    const callTime = new Date(record.call_time);
                    return callTime >= oneWeekAgo;
                });
                
                // âœ… NOT: Silinen Ã§aÄŸrÄ±larÄ± burada FÄ°LTRELEME - gruplama sonrasÄ± yapÄ±lacak
                // Ã‡Ã¼nkÃ¼ aynÄ± numaranÄ±n birden fazla Ã§aÄŸrÄ±sÄ± olabilir ve sadece en son Ã§aÄŸrÄ± silinmiÅŸse
                // diÄŸer Ã§aÄŸrÄ±larÄ± da gÃ¶rmemiz gerekiyor (gruplama iÃ§in)
                
                // âœ… Ä°lk aramada tÃ¼m alanlarÄ± gÃ¶relim
                if (incomingCalls.length > 0) {
                    console.log('ğŸ“‹ Bulutfon Call Sample:', incomingCalls[0]);
                }
                
                // âœ… AKILLI GRUPLAMA: AynÄ± numaralarÄ± birleÅŸtir ve son duruma gÃ¶re kategorize et
                
                // 1. TÃ¼m giden aramalarÄ± da al (durum kontrolÃ¼ iÃ§in)
                const outgoingCalls = allRecords.filter(record => record.direction === 'OUT');
                
                // 2. Numaraya gÃ¶re grupla
                const groupedByNumber = {};
                
                incomingCalls.forEach(call => {
                    const cleanNumber = call.caller?.replace(/\D/g, '') || 'unknown';
                    const last10Digits = cleanNumber.slice(-10);
                    
                    if (!groupedByNumber[last10Digits]) {
                        groupedByNumber[last10Digits] = {
                            number: call.caller,
                            incomingCalls: [],
                            outgoingCalls: []
                        };
                    }
                    
                    groupedByNumber[last10Digits].incomingCalls.push(call);
                });
                
                // 3. Her numara iÃ§in giden aramalarÄ± da bul
                Object.keys(groupedByNumber).forEach(number => {
                    const group = groupedByNumber[number];
                    
                    group.outgoingCalls = outgoingCalls.filter(call => {
                        const cleanCallee = call.callee?.replace(/\D/g, '') || '';
                        return cleanCallee.endsWith(number) || number.endsWith(cleanCallee.slice(-10));
                    });
                });
                
                // 4. Her numara iÃ§in durum analizi yap
                const analyzedCalls = Object.values(groupedByNumber).map(group => {
                    // TÃ¼m aramalarÄ± birleÅŸtir ve tarihlerine gÃ¶re sÄ±rala
                    const allCallsFromNumber = [
                        ...group.incomingCalls.map(c => ({ ...c, type: 'incoming' })),
                        ...group.outgoingCalls.map(c => ({ ...c, type: 'outgoing' }))
                    ].sort((a, b) => new Date(b.call_time) - new Date(a.call_time));
                    
                    // En son Ã§aÄŸrÄ±yÄ± bul
                    const lastCall = allCallsFromNumber[0];
                    
                    // CevapsÄ±z gelen aramalarÄ± filtrele
                    const missedIncoming = group.incomingCalls.filter(call => {
                        if (call.is_missing_call !== undefined && call.is_missing_call !== null) {
                            return call.is_missing_call === true || call.is_missing_call === "true" || call.is_missing_call === 1;
                        }
                        const hangupCause = (call.hangup_cause || '').toUpperCase();
                        return hangupCause !== 'ANSWERED';
                    });
                    
                    // Cevaplanan gelen aramalarÄ± filtrele
                    const answeredIncoming = group.incomingCalls.filter(call => {
                        if (call.is_missing_call !== undefined && call.is_missing_call !== null) {
                            return !(call.is_missing_call === true || call.is_missing_call === "true" || call.is_missing_call === 1);
                        }
                        const hangupCause = (call.hangup_cause || '').toUpperCase();
                        return hangupCause === 'ANSWERED';
                    });
                    
                    // Durum analizi
                    let status = 'unanswered'; // VarsayÄ±lan: cevapsÄ±z
                    let callbackMade = false;
                    let callbackButStillUnanswered = false; // Yeni flag: geri aradÄ±k ama cevapsÄ±z kaldÄ±
                    
                    // En son arama giden aramaysa
                    if (lastCall.type === 'outgoing') {
                        // âœ… GÄ°DEN ARAMALAR iÃ§in answer_time kontrolÃ¼ (daha gÃ¼venilir)
                        let isAnsweredOutgoing = false;
                        
                        if (lastCall.answer_time !== undefined) {
                            // answer_time varsa ve null/boÅŸ deÄŸilse â†’ CevaplanmÄ±ÅŸ
                            isAnsweredOutgoing = lastCall.answer_time && lastCall.answer_time !== null && lastCall.answer_time !== '';
                        } else if (lastCall.hangup_cause) {
                            // Fallback: hangup_cause kontrolÃ¼
                        const hangupCause = (lastCall.hangup_cause || '').toUpperCase();
                            isAnsweredOutgoing = hangupCause === 'ANSWERED';
                        } else if (lastCall.talking_seconds !== undefined) {
                            // Son fallback: talking_seconds
                            const talkingSeconds = parseInt(lastCall.talking_seconds) || 0;
                            isAnsweredOutgoing = talkingSeconds > 0;
                        }
                        
                        if (isAnsweredOutgoing) {
                            // En son giden aramada gÃ¶rÃ¼ÅŸÃ¼ldÃ¼
                            status = 'answered_outgoing';
                            callbackMade = true;
                        } else if (missedIncoming.length > 0) {
                            // âœ… CevapsÄ±z gelen arama var ama geri dÃ¶nÃ¼ÅŸ yapÄ±lmÄ±ÅŸ (cevapsÄ±z kalmÄ±ÅŸ)
                            // Hala cevapsÄ±z kategorisinde kalacak ama flag set edilecek
                            status = 'unanswered';
                            callbackButStillUnanswered = true;
                            callbackMade = true;
                        }
                    } 
                    // En son arama gelen aramaysa
                    else {
                        // is_missing_call field'Ä± daha gÃ¼venilir (NORMAL_CLEARING hem cevaplÄ± hem cevapsÄ±z iÃ§in kullanÄ±labiliyor)
                        if (lastCall.is_missing_call !== undefined && lastCall.is_missing_call !== null) {
                            const isMissed = lastCall.is_missing_call === true || lastCall.is_missing_call === "true" || lastCall.is_missing_call === 1;
                            status = isMissed ? 'unanswered' : 'answered';
                        } else {
                            // is_missing_call yoksa hangup_cause'a bak
                            const hangupCause = (lastCall.hangup_cause || '').toUpperCase();
                            status = (hangupCause === 'ANSWERED') ? 'answered' : 'unanswered';
                        }
                    }
                    
                    // CevapsÄ±z arama saatlerini topla
                    const missedCallTimes = missedIncoming.map(call => {
                        const time = new Date(call.call_time);
                        time.setHours(time.getHours() - 3); // UTC'den TÃ¼rkiye'ye
                        return time.toLocaleString('tr-TR', { 
                            day: '2-digit', 
                            month: '2-digit',
                            hour: '2-digit', 
                            minute: '2-digit'
                        });
                    });
                    
                    return {
                        number: group.number,
                        lastCall: lastCall,
                        status: status,
                        callbackMade: callbackMade,
                        callbackButStillUnanswered: callbackButStillUnanswered, // âœ… Yeni flag
                        totalIncomingCalls: group.incomingCalls.length,
                        totalOutgoingCalls: group.outgoingCalls.length,
                        missedCount: missedIncoming.length,
                        answeredCount: answeredIncoming.length,
                        missedCallTimes: missedCallTimes,
                        allCalls: allCallsFromNumber
                    };
                });
                
                // 5. Duruma gÃ¶re kategorize et
                let unansweredCalls = analyzedCalls.filter(c => c.status === 'unanswered' && !c.callbackButStillUnanswered); // Sadece tam cevapsÄ±z
                let callbackUnansweredCalls = analyzedCalls.filter(c => c.status === 'unanswered' && c.callbackButStillUnanswered); // DÃ¶nÃ¼ÅŸ yapÄ±ldÄ± ama cevapsÄ±z
                let answeredOutgoingCalls = analyzedCalls.filter(c => c.status === 'answered_outgoing');
                let answeredCalls = analyzedCalls.filter(c => c.status === 'answered');
                
                // âœ… "DiÄŸer" kategorisi: SADECE localStorage'da manuel iÅŸaretlenmiÅŸ aramalar
                // (WhatsApp, yÃ¼z yÃ¼ze, veya baÅŸka yolla cevaplanmÄ±ÅŸ olarak iÅŸaretlenenler)
                // âœ… CRM etiketiyle ilgisi YOK - sadece bir sekme
                // âœ… AMA SADECE EN SON ARAMA "DÄ°ÄER"E ATILMA TARÄ°HÄ°NDEN Ã–NCE Ä°SE
                const answeredMissedCallsList = JSON.parse(localStorage.getItem('answeredMissedCalls') || '[]');
                let otherCalls = analyzedCalls.filter(c => {
                    const cleanCaller = c.number?.replace(/\D/g, '') || '';
                    
                    // Telefon numarasÄ±nÄ± normalize et
                    let formattedCaller = cleanCaller;
                    if (cleanCaller.startsWith('90') && cleanCaller.length === 12) {
                        formattedCaller = '0' + cleanCaller.slice(2);
                    } else if (!cleanCaller.startsWith('0') && cleanCaller.length === 10) {
                        formattedCaller = '0' + cleanCaller;
                    }
                    
                    // localStorage'da manuel olarak iÅŸaretlenmiÅŸ mi kontrol et
                    const markedEntry = answeredMissedCallsList.find(item => {
                        // Eski format desteÄŸi (string array)
                        if (typeof item === 'string') {
                            return item === formattedCaller;
                        }
                        // Yeni format (object with phone and date)
                        return item.phone === formattedCaller;
                    });
                    
                    if (!markedEntry) {
                        return false; // "DiÄŸer"e atÄ±lmamÄ±ÅŸ
                    }
                    
                    // âœ… TARÄ°H KONTROLÃœ: EÄŸer en son arama "diÄŸer"e atÄ±lma tarihinden SONRA ise
                    // "DiÄŸer"e ATMA, ilgili kategorisinde (cevapsÄ±z/cevaplanan vb.) kalsÄ±n
                    if (typeof markedEntry === 'object' && markedEntry.markedDate) {
                        const markedDate = new Date(markedEntry.markedDate);
                        const lastCallDate = new Date(c.lastCall.call_time);
                        
                        // âœ… DEBUG LOG
                        console.log(`ğŸ” Tarih KarÅŸÄ±laÅŸtÄ±rma - ${c.number}:`, {
                            'lastCall.call_time (RAW)': c.lastCall.call_time,
                            'lastCallDate': lastCallDate.toISOString(),
                            'markedDate': markedDate.toISOString(),
                            'lastCallDate > markedDate': lastCallDate > markedDate,
                            'Fark (dakika)': Math.floor((lastCallDate - markedDate) / 60000)
                        });
                        
                        if (lastCallDate > markedDate) {
                            console.log(`ğŸ“ ${c.number} - Son arama "DiÄŸer"e atÄ±lma tarihinden SONRA â†’ Ä°lgili kategoride kalacak âœ…`);
                            return false; // "DiÄŸer"e ATMA
                        } else {
                            console.log(`ğŸ“ ${c.number} - Son arama "DiÄŸer"e atÄ±lma tarihinden Ã–NCE veya EÅÄ°T â†’ "DiÄŸer" sekmesinde kalacak`);
                        }
                    }
                    
                    // âœ… Hangi metodla cevaplandÄ±ÄŸÄ±nÄ± call objesine ekle
                    if (typeof markedEntry === 'object' && markedEntry.method) {
                        c.answeredMethod = markedEntry.method;
                    }
                    
                    return true; // "DiÄŸer" sekmesine ekle
                });
                
                // âœ… "DiÄŸer" kategorisindeki aramalarÄ± diÄŸer kategorilerden Ã§Ä±kar
                const otherNumbers = new Set(otherCalls.map(c => c.number));
                unansweredCalls = unansweredCalls.filter(c => !otherNumbers.has(c.number));
                callbackUnansweredCalls = callbackUnansweredCalls.filter(c => !otherNumbers.has(c.number));
                answeredOutgoingCalls = answeredOutgoingCalls.filter(c => !otherNumbers.has(c.number));
                answeredCalls = answeredCalls.filter(c => !otherNumbers.has(c.number));
                
                // âœ… Silinenleri filtrele (showDeletedCalls false ise) - EN SON Ã‡AÄRIYA gÃ¶re
                if (!showDeletedCalls) {
                    unansweredCalls = unansweredCalls.filter(c => !isCallDeleted(c.number, 'incoming', c.lastCall.call_time));
                    callbackUnansweredCalls = callbackUnansweredCalls.filter(c => !isCallDeleted(c.number, 'incoming', c.lastCall.call_time));
                    answeredOutgoingCalls = answeredOutgoingCalls.filter(c => !isCallDeleted(c.number, 'incoming', c.lastCall.call_time));
                    answeredCalls = answeredCalls.filter(c => !isCallDeleted(c.number, 'incoming', c.lastCall.call_time));
                    otherCalls = otherCalls.filter(c => !isCallDeleted(c.number, 'incoming', c.lastCall.call_time));
                }
                
                // âœ… Gizlenenleri filtrele (hiddenCalls)
                if (hiddenCalls && hiddenCalls.length > 0) {
                    const isCallHidden = (number) => {
                        const cleanNumber = number?.replace(/\D/g, '') || '';
                        return hiddenCalls.some(hidden => {
                            const cleanHidden = hidden?.replace(/\D/g, '') || '';
                            return cleanNumber.endsWith(cleanHidden.slice(-10)) || cleanHidden.endsWith(cleanNumber.slice(-10));
                        });
                    };
                    
                    unansweredCalls = unansweredCalls.filter(c => !isCallHidden(c.number));
                    callbackUnansweredCalls = callbackUnansweredCalls.filter(c => !isCallHidden(c.number));
                    answeredOutgoingCalls = answeredOutgoingCalls.filter(c => !isCallHidden(c.number));
                    answeredCalls = answeredCalls.filter(c => !isCallHidden(c.number));
                    otherCalls = otherCalls.filter(c => !isCallHidden(c.number));
                    console.log(`ğŸ” ${hiddenCalls.length} gizli arama filtrelendi`);
                }
                
                // SÄ±rala (en yeni en Ã¼stte)
                unansweredCalls.sort((a, b) => new Date(b.lastCall.call_time) - new Date(a.lastCall.call_time));
                callbackUnansweredCalls.sort((a, b) => new Date(b.lastCall.call_time) - new Date(a.lastCall.call_time));
                answeredOutgoingCalls.sort((a, b) => new Date(b.lastCall.call_time) - new Date(a.lastCall.call_time));
                answeredCalls.sort((a, b) => new Date(b.lastCall.call_time) - new Date(a.lastCall.call_time));
                otherCalls.sort((a, b) => new Date(b.lastCall.call_time) - new Date(a.lastCall.call_time));
                
                // Global deÄŸiÅŸkende sakla (sekmeler iÃ§in)
                window.incomingCallsCategories = {
                    unanswered: unansweredCalls, // Sadece tam cevapsÄ±z
                    'callback-unanswered': callbackUnansweredCalls, // DÃ¶nÃ¼ÅŸ yapÄ±ldÄ± ama cevapsÄ±z
                    callback: answeredOutgoingCalls, // Giden aramada cevaplanmÄ±ÅŸ
                    answered: answeredCalls, // Cevaplanan aramalar
                    other: otherCalls // WhatsApp, YÃ¼z YÃ¼ze veya DiÄŸer yolla cevaplananlar
                };
                
                // SayÄ±larÄ± gÃ¼ncelle
                document.getElementById('count-unanswered').textContent = unansweredCalls.length;
                document.getElementById('count-callback-unanswered').textContent = callbackUnansweredCalls.length;
                document.getElementById('count-callback').textContent = answeredOutgoingCalls.length;
                document.getElementById('count-answered').textContent = answeredCalls.length;
                document.getElementById('count-other').textContent = otherCalls.length;
                
                // Toplam cevapsÄ±z sayÄ±sÄ±nÄ± gÃ¼ncelle (bildirim iÃ§in) - SADECE tam cevapsÄ±z
                window.totalUnansweredCount = unansweredCalls.length + callbackUnansweredCalls.length;
                
                // âœ… Ä°lk yÃ¼kleme ise, bildirim sayacÄ±nÄ± gÃ¼ncelle ve eÄŸer cevapsÄ±z varsa bildirim gÃ¶ster
                if (lastMissedCallsCount === -1) {
                    lastMissedCallsCount = 0; // Ä°lk kontrolde 0'dan baÅŸlayalÄ±m
                    console.log(`ğŸ“Š Ä°lk yÃ¼kleme: Toplam cevapsÄ±z sayÄ±sÄ± ${window.totalUnansweredCount} olarak tespit edildi`);
                    
                    // âœ… Ä°lk yÃ¼klemede cevapsÄ±z Ã§aÄŸrÄ± varsa bildirim gÃ¶ster
                    if (window.totalUnansweredCount > 0) {
                        console.log(`ğŸ”” Ä°lk yÃ¼kleme bildirimi: ${window.totalUnansweredCount} cevapsÄ±z Ã§aÄŸrÄ± mevcut`);
                        await showMissedCallNotification(window.totalUnansweredCount);
                    }
                    
                    lastMissedCallsCount = window.totalUnansweredCount;
                }
                
                if (incomingCalls.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p style="padding: 40px; color: #999;">ğŸ“‹ Son 72 saatte gelen arama yok</p></div>';
                return;
            }
            
                // Ä°lk sekmeyi gÃ¶ster (cevapsÄ±z)
                switchIncomingCallTab('unanswered');
                
                // Toplu silme butonunu gÃ¼ncelle
                updateBulkDeleteButton('incoming');
            } catch (error) {
                console.error('Gelen aramalar yÃ¼klenirken hata:', error);
                container.innerHTML = '<div class="empty-state"><p style="padding: 40px; color: #f44336;">âŒ Gelen aramalar yÃ¼klenirken bir hata oluÅŸtu</p></div>';
            }
        }
        
        // Sekme deÄŸiÅŸtir
        window.switchIncomingCallTab = function(tabName) {
            const container = document.getElementById('incoming-calls-list');
            if (!container || !window.incomingCallsCategories) return;
            
            // Sekme stillerini gÃ¼ncelle
            const tabs = ['unanswered', 'callback-unanswered', 'callback', 'answered', 'other'];
            tabs.forEach(tab => {
                const tabBtn = document.getElementById(`tab-${tab}`);
                if (tabBtn) {
                    if (tab === tabName) {
                        // Aktif sekme
                        let bgColor = '#ffebee';
                        let color = '#f44336';
                        let borderColor = '#f44336';
                        
                        if (tab === 'callback-unanswered') {
                            bgColor = '#fff3e0';
                            color = '#ff9800';
                            borderColor = '#ff9800';
                        } else if (tab === 'callback') {
                            bgColor = '#e3f2fd';
                            color = '#2196f3';
                            borderColor = '#2196f3';
                        } else if (tab === 'answered') {
                            bgColor = '#e8f5e9';
                            color = '#4caf50';
                            borderColor = '#4caf50';
                        } else if (tab === 'other') {
                            bgColor = '#f3e5f5';
                            color = '#9c27b0';
                            borderColor = '#9c27b0';
                        }
                        
                        tabBtn.style.background = bgColor;
                        tabBtn.style.color = color;
                        tabBtn.style.borderBottom = `3px solid ${borderColor}`;
                    } else {
                        // Pasif sekme
                        tabBtn.style.background = '#fff';
                        tabBtn.style.color = '#666';
                        tabBtn.style.borderBottom = '3px solid transparent';
                    }
                }
            });
            
            // Ä°Ã§eriÄŸi render et
            const calls = window.incomingCallsCategories[tabName] || [];
            
            if (calls.length === 0) {
                let emptyMessage = 'ğŸ“‹ Bu kategoride arama yok';
                if (tabName === 'unanswered') {
                    emptyMessage = 'âœ… Harika! CevapsÄ±z Ã§aÄŸrÄ±nÄ±z yok.';
                } else if (tabName === 'callback-unanswered') {
                    emptyMessage = 'ğŸ“‹ DÃ¶nÃ¼ÅŸ yapÄ±ldÄ± ama cevapsÄ±z Ã§aÄŸrÄ± yok';
                } else if (tabName === 'callback') {
                    emptyMessage = 'ğŸ“‹ Giden aramada cevaplanmÄ±ÅŸ Ã§aÄŸrÄ± yok';
                } else if (tabName === 'answered') {
                    emptyMessage = 'ğŸ“‹ Gelen aramada cevaplanmÄ±ÅŸ Ã§aÄŸrÄ± yok';
                } else if (tabName === 'other') {
                    emptyMessage = 'ğŸ“‹ WhatsApp, YÃ¼z YÃ¼ze veya DiÄŸer yolla cevaplanan Ã§aÄŸrÄ± yok';
                }
                container.innerHTML = `<div class="empty-state"><p style="padding: 40px; color: #999;">${emptyMessage}</p></div>`;
                return;
            }
            
            // Limitleme
            const displayCalls = calls.slice(0, 50);
            
            // Ã‡aÄŸrÄ± tipine gÃ¶re render et
            let callType = 'normal';
            let isMissed = false;
            
            if (tabName === 'unanswered') {
                callType = 'normal';
                isMissed = true;
            } else if (tabName === 'callback-unanswered') {
                callType = 'callback-unanswered';
                isMissed = true;
            } else if (tabName === 'callback') {
                callType = 'callback';
            } else if (tabName === 'other') {
                callType = 'other';
                isMissed = false;
            } else if (tabName === 'answered') {
                callType = 'answered';
                isMissed = false;
            }
            
            const callsHtml = displayCalls.map(call => renderIncomingCall(call, isMissed, callType)).join('');
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; padding: 15px;">
                    ${callsHtml}
                </div>
                ${calls.length > 50 ? `<p style="text-align: center; color: #666; padding: 15px;">Ä°lk 50 arama gÃ¶steriliyor (Toplam: ${calls.length})</p>` : ''}
            `;
        };
        
        // Gelen arama kartÄ±nÄ± render et
        function renderIncomingCall(call, isMissed, callType = 'normal') {
            try {
                        const caller = call.number || call.caller || 'Bilinmeyen';
                        const formattedCaller = formatPhoneDisplay(caller);
                        
                        // âœ… ARANAN = Her zaman ÅŸirket numarasÄ±
                        // EÄŸer lastCall bir giden arama ise (type='outgoing'), caller=ÅŸirket
                        // EÄŸer lastCall bir gelen arama ise (type='incoming'), callee=ÅŸirket
                        let callee;
                        if (call.lastCall?.type === 'outgoing') {
                            // Giden aramada: caller = ÅŸirket
                            callee = call.lastCall.caller || 'Bilinmeyen';
                        } else {
                            // Gelen aramada: callee = ÅŸirket
                            callee = call.lastCall?.callee || call.callee || 'Bilinmeyen';
                        }
                        const formattedCallee = formatPhoneDisplay(callee);
                        const callTime = new Date(call.lastCall.call_time);
                        callTime.setHours(callTime.getHours() - 3); // UTC'den TÃ¼rkiye saatine Ã§evir
                        const timeStr = callTime.toLocaleString('tr-TR', { 
                            day: '2-digit', 
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit', 
                            minute: '2-digit'
                        });
                        
                            // Duration bilgisini lastCall'dan al
                            const talkingSeconds = call.lastCall.talking_seconds || call.lastCall.duration || 0;
                            const durationStr = talkingSeconds > 0 ? `${Math.floor(talkingSeconds / 60)}:${String(talkingSeconds % 60).padStart(2, '0')} dk` : '0 sn';
                            
                            // âœ… is_missing_call kullan (API dokÃ¼mantasyonuna gÃ¶re) - lastCall'dan al
                            let wasAnswered = false;
                            let isMissed = false;
                            
                            // Ã–nce is_missing_call kontrol et (lastCall'dan)
                            if (call.lastCall.is_missing_call !== undefined && call.lastCall.is_missing_call !== null) {
                                const isMissingCall = call.lastCall.is_missing_call === true || call.lastCall.is_missing_call === "true" || call.lastCall.is_missing_call === 1;
                                isMissed = isMissingCall;
                                wasAnswered = !isMissingCall;
                            } 
                            // Fallback: is_missing_call yoksa hangup_cause kontrol et (lastCall'dan)
                            else {
                                const hangupCause = (call.lastCall.hangup_cause || '').toUpperCase();
                                wasAnswered = hangupCause === 'ANSWERED';
                                isMissed = !wasAnswered;
                            }
                            // âœ… Durum bilgileri - callType ve callbackButStillUnanswered durumuna gÃ¶re ayarla
                            let statusIcon = 'âœ…';
                            let statusText = 'CevaplandÄ±';
                            let statusColor = '#4caf50';
                            
                            // callType'a gÃ¶re durum belirleme
                            if (callType === 'callback-unanswered') {
                                // DÃ¶nÃ¼ÅŸ yapÄ±ldÄ± ama cevapsÄ±z (sadece badge gÃ¶sterilecek, status gÃ¶sterilmeyecek)
                                statusIcon = '';
                                statusText = '';
                                statusColor = '#ff9800';
                            } else if (callType === 'callback') {
                                // Giden aramada cevaplanmÄ±ÅŸ (cevapsÄ±z badge'i gÃ¶sterilmeyecek)
                                statusIcon = 'âœ…';
                                statusText = 'CevaplandÄ±';
                                statusColor = '#4caf50';
                            } else if (callType === 'answered') {
                                // Cevaplanan aramalar
                                statusIcon = 'âœ…';
                                statusText = 'CevaplandÄ±';
                                statusColor = '#4caf50';
                            } else if (callType === 'other') {
                                // DiÄŸer yolla cevaplananlar (WhatsApp, YÃ¼z YÃ¼ze, DiÄŸer)
                                statusIcon = 'ğŸ“‹';
                                // âœ… Hangi metodla cevaplandÄ±ysa onu gÃ¶ster
                                statusText = call.answeredMethod || 'DiÄŸer Yolla CevaplandÄ±';
                                statusColor = '#9c27b0';
                            } else if (callType === 'normal' && isMissed) {
                                // Tam cevapsÄ±z
                                statusIcon = 'âŒ';
                                statusText = 'CevapsÄ±z';
                                statusColor = '#f44336';
                            } else {
                                // DiÄŸer durumlar (fallback)
                                statusIcon = wasAnswered ? 'âœ…' : 'âŒ';
                                statusText = wasAnswered ? 'CevaplandÄ±' : 'CevapsÄ±z';
                                statusColor = wasAnswered ? '#4caf50' : '#f44336';
                            }
                            
                            // CRM'de veya Ã¼yelerde var mÄ± kontrol et
                            const leadMatch = crmLeads.find(l => {
                                const cleanLead = l.phone?.replace(/\D/g, '');
                                const cleanCaller = caller.replace(/\D/g, '');
                                return cleanLead && cleanCaller && (
                                    cleanLead.endsWith(cleanCaller.slice(-10)) || 
                                    cleanCaller.endsWith(cleanLead.slice(-10))
                                );
                            });
                            
                            const memberMatch = members.find(m => {
                                const cleanMember = m.Telefon?.replace(/\D/g, '');
                                const cleanMember2 = m.Telefon_2?.replace(/\D/g, '');
                                const cleanCaller = caller.replace(/\D/g, '');
                                return cleanCaller && (
                                    (cleanMember && (cleanMember.endsWith(cleanCaller.slice(-10)) || cleanCaller.endsWith(cleanMember.slice(-10)))) ||
                                    (cleanMember2 && (cleanMember2.endsWith(cleanCaller.slice(-10)) || cleanCaller.endsWith(cleanMember2.slice(-10))))
                                );
                            });
                            
                            // âœ… UlaÅŸÄ±lamadÄ± kontrolÃ¼
                            const cleanCaller = caller.replace(/\D/g, '');
                            const unreachableCalls = JSON.parse(localStorage.getItem('unreachableCalls') || '{}');
                            const isUnreachable = Object.values(unreachableCalls).some(u => {
                                const cleanUnreachable = u.phone?.replace(/\D/g, '');
                                return cleanUnreachable && cleanCaller && (
                                    cleanUnreachable.endsWith(cleanCaller.slice(-10)) || 
                                    cleanCaller.endsWith(cleanUnreachable.slice(-10))
                                );
                            });
                            
                            let personInfo = '';
                            let actionButtons = '';
                            let bgColor = wasAnswered ? '#e8f5e9' : (isUnreachable ? '#fff3e0' : '#ffebee');
                            let borderColor = wasAnswered ? statusColor : (isUnreachable ? '#ff9800' : statusColor);
                            
                            // SilinmiÅŸ badge ekle
                            const callDeleted = isCallDeleted(caller, 'incoming', call.lastCall.call_time);
                            const deletedBadge = callDeleted ? `<span style="background: #9e9e9e; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">ğŸ—‘ï¸ Silindi</span>` : '';
                            
                            // âœ… WhatsApp badge ekle
                            const whatsappBadge = call.lastCall.isWhatsApp ? `<span style="background: #25D366; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">ğŸ“± WhatsApp</span>` : '';
                            
                            // âœ… Kategori badge'leri - callType'a gÃ¶re
                            let categoryBadge = '';
                            if (callType === 'callback-unanswered') {
                                // DÃ¶nÃ¼ÅŸ yapÄ±ldÄ± ama cevapsÄ±z kaldÄ± - sadece bu badge gÃ¶sterilecek
                                categoryBadge = `<span style="background: #ff9800; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">â†©ï¸ DÃ¶nÃ¼ÅŸ YapÄ±ldÄ± Ama CevapsÄ±z</span>`;
                            } else if (callType === 'callback') {
                                // Giden aramada cevaplanmÄ±ÅŸ
                                categoryBadge = `<span style="background: #2196f3; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">ğŸ“ Giden Aramada CevaplanmÄ±ÅŸ</span>`;
                            }
                            
                            // Arama sayÄ±sÄ± ve cevapsÄ±z saatler bilgisi
                            let callCountInfo = '';
                            if (call.missedCount > 0) {
                                callCountInfo = `
                                    <div style="font-size: 12px; color: #f44336; font-weight: 600; margin-top: 6px; padding: 8px; background: rgba(244, 67, 54, 0.1); border-radius: 4px;">
                                        ğŸ“µ ${call.missedCount} kere cevapsÄ±z aradÄ±
                                        ${call.missedCallTimes && call.missedCallTimes.length > 0 ? `
                                            <div style="font-size: 11px; color: #666; margin-top: 4px;">
                                                ğŸ• Saatler: ${call.missedCallTimes.join(', ')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `;
                            }
                            
                            // Toplam arama sayÄ±sÄ±
                            const totalCallsInfo = call.totalIncomingCalls > 1 ? 
                                `<span style="background: #9c27b0; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">ğŸ“ ${call.totalIncomingCalls} arama</span>` : '';
                            
                            if (leadMatch) {
                                personInfo = `<div style="font-weight: 600; font-size: 15px; color: #1976d2; margin-bottom: 6px;">ğŸ‘¤ ${leadMatch.fullName}${deletedBadge}</div>`;
                                
                                // Dropdown menÃ¼ oluÅŸtur
                                const dropdownId = `dropdown-${call.lastCall.call_time.replace(/[^0-9]/g, '')}`;
                                
                                // âœ… Gelen Aramalar Ä°Ã§in SadeleÅŸtirilmiÅŸ MenÃ¼: CevaplandÄ±, Mesaj GÃ¶nder, Sil
                                const menuTimeStr = new Date(call.lastCall.call_time).toLocaleString('tr-TR');
                                // âœ… Sadece cevapsÄ±z Ã§aÄŸrÄ±larda iÅŸlemler menÃ¼sÃ¼nÃ¼ gÃ¶ster (callback, answered, other'da gÃ¶sterme)
                                const showActionsMenu = isMissed && callType !== 'callback' && callType !== 'answered' && callType !== 'other';
                                const missedCallMenuItems = showActionsMenu ? `
                                    <button class="btn btn-sm btn-info" onclick="markMissedCallAsAnswered('${caller}', '${leadMatch.id}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left; margin-bottom: 5px;">
                                        âœ”ï¸ CevaplandÄ±
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="sendMissedCallMessage('${leadMatch.phone || caller}', '${leadMatch.fullName}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left; margin-bottom: 5px;">
                                        ğŸ’¬ Mesaj GÃ¶nder
                                    </button>
                                ` : '';
                                
                                actionButtons = `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; gap: 5px; align-items: center; flex-wrap: wrap;">
                                        <button class="btn btn-sm btn-primary" onclick="openCustomerDetail('${leadMatch.id}')">
                                            ğŸ“‹ GÃ¶rÃ¼ntÃ¼le
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="showCallRecordsModal('${caller}')" title="GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ±nÄ± gÃ¶rÃ¼ntÃ¼le">
                                            ğŸ“ GÃ¶rÃ¼ÅŸmeler
                                        </button>
                                        ${missedCallMenuItems ? `
                                        <div style="position: relative; display: inline-block; z-index: 10000;">
                                            <button class="btn btn-sm btn-secondary" onclick="toggleCallDropdown('${dropdownId}')" style="padding: 4px 10px;">
                                                âš™ï¸ Ä°ÅŸlemler â–¼
                                            </button>
                                            <div id="${dropdownId}" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 99999; min-width: 180px; padding: 8px; margin-top: 4px;">
                                                ${missedCallMenuItems}
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                `;
                                bgColor = '#e3f2fd';
                            } else if (memberMatch) {
                                const memberName = memberMatch.Resit_Olmayan_Adi_Soyadi || memberMatch.Ad_Soyad;
                                personInfo = `<div style="font-weight: 600; font-size: 15px; color: #388e3c; margin-bottom: 6px;">âœ… Ãœye: ${memberName}${deletedBadge}</div>`;
                                
                                // âœ… Ãœyeler iÃ§in de sadece cevapsÄ±z Ã§aÄŸrÄ±larda iÅŸlemler butonlarÄ± ekle
                                const showMemberActions = isMissed && callType !== 'callback' && callType !== 'answered' && callType !== 'other';
                                const missedCallMemberButtons = showMemberActions ? `
                                    <button class="btn btn-sm btn-info" onclick="markMissedCallAsAnswered('${caller}', null, '${memberMatch.id}')" title="Manuel olarak cevaplandÄ± iÅŸaretle">
                                        âœ”ï¸ CevaplandÄ±
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="sendMissedCallMessage('${memberMatch.Telefon || caller}', '${memberName}')" title="CevapsÄ±z Ã§aÄŸrÄ± mesajÄ± gÃ¶nder">
                                        ğŸ’¬ Mesaj GÃ¶nder
                                    </button>
                                ` : '';
                                
                                actionButtons = `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; flex-wrap: wrap; gap: 5px;">
                                        <button class="btn btn-sm btn-success" onclick="showMemberAttendancePage('${memberMatch.id}')">
                                            ğŸ“‹ Ãœye Bilgileri
                                        </button>
                                        ${missedCallMemberButtons}
                                    </div>
                                `;
                        } else {
                                // CRM'de olmayan cevapsÄ±z Ã§aÄŸrÄ±lar iÃ§in - FARKLI RENK
                                bgColor = '#fff8e1'; // AÃ§Ä±k sarÄ±/turuncu
                                borderColor = '#ffa726'; // Turuncu border
                                
                                const dropdownId = `dropdown-${call.lastCall.call_time.replace(/[^0-9]/g, '')}`;
                                const menuTimeStr2 = new Date(call.lastCall.call_time).toLocaleString('tr-TR');
                                
                                // âœ… Sadece cevapsÄ±z Ã§aÄŸrÄ±larda iÅŸlemler menÃ¼sÃ¼nÃ¼ gÃ¶ster
                                const showNewCustomerActions = isMissed && callType !== 'callback' && callType !== 'answered' && callType !== 'other';
                                const missedCallMenuItems = showNewCustomerActions ? `
                                    <button class="btn btn-sm btn-info" onclick="markMissedCallAsAnswered('${caller}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left; margin-bottom: 5px;">
                                        âœ”ï¸ CevaplandÄ±
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="markAsUnreachableWithMessage('${caller}', '${menuTimeStr2}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left; margin-bottom: 5px;">
                                        ğŸ“µ UlaÅŸÄ±lamadÄ±
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="sendMissedCallMessage('${caller}', 'MÃ¼ÅŸteri'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left; margin-bottom: 5px;">
                                        ğŸ’¬ Mesaj GÃ¶nder
                                    </button>
                                ` : '';
                                
                                personInfo = `<div style="font-weight: 600; font-size: 15px; color: #e65100; margin-bottom: 6px;">ğŸŒŸ Yeni Potansiyel MÃ¼ÅŸteri${deletedBadge}</div>`;
                                
                                actionButtons = `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; gap: 5px; align-items: center;">
                                        <button class="btn btn-sm btn-primary" onclick="addToCRMFromMissedCall('${caller}')">
                                            â• CRM'e Ekle
                                        </button>
                                        <button class="btn btn-sm btn-info" onclick="showCallRecordsModal('${caller}')" title="GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ±nÄ± gÃ¶rÃ¼ntÃ¼le">
                                            ğŸ“ GÃ¶rÃ¼ÅŸmeler
                                        </button>
                                        ${missedCallMenuItems ? `
                                        <div style="position: relative; display: inline-block; z-index: 10000;">
                                            <button class="btn btn-sm btn-secondary" onclick="toggleCallDropdown('${dropdownId}')" style="padding: 4px 10px;">
                                                âš™ï¸ Ä°ÅŸlemler â–¼
                                            </button>
                                            <div id="${dropdownId}" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 99999; min-width: 180px; padding: 8px; margin-top: 4px;">
                                                ${missedCallMenuItems}
                                            </div>
                                        </div>
                                        ` : ''}
                                    </div>
                                `;
                            }
                            
                            // Checkbox iÃ§in unique key - Ã¶zel karakterleri escape et
                            const safeCallTime = call.lastCall.call_time.replace(/'/g, "\\'");
                            const safeCaller = caller.replace(/'/g, "\\'");
                            const callKey = `${caller}|${call.lastCall.call_time}`;
                            const isChecked = selectedIncomingCalls.has(callKey) ? 'checked' : '';
                            
                            // CRM badge (saÄŸ Ã¼st kÃ¶ÅŸe)
                            const crmBadge = leadMatch ? `<div style="position: absolute; top: 8px; right: 8px; background: #1976d2; color: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">ğŸ“‹ CRM</div>` : '';
                            
                            return `
                                <div style="position: relative; padding: 15px; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 8px; transition: transform 0.2s; display: flex; gap: 12px; align-items: flex-start;" onmouseover="this.style.transform='translateY(-2px)'; this.style.zIndex='100';" onmouseout="this.style.transform='translateY(0)'; this.style.zIndex='1';">
                                    ${crmBadge}
                                    <div style="padding-top: 2px;">
                                        <input type="checkbox" class="incoming-call-checkbox" value="${callKey}" onchange="toggleIncomingCall(this, '${safeCaller}|${safeCallTime}')" ${isChecked} style="width: 20px; height: 20px; cursor: pointer; margin: 0;">
                                    </div>
                                    <div style="flex: 1;">
                                        ${personInfo}
                                        <div style="font-size: 14px; color: #333; font-weight: 500; margin-bottom: 6px;">ğŸ“ Arayan: ${formattedCaller} ${totalCallsInfo} ${whatsappBadge}</div>
                                        <div style="font-size: 13px; color: #666; margin-bottom: 6px;">ğŸ“± Aranan: ${formattedCallee}</div>
                                        <div style="font-size: 13px; color: #666; margin-bottom: 4px;">ğŸ• En Son: ${timeStr}</div>
                                        ${statusIcon && statusText ? `<div style="font-size: 13px; color: ${statusColor}; font-weight: 600; margin-bottom: 4px;">
                                            ${statusIcon} ${statusText}
                                        </div>` : ''}
                                        ${categoryBadge ? `<div style="margin-bottom: 4px;">${categoryBadge}</div>` : ''}
                                        <div style="font-size: 12px; color: #666;">â±ï¸ SÃ¼re: ${durationStr}</div>
                                        ${callCountInfo}
                                        ${actionButtons}
                                    </div>
                                </div>
                            `;
            } catch (error) {
                console.error('Gelen arama kartÄ± render hatasÄ±:', error);
                return `<div style="padding: 15px; background: #ffebee; border-radius: 8px;"><p style="color: #f44336;">âŒ Kart yÃ¼klenemedi</p></div>`;
            }
        };
        
        // Giden aramalar sayfasÄ±nÄ± render et
        window.renderOutgoingCallsPage = async function() {
            const container = document.getElementById('outgoing-calls-list');
            if (!container) return;
            
            // SeÃ§imleri temizle
            selectedOutgoingCalls.clear();
            const selectAllCheckbox = document.getElementById('selectAllOutgoing');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Giden aramalar yÃ¼kleniyor...</span></div>';
            
            // Bulutfon kontrolÃ¼ - API Key'e gÃ¶re kontrol et
            if (!clubSettings || !clubSettings.bulutfonApiKey) {
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <h3 style="color: #856404; margin-bottom: 15px;">ğŸ“ Bulutfon Entegrasyonu Gerekli</h3>
                        <p style="color: #666; margin-bottom: 20px;">
                            Giden aramalarÄ± gÃ¶rÃ¼ntÃ¼lemek iÃ§in Bulutfon API entegrasyonunu aktif etmeniz gerekiyor.
                        </p>
                        <button class="btn btn-primary" onclick="showSection('settings', document.querySelector('.nav-btn[onclick*=\\'settings\\']')); setTimeout(() => switchSettingsTab('general'), 500);">
                            âš™ï¸ Ayarlara Git
                        </button>
                    </div>
                `;
                return;
            }
            
            console.log('ğŸ“ Bulutfon API Key mevcut, aramalar yÃ¼kleniyor...');
            
            try {
                const response = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${clubSettings.bulutfonApiKey}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const allRecords = Array.isArray(data) ? data : (data.cdrs || data.data || []);
                
                // Giden aramalarÄ± filtrele (direction: 'OUT')
                let outgoingCalls = allRecords.filter(record => record.direction === 'OUT');
                
                // Son 1 hafta iÃ§indeki Ã§aÄŸrÄ±larÄ± al
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                outgoingCalls = outgoingCalls.filter(record => {
                    const callTime = new Date(record.call_time);
                    return callTime >= oneWeekAgo;
                });
                
                // âœ… NOT: Silinen Ã§aÄŸrÄ±larÄ± burada FÄ°LTRELEME - gruplama sonrasÄ± yapÄ±lacak
                // Ã‡Ã¼nkÃ¼ aynÄ± numaranÄ±n birden fazla Ã§aÄŸrÄ±sÄ± olabilir ve sadece en son Ã§aÄŸrÄ± silinmiÅŸse
                // diÄŸer Ã§aÄŸrÄ±larÄ± da gÃ¶rmemiz gerekiyor (gruplama iÃ§in)
                
                // âœ… Numaraya gÃ¶re grupla ve EN SON DURUMA gÃ¶re kategorilendirme yap
                const groupedByNumber = {};
                
                outgoingCalls.forEach(call => {
                    const cleanNumber = call.callee?.replace(/\D/g, '') || 'unknown';
                    const last10Digits = cleanNumber.slice(-10);
                    
                    if (!groupedByNumber[last10Digits]) {
                        groupedByNumber[last10Digits] = [];
                    }
                    
                    groupedByNumber[last10Digits].push(call);
                });
                
                // Her numara iÃ§in en son duruma gÃ¶re kategorilendirme yap
                const analyzedCalls = Object.values(groupedByNumber).map(calls => {
                    // En son Ã§aÄŸrÄ±yÄ± bul (en yeni tarih)
                    calls.sort((a, b) => new Date(b.call_time) - new Date(a.call_time));
                    const lastCall = calls[0];
                    
                    // En son Ã§aÄŸrÄ±nÄ±n durumunu kontrol et
                    let isAnswered = false;
                    
                    // 1. answer_time kontrolÃ¼ (Ã¶ncelikli - giden aramalar iÃ§in)
                    if (lastCall.answer_time !== undefined) {
                        isAnswered = lastCall.answer_time && lastCall.answer_time !== null && lastCall.answer_time !== '';
                    }
                    // 2. hangup_cause kontrolÃ¼ (fallback)
                    else if (lastCall.hangup_cause) {
                        const hangupCause = (lastCall.hangup_cause || '').toUpperCase();
                        isAnswered = hangupCause === 'ANSWERED';
                    }
                    // 3. Son fallback: talking_seconds kontrolÃ¼
                    else {
                        const talkingSeconds = parseInt(lastCall.talking_seconds) || 0;
                        isAnswered = talkingSeconds > 0;
                    }
                    
                    return {
                        number: lastCall.callee,
                        lastCall: lastCall,
                        status: isAnswered ? 'answered' : 'unanswered',
                        totalCalls: calls.length,
                        allCalls: calls
                    };
                });
                
                // Duruma gÃ¶re ayÄ±r
                let missedCalls = analyzedCalls.filter(c => c.status === 'unanswered');
                let answeredCalls = analyzedCalls.filter(c => c.status === 'answered');
                
                // âœ… Silinenleri filtrele (showDeletedCalls false ise) - EN SON Ã‡AÄRIYA gÃ¶re
                if (!showDeletedCalls) {
                    missedCalls = missedCalls.filter(c => !isCallDeleted(c.number, 'outgoing', c.lastCall.call_time));
                    answeredCalls = answeredCalls.filter(c => !isCallDeleted(c.number, 'outgoing', c.lastCall.call_time));
                }
                
                // âœ… Gizlenenleri filtrele (hiddenCalls)
                if (hiddenCalls && hiddenCalls.length > 0) {
                    const isCallHidden = (number) => {
                        const cleanNumber = number?.replace(/\D/g, '') || '';
                        return hiddenCalls.some(hidden => {
                            const cleanHidden = hidden?.replace(/\D/g, '') || '';
                            return cleanNumber.endsWith(cleanHidden.slice(-10)) || cleanHidden.endsWith(cleanNumber.slice(-10));
                        });
                    };
                    
                    missedCalls = missedCalls.filter(c => !isCallHidden(c.number));
                    answeredCalls = answeredCalls.filter(c => !isCallHidden(c.number));
                    console.log(`ğŸ” Giden aramalarda ${hiddenCalls.length} gizli arama filtrelendi`);
                }
                
                // Her ikisini de sÄ±rala (en yeni en Ã¼stte)
                missedCalls.sort((a, b) => new Date(b.lastCall.call_time) - new Date(a.lastCall.call_time));
                answeredCalls.sort((a, b) => new Date(b.lastCall.call_time) - new Date(a.lastCall.call_time));
                
                // Debug: Ä°lk birkaÃ§ kaydÄ± gÃ¶ster
                console.log(`ğŸ“Š Giden aramalar: ${missedCalls.length} cevapsÄ±z, ${answeredCalls.length} cevaplanan`);
                if (outgoingCalls.length > 0) {
                    console.log('ğŸ” Ä°lk 3 giden arama:');
                    outgoingCalls.slice(0, 3).forEach((call, idx) => {
                        console.log(`  ${idx + 1}. answer_time: ${call.answer_time || 'null'}, hangup_cause: ${call.hangup_cause}, talking_seconds: ${call.talking_seconds}, callee: ${call.callee}`);
                    });
                }
                
                // Global deÄŸiÅŸkende sakla (sekmeler iÃ§in - ileride kullanÄ±labilir)
                window.outgoingCallsCategories = {
                    unanswered: missedCalls,
                    answered: answeredCalls
                };
                
                // En fazla 30 cevapsÄ±z, 50 cevaplÄ±
                const displayMissed = missedCalls.slice(0, 30);
                const displayAnswered = answeredCalls.slice(0, 50);
                
                if (outgoingCalls.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p style="padding: 40px; color: #999;">ğŸ“‹ Son 72 saatte giden arama yok</p></div>';
                    return;
                }
                
                // CevapsÄ±z Ã§aÄŸrÄ±lar bÃ¶lÃ¼mÃ¼
                let missedSection = '';
                if (displayMissed.length > 0) {
                    missedSection = `
                        <div style="margin-bottom: 30px;">
                            <h3 style="color: #f44336; font-size: 18px; margin-bottom: 15px; padding: 10px; background: #ffebee; border-left: 4px solid #f44336; border-radius: 4px;">
                                ğŸ“µ CevapsÄ±z Ã‡aÄŸrÄ±lar (${displayMissed.length}) - En Son Arama
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; padding: 15px;">
                                ${displayMissed.map(call => renderOutgoingCall(call, true)).join('')}
                            </div>
                        </div>
                    `;
                }
                
                // Cevaplanan aramalar bÃ¶lÃ¼mÃ¼
                let answeredSection = '';
                if (displayAnswered.length > 0) {
                    answeredSection = `
                        <div>
                            <h3 style="color: #4caf50; font-size: 18px; margin-bottom: 15px; padding: 10px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 4px;">
                                âœ… Cevaplanan Aramalar (${displayAnswered.length}) - En Son Arama
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; padding: 15px;">
                                ${displayAnswered.map(call => renderOutgoingCall(call, false)).join('')}
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = missedSection + answeredSection;
                
                // Toplu silme butonunu gÃ¼ncelle
                updateBulkDeleteButton('outgoing');
            } catch (error) {
                console.error('Giden aramalar yÃ¼klenirken hata:', error);
                container.innerHTML = '<div class="empty-state"><p style="padding: 40px; color: #f44336;">âŒ Giden aramalar yÃ¼klenirken bir hata oluÅŸtu</p></div>';
            }
        }
        
        // Giden arama kartÄ±nÄ± render et
        function renderOutgoingCall(call, isMissedParam) {
            try {
                // call.lastCall yapÄ±sÄ±ndan veri al
                const actualCall = call.lastCall || call; // Eski yapÄ±yla uyumluluk iÃ§in
                
                // âœ… GÄ°DEN ARAMADA: caller=ÅŸirket, callee=mÃ¼ÅŸteri
                // "Aranan" = ÅŸirket olmalÄ± (orijinal aramada aranan ÅŸirketti)
                const callerNumber = actualCall.caller || 'Bilinmeyen'; // Åirket numarasÄ±
                const calleeNumber = call.number || actualCall.callee || 'Bilinmeyen'; // MÃ¼ÅŸteri numarasÄ±
                
                // âœ… "Aranan" sÃ¼tunu iÃ§in ÅŸirket numarasÄ±nÄ± kullan
                const callee = callerNumber; // Aranan = Åirket
                const formattedCallee = formatPhoneDisplay(callee);
                
                // âœ… "Arayan" sÃ¼tunu iÃ§in mÃ¼ÅŸteri numarasÄ±nÄ± kullan
                const caller = calleeNumber; // Arayan = MÃ¼ÅŸteri
                const formattedCaller = formatPhoneDisplay(caller);
                const callTime = new Date(actualCall.call_time);
                callTime.setHours(callTime.getHours() - 3); // UTC'den TÃ¼rkiye saatine Ã§evir
                const timeStr = callTime.toLocaleString('tr-TR', { 
                    day: '2-digit', 
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit'
                });
                
                // Duration bilgisini actualCall'dan al
                const talkingSeconds = actualCall.talking_seconds || actualCall.duration || 0;
                const durationStr = talkingSeconds > 0 ? `${Math.floor(talkingSeconds / 60)}:${String(talkingSeconds % 60).padStart(2, '0')} dk` : '0 sn';
                
                // isMissedParam'dan durumu al (status'den de kontrol et)
                const isMissed = call.status === 'unanswered' || isMissedParam;
                const wasAnswered = !isMissedParam;
                const statusIcon = wasAnswered ? 'âœ…' : 'âŒ';
                const statusText = wasAnswered ? 'CevaplandÄ±' : 'CevapsÄ±z';
                const statusColor = wasAnswered ? '#4caf50' : '#f44336';
                        
                        // CRM'de veya Ã¼yelerde var mÄ± kontrol et
                        const leadMatch = crmLeads.find(l => {
                                const cleanLead = l.phone?.replace(/\D/g, '');
                                const cleanCallee = callee.replace(/\D/g, '');
                                return cleanLead && cleanCallee && (
                                    cleanLead.endsWith(cleanCallee.slice(-10)) || 
                                    cleanCallee.endsWith(cleanLead.slice(-10))
                            );
                        });
                        
                        const memberMatch = members.find(m => {
                                const cleanMember = m.Telefon?.replace(/\D/g, '');
                                const cleanMember2 = m.Telefon_2?.replace(/\D/g, '');
                                const cleanCallee = callee.replace(/\D/g, '');
                                return cleanCallee && (
                                    (cleanMember && (cleanMember.endsWith(cleanCallee.slice(-10)) || cleanCallee.endsWith(cleanMember.slice(-10)))) ||
                                    (cleanMember2 && (cleanMember2.endsWith(cleanCallee.slice(-10)) || cleanCallee.endsWith(cleanMember2.slice(-10))))
                            );
                        });
                        
                        let personInfo = '';
                        let actionButtons = '';
                            let bgColor = wasAnswered ? '#e8f5e9' : '#ffebee';
                            let borderColor = statusColor;
                            
                            // SilinmiÅŸ badge ekle
                            const callDeleted = isCallDeleted(callee, 'outgoing', call.call_time);
                            const deletedBadge = callDeleted ? `<span style="background: #9e9e9e; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">ğŸ—‘ï¸ Silindi</span>` : '';
                            
                            const deleteButton = callDeleted ? 
                                `<button class="btn btn-sm btn-secondary" onclick="undeleteCall('${callee}', 'outgoing', '${call.call_time}')" title="Ã‡aÄŸrÄ±yÄ± geri getir">â†©ï¸ Geri Al</button>` :
                                `<button class="btn btn-sm btn-danger" onclick="deleteCall('${callee}', 'outgoing', '${call.call_time}')" title="Ã‡aÄŸrÄ±yÄ± sil">ğŸ—‘ï¸ Sil</button>`;
                        
                        if (leadMatch) {
                                personInfo = `<div style="font-weight: 600; font-size: 15px; color: #1976d2; margin-bottom: 6px;">ğŸ‘¤ ${leadMatch.fullName}${deletedBadge}</div>`;
                                
                                const dropdownId = `dropdown-out-${actualCall.call_time.replace(/[^0-9]/g, '')}`;
                                
                                // Toplam arama sayÄ±sÄ± badge
                                const totalCallsInfo = call.totalCalls && call.totalCalls > 1 ? 
                                    `<span style="background: #9c27b0; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">ğŸ“ ${call.totalCalls} arama</span>` : '';
                                
                            actionButtons = `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; gap: 5px; align-items: center; flex-wrap: wrap;">
                                        <button class="btn btn-sm btn-primary" onclick="openCustomerDetail('${leadMatch.id}')">
                                        ğŸ“‹ GÃ¶rÃ¼ntÃ¼le
                                    </button>
                                        <button class="btn btn-sm btn-info" onclick="showCallRecordsModal('${callee}')" title="GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ±nÄ± gÃ¶rÃ¼ntÃ¼le">
                                            ğŸ“ GÃ¶rÃ¼ÅŸmeler
                                        </button>
                                        <div style="position: relative; display: inline-block; z-index: 10000;">
                                            <button class="btn btn-sm btn-secondary" onclick="toggleCallDropdown('${dropdownId}')" style="padding: 4px 10px;">
                                                âš™ï¸ Ä°ÅŸlemler â–¼
                                            </button>
                                            <div id="${dropdownId}" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 99999; min-width: 180px; padding: 8px; margin-top: 4px;">
                                                <button class="btn btn-sm btn-success" onclick="updateCRMFromMissedCall('${leadMatch.id}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left; margin-bottom: 5px;">
                                            âœï¸ GÃ¼ncelle
                                    </button>
                                                <div style="border-top: 1px solid #e0e0e0; margin: 5px 0;"></div>
                                                ${callDeleted ? 
                                                    `<button class="btn btn-sm btn-secondary" onclick="undeleteCall('${callee}', 'outgoing', '${actualCall.call_time}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left;">â†©ï¸ Geri Al</button>` :
                                                    `<button class="btn btn-sm btn-danger" onclick="deleteCall('${callee}', 'outgoing', '${actualCall.call_time}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left;">ğŸ—‘ï¸ Sil</button>`}
                                            </div>
                                        </div>
                                        ${totalCallsInfo}
                                </div>
                            `;
                            bgColor = '#e3f2fd';
                        } else if (memberMatch) {
                            const memberName = memberMatch.Resit_Olmayan_Adi_Soyadi || memberMatch.Ad_Soyad;
                                personInfo = `<div style="font-weight: 600; font-size: 15px; color: #388e3c; margin-bottom: 6px;">âœ… Ãœye: ${memberName}${deletedBadge}</div>`;
                            actionButtons = `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; flex-wrap: wrap; gap: 5px;">
                                        <button class="btn btn-sm btn-success" onclick="showMemberAttendancePage('${memberMatch.id}')">
                                            ğŸ“‹ Ãœye Bilgileri
                                    </button>
                                        ${deleteButton}
                                </div>
                            `;
                        } else {
                                // CRM'de olmayan iÃ§in - FARKLI RENK
                                bgColor = '#fff8e1'; // AÃ§Ä±k sarÄ±/turuncu
                                borderColor = '#ffa726'; // Turuncu border
                                personInfo = `<div style="font-weight: 600; font-size: 15px; color: #e65100; margin-bottom: 6px;">ğŸŒŸ Yeni Potansiyel MÃ¼ÅŸteri${deletedBadge}</div>`;
                                
                                const dropdownId = `dropdown-out-${actualCall.call_time ? actualCall.call_time.replace(/[^0-9]/g, '') : 'unknown'}`;
                                
                            actionButtons = `
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); display: flex; gap: 5px; align-items: center;">
                                        <button class="btn btn-sm btn-primary" onclick="addToCRMFromMissedCall('${callee}')">
                                        â• CRM'e Ekle
                                    </button>
                                        <button class="btn btn-sm btn-info" onclick="showCallRecordsModal('${callee}')" title="GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ±nÄ± gÃ¶rÃ¼ntÃ¼le">
                                            ğŸ“ GÃ¶rÃ¼ÅŸmeler
                                        </button>
                                        <div style="position: relative; display: inline-block; z-index: 10000;">
                                            <button class="btn btn-sm btn-secondary" onclick="toggleCallDropdown('${dropdownId}')" style="padding: 4px 10px;">
                                                âš™ï¸ Ä°ÅŸlemler â–¼
                                            </button>
                                            <div id="${dropdownId}" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 99999; min-width: 180px; padding: 8px; margin-top: 4px;">
                                                <button class="btn btn-sm btn-secondary" onclick="sendMissedCallMessage('${callee}', 'MÃ¼ÅŸteri'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left; margin-bottom: 5px;">
                                            ğŸ’¬ Mesaj GÃ¶nder
                                        </button>
                                                <div style="border-top: 1px solid #e0e0e0; margin: 5px 0;"></div>
                                                ${callDeleted ? 
                                                    `<button class="btn btn-sm btn-secondary" onclick="undeleteCall('${callee}', 'outgoing', '${actualCall.call_time}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left;">â†©ï¸ Geri Al</button>` :
                                                    `<button class="btn btn-sm btn-danger" onclick="deleteCall('${callee}', 'outgoing', '${actualCall.call_time}'); toggleCallDropdown('${dropdownId}')" style="width: 100%; text-align: left;">ğŸ—‘ï¸ Sil</button>`}
                                            </div>
                                        </div>
                                </div>
                            `;
                        }
                        
                // Checkbox iÃ§in unique key - Ã¶zel karakterleri escape et
                const safeCallTime = actualCall.call_time ? actualCall.call_time.replace(/'/g, "\\'") : '';
                const safeCallee = callee ? callee.replace(/'/g, "\\'") : '';
                const callKey = `${callee}|${actualCall.call_time}`;
                const isChecked = selectedOutgoingCalls.has(callKey) ? 'checked' : '';
                
                // CRM badge (saÄŸ Ã¼st kÃ¶ÅŸe)
                const crmBadge = leadMatch ? `<div style="position: absolute; top: 8px; right: 8px; background: #1976d2; color: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">ğŸ“‹ CRM</div>` : '';
                        
                return `
                    <div style="position: relative; padding: 15px; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 8px; transition: transform 0.2s; display: flex; gap: 12px; align-items: flex-start;" onmouseover="this.style.transform='translateY(-2px)'; this.style.zIndex='100';" onmouseout="this.style.transform='translateY(0)'; this.style.zIndex='1';">
                        ${crmBadge}
                        <div style="padding-top: 2px;">
                            <input type="checkbox" class="outgoing-call-checkbox" value="${callKey}" onchange="toggleOutgoingCall(this, '${safeCallee}|${safeCallTime}')" ${isChecked} style="width: 20px; height: 20px; cursor: pointer; margin: 0;">
                        </div>
                        <div style="flex: 1;">
                            ${personInfo}
                            <div style="font-size: 14px; color: #333; font-weight: 500; margin-bottom: 6px;">ğŸ“ Aranan: ${formattedCallee}</div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 6px;">ğŸ“± Arayan: ${formattedCaller}</div>
                            <div style="font-size: 13px; color: #666; margin-bottom: 4px;">ğŸ• ${timeStr}</div>
                            <div style="font-size: 13px; color: ${statusColor}; font-weight: 600; margin-bottom: 4px;">
                                ${statusIcon} ${statusText}
                            </div>
                            <div style="font-size: 12px; color: #666;">â±ï¸ SÃ¼re: ${durationStr}</div>
                            ${actionButtons}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Giden arama kartÄ± render hatasÄ±:', error);
                return `<div style="padding: 15px; background: #ffebee; border-radius: 8px;"><p style="color: #f44336;">âŒ Kart yÃ¼klenemedi</p></div>`;
            }
        }
        
        // CevapsÄ±z Ã§aÄŸrÄ±lar iÃ§in otomatik kontrol sistemi
        let missedCallsCheckInterval = null;
        let lastMissedCallsCount = -1; // -1 = henÃ¼z kontrol edilmedi, ilk kontrolde bildirim gÃ¶nder
        
        // Not: Gizli Ã§aÄŸrÄ± sistemi kaldÄ±rÄ±ldÄ± - artÄ±k sadece yerel silme var
        
        // Otomatik kontrolÃ¼ baÅŸlat
        async function startMissedCallsAutoCheck() {
            // EÄŸer Bulutfon aktif deÄŸilse baÅŸlatma
            if (!clubSettings || !clubSettings.bulutfonEnabled || !clubSettings.bulutfonApiKey) {
                return;
            }
            
            console.log('â³ CevapsÄ±z Ã§aÄŸrÄ± bildirimi sistemi baÅŸlatÄ±ldÄ±');
            
            // Varsa Ã¶nceki interval'i temizle
            if (missedCallsCheckInterval) {
                clearInterval(missedCallsCheckInterval);
            }
            
            // âœ… Ä°lk kontrolÃ¼ hemen yap (sayfa aÃ§Ä±lÄ±r aÃ§Ä±lmaz)
            setTimeout(async () => {
                await checkForNewMissedCalls();
            }, 2000); // 2 saniye sonra (sayfa yÃ¼klenmesini bekle)
            
            // Her 2 dakikada bir kontrol et
            missedCallsCheckInterval = setInterval(async () => {
                await checkForNewMissedCalls();
            }, 120 * 1000); // 120 saniye = 2 dakika
            
            console.log('âœ… CevapsÄ±z Ã§aÄŸrÄ±lar otomatik kontrol baÅŸlatÄ±ldÄ± (Her 2 dakikada bir)');
        }
        
        // Yeni cevapsÄ±z Ã§aÄŸrÄ±larÄ± kontrol et
        async function checkForNewMissedCalls() {
            try {
                // âœ… CevapsÄ±z Ã§aÄŸrÄ±larÄ± yeniden hesapla
                await renderIncomingCallsPage();
                
                // Toplam cevapsÄ±z sayÄ±sÄ±nÄ± al (SADECE tam cevapsÄ±z)
                const currentCount = window.totalUnansweredCount || 0;
                
                console.log(`ğŸ” Kontrol: Åu an ${currentCount} cevapsÄ±z, Ã¶nceki: ${lastMissedCallsCount}`);
                
                // EÄŸer sayÄ± artmÄ±ÅŸsa bildirim gÃ¶ster
                if (currentCount > lastMissedCallsCount && lastMissedCallsCount >= 0) {
                    const newCallsCount = currentCount - lastMissedCallsCount;
                    if (newCallsCount > 0) {
                        console.log(`ğŸ”” ${newCallsCount} yeni cevapsÄ±z Ã§aÄŸrÄ± tespit edildi!`);
                        await showMissedCallNotification(newCallsCount);
                    }
                }
                
                lastMissedCallsCount = currentCount;
                
            } catch (error) {
                console.error('âŒ CevapsÄ±z Ã§aÄŸrÄ± kontrolÃ¼ hatasÄ±:', error);
            }
        }
        
        // Sesli ve gÃ¶rsel bildirim gÃ¶ster
        async function showMissedCallNotification(count) {
            console.log(`ğŸ”” Bildirim gÃ¶steriliyor: ${count} yeni cevapsÄ±z Ã§aÄŸrÄ±`);
            
            // GÃ¶rsel bildirim (Browser Notification API)
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    const notificationBody = count === 1 
                        ? '1 cevapsÄ±z Ã§aÄŸrÄ±nÄ±z var! Hemen inceleyin.' 
                        : `${count} cevapsÄ±z Ã§aÄŸrÄ±nÄ±z var! Hemen inceleyin.`;
                    
                    const notification = new Notification('ğŸ“µ CevapsÄ±z Ã‡aÄŸrÄ±!', {
                        body: notificationBody,
                        icon: 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext y=%220.9em%22 font-size=%2290%22%3EğŸ“µ%3C/text%3E%3C/svg%3E',
                        tag: 'missed-calls-' + Date.now(),
                        requireInteraction: true,
                        silent: false
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        showSection('crm-incoming-calls', document.querySelector('.nav-btn[onclick*=\'crm-incoming-calls\']'));
                        notification.close();
                    };
                    
                    console.log('âœ… Browser bildirimi gÃ¶nderildi');
                } else if (Notification.permission === 'default') {
                    requestNotificationPermission();
                }
            }
            
            // Sesli bildirim
            await playNotificationSound();
            
            // Sayfa iÃ§i bildirim (clickable alert) - Ã‡OK DAHA BELÄ°RGÄ°N
            let alertMessage;
            if (count >= 3) {
                alertMessage = `ğŸ“µ ACELE! ${count} CEVAPSIZ Ã‡AÄRI! Hemen gÃ¶rÃ¼ntÃ¼lemek iÃ§in tÄ±klayÄ±n.`;
            } else if (count === 1) {
                alertMessage = `ğŸ“µ 1 CEVAPSIZ Ã‡AÄRI! GÃ¶rÃ¼ntÃ¼lemek iÃ§in tÄ±klayÄ±n.`;
            } else {
                alertMessage = `ğŸ“µ ${count} CEVAPSIZ Ã‡AÄRI! GÃ¶rÃ¼ntÃ¼lemek iÃ§in tÄ±klayÄ±n.`;
            }
            
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${count >= 3 ? 'linear-gradient(135deg, #f44336 0%, #e91e63 100%)' : 'linear-gradient(135deg, #ff9800 0%, #ff5722 100%)'};
                color: white;
                padding: 25px 40px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.4);
                z-index: 10000;
                cursor: pointer;
                font-size: 18px;
                font-weight: 700;
                animation: bounceIn 0.5s ease-out;
                max-width: 450px;
                border: 3px solid white;
                text-align: center;
            `;
            alertDiv.textContent = alertMessage;
            alertDiv.onclick = () => {
                showSection('crm-incoming-calls', document.querySelector('.nav-btn[onclick*=\'crm-incoming-calls\']'));
                alertDiv.remove();
            };
            
            document.body.appendChild(alertDiv);
            
            // 15 saniye sonra otomatik kapat
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => alertDiv.remove(), 300);
                }
            }, 15000);
            
            console.log('âœ… Sayfa iÃ§i bildirim gÃ¶sterildi');
        }
        
        // âœ… Bildirim sesi Ã§al (Web Audio API fonksiyonu satÄ±r 3886'da tanÄ±mlÄ±)
        
        // WhatsApp mesaj bildirimi gÃ¶ster
        async function showWhatsAppMessageNotification(count, lastSender = '', messageText = '', instanceName = '') {
            console.log(`ğŸ”” WhatsApp bildirimi gÃ¶steriliyor: ${count} yeni mesaj, gÃ¶nderen: ${lastSender}, mesaj: ${messageText}`);
            
            // GÃ¶rsel bildirim (Browser Notification API)
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    let notificationBody;
                    if (count === 1 && messageText) {
                        // Kimin kime yazdÄ±ÄŸÄ±nÄ± gÃ¶ster
                        const receiverInfo = instanceName ? ` â†’ ${instanceName}` : '';
                        notificationBody = `${lastSender}${receiverInfo}:\n${messageText.substring(0, 100)}`;
                    } else if (count === 1) {
                        notificationBody = `${lastSender} mesaj gÃ¶nderdi`;
                    } else {
                        notificationBody = `${count} yeni WhatsApp mesajÄ± var!`;
                    }
                    
                    const notification = new Notification('ğŸ’¬ WhatsApp MesajÄ±!', {
                        body: notificationBody,
                        icon: 'https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg',
                        tag: 'whatsapp-messages-' + Date.now(),
                        requireInteraction: false,
                        silent: false
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        showSection('whatsapp', document.querySelector('.nav-btn[onclick*=\'whatsapp\']'));
                        notification.close();
                    };
                    
                    console.log('âœ… WhatsApp browser bildirimi gÃ¶nderildi');
                } else if (Notification.permission === 'default') {
                    // Ä°lk mesaj geldiÄŸinde izin iste
                    requestNotificationPermission();
                }
            }
            
            // Sesli bildirim - Hemen Ã§al
            await playNotificationSound();
            
            // Sayfa iÃ§i bildirim (clickable alert)
            let alertMessage;
            if (count === 1 && messageText) {
                const receiverInfo = instanceName ? ` â†’ ${instanceName}` : '';
                alertMessage = `ğŸ’¬ ${lastSender}${receiverInfo}: ${messageText.substring(0, 50)}... (TÄ±klayÄ±n)`;
            } else if (count === 1) {
                alertMessage = `ğŸ’¬ ${lastSender} mesaj gÃ¶nderdi! (TÄ±klayÄ±n)`;
            } else {
                alertMessage = `ğŸ’¬ ${count} YENÄ° WHATSAPP MESAJI! (TÄ±klayÄ±n)`;
            }
            
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
                color: white;
                padding: 20px 30px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(37, 211, 102, 0.4);
                z-index: 100000;
                font-size: 18px;
                font-weight: bold;
                cursor: pointer;
                animation: slideInRight 0.5s ease-out, pulse 2s infinite;
                max-width: 400px;
                border: 3px solid white;
            `;
            
            alertDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 32px;">ğŸ’¬</div>
                    <div style="flex: 1;">${alertMessage}</div>
                </div>
            `;
            
            alertDiv.onclick = () => {
                showSection('whatsapp', document.querySelector('.nav-btn[onclick*=\'whatsapp\']'));
                alertDiv.remove();
            };
            
            document.body.appendChild(alertDiv);
            
            // 15 saniye sonra otomatik kapat
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.style.animation = 'slideOutRight 0.5s ease-in';
                    setTimeout(() => alertDiv.remove(), 500);
                }
            }, 15000);
            
            console.log('âœ… Sayfa iÃ§i WhatsApp bildirimi gÃ¶sterildi');
        }
        
        // Browser bildirim izni iste ve Service Worker kaydet
        async function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                try {
                    // KullanÄ±cÄ± ID'sini kontrol et
                    if (!currentUser || !currentUser.email) {
                        console.warn('âš ï¸ KullanÄ±cÄ± bilgisi yok, bildirim izni atlanÄ±yor');
                        return;
                    }
                    
                    // Firebase'den kullanÄ±cÄ±nÄ±n bildirim izni durumunu kontrol et
                    const userId = currentUser.email.replace('@', '_').replace('.', '_');
                    const userDocRef = window.firebase.doc(window.db, 'users', userId);
                    const userDoc = await window.firebase.getDoc(userDocRef);
                    
                    const userData = userDoc.data();
                    const hasAsked = userData?.notificationPermissionAsked || false;
                    
                    if (!hasAsked) {
                        const permission = await Notification.requestPermission();
                        
                        // Firebase'e kaydet
                        await window.firebase.setDoc(
                            userDocRef,
                            {
                                email: currentUser.email,
                                notificationPermissionAsked: true,
                                notificationPermission: permission,
                                notificationPermissionDate: new Date().toISOString()
                            },
                            { merge: true }
                        );
                        
                    if (permission === 'granted') {
                        console.log('âœ… Bildirim izni verildi');
                            
                            // Service Worker kaydet (tarayÄ±cÄ± arka plandayken bildirim iÃ§in)
                            if ('serviceWorker' in navigator) {
                                try {
                                    // Inline Service Worker oluÅŸtur
                                    const swCode = `
                                        self.addEventListener('push', function(event) {
                                            const data = event.data ? event.data.json() : {};
                                            const title = data.title || 'Yeni Bildirim';
                                            const options = {
                                                body: data.body || '',
                                                icon: '/favicon.ico',
                                                badge: '/favicon.ico',
                                                vibrate: [200, 100, 200],
                                                data: data
                                            };
                                            event.waitUntil(
                                                self.registration.showNotification(title, options)
                                            );
                                        });
                                        
                                        self.addEventListener('notificationclick', function(event) {
                                            event.notification.close();
                                            event.waitUntil(
                                                clients.openWindow(event.notification.data.url || '/')
                                            );
                                        });
                                    `;
                                    
                                    const blob = new Blob([swCode], { type: 'application/javascript' });
                                    const swUrl = URL.createObjectURL(blob);
                                    
                                    const registration = await navigator.serviceWorker.register(swUrl);
                                    console.log('âœ… Service Worker kaydedildi:', registration);
                                } catch (error) {
                                    console.log('âš ï¸ Service Worker kaydedilemedi:', error);
                                }
                            }
                        } else if (permission === 'denied') {
                            console.log('âŒ Bildirim izni reddedildi');
                        }
                    }
                } catch (error) {
                    console.error('Bildirim izni kontrolÃ¼ hatasÄ±:', error);
                }
            }
        }
        
        // CRM'e ekle (cevapsÄ±z Ã§aÄŸrÄ±dan)
        window.addToCRMFromMissedCall = async function(phoneNumber) {
            // Telefonu formatla (05xxx formatÄ±na)
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            // âœ… showSection kaldÄ±rÄ±ldÄ± - kullanÄ±cÄ± bulunduÄŸu sayfada kalacak
            
            // Modal'Ä± aÃ§
                openAddLeadModal();
                
            // Telefonu doldur ve gÃ¶rÃ¼ÅŸme kayÄ±tlarÄ±nÄ± yÃ¼kle
                setTimeout(() => {
                    const phoneInput = document.querySelector('#addLeadModal input[name="phone"]');
                    if (phoneInput) {
                        phoneInput.value = formattedPhone;
                        // Telefon kontrolÃ¼nÃ¼ tetikle
                        phoneInput.dispatchEvent(new Event('blur'));
                    }
                
                // GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ± sekmesi ekle - daha uzun timeout
                setTimeout(async () => {
                    console.log('ğŸ“ GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ± yÃ¼kleniyor...');
                    await addCallRecordsTabToModal(formattedPhone);
                }, 600);
            }, 300);
        };
        
        // Modal'a gÃ¶rÃ¼ÅŸme kayÄ±tlarÄ± sekmesi ekle
        async function addCallRecordsTabToModal(phoneNumber) {
            try {
                const modal = document.getElementById('addLeadModal');
                if (!modal) {
                    console.log('âš ï¸ Modal bulunamadÄ±');
                    return;
                }
                
                // Modal iÃ§eriÄŸine sekme ekle
                const modalBody = modal.querySelector('.modal-body');
                if (!modalBody) {
                    console.log('âš ï¸ Modal body bulunamadÄ±');
                    return;
                }
                
                // Bulutfon kontrolÃ¼
                if (!clubSettings || !clubSettings.bulutfonEnabled || !clubSettings.bulutfonApiKey) {
                    console.log('âš ï¸ Bulutfon entegrasyonu aktif deÄŸil');
                    const form = modalBody.querySelector('#addLeadForm');
                    if (form) {
                        const existingCallRecords = modalBody.querySelector('[data-call-records]');
                        if (existingCallRecords) existingCallRecords.remove();
                        
                        const callRecordsDiv = document.createElement('div');
                        callRecordsDiv.setAttribute('data-call-records', 'true');
                        callRecordsDiv.innerHTML = `
                            <div style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 15px;">
                                <h4 style="color: #ff9800; margin-bottom: 10px;">ğŸ“ GÃ¶rÃ¼ÅŸme KayÄ±tlarÄ±</h4>
                                <div style="padding: 15px; background: #fff3e0; border-radius: 6px; border-left: 4px solid #ff9800;">
                                    <p style="color: #666; margin: 0; font-size: 13px;">Bulutfon entegrasyonu aktif deÄŸil. GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ±nÄ± gÃ¶rmek iÃ§in WhatsApp > Ayarlar > Bulutfon API'yi aktif edin.</p>
                                </div>
                            </div>
                        `;
                        form.parentNode.insertBefore(callRecordsDiv, form.nextSibling);
                    }
                    return;
                }
                
                // YÃ¼kleniyor mesajÄ± gÃ¶ster
                const form = modalBody.querySelector('#addLeadForm');
                if (form) {
                    const existingCallRecords = modalBody.querySelector('[data-call-records]');
                    if (existingCallRecords) existingCallRecords.remove();
                    
                    const loadingDiv = document.createElement('div');
                    loadingDiv.setAttribute('data-call-records', 'true');
                    loadingDiv.innerHTML = `
                        <div style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 15px;">
                            <h4 style="color: #1976d2; margin-bottom: 10px;">ğŸ“ GÃ¶rÃ¼ÅŸme KayÄ±tlarÄ±</h4>
                            <div class="loading"><div class="spinner"></div><span>GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ± yÃ¼kleniyor...</span></div>
                        </div>
                    `;
                    form.parentNode.insertBefore(loadingDiv, form.nextSibling);
                }
                
                // Bulutfon'dan bu numaraya ait Ã§aÄŸrÄ±larÄ± Ã§ek
                console.log(`ğŸ“ ${phoneNumber} iÃ§in gÃ¶rÃ¼ÅŸme kayÄ±tlarÄ± Ã§ekiliyor...`);
                const response = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${clubSettings.bulutfonApiKey}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`Bulutfon API hatasÄ±: HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const allRecords = Array.isArray(data) ? data : (data.cdrs || data.data || []);
                
                console.log(`ğŸ“Š Toplam ${allRecords.length} arama kaydÄ± alÄ±ndÄ±`);
                
                // Bu telefon numarasÄ±na ait kayÄ±tlarÄ± filtrele - phonesMatch kullan
                const phoneRecords = allRecords.filter(record => {
                    return phonesMatch(record.caller, phoneNumber) || phonesMatch(record.callee, phoneNumber);
                });
                
                console.log(`ğŸ“ ${phoneNumber} iÃ§in ${phoneRecords.length} gÃ¶rÃ¼ÅŸme kaydÄ± bulundu`);
                
                // Sekme oluÅŸtur - kayÄ±t yoksa da bilgi gÃ¶ster
                let callRecordsHtml = `
                    <div style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 15px;">
                        <h4 style="color: #1976d2; margin-bottom: 15px;">ğŸ“ GÃ¶rÃ¼ÅŸme KayÄ±tlarÄ± (${phoneRecords.length})</h4>
                `;
                
                if (phoneRecords.length === 0) {
                    callRecordsHtml += `
                        <div style="padding: 15px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                            <p style="color: #666; margin: 0; font-size: 13px;">Bu numara (${phoneNumber}) iÃ§in Bulutfon sisteminde gÃ¶rÃ¼ÅŸme kaydÄ± bulunamadÄ±.</p>
                            <p style="color: #888; margin: 5px 0 0 0; font-size: 12px;">ğŸ’¡ KayÄ±tlar silinmiÅŸ veya henÃ¼z bu numarayla gÃ¶rÃ¼ÅŸme yapÄ±lmamÄ±ÅŸ olabilir.</p>
                        </div>
                    `;
                } else {
                    callRecordsHtml += `<div style="max-height: 300px; overflow-y: auto;">`;
                
                phoneRecords.slice(0, 10).forEach(record => {
                    const callTime = new Date(record.call_time);
                    const timeStr = callTime.toLocaleString('tr-TR');
                    const direction = record.direction === 'IN' ? 'ğŸ“¥ Gelen' : 'ğŸ“¤ Giden';
                    const duration = record.talking_seconds ? `${record.talking_seconds}s` : 'CevapsÄ±z';
                    const wasAnswered = record.talking_seconds && parseInt(record.talking_seconds) > 0;
                    const statusColor = wasAnswered ? '#4caf50' : '#f44336';
                    
                const recordingBtn = (record.uuid && clubSettings && clubSettings.bulutfonApiKey) ?
                        `<button class="btn btn-sm btn-info" onclick="window.open('https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonRecordingProxy?apikey=${clubSettings.bulutfonApiKey}&uuid=${record.uuid}', '_blank')" title="Ses kaydÄ±nÄ± dinle">ğŸ§ Dinle</button>` :
                        '';
                    
                    callRecordsHtml += `
                        <div style="padding: 12px; background: #f5f5f5; border-left: 4px solid ${statusColor}; border-radius: 6px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${direction}</div>
                                    <div style="font-size: 13px; color: #666;">ğŸ• ${timeStr}</div>
                                    <div style="font-size: 13px; color: ${statusColor}; font-weight: 600; margin-top: 4px;">${duration}</div>
                                </div>
                                <div>
                                    ${recordingBtn}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                if (phoneRecords.length > 10) {
                    callRecordsHtml += `<div style="text-align: center; color: #666; font-size: 13px; margin-top: 10px;">... ve ${phoneRecords.length - 10} kayÄ±t daha</div>`;
                }
                
                    callRecordsHtml += `</div>`;
                }
                
                callRecordsHtml += `</div>`;
                
                // Form'dan sonra ekle
                if (form) {
                    const existingCallRecords = modalBody.querySelector('[data-call-records]');
                    if (existingCallRecords) {
                        existingCallRecords.remove();
                    }
                    
                    const callRecordsDiv = document.createElement('div');
                    callRecordsDiv.setAttribute('data-call-records', 'true');
                    callRecordsDiv.innerHTML = callRecordsHtml;
                    form.parentNode.insertBefore(callRecordsDiv, form.nextSibling);
                }
                
            } catch (error) {
                console.error('âŒ GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ± yÃ¼klenirken hata:', error);
                
                // Hata mesajÄ±nÄ± modal'da gÃ¶ster
                const modal = document.getElementById('addLeadModal');
                if (modal) {
                    const modalBody = modal.querySelector('.modal-body');
                    const form = modalBody?.querySelector('#addLeadForm');
                    if (form) {
                        const existingCallRecords = modalBody.querySelector('[data-call-records]');
                        if (existingCallRecords) existingCallRecords.remove();
                        
                        const errorDiv = document.createElement('div');
                        errorDiv.setAttribute('data-call-records', 'true');
                        errorDiv.innerHTML = `
                            <div style="margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 15px;">
                                <h4 style="color: #f44336; margin-bottom: 10px;">ğŸ“ GÃ¶rÃ¼ÅŸme KayÄ±tlarÄ±</h4>
                                <div style="padding: 15px; background: #ffebee; border-radius: 6px; border-left: 4px solid #f44336;">
                                    <p style="color: #c62828; margin: 0 0 5px 0; font-weight: 600;">âŒ GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ± yÃ¼klenemedi</p>
                                    <p style="color: #666; margin: 0; font-size: 13px;">${error.message}</p>
                                    <p style="color: #888; margin: 5px 0 0 0; font-size: 12px;">ğŸ’¡ Bulutfon API baÄŸlantÄ±nÄ±zÄ± ve API key'inizi kontrol edin.</p>
                                </div>
                            </div>
                        `;
                        form.parentNode.insertBefore(errorDiv, form.nextSibling);
                    }
                }
            }
        }
        
        // CRM bilgilerini gÃ¼ncelle (cevapsÄ±z Ã§aÄŸrÄ±dan)
        window.updateCRMFromMissedCall = function(leadId) {
            // CRM sayfasÄ±na geÃ§
            showSection('crm', document.querySelector('.nav-btn[onclick*=\'crm\']'));
            
            // KÄ±sa bir gecikme sonra customer detail'Ä± aÃ§
            setTimeout(() => {
                openCustomerDetail(leadId);
            }, 300);
        };
        
        // Telefon numarasÄ±nÄ± temizle ve formatla
        function cleanPhoneNumber(phone) {
            if (!phone) return '';
            // TÃ¼m boÅŸluklar, tire, parantez vb temizle - sadece rakamlar kalsÄ±n
            return phone.replace(/\D/g, '');
        }
        
        // Telefon numaralarÄ±nÄ± karÅŸÄ±laÅŸtÄ±r - GÃœÃ‡LENDÄ°RÄ°LMÄ°Å VERSÄ°YON
        function phonesMatch(phone1, phone2) {
            if (!phone1 || !phone2) return false;
            
            const clean1 = cleanPhoneNumber(phone1);
            const clean2 = cleanPhoneNumber(phone2);
            
            if (clean1.length < 10 || clean2.length < 10) return false;
            
            // Son 10 haneyi al (TÃ¼rkiye telefon numarasÄ± standardÄ±)
            const last10_1 = clean1.slice(-10);
            const last10_2 = clean2.slice(-10);
            
            return last10_1 === last10_2;
        }
        
        // Mevcut telefonu kontrol et ve Ã¶nerileri gÃ¶ster - MÃœÅTERÄ° FÄ°LTRESÄ° GÄ°BÄ° GÃœÃ‡LÃœ
        window.checkExistingPhone = function(inputValue) {
            const messageDiv = document.getElementById('phone-check-message');
            if (!messageDiv) return;
            
            if (!inputValue || inputValue.trim().length < 3) {
                messageDiv.innerHTML = '';
                return;
            }
            
            // Benzer telefon numaralarÄ±nÄ± bul (phonesMatch kullanarak)
            const cleanInput = cleanPhoneNumber(inputValue);
            const matchingLeads = [];
            
            // Tam eÅŸleÅŸme kontrolÃ¼ (son 10 hane)
            const exactMatch = crmLeads.find(lead => phonesMatch(lead.phone, inputValue));
            
            if (exactMatch) {
                messageDiv.innerHTML = `
                    <div style="color: #f44336; background: #ffebee; padding: 8px; border-radius: 4px; border-left: 3px solid #f44336;">
                        <strong>âš ï¸ UyarÄ±:</strong> Bu telefon numarasÄ± zaten kayÄ±tlÄ±!<br>
                        <strong>MÃ¼ÅŸteri:</strong> ${exactMatch.fullName} | Tel: ${exactMatch.phone}<br>
                        <button class="btn btn-sm btn-primary" onclick="openCustomerDetail('${exactMatch.id}')" style="margin-top: 5px;">
                            ğŸ“‹ MÃ¼ÅŸteriyi GÃ¶rÃ¼ntÃ¼le
                        </button>
                    </div>
                `;
                return;
            }
            
            // KÄ±smi eÅŸleÅŸmeleri bul (en az 5 rakam eÅŸleÅŸmeli) - MÃ¼ÅŸteri filtresi gibi
            if (cleanInput.length >= 5) {
                crmLeads.forEach(lead => {
                    const cleanLeadPhone = cleanPhoneNumber(lead.phone);
                    
                    // Her tÃ¼rlÃ¼ eÅŸleÅŸme: 
                    // 1. Girilen rakamlar lead telefonda geÃ§iyor mu?
                    // 2. Lead telefon girilen rakamlarÄ± iÃ§eriyor mu?
                    if (cleanLeadPhone.includes(cleanInput) || cleanInput.includes(cleanLeadPhone)) {
                        if (!matchingLeads.find(l => l.id === lead.id)) {
                            matchingLeads.push(lead);
                        }
                    }
                });
            }
            
            if (matchingLeads.length > 0) {
                const suggestions = matchingLeads.slice(0, 5).map(lead => `
                    <div style="padding: 6px; margin: 4px 0; background: white; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e0e0e0;">
                        <div style="flex: 1;">
                            <strong>${lead.fullName}</strong><br>
                            <small style="color: #666;">${lead.phone}</small>
                        </div>
                        <button onclick="openCustomerDetail('${lead.id}'); event.stopPropagation();" style="padding: 4px 8px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                            AÃ§
                        </button>
                    </div>
                `).join('');
                
                messageDiv.innerHTML = `
                    <div style="color: #ff9800; background: #fff3e0; padding: 8px; border-radius: 4px; border-left: 3px solid #ff9800;">
                        <strong>ğŸ’¡ ${matchingLeads.length} benzer numara bulundu:</strong>
                        ${suggestions}
                        ${matchingLeads.length > 5 ? `<div style="font-size: 11px; color: #666; margin-top: 5px;">ve ${matchingLeads.length - 5} tane daha...</div>` : ''}
                    </div>
                `;
            } else {
                messageDiv.innerHTML = '<div style="color: #4caf50; padding: 4px 0;">âœ… Bu telefon numarasÄ± kullanÄ±labilir</div>';
            }
        };
        
        // UlaÅŸÄ±lamadÄ± olarak iÅŸaretle VE mesaj gÃ¶nder
        window.markAsUnreachableWithMessage = async function(phoneNumber, timeStr) {
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            try {
                // WhatsApp cihazÄ±nÄ± kontrol et
                if (!defaultWhatsAppDevice) {
                    showAlert('âš ï¸ WhatsApp cihazÄ± yapÄ±landÄ±rÄ±lmamÄ±ÅŸ.', 'warning');
                    return;
                }
                
                // Mesaj ÅŸablonu
                const clubName = clubSettings.clubName || 'Sporcum';
                const messageTemplate = `Merhaba,\n\n${clubName} olarak size ulaÅŸmaya Ã§alÄ±ÅŸtÄ±k ancak ulaÅŸamadÄ±k.\n\nBize ${timeStr} tarihinde bir cevapsÄ±z Ã§aÄŸrÄ±nÄ±z dÃ¼ÅŸmÃ¼ÅŸtÃ¼r.\n\nSizinle gÃ¶rÃ¼ÅŸmek ve sorularÄ±nÄ±zÄ± yanÄ±tlamak isteriz. LÃ¼tfen uygun olduÄŸunuzda bizi arayÄ±nÄ±z.\n\nTeÅŸekkÃ¼rler,\n${clubName} Ekibi`;
                
                // MesajÄ± kuyruÄŸa ekle - CRM'e EKLEMÄ°YORUZ, sadece mesaj gÃ¶nderiyoruz
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'messageQueue'),
                    {
                        clubId: currentClubId,
                        phone: formattedPhone,
                        message: messageTemplate,
                        deviceId: defaultWhatsAppDevice,
                        scheduledFor: new Date().toISOString(),
                        status: 'pending',
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser?.fullName || 'Admin',
                        type: 'unreachable_notification'
                    }
                );
                
                // âœ… UlaÅŸÄ±lamadÄ± olarak iÅŸaretle (localStorage'a kaydet)
                const unreachableKey = `unreachable_${cleanPhone}_${timeStr}`;
                const unreachableCalls = JSON.parse(localStorage.getItem('unreachableCalls') || '{}');
                unreachableCalls[unreachableKey] = {
                    phone: cleanPhone,
                    timestamp: new Date().toISOString(),
                    timeStr: timeStr
                };
                localStorage.setItem('unreachableCalls', JSON.stringify(unreachableCalls));
                
                showAlert('âœ… "UlaÅŸÄ±lamadÄ±" mesajÄ± kuyruÄŸa eklendi. MÃ¼ÅŸteri cevapsÄ±z Ã§aÄŸrÄ±larda kalacak.', 'success');
                
                // CevapsÄ±z Ã§aÄŸrÄ±larÄ± yenile
                await renderMissedCalls();
                // Gelen aramalar sayfasÄ±nÄ± da yenile (eÄŸer o sayfadaysak)
                if (document.getElementById('incoming-calls-list')) {
                    await renderIncomingCallsPage();
                }
            } catch (error) {
                console.error('UlaÅŸÄ±lamadÄ± mesajÄ± gÃ¶nderme hatasÄ±:', error);
                showAlert('âŒ Ä°ÅŸlem baÅŸarÄ±sÄ±z: ' + error.message, 'danger');
            }
        };
        
        // UlaÅŸÄ±lamadÄ± olarak iÅŸaretle (mesaj olmadan)
        window.markAsUnreachable = async function(phoneNumber, timeStr) {
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            const notes = `UlaÅŸÄ±lamadÄ± - ${timeStr} tarihinde cevapsÄ±z Ã§aÄŸrÄ±`;
            
            try {
                // CRM'e ekle - branÅŸ bilinmediÄŸi iÃ§in ulaÅŸÄ±lamadÄ± statÃ¼sÃ¼nde kalsÄ±n
                const newLead = {
                    fullName: 'UlaÅŸÄ±lamadÄ± - ' + formattedPhone,
                    phone: formattedPhone,
                    email: '',
                    branch: 'Belirsiz',
                    status: 'lost', // KayÄ±p olarak iÅŸaretle
                    source: 'CevapsÄ±z Ã‡aÄŸrÄ±',
                    notes: notes,
                    clubId: currentClubId,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    tags: ['UlaÅŸÄ±lamadÄ±'],
                    history: [{
                        date: new Date().toISOString(),
                        action: 'UlaÅŸÄ±lamadÄ± olarak iÅŸaretlendi',
                        notes: notes,
                        user: currentUser?.fullName || 'Admin'
                    }]
                };
                
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'crmLeads'),
                    newLead
                );
                
                showAlert('âœ… "UlaÅŸÄ±lamadÄ±" olarak iÅŸaretlendi ve CRM\'e eklendi', 'success');
                
                // CevapsÄ±z Ã§aÄŸrÄ±larÄ± yenile
                await renderMissedCalls();
                
                // CRM'i gÃ¼ncelle
                await loadData();
            } catch (error) {
                console.error('UlaÅŸÄ±lamadÄ± iÅŸaretleme hatasÄ±:', error);
                showAlert('âŒ Ä°ÅŸlem baÅŸarÄ±sÄ±z: ' + error.message, 'danger');
            }
        };
        
        // Manuel olarak cevaplandÄ± iÅŸaretle
        window.markMissedCallAsAnswered = async function(phoneNumber, leadId = null, memberId = null) {
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            const responseMethod = prompt('NasÄ±l iletiÅŸime geÃ§ildi?\n\n1: WhatsApp\'tan Mesaj GÃ¶nderildi\n2: YÃ¼z YÃ¼ze GÃ¶rÃ¼ÅŸÃ¼ldÃ¼\n3: DiÄŸer\n\n(Not: Telefonla aramalar ve mÃ¼ÅŸteri geri aramalarÄ± sistem tarafÄ±ndan otomatik takip edilir)', '1');
            
            if (!responseMethod) return;
            
            // Sadece 1, 2, 3 kabul et
            if (!['1', '2', '3'].includes(responseMethod)) {
                alert('âš ï¸ LÃ¼tfen 1, 2 veya 3 seÃ§eneklerinden birini girin.');
                return;
            }
            
            const methodTexts = {
                '1': 'WhatsApp\'tan mesaj gÃ¶nderildi',
                '2': 'YÃ¼z yÃ¼ze gÃ¶rÃ¼ÅŸÃ¼ldÃ¼',
                '3': 'DiÄŸer yÃ¶ntemle iletiÅŸime geÃ§ildi'
            };
            
            const methodText = methodTexts[responseMethod] || 'Ä°letiÅŸime geÃ§ildi';
            const now = new Date().toISOString();
            const notes = `CevaplandÄ± - ${methodText}`;
            
            try {
                if (leadId) {
                    // CRM'de zaten var - sadece not ekle (Etiketi DEÄÅTME!)
                    const leadRef = window.firebase.doc(window.db, 'crmLeads', leadId);
                    const leadDoc = await window.firebase.getDoc(leadRef);
                    
                    if (leadDoc.exists()) {
                        const lead = leadDoc.data();
                        const updatedHistory = lead.history || [];
                        updatedHistory.push({
                            date: now,
                            action: 'CevapsÄ±z Ã§aÄŸrÄ± cevaplandÄ± (DiÄŸer yolla)',
                            notes: methodText,
                            user: currentUser?.fullName || 'Admin'
                        });
                        
                        // âœ… Etiket deÄŸiÅŸtirme - mevcut etiketleri koru
                        await window.firebase.updateDoc(leadRef, {
                            updatedAt: now,
                            history: updatedHistory,
                            notes: (lead.notes ? lead.notes + '\n' : '') + notes
                        });
                    }
                    
                    showAlert(`âœ… "${methodText}" olarak kaydedildi ve "DiÄŸer" sekmesine taÅŸÄ±ndÄ±`, 'success');
                } else if (memberId) {
                    // Ãœye - sadece bilgi mesajÄ±
                    showAlert(`âœ… Ãœye "${methodText}" olarak not edildi`, 'success');
                } else {
                    // CRM'de yok - yeni kayÄ±t oluÅŸtur (VarsayÄ±lan etiketle)
                const newLead = {
                    fullName: formattedPhone,
                    phone: formattedPhone,
                    email: '',
                    branches: [{
                        branchId: 'general',
                        branchName: 'Genel',
                        selectedTag: '', // âœ… BoÅŸ etiket - kullanÄ±cÄ± seÃ§sin
                        notes: methodText
                    }],
                    source: 'CevapsÄ±z Ã‡aÄŸrÄ± - Manuel',
                    notes: notes,
                    clubId: currentClubId,
                    createdAt: now,
                    updatedAt: now,
                    history: [{
                        date: now,
                        action: 'Manuel olarak cevaplandÄ± iÅŸaretlendi',
                        notes: methodText,
                        user: currentUser?.fullName || 'Admin'
                    }]
                };
                
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'crmLeads'),
                    newLead
                );
                
                showAlert(`âœ… "${methodText}" olarak iÅŸaretlendi ve CRM'e eklendi`, 'success');
                }
                
                // âœ… localStorage'a cevaplandÄ± durumunu TARÄ°H ile kaydet
                const answeredCalls = JSON.parse(localStorage.getItem('answeredMissedCalls') || '[]');
                // Eski format (string array) kontrolÃ¼ - temizle ve yeni formata geÃ§
                if (answeredCalls.length > 0 && typeof answeredCalls[0] === 'string') {
                    localStorage.setItem('answeredMissedCalls', '[]');
                }
                
                const answeredCallsNew = JSON.parse(localStorage.getItem('answeredMissedCalls') || '[]');
                const existingIndex = answeredCallsNew.findIndex(item => item.phone === formattedPhone);
                
                if (existingIndex >= 0) {
                    // Zaten var - tarihi ve metodu gÃ¼ncelle
                    answeredCallsNew[existingIndex].markedDate = now;
                    answeredCallsNew[existingIndex].method = methodText;
                } else {
                    // Yeni ekle
                    answeredCallsNew.push({
                        phone: formattedPhone,
                        markedDate: now,
                        method: methodText // âœ… Hangi yÃ¶ntemle cevaplandÄ±ÄŸÄ±nÄ± kaydet
                    });
                }
                
                localStorage.setItem('answeredMissedCalls', JSON.stringify(answeredCallsNew));
                
                // âœ… CRM verilerini yeniden yÃ¼kle (etiket deÄŸiÅŸikliÄŸi iÃ§in)
                await loadData();
                
                // CevapsÄ±z Ã§aÄŸrÄ±larÄ± yenile
                await renderMissedCalls();
                
                // Gelen aramalar sayfasÄ±nÄ± da yenile (eÄŸer o sayfadaysak)
                if (document.getElementById('incoming-calls-list')) {
                    await renderIncomingCallsPage();
                    // âœ… Sekme deÄŸiÅŸimini kaldÄ±rdÄ±k - kullanÄ±cÄ± hangi sekmede ise orada kalsÄ±n
                }
                
                // CRM sayfasÄ±nÄ± yenile (eÄŸer o sayfadaysak)
                const currentSection = document.querySelector('.nav-btn.active')?.getAttribute('onclick')?.match(/showSection\('([^']+)'/)?.[1];
                if (currentSection === 'crm') {
                    console.log('ğŸ”„ CRM sayfasÄ± yenileniyor (etiket deÄŸiÅŸikliÄŸi iÃ§in)...');
                    renderCRMDashboard();
                }
            } catch (error) {
                console.error('CevaplandÄ± iÅŸaretleme hatasÄ±:', error);
                showAlert('âŒ Ä°ÅŸlem baÅŸarÄ±sÄ±z: ' + error.message, 'danger');
            }
        };
        
        // Ã‡aÄŸrÄ±yÄ± sil (localStorage'da saklanÄ±yor - kalÄ±cÄ±)
        // Dropdown toggle fonksiyonu
        window.toggleCallDropdown = function(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;
            
            // DiÄŸer aÃ§Ä±k dropdown'larÄ± kapat ve z-index'lerini resetle
            document.querySelectorAll('[id^="dropdown-"]').forEach(d => {
                if (d.id !== dropdownId && d.style.display === 'block') {
                    d.style.display = 'none';
                    // Parent kartÄ±n z-index'ini resetle
                    let parentCard = d.closest('div[style*="position: relative"]');
                    if (!parentCard) parentCard = d.closest('div[style*="padding: 15px"]');
                    if (!parentCard) parentCard = d.closest('div[style*="padding: 12px"]');
                    if (parentCard) {
                        parentCard.style.cssText = parentCard.style.cssText.replace(/z-index:\s*\d+\s*!important;?/g, '');
                        parentCard.style.zIndex = '1';
                    }
                }
            });
            
            // Bu dropdown'Ä± aÃ§/kapat
            const isOpening = dropdown.style.display === 'none';
            dropdown.style.display = isOpening ? 'block' : 'none';
            
            // Parent kartÄ±n z-index'ini ayarla - !important ile zorla
            let parentCard = dropdown.closest('div[style*="position: relative"]');
            if (!parentCard) parentCard = dropdown.closest('div[style*="padding: 15px"]');
            if (!parentCard) parentCard = dropdown.closest('div[style*="padding: 12px"]');
            if (parentCard) {
                if (isOpening) {
                    parentCard.style.setProperty('z-index', '1000', 'important');
                } else {
                    parentCard.style.cssText = parentCard.style.cssText.replace(/z-index:\s*\d+\s*!important;?/g, '');
                    parentCard.style.zIndex = '1';
                }
            }
        };
        
        // Sayfa tÄ±klamasÄ±nda dropdown'larÄ± kapat
        document.addEventListener('click', function(e) {
            if (!e.target.closest('[onclick*="toggleCallDropdown"]') && !e.target.closest('[id^="dropdown-"]')) {
                document.querySelectorAll('[id^="dropdown-"]').forEach(d => {
                    if (d.style.display === 'block') {
                        d.style.display = 'none';
                        // Parent kartÄ±n z-index'ini resetle
                        const parentCard = d.closest('[style*="position: relative"]');
                        if (parentCard) parentCard.style.zIndex = '1';
                    }
                });
            }
        });
        
        // GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ± modalÄ±nÄ± gÃ¶ster (CRM'e kaydetmeden)
        window.showCallRecordsModal = async function(phoneNumber) {
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            const modalId = 'callRecordsViewModal';
            
            // Modal var mÄ± kontrol et, yoksa oluÅŸtur
            let modal = document.getElementById(modalId);
            if (!modal) {
                const modalHtml = `
                    <div id="${modalId}" class="modal">
                        <div class="modal-content" style="max-width: 800px;">
                            <h3 style="margin-bottom: 20px;">ğŸ“ GÃ¶rÃ¼ÅŸme KayÄ±tlarÄ±</h3>
                            <div style="background: #f5f5f5; padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                                <div style="font-size: 14px; color: #666;">Telefon NumarasÄ±:</div>
                                <div style="font-size: 18px; font-weight: 600; color: #1976d2;" id="callRecordsPhoneDisplay">${formattedPhone}</div>
                            </div>
                            <div id="callRecordsModalContent" style="max-height: 500px; overflow-y: auto;">
                                <div class="loading"><div class="spinner"></div><span>GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ± yÃ¼kleniyor...</span></div>
                            </div>
                            <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                                <button class="btn btn-primary" onclick="addToCRMFromMissedCall('${formattedPhone}'); closeModal('${modalId}')">
                                    â• CRM'e Ekle
                                </button>
                                <button class="btn btn-secondary" onclick="closeModal('${modalId}')">Kapat</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                modal = document.getElementById(modalId);
            }
            
            // Telefon numarasÄ±nÄ± gÃ¼ncelle
            const phoneDisplay = document.getElementById('callRecordsPhoneDisplay');
            if (phoneDisplay) phoneDisplay.textContent = formattedPhone;
            
            // Modal'Ä± aÃ§
            openModal(modalId);
            
            // GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ±nÄ± yÃ¼kle
            await renderCallRecords(formattedPhone, 'callRecordsModalContent');
        };
        
        window.deleteCall = function(phoneNumber, callType, callTime) {
            try {
                const deletedCall = {
                    phoneNumber: phoneNumber,
                    callType: callType, // 'incoming', 'outgoing'
                    callTime: callTime,
                    deletedAt: new Date().toISOString()
                };
                
                deletedCalls.push(deletedCall);
                saveDeletedCalls();
                
                showAlert('âœ… Ã‡aÄŸrÄ± silindi', 'success');
                
                // Ä°lgili sayfayÄ± yenile
                if (callType === 'incoming') renderIncomingCallsPage();
                if (callType === 'outgoing') renderOutgoingCallsPage();
            } catch (error) {
                console.error('Ã‡aÄŸrÄ± silme hatasÄ±:', error);
                showAlert('âŒ Ã‡aÄŸrÄ± silinemedi: ' + error.message, 'danger');
            }
        };
        
        // Ã‡aÄŸrÄ±yÄ± geri getir
        window.undeleteCall = function(phoneNumber, callType, callTime) {
            try {
                deletedCalls = deletedCalls.filter(dc => 
                    !(dc.phoneNumber === phoneNumber && dc.callType === callType && dc.callTime === callTime)
                );
                saveDeletedCalls();
                
                showAlert('âœ… Ã‡aÄŸrÄ± geri getirildi', 'success');
                
                // SayfayÄ± yenile
                renderCurrentSection();
            } catch (error) {
                console.error('Ã‡aÄŸrÄ± geri getirme hatasÄ±:', error);
                showAlert('âŒ Ä°ÅŸlem baÅŸarÄ±sÄ±z: ' + error.message, 'danger');
            }
        };
        
        // Ã‡aÄŸrÄ±nÄ±n silinmiÅŸ olup olmadÄ±ÄŸÄ±nÄ± kontrol et
        function isCallDeleted(phoneNumber, callType, callTime) {
            return deletedCalls.some(dc => 
                dc.phoneNumber === phoneNumber && 
                dc.callType === callType &&
                dc.callTime === callTime
            );
        }
        
        // Silinenleri gÃ¶ster/gizle toggle
        window.toggleShowDeletedCalls = function() {
            showDeletedCalls = !showDeletedCalls;
            
            // TÃ¼m toggle butonlarÄ±nÄ± gÃ¼ncelle
            const buttons = [
                document.getElementById('toggleDeletedCallsIncomingBtn'),
                document.getElementById('toggleDeletedCallsOutgoingBtn')
            ];
            
            buttons.forEach(btn => {
                if (btn) {
                    btn.textContent = showDeletedCalls ? 'ğŸ‘ï¸ Silinenleri Sakla' : 'ğŸ—‘ï¸ Silinenleri GÃ¶ster';
                    btn.className = showDeletedCalls ? 'btn btn-sm btn-warning' : 'btn btn-sm btn-secondary';
                }
            });
            
            renderCurrentSection();
        };
        
        // Checkbox seÃ§im fonksiyonlarÄ±
        window.toggleSelectAllIncoming = function(checkbox) {
            const checkboxes = document.querySelectorAll('.incoming-call-checkbox');
            selectedIncomingCalls.clear();
            
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                if (checkbox.checked) {
                    selectedIncomingCalls.add(cb.value);
                }
            });
            
            updateBulkDeleteButton('incoming');
        };
        
        window.toggleSelectAllOutgoing = function(checkbox) {
            const checkboxes = document.querySelectorAll('.outgoing-call-checkbox');
            selectedOutgoingCalls.clear();
            
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                if (checkbox.checked) {
                    selectedOutgoingCalls.add(cb.value);
                }
            });
            
            updateBulkDeleteButton('outgoing');
        };
        
        window.toggleIncomingCall = function(checkbox, callKey) {
            if (checkbox.checked) {
                selectedIncomingCalls.add(callKey);
            } else {
                selectedIncomingCalls.delete(callKey);
                document.getElementById('selectAllIncoming').checked = false;
            }
            updateBulkDeleteButton('incoming');
        };
        
        window.toggleOutgoingCall = function(checkbox, callKey) {
            if (checkbox.checked) {
                selectedOutgoingCalls.add(callKey);
            } else {
                selectedOutgoingCalls.delete(callKey);
                document.getElementById('selectAllOutgoing').checked = false;
            }
            updateBulkDeleteButton('outgoing');
        };
        
        function updateBulkDeleteButton(callType) {
            const selectedCount = callType === 'incoming' ? selectedIncomingCalls.size : selectedOutgoingCalls.size;
            const btnId = callType === 'incoming' ? 'bulkDeleteIncomingBtn' : 'bulkDeleteOutgoingBtn';
            const btn = document.getElementById(btnId);
            
            if (btn) {
                if (selectedCount > 0) {
                    btn.textContent = `ğŸ—‘ï¸ SeÃ§ilenleri Sil (${selectedCount})`;
                    btn.disabled = false;
                    btn.className = 'btn btn-sm btn-danger';
                } else {
                    btn.textContent = 'ğŸ—‘ï¸ SeÃ§ilenleri Sil';
                    btn.disabled = true;
                    btn.className = 'btn btn-sm btn-secondary';
                }
            }
        }
        
        // Toplu silme fonksiyonlarÄ± - SeÃ§ilenleri sil
        // Gelen aramalar iÃ§in silme modunu aÃ§
        window.showIncomingDeleteMode = function() {
            // Checkbox'larÄ± gÃ¶ster
            document.querySelectorAll('.incoming-call-checkbox').forEach(cb => {
                cb.style.display = 'block';
                cb.parentElement.style.display = 'block';
            });
            document.getElementById('selectAllIncomingLabel').style.display = 'flex';
            
            // ButonlarÄ± deÄŸiÅŸtir
            document.getElementById('showDeleteModeIncomingBtn').style.display = 'none';
            document.getElementById('confirmDeleteIncomingBtn').style.display = 'inline-block';
            document.getElementById('cancelDeleteIncomingBtn').style.display = 'inline-block';
        };
        
        // Gelen aramalar silmeyi iptal et
        window.cancelIncomingDeleteMode = function() {
            // Checkbox'larÄ± gizle
            document.querySelectorAll('.incoming-call-checkbox').forEach(cb => {
                cb.style.display = 'none';
                cb.parentElement.style.display = 'none';
                cb.checked = false;
            });
            document.getElementById('selectAllIncomingLabel').style.display = 'none';
            document.getElementById('selectAllIncoming').checked = false;
            
            // SeÃ§imleri temizle
            selectedIncomingCalls.clear();
            
            // ButonlarÄ± deÄŸiÅŸtir
            document.getElementById('showDeleteModeIncomingBtn').style.display = 'inline-block';
            document.getElementById('confirmDeleteIncomingBtn').style.display = 'none';
            document.getElementById('cancelDeleteIncomingBtn').style.display = 'none';
        };
        
        // Gelen aramalarÄ± onayla ve sil
        window.confirmDeleteIncomingCalls = async function() {
            if (selectedIncomingCalls.size === 0) {
                showAlert('âš ï¸ LÃ¼tfen silmek istediÄŸiniz aramalarÄ± seÃ§in', 'warning');
                return;
            }
            
            if (!confirm(`SeÃ§ili ${selectedIncomingCalls.size} aramayÄ± kalÄ±cÄ± olarak silmek istediÄŸinize emin misiniz?`)) {
                return;
            }
            
            await bulkDeleteIncomingCalls();
            cancelIncomingDeleteMode();
        };
        
        window.bulkDeleteIncomingCalls = async function() {
            if (selectedIncomingCalls.size === 0) {
                return;
            }
            
            try {
                // SeÃ§ili aramalarÄ± sil
                selectedIncomingCalls.forEach(callKey => {
                    const [phoneNumber, callTime] = callKey.split('|');
                    const deletedCall = {
                        phoneNumber: phoneNumber,
                        callType: 'incoming',
                        callTime: callTime,
                        deletedAt: new Date().toISOString()
                    };
                    deletedCalls.push(deletedCall);
                });
                
                saveDeletedCalls();
                const deletedCount = selectedIncomingCalls.size;
                selectedIncomingCalls.clear();
                
                showAlert(`âœ… ${deletedCount} gelen arama silindi`, 'success');
                renderIncomingCallsPage();
            } catch (error) {
                console.error('Toplu silme hatasÄ±:', error);
                showAlert('âŒ Toplu silme baÅŸarÄ±sÄ±z: ' + error.message, 'danger');
            }
        };
        
        // Giden aramalar iÃ§in silme modunu aÃ§
        window.showOutgoingDeleteMode = function() {
            // Checkbox'larÄ± gÃ¶ster
            document.querySelectorAll('.outgoing-call-checkbox').forEach(cb => {
                cb.style.display = 'block';
                cb.parentElement.style.display = 'block';
            });
            document.getElementById('selectAllOutgoingLabel').style.display = 'flex';
            
            // ButonlarÄ± deÄŸiÅŸtir
            document.getElementById('showDeleteModeOutgoingBtn').style.display = 'none';
            document.getElementById('confirmDeleteOutgoingBtn').style.display = 'inline-block';
            document.getElementById('cancelDeleteOutgoingBtn').style.display = 'inline-block';
        };
        
        // Giden aramalar silmeyi iptal et
        window.cancelOutgoingDeleteMode = function() {
            // Checkbox'larÄ± gizle
            document.querySelectorAll('.outgoing-call-checkbox').forEach(cb => {
                cb.style.display = 'none';
                cb.parentElement.style.display = 'none';
                cb.checked = false;
            });
            document.getElementById('selectAllOutgoingLabel').style.display = 'none';
            document.getElementById('selectAllOutgoing').checked = false;
            
            // SeÃ§imleri temizle
            selectedOutgoingCalls.clear();
            
            // ButonlarÄ± deÄŸiÅŸtir
            document.getElementById('showDeleteModeOutgoingBtn').style.display = 'inline-block';
            document.getElementById('confirmDeleteOutgoingBtn').style.display = 'none';
            document.getElementById('cancelDeleteOutgoingBtn').style.display = 'none';
        };
        
        // Giden aramalarÄ± onayla ve sil
        window.confirmDeleteOutgoingCalls = async function() {
            if (selectedOutgoingCalls.size === 0) {
                showAlert('âš ï¸ LÃ¼tfen silmek istediÄŸiniz aramalarÄ± seÃ§in', 'warning');
                return;
            }
            
            if (!confirm(`SeÃ§ili ${selectedOutgoingCalls.size} aramayÄ± kalÄ±cÄ± olarak silmek istediÄŸinize emin misiniz?`)) {
                return;
            }
            
            await bulkDeleteOutgoingCalls();
            cancelOutgoingDeleteMode();
        };
        
        window.bulkDeleteOutgoingCalls = async function() {
            if (selectedOutgoingCalls.size === 0) {
                return;
            }
            
            try {
                // SeÃ§ili aramalarÄ± sil
                selectedOutgoingCalls.forEach(callKey => {
                    const [phoneNumber, callTime] = callKey.split('|');
                    const deletedCall = {
                        phoneNumber: phoneNumber,
                        callType: 'outgoing',
                        callTime: callTime,
                        deletedAt: new Date().toISOString()
                    };
                    deletedCalls.push(deletedCall);
                });
                
                saveDeletedCalls();
                const deletedCount = selectedOutgoingCalls.size;
                selectedOutgoingCalls.clear();
                
                showAlert(`âœ… ${deletedCount} giden arama silindi`, 'success');
                renderOutgoingCallsPage();
            } catch (error) {
                console.error('Toplu silme hatasÄ±:', error);
                showAlert('âŒ Toplu silme baÅŸarÄ±sÄ±z: ' + error.message, 'danger');
            }
        };
        
        // CevapsÄ±z Ã§aÄŸrÄ± mesajÄ± gÃ¶nder
        window.sendMissedCallMessage = async function(phoneNumber, timeStr) {
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            let formattedPhone = cleanPhone;
            if (cleanPhone.startsWith('90') && cleanPhone.length === 12) {
                formattedPhone = '0' + cleanPhone.slice(2);
            } else if (!cleanPhone.startsWith('0') && cleanPhone.length === 10) {
                formattedPhone = '0' + cleanPhone;
            }
            
            // Mesaj ÅŸablonu
            const clubName = clubSettings.clubName || 'Sporcum';
            const messageTemplate = `Merhaba,\n\n${clubName} olarak size ulaÅŸmaya Ã§alÄ±ÅŸtÄ±k ancak ulaÅŸamadÄ±k.\n\nBize ${timeStr} tarihinde bir cevapsÄ±z Ã§aÄŸrÄ±nÄ±z dÃ¼ÅŸmÃ¼ÅŸtÃ¼r.\n\nSizinle gÃ¶rÃ¼ÅŸmek ve sorularÄ±nÄ±zÄ± yanÄ±tlamak isteriz. LÃ¼tfen uygun olduÄŸunuzda bizi arayÄ±nÄ±z.\n\nTeÅŸekkÃ¼rler,\n${clubName} Ekibi`;
            
            if (!confirm(`${formattedPhone} numarasÄ±na aÅŸaÄŸÄ±daki mesajÄ± gÃ¶ndermek istiyor musunuz?\n\n${messageTemplate}`)) {
                return;
            }
            
            try {
                // WhatsApp cihazÄ±nÄ± kontrol et
                if (!defaultWhatsAppDevice) {
                    showAlert('âš ï¸ WhatsApp cihazÄ± yapÄ±landÄ±rÄ±lmamÄ±ÅŸ. LÃ¼tfen ayarlardan WhatsApp entegrasyonunu yapÄ±landÄ±rÄ±n.', 'warning');
                    return;
                }
                
                // MesajÄ± kuyruÄŸa ekle
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'messageQueue'),
                    {
                        clubId: currentClubId,
                        phone: formattedPhone,
                        message: messageTemplate,
                        deviceId: defaultWhatsAppDevice,
                        scheduledFor: new Date().toISOString(),
                        status: 'pending',
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser?.fullName || 'Admin',
                        type: 'missed_call_notification'
                    }
                );
                
                showAlert('âœ… Mesaj kuyruÄŸa eklendi ve en kÄ±sa sÃ¼rede gÃ¶nderilecek', 'success');
                
                // CevapsÄ±z Ã§aÄŸrÄ±larÄ± yenile
                await renderMissedCalls();
            } catch (error) {
                console.error('Mesaj gÃ¶nderme hatasÄ±:', error);
                showAlert('âŒ Mesaj gÃ¶nderilemedi: ' + error.message, 'danger');
            }
        };
        
        // Bulutfon checkbox toggle
        window.addEventListener('DOMContentLoaded', function() {
            const bulutfonCheckbox = document.getElementById('bulutfonEnabled');
            const bulutfonSettings = document.getElementById('bulutfon-api-settings');
            
            if (bulutfonCheckbox && bulutfonSettings) {
                bulutfonCheckbox.addEventListener('change', function() {
                    bulutfonSettings.style.display = this.checked ? 'block' : 'none';
                });
                
                // Sayfa yÃ¼klendiÄŸinde mevcut duruma gÃ¶re ayarla
                if (clubSettings && clubSettings.bulutfonEnabled) {
                    bulutfonCheckbox.checked = true;
                    bulutfonSettings.style.display = 'block';
                    if (clubSettings.bulutfonApiKey) {
                        document.getElementById('bulutfonApiKey').value = clubSettings.bulutfonApiKey;
                    }
                }
            }
            
            // âœ… Webhook Checkbox Event Listener
            const webhookCheckbox = document.getElementById('webhookEnabled');
            const webhookSettings = document.getElementById('webhook-settings');
            
            if (webhookCheckbox && webhookSettings) {
                webhookCheckbox.addEventListener('change', function() {
                    webhookSettings.style.display = this.checked ? 'block' : 'none';
                });
                
                // Load webhook settings from Firebase
                loadWebhookSettings();
            }
        });
        
        // âœ… Load Webhook Settings
        async function loadWebhookSettings() {
            try {
                const webhookDoc = await window.firebase.getDoc(
                    window.firebase.doc(window.db, 'webhooks', `contract_${currentClubId}`)
                );
                
                if (webhookDoc.exists()) {
                    const webhookData = webhookDoc.data();
                    const webhookCheckbox = document.getElementById('webhookEnabled');
                    const webhookSettings = document.getElementById('webhook-settings');
                    const webhookUrl = document.getElementById('webhookUrl');
                    
                    if (webhookCheckbox && webhookData.active) {
                        webhookCheckbox.checked = true;
                        if (webhookSettings) webhookSettings.style.display = 'block';
                    }
                    
                    if (webhookUrl && webhookData.url) {
                        webhookUrl.value = webhookData.url;
                    }
                }
            } catch (error) {
                console.error('Webhook ayarlarÄ± yÃ¼klenirken hata:', error);
            }
        }
        
        // âœ… Test Webhook Function
        window.testWebhook = async function() {
            const webhookUrl = document.getElementById('webhookUrl').value;
            
            if (!webhookUrl || webhookUrl.trim() === '') {
                showAlert('âš ï¸ LÃ¼tfen Ã¶nce Webhook URL giriniz', 'warning');
                return;
            }
            
            try {
                showAlert('ğŸ”„ Webhook test ediliyor...', 'info');
                
                const testPayload = {
                    event: 'contract_signed_test',
                    Ad_Soyad: 'Test KullanÄ±cÄ±',
                    Telefon: '05551234567',
                    TC_Kimlik_No: '12345678901',
                    Adres: 'Test Adresi',
                    branch: 'test',
                    paymentPlan: [],
                    contractPdfBase64: 'data:application/pdf;base64,test',
                    preRegistrationId: 'test-123',
                    timestamp: new Date().toISOString(),
                    isTest: true
                };
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testPayload)
                });
                
                if (response.ok) {
                    showAlert(`âœ… Webhook test baÅŸarÄ±lÄ±! (${response.status} ${response.statusText})`, 'success');
                } else {
                    showAlert(`âš ï¸ Webhook yanÄ±t verdi ama hata kodu: ${response.status} ${response.statusText}`, 'warning');
                }
            } catch (error) {
                console.error('Webhook test hatasÄ±:', error);
                showAlert('âŒ Webhook test baÅŸarÄ±sÄ±z! URL\'yi kontrol edin. CORS hatasÄ± olabilir.', 'danger');
            }
        };
        
        // Bulutfon baÄŸlantÄ±sÄ±nÄ± test et
        window.testBulutfonConnection = async function() {
            const apiKey = document.getElementById('bulutfonApiKey').value;
            
            if (!apiKey || apiKey.trim() === '') {
                showAlert('âš ï¸ LÃ¼tfen Ã¶nce API Key giriniz', 'warning');
                return;
            }
            
            try {
                showAlert('ğŸ”„ BaÄŸlantÄ± test ediliyor...', 'info');
                
                const response = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${apiKey}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const recordCount = Array.isArray(data) ? data.length : (data.data?.length || 0);
                
                showAlert(`âœ… BaÄŸlantÄ± baÅŸarÄ±lÄ±! ${recordCount} adet gÃ¶rÃ¼ÅŸme kaydÄ± bulundu.`, 'success');
            } catch (error) {
                console.error('Bulutfon test hatasÄ±:', error);
                showAlert('âŒ BaÄŸlantÄ± baÅŸarÄ±sÄ±z! API Key\'inizi kontrol edin veya Bulutfon desteÄŸi ile iletiÅŸime geÃ§in.', 'danger');
            }
        };
        
        // Telefon numarasÄ±na tÄ±klayÄ±nca kopyala
        window.handlePhoneClick = function(event, phoneNumber) {
            event.preventDefault();
            event.stopPropagation();
            
            if (!phoneNumber) return;
            
            const message = `ğŸ“‹ ${formatPhoneDisplay(phoneNumber)} kopyalandÄ±!`;
            
            // Clipboard API ile kopyala
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(phoneNumber)
                    .then(() => {
                        showAlert(message, 'success');
                    })
                    .catch(err => {
                        console.error('Kopyalama hatasÄ±:', err);
                        // Fallback: Eski yÃ¶ntem
                        fallbackCopyToClipboard(phoneNumber, message);
                    });
            } else {
                // Eski tarayÄ±cÄ±lar iÃ§in fallback
                fallbackCopyToClipboard(phoneNumber, message);
            }
        };
        
        function renderBranchDistribution() {
            const container = document.getElementById('branch-distribution');
            if (!container) return;
            
            const branchCounts = {};
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        const branchName = branches.find(b => b.id === br.branchId)?.name || 'Bilinmiyor';
                        branchCounts[branchName] = (branchCounts[branchName] || 0) + 1;
                    });
                }
            });
            
            const total = Object.values(branchCounts).reduce((a, b) => a + b, 0);
            const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a'];
            
            if (total === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">HenÃ¼z branÅŸ verisi yok</p></div>';
                return;
            }
            
            container.innerHTML = Object.entries(branchCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([branchName, count], idx) => {
                    const percentage = ((count / total) * 100).toFixed(1);
                    const color = colors[idx % colors.length];
                    return `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="font-weight: 600; font-size: 14px;">${branchName}</span>
                                <span style="font-weight: 600; color: ${color};">${count} (${percentage}%)</span>
                            </div>
                            <div style="background: #f0f0f0; border-radius: 10px; height: 10px; overflow: hidden;">
                                <div style="background: ${color}; height: 100%; width: ${percentage}%; border-radius: 10px; transition: width 0.5s;"></div>
                            </div>
                        </div>
                    `;
                }).join('');
        }
        
        function renderTagDistribution() {
            const container = document.getElementById('tag-distribution');
            if (!container) return;
            
            const tagCounts = {};
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        if (br.selectedTag) {
                            tagCounts[br.selectedTag] = (tagCounts[br.selectedTag] || 0) + 1;
                        }
                        if (br.ageGroup === 'child' && br.children) {
                            br.children.forEach(c => {
                                if (c.selectedTag) {
                                    tagCounts[c.selectedTag] = (tagCounts[c.selectedTag] || 0) + 1;
                                }
                            });
                        }
                    });
                }
            });
            
            const total = Object.values(tagCounts).reduce((a, b) => a + b, 0);
            const colors = ['#f093fb', '#4facfe', '#43e97b', '#fa709a', '#667eea'];
            
            if (total === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">HenÃ¼z etiket verisi yok</p></div>';
                return;
            }
            
            container.innerHTML = Object.entries(tagCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([tagName, count], idx) => {
                    const percentage = ((count / total) * 100).toFixed(1);
                    const color = colors[idx % colors.length];
                    return `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="font-weight: 600; font-size: 14px;">ğŸ·ï¸ ${tagName}</span>
                                <span style="font-weight: 600; color: ${color};">${count} (${percentage}%)</span>
                            </div>
                            <div style="background: #f0f0f0; border-radius: 10px; height: 10px; overflow: hidden;">
                                <div style="background: ${color}; height: 100%; width: ${percentage}%; border-radius: 10px; transition: width 0.5s;"></div>
                            </div>
                        </div>
                    `;
                }).join('');
        }
        
        function renderAccumulationAnalysis() {
            const container = document.getElementById('accumulation-analysis');
            if (!container) return;
            
            // Hangi branÅŸ+etiket kombinasyonlarÄ±nda en Ã§ok birikme var
            const combinations = {};
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        const branchName = branches.find(b => b.id === br.branchId)?.name || 'Bilinmiyor';
                        const tag = br.selectedTag || 'Etiketsiz';
                        const key = `${branchName} - ${tag}`;
                        combinations[key] = (combinations[key] || 0) + 1;
                        
                        if (br.ageGroup === 'child' && br.children) {
                            br.children.forEach(c => {
                                const childTag = c.selectedTag || 'Etiketsiz';
                                const childKey = `${branchName} - ${childTag}`;
                                combinations[childKey] = (combinations[childKey] || 0) + 1;
                            });
                        }
                    });
                }
            });
            
            const sortedCombo = Object.entries(combinations)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            if (sortedCombo.length === 0) {
                container.innerHTML = '<div class="empty-state"><p style="padding: 20px; color: #999;">HenÃ¼z veri yok</p></div>';
                return;
            }
            
            const maxCount = sortedCombo[0][1];
            
            container.innerHTML = `
                <div style="display: grid; gap: 12px;">
                    ${sortedCombo.map(([combo, count]) => {
                        const percentage = ((count / maxCount) * 100);
                        return `
                            <div style="padding: 15px; background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border-radius: 10px; border-left: 4px solid #667eea;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 5px;">${combo}</div>
                                        <div style="background: #e3f2fd; border-radius: 10px; height: 8px; width: ${Math.max(percentage, 10)}px; max-width: 300px; transition: width 0.5s;"></div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 24px; font-weight: 700; color: #667eea;">${count}</div>
                                        <div style="font-size: 11px; color: #888;">MÃ¼ÅŸteri</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // CRM Leads Listesi
        function renderCRMLeads() {
            const container = document.getElementById('crm-leads-list');
            if (!container) return;
            
            const statusFilter = document.getElementById('crm-status-filter')?.value || 'all';
            const branchFilter = document.getElementById('crm-branch-filter')?.value || 'all';
            
            let filteredLeads = crmLeads;
            
            if (statusFilter !== 'all') {
                filteredLeads = filteredLeads.filter(l => l.status === statusFilter);
            }
            
            if (branchFilter !== 'all') {
                filteredLeads = filteredLeads.filter(l => l.branch === branchFilter);
            }
            
            // âœ… Ek filtreler buraya eklenebilir (mÃ¼ÅŸteri filtrele, denemeler, etiketler)
            
            if (filteredLeads.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>KayÄ±t bulunamadÄ±</h3>
                        <p>Filtrelerinizi deÄŸiÅŸtirin veya yeni kayÄ±t ekleyin</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ad Soyad</th>
                            <th>Telefon</th>
                            <th>BranÅŸ</th>
                            <th>Durum</th>
                            <th>Ãœyelik</th>
                            <th>Kaynak</th>
                            <th>Deneme Tarihi</th>
                            <th>OluÅŸturma</th>
                            <th>Ä°ÅŸlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredLeads.map(lead => {
                            const status = crmStatuses.find(s => s.id === lead.status);
                            const branch = branches.find(b => b.id === lead.branch);
                            const trialDateFormatted = lead.trialDate ? 
                                new Date(lead.trialDate).toLocaleString('tr-TR', { 
                                    year: 'numeric', month: '2-digit', day: '2-digit',
                                    hour: '2-digit', minute: '2-digit'
                                }) : '-';
                            const createdFormatted = new Date(lead.createdAt).toLocaleDateString('tr-TR');
                            
                            // âœ… Ãœye kontrolÃ¼ - telefon numarasÄ±na gÃ¶re
                            const memberMatch = members.find(m => phonesMatch(m.Telefon, lead.phone) || phonesMatch(m.Telefon_2, lead.phone));
                            const membershipBadge = memberMatch ? 
                                `<span style="background: #4CAF5015; color: #4CAF50; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer;" onclick="showMemberAttendancePage('${memberMatch.id}')" title="Ãœye detaylarÄ±nÄ± gÃ¶rÃ¼ntÃ¼le">
                                    âœ… Ãœye
                                </span>` : 
                                `<span style="background: #99999915; color: #999; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                    â– Ãœye DeÄŸil
                                </span>`;
                            
                            return `
                                <tr>
                                    <td><strong style="cursor: pointer; color: var(--primary-color); text-decoration: underline;" onclick="openCustomerDetail('${lead.id}')">${lead.fullName}</strong></td>
                                    <td><a href="#" class="phone-link" onclick="handlePhoneClick(event, '${lead.phone}')">${lead.phone}</a></td>
                                    <td>${branch ? branch.icon + ' ' + branch.name : '-'}</td>
                                    <td>
                                        <span style="background: ${status?.color}15; color: ${status?.color}; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                            ${status?.icon} ${status?.name}
                                        </span>
                                    </td>
                                    <td>${membershipBadge}</td>
                                    <td>${getSourceName(lead.source)}</td>
                                    <td>${trialDateFormatted}</td>
                                    <td>${createdFormatted}</td>
                                    <td>
                                        <button class="btn btn-sm btn-success" onclick="openCustomerDetail('${lead.id}')" title="Detay">ğŸ‘¤</button>
                                        ${memberMatch ? `<button class="btn btn-sm btn-info" onclick="showMemberAttendancePage('${memberMatch.id}')" title="Ãœye SayfasÄ±">ğŸ‘¥</button>` : ''}
                                        <button class="btn btn-sm btn-danger" onclick="deleteLead('${lead.id}')" title="Sil">ğŸ—‘ï¸</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // WhatsApp ile lead aÃ§
        function openWhatsAppWithLead(leadId) {
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) return;
            
            // WhatsApp sayfasÄ±na geÃ§
            showSection('whatsapp', document.querySelector('.nav-btn[onclick*="whatsapp"]'));
            
            // KÄ±sa bir gecikme ile lead'i seÃ§ (sayfa yÃ¼klenmesini beklemek iÃ§in)
            setTimeout(() => {
                // WhatsApp contact'Ä± bul veya oluÅŸtur
                const normalizedPhone = lead.phone.replace(/\D/g, '');
                
                // EÄŸer contact listede varsa seÃ§
                const contactElement = document.querySelector(`[data-phone="${normalizedPhone}"]`);
                if (contactElement) {
                    contactElement.click();
                } else {
                    // Yeni mesaj baÅŸlat
                    showToast(`ğŸ’¬ ${lead.fullName} ile WhatsApp mesajlaÅŸmasÄ± baÅŸlatÄ±lÄ±yor...`, 'info');
                }
            }, 500);
        }

        // ============================================
        // âœ… CRM FILTER FUNCTIONS
        // ============================================
        
        // MÃ¼ÅŸteri yaÅŸÄ±nÄ± hesapla (doÄŸum tarihinden)
        function getCustomerAge(lead) {
            if (!lead.branches || lead.branches.length === 0) return 999; // Bilinmeyen yaÅŸ iÃ§in bÃ¼yÃ¼k deÄŸer
            
            let oldestAge = 0;
            
            lead.branches.forEach(branchData => {
                // YetiÅŸkin yaÅŸ grubu iÃ§in parentBirthDate'i kontrol et
                if (branchData.ageGroup === 'adult' && branchData.parentBirthDate) {
                    const birthDate = new Date(branchData.parentBirthDate);
                    const today = new Date();
                    const age = today.getFullYear() - birthDate.getFullYear();
                    const monthDiff = today.getMonth() - birthDate.getMonth();
                    const adjustedAge = (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) ? age - 1 : age;
                    if (adjustedAge > oldestAge) oldestAge = adjustedAge;
                }
                
                // Ã‡ocuk yaÅŸ grubu iÃ§in children array'indeki yaÅŸ bilgisini kontrol et
                if (branchData.ageGroup === 'child' && branchData.children && branchData.children.length > 0) {
                    branchData.children.forEach(child => {
                        // Ã–nce direkt age alanÄ±nÄ± kontrol et
                        if (child.age && !isNaN(child.age)) {
                            const childAge = parseInt(child.age);
                            if (childAge > oldestAge) oldestAge = childAge;
                        } 
                        // Yoksa birthDate'den hesapla
                        else if (child.birthDate) {
                            const birthDate = new Date(child.birthDate);
                            const today = new Date();
                            const age = today.getFullYear() - birthDate.getFullYear();
                            const monthDiff = today.getMonth() - birthDate.getMonth();
                            const adjustedAge = (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) ? age - 1 : age;
                            if (adjustedAge > oldestAge) oldestAge = adjustedAge;
                        }
                    });
                }
            });
            
            return oldestAge || 999; // YaÅŸ bulunamazsa bÃ¼yÃ¼k deÄŸer dÃ¶ndÃ¼r
        }
        
        // MÃ¼ÅŸterinin son iÅŸlem tarihini al
        function getLastActionDate(lead) {
            let lastDate = null;
            
            // updatedAt varsa kullan
            if (lead.updatedAt) {
                lastDate = new Date(lead.updatedAt);
            }
            
            // createdAt varsa karÅŸÄ±laÅŸtÄ±r
            if (lead.createdAt) {
                const createdDate = new Date(lead.createdAt);
                if (!lastDate || createdDate > lastDate) {
                    lastDate = createdDate;
                }
            }
            
            // History'deki en son tarihi bul
            if (lead.history && lead.history.length > 0) {
                lead.history.forEach(h => {
                    if (h.date) {
                        // TÃ¼rkÃ§e tarih formatÄ±nÄ± parse et (DD/MM/YYYY, HH:MM)
                        const dateParts = h.date.split(/[\s,/:]+/);
                        if (dateParts.length >= 5) {
                            const day = parseInt(dateParts[0]);
                            const month = parseInt(dateParts[1]) - 1;
                            const year = parseInt(dateParts[2]);
                            const hour = parseInt(dateParts[3]);
                            const minute = parseInt(dateParts[4]);
                            const historyDate = new Date(year, month, day, hour, minute);
                            
                            if (!lastDate || historyDate > lastDate) {
                                lastDate = historyDate;
                            }
                        }
                    }
                });
            }
            
            return lastDate;
        }
        
        // MÃ¼ÅŸteri filtrelerini uygula
        window.applyCustomerFilters = function(exportMode = false) {
            const branchFilter = document.getElementById('filter-branch')?.value || 'all';
            const ageGroupFilter = document.getElementById('filter-age-group')?.value || 'all';
            const tagFilter = document.getElementById('filter-tag')?.value || 'all';
            const searchText = document.getElementById('filter-search')?.value.toLowerCase() || '';
            const dateStart = document.getElementById('filter-date-start')?.value || '';
            const dateEnd = document.getElementById('filter-date-end')?.value || '';
            
            // âœ… Ä°lk aÃ§Ä±lÄ±ÅŸta hiÃ§bir filtre seÃ§ili deÄŸilse, mÃ¼ÅŸterileri gÃ¶sterme
            const noFilterSelected = branchFilter === 'all' && 
                                     ageGroupFilter === 'all' && 
                                     tagFilter === 'all' && 
                                     searchText === '' && 
                                     dateStart === '' && 
                                     dateEnd === '';
            
            if (noFilterSelected && !exportMode) {
                const tableBody = document.getElementById('filter-customer-list');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-5">
                                <i data-lucide="filter" class="text-muted mb-3" style="width:48px;height:48px;"></i>
                                <p class="text-muted mb-0">LÃ¼tfen bir filtre seÃ§in veya arama yapÄ±n</p>
                            </td>
                        </tr>
                    `;
                    lucide.createIcons();
                }
                return [];
            }
            
            // Telefon aramasÄ± iÃ§in boÅŸluksuz versiyonu da hazÄ±rla
            const searchTextNoSpaces = searchText.replace(/\s/g, '');
            
            // âœ… CRM mÃ¼ÅŸterileri + Ãœyeleri birleÅŸtir
            let filtered = [...crmLeads];
            
            // âœ… Ãœyeleri de ekle (CRM'de olmayan)
            members.forEach(member => {
                // âœ… Ã‡ocuÄŸun 2 telefonu varsa (Veli 1 ve Veli 2) her ikisi iÃ§in de kayÄ±t oluÅŸtur
                const phones = [];
                const phone1 = cleanPhoneNumber(member.Telefon);
                const phone2 = cleanPhoneNumber(member.Telefon_2);
                
                if (phone1 && phone1.length >= 10) phones.push({ phone: phone1, veliName: member.Ad_Soyad || '' });
                if (phone2 && phone2.length >= 10) phones.push({ phone: phone2, veliName: member.Veli_2_Adi_Soyadi || '' });
                
                phones.forEach((phoneData, phoneIndex) => {
                    const memberPhone = phoneData.phone;
                    const veliName = phoneData.veliName;
                    
                    // CRM'de zaten var mÄ± kontrol et
                    const existsInCRM = crmLeads.some(l => phonesMatch(l.phone, memberPhone));
                    if (!existsInCRM) {
                        // BranÅŸ bilgisini bul
                        const memberBranch = branches.find(b => b.name === member.Brans);
                        const branchId = memberBranch?.id || '';
                        const branchName = member.Brans || 'Bilinmeyen';
                        
                        // Ã‡ocuk mu yetiÅŸkin mi?
                        const isChild = member.Resit_Olmayan_Adi_Soyadi && member.Resit_Olmayan_Adi_Soyadi.trim() !== '';
                        
                        // âœ… fullName'i dÃ¼zgÃ¼n set et (arama iÃ§in Ã¶nemli)
                        let displayName = '';
                        let searchableName = '';
                        
                        if (isChild) {
                            // Ã‡ocuk: Her veli iÃ§in ayrÄ± searchableName
                            displayName = member.Resit_Olmayan_Adi_Soyadi;
                            searchableName = `${member.Resit_Olmayan_Adi_Soyadi} ${veliName || member.Ad_Soyad || ''}`; // Hem Ã§ocuk hem ilgili veli ismiyle aranabilir
                        } else {
                            // YetiÅŸkin
                            displayName = member.Ad_Soyad || '';
                            searchableName = member.Ad_Soyad || '';
                        }
                        
                        // Ãœyeyi CRM formatÄ±na Ã§evir
                        const memberAsLead = {
                            id: `member_${member.id}_${phoneIndex}`, // âœ… Her telefon iÃ§in unique ID
                            fullName: displayName,
                            searchableName: searchableName,
                            phone: memberPhone,
                            source: 'member',
                            status: 'converted',
                            isMember: true,
                            memberId: member.id,
                            branches: [{
                                branchId: branchId,
                                branchName: branchName,
                                ageGroup: isChild ? 'child' : 'adult',
                                fullName: displayName,
                                parentName: veliName || (isChild ? (member.Ad_Soyad || '') : ''),
                                selectedTag: 'Ãœye',
                                children: isChild ? [{
                                    name: member.Resit_Olmayan_Adi_Soyadi,
                                    age: member.studentBirthDate ? calculateAge(member.studentBirthDate) : '',
                                    selectedTag: 'Ãœye'
                                }] : []
                            }],
                            createdAt: member.registrationDate || member.createdAt || new Date().toISOString(),
                            history: []
                        };
                        filtered.push(memberAsLead);
                    }
                });
            });
            
            // BranÅŸ filtresi - En az bir branÅŸÄ± eÅŸleÅŸmeli
            if (branchFilter !== 'all') {
                filtered = filtered.filter(l => {
                    if (!l.branches || l.branches.length === 0) return false;
                    return l.branches.some(b => b.branchId === branchFilter);
                });
            }
            
            // YaÅŸ grubu filtresi - BranÅŸ seviyesinde kontrol et
            if (ageGroupFilter !== 'all') {
                filtered = filtered.filter(l => {
                    if (!l.branches || l.branches.length === 0) return false;
                    return l.branches.some(b => b.ageGroup === ageGroupFilter);
                });
            }
            
            // Etiket filtresi - BranÅŸ ve Ã§ocuk etiketlerini kontrol et
            if (tagFilter !== 'all') {
                filtered = filtered.filter(l => {
                    if (!l.branches || l.branches.length === 0) return false;
                    return l.branches.some(b => {
                        // BranÅŸ etiketi kontrolÃ¼ (yetiÅŸkinler iÃ§in)
                        if (b.selectedTag === tagFilter) return true;
                        // Ã‡ocuk etiketleri kontrolÃ¼
                        if (b.children && b.children.length > 0) {
                            return b.children.some(c => c.selectedTag === tagFilter);
                        }
                        return false;
                    });
                });
            }
            
            // Son Ä°ÅŸlem Tarihi Filtresi
            if (dateStart || dateEnd) {
                filtered = filtered.filter(l => {
                    const lastActionDate = getLastActionDate(l);
                    if (!lastActionDate) return false;
                    
                    // Sadece tarih kÄ±smÄ±nÄ± karÅŸÄ±laÅŸtÄ±r (saat dahil etme)
                    const actionDateOnly = new Date(lastActionDate.getFullYear(), lastActionDate.getMonth(), lastActionDate.getDate());
                    
                    if (dateStart) {
                        const startDate = new Date(dateStart);
                        if (actionDateOnly < startDate) return false;
                    }
                    
                    if (dateEnd) {
                        const endDate = new Date(dateEnd);
                        if (actionDateOnly > endDate) return false;
                    }
                    
                    return true;
                });
            }
            
            // Arama filtresi - Ä°sim, telefon, veli ismi, Ã§ocuk isimlerinde ara
            if (searchText) {
                filtered = filtered.filter(l => {
                    // Telefon ve genel isim
                    if (l.fullName && l.fullName.toLowerCase().includes(searchText)) return true;
                    
                    // âœ… searchableName alanÄ±nda ara (Ã¼yeler iÃ§in veli ismi de dahil)
                    if (l.searchableName && l.searchableName.toLowerCase().includes(searchText)) return true;
                    
                    // Telefon aramasÄ± - tÃ¼m rakam olmayan karakterleri temizleyerek ara
                    // EÄŸer arama metni sayÄ± iÃ§eriyorsa telefon olarak deÄŸerlendir
                    if (/\d/.test(searchText)) {
                        const cleanSearch = cleanPhoneNumber(searchText); // Sadece rakamlar
                        const cleanLeadPhone = cleanPhoneNumber(l.phone); // Sadece rakamlar
                        
                        // En az 3 haneli arama iÃ§in kÄ±smi eÅŸleÅŸme
                        if (cleanSearch.length >= 3) {
                            // AramanÄ±n telefonda geÃ§ip geÃ§mediÄŸini kontrol et
                            if (cleanLeadPhone.includes(cleanSearch)) return true;
                            
                            // Tam eÅŸleÅŸme kontrolÃ¼ (son 10 hane)
                            if (cleanSearch.length >= 10 && cleanLeadPhone.length >= 10) {
                                const last10Search = cleanSearch.slice(-10);
                                const last10Phone = cleanLeadPhone.slice(-10);
                                if (last10Search === last10Phone) return true;
                            }
                        }
                    }
                    
                    // BranÅŸlarda ara
                    if (l.branches && l.branches.length > 0) {
                        return l.branches.some(b => {
                            // YetiÅŸkin ismi
                            if (b.fullName && b.fullName.toLowerCase().includes(searchText)) return true;
                            // Veli ismi
                            if (b.parentName && b.parentName.toLowerCase().includes(searchText)) return true;
                            // Ã‡ocuk isimleri
                            if (b.children && b.children.length > 0) {
                                return b.children.some(c => c.name && c.name.toLowerCase().includes(searchText));
                            }
                            return false;
                        });
                    }
                    return false;
                });
            }
            
            // SÄ±ralama uygula
            const sortOption = document.getElementById('filter-sort')?.value || 'date-desc';
            
            filtered.sort((a, b) => {
                switch(sortOption) {
                    case 'date-desc': // Son Ä°ÅŸlem Tarihi (Yeni â†’ Eski)
                        const dateA = getLastActionDate(a);
                        const dateB = getLastActionDate(b);
                        return (dateB?.getTime() || 0) - (dateA?.getTime() || 0);
                    
                    case 'date-asc': // Son Ä°ÅŸlem Tarihi (Eski â†’ Yeni)
                        const dateA2 = getLastActionDate(a);
                        const dateB2 = getLastActionDate(b);
                        return (dateA2?.getTime() || 0) - (dateB2?.getTime() || 0);
                    
                    case 'age-desc': // YaÅŸ (BÃ¼yÃ¼kten KÃ¼Ã§Ã¼ÄŸe)
                        const ageA = getCustomerAge(a);
                        const ageB = getCustomerAge(b);
                        return ageB - ageA;
                    
                    case 'age-asc': // YaÅŸ (KÃ¼Ã§Ã¼kten BÃ¼yÃ¼ÄŸe)
                        const ageA2 = getCustomerAge(a);
                        const ageB2 = getCustomerAge(b);
                        return ageA2 - ageB2;
                    
                    case 'name-asc': // Ä°sim (A â†’ Z)
                        return (a.fullName || '').localeCompare(b.fullName || '', 'tr');
                    
                    case 'name-desc': // Ä°sim (Z â†’ A)
                        return (b.fullName || '').localeCompare(a.fullName || '', 'tr');
                    
                    default:
                        return 0;
                }
            });
            
            // Export mode iÃ§in direkt veriyi dÃ¶ndÃ¼r
            if (exportMode) {
                return filtered;
            }
            
            // Normal mode: Ä°statistikleri gÃ¼ncelle ve listeyi render et
            updateFilterStats(filtered);
            renderFilteredCustomers(filtered);
        };
        
        // FiltrelenmiÅŸ mÃ¼ÅŸteri istatistiklerini gÃ¼ncelle
        function updateFilterStats(filtered) {
            document.getElementById('total-filtered').textContent = filtered.length;
            document.getElementById('new-filtered').textContent = filtered.filter(l => l.status === 'new').length;
            document.getElementById('trial-filtered').textContent = filtered.filter(l => l.status === 'trial').length;
            document.getElementById('converted-filtered').textContent = filtered.filter(l => l.status === 'converted').length;
        }
        
        // FiltrelenmiÅŸ mÃ¼ÅŸterileri listele
        function renderFilteredCustomers(filtered) {
            const container = document.getElementById('filtered-customers-list');
            if (!container) return;
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>MÃ¼ÅŸteri bulunamadÄ±</h3>
                        <p>Filtrelerinizi deÄŸiÅŸtirerek yeniden deneyin</p>
                    </div>
                `;
                return;
            }
            
            // Status'a gÃ¶re renk atama
            const statusColors = {
                'new': { bg: '#e3f2fd', border: '#2196F3', text: '#1976D2' },
                'trial': { bg: '#f3e5f5', border: '#9C27B0', text: '#7B1FA2' },
                'converted': { bg: '#e8f5e9', border: '#4CAF50', text: '#388E3C' },
                'lost': { bg: '#ffebee', border: '#f44336', text: '#d32f2f' },
                'default': { bg: '#fff3e0', border: '#FF9800', text: '#F57C00' }
            };
            
            container.innerHTML = filtered.map(customer => {
                // Status rengi belirle
                const statusColor = statusColors[customer.status] || statusColors['default'];
                
                // BranÅŸ bilgilerini kompakt listele
                const branchesInfo = [];
                if (customer.branches && customer.branches.length > 0) {
                    customer.branches.forEach(branchData => {
                        const branch = branches.find(b => b.id === branchData.branchId);
                        const branchIcon = branch ? branch.icon : 'ğŸ¯';
                        const branchName = branch ? branch.name : 'Bilinmeyen';
                        
                        if (branchData.ageGroup === 'adult') {
                            const tag = branchData.selectedTag || 'AranmadÄ±';
                            branchesInfo.push(`<div style="display: inline-flex; align-items: center; margin: 2px 4px 2px 0; padding: 4px 8px; background: rgba(255,255,255,0.7); border-radius: 12px; font-size: 10px; border: 1px solid rgba(0,0,0,0.08);">
                                ${branchIcon} <strong style="margin: 0 4px;">${branchName}</strong> <span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 8px; margin-right: 4px;">ğŸ‘¨</span> <span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 8px;">${tag}</span>
                            </div>`);
                        } else if (branchData.ageGroup === 'child' && branchData.children) {
                            branchData.children.forEach(child => {
                                const childTag = child.selectedTag || 'AranmadÄ±';
                                const childAgeInfo = child.age ? ` (${child.age} yaÅŸ)` : '';
                                const veliName = branchData.parentName || 'BelirtilmemiÅŸ';
                                const displayText = `Ã–ÄŸrenci: ${child.name}${childAgeInfo} / Veli: ${veliName}`;
                                branchesInfo.push(`<div style="display: inline-flex; align-items: center; margin: 2px 4px 2px 0; padding: 4px 8px; background: rgba(255,255,255,0.7); border-radius: 12px; font-size: 10px; border: 1px solid rgba(0,0,0,0.08);">
                                    ${branchIcon} <strong style="margin: 0 4px;">${branchName}</strong> <span style="background: #FFC107; color: white; padding: 2px 6px; border-radius: 8px; margin-right: 4px; font-weight: 600;">${displayText}</span> <span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 8px;">${childTag}</span>
                                </div>`);
                            });
                        }
                    });
                }
                
                const branchesHtml = branchesInfo.length > 0 ? branchesInfo.join('') : '<div style="font-size: 11px; color: #999; padding: 4px 0;">BranÅŸ yok</div>';
                
                // Son iÅŸlem tarihi
                const lastActionDate = getLastActionDate(customer);
                let lastActionStr = '';
                if (lastActionDate) {
                    const now = new Date();
                    const diffMs = now - lastActionDate;
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 0) {
                        lastActionStr = 'BugÃ¼n';
                    } else if (diffDays === 1) {
                        lastActionStr = 'DÃ¼n';
                    } else if (diffDays < 7) {
                        lastActionStr = `${diffDays} gÃ¼n Ã¶nce`;
                    } else if (diffDays < 30) {
                        lastActionStr = `${Math.floor(diffDays / 7)} hafta Ã¶nce`;
                    } else {
                        lastActionStr = lastActionDate.toLocaleDateString('tr-TR');
                    }
                }
                
                // Status badge
                const statusLabels = {
                    'new': 'ğŸ†• Yeni',
                    'trial': 'ğŸ¾ Deneme',
                    'converted': 'âœ… Ãœye Oldu',
                    'lost': 'âŒ KayÄ±p'
                };
                const statusLabel = statusLabels[customer.status] || 'ğŸ“‹ MÃ¼ÅŸteri';
                
                // âœ… Ãœye ise Ã¼ye sayfasÄ±na, CRM ise detay sayfasÄ±na yÃ¶nlendir
                const clickAction = customer.isMember && customer.memberId 
                    ? `onclick="showMemberAttendancePage('${customer.memberId}')"` 
                    : `onclick="openCustomerDetail('${customer.id}')"`;
                
                return `
                    <div class="filtered-customer-item" style="cursor: pointer; padding: 15px; margin-bottom: 10px; background: ${statusColor.bg}; border-radius: 10px; border-left: 5px solid ${statusColor.border}; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.08);" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.12)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.08)'; this.style.transform='translateY(0)'" ${clickAction}>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="font-weight: 600; font-size: 14px; color: #333;">${customer.fullName || customer.phone}</div>
                            <div style="background: ${statusColor.border}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">${statusLabel}</div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">
                            ğŸ“ <span onclick="event.stopPropagation()" style="cursor: pointer; display: inline-flex; gap: 6px; align-items: center;">
                                <span onclick="copyToClipboard('${customer.phone}', 'Telefon numarasÄ± kopyalandÄ±')" style="padding: 3px 8px; background: rgba(255,255,255,0.8); border-radius: 4px; transition: all 0.2s; border: 1px solid rgba(0,0,0,0.1);" onmouseover="this.style.background='rgba(255,255,255,1)'" onmouseout="this.style.background='rgba(255,255,255,0.8)'" title="Kopyala">${customer.phone} ğŸ“‹</span>
                                <a href="tel:${customer.phone}" style="padding: 3px 8px; background: rgba(76,175,80,0.1); border-radius: 4px; text-decoration: none; color: #4CAF50; transition: all 0.2s; border: 1px solid rgba(76,175,80,0.2);" onmouseover="this.style.background='rgba(76,175,80,0.2)'" onmouseout="this.style.background='rgba(76,175,80,0.1)'" title="Ara">ğŸ“</a>
                            </span>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 4px; margin-bottom: 8px;">
                            ${branchesHtml}
                        </div>
                        ${lastActionStr ? `<div style="font-size: 11px; color: ${statusColor.text}; font-weight: 500;">ğŸ• Son iÅŸlem: ${lastActionStr}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Filtreleri temizle
        window.clearCRMFilters = function() {
            document.getElementById('filter-branch').value = 'all';
            document.getElementById('filter-age-group').value = 'all';
            document.getElementById('filter-tag').value = 'all';
            document.getElementById('filter-search').value = '';
            document.getElementById('filter-date-start').value = '';
            document.getElementById('filter-date-end').value = '';
            document.getElementById('filter-sort').value = 'date-desc'; // SÄ±ralamayÄ± varsayÄ±lana dÃ¶ndÃ¼r
            
            // Listeyi temizle - applyCustomerFilters ile tutarlÄ± mesaj
            const tableBody = document.getElementById('filter-customer-list');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-5">
                            <i data-lucide="filter" class="text-muted mb-3" style="width:48px;height:48px;"></i>
                            <p class="text-muted mb-0">LÃ¼tfen bir filtre seÃ§in veya arama yapÄ±n</p>
                        </td>
                    </tr>
                `;
                lucide.createIcons();
            }
            
            // Ä°statistikleri sÄ±fÄ±rla
            document.getElementById('total-filtered').textContent = '0';
            document.getElementById('new-filtered').textContent = '0';
            document.getElementById('trial-filtered').textContent = '0';
            document.getElementById('converted-filtered').textContent = '0';
        };
        
        // FiltrelenmiÅŸ mÃ¼ÅŸterileri dÄ±ÅŸa aktar
        window.exportFilteredCustomers = function() {
            // Filtre uygula
            const filtered = applyCustomerFilters(true); // true = export mode
            
            if (!filtered || filtered.length === 0) {
                alert('DÄ±ÅŸa aktarÄ±lacak mÃ¼ÅŸteri bulunamadÄ±! Ã–nce filtre uygulayÄ±n.');
                return;
            }
            
            // CSV oluÅŸtur
            const csvRows = [
                ['Telefon', 'Ad Soyad', 'BranÅŸ', 'YaÅŸ Grubu', 'Etiket', 'Veli/Ã–ÄŸrenci', 'YaÅŸ', 'Kaynak', 'OluÅŸturma Tarihi']
            ];
            
            filtered.forEach(customer => {
                if (customer.branches && customer.branches.length > 0) {
                    customer.branches.forEach(branchData => {
                        const branch = branches.find(b => b.id === branchData.branchId);
                        const branchName = branch ? branch.name : 'Bilinmeyen';
                        
                        if (branchData.ageGroup === 'adult') {
                            csvRows.push([
                                customer.phone,
                                customer.fullName || branchData.fullName || '',
                                branchName,
                                'YetiÅŸkin',
                                branchData.selectedTag || '',
                                branchData.fullName || '',
                                '',
                                getSourceName(customer.source || 'other'),
                                customer.createdAt ? new Date(customer.createdAt).toLocaleDateString('tr-TR') : ''
                            ]);
                        } else if (branchData.ageGroup === 'child') {
                            if (branchData.children && branchData.children.length > 0) {
                                branchData.children.forEach(child => {
                                    csvRows.push([
                                        customer.phone,
                                        branchData.parentName || '',
                                        branchName,
                                        'Ã‡ocuk',
                                        child.selectedTag || '',
                                        child.name || '',
                                        child.age || '',
                                        getSourceName(customer.source || 'other'),
                                        customer.createdAt ? new Date(customer.createdAt).toLocaleDateString('tr-TR') : ''
                                    ]);
                                });
                            } else {
                                csvRows.push([
                                    customer.phone,
                                    branchData.parentName || '',
                                    branchName,
                                    'Ã‡ocuk',
                                    branchData.selectedTag || '',
                                    '',
                                    '',
                                    getSourceName(customer.source || 'other'),
                                    customer.createdAt ? new Date(customer.createdAt).toLocaleDateString('tr-TR') : ''
                                ]);
                            }
                        }
                    });
                } else {
                    csvRows.push([
                        customer.phone,
                        customer.fullName || '',
                        '',
                        '',
                        '',
                        '',
                        '',
                        getSourceName(customer.source || 'other'),
                        customer.createdAt ? new Date(customer.createdAt).toLocaleDateString('tr-TR') : ''
                    ]);
                }
            });
            
            // BOM ekleyerek UTF-8 desteÄŸi saÄŸla
            const csvContent = '\ufeff' + csvRows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `musteriler_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showAlert('âœ… MÃ¼ÅŸteriler dÄ±ÅŸa aktarÄ±ldÄ±!', 'success');
        };

        // Ortak gÃ¶rÃ¼ÅŸme kayÄ±tlarÄ± render fonksiyonu (Ã¼yeler ve CRM detaylarÄ± iÃ§in)
        window.renderCallRecords = async function(phoneNumber, containerId) {
            try {
                const container = document.getElementById(containerId);
                if (!container) return;

                container.innerHTML = '<div class="loading"><div class="spinner"></div><span>GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ± yÃ¼kleniyor...</span></div>';

                if (!clubSettings || !clubSettings.bulutfonApiKey) {
                    container.innerHTML = '<p style="color:#999; padding: 12px;">Bulutfon API anahtarÄ± tanÄ±mlÄ± deÄŸil.</p>';
                    return;
                }

                const res = await fetch(`https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonProxy?apikey=${clubSettings.bulutfonApiKey}`, { headers: { 'Content-Type': 'application/json' } });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const records = Array.isArray(data) ? data : (data.cdrs || data.data || []);

                const phoneRecords = records.filter(r => phonesMatch(r.caller, phoneNumber) || phonesMatch(r.callee, phoneNumber));

                if (phoneRecords.length === 0) {
                    container.innerHTML = '<p style="color:#999; padding: 12px;">Bu numara iÃ§in gÃ¶rÃ¼ÅŸme kaydÄ± bulunamadÄ±.</p>';
                    return;
                }

                const html = phoneRecords.slice(0, 20).map(record => {
                    const callTime = new Date(record.call_time);
                    callTime.setHours(callTime.getHours() - 3); // âœ… UTC'den TÃ¼rkiye saatine Ã§evir
                    const timeStr = callTime.toLocaleString('tr-TR');
                    const direction = record.direction === 'IN' ? 'ğŸ“¥ Gelen' : 'ğŸ“¤ Giden';
                    const duration = record.talking_seconds ? `${record.talking_seconds}s` : 'CevapsÄ±z';
                    const wasAnswered = record.talking_seconds && parseInt(record.talking_seconds) > 0;
                    const statusColor = wasAnswered ? '#4caf50' : '#f44336';
                    const recordingBtn = (record.uuid && clubSettings && clubSettings.bulutfonApiKey) ?
                        `<button class="btn btn-sm btn-info" onclick="window.open('https://us-central1-uyekayit-5964b.cloudfunctions.net/bulutfonRecordingProxy?apikey=${clubSettings.bulutfonApiKey}&uuid=${record.uuid}', '_blank')" title="Ses kaydÄ±nÄ± dinle">ğŸ§ Dinle</button>` : '';
                    return `
                        <div style="padding: 12px; background: #f5f5f5; border-left: 4px solid ${statusColor}; border-radius: 6px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${direction}</div>
                                    <div style="font-size: 13px; color: #666;">ğŸ• ${timeStr}</div>
                                    <div style="font-size: 13px; color: ${statusColor}; font-weight: 600; margin-top: 4px;">${duration}</div>
                                </div>
                                <div>${recordingBtn}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = `<div>${html}</div>`;
            } catch (err) {
                const container = document.getElementById(containerId);
                if (container) container.innerHTML = '<p style="color:#c00; padding: 12px;">GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ± yÃ¼klenemedi.</p>';
                console.error('renderCallRecords error:', err);
            }
        };

        // ============================================
        // âœ… CRM TRIALS FUNCTIONS
        // ============================================
        
        // Denemeleri render et
        window.renderTrials = function() {
            const container = document.getElementById('trials-list');
            if (!container) {
                console.log('âŒ trials-list container bulunamadÄ±!');
                return;
            }
            
            const branchFilter = document.getElementById('trial-branch-filter')?.value || 'all';
            const searchText = document.getElementById('trial-search')?.value.toLowerCase() || '';
            
            console.log('ğŸ¾ renderTrials Ã§aÄŸrÄ±ldÄ±, crmLeads:', crmLeads.length);
            
            // Deneme tarihi olan her kiÅŸiyi (yetiÅŸkin veya Ã§ocuk) topla
            // Etiket deÄŸiÅŸse bile deneme tarihi varsa listede kalmalÄ± (manuel kaldÄ±rma ile silinir)
            let trials = [];
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(branchData => {
                        // YetiÅŸkin iÃ§in branÅŸ seviyesinde kontrol - sadece denemeDate kontrol et
                        if (branchData.ageGroup === 'adult' && branchData.denemeDate) {
                            trials.push({
                                lead,
                                branchData,
                                childData: null,
                                trialStatus: branchData.trialStatus || 'scheduled'
                            });
                        }
                        // Ã‡ocuklar iÃ§in her Ã§ocuÄŸu ayrÄ± kontrol et - sadece denemeDate kontrol et
                        else if (branchData.ageGroup === 'child' && branchData.children && branchData.children.length > 0) {
                            branchData.children.forEach(childData => {
                                if (childData.denemeDate) {
                                    trials.push({
                                        lead,
                                        branchData,
                                        childData,
                                        trialStatus: childData.trialStatus || 'scheduled'
                                    });
                                }
                            });
                        }
                    });
                }
            });
            
            console.log('ğŸ¾ Bulunan deneme sayÄ±sÄ±:', trials.length);
            
            // Filtreleri uygula
            if (branchFilter !== 'all') {
                trials = trials.filter(t => t.branchData.branchId === branchFilter);
            }
            if (searchText) {
                trials = trials.filter(t => {
                    const parentName = t.branchData.parentName || '';
                    const childName = t.childData ? t.childData.name : '';
                    const adultName = t.branchData.fullName || lead.fullName || '';
                    const searchNoSpaces = searchText.replace(/\s/g, '');
                    
                    return parentName.toLowerCase().includes(searchText) ||
                           childName.toLowerCase().includes(searchText) ||
                           adultName.toLowerCase().includes(searchText) ||
                           t.lead.phone.includes(searchText) ||
                           t.lead.phone.replace(/\s/g, '').includes(searchNoSpaces);
                });
            }
            
            // Ä°statistikleri gÃ¼ncelle
            updateTrialStats(trials);
            
            if (trials.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Deneme dersi bulunamadÄ±</h3>
                        <p>"Denemeye Gelecek" etiketine sahip mÃ¼ÅŸteriler burada gÃ¶rÃ¼nÃ¼r</p>
                    </div>
                `;
                return;
            }
            
            // Tarihe gÃ¶re gruplandÄ±r ve sÄ±rala
            const trialsByDate = {};
            const dateColorMap = {};
            const dateBranchMap = {}; // BranÅŸ bilgisini saklamak iÃ§in
            
            // âœ… BranÅŸa gÃ¶re renk ve stil tanÄ±mlarÄ±
            const branchStyles = {
                'tenis': {
                    colors: ['#fff9e6', '#fff3cc', '#ffe4b3', '#ffd699', '#ffc780'], // SarÄ± tonlarÄ±
                    emoji: 'ğŸ¾',
                    borderColor: '#ffc107'
                },
                'yuzme': {
                    colors: ['#e3f2fd', '#bbdefb', '#90caf9', '#64b5f6', '#42a5f5'], // Mavi tonlarÄ±
                    emoji: 'ğŸŠ',
                    borderColor: '#2196f3'
                },
                'default': {
                    colors: ['#f3e5f5', '#e1bee7', '#ce93d8', '#ba68c8', '#ab47bc'], // Mor tonlarÄ±
                    emoji: 'ğŸ¯',
                    borderColor: '#9c27b0'
                }
            };
            
            trials.forEach(trial => {
                const trialDate = trial.childData ? new Date(trial.childData.denemeDate) : new Date(trial.branchData.denemeDate);
                const dateTimeStr = trialDate.toLocaleString('tr-TR', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // âœ… AynÄ± branÅŸ + aynÄ± yaÅŸ grubu + aynÄ± saat iÃ§in aynÄ± renk
                const ageGroup = trial.branchData.ageGroup || 'adult';
                const dateKey = `${trial.branchData.branchId}_${ageGroup}_${dateTimeStr}`;
                
                if (!trialsByDate[dateKey]) {
                    trialsByDate[dateKey] = [];
                    
                    // BranÅŸ stilini al
                    const branchStyle = branchStyles[trial.branchData.branchId] || branchStyles['default'];
                    dateBranchMap[dateKey] = branchStyle;
                    
                    // AynÄ± branÅŸ iÃ§in farklÄ± saatlere farklÄ± tonlar
                    const existingBranchKeys = Object.keys(dateBranchMap).filter(k => k.startsWith(trial.branchData.branchId));
                    const colorIndex = existingBranchKeys.length - 1;
                    dateColorMap[dateKey] = branchStyle.colors[colorIndex % branchStyle.colors.length];
                }
                trialsByDate[dateKey].push(trial);
            });
            
            // Tarihe gÃ¶re sÄ±ralÄ± HTML oluÅŸtur (branchId_datetime formatÄ±ndan tarihi al)
            const sortedDates = Object.keys(trialsByDate).sort((a, b) => {
                const dateA = trialsByDate[a][0].childData 
                    ? new Date(trialsByDate[a][0].childData.denemeDate)
                    : new Date(trialsByDate[a][0].branchData.denemeDate);
                const dateB = trialsByDate[b][0].childData 
                    ? new Date(trialsByDate[b][0].childData.denemeDate)
                    : new Date(trialsByDate[b][0].branchData.denemeDate);
                // Ã–nce tarihe gÃ¶re sÄ±rala, aynÄ± tarihse branÅŸ ID'ye gÃ¶re
                const timeDiff = dateA - dateB;
                if (timeDiff !== 0) return timeDiff;
                return a.localeCompare(b); // BranchId iÃ§in alfasayÄ±sal sÄ±ralama
            });
            
            container.innerHTML = sortedDates.map(dateKey => {
                const dateTrials = trialsByDate[dateKey];
                const bgColor = dateColorMap[dateKey];
                const branchStyle = dateBranchMap[dateKey]; // BranÅŸ stilini al
                
                return dateTrials.map(({lead, branchData, childData, trialStatus}) => {
                    const branch = branches.find(b => b.id === branchData.branchId);
                    const trialDate = childData ? new Date(childData.denemeDate) : new Date(branchData.denemeDate);
                    const lastNote = branchData.notesHistory && branchData.notesHistory.length > 0 
                        ? branchData.notesHistory[branchData.notesHistory.length - 1].text 
                        : 'Not yok';
                    
                    // Ä°sim bilgisini belirle
                    let displayName = '';
                    let branchFullName = '';
                    
                    if (childData) {
                        // Ã‡ocuk denemesi - veli: xx Ã¶ÄŸrenci: xx formatÄ±nda
                        const ageInfo = childData.age ? ` (${childData.age} yaÅŸ)` : '';
                        displayName = `Veli: ${branchData.parentName || 'BelirtilmemiÅŸ'} / Ã–ÄŸrenci: ${childData.name}${ageInfo}`;
                        branchFullName = 'ğŸ‘¶ Ã‡ocuk - ' + (branch ? branch.name : 'BranÅŸ yok');
                    } else if (branchData.ageGroup === 'adult') {
                        // YetiÅŸkin denemesi
                        displayName = branchData.fullName || lead.fullName || 'YetiÅŸkin';
                        branchFullName = 'ğŸ‘¨ YetiÅŸkin - ' + (branch ? branch.name : 'BranÅŸ yok');
                    }
                    
                    // Etiket bilgisi
                    const selectedTag = childData ? childData.selectedTag : branchData.selectedTag;
                    const tagBadge = selectedTag ? `<span style="background: #667eea; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">ğŸ·ï¸ ${selectedTag}</span>` : '';
                    
                    // Deneme ID'si
                    const branchIndex = lead.branches.findIndex(b => b === branchData);
                    const childIndex = childData && branchData.children ? branchData.children.findIndex(c => c === childData) : -1;
                    
                    // Tarih formatÄ± - daha belirgin
                    const dateFormatted = trialDate.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const timeFormatted = trialDate.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                    
                    return `
                        <div class="trial-item ${trialStatus}" style="position: relative; background: ${bgColor}; border-left: 6px solid ${branchStyle.borderColor}; padding: 18px; border-radius: 10px; margin-bottom: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div style="position: absolute; top: 10px; right: 10px; font-size: 64px; opacity: 0.15; pointer-events: none; z-index: 0;">
                                ${branchStyle.emoji}
                            </div>
                            <div style="position: relative; z-index: 1; display: grid; grid-template-columns: 1fr auto; gap: 15px; align-items: start; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 15px; font-weight: 600; color: #333; margin-bottom: 6px;">
                                        <span style="font-size: 20px; margin-right: 8px;">${branchStyle.emoji}</span>${displayName}
                                    </div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 4px;">
                                        ğŸ“ <span onclick="event.stopPropagation()" style="cursor: pointer; display: inline-flex; gap: 8px; align-items: center;">
                                            <span onclick="copyToClipboard('${lead.phone}', 'Telefon numarasÄ± kopyalandÄ±')" style="padding: 4px 8px; background: #e3f2fd; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#bbdefb'" onmouseout="this.style.background='#e3f2fd'" title="Kopyala">${lead.phone} ğŸ“‹</span>
                                            <a href="tel:${lead.phone}" style="padding: 4px 8px; background: #e8f5e9; border-radius: 4px; text-decoration: none; color: #666; transition: background 0.2s;" onmouseover="this.style.background='#c8e6c9'" onmouseout="this.style.background='#e8f5e9'" title="Ara">ğŸ“</a>
                                        </span>
                                    </div>
                                    <div style="font-size: 13px; color: #666; margin-bottom: 4px;">
                                        ğŸ¯ ${branchFullName}
                                    </div>
                                    <div style="margin-top: 6px;">
                                        ${tagBadge}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 18px; font-weight: 700; color: #2c3e50; margin-bottom: 2px;">
                                        ${timeFormatted}
                                    </div>
                                    <div style="font-size: 14px; font-weight: 600; color: #555;">
                                        ğŸ“… ${dateFormatted}
                                    </div>
                                    <div style="margin-top: 8px; background: ${getTrialStatusColor(trialStatus)}15; color: ${getTrialStatusColor(trialStatus)}; padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 600; text-align: center;">
                                        ${getTrialStatusIcon(trialStatus)} ${getTrialStatusName(trialStatus)}
                                    </div>
                                </div>
                            </div>
                            <div style="position: relative; z-index: 1; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px;">
                                <button class="btn btn-sm btn-primary" onclick="openCustomerDetail('${lead.id}', ${branchIndex})" style="width: 100%; padding: 8px 12px; font-size: 12px;">ğŸ‘¤ Detay</button>
                                <button class="btn btn-sm btn-warning trial-reminder-btn" id="trialBtn_${lead.phone}_${branchIndex}_${childIndex}" onclick="sendTrialReminder('${lead.phone}', '${displayName.replace(/'/g, "\\'")}', '${timeFormatted}', '${dateFormatted}', 'trialBtn_${lead.phone}_${branchIndex}_${childIndex}')" style="width: 100%; padding: 8px 12px; font-size: 12px;">â° HatÄ±rlat</button>
                                <button class="btn btn-sm btn-danger" onclick="removeFromTrials('${lead.id}', ${branchIndex}, ${childIndex})" style="width: 100%; padding: 8px 12px; font-size: 12px; background: #f44336;">ğŸ—‘ï¸ Denemeden KaldÄ±r</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }).join('');
        };
        
        // Denemeden kaldÄ±r (sadece listeden, mÃ¼ÅŸteriyi silmez)
        window.removeFromTrials = async function(leadId, branchIndex, childIndex) {
            try {
                const lead = crmLeads.find(l => l.id === leadId);
                if (!lead || !lead.branches || !lead.branches[branchIndex]) {
                    showAlert('âŒ MÃ¼ÅŸteri bulunamadÄ±', 'danger');
                    return;
                }
                
                const branchData = lead.branches[branchIndex];
                let selectedTag = '';
                
                // Ã‡ocuk denemesi mi yoksa yetiÅŸkin denemesi mi?
                if (childIndex >= 0 && branchData.children && branchData.children[childIndex]) {
                    selectedTag = branchData.children[childIndex].selectedTag;
                } else {
                    selectedTag = branchData.selectedTag;
                }
                
                // âœ… EÄŸer etiket "Denemeye Gelecek" ise hiÃ§bir ÅŸekilde silmeye izin verme
                if (selectedTag === 'Denemeye Gelecek') {
                    showAlert('âš ï¸ Bu mÃ¼ÅŸterinin etiketi "Denemeye Gelecek" olarak iÅŸaretli!\n\nLÃ¼tfen Ã¶nce denemeyi sonuÃ§landÄ±rÄ±n ve etiketini deÄŸiÅŸtirin. Denemeye gelecek etiketli mÃ¼ÅŸteriler listeden kaldÄ±rÄ±lamaz.', 'warning');
                    return; // Ä°ÅŸlemi tamamen iptal et
                }
                
                // DiÄŸer etiketler iÃ§in onay iste
                if (!confirm('Bu denemeyi listeden kaldÄ±rmak istediÄŸinize emin misiniz?\n(MÃ¼ÅŸteri kaydÄ± silinmeyecek, sadece deneme tarihi temizlenecek, etiket korunacak)')) {
                    return;
                }
                
                // Ã‡ocuk denemesi mi yoksa yetiÅŸkin denemesi mi?
                if (childIndex >= 0 && branchData.children && branchData.children[childIndex]) {
                    // âœ… Ã‡ocuk denemesi - SADECE deneme tarihini temizle, ETÄ°KET KALSIN
                    branchData.children[childIndex].denemeDate = null;
                } else {
                    // âœ… YetiÅŸkin denemesi - SADECE deneme tarihini temizle, ETÄ°KET KALSIN
                    branchData.denemeDate = null;
                }
                
                // Firebase'e kaydet
                await window.firebase.updateDoc(
                    window.firebase.doc(window.db, 'crmLeads', leadId),
                    { branches: lead.branches }
                );
                
                showAlert('âœ… Deneme listeden kaldÄ±rÄ±ldÄ±! (Etiket korundu)', 'success');
                await loadData();
                renderTrials();
                updateDashboard();
            } catch (error) {
                console.error('Deneme kaldÄ±rma hatasÄ±:', error);
                showAlert('âŒ Ä°ÅŸlem baÅŸarÄ±sÄ±z: ' + error.message, 'danger');
            }
        };
        
        // Deneme hatÄ±rlatmasÄ± gÃ¶nder (Evolution API ile)
        window.sendTrialReminder = async function(phone, name, time, date, buttonId) {
            try {
                // âœ… Butonu disable et ve gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ deÄŸiÅŸtir
                const btn = document.getElementById(buttonId);
                if (btn) {
                    if (btn.disabled) {
                        showAlert('â³ Mesaj zaten gÃ¶nderildi veya kuyruÄŸa eklendi!', 'warning');
                        return;
                    }
                    btn.disabled = true;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = 'â³ GÃ¶nderiliyor...';
                    btn.style.opacity = '0.6';
                    btn.style.cursor = 'not-allowed';
                }
                
                // WhatsApp cihazÄ±nÄ± kontrol et
                if (!whatsappDevices || whatsappDevices.length === 0) {
                    showAlert('âš ï¸ WhatsApp cihazÄ± bulunamadÄ±!', 'warning');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                    }
                    return;
                }
                
                const instanceName = whatsappDevices[0].instanceName || whatsappDevices[0].instance;
                
                // VarsayÄ±lan mesaj
                const message = `Merhaba,\n\nğŸ“… ${date} tarihinde saat ${time}'de deneme dersini hatÄ±rlatmak isteriz.\n\nGÃ¶rÃ¼ÅŸmek Ã¼zere! ğŸ¾`;
                
                // Evolution API ile gÃ¶nder
                const cleanPhone = phone.replace(/\D/g, '');
                
                console.log('ğŸ“¤ Deneme hatÄ±rlatmasÄ± gÃ¶nderiliyor:', { instanceName, phone: cleanPhone, name });
                
                const success = await sendWhatsAppMessage(instanceName, cleanPhone, message, name);
                
                // âœ… Butonu "GÃ¶nderildi" durumuna getir
                if (btn) {
                    btn.innerHTML = 'âœ… GÃ¶nderildi';
                    btn.classList.remove('btn-warning');
                    btn.classList.add('btn-success');
                    btn.style.background = '#4caf50';
                }
                
                showAlert('âœ… Deneme hatÄ±rlatmasÄ± kuyruÄŸa eklendi!', 'success');
            } catch (error) {
                console.error('âŒ Deneme hatÄ±rlatma hatasÄ±:', error);
                showAlert('âŒ Mesaj gÃ¶nderilemedi: ' + error.message, 'danger');
                
                // âœ… Hata durumunda butonu tekrar aktif et
                const btn = document.getElementById(buttonId);
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'â° HatÄ±rlat';
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            }
        };
        
        // Deneme istatistiklerini gÃ¼ncelle - Ä°statistikler kaldÄ±rÄ±ldÄ±, fonksiyon boÅŸ bÄ±rakÄ±ldÄ±
        function updateTrialStats(trials) {
            // Ä°statistik kartlarÄ± kaldÄ±rÄ±ldÄ±
        }
        
        // Deneme durumu rengi
        function getTrialStatusColor(status) {
            const colors = {
                scheduled: '#4facfe',
                completed: '#43e97b',
                cancelled: '#f5576c',
                converted: '#f093fb'
            };
            return colors[status] || '#667eea';
        }
        
        // Deneme durumu ikonu
        function getTrialStatusIcon(status) {
            const icons = {
                scheduled: 'ğŸ“…',
                completed: 'âœ…',
                cancelled: 'âŒ',
                converted: 'ğŸ‰'
            };
            return icons[status] || 'ğŸ“‹';
        }
        
        // Deneme durumu adÄ±
        function getTrialStatusName(status) {
            const names = {
                scheduled: 'PlanlandÄ±',
                completed: 'TamamlandÄ±',
                cancelled: 'Ä°ptal',
                converted: 'Ãœye Oldu'
            };
            return names[status] || 'Bilinmiyor';
        }
        
        // Deneme tamamla
        window.markTrialCompleted = async function(leadId) {
            if (!confirm('Deneme dersini tamamlandÄ± olarak iÅŸaretlemek istediÄŸinize emin misiniz?')) return;
            
            try {
                const leadRef = window.firebase.doc(window.db, 'crmLeads', leadId);
                await window.firebase.updateDoc(leadRef, {
                    trialStatus: 'completed',
                    updatedAt: new Date().toISOString()
                });
                showAlert('âœ… Deneme tamamlandÄ± olarak iÅŸaretlendi!', 'success');
                await loadData();
                renderTrials();
            } catch (error) {
                console.error('Deneme gÃ¼ncellenirken hata:', error);
                showAlert('âŒ Hata oluÅŸtu: ' + error.message, 'danger');
            }
        };
        
        // Deneme iptal et
        window.cancelTrial = async function(leadId) {
            if (!confirm('Deneme dersini iptal etmek istediÄŸinize emin misiniz?')) return;
            
            try {
                const leadRef = window.firebase.doc(window.db, 'crmLeads', leadId);
                await window.firebase.updateDoc(leadRef, {
                    trialStatus: 'cancelled',
                    updatedAt: new Date().toISOString()
                });
                showAlert('âœ… Deneme iptal edildi!', 'success');
                await loadData();
                renderTrials();
            } catch (error) {
                console.error('Deneme gÃ¼ncellenirken hata:', error);
                showAlert('âŒ Hata oluÅŸtu: ' + error.message, 'danger');
            }
        };
        
        // Deneme modal aÃ§
        window.openAddTrialModal = function() {
            openAddLeadModal();
            // Deneme tarihi alanÄ±na odaklan
            setTimeout(() => {
                document.querySelector('[name="trialDate"]')?.focus();
            }, 100);
        };

        // ============================================
        // âœ… CRM TAGS FUNCTIONS
        // ============================================
        
        // Global etiket listesi
        let crmTags = [];
        
        // Etiketleri yÃ¼kle
        async function loadCRMTags() {
            if (!currentClubId) return;
            
            try {
                // PostgreSQL iÃ§in: subcollection yerine clubId filtresi
                const tagsRef = window.firebase.query(
                    window.firebase.collection(window.db, 'crmTags'),
                    window.firebase.where('clubId', '==', currentClubId)
                );
                const tagsSnapshot = await window.firebase.getDocs(tagsRef);
                crmTags = tagsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // BranÅŸlarÄ± otomatik etiket olarak ekle
                await syncBranchTags();
                
                // Sistem etiketlerini ekle
                await ensureSystemTags();
                
                renderAllTags();
                updateTagStats();
                loadTagsToFilters();
            } catch (error) {
                console.error('Etiketler yÃ¼klenirken hata:', error);
            }
        }
        
        // BranÅŸlarÄ± otomatik etiket olarak senkronize et
        async function syncBranchTags() {
            if (!branches || branches.length === 0) return;
            
            try {
                for (const branch of branches) {
                    // Bu branÅŸ etiketi var mÄ± kontrol et
                    const existingTag = crmTags.find(t => t.name === branch.name && t.category === 'branch');
                    
                    if (!existingTag) {
                        // Yoksa ekle
                        const newTag = {
                            name: branch.name,
                            category: 'branch',
                            description: `${branch.icon} ${branch.name} branÅŸÄ±`,
                            isActive: true,
                            isAutoGenerated: true,
                            createdAt: new Date().toISOString(),
                            clubId: currentClubId
                        };
                        
                        const docRef = await window.firebase.addDoc(
                            window.firebase.collection(window.db, 'crmTags'),
                            newTag
                        );
                        
                        crmTags.push({ id: docRef.id, ...newTag });
                    }
                }
            } catch (error) {
                console.error('BranÅŸ etiketleri senkronize edilirken hata:', error);
            }
        }
        
        // Sistem etiketlerini oluÅŸtur (KayÄ±t Olabilir, Denemeye Gelecek, Ãœye Oldu)
        async function ensureSystemTags() {
            const systemTags = [
                {
                    name: 'AranmadÄ±',
                    category: 'status',
                    description: 'HenÃ¼z aranmamÄ±ÅŸ mÃ¼ÅŸteriler',
                    isSystem: true,
                    requiresDate: false,
                    order: 1
                },
                {
                    name: 'Mesaj AtÄ±lacak',
                    category: 'status',
                    description: 'Mesaj gÃ¶nderilecek mÃ¼ÅŸteriler',
                    isSystem: true,
                    requiresDate: false,
                    order: 2
                },
                {
                    name: 'Denemeye Gelecek',
                    category: 'status',
                    description: 'Deneme dersi iÃ§in randevusu olan mÃ¼ÅŸteriler',
                    isSystem: true,
                    requiresDate: true,
                    order: 3
                },
                {
                    name: 'KayÄ±t Olabilir',
                    category: 'status',
                    description: 'Ä°leri tarihte kayÄ±t olabilecek mÃ¼ÅŸteriler iÃ§in',
                    isSystem: true,
                    requiresDate: true,
                    order: 4
                },
                {
                    name: 'KayÄ±t Oldu',
                    category: 'status',
                    description: 'KayÄ±t olmuÅŸ mÃ¼ÅŸteriler',
                    isSystem: true,
                    requiresDate: false,
                    order: 5
                },
                {
                    name: 'DiÄŸer',
                    category: 'status',
                    description: 'DiÄŸer durumdaki mÃ¼ÅŸteriler',
                    isSystem: true,
                    requiresDate: false,
                    order: 6
                }
            ];
            
            try {
                for (const sysTag of systemTags) {
                    const existing = crmTags.find(t => t.name === sysTag.name);
                    
                    if (!existing) {
                        const newTag = {
                            ...sysTag,
                            isActive: true,
                            createdAt: new Date().toISOString(),
                            clubId: currentClubId
                        };
                        
                        const docRef = await window.firebase.addDoc(
                            window.firebase.collection(window.db, 'crmTags'),
                            newTag
                        );
                        
                        crmTags.push({ id: docRef.id, ...newTag });
                    }
                }
            } catch (error) {
                console.error('Sistem etiketleri oluÅŸturulurken hata:', error);
            }
        }
        
        // TÃ¼m etiketleri render et
        window.renderAllTags = function() {
            const searchText = document.getElementById('tag-search')?.value.toLowerCase() || '';
            const categoryFilter = document.getElementById('tag-category-filter')?.value || 'all';
            
            let filtered = [...crmTags];
            
            if (searchText) {
                filtered = filtered.filter(tag => tag.name.toLowerCase().includes(searchText));
            }
            
            if (categoryFilter !== 'all') {
                filtered = filtered.filter(tag => tag.category === categoryFilter);
            }
            
            // SÄ±ralamaya gÃ¶re sÄ±rala
            filtered.sort((a, b) => (a.order || 999) - (b.order || 999));
            
            // Kategorilere gÃ¶re ayÄ±r ve sÄ±rala
            const statusTags = filtered.filter(t => t.category === 'status').sort((a, b) => (a.order || 999) - (b.order || 999));
            const branchTags = filtered.filter(t => t.category === 'branch').sort((a, b) => (a.order || 999) - (b.order || 999));
            const customTags = filtered.filter(t => t.category === 'custom').sort((a, b) => (a.order || 999) - (b.order || 999));
            
            // Her kategoriyi render et
            renderTagCategory('status-tags-list', statusTags, 'status');
            renderTagCategory('branch-tags-list', branchTags, 'branch');
            renderTagCategory('custom-tags-list', customTags, 'custom');
            
            // TÃ¼m etiketler listesi
            const allContainer = document.getElementById('all-tags-list');
            if (allContainer) {
                if (filtered.length === 0) {
                    allContainer.innerHTML = `
                        <div class="empty-state">
                            <h3>Etiket bulunamadÄ±</h3>
                            <p>Yeni etiket eklemek iÃ§in yukarÄ±daki butonu kullanÄ±n</p>
                        </div>
                    `;
                } else {
                    allContainer.innerHTML = filtered.map((tag, index) => {
                        const usageCount = crmLeads.filter(l => (l.tags || []).includes(tag.name)).length;
                        const tagId = tag.id.replace(/'/g, "\\'");
                        return `
                            <div class="tag-item ${tag.category}-tag" data-tag-id="${tag.id}">
                                <div style="display: flex; flex-direction: column; gap: 2px; margin-right: 8px;">
                                    <button onclick="moveTagUp('${tagId}', 'all')" ${index === 0 ? 'disabled' : ''} style="padding: 2px 6px; font-size: 10px; background: ${index === 0 ? '#ccc' : '#4CAF50'}; color: white; border: none; border-radius: 3px; cursor: ${index === 0 ? 'not-allowed' : 'pointer'};" title="YukarÄ± TaÅŸÄ±">â–²</button>
                                    <button onclick="moveTagDown('${tagId}', 'all')" ${index === filtered.length - 1 ? 'disabled' : ''} style="padding: 2px 6px; font-size: 10px; background: ${index === filtered.length - 1 ? '#ccc' : '#4CAF50'}; color: white; border: none; border-radius: 3px; cursor: ${index === filtered.length - 1 ? 'not-allowed' : 'pointer'};" title="AÅŸaÄŸÄ± TaÅŸÄ±">â–¼</button>
                                </div>
                                <span class="tag-name">${tag.name}</span>
                                <span class="tag-count">${usageCount}</span>
                                <div class="tag-actions">
                                    <button onclick="editTag('${tagId}')" title="DÃ¼zenle">âœï¸</button>
                                    <button onclick="deleteTag('${tagId}')" title="Sil">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
        };
        
        // Kategori etiketlerini render et
        function renderTagCategory(containerId, tags, category) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (tags.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 12px; padding: 10px;">HenÃ¼z etiket yok</p>';
                return;
            }
            
            container.innerHTML = tags.map((tag, index) => {
                const usageCount = crmLeads.filter(l => (l.tags || []).includes(tag.name)).length;
                const tagId = tag.id.replace(/'/g, "\\'");
                const categoryStr = category.replace(/'/g, "\\'");
                return `
                    <div class="tag-item ${category}-tag" data-tag-id="${tag.id}">
                        <div style="display: flex; flex-direction: column; gap: 2px; margin-right: 8px;">
                            <button onclick="moveTagUp('${tagId}', '${categoryStr}')" ${index === 0 ? 'disabled' : ''} style="padding: 2px 6px; font-size: 10px; background: ${index === 0 ? '#ccc' : '#4CAF50'}; color: white; border: none; border-radius: 3px; cursor: ${index === 0 ? 'not-allowed' : 'pointer'};" title="YukarÄ± TaÅŸÄ±">â–²</button>
                            <button onclick="moveTagDown('${tagId}', '${categoryStr}')" ${index === tags.length - 1 ? 'disabled' : ''} style="padding: 2px 6px; font-size: 10px; background: ${index === tags.length - 1 ? '#ccc' : '#4CAF50'}; color: white; border: none; border-radius: 3px; cursor: ${index === tags.length - 1 ? 'not-allowed' : 'pointer'};" title="AÅŸaÄŸÄ± TaÅŸÄ±">â–¼</button>
                        </div>
                        <span class="tag-name">${tag.name}</span>
                        <span class="tag-count">${usageCount}</span>
                        <div class="tag-actions">
                            <button onclick="editTag('${tagId}')" title="DÃ¼zenle">âœï¸</button>
                            <button onclick="deleteTag('${tagId}')" title="Sil">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Etiket taÅŸÄ±ma fonksiyonlarÄ± (ok iÅŸaretleri ile)
        window.moveTagUp = async function(tagId, category) {
            console.log('moveTagUp Ã§aÄŸrÄ±ldÄ±:', tagId, category);
            const tag = crmTags.find(t => t.id === tagId);
            if (!tag) {
                console.error('Etiket bulunamadÄ±:', tagId);
                return;
            }
            
            // AynÄ± kategorideki etiketleri al ve sÄ±rala
            const sameCategoryTags = crmTags
                .filter(t => category === 'all' || t.category === category)
                .sort((a, b) => (a.order || 999) - (b.order || 999));
            
            console.log('AynÄ± kategorideki etiketler:', sameCategoryTags.length);
            
            const currentIndex = sameCategoryTags.findIndex(t => t.id === tagId);
            if (currentIndex <= 0) {
                console.log('Etiket zaten en Ã¼stte');
                return; // Zaten en Ã¼stte
            }
            
            // Sadece iki etiketin order deÄŸerlerini deÄŸiÅŸtir (swap)
            const currentTag = sameCategoryTags[currentIndex];
            const previousTag = sameCategoryTags[currentIndex - 1];
            
            const tempOrder = currentTag.order;
            currentTag.order = previousTag.order;
            previousTag.order = tempOrder;

            try {
                // Sadece 2 etiketi gÃ¼ncelle
                await Promise.all([
                    window.firebase.updateDoc(
                        window.firebase.doc(window.db, 'crmTags', currentTag.id),
                        { order: currentTag.order }
                    ),
                    window.firebase.updateDoc(
                        window.firebase.doc(window.db, 'crmTags', previousTag.id),
                        { order: previousTag.order }
                    )
                ]);

                console.log('âœ… Etiket sÄ±ralamasÄ± gÃ¼ncellendi');
                await loadCRMTags();
                renderAllTags();
            } catch (error) {
                console.error('Etiket taÅŸÄ±nÄ±rken hata:', error);
                showAlert('âŒ Etiket taÅŸÄ±nÄ±rken hata oluÅŸtu: ' + error.message, 'danger');
            }
        };
        
        window.moveTagDown = async function(tagId, category) {
            console.log('moveTagDown Ã§aÄŸrÄ±ldÄ±:', tagId, category);
            const tag = crmTags.find(t => t.id === tagId);
            if (!tag) {
                console.error('Etiket bulunamadÄ±:', tagId);
                return;
            }
            
            // AynÄ± kategorideki etiketleri al ve sÄ±rala
            const sameCategoryTags = crmTags
                .filter(t => category === 'all' || t.category === category)
                .sort((a, b) => (a.order || 999) - (b.order || 999));
            
            console.log('AynÄ± kategorideki etiketler:', sameCategoryTags.length);
            
            const currentIndex = sameCategoryTags.findIndex(t => t.id === tagId);
            if (currentIndex >= sameCategoryTags.length - 1 || currentIndex < 0) {
                console.log('Etiket zaten en altta');
                return; // Zaten en altta
            }
            
            // Sadece iki etiketin order deÄŸerlerini deÄŸiÅŸtir (swap)
            const currentTag = sameCategoryTags[currentIndex];
            const nextTag = sameCategoryTags[currentIndex + 1];
            
            const tempOrder = currentTag.order;
            currentTag.order = nextTag.order;
            nextTag.order = tempOrder;

            try {
                // Sadece 2 etiketi gÃ¼ncelle
                await Promise.all([
                    window.firebase.updateDoc(
                        window.firebase.doc(window.db, 'crmTags', currentTag.id),
                        { order: currentTag.order }
                    ),
                    window.firebase.updateDoc(
                        window.firebase.doc(window.db, 'crmTags', nextTag.id),
                        { order: nextTag.order }
                    )
                ]);

                console.log('âœ… Etiket sÄ±ralamasÄ± gÃ¼ncellendi');
                await loadCRMTags();
                renderAllTags();
            } catch (error) {
                console.error('Etiket taÅŸÄ±nÄ±rken hata:', error);
                showAlert('âŒ Etiket taÅŸÄ±nÄ±rken hata oluÅŸtu: ' + error.message, 'danger');
            }
        };
        
        // Drag & Drop fonksiyonlarÄ± (eski sistem - opsiyonel)
        let draggedTagElement = null;
        let draggedTagId = null;
        
        window.handleTagDragStart = function(event) {
            draggedTagElement = event.target;
            draggedTagId = event.target.dataset.tagId;
            event.target.style.opacity = '0.4';
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.innerHTML);
        };
        
        window.handleTagDragOver = function(event) {
            if (event.preventDefault) {
                event.preventDefault();
            }
            event.dataTransfer.dropEffect = 'move';
            
            const target = event.target.closest('.tag-item');
            if (target && target !== draggedTagElement) {
                target.style.borderTop = '2px solid #4CAF50';
            }
            return false;
        };
        
        window.handleTagDrop = async function(event) {
            if (event.stopPropagation) {
                event.stopPropagation();
            }
            
            const target = event.target.closest('.tag-item');
            if (!target || target === draggedTagElement) return false;
            
            target.style.borderTop = '';
            
            // SÄ±ralamayÄ± deÄŸiÅŸtir
            const draggedTag = crmTags.find(t => t.id === draggedTagId);
            const targetTagId = target.dataset.tagId;
            const targetTag = crmTags.find(t => t.id === targetTagId);
            
            if (!draggedTag || !targetTag) return false;
            
            // Sadece aynÄ± kategorideki etiketleri sÄ±ralayabilir
            if (draggedTag.category !== targetTag.category) {
                showAlert('âš ï¸ Sadece aynÄ± kategorideki etiketleri sÄ±ralayabilirsiniz', 'warning');
                return false;
            }
            
            // SÄ±ralamayÄ± deÄŸiÅŸtir
            const draggedOrder = draggedTag.order || 999;
            const targetOrder = targetTag.order || 999;
            
            // AynÄ± kategorideki tÃ¼m etiketleri al ve sÄ±rala
            const sameCategoryTags = crmTags
                .filter(t => t.category === draggedTag.category)
                .sort((a, b) => (a.order || 999) - (b.order || 999));
            
            // Yeni sÄ±ralamayÄ± hesapla
            const draggedIndex = sameCategoryTags.findIndex(t => t.id === draggedTagId);
            const targetIndex = sameCategoryTags.findIndex(t => t.id === targetTagId);
            
            // SÄ±ralamayÄ± deÄŸiÅŸtir
            sameCategoryTags.splice(draggedIndex, 1);
            sameCategoryTags.splice(targetIndex, 0, draggedTag);
            
            // Her etikete yeni order deÄŸeri ata ve kaydet
            try {
                for (let i = 0; i < sameCategoryTags.length; i++) {
                    const tag = sameCategoryTags[i];
                    tag.order = i;
                    
                    // Firebase'e kaydet
                    const tagRef = window.firebase.doc(window.db, `clubs/${currentClubId}/crmTags/${tag.id}`);
                    await window.firebase.updateDoc(tagRef, { order: i });
                }
                
                // Local array'i gÃ¼ncelle
                await loadCRMTags();
                
                showAlert('âœ… Etiket sÄ±ralamasÄ± gÃ¼ncellendi', 'success');
            } catch (error) {
                console.error('SÄ±ralama kaydedilirken hata:', error);
                showAlert('âŒ SÄ±ralama kaydedilemedi', 'danger');
            }
            
            return false;
        };
        
        window.handleTagDragEnd = function(event) {
            event.target.style.opacity = '1';
            
            // TÃ¼m border'larÄ± temizle
            document.querySelectorAll('.tag-item').forEach(item => {
                item.style.borderTop = '';
            });
        };
        
        // Etiket istatistiklerini gÃ¼ncelle
        function updateTagStats() {
            const activeTags = crmTags.filter(t => t.isActive !== false);
            const taggedCustomers = new Set();
            crmLeads.forEach(lead => {
                if (lead.tags && lead.tags.length > 0) {
                    taggedCustomers.add(lead.id);
                }
            });
            
            document.getElementById('total-tags').textContent = crmTags.length;
            document.getElementById('active-tags').textContent = activeTags.length;
            document.getElementById('tagged-customers').textContent = taggedCustomers.size;
        }
        
        // Etiketleri filtrelere yÃ¼kle
        function loadTagsToFilters() {
            const filterTag = document.getElementById('filter-tag');
            if (filterTag) {
                // BranÅŸ etiketlerini gizle ve ORDER'a gÃ¶re sÄ±rala
                const nonBranchTags = crmTags
                    .filter(tag => tag.category !== 'branch')
                    .sort((a, b) => {
                        const orderA = a.order !== undefined ? a.order : 999;
                        const orderB = b.order !== undefined ? b.order : 999;
                        return orderA - orderB;
                    });
                filterTag.innerHTML = '<option value="all">TÃ¼mÃ¼</option>' + 
                    nonBranchTags.map(tag => 
                        `<option value="${tag.name}">${tag.name}</option>`
                    ).join('');
            }
        }
        
        // CRM Åablonlar SayfasÄ±nÄ± Render Et
        function renderCRMTemplatesPage() {
            const container = document.getElementById('main-content') || document.querySelector('.admin-content');
            if (!container) return;
            
            // localStorage'dan Ã¶zel ÅŸablonlarÄ± yÃ¼kle
            const customTemplates = JSON.parse(localStorage.getItem(`crmTemplates_${currentClubId}`) || '{}');
            
            // Potansiyel Ã¼yeler iÃ§in ÅŸablonlar (sadece CRM)
            const templatesByBranch = {};
            
            // Genel CRM ÅŸablonlarÄ± (potansiyel Ã¼yeler iÃ§in)
            const genTemplates = [
                {
                    id: 'gen-template-1',
                    name: 'Sizi AradÄ±k MesajÄ±',
                    message: 'Merhaba {isim},\n\nBugÃ¼n sizi aramaya Ã§alÄ±ÅŸtÄ±k ancak ulaÅŸamadÄ±k. Size uygun bir zamanda gÃ¶rÃ¼ÅŸmek isteriz.\n\nBize uygun bir zaman dilimi bildirebilir misiniz?\n\nSaygÄ±larÄ±mÄ±zla,\n{kulup_adi}',
                    icon: 'ğŸ“',
                    color: '#2196F3'
                },
                {
                    id: 'gen-template-2',
                    name: 'CevapsÄ±z Ã‡aÄŸrÄ±',
                    message: 'Merhaba,\n\nBizi aramaya Ã§alÄ±ÅŸtÄ±nÄ±z ancak o anda mÃ¼sait deÄŸildik. Size nasÄ±l yardÄ±mcÄ± olabiliriz?\n\n{kulup_adi}',
                    icon: 'ğŸ“µ',
                    color: '#f44336'
                },
                {
                    id: 'gen-template-3',
                    name: 'KayÄ±t Davetiyesi',
                    message: 'Merhaba {isim},\n\nBizimle gÃ¶rÃ¼ÅŸtÃ¼kten sonra kayÄ±t iÅŸleminizi tamamlamadÄ±ÄŸÄ±nÄ±zÄ± fark ettik.\n\nSize Ã¶zel fÄ±rsatlarÄ±mÄ±z devam ediyor!\n\n{kulup_adi}',
                    icon: 'âœ¨',
                    color: '#9C27B0'
                },
                {
                    id: 'gen-template-4',
                    name: 'Bilgi Talebi',
                    message: 'Merhaba {isim},\n\nKulÃ¼bÃ¼mÃ¼z hakkÄ±nda bilgi almak istediÄŸinizi Ã¶ÄŸrendik.\n\nSize detaylÄ± bilgi vermek ve sorularÄ±nÄ±zÄ± yanÄ±tlamak iÃ§in buradayÄ±z.\n\nBizi arayabilir veya ziyaret edebilirsiniz.\n\n{kulup_adi}',
                    icon: 'â„¹ï¸',
                    color: '#00BCD4'
                }
            ];
            
            // âœ… localStorage'daki Ã¶zel ÅŸablonlarÄ± uygula
            genTemplates.forEach(template => {
                if (customTemplates[template.id]) {
                    template.name = customTemplates[template.id].name;
                    template.message = customTemplates[template.id].message;
                }
            });
            
            templatesByBranch['genel'] = genTemplates;
            
            // âœ… BRANÅ SEKMELERÄ° KALDIRILDI - Sadece genel ÅŸablonlar kullanÄ±lÄ±yor
            
            // Sekme butonlarÄ± oluÅŸtur (sadece genel)
            let tabsHTML = '';
            
            // Sekme iÃ§erikleri
            let contentsHTML = '';
            
            // Her branÅŸ iÃ§in iÃ§erik oluÅŸtur
            Object.keys(templatesByBranch).forEach((branchKey, index) => {
                const isActive = branchKey === 'genel';
                const templates = templatesByBranch[branchKey];
                const branchName = branchKey === 'genel' ? 'Genel CRM' : (branches.find(b => b.id === branchKey)?.name || branchKey);
                
                contentsHTML += `
                    <div class="tab-content ${isActive ? 'active' : ''}" id="template-tab-${branchKey}" style="display: ${isActive ? 'block' : 'none'};">
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #667eea; margin-bottom: 15px;">${branchName} Mesaj ÅablonlarÄ±</h3>
                            <div style="display: grid; gap: 15px;">
                                ${templates.map(template => `
                                    <div style="background: ${template.color}15; border-left: 4px solid ${template.color}; border-radius: 8px; padding: 15px;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                                            <div>
                                                <div style="font-size: 24px; margin-bottom: 5px;">${template.icon}</div>
                                                <h4 style="margin: 0; font-size: 16px; color: #333;">${template.name}</h4>
                            </div>
                                            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                                <button class="btn btn-sm btn-warning" onclick="editCRMTemplate('${template.id}', '${branchKey}')" title="Åablonu DÃ¼zenle">
                                                    âœï¸ DÃ¼zenle
                                                </button>
                                                <button class="btn btn-sm btn-primary" onclick="copyTemplateToClipboard(\`${template.message.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, '${branchKey}')" title="Åablonu Kopyala">
                                                    ğŸ“‹ Kopyala
                                                </button>
                                                <button class="btn btn-sm btn-success" onclick="useTemplateInWhatsApp(\`${template.message.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" title="WhatsApp'ta Kullan">
                                                    ğŸ’¬ Kullan
                                                </button>
                            </div>
                            </div>
                                        <pre style="background: white; padding: 12px; border-radius: 6px; font-size: 13px; white-space: pre-wrap; margin: 0; font-family: inherit; border: 1px solid ${template.color}30; line-height: 1.6;">${template.message}</pre>
                                        <div style="margin-top: 10px; font-size: 11px; color: #666; padding: 8px; background: white; border-radius: 4px;">
                                            <strong>ğŸ“ DeÄŸiÅŸkenler:</strong> {isim}, {tarih}, {saat}, {kulup_adi}, {adres}, {tutar}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                    </div>
                </div>
            `;
            });
            
            // Ana HTML'i oluÅŸtur
            const html = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">ğŸ“ CRM Mesaj ÅablonlarÄ±</h2>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3; margin-bottom: 20px;">
                        <strong>â„¹ï¸ KullanÄ±m:</strong> Bu ÅŸablonlar <strong>potansiyel Ã¼yeler</strong> (CRM'deki kiÅŸiler) iÃ§in hazÄ±rlanmÄ±ÅŸtÄ±r. 
                        Deneme dersi, arama, kayÄ±t davetiyesi gibi ilk iletiÅŸim mesajlarÄ±nÄ± iÃ§erir. 
                        ÅablonlarÄ± kopyalayÄ±p dÃ¼zenleyebilir veya doÄŸrudan WhatsApp'ta kullanabilirsiniz.
                    </div>
                    
                    ${tabsHTML}
                    ${contentsHTML}
                </div>
            `;
            
            // Render et
            const mainContent = document.querySelector('.admin-content');
            if (mainContent) {
                // Mevcut iÃ§eriÄŸi temizle ve yeni iÃ§eriÄŸi ekle
                const sections = mainContent.querySelectorAll('.section');
                sections.forEach(s => s.style.display = 'none');
                
                // CRM Templates section varsa gÃ¼ncelle, yoksa oluÅŸtur
                let templateSection = document.getElementById('crm-templates-section');
                if (!templateSection) {
                    templateSection = document.createElement('div');
                    templateSection.id = 'crm-templates-section';
                    templateSection.className = 'section';
                    mainContent.appendChild(templateSection);
                }
                
                templateSection.innerHTML = html;
                templateSection.style.display = 'block';
            }
        }
        
        // Åablon sekmesini deÄŸiÅŸtir
        window.switchTemplateTab = function(branchId) {
            // TÃ¼m sekmeleri pasif yap
            const tabs = document.querySelectorAll('.customer-tabs .tab-button');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // TÃ¼m iÃ§erikleri gizle
            const contents = document.querySelectorAll('[id^="template-tab-"]');
            contents.forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // SeÃ§ilen sekmeyi aktif yap
            const selectedTab = Array.from(tabs).find(tab => tab.getAttribute('onclick').includes(branchId));
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // SeÃ§ilen iÃ§eriÄŸi gÃ¶ster
            const selectedContent = document.getElementById(`template-tab-${branchId}`);
            if (selectedContent) {
                selectedContent.classList.add('active');
                selectedContent.style.display = 'block';
            }
        };
        
        // CRM ÅŸablonu dÃ¼zenle
        window.editCRMTemplate = function(templateId, branchKey) {
            // localStorage'dan Ã¶zel ÅŸablonlarÄ± yÃ¼kle
            const customTemplates = JSON.parse(localStorage.getItem(`crmTemplates_${currentClubId}`) || '{}');
            
            // Åablon iÃ§eriÄŸini bul (Ã¶nce localStorage'da, sonra default'ta)
            let template = customTemplates[templateId];
            
            if (!template) {
                // Default ÅŸablonlarÄ± oluÅŸtur (renderCRMTemplatesPage'deki mantÄ±kla aynÄ±)
                const allTemplates = {};
                
                // Genel CRM ÅŸablonlarÄ±
                allTemplates['gen-template-1'] = { name: 'Sizi AradÄ±k MesajÄ±', message: 'Merhaba {isim},\n\nBugÃ¼n sizi aramaya Ã§alÄ±ÅŸtÄ±k ancak ulaÅŸamadÄ±k. Size uygun bir zamanda gÃ¶rÃ¼ÅŸmek isteriz.\n\nBize uygun bir zaman dilimi bildirebilir misiniz?\n\nSaygÄ±larÄ±mÄ±zla,\n{kulup_adi}' };
                allTemplates['gen-template-2'] = { name: 'CevapsÄ±z Ã‡aÄŸrÄ±', message: 'Merhaba,\n\nBizi aramaya Ã§alÄ±ÅŸtÄ±nÄ±z ancak o anda mÃ¼sait deÄŸildik. Size nasÄ±l yardÄ±mcÄ± olabiliriz?\n\n{kulup_adi}' };
                allTemplates['gen-template-3'] = { name: 'KayÄ±t Davetiyesi', message: 'Merhaba {isim},\n\nBizimle gÃ¶rÃ¼ÅŸtÃ¼kten sonra kayÄ±t iÅŸleminizi tamamlamadÄ±ÄŸÄ±nÄ±zÄ± fark ettik.\n\nSize Ã¶zel fÄ±rsatlarÄ±mÄ±z devam ediyor!\n\n{kulup_adi}' };
                allTemplates['gen-template-4'] = { name: 'Bilgi Talebi', message: 'Merhaba {isim},\n\nKulÃ¼bÃ¼mÃ¼z hakkÄ±nda bilgi almak istediÄŸinizi Ã¶ÄŸrendik.\n\nSize detaylÄ± bilgi vermek ve sorularÄ±nÄ±zÄ± yanÄ±tlamak iÃ§in buradayÄ±z.\n\nBizi arayabilir veya ziyaret edebilirsiniz.\n\n{kulup_adi}' };
                
                template = allTemplates[templateId] || { name: 'Åablon', message: '' };
            }
            
            // âœ… Inline dÃ¼zenleme alanÄ± oluÅŸtur
            const editContainer = document.createElement('div');
            editContainer.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            
            editContainer.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 30px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <h2 style="margin: 0 0 20px 0; color: #333; font-size: 24px;">âœï¸ Åablonu DÃ¼zenle</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">Åablon AdÄ±:</label>
                        <input type="text" id="templateNameInput" value="${template.name || ''}" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;" />
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">Mesaj Ä°Ã§eriÄŸi:</label>
                        <textarea id="templateMessageInput" rows="12" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px; font-family: inherit; line-height: 1.6; box-sizing: border-box; resize: vertical;">${template.message || ''}</textarea>
                        <small style="display: block; margin-top: 8px; color: #666; font-size: 13px;">
                            ğŸ“ <strong>KullanÄ±labilir deÄŸiÅŸkenler:</strong> {isim}, {tarih}, {saat}, {kulup_adi}, {adres}, {tutar}
                        </small>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button id="cancelEditBtn" style="padding: 12px 24px; border: 2px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                            âŒ Ä°ptal
                        </button>
                        <button id="saveEditBtn" style="padding: 12px 24px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
                            ğŸ’¾ Kaydet
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(editContainer);
            
            // Focus input
            document.getElementById('templateNameInput').focus();
            
            // Ä°ptal butonu
            document.getElementById('cancelEditBtn').onclick = function() {
                document.body.removeChild(editContainer);
            };
            
            // Overlay'e tÄ±klama ile kapat
            editContainer.onclick = function(e) {
                if (e.target === editContainer) {
                    document.body.removeChild(editContainer);
                }
            };
            
            // Kaydet butonu
            document.getElementById('saveEditBtn').onclick = function() {
                const newName = document.getElementById('templateNameInput').value.trim();
                const newMessage = document.getElementById('templateMessageInput').value.trim();
                
                if (!newName || !newMessage) {
                    alert('âš ï¸ Åablon adÄ± ve mesaj iÃ§eriÄŸi boÅŸ olamaz!');
                    return;
                }
                
                // localStorage'a kaydet
                const updatedTemplate = {
                    name: newName,
                    message: newMessage
                };
                
                customTemplates[templateId] = updatedTemplate;
                localStorage.setItem(`crmTemplates_${currentClubId}`, JSON.stringify(customTemplates));
                
                showAlert('âœ… Åablon baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
                
                // Modal'Ä± kapat
                document.body.removeChild(editContainer);
                
                // SayfayÄ± yenile
                renderCRMTemplatesPage();
                switchTemplateTab(branchKey);
            };
        };
        
        // Åablonu panoya kopyala
        window.copyTemplateToClipboard = function(message, branchId) {
            navigator.clipboard.writeText(message).then(() => {
                showAlert('âœ… Åablon panoya kopyalandÄ±!', 'success', 2000);
            }).catch(err => {
                console.error('Kopyalama hatasÄ±:', err);
                showAlert('âŒ Kopyalama baÅŸarÄ±sÄ±z!', 'danger');
            });
        };
        
        // Åablonu WhatsApp'ta kullan
        window.useTemplateInWhatsApp = function(message) {
            // WhatsApp sayfasÄ±na git
            showSection('whatsapp', document.querySelector('.nav-btn[onclick*="whatsapp"]'));
            
            // Mesaj alanÄ±na ÅŸablonu yerleÅŸtir
            setTimeout(() => {
                const messageField = document.getElementById('bulkMessageText');
                if (messageField) {
                    messageField.value = message;
                    showAlert('âœ… Åablon WhatsApp mesaj alanÄ±na yÃ¼klendi!', 'success', 2000);
                    
                    // MesajlaÅŸma sekmesine geÃ§
                    if (window.switchWhatsAppTab) {
                        switchWhatsAppTab('messages');
                    }
                } else {
                    showAlert('âŒ WhatsApp mesaj alanÄ± bulunamadÄ±!', 'danger');
                }
            }, 500);
        };
        
        // Etiket modal aÃ§
        window.openAddTagModal = function() {
            const html = `
                <div id="addTagModal" class="modal" style="display: block;">
                    <div class="modal-content">
                        <span class="close" onclick="closeModal('addTagModal')">&times;</span>
                        <h3>â• Yeni Etiket</h3>
                        <form id="addTagForm" onsubmit="handleAddTag(event)">
                            <div class="form-group">
                                <label>Etiket AdÄ± *</label>
                                <input type="text" name="tagName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>Kategori *</label>
                                <select name="category" class="form-control" required>
                                    <option value="status">Durum</option>
                                    <option value="branch">BranÅŸ</option>
                                    <option value="custom">Ã–zel</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>AÃ§Ä±klama</label>
                                <textarea name="description" class="form-control" rows="3"></textarea>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="submit" class="btn btn-primary" style="flex: 1;">ğŸ’¾ Kaydet</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('addTagModal')">Ä°ptal</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Modal varsa kaldÄ±r
            const existing = document.getElementById('addTagModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', html);
        };
        
        // Etiket ekle
        window.handleAddTag = async function(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const newTag = {
                name: formData.get('tagName'),
                category: formData.get('category'),
                description: formData.get('description') || '',
                isActive: true,
                order: (crmTags && crmTags.length > 0) ? Math.max(...crmTags.map(t => t.order ?? 0)) + 1 : 0,
                createdAt: new Date().toISOString(),
                clubId: currentClubId
            };
            
            try {
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'crmTags'), 
                    newTag
                );
                showAlert('âœ… Etiket baÅŸarÄ±yla eklendi!', 'success');
                closeModal('addTagModal');
                loadCRMTags();
            } catch (error) {
                console.error('Etiket eklenirken hata:', error);
                showAlert('âŒ Etiket eklenirken hata oluÅŸtu: ' + error.message, 'danger');
            }
        };
        
        // Etiket dÃ¼zenle
        window.editTag = function(tagId) {
            const tag = crmTags.find(t => t.id === tagId);
            if (!tag) return;
            
            const html = `
                <div id="editTagModal" class="modal" style="display: block;">
                    <div class="modal-content">
                        <span class="close" onclick="closeModal('editTagModal')">&times;</span>
                        <h3>âœï¸ Etiket DÃ¼zenle</h3>
                        <form id="editTagForm" onsubmit="handleEditTag(event, '${tagId}')">
                            <div class="form-group">
                                <label>Etiket AdÄ± *</label>
                                <input type="text" name="tagName" class="form-control" value="${tag.name}" required>
                            </div>
                            <div class="form-group">
                                <label>Kategori *</label>
                                <select name="category" class="form-control" required>
                                    <option value="status" ${tag.category === 'status' ? 'selected' : ''}>Durum</option>
                                    <option value="branch" ${tag.category === 'branch' ? 'selected' : ''}>BranÅŸ</option>
                                    <option value="custom" ${tag.category === 'custom' ? 'selected' : ''}>Ã–zel</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>AÃ§Ä±klama</label>
                                <textarea name="description" class="form-control" rows="3">${tag.description || ''}</textarea>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button type="submit" class="btn btn-primary" style="flex: 1;">ğŸ’¾ GÃ¼ncelle</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('editTagModal')">Ä°ptal</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('editTagModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', html);
        };
        
        // Etiket gÃ¼ncelle
        window.handleEditTag = async function(event, tagId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const updatedTag = {
                name: formData.get('tagName'),
                category: formData.get('category'),
                description: formData.get('description') || '',
                updatedAt: new Date().toISOString()
            };
            
            try {
                const tagRef = window.firebase.doc(window.db, 'crmTags', tagId);
                await window.firebase.updateDoc(tagRef, updatedTag);
                showAlert('âœ… Etiket baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
                closeModal('editTagModal');
                loadCRMTags();
            } catch (error) {
                console.error('Etiket gÃ¼ncellenirken hata:', error);
                showAlert('âŒ Etiket gÃ¼ncellenirken hata oluÅŸtu: ' + error.message, 'danger');
            }
        };
        
        // Etiket sil
        window.deleteTag = async function(tagId) {
            if (!confirm('Bu etiketi silmek istediÄŸinize emin misiniz?')) return;
            
            try {
                await window.firebase.deleteDoc(
                    window.firebase.doc(window.db, 'crmTags', tagId)
                );
                showAlert('âœ… Etiket baÅŸarÄ±yla silindi!', 'success');
                loadCRMTags();
            } catch (error) {
                console.error('Etiket silinirken hata:', error);
                showAlert('âŒ Etiket silinirken hata oluÅŸtu: ' + error.message, 'danger');
            }
        };
        
        // Global branÅŸ sayacÄ±
        let branchFieldCounter = 0;
        
        // BranÅŸ field HTML'i oluÅŸtur
        function generateBranchFieldHTML(params) {
            const { index, branchId, branchData, ageGroup, fullName, parentName, children, selectedTag, kayitOlabilirDate, denemeDate, notesHistory, newNote } = params;
            
            const nonBranchTags = crmTags
                .filter(tag => tag.category !== 'branch')
                .sort((a, b) => (a.order || 999) - (b.order || 999));
            
            // Ã‡ocuklarÄ± render et
            const childrenArray = children || [];
            const childrenHtml = childrenArray.map((child, childIndex) => `
                <div style="padding: 15px; background: white; border-radius: 8px; border: 2px solid #e0e0e0; margin-bottom: 10px; position: relative;" data-child-index="${childIndex}">
                    <button type="button" onclick="removeChildFromBranch(${index}, ${childIndex})" style="position: absolute; top: 10px; right: 10px; background: #f44336; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 16px; z-index: 10;">Ã—</button>
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 11px; color: #666;">Ã‡ocuk Ad Soyad</label>
                            <input type="text" placeholder="Ad Soyad" value="${child.name || ''}" class="form-control" onchange="updateChildData(${index}, ${childIndex}, 'name', this.value)">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 11px; color: #666;">YaÅŸ</label>
                            <input type="number" placeholder="YaÅŸ" value="${child.age || ''}" class="form-control" min="1" max="18" onchange="updateChildData(${index}, ${childIndex}, 'age', this.value)">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-size: 11px; color: #666;">ğŸ·ï¸ Etiket *</label>
                        <select class="form-control" required onchange="updateChildData(${index}, ${childIndex}, 'selectedTag', this.value); handleChildTagSelection(${index}, ${childIndex}, this)">
                            <option value="">Etiket seÃ§iniz...</option>
                            ${nonBranchTags.map(tag => `<option value="${tag.name}" ${child.selectedTag === tag.name ? 'selected' : ''}>${tag.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div id="child-${index}-${childIndex}-dates" style="display: ${child.selectedTag ? 'block' : 'none'};">
                        <div id="child-${index}-${childIndex}-kayit" style="display: ${child.selectedTag === 'KayÄ±t Olabilir' ? 'block' : 'none'}; margin-bottom: 10px;">
                            <label style="font-size: 11px; color: #666;">ğŸ“… KayÄ±t Olabilir Tarihi</label>
                            <input type="datetime-local" value="${child.kayitOlabilirDate || ''}" class="form-control" onchange="updateChildData(${index}, ${childIndex}, 'kayitOlabilirDate', this.value)">
                        </div>
                        
                        <div id="child-${index}-${childIndex}-deneme" style="display: ${child.selectedTag === 'Denemeye Gelecek' ? 'block' : 'none'}; margin-bottom: 10px;">
                            <label style="font-size: 11px; color: #666;">ğŸ“… Deneme Dersi Tarihi</label>
                            <input type="datetime-local" value="${child.denemeDate || ''}" class="form-control" onchange="updateChildData(${index}, ${childIndex}, 'denemeDate', this.value)">
                        </div>
                    </div>
                </div>
            `).join('');
            
            return `
                <div class="branch-field-card" id="branch-field-${index}" style="background: #f9f9f9; border: 2px solid #ddd; border-radius: 12px; padding: 15px; margin-bottom: 15px; position: relative;">
                    <button type="button" onclick="removeBranchField(${index})" style="position: absolute; top: 10px; right: 10px; background: #f44336; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px; z-index: 10;">Ã—</button>
                    
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label>BranÅŸ *</label>
                            <select name="branches[${index}][branchId]" class="form-control" required>
                                <option value="">SeÃ§iniz...</option>
                                ${branches.map(b => `<option value="${b.id}" ${branchId === b.id ? 'selected' : ''}>${b.icon} ${b.name}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>YaÅŸ Grubu *</label>
                            <select name="branches[${index}][ageGroup]" class="form-control" required onchange="handleBranchAgeGroupChange(${index}, this)">
                                <option value="">SeÃ§iniz...</option>
                                <option value="adult" ${ageGroup === 'adult' ? 'selected' : ''}>ğŸ‘¨ YetiÅŸkin</option>
                                <option value="child" ${ageGroup === 'child' ? 'selected' : ''}>ğŸ‘¶ Ã‡ocuk</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="branch-tag-field-${index}">
                            <label>ğŸ·ï¸ Etiket *</label>
                            <select name="branches[${index}][selectedTag]" class="form-control" required onchange="handleBranchTagSelection(${index}, this)">
                                <option value="">Etiket seÃ§iniz...</option>
                                ${nonBranchTags.map(tag => `<option value="${tag.name}" ${selectedTag === tag.name ? 'selected' : ''}>${tag.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <!-- YetiÅŸkin iÃ§in Alan -->
                    <div id="branch-adult-${index}" style="display: ${ageGroup === 'adult' ? 'block' : 'none'};">
                        <div class="form-group">
                            <label>Ad Soyad *</label>
                            <input type="text" name="branches[${index}][fullName]" class="form-control" value="${fullName || ''}">
                        </div>
                        
                        <!-- YetiÅŸkin iÃ§in Ã¶zel etiket tarihleri -->
                        <div id="branch-adult-dates-${index}" style="display: ${selectedTag ? 'block' : 'none'};">
                            <div id="branch-adult-kayit-${index}" style="display: ${selectedTag === 'KayÄ±t Olabilir' ? 'block' : 'none'};">
                                <div class="form-group">
                                    <label>ğŸ“… KayÄ±t Olabilir Tarihi</label>
                                    <input type="datetime-local" name="branches[${index}][kayitOlabilirDate]" class="form-control" value="${kayitOlabilirDate || ''}">
                                </div>
                            </div>
                            
                            <div id="branch-adult-deneme-${index}" style="display: ${selectedTag === 'Denemeye Gelecek' ? 'block' : 'none'};">
                                <div class="form-group">
                                    <label>ğŸ“… Deneme Dersi Tarihi</label>
                                    <input type="datetime-local" name="branches[${index}][denemeDate]" class="form-control" value="${denemeDate || ''}">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ã‡ocuk iÃ§in Alanlar -->
                    <div id="branch-child-${index}" style="display: ${ageGroup === 'child' ? 'block' : 'none'};">
                        <div class="form-group">
                            <label>Veli Ad Soyad *</label>
                            <input type="text" name="branches[${index}][parentName]" class="form-control" value="${parentName || ''}" list="parent-names-${index}" placeholder="Veli ismi giriniz (varsa listeden seÃ§ebilirsiniz)">
                            <datalist id="parent-names-${index}">
                                ${window.existingParentNames && window.existingParentNames.length > 0 
                                    ? window.existingParentNames.map(name => `<option value="${name}">${name}</option>`).join('')
                                    : ''}
                            </datalist>
                        </div>
                        
                        <div class="form-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <label style="margin: 0;">ğŸ‘¶ Ã‡ocuklar</label>
                                <button type="button" class="btn btn-sm btn-success" onclick="addChildToBranch(${index})">+ Ã‡ocuk Ekle</button>
                            </div>
                            <div id="branch-children-${index}">
                                ${childrenHtml || '<p style="color: #999; font-size: 12px; text-align: center; padding: 10px;">HenÃ¼z Ã§ocuk eklenmedi</p>'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>ğŸ“ AÃ§Ä±klama</label>
                        <textarea name="branches[${index}][newNote]" class="form-control" rows="2" placeholder="Bu branÅŸ iÃ§in aÃ§Ä±klama...">${newNote || ''}</textarea>
                    </div>
                    
                    ${notesHistory && notesHistory.length > 0 ? `
                        <div class="form-group">
                            <label>ğŸ“‹ GeÃ§miÅŸ AÃ§Ä±klamalar</label>
                            <div style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: white;">
                                ${notesHistory.slice().reverse().map((note, reverseIndex) => {
                                    const noteIndex = notesHistory.length - 1 - reverseIndex;
                                    return `
                                    <div style="padding: 8px; margin-bottom: 8px; border-left: 3px solid var(--primary-color); background: #f9f9f9; position: relative;">
                                        <button type="button" onclick="deleteBranchNote(${index}, ${noteIndex})" style="position: absolute; top: 5px; right: 5px; background: #f44336; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 14px;">Ã—</button>
                                        <div style="font-size: 11px; color: #666; margin-bottom: 4px;">ğŸ‘¤ ${note.by} - ${note.date}</div>
                                        <div style="font-size: 12px; white-space: pre-wrap;">${note.text}</div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <input type="hidden" name="branches[${index}][notesHistory]" value='${notesHistory ? JSON.stringify(notesHistory) : '[]'}'>
                    <input type="hidden" name="branches[${index}][children]" value='${childrenArray.length > 0 ? JSON.stringify(childrenArray) : '[]'}'>
                </div>
            `;
        }
        
        // BranÅŸ alanÄ± ekle
        window.addBranchField = function(branchData = null) {
            const index = branchFieldCounter++;
            const container = document.getElementById('branches-container');
            
            const branchHtml = generateBranchFieldHTML({
                index: index,
                branchId: branchData?.branchId,
                branchData: branchData,
                ageGroup: branchData?.ageGroup || 'adult',
                fullName: branchData?.fullName || '',
                parentName: branchData?.parentName || '',
                children: branchData?.children || [],
                selectedTag: branchData?.selectedTag || '',
                kayitOlabilirDate: branchData?.kayitOlabilirDate || '',
                denemeDate: branchData?.denemeDate || '',
                notesHistory: branchData?.notesHistory || [],
                newNote: branchData?.newNote || ''
            });
            
            container.insertAdjacentHTML('beforeend', branchHtml);
            
            // Etiket seÃ§ilmiÅŸse tarihleri gÃ¶ster
            if (branchData && branchData.selectedTag) {
                const select = document.querySelector(`[name="branches[${index}][selectedTag]"]`);
                if (select) {
                    handleBranchTagSelection(index, select);
                }
            }
        };
        
        // BranÅŸ etiket seÃ§imi (YetiÅŸkinler iÃ§in)
        window.handleBranchTagSelection = function(index, selectElement) {
            const selectedTag = selectElement.value;
            const datesContainer = document.getElementById(`branch-adult-dates-${index}`);
            const kayitField = document.getElementById(`branch-adult-kayit-${index}`);
            const denemeField = document.getElementById(`branch-adult-deneme-${index}`);
            
            if (!datesContainer) return; // Ã‡ocuk branÅŸÄ± ise
            
            const kayitInput = kayitField?.querySelector('input[type="datetime-local"]');
            const denemeInput = denemeField?.querySelector('input[type="datetime-local"]');
            
            if (selectedTag === 'KayÄ±t Olabilir') {
                datesContainer.style.display = 'block';
                kayitField.style.display = 'block';
                denemeField.style.display = 'none';
                if (kayitInput) kayitInput.required = false;
                if (denemeInput) {
                    denemeInput.required = false;
                    // âœ… Deneme tarihi SÄ°LÄ°NMEYECEK - sadece gizlenecek (manuel kaldÄ±rma iÃ§in korunacak)
                }
            } else if (selectedTag === 'Denemeye Gelecek') {
                datesContainer.style.display = 'block';
                kayitField.style.display = 'none';
                denemeField.style.display = 'block';
                if (denemeInput) denemeInput.required = false; // âœ… JavaScript validasyonu kullanÄ±lÄ±yor, HTML required kaldÄ±rÄ±ldÄ±
                if (kayitInput) {
                    kayitInput.required = false;
                    // âœ… KayÄ±t tarihi SÄ°LÄ°NMEYECEK - sadece gizlenecek
                }
            } else {
                datesContainer.style.display = 'none';
                kayitField.style.display = 'none';
                denemeField.style.display = 'none';
                if (kayitInput) {
                    kayitInput.required = false;
                    // âœ… KayÄ±t tarihi SÄ°LÄ°NMEYECEK - sadece gizlenecek
                }
                if (denemeInput) {
                    denemeInput.required = false;
                    // âœ… Deneme tarihi SÄ°LÄ°NMEYECEK - sadece gizlenecek (manuel kaldÄ±rma iÃ§in korunacak)
                }
            }
        };
        
        // BranÅŸ yaÅŸ grubu deÄŸiÅŸimi
        window.handleBranchAgeGroupChange = function(branchIndex, selectElement) {
            const value = selectElement.value;
            const adultDiv = document.getElementById(`branch-adult-${branchIndex}`);
            const childDiv = document.getElementById(`branch-child-${branchIndex}`);
            const tagField = document.getElementById(`branch-tag-field-${branchIndex}`);
            const tagSelect = document.querySelector(`[name="branches[${branchIndex}][selectedTag]"]`);
            
            if (value === 'adult') {
                adultDiv.style.display = 'block';
                childDiv.style.display = 'none';
                if (tagField) tagField.style.display = 'block'; // YetiÅŸkin iÃ§in etiket gÃ¶ster
                if (tagSelect) tagSelect.required = true; // âœ… Etiket zorunlu
                // Adult zorunlu yap
                const fullNameInput = document.querySelector(`[name="branches[${branchIndex}][fullName]"]`);
                if (fullNameInput) fullNameInput.required = true;
                // Child opsiyonel yap
                const parentNameInput = document.querySelector(`[name="branches[${branchIndex}][parentName]"]`);
                if (parentNameInput) parentNameInput.required = false;
            } else if (value === 'child') {
                adultDiv.style.display = 'none';
                childDiv.style.display = 'block';
                if (tagField) tagField.style.display = 'none'; // Ã‡ocuk iÃ§in etiket gizle
                if (tagSelect) {
                    tagSelect.required = false; // âœ… Etiket zorunlu deÄŸil
                    tagSelect.value = ''; // âœ… DeÄŸeri temizle
                }
                // Child zorunlu yap
                const parentNameInput = document.querySelector(`[name="branches[${branchIndex}][parentName]"]`);
                if (parentNameInput) parentNameInput.required = true;
                // Adult opsiyonel yap
                const fullNameInput = document.querySelector(`[name="branches[${branchIndex}][fullName]"]`);
                if (fullNameInput) fullNameInput.required = false;
            } else {
                adultDiv.style.display = 'none';
                childDiv.style.display = 'none';
                if (tagField) tagField.style.display = 'block';
                if (tagSelect) tagSelect.required = true; // âœ… Etiket zorunlu
            }
        };
        
        // BranÅŸa Ã§ocuk ekle
        window.addChildToBranch = function(branchIndex) {
            const container = document.getElementById(`branch-children-${branchIndex}`);
            const childrenInput = document.querySelector(`[name="branches[${branchIndex}][children]"]`);
            const children = JSON.parse(childrenInput.value || '[]');
            
            const childIndex = children.length;
            children.push({ name: '', age: '', selectedTag: '', kayitOlabilirDate: '', denemeDate: '' });
            childrenInput.value = JSON.stringify(children);
            
            const nonBranchTags = crmTags
                .filter(tag => tag.category !== 'branch')
                .sort((a, b) => (a.order || 999) - (b.order || 999));
            
            const childHtml = `
                <div style="padding: 15px; background: white; border-radius: 8px; border: 2px solid #e0e0e0; margin-bottom: 10px; position: relative;" data-child-index="${childIndex}">
                    <button type="button" onclick="removeChildFromBranch(${branchIndex}, ${childIndex})" style="position: absolute; top: 10px; right: 10px; background: #f44336; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 16px; z-index: 10;">Ã—</button>
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 11px; color: #666;">Ã‡ocuk Ad Soyad</label>
                            <input type="text" placeholder="Ad Soyad" class="form-control" onchange="updateChildData(${branchIndex}, ${childIndex}, 'name', this.value)">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label style="font-size: 11px; color: #666;">YaÅŸ</label>
                            <input type="number" placeholder="YaÅŸ" class="form-control" min="1" max="18" onchange="updateChildData(${branchIndex}, ${childIndex}, 'age', this.value)">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label style="font-size: 11px; color: #666;">ğŸ·ï¸ Etiket</label>
                        <select class="form-control" onchange="updateChildData(${branchIndex}, ${childIndex}, 'selectedTag', this.value); handleChildTagSelection(${branchIndex}, ${childIndex}, this)">
                            <option value="">Etiket seÃ§iniz...</option>
                            ${nonBranchTags.map(tag => `<option value="${tag.name}">${tag.name}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div id="child-${branchIndex}-${childIndex}-dates" style="display: none;">
                        <div id="child-${branchIndex}-${childIndex}-kayit" style="display: none; margin-bottom: 10px;">
                            <label style="font-size: 11px; color: #666;">ğŸ“… KayÄ±t Olabilir Tarihi</label>
                            <input type="datetime-local" class="form-control" onchange="updateChildData(${branchIndex}, ${childIndex}, 'kayitOlabilirDate', this.value)">
                        </div>
                        
                        <div id="child-${branchIndex}-${childIndex}-deneme" style="display: none; margin-bottom: 10px;">
                            <label style="font-size: 11px; color: #666;">ğŸ“… Deneme Dersi Tarihi</label>
                            <input type="datetime-local" class="form-control" onchange="updateChildData(${branchIndex}, ${childIndex}, 'denemeDate', this.value)">
                        </div>
                    </div>
                </div>
            `;
            
            if (container.querySelector('p')) {
                container.innerHTML = '';
            }
            container.insertAdjacentHTML('beforeend', childHtml);
        };
        
        // Ã‡ocuk verisini gÃ¼ncelle
        window.updateChildData = function(branchIndex, childIndex, field, value) {
            const childrenInput = document.querySelector(`[name="branches[${branchIndex}][children]"]`);
            const children = JSON.parse(childrenInput.value || '[]');
            if (children[childIndex]) {
                children[childIndex][field] = value;
                childrenInput.value = JSON.stringify(children);
            }
        };
        
        // Ã‡ocuÄŸu branÅŸtan kaldÄ±r
        window.removeChildFromBranch = function(branchIndex, childIndex) {
            const childrenInput = document.querySelector(`[name="branches[${branchIndex}][children]"]`);
            const children = JSON.parse(childrenInput.value || '[]');
            children.splice(childIndex, 1);
            childrenInput.value = JSON.stringify(children);
            
            // UI'den kaldÄ±r
            const container = document.getElementById(`branch-children-${branchIndex}`);
            const childElements = container.querySelectorAll('[data-child-index]');
            childElements[childIndex]?.remove();
            
            // EÄŸer hiÃ§ Ã§ocuk kalmadÄ±ysa mesaj gÃ¶ster
            if (children.length === 0) {
                container.innerHTML = '<p style="color: #999; font-size: 12px; text-align: center; padding: 10px;">HenÃ¼z Ã§ocuk eklenmedi</p>';
            }
        };
        
        // BranÅŸ alanÄ±nÄ± kaldÄ±r
        window.removeBranchField = function(index) {
            const field = document.getElementById(`branch-field-${index}`);
            if (field) {
                field.remove();
            }
        };
        
        // BranÅŸ not silme
        window.deleteBranchNote = function(branchIndex, noteIndex) {
            const notesInput = document.querySelector(`[name="branches[${branchIndex}][notesHistory]"]`);
            if (notesInput) {
                const notesHistory = JSON.parse(notesInput.value || '[]');
                notesHistory.splice(noteIndex, 1);
                notesInput.value = JSON.stringify(notesHistory);
                
                // KartÄ± yeniden render et
                const branchField = document.getElementById(`branch-field-${branchIndex}`);
                if (branchField) {
                    // Mevcut deÄŸerleri al
                    const branchId = document.querySelector(`[name="branches[${branchIndex}][branchId]"]`).value;
                    const selectedTag = document.querySelector(`[name="branches[${branchIndex}][selectedTag]"]`).value;
                    const kayitDate = document.querySelector(`[name="branches[${branchIndex}][kayitOlabilirDate]"]`)?.value;
                    const denemeDate = document.querySelector(`[name="branches[${branchIndex}][denemeDate]"]`)?.value;
                    const newNote = document.querySelector(`[name="branches[${branchIndex}][newNote]"]`).value;
                    
                    // KartÄ± kaldÄ±r
                    branchField.remove();
                    
                    // Yeni kart ekle
                    branchFieldCounter--;
                    addBranchField({
                        branchId,
                        selectedTag,
                        kayitOlabilirDate: kayitDate,
                        denemeDate: denemeDate,
                        newNote,
                        notesHistory
                    });
                }
            }
        };
        
        
        // Her Ã§ocuk iÃ§in etiket seÃ§imi
        window.handleChildTagSelection = function(branchIndex, childIndex, selectElement) {
            const selectedTag = selectElement.value;
            const datesContainer = document.getElementById(`child-${branchIndex}-${childIndex}-dates`);
            const kayitField = document.getElementById(`child-${branchIndex}-${childIndex}-kayit`);
            const denemeField = document.getElementById(`child-${branchIndex}-${childIndex}-deneme`);
            
            // Tarih inputlarÄ±nÄ± bul
            const kayitInput = kayitField?.querySelector('input[type="datetime-local"]');
            const denemeInput = denemeField?.querySelector('input[type="datetime-local"]');
            
            if (selectedTag === 'KayÄ±t Olabilir') {
                datesContainer.style.display = 'block';
                kayitField.style.display = 'block';
                denemeField.style.display = 'none';
                if (kayitInput) kayitInput.required = false;
                if (denemeInput) {
                    denemeInput.required = false;
                    // âœ… Deneme tarihi SÄ°LÄ°NMEYECEK - sadece gizlenecek (manuel kaldÄ±rma iÃ§in korunacak)
                }
            } else if (selectedTag === 'Denemeye Gelecek') {
                datesContainer.style.display = 'block';
                kayitField.style.display = 'none';
                denemeField.style.display = 'block';
                if (denemeInput) denemeInput.required = false; // âœ… JavaScript validasyonu kullanÄ±lÄ±yor, HTML required kaldÄ±rÄ±ldÄ±
                if (kayitInput) {
                    kayitInput.required = false;
                    // âœ… KayÄ±t tarihi SÄ°LÄ°NMEYECEK - sadece gizlenecek
                }
            } else {
                if (datesContainer) datesContainer.style.display = 'none';
                if (kayitField) kayitField.style.display = 'none';
                if (denemeField) denemeField.style.display = 'none';
                if (kayitInput) kayitInput.required = false;
                if (denemeInput) denemeInput.required = false;
                // âœ… Tarihler SÄ°LÄ°NMEYECEK - sadece gizlenecek (manuel kaldÄ±rma iÃ§in korunacak)
            }
        };
        
        // YaÅŸ grubu deÄŸiÅŸtiÄŸinde alanlarÄ± gÃ¶ster/gizle
        window.handleAgeGroupChange = function(selectElement) {
            const value = selectElement.value;
            const childFields = document.getElementById('child-fields');
            const adultFields = document.getElementById('adult-fields');
            
            if (value === 'child') {
                childFields.style.display = 'block';
                adultFields.style.display = 'none';
                // Sadece veli ismi zorunlu
                childFields.querySelectorAll('input').forEach(input => {
                    if (input.name === 'parentName') {
                        input.required = true;
                    } else {
                        input.required = false;
                    }
                });
                adultFields.querySelectorAll('input').forEach(input => input.required = false);
            } else if (value === 'adult') {
                childFields.style.display = 'none';
                adultFields.style.display = 'block';
                // YetiÅŸkin ismi zorunlu
                adultFields.querySelectorAll('input').forEach(input => input.required = true);
                childFields.querySelectorAll('input').forEach(input => input.required = false);
            } else {
                childFields.style.display = 'none';
                adultFields.style.display = 'none';
            }
        };
        
        // Tek etiket seÃ§imi deÄŸiÅŸtiÄŸinde tarih alanlarÄ±nÄ± gÃ¶ster/gizle
        window.handleSingleTagSelection = function(selectElement) {
            const selectedTag = selectElement.value;
            
            const tagDateFields = document.getElementById('tag-date-fields');
            const kayitOlabilirField = document.getElementById('kayit-olabilir-date');
            const denemeField = document.getElementById('denemeye-gelecek-date');
            
            // KayÄ±t Olabilir seÃ§ildi mi?
            if (selectedTag === 'KayÄ±t Olabilir') {
                kayitOlabilirField.style.display = 'block';
                denemeField.style.display = 'none';
                tagDateFields.style.display = 'block';
            } else if (selectedTag === 'Denemeye Gelecek') {
                denemeField.style.display = 'block';
                kayitOlabilirField.style.display = 'none';
                tagDateFields.style.display = 'block';
            } else {
                kayitOlabilirField.style.display = 'none';
                denemeField.style.display = 'none';
                tagDateFields.style.display = 'none';
            }
        };
        
        // Eski handleTagSelection fonksiyonu - artÄ±k kullanÄ±lmÄ±yor ama uyumluluk iÃ§in bÄ±rakÄ±yoruz
        window.handleTagSelection = function(selectElement) {
            const selectedTags = Array.from(selectElement.selectedOptions).map(o => o.value);
            
            const tagDateFields = document.getElementById('tag-date-fields');
            const kayitOlabilirField = document.getElementById('kayit-olabilir-date');
            const denemeField = document.getElementById('denemeye-gelecek-date');
            
            // KayÄ±t Olabilir seÃ§ildi mi?
            if (selectedTags.includes('KayÄ±t Olabilir')) {
                kayitOlabilirField.style.display = 'block';
                tagDateFields.style.display = 'block';
            } else {
                kayitOlabilirField.style.display = 'none';
            }
            
            // Denemeye Gelecek seÃ§ildi mi?
            if (selectedTags.includes('Denemeye Gelecek')) {
                denemeField.style.display = 'block';
                tagDateFields.style.display = 'block';
            } else {
                denemeField.style.display = 'none';
            }
            
            // HiÃ§biri seÃ§ili deÄŸilse gizle
            if (!selectedTags.includes('KayÄ±t Olabilir') && !selectedTags.includes('Denemeye Gelecek')) {
                tagDateFields.style.display = 'none';
            }
        };
    
        // Telefon numarasÄ± kontrolÃ¼
        let phoneCheckTimeout;
        let lastCheckedPhone = '';
        window.checkExistingPhone = function(phone) {
            clearTimeout(phoneCheckTimeout);
            const messageDiv = document.getElementById('phone-check-message');
            const form = document.getElementById('addLeadForm');
            
            // Telefon numarasÄ± deÄŸiÅŸtiÄŸinde ve daha Ã¶nce bir mÃ¼ÅŸteri yÃ¼klendiyse formu temizle
            if (lastCheckedPhone && phone && lastCheckedPhone !== phone && form.dataset.leadId) {
                // Formu sÄ±fÄ±rla
                clearAddLeadForm();
                messageDiv.innerHTML = '';
                lastCheckedPhone = '';
            }
            
            if (!phone || phone.length < 10) {
                messageDiv.innerHTML = '';
                return;
            }
            
            phoneCheckTimeout = setTimeout(() => {
                const existingLead = crmLeads.find(l => phonesMatch(l.phone, phone));
                
                if (existingLead) {
                    // Mevcut mÃ¼ÅŸteri bulundu
                    const branchNames = existingLead.branches?.map(b => {
                        const branch = branches.find(br => br.id === b.branchId);
                        return branch ? branch.name : 'Yok';
                    }).join(', ') || 'Yok';
                    
                    // Mevcut veli isimlerini topla
                    const parentNames = new Set();
                    if (existingLead.branches && existingLead.branches.length > 0) {
                        existingLead.branches.forEach(branch => {
                            if (branch.ageGroup === 'child' && branch.parentName) {
                                parentNames.add(branch.parentName);
                            }
                        });
                    }
                    window.existingParentNames = Array.from(parentNames);
                    
                    let displayName = 'MÃ¼ÅŸteri';
                    if (existingLead.branches && existingLead.branches.length > 0) {
                        const firstBranch = existingLead.branches[0];
                        if (firstBranch.ageGroup === 'adult') {
                            displayName = firstBranch.fullName || 'MÃ¼ÅŸteri';
                        } else {
                            displayName = firstBranch.parentName || 'Veli';
                        }
                    }
                    
                    messageDiv.innerHTML = `<span style="color: #2196F3;">âœ… Mevcut mÃ¼ÅŸteri: <strong>${displayName}</strong> (${branchNames}). Yeni branÅŸ ekleyebilirsiniz.</span>`;
                    
                    // Mevcut mÃ¼ÅŸterinin bilgilerini yÃ¼kle
                    form.dataset.leadId = existingLead.id;
                    form.elements['source'].value = existingLead.source || 'other';
                    
                    // Sekmeli yapÄ± oluÅŸtur
                    branchFieldCounter = 0;
                    const mainContainer = document.getElementById('branches-container');
                    mainContainer.innerHTML = '';
                    
                    if (existingLead.branches && existingLead.branches.length > 0) {
                        // Sekmeli yapÄ± oluÅŸtur
                        let tabsHtml = '<div class="customer-tabs" style="margin-bottom: 15px;">';
                        let tabContentsHtml = '<div id="edit-tabs-content">';
                        
                        existingLead.branches.forEach((branch, index) => {
                            const branchObj = branches.find(b => b.id === branch.branchId);
                            const baseBranchName = branchObj ? `${branchObj.icon} ${branchObj.name}` : 'BranÅŸ';
                            const ageGroupPrefix = branch.ageGroup === 'child' ? 'ğŸ‘¶ Ã‡OCUK - ' : 
                                                   branch.ageGroup === 'adult' ? 'ğŸ‘¨ YETÄ°ÅKÄ°N - ' : '';
                            const branchName = ageGroupPrefix + baseBranchName;
                            
                            // Sekme baÅŸlÄ±ÄŸÄ±
                            tabsHtml += `
                                <button type="button" class="tab-button ${index === 0 ? 'active' : ''}" onclick="switchEditTab(${index})">
                                    ${branchName}
                                </button>
                            `;
                            
                            // formatDate fonksiyonu
                            const formatDate = (dateStr) => {
                                if (!dateStr) return '';
                                const d = new Date(dateStr);
                                if (isNaN(d.getTime())) return '';
                                const y = d.getFullYear();
                                const m = String(d.getMonth() + 1).padStart(2, '0');
                                const day = String(d.getDate()).padStart(2, '0');
                                const h = String(d.getHours()).padStart(2, '0');
                                const min = String(d.getMinutes()).padStart(2, '0');
                                return y + '-' + m + '-' + day + 'T' + h + ':' + min;
                            };
                            
                            // Bu branÅŸ iÃ§in iÃ§eriÄŸi oluÅŸtur
                            const branchFieldHtml = generateBranchFieldHTML({
                                index: index,
                                branchId: branch.branchId,
                                branchData: branch,
                                ageGroup: branch.ageGroup || 'adult',
                                fullName: branch.fullName || '',
                                parentName: branch.parentName || '',
                                children: branch.children || [],
                                selectedTag: branch.selectedTag || '',
                                kayitOlabilirDate: formatDate(branch.kayitOlabilirDate),
                                denemeDate: formatDate(branch.denemeDate),
                                notesHistory: branch.notesHistory || [],
                                newNote: ''
                            });
                            
                            // Sekme iÃ§eriÄŸi
                            tabContentsHtml += `
                                <div class="tab-content ${index === 0 ? 'active' : ''}" id="edit-tab-${index}" style="display: ${index === 0 ? 'block' : 'none'};">
                                    ${branchFieldHtml}
                                </div>
                            `;
                        });
                        
                        // Yeni branÅŸ ekleme sekmesi
                        const newIndex = existingLead.branches.length;
                        tabsHtml += `
                            <button type="button" class="tab-button" onclick="switchEditTab(${newIndex})" style="background: #4CAF50; color: white;">
                                â• Yeni BranÅŸ
                            </button>
                        `;
                        
                        // âœ… Yeni branÅŸ formu iÃ§in tab content ekle
                        const newBranchFormHtml = generateBranchFieldHTML({
                            index: newIndex,
                            branchId: '',
                            ageGroup: '',
                            selectedTag: '',
                            fullName: '',
                            parentName: '',
                            newNote: '',
                            notesHistory: [],
                            childrenArray: [],
                            kayitOlabilirDate: '',
                            denemeDate: ''
                        });
                        
                        tabContentsHtml += `
                            <div class="tab-content" id="edit-tab-${newIndex}" style="display: none;">
                                ${newBranchFormHtml}
                            </div>
                        `;
                        
                        tabsHtml += '</div>';
                        tabContentsHtml += '</div>';
                        
                        mainContainer.innerHTML = tabsHtml + tabContentsHtml;
                        
                        // Her branÅŸ iÃ§in event handler'larÄ± ayarla
                        existingLead.branches.forEach((branch, index) => {
                            const ageGroupSelect = document.querySelector(`#edit-tab-${index} [name="branches[${index}][ageGroup]"]`);
                            if (ageGroupSelect && branch.ageGroup) {
                                handleBranchAgeGroupChange(index, ageGroupSelect);
                            }
                            
                            const tagSelect = document.querySelector(`#edit-tab-${index} [name="branches[${index}][selectedTag]"]`);
                            if (tagSelect && branch.selectedTag) {
                                handleBranchTagSelection(index, tagSelect);
                            }
                        });
                        
                        // âœ… Ä°lk sekmeyi aktif et ve required alanlarÄ± enable et
                        setTimeout(() => {
                            switchEditTab(0);
                        }, 100);
                    } else {
                        // HiÃ§ branÅŸ yoksa tek branÅŸ ekle
                        addBranchField();
                    }
                    
                    document.querySelector('#addLeadModal h3').textContent = `âœï¸ ${displayName} - BranÅŸ Ekle/DÃ¼zenle`;
                    
                    // Son kontrol edilen telefonu kaydet
                    lastCheckedPhone = phone;
                } else {
                    // Yeni mÃ¼ÅŸteri
                    messageDiv.innerHTML = '<span style="color: #4CAF50;">âœ… Yeni mÃ¼ÅŸteri kaydÄ±</span>';
                    form.removeAttribute('data-lead-id');
                    document.querySelector('#addLeadModal h3').textContent = 'â• Yeni Potansiyel MÃ¼ÅŸteri';
                    
                    // Son kontrol edilen telefonu kaydet
                    lastCheckedPhone = phone;
                }
            }, 500);
        };
        
        // Form temizleme fonksiyonu
        function clearAddLeadForm() {
            const form = document.getElementById('addLeadForm');
            if (!form) return;
            
            // leadId'yi temizle
            form.removeAttribute('data-lead-id');
            
            // Telefon hariÃ§ formu resetle (telefon inputu deÄŸiÅŸmemeli)
            const phoneInput = form.querySelector('input[name="phone"]');
            const phoneValue = phoneInput ? phoneInput.value : '';
            
            // KaynaÄŸÄ± varsayÄ±lana Ã§ek
            const sourceSelect = form.querySelector('select[name="source"]');
            if (sourceSelect) sourceSelect.value = 'other';
            
            // BranÅŸ container'Ä± temizle ve yeni bir tane ekle
            const branchesContainer = document.getElementById('branches-container');
            if (branchesContainer) {
                branchesContainer.innerHTML = '';
                branchFieldCounter = 0;
                addBranchField();
            }
            
            // Telefon deÄŸerini geri yaz
            if (phoneInput) phoneInput.value = phoneValue;
            
            // Modal baÅŸlÄ±ÄŸÄ±nÄ± gÃ¼ncelle
            document.querySelector('#addLeadModal h3').textContent = 'â• Yeni Potansiyel MÃ¼ÅŸteri';
            
            // Global deÄŸiÅŸkenleri temizle
            window.existingParentNames = [];
            lastCheckedPhone = '';
        }
        
        // Lead Modal AÃ§
        function openAddLeadModal() {
            const modal = document.getElementById('addLeadModal');
            if (!modal) {
                console.error('âŒ addLeadModal bulunamadÄ±!');
                return;
            }
            
            const form = document.getElementById('addLeadForm');
            form.reset();
            form.removeAttribute('data-lead-id');
            
            // Submit butonunu resetle
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'ğŸ’¾ Kaydet';
            }
            
            // MesajÄ± temizle
            document.getElementById('phone-check-message').innerHTML = '';
            
            // BranÅŸ container'Ä± temizle
            document.getElementById('branches-container').innerHTML = '';
            branchFieldCounter = 0;
            
            // Otomatik ilk branÅŸ ekle
            addBranchField();
            
            // BranÅŸ ekleme butonunu gÃ¶ster (yeni mÃ¼ÅŸteri modunda)
            const addBranchBtn = document.querySelector('#addLeadModal .btn-success[onclick*="addBranchField"]');
            if (addBranchBtn) addBranchBtn.style.display = 'inline-block';
            
            // lastCheckedPhone'u sÄ±fÄ±rla
            lastCheckedPhone = '';
            
            document.querySelector('#addLeadModal h3').textContent = 'â• Yeni Potansiyel MÃ¼ÅŸteri';
            openModal('addLeadModal');
        }
        
        // Lead DÃ¼zenle
        function editLead(leadId, openBranchIndex = 0) {
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) {
                console.error('Lead bulunamadÄ±:', leadId);
                return;
            }
            
            const modal = document.getElementById('addLeadModal');
            const form = document.getElementById('addLeadForm');
            
            form.elements['phone'].value = lead.phone || '';
            form.elements['source'].value = lead.source || 'other';
            
            const formatDate = (date) => {
                if (!date) return '';
                const d = new Date(date);
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const h = String(d.getHours()).padStart(2, '0');
                const min = String(d.getMinutes()).padStart(2, '0');
                return `${y}-${m}-${day}T${h}:${min}`;
            };
            
            // Sekmeli yapÄ± oluÅŸtur
            branchFieldCounter = 0;
            
            // Ã–nce container'Ä± temizle
            const mainContainer = document.getElementById('branches-container');
            mainContainer.innerHTML = '';
            
            if (lead.branches && lead.branches.length > 0) {
                // Sekmeli yapÄ± oluÅŸtur
                let tabsHtml = '<div class="customer-tabs" style="margin-bottom: 15px;">';
                let tabContentsHtml = '<div id="edit-tabs-content">';
                
                lead.branches.forEach((branch, index) => {
                    const branchObj = branches.find(b => b.id === branch.branchId);
                    const baseBranchName = branchObj ? `${branchObj.icon} ${branchObj.name}` : 'BranÅŸ';
                    const ageGroupPrefix = branch.ageGroup === 'child' ? 'ğŸ‘¶ Ã‡OCUK - ' : 
                                           branch.ageGroup === 'adult' ? 'ğŸ‘¨ YETÄ°ÅKÄ°N - ' : '';
                    const branchName = ageGroupPrefix + baseBranchName;
                    
                    // Sekme baÅŸlÄ±ÄŸÄ± - openBranchIndex'e gÃ¶re aktif sekmeyi belirle
                    tabsHtml += `
                        <button type="button" class="tab-button ${index === openBranchIndex ? 'active' : ''}" onclick="switchEditTab(${index})">
                            ${branchName}
                        </button>
                    `;
                    
                    // Bu branÅŸ iÃ§in ayrÄ± field container oluÅŸtur
                    const tempContainer = document.createElement('div');
                    tempContainer.id = 'temp-branch-container';
                    
                    // addBranchField ile iÃ§eriÄŸi oluÅŸtur
                    const branchFieldHtml = generateBranchFieldHTML({
                        index: index,
                        branchId: branch.branchId,
                        branchData: branch,
                        ageGroup: branch.ageGroup || 'adult',
                        fullName: branch.fullName || '',
                        parentName: branch.parentName || '',
                        children: branch.children || [],
                        selectedTag: branch.selectedTag || '',
                        kayitOlabilirDate: formatDate(branch.kayitOlabilirDate),
                        denemeDate: formatDate(branch.denemeDate),
                        notesHistory: branch.notesHistory || [],
                        newNote: ''
                    });
                    
                    // Sekme iÃ§eriÄŸi - openBranchIndex'e gÃ¶re gÃ¶ster
                    tabContentsHtml += `
                        <div class="tab-content ${index === openBranchIndex ? 'active' : ''}" id="edit-tab-${index}" style="display: ${index === openBranchIndex ? 'block' : 'none'};">
                            ${branchFieldHtml}
                        </div>
                    `;
                });
                
                tabsHtml += '</div>';
                tabContentsHtml += '</div>';
                
                mainContainer.innerHTML = tabsHtml + tabContentsHtml;
                
                // Her branÅŸ iÃ§in event handler'larÄ± ayarla
                lead.branches.forEach((branch, index) => {
                    const ageGroupSelect = document.querySelector(`#edit-tab-${index} [name="branches[${index}][ageGroup]"]`);
                    if (ageGroupSelect && branch.ageGroup) {
                        handleBranchAgeGroupChange(index, ageGroupSelect);
                    }
                    
                    const tagSelect = document.querySelector(`#edit-tab-${index} [name="branches[${index}][selectedTag]"]`);
                    if (tagSelect && branch.selectedTag) {
                        handleBranchTagSelection(index, tagSelect);
                    }
                });
                
                // âœ… AÃ§Ä±lacak sekmeyi aktif et ve required alanlarÄ± doÄŸru ÅŸekilde enable/disable et
                setTimeout(() => {
                    switchEditTab(openBranchIndex);
                }, 100);
            }
            
            form.dataset.leadId = leadId;
            
            let displayName = lead.fullName || 'MÃ¼ÅŸteri';
            if (lead.branches && lead.branches.length > 0) {
                const firstBranch = lead.branches[0];
                if (firstBranch.ageGroup === 'adult') {
                    displayName = firstBranch.fullName || lead.fullName || 'MÃ¼ÅŸteri';
                } else {
                    displayName = firstBranch.parentName || lead.fullName || 'Veli';
                }
            }
            
            // BranÅŸ ekleme butonunu gizle (dÃ¼zenleme modunda)
            const addBranchBtn = document.querySelector('#addLeadModal .btn-success[onclick*="addBranchField"]');
            if (addBranchBtn) addBranchBtn.style.display = 'none';
            
            // Submit butonunu resetle
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'ğŸ’¾ Kaydet';
            }
            
            document.querySelector('#addLeadModal h3').textContent = `âœï¸ ${displayName} - DÃ¼zenle`;
            openModal('addLeadModal');
        }
        
        // WhatsApp'tan CRM lead detayÄ±nÄ± aÃ§
        window.openCrmLeadDetail = function(leadId) {
            // âœ… SayfayÄ± deÄŸiÅŸtirmeden modal'Ä± aÃ§
            editLead(leadId, 0);
        }
        
        // DÃ¼zenleme sekmelerini deÄŸiÅŸtir
        window.switchEditTab = function(tabIndex) {
            // TÃ¼m butonlardan active kaldÄ±r
            document.querySelectorAll('#addLeadModal .tab-button').forEach(btn => btn.classList.remove('active'));
            
            // TÃ¼m iÃ§erikleri gizle ve required attribute'Ã¼ disable et
            document.querySelectorAll('#edit-tabs-content .tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
                
                // âœ… Gizli sekmelerdeki required alanlarÄ± disable et
                content.querySelectorAll('[required]').forEach(input => {
                    input.disabled = true;
                });
            });
            
            const tabs = document.querySelectorAll('#addLeadModal .tab-button');
            const contents = document.querySelectorAll('#edit-tabs-content .tab-content');
            
            // SeÃ§ili sekmeyi aktif yap
            if (tabs[tabIndex]) tabs[tabIndex].classList.add('active');
            if (contents[tabIndex]) {
                contents[tabIndex].classList.add('active');
                contents[tabIndex].style.display = 'block';
                
                // âœ… Aktif sekmedeki required alanlarÄ± enable et
                contents[tabIndex].querySelectorAll('[required]').forEach(input => {
                    input.disabled = false;
                });
            }
        };
        
        // CRM mÃ¼ÅŸteriyi sil
        window.deleteCRMLead = async function(leadId) {
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) {
                showAlert('âŒ MÃ¼ÅŸteri bulunamadÄ±', 'danger');
                return;
            }
            
            if (!confirm(`"${lead.fullName}" isimli mÃ¼ÅŸteriyi silmek istediÄŸinize emin misiniz?\n\nBu iÅŸlem geri alÄ±namaz!`)) {
                return;
            }
            
            try {
                await window.firebase.deleteDoc(
                    window.firebase.doc(window.db, 'crmLeads', leadId)
                );
                
                // Ã–nce global diziden sil (anÄ±nda UI gÃ¼ncellemesi iÃ§in)
                const leadIndex = crmLeads.findIndex(l => l.id === leadId);
                if (leadIndex !== -1) {
                    crmLeads.splice(leadIndex, 1);
                }
                
                // Modal'Ä± hemen kapat
                closeModal('customerDetailModal');
                
                showAlert('âœ… MÃ¼ÅŸteri baÅŸarÄ±yla silindi', 'success');
                
                // CRM listesini hemen yenile (refresh beklemeden)
                renderCRMLeads();
                renderCRMDashboard();
                renderCurrentSection();
                
                // Arka planda full data reload (senkronizasyon iÃ§in)
                loadData().catch(err => console.error('Background loadData error:', err));
            } catch (error) {
                console.error('MÃ¼ÅŸteri silme hatasÄ±:', error);
                showAlert('âŒ MÃ¼ÅŸteri silinemedi: ' + error.message, 'danger');
            }
        };
        
        // MÃ¼ÅŸteri detay sayfasÄ±nÄ± aÃ§
        window.openCustomerDetail = function(leadId, openBranchIndex = 0) {
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) return;
            
            // Sekmeler ve iÃ§erikler
            let tabsHtml = '';
            let tabContentsHtml = '';
            
            if (lead.branches && lead.branches.length > 0) {
                lead.branches.forEach((branchData, index) => {
                    const branch = branches.find(b => b.id === branchData.branchId);
                    const baseBranchName = branch ? `${branch.icon} ${branch.name}` : 'Bilinmeyen BranÅŸ';
                    
                    // YaÅŸ grubu etiketi ekle
                    const ageGroupPrefix = branchData.ageGroup === 'child' ? 'ğŸ‘¶ Ã‡OCUK - ' : 
                                           branchData.ageGroup === 'adult' ? 'ğŸ‘¨ YETÄ°ÅKÄ°N - ' : '';
                    const branchName = ageGroupPrefix + baseBranchName;
                    const selectedTag = branchData.selectedTag || 'Yok';
                    
                    // Sekme baÅŸlÄ±ÄŸÄ± - aÃ§Ä±lacak sekmeyi belirle
                    tabsHtml += `
                        <button class="tab-button ${index === openBranchIndex ? 'active' : ''}" onclick="switchCustomerTab(${index})">
                            ${branchName}
                        </button>
                    `;
                    
                    // Not geÃ§miÅŸi - En yeni aÃ§Ä±klamalar en Ã¼stte
                    const notesHistory = branchData.notesHistory || [];
                    const notesHtml = notesHistory.length > 0 ? notesHistory.slice().reverse().map((note, noteIndex) => `
                        <div style="padding: 10px; margin-bottom: 10px; border-left: 3px solid var(--primary-color); background: white; border-radius: 6px;">
                            <div style="font-size: 11px; color: #666; margin-bottom: 5px;">
                                ğŸ‘¤ ${note.by} - ${note.date}
                            </div>
                            <div style="font-size: 13px; white-space: pre-wrap;">${note.text}</div>
                        </div>
                    `).join('') : '<p style="color: #999; font-size: 13px; text-align: center; padding: 20px;">HenÃ¼z aÃ§Ä±klama yok</p>';
                    
                    // YaÅŸ grubu ve isim bilgileri
                    let ageGroupInfo = '';
                    if (branchData.ageGroup === 'child') {
                        ageGroupInfo = `
                            <div class="branch-info-item">
                                <strong>ğŸ‘¶ YaÅŸ Grubu</strong>
                                <span>Ã‡ocuk</span>
                            </div>
                            <div class="branch-info-item">
                                <strong>ğŸ‘¨ Veli</strong>
                                <span>${branchData.parentName || 'BelirtilmemiÅŸ'}</span>
                            </div>
                        `;
                        
                        if (branchData.children && branchData.children.length > 0) {
                            // Her Ã§ocuk iÃ§in ayrÄ± kartlar
                            ageGroupInfo += `
                                <div class="branch-info-item" style="grid-column: 1 / -1;">
                                    <strong>ğŸ‘¶ Ã‡ocuklar</strong>
                                    <div style="margin-top: 12px; display: grid; gap: 12px;">
                                        ${branchData.children.map((child, childIdx) => `
                                            <div style="background: white; padding: 15px; border-radius: 12px; border: 2px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                                    <div>
                                                        <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 4px;">${child.name}</div>
                                                        <div style="font-size: 13px; color: #666;">ğŸ‚ ${child.age} yaÅŸ</div>
                                                    </div>
                                                    ${child.selectedTag ? `
                                                        <span style="background: #667eea; color: white; padding: 6px 12px; border-radius: 16px; font-size: 11px;">
                                                            ğŸ·ï¸ ${child.selectedTag}
                                                        </span>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }
                    } else if (branchData.ageGroup === 'adult') {
                        ageGroupInfo = `
                            <div class="branch-info-item">
                                <strong>ğŸ‘¨ YaÅŸ Grubu</strong>
                                <span>YetiÅŸkin</span>
                            </div>
                            <div class="branch-info-item">
                                <strong>ğŸ“ Ad Soyad</strong>
                                <span>${branchData.fullName || 'BelirtilmemiÅŸ'}</span>
                            </div>
                        `;
                    }
                    
                    // Sekme iÃ§eriÄŸi - openBranchIndex parametresine gÃ¶re gÃ¶ster
                    tabContentsHtml += `
                        <div class="tab-content ${index === openBranchIndex ? 'active' : ''}" id="tab-${index}" style="display: ${index === openBranchIndex ? 'block' : 'none'};">
                            <div class="branch-tab-content">
                                <div class="branch-info-grid">
                                    ${ageGroupInfo}
                                    ${branchData.ageGroup === 'adult' ? `
                                        <div class="branch-info-item">
                                            <strong>ğŸ·ï¸ Etiket</strong>
                                            <span style="color: var(--primary-color);">${selectedTag}</span>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <div style="margin-top: 20px;">
                                    <h4 style="font-size: 14px; color: #666; margin-bottom: 12px;">ğŸ“‹ AÃ§Ä±klama GeÃ§miÅŸi</h4>
                                    <div style="max-height: 300px; overflow-y: auto;">
                                        ${notesHtml}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                tabsHtml = '';
                tabContentsHtml = '';
            }
            
            // GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ± sekmesi ekle (Bulutfon aktifse)
            let callRecordsTabIndex = lead.branches ? lead.branches.length : 0;
            let historyTabIndex = callRecordsTabIndex;
            let newBranchIndex = callRecordsTabIndex;
            
            if (clubSettings && clubSettings.bulutfonEnabled) {
                tabsHtml += `
                    <button class="tab-button" onclick="switchCustomerTab(${callRecordsTabIndex}); loadCallRecordsTab('${leadId}', 'tab-calls-${callRecordsTabIndex}')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        ğŸ“ GÃ¶rÃ¼ÅŸme KayÄ±tlarÄ±
                    </button>
                `;
                
                tabContentsHtml += `
                    <div class="tab-content" id="tab-calls-${callRecordsTabIndex}" style="display: none;">
                        <div class="branch-tab-content">
                            <h4 style="font-size: 16px; color: #666; margin-bottom: 15px;">ğŸ“ GÃ¶rÃ¼ÅŸme KayÄ±tlarÄ±</h4>
                            <div id="callRecords-${leadId}">
                                <div class="loading"><div class="spinner"></div><span>YÃ¼kleniyor...</span></div>
                            </div>
                        </div>
                    </div>
                `;
                
                historyTabIndex = callRecordsTabIndex + 1;
                newBranchIndex = historyTabIndex + 1;
            } else {
                historyTabIndex = callRecordsTabIndex;
                newBranchIndex = historyTabIndex + 1;
            }
            
            // History sekmesi ekle
            tabsHtml += `
                <button class="tab-button" onclick="switchCustomerTab(${historyTabIndex})" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                    ğŸ“œ GeÃ§miÅŸ
                </button>
            `;
            
            const historyHtml = (lead.history && lead.history.length > 0) 
                ? lead.history.slice().reverse().map((entry, index) => `
                    <div style="padding: 12px; margin-bottom: 10px; border-left: 4px solid #f5576c; background: white; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size: 11px; color: #666; margin-bottom: 5px;">
                            ğŸ‘¤ ${entry.by} - ${entry.date}
                        </div>
                        <div style="font-size: 13px; color: #333; font-weight: 500;">${entry.details}</div>
                    </div>
                `).join('')
                : '<p style="color: #999; font-size: 13px; text-align: center; padding: 20px;">HenÃ¼z geÃ§miÅŸ kaydÄ± yok</p>';
            
            tabContentsHtml += `
                <div class="tab-content" id="tab-history-${historyTabIndex}" style="display: none;">
                    <div class="branch-tab-content">
                        <h4 style="font-size: 16px; color: #666; margin-bottom: 15px;">ğŸ“œ MÃ¼ÅŸteri GeÃ§miÅŸi</h4>
                        <div style="max-height: 500px; overflow-y: auto;">
                            ${historyHtml}
                        </div>
                    </div>
                </div>
            `;
            
            // Yeni branÅŸ ekleme sekmesi ve iÃ§eriÄŸi
            tabsHtml += `
                <button class="tab-button" onclick="switchCustomerTab(${newBranchIndex})" style="background: #4CAF50; color: white; font-weight: bold;">
                    â• Yeni BranÅŸ
                </button>
            `;
            
            // Yeni branÅŸ ekleme formu
            const nonBranchTags = crmTags
                .filter(tag => tag.category !== 'branch')
                .sort((a, b) => (a.order || 999) - (b.order || 999));
            
            tabContentsHtml += `
                <div class="tab-content" id="tab-${newBranchIndex}" style="display: none;">
                    <div class="branch-tab-content">
                        <h4 style="font-size: 16px; color: #666; margin-bottom: 15px;">â• Yeni BranÅŸ Ekle</h4>
                        <form id="addNewBranchForm" onsubmit="handleAddNewBranch(event, '${lead.id}'); return false;">
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                                <div class="form-group">
                                    <label>BranÅŸ *</label>
                                    <select name="branchId" class="form-control" required>
                                        <option value="">SeÃ§iniz...</option>
                                        ${branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>YaÅŸ Grubu *</label>
                                    <select name="ageGroup" class="form-control" required onchange="handleNewBranchAgeGroupChange(this)">
                                        <option value="">SeÃ§iniz...</option>
                                        <option value="adult">ğŸ‘¨ YetiÅŸkin</option>
                                        <option value="child">ğŸ‘¶ Ã‡ocuk</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- YetiÅŸkin iÃ§in -->
                            <div id="new-branch-adult" style="display: none;">
                                <div class="form-group">
                                    <label>Ad Soyad *</label>
                                    <input type="text" name="fullName" class="form-control" placeholder="Ad Soyad">
                                </div>
                                <div class="form-group">
                                    <label>ğŸ·ï¸ Etiket</label>
                                    <select name="selectedTag" class="form-control" onchange="handleNewBranchTagChange(this)">
                                        <option value="">Etiket seÃ§iniz...</option>
                                        ${nonBranchTags.map(tag => `<option value="${tag.name}">${tag.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div id="new-branch-adult-dates" style="display: none;">
                                    <div id="new-branch-adult-kayit" style="display: none;">
                                        <label>ğŸ“… KayÄ±t Olabilir Tarihi</label>
                                        <input type="datetime-local" name="kayitOlabilirDate" class="form-control">
                                    </div>
                                    <div id="new-branch-adult-deneme" style="display: none;">
                                        <label>ğŸ“… Deneme Dersi Tarihi</label>
                                        <input type="datetime-local" name="denemeDate" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Ã‡ocuk iÃ§in -->
                            <div id="new-branch-child" style="display: none;">
                                <div class="form-group">
                                    <label>Veli Ad Soyad *</label>
                                    <input type="text" name="parentName" class="form-control" placeholder="Veli ismi" value="${lead.branches && lead.branches.length > 0 && lead.branches[0].parentName ? lead.branches[0].parentName : ''}">
                                </div>
                                <div class="form-group">
                                    <label>Ã‡ocuk Ad Soyad</label>
                                    <input type="text" name="childName" class="form-control" placeholder="Ã‡ocuk ismi">
                                </div>
                                <div class="form-group">
                                    <label>Ã‡ocuk YaÅŸ</label>
                                    <input type="number" name="childAge" class="form-control" placeholder="YaÅŸ" min="1" max="18">
                                </div>
                                <div class="form-group">
                                    <label>ğŸ·ï¸ Etiket</label>
                                    <select name="childTag" class="form-control" onchange="handleNewChildTagChange(this)">
                                        <option value="">Etiket seÃ§iniz...</option>
                                        ${nonBranchTags.map(tag => `<option value="${tag.name}">${tag.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div id="new-branch-child-dates" style="display: none;">
                                    <div id="new-branch-child-kayit" style="display: none;">
                                        <label>ğŸ“… KayÄ±t Olabilir Tarihi</label>
                                        <input type="datetime-local" name="childKayitDate" class="form-control">
                                    </div>
                                    <div id="new-branch-child-deneme" style="display: none;">
                                        <label>ğŸ“… Deneme Dersi Tarihi</label>
                                        <input type="datetime-local" name="childDenemeDate" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>ğŸ“ AÃ§Ä±klama</label>
                                <textarea name="newNote" class="form-control" rows="3" placeholder="BranÅŸ hakkÄ±nda not..."></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="width: 100%;">ğŸ’¾ BranÅŸÄ± Kaydet</button>
                        </form>
                    </div>
                </div>
            `;
            
            const html = `
                <div id="customerDetailModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <span class="close" onclick="closeModal('customerDetailModal')">&times;</span>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">ğŸ‘¤ ${lead.fullName}</h3>
                            <button class="btn btn-danger btn-sm" onclick="deleteCRMLead('${lead.id}')" style="padding: 6px 12px;">
                                ğŸ—‘ï¸ MÃ¼ÅŸteriyi Sil
                            </button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">ğŸ“ Telefon</div>
                                <div style="font-size: 18px; font-weight: bold;">${lead.phone}</div>
                            </div>
                            ${(() => {
                                const memberMatch = members.find(m => phonesMatch(m.Telefon, lead.phone) || phonesMatch(m.Telefon_2, lead.phone));
                                if (memberMatch) {
                                    return `
                                        <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); padding: 15px; border-radius: 10px; color: white; text-align: center; cursor: pointer;" onclick="showMemberAttendancePage('${memberMatch.id}')" title="Ãœye sayfasÄ±na git">
                                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">âœ… Ãœyelik Durumu</div>
                                            <div style="font-size: 18px; font-weight: bold;">ÃœYE</div>
                                        </div>
                                    `;
                                } else {
                                    return `
                                        <div style="background: linear-gradient(135deg, #999 0%, #777 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">âŒ Ãœyelik Durumu</div>
                                            <div style="font-size: 18px; font-weight: bold;">ÃœYE DEÄÄ°L</div>
                                        </div>
                                    `;
                                }
                            })()}
                            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">ğŸ¯ BranÅŸ SayÄ±sÄ±</div>
                                <div style="font-size: 18px; font-weight: bold;">${lead.branches ? lead.branches.length : 0}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">ğŸ“ Kaynak</div>
                                <div style="font-size: 16px; font-weight: bold;">${getSourceName(lead.source || 'other')}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">ğŸ“… OluÅŸturma</div>
                                <div style="font-size: 16px; font-weight: bold;">${lead.createdAt ? new Date(lead.createdAt).toLocaleDateString('tr-TR') : '-'}</div>
                            </div>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <h4 style="font-size: 16px; color: #666; margin-bottom: 10px;">ğŸ¯ BranÅŸlar ve Bilgiler</h4>
                            <div class="customer-tabs">
                                ${tabsHtml}
                            </div>
                            ${tabContentsHtml}
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
                            <button class="btn btn-primary" onclick="closeModal('customerDetailModal'); editLead('${lead.id}', ${openBranchIndex})">âœï¸ DÃ¼zenle</button>
                            <button class="btn btn-success" onclick="closeModal('customerDetailModal'); openWhatsAppWithLead('${lead.id}')">ğŸ’¬ WhatsApp</button>
                            <button class="btn btn-secondary" onclick="closeModal('customerDetailModal')">Kapat</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Modal varsa kaldÄ±r
            const existing = document.getElementById('customerDetailModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', html);
            
            // Backdrop'a tÄ±klayÄ±nca modalÄ± kapat
            const modal = document.getElementById('customerDetailModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    // EÄŸer modal'Ä±n kendisine (backdrop) tÄ±klanmÄ±ÅŸsa kapat, iÃ§eriÄŸe tÄ±klanmamÄ±ÅŸsa kapatma
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
        };
        
        // GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ± sekmesi yÃ¼kleyici
        window.loadCallRecordsTab = async function(leadId, tabId) {
            // EÄŸer zaten yÃ¼klenmiÅŸ ise tekrar yÃ¼kleme
            const tabElement = document.getElementById(tabId);
            if (!tabElement) return;
            
            const contentDiv = tabElement.querySelector(`#callRecords-${leadId}`);
            if (!contentDiv || contentDiv.dataset.loaded === 'true') return;
            
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) return;
            
            await renderCallRecords(lead.phone, `callRecords-${leadId}`);
            contentDiv.dataset.loaded = 'true';
        };
        
        // MÃ¼ÅŸteri detay sekmelerini deÄŸiÅŸtir
        window.switchCustomerTab = function(tabIndex) {
            // Modal iÃ§indeki sekmeleri bul
            const modal = document.getElementById('customerDetailModal');
            if (!modal) return;
            
            // TÃ¼m sekme butonlarÄ±nÄ± pasif yap
            const tabs = modal.querySelectorAll('.tab-button');
            tabs.forEach(btn => btn.classList.remove('active'));
            
            // TÃ¼m sekme iÃ§eriklerini gizle
            const contents = modal.querySelectorAll('.tab-content');
            contents.forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // SeÃ§ilen sekmeyi aktif yap
            if (tabs[tabIndex]) {
                tabs[tabIndex].classList.add('active');
            }
            if (contents[tabIndex]) {
                contents[tabIndex].classList.add('active');
                contents[tabIndex].style.display = 'block';
            }
        };
        
        // Yeni branÅŸ yaÅŸ grubu deÄŸiÅŸimi
        window.handleNewBranchAgeGroupChange = function(selectElement) {
            const value = selectElement.value;
            const adultDiv = document.getElementById('new-branch-adult');
            const childDiv = document.getElementById('new-branch-child');
            
            if (value === 'adult') {
                adultDiv.style.display = 'block';
                childDiv.style.display = 'none';
                adultDiv.querySelector('[name="fullName"]').required = true;
                childDiv.querySelector('[name="parentName"]').required = false;
            } else if (value === 'child') {
                adultDiv.style.display = 'none';
                childDiv.style.display = 'block';
                childDiv.querySelector('[name="parentName"]').required = true;
                adultDiv.querySelector('[name="fullName"]').required = false;
            } else {
                adultDiv.style.display = 'none';
                childDiv.style.display = 'none';
            }
        };
        
        // Yeni branÅŸ yetiÅŸkin etiket deÄŸiÅŸimi
        window.handleNewBranchTagChange = function(selectElement) {
            const value = selectElement.value;
            const datesDiv = document.getElementById('new-branch-adult-dates');
            const kayitDiv = document.getElementById('new-branch-adult-kayit');
            const denemeDiv = document.getElementById('new-branch-adult-deneme');
            
            if (value === 'KayÄ±t Olabilir') {
                datesDiv.style.display = 'block';
                kayitDiv.style.display = 'block';
                denemeDiv.style.display = 'none';
            } else if (value === 'Denemeye Gelecek') {
                datesDiv.style.display = 'block';
                kayitDiv.style.display = 'none';
                denemeDiv.style.display = 'block';
                // âœ… JavaScript validasyonu kullanÄ±lÄ±yor, HTML required kaldÄ±rÄ±ldÄ±
            } else {
                datesDiv.style.display = 'none';
                kayitDiv.style.display = 'none';
                denemeDiv.style.display = 'none';
            }

            // Etiket seÃ§iminden sonra form sonuna kaydÄ±r
            try {
                const form = selectElement.closest('form');
                if (form) {
                    setTimeout(() => {
                        form.scrollTo({ top: form.scrollHeight, behavior: 'smooth' });
                    }, 50);
                }
            } catch(e) { /* no-op */ }
        };
        
        // Yeni branÅŸ Ã§ocuk etiket deÄŸiÅŸimi
        window.handleNewChildTagChange = function(selectElement) {
            const value = selectElement.value;
            const datesDiv = document.getElementById('new-branch-child-dates');
            const kayitDiv = document.getElementById('new-branch-child-kayit');
            const denemeDiv = document.getElementById('new-branch-child-deneme');
            
            if (value === 'KayÄ±t Olabilir') {
                datesDiv.style.display = 'block';
                kayitDiv.style.display = 'block';
                denemeDiv.style.display = 'none';
            } else if (value === 'Denemeye Gelecek') {
                datesDiv.style.display = 'block';
                kayitDiv.style.display = 'none';
                denemeDiv.style.display = 'block';
                // âœ… JavaScript validasyonu kullanÄ±lÄ±yor, HTML required kaldÄ±rÄ±ldÄ±
            } else {
                datesDiv.style.display = 'none';
                kayitDiv.style.display = 'none';
                denemeDiv.style.display = 'none';
            }
        };
        
        // Yeni branÅŸ ekleme
        window.handleAddNewBranch = async function(event, leadId) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            // Submit butonunu devre dÄ±ÅŸÄ± bÄ±rak
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'â³ Kaydediliyor...';
            
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) {
                showAlert('âŒ MÃ¼ÅŸteri bulunamadÄ±!', 'danger');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                return;
            }
            
            // Yeni branÅŸ verisi
            const newBranch = {
                branchId: formData.get('branchId'),
                ageGroup: formData.get('ageGroup'),
                notesHistory: [],
                createdAt: new Date().toISOString()
            };
            
            // AÃ§Ä±klama varsa ekle
            if (formData.get('newNote')) {
                newBranch.notesHistory.push({
                    text: formData.get('newNote'),
                    by: currentUser.fullName || currentUser.email,
                    date: new Date().toLocaleString('tr-TR')
                });
            }
            
            // YaÅŸ grubuna gÃ¶re veri ekle
            if (newBranch.ageGroup === 'adult') {
                newBranch.fullName = formData.get('fullName');
                newBranch.selectedTag = formData.get('selectedTag') || '';
                newBranch.kayitOlabilirDate = formData.get('kayitOlabilirDate') || '';
                newBranch.denemeDate = formData.get('denemeDate') || '';
            } else if (newBranch.ageGroup === 'child') {
                newBranch.parentName = formData.get('parentName');
                newBranch.children = [];
                
                // Ã‡ocuk bilgisi varsa ekle
                if (formData.get('childName')) {
                    newBranch.children.push({
                        name: formData.get('childName'),
                        age: formData.get('childAge') || '',
                        selectedTag: formData.get('childTag') || '',
                        kayitOlabilirDate: formData.get('childKayitDate') || '',
                        denemeDate: formData.get('childDenemeDate') || ''
                    });
                }
            }
            
            try {
                // Mevcut branÅŸlara ekle
                const updatedBranches = [...(lead.branches || []), newBranch];
                
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'crmLeads', leadId), {
                    branches: updatedBranches
                });
                
                showAlert('âœ… Yeni branÅŸ baÅŸarÄ±yla eklendi!', 'success');
                
                // Listeyi yenile
                await loadData();
                
                // ModalÄ± kapat ve yeniden aÃ§
                closeModal('customerDetailModal');
                setTimeout(() => openCustomerDetail(leadId), 100);
                
            } catch (error) {
                console.error('BranÅŸ eklenirken hata:', error);
                showAlert('âŒ BranÅŸ eklenirken hata oluÅŸtu: ' + error.message, 'danger');
                
                // Hata durumunda butonu tekrar aktif et
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        };
        
        // MÃ¼ÅŸteriye branÅŸ ekle
        window.addBranchToLead = function(leadId) {
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) return;
            
            // BranÅŸ ekleme butonunu gÃ¶ster
            setTimeout(() => {
                const addBranchBtn = document.querySelector('#addLeadModal .btn-success[onclick*="addBranchField"]');
                if (addBranchBtn) addBranchBtn.style.display = 'inline-block';
            }, 50);
            
            // Telefon numarasÄ±nÄ± otomatik kontrol ettir
            setTimeout(() => {
                const phoneInput = document.querySelector('#addLeadForm input[name="phone"]');
                if (phoneInput) {
                    phoneInput.value = lead.phone;
                    phoneInput.dispatchEvent(new Event('input'));
                }
            }, 100);
            
            openModal('addLeadModal');
        };
        
        // AÃ§Ä±klama geÃ§miÅŸinden bir notu sil
        window.deleteNoteHistory = async function(leadId, noteIndex) {
            if (!confirm('Bu aÃ§Ä±klamayÄ± silmek istediÄŸinize emin misiniz?')) return;
            
            try {
                const lead = crmLeads.find(l => l.id === leadId);
                if (!lead) return;
                
                const notesHistory = lead.notesHistory || [];
                notesHistory.splice(noteIndex, 1);
                
                await window.firebase.updateDoc(
                    window.firebase.doc(window.db, 'crmLeads', leadId),
                    { notesHistory: notesHistory }
                );
                
                showAlert('âœ… AÃ§Ä±klama silindi!', 'success');
                await loadData();
                
                // Modal'Ä± yenile
                closeModal('customerDetailModal');
                openCustomerDetail(leadId);
            } catch (error) {
                console.error('AÃ§Ä±klama silme hatasÄ±:', error);
                showAlert('âŒ Silme iÅŸlemi baÅŸarÄ±sÄ±z: ' + error.message, 'danger');
            }
        };
        
        // WhatsApp ile lead'e mesaj at
        window.openWhatsAppWithLead = function(leadId) {
            const lead = crmLeads.find(l => l.id === leadId);
            if (!lead) return;
            
            // WhatsApp bÃ¶lÃ¼mÃ¼ne git
            showSection('whatsapp', document.querySelector('.nav-btn[onclick*="whatsapp"]'));
            
            // Telefon numarasÄ±nÄ± temizle ve formatla
            let phone = lead.phone.replace(/\D/g, '');
            if (phone.startsWith('0')) {
                phone = '90' + phone.substring(1);
            } else if (!phone.startsWith('90')) {
                phone = '90' + phone;
            }
            
            // Chat'i aÃ§ (bir sÃ¼re bekle ki sayfa yÃ¼klensin)
            setTimeout(() => {
                const phoneWithSuffix = phone + '@s.whatsapp.net';
                // WhatsApp chat aÃ§ma fonksiyonunu Ã§aÄŸÄ±r
                if (window.openWhatsAppChat) {
                    window.openWhatsAppChat(phoneWithSuffix);
                }
            }, 500);
        };
        
        // Lead Sil
        async function deleteLead(leadId) {
            if (!confirm('Bu potansiyel mÃ¼ÅŸteriyi silmek istediÄŸinize emin misiniz?')) return;
            
            try {
                await window.firebase.deleteDoc(window.firebase.doc(window.db, 'crmLeads', leadId));
                showAlert('âœ… MÃ¼ÅŸteri baÅŸarÄ±yla silindi!', 'success');
                await loadData();
                renderCRMDashboard();
                renderCRMLeads();
            } catch (error) {
                console.error('Lead silme hatasÄ±:', error);
                showAlert('âŒ Silme iÅŸlemi baÅŸarÄ±sÄ±z: ' + error.message, 'danger');
            }
        }
        
        // Lead Kaydet/GÃ¼ncelle
        async function handleAddLead(e) {
            e.preventDefault();
            const form = e.target;
            const leadId = form.dataset.leadId;
            const formData = new FormData(form);
            
            // âœ… Kaydet butonunu devre dÄ±ÅŸÄ± bÄ±rak ve loading gÃ¶ster
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'â³ Kaydediliyor...';
            
            const phoneRaw = formData.get('phone');
            // Telefon numarasÄ±nÄ± temizle - boÅŸluklar, tire vb. kaldÄ±r
            const phone = cleanPhoneNumber(phoneRaw);
            
            // Telefon numarasÄ± boÅŸ mu kontrol et
            if (!phone || phone.length < 10) {
                showAlert('âš ï¸ GeÃ§erli bir telefon numarasÄ± girin!', 'warning');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                return;
            }
            
            // YENÄ° EKLEME: AynÄ± telefon numarasÄ± var mÄ± kontrol et - phonesMatch kullan
            if (!leadId) { // Sadece yeni ekleme yapÄ±lÄ±rken kontrol et
                const existingLead = crmLeads.find(l => phonesMatch(l.phone, phone));
                
                if (existingLead) {
                    const openExisting = confirm(
                        `âš ï¸ Bu telefon numarasÄ± zaten kayÄ±tlÄ±!\n\n` +
                        `MÃ¼ÅŸteri: ${existingLead.fullName}\n` +
                        `Telefon: ${existingLead.phone}\n\n` +
                        `Mevcut mÃ¼ÅŸteriyi aÃ§mak ister misiniz?`
                    );
                    
                    if (openExisting) {
                        closeModal('addLeadModal');
                        openCustomerDetail(existingLead.id);
                    }
                    
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    return;
                }
            }
            
            // BranÅŸ verilerini topla
            const branchesData = [];
            const branchInputs = form.querySelectorAll('[name^="branches["]');
            const branchIndices = new Set();
            
            branchInputs.forEach(input => {
                const match = input.name.match(/branches\[(\d+)\]\[(\w+)\]/);
                if (match) {
                    branchIndices.add(parseInt(match[1]));
                }
            });
            
            const now = new Date();
            const dateStr = now.toLocaleString('tr-TR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            const userName = currentUser.fullName || currentUser.email || 'KullanÄ±cÄ±';
            
            branchIndices.forEach(index => {
                const branchId = formData.get(`branches[${index}][branchId]`);
                if (!branchId) return; // BranÅŸ seÃ§ilmemiÅŸse atla
                
                const ageGroup = formData.get(`branches[${index}][ageGroup]`);
                const selectedTag = formData.get(`branches[${index}][selectedTag]`);
                const newNote = formData.get(`branches[${index}][newNote]`);
                const kayitOlabilirDate = formData.get(`branches[${index}][kayitOlabilirDate]`);
                const denemeDate = formData.get(`branches[${index}][denemeDate]`);
                const notesHistoryStr = formData.get(`branches[${index}][notesHistory]`);
                const childrenStr = formData.get(`branches[${index}][children]`);
                
                let notesHistory = [];
                try {
                    notesHistory = JSON.parse(notesHistoryStr || '[]');
                } catch (e) {
                    notesHistory = [];
                }
                
                let children = [];
                try {
                    children = JSON.parse(childrenStr || '[]');
                } catch (e) {
                    children = [];
                }
                
                // Yeni not ekle
                if (newNote && newNote.trim()) {
                    notesHistory.push({
                        text: newNote.trim(),
                        by: userName,
                        date: dateStr
                    });
                }
                
                const branchData = {
                    branchId,
                    branchName: branches.find(b => b.id === branchId)?.name || '',
                    ageGroup: ageGroup || 'adult',
                    selectedTag: selectedTag || '',
                    notesHistory,
                    kayitOlabilirDate: kayitOlabilirDate || null,
                    denemeDate: denemeDate || null
                };
                
                // YaÅŸ grubuna gÃ¶re isim bilgisi
                if (ageGroup === 'adult') {
                    branchData.fullName = formData.get(`branches[${index}][fullName]`);
                } else if (ageGroup === 'child') {
                    branchData.parentName = formData.get(`branches[${index}][parentName]`);
                    branchData.children = children.filter(c => c.name && c.name.trim());
                }
                
                branchesData.push(branchData);
            });
            
            // âœ… Validasyon: "Denemeye Gelecek" etiketi seÃ§iliyse deneme tarihi zorunlu
            for (const branch of branchesData) {
                if (branch.selectedTag === 'Denemeye Gelecek') {
                    // YetiÅŸkin iÃ§in deneme tarihi kontrolÃ¼
                    if (branch.ageGroup === 'adult' && (!branch.denemeDate || branch.denemeDate.trim() === '')) {
                        alert('âš ï¸ "Denemeye Gelecek" etiketi seÃ§ildiÄŸinde deneme dersi tarihi zorunludur!\n\nLÃ¼tfen deneme tarihi girin.');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                        return;
                    }
                    // Ã‡ocuklar iÃ§in her Ã§ocuÄŸun deneme tarihi kontrolÃ¼
                    if (branch.ageGroup === 'child' && branch.children && branch.children.length > 0) {
                        const childrenWithDenemeTag = branch.children.filter(child => child.selectedTag === 'Denemeye Gelecek');
                        for (const child of childrenWithDenemeTag) {
                            if (!child.denemeDate || child.denemeDate.trim() === '') {
                                alert(`âš ï¸ "${child.name}" iÃ§in "Denemeye Gelecek" etiketi seÃ§ildiÄŸinde deneme dersi tarihi zorunludur!\n\nLÃ¼tfen deneme tarihi girin.`);
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalText;
                                return;
                            }
                        }
                    }
                }
                
                // âœ… Validasyon: "KayÄ±t Olabilir" etiketi seÃ§iliyse kayÄ±t tarihi zorunlu
                if (branch.selectedTag === 'KayÄ±t Olabilir') {
                    // YetiÅŸkin iÃ§in kayÄ±t tarihi kontrolÃ¼
                    if (branch.ageGroup === 'adult' && (!branch.kayitOlabilirDate || branch.kayitOlabilirDate.trim() === '')) {
                        alert('âš ï¸ "KayÄ±t Olabilir" etiketi seÃ§ildiÄŸinde kayÄ±t olabilir tarihi zorunludur!\n\nLÃ¼tfen kayÄ±t olabilir tarihi girin.');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                        return;
                    }
                    // Ã‡ocuklar iÃ§in her Ã§ocuÄŸun kayÄ±t tarihi kontrolÃ¼
                    if (branch.ageGroup === 'child' && branch.children && branch.children.length > 0) {
                        const childrenWithKayitTag = branch.children.filter(child => child.selectedTag === 'KayÄ±t Olabilir');
                        for (const child of childrenWithKayitTag) {
                            if (!child.kayitOlabilirDate || child.kayitOlabilirDate.trim() === '') {
                                alert(`âš ï¸ "${child.name}" iÃ§in "KayÄ±t Olabilir" etiketi seÃ§ildiÄŸinde kayÄ±t olabilir tarihi zorunludur!\n\nLÃ¼tfen kayÄ±t olabilir tarihi girin.`);
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalText;
                                return;
                            }
                        }
                    }
                }
            }
            
            // fullName belirle - ilk branÅŸtan veya veli isminden
            let fullName = 'MÃ¼ÅŸteri';
            if (branchesData.length > 0) {
                const firstBranch = branchesData[0];
                if (firstBranch.ageGroup === 'adult') {
                    fullName = firstBranch.fullName || 'MÃ¼ÅŸteri';
                } else {
                    fullName = firstBranch.parentName || 'Veli';
                }
            }
            
            // Temel veri
            const leadData = {
                fullName: fullName, // Listeleme iÃ§in
                phone: phone,
                source: formData.get('source') || 'other',
                branches: branchesData,
                clubId: currentClubId
            };
            
            try {
                if (leadId) {
                    // GÃ¼ncelleme
                    leadData.updatedAt = now.toISOString();
                    leadData.updatedBy = userName;
                    
                    // Eski lead'i bul ve etiket deÄŸiÅŸikliklerini kontrol et
                    const oldLead = crmLeads.find(l => l.id === leadId);
                    const newHistory = [];
                    
                    if (oldLead && oldLead.branches) {
                        // Her branÅŸ iÃ§in etiket deÄŸiÅŸikliklerini kontrol et
                        branchesData.forEach((newBranch) => {
                            const oldBranch = oldLead.branches.find(b => b.branchId === newBranch.branchId);
                            
                            if (oldBranch) {
                                // Etiket deÄŸiÅŸti mi?
                                if (oldBranch.selectedTag !== newBranch.selectedTag) {
                                    newHistory.push({
                                        action: 'tag_changed',
                                        by: userName,
                                        date: dateStr,
                                        details: `${newBranch.branchName} - Etiket "${oldBranch.selectedTag || 'Yok'}" â†’ "${newBranch.selectedTag || 'Yok'}"`
                                    });
                                }
                            } else {
                                // Yeni branÅŸ eklendi
                                if (newBranch.selectedTag) {
                                    newHistory.push({
                                        action: 'tag_added',
                                        by: userName,
                                        date: dateStr,
                                        details: `${newBranch.branchName} - Etiket: "${newBranch.selectedTag}"`
                                    });
                                }
                            }
                        });
                    }
                    
                    // Varsa yeni history kayÄ±tlarÄ±nÄ± ekle
                    if (newHistory.length > 0) {
                        leadData.history = [...(oldLead?.history || []), ...newHistory];
                    }
                    
                    await window.firebase.updateDoc(
                        window.firebase.doc(window.db, 'crmLeads', leadId),
                        leadData
                    );
                    showAlert('âœ… Potansiyel mÃ¼ÅŸteri baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
                } else {
                    // Yeni ekleme
                    leadData.createdAt = now.toISOString();
                    leadData.createdBy = userName;
                    leadData.status = 'new';
                    
                    // History'e mÃ¼ÅŸteri oluÅŸturma kaydÄ± ekle
                    leadData.history = [{
                        action: 'created',
                        by: userName,
                        date: dateStr,
                        details: `MÃ¼ÅŸteri oluÅŸturuldu - ${fullName} (${phone})`
                    }];
                    
                    // Her branÅŸ iÃ§in etiket bilgisi ekle
                    branchesData.forEach((branch, index) => {
                        if (branch.selectedTag) {
                            leadData.history.push({
                                action: 'tag_added',
                                by: userName,
                                date: dateStr,
                                details: `${branch.branchName} - Etiket: "${branch.selectedTag}"`
                            });
                        }
                    });
                    
                    await window.firebase.addDoc(
                        window.firebase.collection(window.db, 'crmLeads'),
                        leadData
                    );
                    showAlert('âœ… Potansiyel mÃ¼ÅŸteri baÅŸarÄ±yla eklendi!', 'success');
                }
                
                // âœ… Veri yÃ¼kleme tamamlanana kadar bekle
                await loadData();
                
                // âœ… "KayÄ±t Oldu" etiketi varsa otomatik olarak Ã¼ye sistemine ekle
                await checkAndAddToMembers(leadData, phone, fullName);
                
                // âœ… BaÅŸarÄ±lÄ± - modal'Ä± kapat
                closeModal('addLeadModal');
                renderCRMDashboard();
                renderCRMLeads();
            } catch (error) {
                console.error('Lead kaydetme hatasÄ±:', error);
                showAlert('âŒ KayÄ±t sÄ±rasÄ±nda hata oluÅŸtu: ' + error.message, 'danger');
                
                // âœ… Hata durumunda butonu tekrar aktif et
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }
        
        // "KayÄ±t Oldu" etiketi varsa otomatik Ã¼ye sistemine ekle
        async function checkAndAddToMembers(leadData, phone, fullName) {
            if (!leadData.branches || leadData.branches.length === 0) return;
            
            try {
                // "KayÄ±t Oldu" etiketi olan branÅŸlarÄ± bul
                const convertedBranches = leadData.branches.filter(b => b.selectedTag === 'KayÄ±t Oldu');
                
                if (convertedBranches.length === 0) return;
                
                // Ãœye sisteminde zaten var mÄ± kontrol et
                const existingMember = members.find(m => phonesMatch(m.Telefon, phone));
                
                for (const branch of convertedBranches) {
                    const branchInfo = branches.find(b => b.id === branch.branchId);
                    if (!branchInfo) continue;
                    
                    // Ãœye verisi oluÅŸtur
                    const memberData = {
                        Ad_Soyad: branch.ageGroup === 'adult' ? (branch.fullName || fullName) : (branch.parentName || fullName),
                        Veli_2_Adi_Soyadi: '',
                        Telefon_2: '',
                        Resit_Olmayan_Adi_Soyadi: branch.ageGroup === 'child' && branch.children && branch.children.length > 0 ? branch.children[0].name : '',
                        Telefon: phone,
                        Brans: branchInfo.name, // BranÅŸ ismi olarak kaydet
                        studentBirthDate: '',
                        status: 'pending', // Bekleyen Ã¼ye olarak ekle
                        registrationDate: new Date().toISOString(),
                        clubId: currentClubId,
                        crmSourceLeadId: leadData.id || null, // CRM'den geldiÄŸini iÅŸaretle
                        notes: `CRM'den otomatik eklendi - Etiket: "KayÄ±t Oldu"`
                    };
                    
                    if (existingMember) {
                        // Ãœye zaten varsa, sadece notlarÄ± gÃ¼ncelle
                        console.log(`âœ… ${fullName}: Zaten Ã¼ye sisteminde mevcut`);
                        
                        const currentNotes = existingMember.notes || '';
                        const newNotes = currentNotes + `\n[${new Date().toLocaleString('tr-TR')}] CRM'de "KayÄ±t Oldu" olarak iÅŸaretlendi - ${branchInfo.name}`;
                        
                        await window.firebase.updateDoc(
                            window.firebase.doc(window.db, 'members', existingMember.id),
                            { notes: newNotes }
                        );
                    } else {
                        // Yeni Ã¼ye ekle
                        await window.firebase.addDoc(
                            window.firebase.collection(window.db, 'members'),
                            memberData
                        );
                        
                        console.log(`âœ… ${fullName}: Bekleyen Ã¼yelere eklendi (${branchInfo.name})`);
                        
                        // BaÅŸarÄ± mesajÄ±
                        showAlert(`âœ… MÃ¼ÅŸteri "Bekleyen Ãœyeler" listesine eklendi!\n\nÃœyeler bÃ¶lÃ¼mÃ¼nden Ã¶deme planÄ± ve diÄŸer bilgileri girebilirsiniz.`, 'success');
                    }
                }
                
                // Ãœye listesini yenile
                await loadData();
                
            } catch (error) {
                console.error('Ãœye sisteme eklenirken hata:', error);
                showAlert(`âš ï¸ CRM kaydÄ± baÅŸarÄ±lÄ± ancak Ã¼ye sistemine eklenirken hata oluÅŸtu: ${error.message}`, 'warning');
            }
        }
        
        // Kaynak adÄ± helper
        function getSourceName(source) {
            const sources = {
                'website': 'ğŸŒ Website',
                'phone': 'ğŸ“ Telefon',
                'referral': 'ğŸ‘¥ Tavsiye',
                'social': 'ğŸ“± Sosyal Medya',
                'other': 'ğŸ”¹ DiÄŸer'
            };
            return sources[source] || source;
        }
        
        // ========== ZAMANLANMIÅ MESAJ FONKSÄ°YONLARI ==========
        
        // ZamanlanmÄ±ÅŸ mesaj modalÄ±nÄ± aÃ§
        function openScheduleMessageModal() {
            const modal = document.getElementById('scheduleMessageModal');
            if (!modal) {
                console.error('âŒ scheduleMessageModal bulunamadÄ±!');
                return;
            }
            
            const form = document.getElementById('scheduleMessageForm');
            form.reset();
            
            // Minimum zamanÄ± ÅŸu andan 5 dakika sonra yap
            const minTime = new Date(Date.now() + 5 * 60 * 1000);
            const year = minTime.getFullYear();
            const month = String(minTime.getMonth() + 1).padStart(2, '0');
            const day = String(minTime.getDate()).padStart(2, '0');
            const hours = String(minTime.getHours()).padStart(2, '0');
            const minutes = String(minTime.getMinutes()).padStart(2, '0');
            form.elements['scheduledTime'].min = `${year}-${month}-${day}T${hours}:${minutes}`;
            
            openModal('scheduleMessageModal');
        }
        
        // ZamanlanmÄ±ÅŸ mesaj kaydet
        async function handleScheduleMessage(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            try {
                // Default cihazÄ± al
                const device = whatsappDevices.find(d => 
                    d.status === 'connected' && d.instanceName === defaultWhatsAppDevice
                ) || whatsappDevices.find(d => d.status === 'connected');
                
                if (!device) {
                    showAlert('âŒ BaÄŸlÄ± WhatsApp cihazÄ± bulunamadÄ±!', 'danger');
                    return;
                }
                
                const phoneNumber = formData.get('phoneNumber');
                const recipientName = formData.get('recipientName') || phoneNumber;
                const messageText = formData.get('messageText');
                const scheduledTime = new Date(formData.get('scheduledTime'));
                const messageType = formData.get('messageType');
                
                // Zamanlama kontrolÃ¼
                if (scheduledTime < new Date()) {
                    showAlert('âš ï¸ GÃ¶nderim zamanÄ± geÃ§miÅŸte olamaz!', 'warning');
                    return;
                }
                
                // Firebase'e kaydet
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'scheduledMessages'), 
                    {
                        clubId: currentClubId,
                        deviceId: device.id,
                        recipientName: recipientName,
                        phoneNumber: phoneNumber,
                        messageText: messageText,
                        messageType: messageType,
                        scheduledTime: scheduledTime,
                        status: 'scheduled',
                        createdAt: new Date(),
                        createdBy: currentUser.email || currentUser.fullName,
                        retryCount: 0
                    }
                );
                
                const timeStr = scheduledTime.toLocaleString('tr-TR', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                showAlert(`âœ… Mesaj ${timeStr} tarihinde gÃ¶nderilmek Ã¼zere zamanlandÄ±!\n\nâš ï¸ TarayÄ±cÄ±yÄ± kapatabilirsiniz, mesaj Firebase Cloud Functions Ã¼zerinden otomatik gÃ¶nderilecektir.`, 'success');
                
                closeModal('scheduleMessageModal');
                
            } catch (error) {
                console.error('Mesaj zamanlama hatasÄ±:', error);
                showAlert('âŒ Mesaj zamanlanamadÄ±: ' + error.message, 'danger');
            }
        }
        
        // Global'e ekle
        window.openScheduleMessageModal = openScheduleMessageModal;
        window.handleScheduleMessage = handleScheduleMessage;
        window.openAddLeadModal = openAddLeadModal;
        window.editLead = editLead;
        window.deleteLead = deleteLead;
        window.handleAddLead = handleAddLead;
        window.renderCRMDashboard = renderCRMDashboard;
        
        // Kampanya SayfasÄ±
        function renderCampaignsPage() {
            // BranÅŸ filtresini doldur
            const branchFilter = document.getElementById('campaign-branch-filter');
            if (branchFilter) {
                branchFilter.innerHTML = '<option value="all">TÃ¼m BranÅŸlar</option>' + 
                    branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
            }
            
            // Etiket filtresini doldur
            const tagFilter = document.getElementById('campaign-tag-filter');
            if (tagFilter && crmTags) {
                const nonBranchTags = crmTags.filter(tag => tag.category !== 'branch');
                tagFilter.innerHTML = '<option value="all">TÃ¼m Etiketler</option>' + 
                    nonBranchTags.map(t => `<option value="${t.name}">ğŸ·ï¸ ${t.name}</option>`).join('');
            }
            
            // Cihaz listesini doldur
            const deviceSelect = document.getElementById('campaign-device');
            if (deviceSelect && whatsappDevices) {
                deviceSelect.innerHTML = '<option value="">Cihaz seÃ§in...</option>' +
                    whatsappDevices
                        .filter(d => d.status === 'connected')
                        .map(d => `<option value="${d.instanceName}">${d.instanceName} (${d.phoneNumber})</option>`).join('');
            }
            
            updateCampaignRecipients();
        }
        
        window.updateCampaignRecipients = function() {
            const branchFilter = document.getElementById('campaign-branch-filter')?.value || 'all';
            const tagFilter = document.getElementById('campaign-tag-filter')?.value || 'all';
            const ageFilter = document.getElementById('campaign-agegroup-filter')?.value || 'all';
            
            let recipients = new Set();
            
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        let match = true;
                        
                        // BranÅŸ filtresi
                        if (branchFilter !== 'all' && br.branchId !== branchFilter) {
                            match = false;
                        }
                        
                        // YaÅŸ grubu filtresi
                        if (ageFilter !== 'all' && br.ageGroup !== ageFilter) {
                            match = false;
                        }
                        
                        // Etiket filtresi
                        if (tagFilter !== 'all' && br.selectedTag !== tagFilter) {
                            match = false;
                        }
                        
                        if (match && lead.phone) {
                            recipients.add(lead.phone);
                        }
                        
                        // Ã‡ocuklarÄ± da kontrol et
                        if (match && br.ageGroup === 'child' && br.children) {
                            br.children.forEach(c => {
                                if (tagFilter === 'all' || c.selectedTag === tagFilter) {
                                    if (lead.phone) recipients.add(lead.phone);
                                }
                            });
                        }
                    });
                }
            });
            
            const countEl = document.getElementById('campaign-recipient-count');
            if (countEl) {
                countEl.textContent = recipients.size;
            }
        };
        
        window.sendCampaignMessages = async function() {
            const device = document.getElementById('campaign-device').value;
            const message = document.getElementById('campaign-message').value;
            const sendDelay = document.getElementById('campaign-send-delay').checked;
            
            if (!device || !message.trim()) {
                showAlert('âŒ LÃ¼tfen tÃ¼m alanlarÄ± doldurun!', 'danger');
                return;
            }
            
            if (!confirm('KampanyayÄ± baÅŸlatmak istediÄŸinize emin misiniz?')) {
                return;
            }
            
            const branchFilter = document.getElementById('campaign-branch-filter')?.value || 'all';
            const tagFilter = document.getElementById('campaign-tag-filter')?.value || 'all';
            const ageFilter = document.getElementById('campaign-agegroup-filter')?.value || 'all';
            
            // AlÄ±cÄ±larÄ± topla
            const recipients = [];
            const phoneSet = new Set();
            
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(br => {
                        let match = true;
                        
                        if (branchFilter !== 'all' && br.branchId !== branchFilter) match = false;
                        if (ageFilter !== 'all' && br.ageGroup !== ageFilter) match = false;
                        if (tagFilter !== 'all' && br.selectedTag !== tagFilter) match = false;
                        
                        if (match && lead.phone && !phoneSet.has(lead.phone)) {
                            phoneSet.add(lead.phone);
                            const name = br.ageGroup === 'adult' ? (br.fullName || lead.fullName) : br.parentName;
                            recipients.push({ phone: lead.phone, name: name || 'MÃ¼ÅŸteri' });
                        }
                        
                        if (match && br.ageGroup === 'child' && br.children) {
                            br.children.forEach(c => {
                                if ((tagFilter === 'all' || c.selectedTag === tagFilter) && lead.phone && !phoneSet.has(lead.phone)) {
                                    phoneSet.add(lead.phone);
                                    recipients.push({ phone: lead.phone, name: br.parentName || 'Veli' });
                                }
                            });
                        }
                    });
                }
            });
            
            if (recipients.length === 0) {
                showAlert('âŒ SeÃ§ilen kriterlere uygun mÃ¼ÅŸteri bulunamadÄ±!', 'danger');
                return;
            }
            
            // GÃ¶nderim baÅŸlat
            const statusDiv = document.getElementById('campaign-status');
            const progressDiv = document.getElementById('campaign-progress');
            statusDiv.style.display = 'block';
            
            let successCount = 0;
            let failCount = 0;
            
            for (let i = 0; i < recipients.length; i++) {
                const recipient = recipients[i];
                const personalizedMessage = message
                    .replace(/\{ad\}/g, recipient.name)
                    .replace(/\{telefon\}/g, recipient.phone);
                
                progressDiv.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>Ä°lerleme:</strong> ${i + 1} / ${recipients.length}
                    </div>
                    <div style="background: #fff; border-radius: 8px; height: 20px; overflow: hidden;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${((i + 1) / recipients.length * 100).toFixed(1)}%; transition: width 0.3s;"></div>
                    </div>
                    <div style="margin-top: 10px; font-size: 14px;">
                        <span style="color: #4caf50;">âœ… BaÅŸarÄ±lÄ±: ${successCount}</span> | 
                        <span style="color: #f44336;">âŒ BaÅŸarÄ±sÄ±z: ${failCount}</span>
                    </div>
                `;
                
                try {
                    const result = await sendWhatsAppMessage(device, recipient.phone, personalizedMessage, recipient.name);
                    if (result.success || result === true) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    failCount++;
                }
                
                if (sendDelay && i < recipients.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            progressDiv.innerHTML += `
                <div style="margin-top: 20px; padding: 15px; background: ${successCount > 0 ? '#e8f5e9' : '#ffebee'}; border-radius: 8px;">
                    <h4>ğŸ‰ Kampanya TamamlandÄ±!</h4>
                    <p><strong>Toplam:</strong> ${recipients.length} | <strong>BaÅŸarÄ±lÄ±:</strong> ${successCount} | <strong>BaÅŸarÄ±sÄ±z:</strong> ${failCount}</p>
                </div>
            `;
        };
        
        // === YENÄ° KAMPANYA SÄ°STEMÄ° FONKSIYONLARI ===
        
        // âœ… Direkt mesaj gÃ¶nderme modalÄ±nÄ± aÃ§
        window.openDirectMessageModal = function() {
            // Cihaz dropdown'Ä±nÄ± doldur
            const deviceSelect = document.getElementById('direct-message-device');
            if (deviceSelect && whatsappDevices) {
                deviceSelect.innerHTML = '<option value="">VarsayÄ±lan cihaz</option>' +
                    whatsappDevices
                        .filter(d => d.status === 'open')
                        .map(d => `<option value="${d.instanceName}">${d.name || d.instanceName}</option>`)
                        .join('');
            }
            
            // Formu temizle
            document.getElementById('directMessageForm').reset();
            
            // Modal'Ä± aÃ§
            openModal('directMessageModal');
        };
        
        // âœ… Direkt mesaj gÃ¶nder
        window.handleDirectMessage = async function(event) {
            event.preventDefault();
            const form = event.target;
            const phone = form.phone.value.trim();
            const message = form.message.value.trim();
            const deviceId = form.deviceId.value || null;
            
            if (!phone || !message) {
                showAlert('Telefon numarasÄ± ve mesaj gerekli!', 'warning');
                return;
            }
            
            // Cihaz seÃ§
            let device = null;
            if (deviceId) {
                device = whatsappDevices.find(d => d.instanceName === deviceId);
            } else {
                // VarsayÄ±lan cihaz veya ilk aktif cihazÄ± kullan
                device = whatsappDevices.find(d => d.instanceName === defaultWhatsAppDevice) || 
                         whatsappDevices.find(d => d.status === 'open');
            }
            
            if (!device) {
                showAlert('âŒ Aktif WhatsApp cihazÄ± bulunamadÄ±!', 'danger');
                return;
            }
            
            // Loading gÃ¶ster
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></span> GÃ¶nderiliyor...';
            
            try {
                // Mesaj gÃ¶nder
                const success = await sendWhatsAppMessage(
                    device.instanceName,
                    phone,
                    message,
                    phone // recipient name
                );
                
                if (success) {
                    showAlert('âœ… Mesaj baÅŸarÄ±yla gÃ¶nderildi!', 'success');
                    closeModal('directMessageModal');
                } else {
                    showAlert('âŒ Mesaj gÃ¶nderilemedi. LÃ¼tfen tekrar deneyin.', 'danger');
                }
            } catch (error) {
                console.error('Direct message error:', error);
                showAlert('âŒ Mesaj gÃ¶nderilirken hata oluÅŸtu: ' + error.message, 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        };
        
        window.openCampaignModal = function() {
            // Etiket dropdown'Ä±nÄ± doldur
            const tagSelect = document.getElementById('campaign-tag-select');
            if (tagSelect && crmTags) {
                const nonBranchTags = crmTags.filter(tag => tag.category !== 'branch');
                tagSelect.innerHTML = '<option value="">SeÃ§iniz...</option>' + 
                    nonBranchTags.map(t => `<option value="${t.name}">ğŸ·ï¸ ${t.name}</option>`).join('');
            }
            
            // BranÅŸ dropdown'Ä±nÄ± doldur
            const branchSelect = document.getElementById('campaign-branch-select');
            if (branchSelect && branches) {
                branchSelect.innerHTML = '<option value="">SeÃ§iniz...</option>' +
                    branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
            }
            
            // Modal'Ä± aÃ§
            document.getElementById('campaignModal').style.display = 'block';
        };
        
        window.updateCampaignRecipientCount = function(audienceType) {
            // Etiket ve branÅŸ filtrelerini gÃ¶ster/gizle
            document.getElementById('campaign-tag-filter').style.display = audienceType === 'crm-by-tag' ? 'block' : 'none';
            document.getElementById('campaign-branch-filter').style.display = audienceType === 'crm-by-branch' ? 'block' : 'none';
            
            // AlÄ±cÄ± sayÄ±sÄ±nÄ± hesapla
            let recipientCount = 0;
            
            switch(audienceType) {
                case 'all-members':
                    recipientCount = members.filter(m => m.Telefon).length;
                    break;
                case 'active-members':
                    recipientCount = members.filter(m => m.Telefon && m.Durum === 'aktif').length;
                    break;
                case 'inactive-members':
                    recipientCount = members.filter(m => m.Telefon && m.Durum !== 'aktif').length;
                    break;
                case 'crm-all':
                    recipientCount = crmLeads.filter(l => l.phone).length;
                    break;
                case 'crm-by-tag':
                case 'crm-by-branch':
                    // KullanÄ±cÄ± etiketi veya branÅŸÄ± seÃ§ince hesaplanÄ±r
                    recipientCount = 0;
                    break;
            }
            
            document.getElementById('campaign-recipient-count').textContent = recipientCount;
            
            // Tahmini sÃ¼reyi hesapla
            const dailyLimit = parseInt(document.querySelector('input[name="dailyLimit"]').value) || 200;
            const estimatedDays = Math.ceil(recipientCount / dailyLimit);
            document.getElementById('campaign-duration').textContent = estimatedDays > 0 ? `${estimatedDays} gÃ¼n` : '-';
        };
        
        window.handleCreateCampaign = async function(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            const campaignData = {
                name: formData.get('campaignName'),
                targetAudience: formData.get('targetAudience'),
                messageContent: formData.get('messageContent'),
                dailyLimit: parseInt(formData.get('dailyLimit')),
                startTime: formData.get('startTime'),
                status: 'pending',
                createdAt: new Date().toISOString(),
                clubId: currentClubId,
                createdBy: currentUserEmail
            };
            
            // CRM filtreler
            if (campaignData.targetAudience === 'crm-by-tag') {
                campaignData.crmTag = formData.get('crmTag');
            } else if (campaignData.targetAudience === 'crm-by-branch') {
                campaignData.crmBranch = formData.get('crmBranch');
            }
            
            // AlÄ±cÄ±larÄ± belirle
            const recipients = getCampaignRecipients(campaignData);
            campaignData.totalRecipients = recipients.length;
            
            if (recipients.length === 0) {
                showAlert('âŒ Hedef kitle boÅŸ! LÃ¼tfen alÄ±cÄ±larÄ± kontrol edin.', 'danger');
                return;
            }
            
            if (!confirm(`${recipients.length} kiÅŸiye mesaj gÃ¶nderilecek. Devam etmek istiyor musunuz?`)) {
                return;
            }
            
            try {
                // KampanyayÄ± Firebase'e kaydet
                const campaignRef = await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'campaigns'),
                    campaignData
                );
                
                // AlÄ±cÄ±larÄ± parÃ§alara bÃ¶l ve kuyruÄŸa ekle
                const startDate = new Date(campaignData.startTime);
                const dailyLimit = campaignData.dailyLimit;
                
                let dayOffset = 0;
                for (let i = 0; i < recipients.length; i += dailyLimit) {
                    const batch = recipients.slice(i, i + dailyLimit);
                    const scheduledDate = new Date(startDate);
                    scheduledDate.setDate(scheduledDate.getDate() + dayOffset);
                    
                    // Her alÄ±cÄ± iÃ§in mesaj kuyruÄŸuna ekle
                    for (const recipient of batch) {
                        const message = campaignData.messageContent
                            .replace(/{AD_SOYAD}/g, recipient.name || '')
                            .replace(/{AD}/g, (recipient.name || '').split(' ')[0])
                            .replace(/{TELEFON}/g, recipient.phone);
                        
                        await window.firebase.addDoc(
                            window.firebase.collection(window.db, 'messageQueue'),
                            {
                                clubId: currentClubId,
                                campaignId: campaignRef.id,
                                phone: recipient.phone,
                                message: message,
                                scheduledFor: scheduledDate.toISOString(),
                                status: 'pending',
                                createdAt: new Date().toISOString()
                            }
                        );
                    }
                    
                    dayOffset++;
                }
                
                showAlert(`âœ… Kampanya oluÅŸturuldu! ${recipients.length} mesaj ${dayOffset} gÃ¼ne bÃ¶lÃ¼nerek kuyruÄŸa eklendi.`, 'success');
                closeModal('campaignModal');
                form.reset();
                loadCampaigns();
            } catch (error) {
                console.error('âŒ Kampanya oluÅŸturma hatasÄ±:', error);
                showAlert('âŒ Kampanya oluÅŸturulamadÄ±: ' + error.message, 'danger');
            }
        };
        
        function getCampaignRecipients(campaignData) {
            const recipients = [];
            const phoneSet = new Set();
            
            switch(campaignData.targetAudience) {
                case 'all-members':
                    members.forEach(m => {
                        if (m.Telefon && !phoneSet.has(m.Telefon)) {
                            phoneSet.add(m.Telefon);
                            recipients.push({
                                phone: m.Telefon,
                                name: m.OgrenciAdiSoyadi || m.VeliAdiSoyadi
                            });
                        }
                    });
                    break;
                case 'active-members':
                    members.filter(m => m.Durum === 'aktif').forEach(m => {
                        if (m.Telefon && !phoneSet.has(m.Telefon)) {
                            phoneSet.add(m.Telefon);
                            recipients.push({
                                phone: m.Telefon,
                                name: m.OgrenciAdiSoyadi || m.VeliAdiSoyadi
                            });
                        }
                    });
                    break;
                case 'inactive-members':
                    members.filter(m => m.Durum !== 'aktif').forEach(m => {
                        if (m.Telefon && !phoneSet.has(m.Telefon)) {
                            phoneSet.add(m.Telefon);
                            recipients.push({
                                phone: m.Telefon,
                                name: m.OgrenciAdiSoyadi || m.VeliAdiSoyadi
                            });
                        }
                    });
                    break;
                case 'crm-all':
                    crmLeads.forEach(lead => {
                        if (lead.phone && !phoneSet.has(lead.phone)) {
                            phoneSet.add(lead.phone);
                            recipients.push({
                                phone: lead.phone,
                                name: lead.fullName
                            });
                        }
                    });
                    break;
                case 'crm-by-tag':
                    crmLeads.forEach(lead => {
                        if (lead.branches) {
                            lead.branches.forEach(br => {
                                if (br.selectedTag === campaignData.crmTag && lead.phone && !phoneSet.has(lead.phone)) {
                                    phoneSet.add(lead.phone);
                                    recipients.push({
                                        phone: lead.phone,
                                        name: lead.fullName
                                    });
                                }
                            });
                        }
                    });
                    break;
                case 'crm-by-branch':
                    crmLeads.forEach(lead => {
                        if (lead.branches) {
                            lead.branches.forEach(br => {
                                if (br.branchId === campaignData.crmBranch && lead.phone && !phoneSet.has(lead.phone)) {
                                    phoneSet.add(lead.phone);
                                    recipients.push({
                                        phone: lead.phone,
                                        name: lead.fullName
                                    });
                                }
                            });
                        }
                    });
                    break;
            }
            
            return recipients;
        }
        
        window.loadCampaigns = async function() {
            const container = document.getElementById('campaigns-list');
            if (!container) return;
            
            try {
                container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Kampanyalar yÃ¼kleniyor...</span></div>';
                
                const campaignsRef = window.firebase.collection(window.db, 'campaigns');
                const q = window.firebase.query(
                    campaignsRef,
                    window.firebase.where('clubId', '==', currentClubId),
                    window.firebase.orderBy('createdAt', 'desc')
                );
                
                const snapshot = await window.firebase.getDocs(q);
                
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-state"><p>HenÃ¼z kampanya oluÅŸturulmamÄ±ÅŸ</p></div>';
                    return;
                }
                
                let html = '<div style="display: grid; gap: 15px;">';
                snapshot.forEach(doc => {
                    const campaign = doc.data();
                    const createdDate = new Date(campaign.createdAt).toLocaleString('tr-TR');
                    const startDate = new Date(campaign.startTime).toLocaleString('tr-TR');
                    
                    const statusColors = {
                        'pending': '#ff9800',
                        'active': '#4CAF50',
                        'completed': '#9e9e9e',
                        'paused': '#f44336'
                    };
                    
                    const statusText = {
                        'pending': 'â° Bekliyor',
                        'active': 'â–¶ï¸ Aktif',
                        'completed': 'âœ… TamamlandÄ±',
                        'paused': 'â¸ï¸ DuraklatÄ±ldÄ±'
                    };
                    
                    html += `
                        <div style="padding: 15px; background: white; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <h4 style="margin: 0 0 5px 0;">${campaign.name}</h4>
                                    <span style="background: ${statusColors[campaign.status]}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px;">
                                        ${statusText[campaign.status]}
                                    </span>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 6px; font-size: 13px;">
                                <div>
                                    <div style="color: #666;">ğŸ“Š AlÄ±cÄ± SayÄ±sÄ±</div>
                                    <div style="font-weight: 600;">${campaign.totalRecipients}</div>
                                </div>
                                <div>
                                    <div style="color: #666;">ğŸ“… GÃ¼nlÃ¼k Limit</div>
                                    <div style="font-weight: 600;">${campaign.dailyLimit}</div>
                                </div>
                                <div>
                                    <div style="color: #666;">ğŸ• BaÅŸlangÄ±Ã§</div>
                                    <div style="font-weight: 600;">${startDate}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                container.innerHTML = html;
            } catch (error) {
                console.error('âŒ Kampanyalar yÃ¼klenirken hata:', error);
                container.innerHTML = '<div class="empty-state"><p>Kampanyalar yÃ¼klenemedi</p></div>';
            }
        };
        
        // === KAMPANYA FONKSÄ°YONLARI SONU ===
        
        window.sendCampaignMessages = async function() {
            
            showAlert(`âœ… Kampanya tamamlandÄ±! ${successCount} mesaj gÃ¶nderildi.`, 'success');
        };
        
        window.resetCampaignForm = function() {
            document.getElementById('campaign-branch-filter').value = 'all';
            document.getElementById('campaign-tag-filter').value = 'all';
            document.getElementById('campaign-agegroup-filter').value = 'all';
            document.getElementById('campaign-message').value = '';
            document.getElementById('campaign-send-delay').checked = false;
            document.getElementById('campaign-status').style.display = 'none';
            updateCampaignRecipients();
        };
        
        window.renderCampaignsPage = renderCampaignsPage;
        window.renderCRMLeads = renderCRMLeads;
        
        // ========== END CRM FUNCTIONS ==========

        function renderTasksPage() {
            const tableBody = document.getElementById('tasksTableBody');
            if (!tableBody) return;
            
            let filteredTasks = tasks;
            if (!currentUser.isSuperAdmin) {
                filteredTasks = tasks.filter(task => task.assignedTo === currentUser.fullName);
            }

            tableBody.innerHTML = filteredTasks.length === 0 
                ? `<tr><td colspan="8" class="empty-state"><h3>Aktif gÃ¶rev bulunmuyor.</h3></td></tr>`
                : filteredTasks.map(task => {
                    let statusClass = 'pending';
                    if (task.status === 'TamamlandÄ±') statusClass = 'completed';
                    if (task.status === 'Devam Ediyor') statusClass = 'active';
                    const messageCount = (task.messages || []).length;
                    const unreadCount = (task.messages || []).filter(m => !m.read && m.sender !== currentUser.fullName).length;
                    return `
                    <tr>
                        <td>${task.taskName}</td>
                        <td>${task.assignedTo}</td>
                        <td><span class="status-badge status-${statusClass}">${task.status}</span></td>
                        <td>${task.notes || '-'}</td>
                        <td>${formatDate(task.createdAt)}</td>
                        <td>${task.completedAt ? formatDate(task.completedAt) : '-'}</td>
                        <td>
                            <button class="btn btn-info btn-sm" onclick="openTaskMessagesModal('${task.id}')">
                                ğŸ’¬ Mesajlar ${unreadCount > 0 ? `<span class="badge">${unreadCount}</span>` : `(${messageCount})`}
                            </button>
                        </td>
                        <td>
                            <div class="actions-cell">
                                ${currentUser.isSuperAdmin || currentUser.isAdmin ? `<button class="btn btn-warning btn-sm" onclick="sendTaskReminder('${task.id}')" title="WhatsApp ile hatÄ±rlat">ğŸ”” HatÄ±rlat</button>` : ''}
                                <button class="btn btn-primary btn-sm" onclick="openTaskEditModal('${task.id}')">DÃ¼zenle</button>
                                ${currentUser.isSuperAdmin || currentUser.isAdmin ? `<button class="btn btn-danger btn-sm" onclick="deleteItem('tasks', '${task.id}')">Sil</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `}).join('');
        }
        
        async function sendTaskReminder(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) {
                showAlert('GÃ¶rev bulunamadÄ±.', 'danger');
                return;
            }
            
            // Find user phone number
            const assignedUser = users.find(u => u.fullName === task.assignedTo);
            if (!assignedUser || !assignedUser.phone) {
                showAlert('Atanan kiÅŸinin telefon numarasÄ± bulunamadÄ±.', 'danger');
                return;
            }
            
            // Check WhatsApp connection
            const connectedDevice = whatsappDevices.find(d => d.status === 'connected' && d.instanceName === defaultWhatsAppDevice);
            if (!connectedDevice) {
                showAlert('WhatsApp baÄŸlantÄ±sÄ± bulunamadÄ±. LÃ¼tfen bir cihaz baÄŸlayÄ±n.', 'danger');
                return;
            }
            
            // Check if evolutionUrl exists
            if (!connectedDevice.evolutionUrl || connectedDevice.evolutionUrl === 'undefined') {
                showAlert('âš ï¸ WhatsApp cihazÄ±nÄ±n Evolution API URL\'si tanÄ±mlanmamÄ±ÅŸ. LÃ¼tfen WhatsApp ayarlarÄ±ndan cihazÄ± yeniden yapÄ±landÄ±rÄ±n.', 'danger');
                console.error('Device configuration:', connectedDevice);
                return;
            }
            
            // Format phone number for Evolution API
            let phoneNumber = assignedUser.phone.replace(/\D/g, ''); // Remove all non-digits
            if (phoneNumber.startsWith('0')) {
                phoneNumber = '90' + phoneNumber.substring(1); // Replace leading 0 with 90
            } else if (!phoneNumber.startsWith('90')) {
                phoneNumber = '90' + phoneNumber; // Add 90 prefix if missing
            }
            
            // Prepare message
            const message = `ğŸ”” GÃ¶rev HatÄ±rlatmasÄ±\n\n` +
                          `GÃ¶rev: ${task.taskName}\n` +
                          `Durum: ${task.status}\n` +
                          `Notlar: ${task.notes || 'Yok'}\n` +
                          `OluÅŸturulma: ${formatDate(task.createdAt)}\n\n` +
                          `LÃ¼tfen gÃ¶revinizi kontrol edin.`;
            
            try {
                console.log(`ğŸ“¤ Sending task reminder to ${phoneNumber}...`);
                
                // Send WhatsApp message
                const response = await fetch(`${connectedDevice.evolutionUrl}/message/sendText/${connectedDevice.instanceName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': connectedDevice.apiKey
                    },
                    body: JSON.stringify({
                        number: phoneNumber,
                        text: message
                    })
                });
                
                if (response.ok) {
                    showAlert(`âœ… HatÄ±rlatma ${task.assignedTo} adlÄ± kiÅŸiye gÃ¶nderildi.`, 'success');
                    
                    // Log the sent message
                    await window.firebase.addDoc(window.firebase.collection(window.db, 'sentMessages'), {
                        recipientName: task.assignedTo,
                        phone: phoneNumber,
                        message: message,
                        sentAt: new Date().toISOString(),
                        instanceName: connectedDevice.instanceName,
                        status: 'sent',
                        type: 'task-reminder',
                        clubId: currentClubId // âœ… KulÃ¼p ID'si eklendi
                    });
                } else {
                    const errorText = await response.text();
                    console.error('âŒ API Error:', errorText);
                    throw new Error(`Mesaj gÃ¶nderilemedi (${response.status})`);
                }
            } catch (error) {
                console.error('Error sending task reminder:', error);
                showAlert('HatÄ±rlatma gÃ¶nderilirken hata oluÅŸtu: ' + error.message, 'danger');
            }
        }
        
        window.sendTaskReminder = sendTaskReminder;
        
        function updateTaskNotificationStatus() {
            const container = document.getElementById('taskNotificationStatus');
            if (!container) return;
            
            const connectedDevices = whatsappDevices.filter(d => d.status === 'connected');
            const hasDefaultDevice = defaultWhatsAppDevice && connectedDevices.find(d => d.instanceName === defaultWhatsAppDevice);
            const taskTemplateEnabled = messageTemplates.task && messageTemplates.task.enabled;
            
            let statusHtml = '<div style="display: grid; gap: 15px;">';
            
            // Template Status
            statusHtml += `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">${taskTemplateEnabled ? 'âœ…' : 'âŒ'}</span>
                    <div>
                        <strong>GÃ¶rev Bildirimi Åablonu:</strong> 
                        <span style="color: ${taskTemplateEnabled ? 'green' : 'red'};">
                            ${taskTemplateEnabled ? 'Etkin' : 'Devre DÄ±ÅŸÄ±'}
                        </span>
                        ${!taskTemplateEnabled ? '<br><small style="color: #666;">Ayarlar â†’ Mesaj ÅablonlarÄ± â†’ GÃ¶rev Bildirimi</small>' : ''}
                    </div>
                </div>
            `;
            
            // Device Status
            statusHtml += `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">${hasDefaultDevice ? 'âœ…' : connectedDevices.length > 0 ? 'âš ï¸' : 'âŒ'}</span>
                    <div>
                        <strong>WhatsApp CihazÄ±:</strong> 
                        <span style="color: ${hasDefaultDevice ? 'green' : connectedDevices.length > 0 ? 'orange' : 'red'};">
                            ${hasDefaultDevice ? `Ana hat: ${defaultWhatsAppDevice}` : connectedDevices.length > 0 ? `${connectedDevices.length} cihaz baÄŸlÄ± (Ana hat seÃ§ilmemiÅŸ)` : 'BaÄŸlÄ± cihaz yok'}
                        </span>
                        ${!hasDefaultDevice ? '<br><small style="color: #666;">Ayarlar â†’ WhatsApp AyarlarÄ± â†’ Ana WhatsApp HattÄ±</small>' : ''}
                    </div>
                </div>
            `;
            
            // User Phone Numbers (check both phoneNumber and phone fields)
            const usersWithoutPhone = users.filter(u => !u.phoneNumber && !u.phone);
            statusHtml += `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;">${usersWithoutPhone.length === 0 ? 'âœ…' : 'âš ï¸'}</span>
                    <div>
                        <strong>YÃ¶netici Telefon NumaralarÄ±:</strong> 
                        <span style="color: ${usersWithoutPhone.length === 0 ? 'green' : 'orange'};">
                            ${users.length - usersWithoutPhone.length}/${users.length} kayÄ±tlÄ±
                        </span>
                        ${usersWithoutPhone.length > 0 ? `<br><small style="color: #666;">Eksik: ${usersWithoutPhone.map(u => u.fullName).join(', ')}</small>` : ''}
                    </div>
                </div>
            `;
            
            // Overall Status
            const canSendNotifications = taskTemplateEnabled && (hasDefaultDevice || connectedDevices.length > 0);
            statusHtml += `
                <div style="padding: 15px; background: ${canSendNotifications ? '#d4edda' : '#f8d7da'}; border-radius: 8px; margin-top: 10px;">
                    <strong style="color: ${canSendNotifications ? '#155724' : '#721c24'};">
                        ${canSendNotifications ? 'âœ… GÃ¶rev bildirimleri Ã§alÄ±ÅŸÄ±yor!' : 'âŒ GÃ¶rev bildirimleri Ã§alÄ±ÅŸmÄ±yor'}
                    </strong>
                    ${!canSendNotifications ? '<br><small>YukarÄ±daki eksiklikleri tamamlayÄ±n.</small>' : ''}
                </div>
            `;
            
            // Test Button
            if (canSendNotifications && users.length > 0) {
                statusHtml += `
                    <div style="margin-top: 10px;">
                        <button class="btn btn-warning" onclick="testTaskNotification()">ğŸ§ª Test MesajÄ± GÃ¶nder</button>
                        <small style="color: #666; margin-left: 10px;">Size bir test gÃ¶revi mesajÄ± gÃ¶nderilecek</small>
                    </div>
                `;
            }
            
            statusHtml += '</div>';
            container.innerHTML = statusHtml;
        }
        
        window.testTaskNotification = async function() {
            if (!currentUser || !currentUser.phoneNumber) {
                return showAlert('âŒ Profilinizde telefon numarasÄ± kayÄ±tlÄ± deÄŸil!', 'danger');
            }
            
            showAlert('ğŸ“¤ Test mesajÄ± gÃ¶nderiliyor...', 'info');
            
            const testTaskData = {
                taskName: 'Test GÃ¶revi',
                notes: 'Bu bir test mesajÄ±dÄ±r. GÃ¶rev bildirimleri Ã§alÄ±ÅŸÄ±yor!',
                createdAt: new Date().toISOString(),
                assignedTo: currentUser.email
            };
            
            const success = await sendTaskNotification(testTaskData);
            
            if (success) {
                showAlert('âœ… Test mesajÄ± gÃ¶nderildi! Telefonunuzu kontrol edin.', 'success');
            } else {
                showAlert('âŒ Test mesajÄ± gÃ¶nderilemedi. AyarlarÄ± kontrol edin.', 'danger');
            }
        };
        
        // --- UPDATE & INTERACTION FUNCTIONS ---
        async function updateMemberStatus(memberId, newStatus) {
            const member = members.find(m => m.id === memberId);
            if (!member) return showAlert('Ãœye bulunamadÄ±.', 'danger');

            const memberGroups = groups.filter(g => Array.isArray(g.members) && g.members.includes(memberId));
            if (newStatus === 'active' && memberGroups.length === 0) {
                const proceed = confirm('Bu Ã¼ye henÃ¼z bir gruba atanmamÄ±ÅŸ. Yine de aktif yapmak istiyor musunuz?');
                if (!proceed) {
                    await loadData(); // Reload to revert the visual change
                return;
                }
            }

            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'members', memberId), { status: newStatus });
                showAlert('âœ… Ãœye durumu gÃ¼ncellendi: ' + (newStatus === 'active' ? 'Aktif' : newStatus === 'pending' ? 'Bekliyor' : 'Pasif'), 'success');
                member.status = newStatus;
                renderCurrentSection(); // Re-render the current section to reflect changes
            } catch(e) { 
                showAlert('Ãœye durumu gÃ¼ncellenirken hata.', 'danger'); 
                await loadData();
            }
        }

        async function saveReason(recordId, newReason, cellElement) {
            // Restore the onclick listener so it can be edited again
            cellElement.setAttribute('onclick', `editReason(this, '${recordId}')`);
            
            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'attendance', recordId), { reason: newReason });
                
                // Update local data
                const recordIndex = attendanceRecords.findIndex(rec => rec.id === recordId);
                if (recordIndex > -1) {
                    attendanceRecords[recordIndex].reason = newReason;
                }
                
                // Update UI without full reload
                cellElement.innerHTML = newReason || '<i>Sebep Ekle</i>';

                showAlert('DevamsÄ±zlÄ±k sebebi gÃ¼ncellendi.', 'success');
            } catch (error) {
                console.error("Error updating absence reason:", error);
                showAlert('Sebep gÃ¼ncellenirken bir hata oluÅŸtu.', 'danger');
                cellElement.innerHTML = 'Hata oluÅŸtu'; // Revert to some text
            }
        }

        async function removeMemberFromGroup(memberId, groupId) {
             showConfirmModal('Ãœyeyi gruptan Ã§Ä±karmak istediÄŸinize emin misiniz?', async () => {
                 closeModal('confirmModal');
                 try {
                     // 1ï¸âƒ£ groups.members array'inden Ã¼yeyi Ã§Ä±kar
                     await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', groupId), {
                        members: window.firebase.arrayRemove(memberId)
                   });
                   console.log('âœ… groups.members gÃ¼ncelendi (Ã¼ye Ã§Ä±karÄ±ldÄ±)');
                   
                    // 2ï¸âƒ£ Ãœyenin baÅŸka grubu var mÄ± kontrol et
                    const remainingGroups = groups.filter(g => g.id !== groupId && Array.isArray(g.members) && g.members.includes(memberId));
                    
                    if (remainingGroups.length === 0) {
                         // BaÅŸka grubu yoksa: groupId'yi temizle ve status'u pending yap
                         await window.firebase.updateDoc(window.firebase.doc(window.db, 'members', memberId), { 
                             status: 'pending',
                             groupId: null  // âœ… groupId'yi temizle!
                         });
                         console.log('âœ… members.groupId temizlendi (baÅŸka grup yok)');
                    } else {
                         // BaÅŸka grubu varsa: groupId'yi ilk gruba ayarla
                         await window.firebase.updateDoc(window.firebase.doc(window.db, 'members', memberId), { 
                             groupId: remainingGroups[0].id
                         });
                         console.log('âœ… members.groupId gÃ¼ncellendi (baÅŸka gruba taÅŸÄ±ndÄ±)');
                    }

                     showAlert('Ãœye gruptan Ã§Ä±karÄ±ldÄ±.', 'success');
                     await loadData();
                 } catch (e) { 
                     console.error('âŒ Gruptan Ã§Ä±karma hatasÄ±:', e);
                     showAlert('Ãœye gruptan Ã§Ä±karÄ±lÄ±rken hata oluÅŸtu.', 'danger'); 
                 }
             });
        }

        async function confirmGroupAssignment(memberId, newGroupId, shouldRemove = false) {
            try {
                console.log('ğŸ”„ Grup atamasÄ± baÅŸlatÄ±lÄ±yor...', { memberId, newGroupId, shouldRemove });
                
                // Ã–nce grup verisini kontrol et
                const groupBefore = groups.find(g => g.id === newGroupId);
                console.log('ğŸ“‹ Grup Ã¶nce:', { 
                    id: groupBefore?.id, 
                    name: groupBefore?.groupName,
                    members: groupBefore?.members
                });
                
                // EÄŸer TAÅI seÃ§eneÄŸi seÃ§ildiyse, Ã¶nce diÄŸer gruplardan Ã§Ä±kar
                if (shouldRemove) {
                    const memberGroups = groups.filter(g => Array.isArray(g.members) && g.members.includes(memberId));
                    console.log('ğŸ”„ TAÅI seÃ§ildi - Ãœye ÅŸu gruplardan Ã§Ä±karÄ±lacak:', 
                        memberGroups.map(g => g.groupName).join(', ') || 'HiÃ§ grup yok'
                    );
                    
                    for (const group of memberGroups) {
                        console.log(`  â†’ ${group.groupName} grubundan Ã§Ä±karÄ±lÄ±yor...`);
                        await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', group.id), {
                            members: window.firebase.arrayRemove(memberId)
                        });
                        console.log(`  âœ… ${group.groupName} grubundan Ã§Ä±karÄ±ldÄ±`);
                    }
                } else {
                    console.log('ğŸ“Œ SADECE EKLE seÃ§ildi - Mevcut gruplara dokunulmayacak');
                }
                
                // 1ï¸âƒ£ groups.members array'ine Ã¼yeyi ekle
                const updateData = { members: window.firebase.arrayUnion(memberId) };
                console.log('ğŸ“¤ Grup gÃ¼ncelleniyor:', updateData);
                
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', newGroupId), updateData);
                console.log('âœ… groups.members gÃ¼ncellendi');
                
                // 2ï¸âƒ£ members.groupId alanÄ±nÄ± gÃ¼ncelle (Ã–NEMLÄ°!)
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'members', memberId), { 
                    status: 'active',
                    groupId: newGroupId  // âœ… groupId'yi de gÃ¼ncelle!
                });
                console.log('âœ… members.groupId gÃ¼ncellendi');
                
                showAlert(shouldRemove ? 'Ãœye baÅŸarÄ±yla taÅŸÄ±ndÄ±.' : 'Ãœye baÅŸarÄ±yla gruba eklendi.', 'success');
                
                // Her iki modalÄ± da kapat
                closeModal('choiceModal');
                closeModal('groupAssignModal');
                
                await loadData();
                
                // Sonra grup verisini kontrol et
                const groupAfter = groups.find(g => g.id === newGroupId);
                console.log('ğŸ“‹ Grup sonra:', { 
                    id: groupAfter?.id, 
                    name: groupAfter?.groupName,
                    members: groupAfter?.members
                });
            } catch (error) { 
                console.error('âŒ Grup atama hatasÄ±:', error);
                showAlert('Gruba Ã¼ye atanÄ±rken bir hata oluÅŸtu.', 'danger'); 
                console.error(error);
            }
        }
        
        function deleteSchedule(event, scheduleId) {
            event.stopPropagation();
            const text = `Bu dersi takvimden kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.`;
            showConfirmModal(text, () => executeDeleteSchedule(scheduleId));
        }

        async function executeDeleteSchedule(scheduleId) {
            closeModal('confirmModal');
            try {
                await window.firebase.deleteDoc(window.firebase.doc(window.db, 'schedules', scheduleId));
                showAlert('Ders takvimden silindi.', 'success');
                await loadData();
            } catch (error) {
                showAlert('Ders silinirken bir hata oluÅŸtu.', 'danger');
                console.error("Schedule delete error:", error);
            }
        }
        
        async function deletePaymentFromSchedule(preRegId, paymentNumber) {
            const text = `${paymentNumber}. taksiti kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.`;
            showConfirmModal(text, async () => {
                closeModal('confirmModal');
                try {
                    const preReg = preRegistrations.find(p => p.id === preRegId);
                    if (!preReg) throw new Error("Ã–n kayÄ±t bulunamadÄ±.");

                    let updatedSchedule = preReg.paymentSchedule.filter(p => p.paymentNumber !== paymentNumber);

                    // Re-number subsequent payments
                    updatedSchedule.forEach((p, index) => {
                        p.paymentNumber = index + 1;
                    });
                    
                    await window.firebase.updateDoc(window.firebase.doc(window.db, 'preRegistrations', preRegId), { paymentSchedule: updatedSchedule });
                    
                    showAlert('Taksit baÅŸarÄ±yla silindi.', 'success');
                    await loadData();
                    
                    // âœ… Ä°statistikleri ve listeyi gÃ¼ncelle
                    if (typeof updatePaymentStats === 'function') {
                        updatePaymentStats();
                    }
                    if (typeof renderPaymentsList === 'function' && currentSection === 'payments') {
                        renderPaymentsList();
                    }
                    
                    viewPaymentPlan(preRegId);
                } catch (error) {
                    showAlert('Taksit silinirken bir hata oluÅŸtu.', 'danger');
                    console.error("Payment delete error:", error);
                }
            });
        }

         async function deleteAttendanceRecord(recordId) {
            showConfirmModal('Bu yoklama kaydÄ±nÄ± kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?', async () => {
                closeModal('confirmModal');
                try {
                    const record = attendanceRecords.find(r => r.id === recordId);
                    if (!record) throw new Error("KayÄ±t bulunamadÄ±.");
                    const memberId = record.memberId;
                    
                    await window.firebase.deleteDoc(window.firebase.doc(window.db, 'attendance', recordId));
                    
                    // Remove from local array
                    attendanceRecords = attendanceRecords.filter(r => r.id !== recordId);
                    
                    showAlert('Yoklama kaydÄ± silindi.', 'success');
                    showMemberAttendancePage(memberId); // Refresh the view
                } catch (error) {
                    console.error("Error deleting attendance record:", error);
                    showAlert('KayÄ±t silinirken bir hata oluÅŸtu.', 'danger');
                }
            });
        }

        // --- UI & MODAL FUNCTIONS ---
        function assignToGroup(memberId, groupId = null) {
            const modalContent = document.getElementById('groupAssignContent');
            let contentHtml = '';
            
            if (memberId) { // Assign/Move a specific member
                const member = members.find(m => m.id === memberId);
                if (!member) return;
                
                document.getElementById('groupAssignTitle').textContent = `${member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad} iÃ§in Grup Ata/TaÅŸÄ±`;
                
                const renderGroupList = (searchTerm = '') => {
                    const memberGroups = groups.filter(g => Array.isArray(g.members) && g.members.includes(memberId));
                    const memberGroupIds = memberGroups.map(g => g.id);
                    const availableGroups = groups.filter(g => {
                         const memberCount = members.filter(m => Array.isArray(g.members) && g.members.includes(m.id) && m.status !== 'expired').length;
                         return g.branch === member.Brans && 
                                !memberGroupIds.includes(g.id) &&
                                memberCount < g.maxMembers &&
                                g.groupName.toLowerCase().includes(searchTerm.toLowerCase());
                    });

                    return `<div class="group-selection-list">${availableGroups.map(g => {
                        const memberCount = members.filter(m => Array.isArray(g.members) && g.members.includes(m.id) && m.status !== 'expired').length;
                        return `<div class="group-selection-item" onclick="promptMoveOrAdd('${memberId}', '${g.id}')"><strong>${g.groupName}</strong><span>${memberCount}/${g.maxMembers}</span></div>`
                    }).join('') || '<p class="empty-state">Bu branÅŸta atanacak uygun grup bulunmuyor.</p>'}</div>`;
                }

                contentHtml = `
                    <div class="form-group" style="margin-bottom: 15px;">
                        <input type="search" id="groupAssignSearchInput" class="form-control" placeholder="Grup adÄ± ile ara...">
                    </div>
                    <div id="group-list-container">
                        ${renderGroupList()}
                    </div>
                `;
                 modalContent.innerHTML = contentHtml;
                 modalContent.querySelector('#groupAssignSearchInput').addEventListener('input', (e) => {
                    modalContent.querySelector('#group-list-container').innerHTML = renderGroupList(e.target.value);
                 });


            } else if (groupId) { // Add/remove members from a specific group
                const group = groups.find(g => g.id === groupId);
                if (!group) return;
                
                // ğŸ” Debug: Grup Ã¼yelik durumunu gÃ¶ster
                console.log('ğŸ” assignToGroup Modal AÃ§Ä±lÄ±yor:', {
                    groupId: groupId,
                    groupName: group.groupName,
                    groupMembers: group.members,
                    isArray: Array.isArray(group.members),
                    memberCount: Array.isArray(group.members) ? group.members.length : 0
                });
                
                document.getElementById('groupAssignTitle').textContent = `${group.groupName} grubuna Ã¼ye ekle/Ã§Ä±kar`;
                const unassignedMembers = members.filter(m => m.status !== 'expired' && m.Brans === group.branch && !(Array.isArray(group.members) && group.members.includes(m.id)));
                const assignedMembers = members.filter(m => Array.isArray(group.members) && group.members.includes(m.id) && m.status !== 'expired');
                
                console.log('  â†’ AtanmamÄ±ÅŸ Ã¼yeler:', unassignedMembers.length);
                console.log('  â†’ AtanmÄ±ÅŸ Ã¼yeler:', assignedMembers.length);

                contentHtml = '<h4>Gruba Ekle</h4>' + (unassignedMembers.length > 0 ? unassignedMembers.map(m =>
                     `<div class="group-selection-item" onclick="confirmGroupAssignment('${m.id}', '${groupId}')"><strong>${m.Resit_Olmayan_Adi_Soyadi || m.Ad_Soyad}</strong><span>+ Ekle</span></div>`
                ).join('') : '<p>Eklenecek Ã¼ye yok.</p>');

                contentHtml += '<hr style="margin: 20px 0;"><h4>Gruptan Ã‡Ä±kar</h4>' + (assignedMembers.length > 0 ? assignedMembers.map(m =>
                     `<div class="group-selection-item" onclick="removeMemberFromGroup('${m.id}', '${groupId}')"><strong>${m.Resit_Olmayan_Adi_Soyadi || m.Ad_Soyad}</strong><span style="color:red;">- Ã‡Ä±kar</span></div>`
                ).join('') : '<p>Ã‡Ä±karÄ±lacak Ã¼ye yok.</p>');
                 modalContent.innerHTML = contentHtml;
            }
           
            openModal('groupAssignModal');
        }

        function togglePaymentDetails(memberId, forceOpen = false) {
            const detailsDiv = document.getElementById(`payment-details-${memberId}`);
            if (detailsDiv) {
                if(forceOpen) detailsDiv.style.display = 'block';
                else detailsDiv.style.display = detailsDiv.style.display === 'block' ? 'none' : 'block';
            }
        }
        
        function openMemberEditModal(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            // Ãœye adÄ±nÄ± belirle
            const memberName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad || 'Ä°simsiz';
            const parentName = member.Ad_Soyad || '-';
            const parentName2 = member.Veli_2_Adi_Soyadi || '-';
            const phone1 = member.Telefon || '-';
            const phone2 = member.Telefon_2 || '-';
            
            // Grubunu bul
            const memberGroups = groups.filter(g => Array.isArray(g.members) && g.members.includes(memberId));
            const groupNames = memberGroups.map(g => g.groupName).join(', ') || 'AtanmamÄ±ÅŸ';
            
            // BranÅŸÄ±nÄ± bul
            const branchName = memberGroups.length > 0 && memberGroups[0].branch 
                ? (branches.find(b => b.id === memberGroups[0].branch)?.name || 'Bilinmiyor')
                : 'AtanmamÄ±ÅŸ';
            
            const html = `
                <div id="memberDetailModal" class="modal" style="display: block;">
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <span class="close" onclick="closeMemberDetail()">&times;</span>
                        <h3>ğŸ‘¤ ${memberName}</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">ğŸ“ Telefon 1</div>
                                <div style="font-size: 16px; font-weight: bold;">${formatPhoneDisplay(phone1)}</div>
                            </div>
                            ${phone2 !== '-' ? `
                            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">ğŸ“ Telefon 2</div>
                                <div style="font-size: 16px; font-weight: bold;">${formatPhoneDisplay(phone2)}</div>
                            </div>
                            ` : ''}
                            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">ğŸ¯ BranÅŸ</div>
                                <div style="font-size: 16px; font-weight: bold;">${branchName}</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 15px; border-radius: 10px; color: white; text-align: center;">
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">ğŸ‘¥ Grup</div>
                                <div style="font-size: 14px; font-weight: bold;">${groupNames}</div>
                            </div>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <div class="customer-tabs">
                                <button class="tab-button active" onclick="switchMemberTab(0)">ğŸ“‹ Genel Bilgiler</button>
                                <button class="tab-button" onclick="switchMemberTab(1); loadMemberCallRecords('${memberId}')">ğŸ“ GÃ¶rÃ¼ÅŸme KayÄ±tlarÄ±</button>
                            </div>
                            
                            <div class="tab-content active" style="padding: 20px; background: white; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 8px 8px;">
                                <h4 style="margin-top: 0;">ğŸ‘¤ Ãœye Bilgileri</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div><strong>Ã–ÄŸrenci AdÄ±:</strong> ${member.Resit_Olmayan_Adi_Soyadi || '-'}</div>
                                    <div><strong>Veli 1:</strong> ${parentName}</div>
                                    <div><strong>Veli 2:</strong> ${parentName2}</div>
                                    <div><strong>Durum:</strong> ${member.status === 'active' ? 'âœ… Aktif' : member.status === 'expired' ? 'âŒ Pasif' : 'â¸ï¸ DondurulmuÅŸ'}</div>
                                    ${member.DogumTarihi ? `<div><strong>DoÄŸum Tarihi:</strong> ${new Date(member.DogumTarihi).toLocaleDateString('tr-TR')}</div>` : ''}
                                </div>
                            </div>
                            
                            <div class="tab-content" style="padding: 20px; background: white; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 8px 8px; display: none;">
                                <h4 style="margin-top: 0;">ğŸ“ GÃ¶rÃ¼ÅŸme KayÄ±tlarÄ±</h4>
                                <div id="memberCallRecords-${memberId}">
                                    <div class="loading"><div class="spinner"></div><span>GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ± yÃ¼kleniyor...</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px; border-top: 2px solid #e0e0e0; padding-top: 20px;">
                            <button class="btn btn-primary" onclick="closeMemberDetail(); openMemberEditForm('${memberId}')">âœï¸ DÃ¼zenle</button>
                            <button class="btn btn-secondary" onclick="closeMemberDetail()">Kapat</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Modal varsa kaldÄ±r
            const existing = document.getElementById('memberDetailModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', html);
            
            // Backdrop'a tÄ±klayÄ±nca modalÄ± kapat
            const modal = document.getElementById('memberDetailModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
        }
        
        // Ãœye detay modalÄ±nÄ± kapat
        window.closeMemberDetail = function() {
            const modal = document.getElementById('memberDetailModal');
            if (modal) modal.remove();
        };
        
        // Ãœye detay sekmelerini deÄŸiÅŸtir
        window.switchMemberTab = function(tabIndex) {
            const modal = document.getElementById('memberDetailModal');
            if (!modal) return;
            
            const tabs = modal.querySelectorAll('.tab-button');
            const contents = modal.querySelectorAll('.tab-content');
            
            tabs.forEach((btn, idx) => {
                if (idx === tabIndex) {
                    btn.classList.add('active');
                    contents[idx].style.display = 'block';
                } else {
                    btn.classList.remove('active');
                    contents[idx].style.display = 'none';
                }
            });
        };
        
        // Ãœye gÃ¶rÃ¼ÅŸme kayÄ±tlarÄ±nÄ± yÃ¼kle
        window.loadMemberCallRecords = async function(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            const container = document.getElementById(`memberCallRecords-${memberId}`);
            if (!container || container.dataset.loaded === 'true') return;
            
            // Telefon numarasÄ±nÄ± belirle - Ã–nce Telefon, sonra Telefon_2
            const phoneNumber = member.Telefon || member.Telefon_2;
            if (!phoneNumber) {
                container.innerHTML = '<p style="color: #999;">Bu Ã¼ye iÃ§in telefon numarasÄ± bulunamadÄ±.</p>';
                return;
            }
            
            await renderCallRecords(phoneNumber, `memberCallRecords-${memberId}`);
            container.dataset.loaded = 'true';
        };
        
        // Eski dÃ¼zenleme formunu aÃ§
        window.openMemberEditForm = function(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            // âœ… BranÅŸ dropdown'Ä±nÄ± doldur
            const branchSelect = document.getElementById('memberEditBrans');
            if (branchSelect && branches) {
                branchSelect.innerHTML = '<option value="">SeÃ§iniz...</option>' +
                    branches.map(b => `<option value="${b.name}">${b.icon} ${b.name}</option>`).join('');
            }
            
            const form = document.getElementById('memberEditForm');
            form.memberId.value = memberId;
            form.Ad_Soyad.value = member.Ad_Soyad || '';
            form.Veli_2_Adi_Soyadi.value = member.Veli_2_Adi_Soyadi || '';
            form.Telefon_2.value = member.Telefon_2 || '';
            form.Resit_Olmayan_Adi_Soyadi.value = member.Resit_Olmayan_Adi_Soyadi || '';
            form.Telefon.value = member.Telefon || '';
            
            // âœ… DoÄŸum tarihi (studentBirthDate veya DogumTarihi)
            const birthDate = member.studentBirthDate || member.DogumTarihi || '';
            if (birthDate) {
                // ISO formatÄ±na Ã§evir (YYYY-MM-DD)
                const date = new Date(birthDate);
                if (!isNaN(date.getTime())) {
                    form.studentBirthDate.value = date.toISOString().split('T')[0];
                }
            } else {
                form.studentBirthDate.value = '';
            }
            
            // âœ… BranÅŸ
            form.Brans.value = member.Brans || '';
            
            // âœ… Durum
            form.status.value = member.status || 'active';
            
            openModal('memberEditModal');
        }

        function openPreRegEditModal(preRegId) {
            const reg = preRegistrations.find(p => p.id === preRegId);
            if (!reg) return showAlert('Ã–n kayÄ±t bulunamadÄ±.', 'danger');
            
            const member = members.find(m => m.preRegistrationId === preRegId);
            const isAdult = member && !member.Resit_Olmayan_Adi_Soyadi;

            const form = document.getElementById('preRegEditForm');
            form.preRegId.value = preRegId;
            form.parentName.value = reg.parentName || '';
            form.studentName.value = reg.studentName || '';
            form.branch.value = reg.branch || '';
            form.notes.value = reg.notes || '';
            
            toggleParentStudentFieldsForEdit(form, isAdult);

            // --- Group Selector Logic for Edit Modal ---
            const groupSearchInput = form.querySelector('#preRegEditGroupSearch');
            const groupHiddenInput = form.querySelector('#preRegEditGroupId');
            const groupResultsContainer = form.querySelector('#preRegEditGroupResults');
            
            // Only check groups if member exists
            if (member && member.id) {
            const memberGroups = groups.filter(g => Array.isArray(g.memberIds) && g.memberIds.includes(member.id));
            if(memberGroups.length > 0) {
                // If in multiple groups, just show one for simplicity in this UI or leave blank
                groupSearchInput.value = memberGroups[0].groupName; 
                groupHiddenInput.value = memberGroups[0].id;
                } else {
                     groupSearchInput.value = '';
                     groupHiddenInput.value = '';
                }
            } else {
                 groupSearchInput.value = '';
                 groupHiddenInput.value = '';
            }

            const availableGroups = groups.filter(g => {
                const memberCount = members.filter(m => Array.isArray(g.memberIds) && g.memberIds.includes(m.id) && m.status !== 'expired').length;
                return g.branch === reg.branch && memberCount < g.maxMembers;
            });

            groupSearchInput.oninput = () => {
                const searchTerm = groupSearchInput.value.toLowerCase();
                groupHiddenInput.value = '';
                const filtered = availableGroups.filter(g => g.groupName.toLowerCase().includes(searchTerm));
                
                groupResultsContainer.innerHTML = filtered.length > 0 ? filtered.map(g => {
                    const memberCount = members.filter(m => Array.isArray(g.members) && g.members.includes(m.id) && m.status !== 'expired').length;
                    return `<div class="searchable-select-item" data-id="${g.id}" data-name="${g.groupName}">${g.groupName} - (${memberCount}/${g.maxMembers})</div>`
                }).join('') : '<div class="searchable-select-item disabled">SonuÃ§ bulunamadÄ±</div>';
                groupResultsContainer.classList.add('active');
            };

            groupResultsContainer.onclick = (e) => {
                if (e.target.classList.contains('searchable-select-item') && e.target.dataset.id) {
                    groupHiddenInput.value = e.target.dataset.id;
                    groupSearchInput.value = e.target.dataset.name;
                    groupResultsContainer.classList.remove('active');
                    console.log('PreReg Edit - Group selected:', { 
                        groupId: groupHiddenInput.value, 
                        groupName: groupSearchInput.value 
                    });
                }
            };

            openModal('preRegEditModal');
        }
        
        function openGroupEditModal(groupId) {
            const group = groups.find(g => g.id === groupId);
            if(!group) return;
            const form = document.getElementById('groupForm');
            form.reset();
            
            // âœ… BranÅŸ dropdown'unu dinamik olarak gÃ¼ncelle
            const branchSelect = form.querySelector('[name="branch"]');
            branchSelect.innerHTML = '<option value="">SeÃ§iniz...</option>' + 
                branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
            
            form.groupId.value = groupId;
            form.groupName.value = group.groupName;
            form.branch.value = group.branch;
            form.instructor.value = group.instructor;
            form.maxMembers.value = group.maxMembers;
            form.description.value = group.description || '';
            
            // Load existing schedule times and days for this group
            const groupSchedules = schedules.filter(s => s.groupId === groupId);
            if (groupSchedules.length > 0) {
                // Get unique days and sort them
                const scheduledDays = [...new Set(groupSchedules.map(s => s.day))];
                const checkboxes = form.querySelectorAll('input[name="days"]');
                checkboxes.forEach(cb => {
                    cb.checked = scheduledDays.includes(cb.value);
                });
                
                // Set time from first schedule (assuming all schedules have same time)
                const firstSchedule = groupSchedules[0];
                const startTimeInput = form.querySelector('[name="startTime"]');
                const endTimeInput = form.querySelector('[name="endTime"]');
                if (startTimeInput) startTimeInput.value = firstSchedule.startTime;
                if (endTimeInput) endTimeInput.value = firstSchedule.endTime;
            }
            
            document.getElementById('groupModalTitle').textContent = 'Grubu DÃ¼zenle';
            openModal('groupModal');
        }
        
        function openAttendanceModal(groupId) {
            const group = groups.find(g => g.id === groupId);
            if(!group) return;

            const modalTitle = document.getElementById('attendanceModalTitle');
            const attendanceList = document.getElementById('attendanceList');
            const form = document.getElementById('attendanceForm');

            modalTitle.textContent = `ğŸ“ ${group.groupName} - Yoklama`;
            form.groupId.value = groupId;
            form.querySelector('[name="attendanceDate"]').value = getTodayString();
            
            const groupMembers = members.filter(m => Array.isArray(group.members) && group.members.includes(m.id) && m.status === 'active');

            if(groupMembers.length === 0) {
                attendanceList.innerHTML = `<p class="empty-state">Bu grupta aktif Ã¼ye bulunmuyor.</p>`;
            } else {
                attendanceList.innerHTML = groupMembers.map(m => `
                    <div class="attendance-item">
                        <label>
                            <input type="checkbox" name="presentMembers" value="${m.id}" onchange="toggleReasonInput(this, '${m.id}')" checked>
                            <span>${m.Resit_Olmayan_Adi_Soyadi || m.Ad_Soyad}</span>
                        </label>
                        <input type="text" name="reason_${m.id}" class="form-control reason-input" placeholder="DevamsÄ±zlÄ±k sebebi..." style="display:none;">
                    </div>
                `).join('');
            }
            openModal('attendanceModal');
        }
        
        function openTaskEditModal(taskId = null) {
            const form = document.getElementById('taskForm');
            form.reset();
            const modalTitle = document.getElementById('taskModalTitle');
            
            const assigneeSelect = form.querySelector('[name="assignedTo"]');
            assigneeSelect.innerHTML = users.map(u => `<option value="${u.fullName}">${u.fullName}</option>`).join('');

            if (taskId) { // Edit mode
                modalTitle.textContent = 'GÃ¶revi DÃ¼zenle';
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    form.taskId.value = task.id;
                    form.taskName.value = task.taskName;
                    form.assignedTo.value = task.assignedTo;
                    form.status.value = task.status;
                    form.notes.value = task.notes || '';
                }
            } else { // Add mode
                modalTitle.textContent = 'Yeni GÃ¶rev Ekle';
                form.taskId.value = '';
            }
            openModal('taskModal');
        }

        function openProfileEditModal() {
            const form = document.getElementById('profileForm');
            form.reset();
            form.fullName.value = currentUser.fullName;
            form.phone.value = currentUser.phone || currentUser.phoneNumber || '';
            openModal('profileModal');
        }
        
        // --- DRAG & DROP FUNCTIONS ---
        function drag(ev, id, isGroup) { 
            ev.dataTransfer.setData("id", id);
            ev.dataTransfer.setData("isGroup", isGroup);
        }
        function allowDrop(ev) { 
            ev.preventDefault();
            ev.currentTarget.classList.add('drag-over');
            ev.currentTarget.addEventListener('dragleave', () => ev.currentTarget.classList.remove('drag-over'), { once: true });
        }
        async function drop(ev, day) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            const id = ev.dataTransfer.getData("id");
            const isGroup = ev.dataTransfer.getData("isGroup") === 'true';
            
            if (isGroup) {
                openScheduleModalForGroup(id, day);
            }
        }

        // âœ… Mevcut schedule'Ä± dÃ¼zenle (saha bilgisi ekle/gÃ¼ncelle)
        window.editScheduleCourt = async function(scheduleId) {
            const schedule = schedules.find(s => s.id === scheduleId);
            if (!schedule) return;
            
            const group = groups.find(g => g.id === schedule.groupId);
            if (!group) return;
            
            const branchInfo = branches.find(b => b.id === schedule.branch);
            if (!branchInfo || !branchInfo.courts || branchInfo.courts.length === 0) {
                return showAlert('Bu branÅŸta saha tanÄ±mlÄ± deÄŸil.', 'warning');
            }
            
            const courtOptions = branchInfo.courts.map((c, idx) => `${idx + 1}. ${c.name}`).join('\n');
            const currentCourt = schedule.court ? `\n\nMevcut saha: ${schedule.court}` : '';
            const courtChoice = prompt(`Saha seÃ§in:${currentCourt}\n\n${courtOptions}\n\nSaha numarasÄ±nÄ± girin (0 = saha kaldÄ±r):`);
            
            if (courtChoice === null) return; // Ä°ptal
            
            let newCourt = null;
            if (courtChoice !== '0' && courtChoice !== '') {
                const courtIndex = parseInt(courtChoice) - 1;
                if (courtIndex >= 0 && courtIndex < branchInfo.courts.length) {
                    newCourt = branchInfo.courts[courtIndex].name;
                }
            }
            
            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'schedules', scheduleId), {
                    court: newCourt
                });
                showAlert(`âœ… Saha bilgisi ${newCourt ? `"${newCourt}" olarak` : ''} gÃ¼ncellendi`, 'success');
                await loadData();
            } catch (error) {
                console.error('Error updating court:', error);
                showAlert('âŒ Saha gÃ¼ncellenirken hata oluÅŸtu', 'danger');
            }
        }

        function openScheduleModalForGroup(groupId, day = null) {
            const group = groups.find(g => g.id === groupId);
            if (!group) {
                console.log('âŒ Grup bulunamadÄ±:', groupId);
                return;
            }
            
            console.log('ğŸ”µ openScheduleModalForGroup Ã§aÄŸrÄ±ldÄ±:', group.groupName, 'BranÅŸ:', group.branch);
            
            const form = document.getElementById('newScheduleForm');
            if (!form) return;
            
            form.reset();
            
            // Grup bilgilerini doldur
            form.querySelector('[name="groupId"]').value = groupId;
            form.querySelector('[name="groupName"]').value = group.groupName;
            
            // âœ… BranÅŸ bilgisini bul ve saha dropdown'unu hazÄ±rla
            const branchInfo = branches.find(b => b.id === group.branch);
            console.log('ğŸ“Œ BranÅŸ bilgisi:', branchInfo);
            console.log('ğŸ“ Sahalar:', branchInfo?.courts);
            
            const courtSelectContainer = document.getElementById('courtSelectContainer');
            const courtSelect = document.getElementById('courtSelect');
            
            if (branchInfo && branchInfo.courts && branchInfo.courts.length > 0) {
                console.log('âœ… Sahalar mevcut, dropdown gÃ¶steriliyor...');
                // Saha dropdown'unu doldur
                courtSelect.innerHTML = '<option value="">Saha SeÃ§iniz (opsiyonel)</option>' + 
                    branchInfo.courts.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                
                // âœ… EÄŸer bir saha seÃ§iliyse, onu otomatik seÃ§
                if (selectedCourtForSchedule) {
                    courtSelect.value = selectedCourtForSchedule;
                }
                
                courtSelectContainer.style.display = 'block';
            } else {
                console.log('âš ï¸ Bu branÅŸta saha yok');
                courtSelectContainer.style.display = 'none';
            }
            
            // Mevcut schedule'larÄ± kontrol et ve formda gÃ¶ster
            const groupSchedules = schedules.filter(s => s.groupId === groupId);
            if (groupSchedules.length > 0) {
                // Mevcut gÃ¼nleri iÅŸaretle
                const scheduledDays = [...new Set(groupSchedules.map(s => s.day))];
                const checkboxes = form.querySelectorAll('input[name="days"]');
                checkboxes.forEach(cb => {
                    cb.checked = scheduledDays.includes(cb.value);
                });
                
                // Mevcut saatleri doldur
                const firstSchedule = groupSchedules[0];
                form.querySelector('[name="startTime"]').value = firstSchedule.startTime;
                form.querySelector('[name="endTime"]').value = firstSchedule.endTime;
                
                // Mevcut sahayÄ± seÃ§
                if (firstSchedule.court && courtSelect) {
                    courtSelect.value = firstSchedule.court;
                }
            } else if (day) {
                // Belirli bir gÃ¼ne sÃ¼rÃ¼klenirse o gÃ¼nÃ¼ iÅŸaretle
                const checkboxes = form.querySelectorAll('input[name="days"]');
                checkboxes.forEach(cb => {
                    cb.checked = cb.value === day;
                });
            }

            // Modal'Ä± aÃ§
            openModal('scheduleModal');
        }
        
        function showMembers(event, groupId) {
            const tooltip = document.getElementById('member-tooltip');
            const group = groups.find(g => g.id === groupId);
            if (!group || !group.members || group.members.length === 0) {
                tooltip.innerHTML = 'Bu grupta Ã¼ye yok.';
            } else {
                const memberNames = group.members.map(mid => members.find(m => m.id === mid)?.Ad_Soyad || 'Bilinmeyen Ãœye');
                tooltip.innerHTML = `<ul><li>${memberNames.join('</li><li>')}</li></ul>`;
            }
            tooltip.style.display = 'block';
            tooltip.style.left = `${event.pageX + 15}px`;
            tooltip.style.top = `${event.pageY + 15}px`;
        }
        function hideMembers() { document.getElementById('member-tooltip').style.display = 'none'; }
        
        // --- OTHER UI FUNCTIONS ---
        function applyRolePermissions() {
             // Ayarlar menÃ¼sÃ¼ artÄ±k tÃ¼m kulÃ¼pler iÃ§in gÃ¶rÃ¼nÃ¼r
             // SuperAdmin kontrolÃ¼ kaldÄ±rÄ±ldÄ±
             
             // âœ… Admin kullanÄ±cÄ±larÄ± tÃ¼m izinlere sahip
             if (currentUser && currentUser.role === 'admin') {
                 console.log('âœ… Admin kullanÄ±cÄ±sÄ± - tÃ¼m izinler verildi');
                 return; // Adminler iÃ§in hiÃ§bir kÄ±sÄ±tlama yok
             }
             
             // Permissions kontrolÃ¼ - eÄŸer permissions yoksa varsayÄ±lan olarak hepsine izin ver
             if (!currentUser || !currentUser.permissions) {
                 console.log('âš ï¸ User permissions bulunamadÄ±, varsayÄ±lan izinler uygulanÄ±yor');
                 return;
             }

             if (!currentUser?.permissions?.view_payments) {
                  const paymentsBtn = document.querySelector('.nav-btn[onclick*="payments"]');
                  if (paymentsBtn) paymentsBtn.style.display = 'none';
             }

             if (!currentUser.permissions.view_stats) {
                const paymentStats = document.getElementById('payment-stats');
                if(paymentStats) paymentStats.style.display = 'none';
                
                const monthlyRevenueCard = document.getElementById('monthlyRevenue');
                if(monthlyRevenueCard) monthlyRevenueCard.closest('.stat-card').style.display = 'none';
             }
             
             if (!currentUser.permissions.manage_users) {
                  document.getElementById('user-management-card').style.display = 'none';
             }
        }
        
        function updateDashboard() {
            // ğŸš€ HIZLI BAÅLANGIÃ‡ - Veriler yoksa dashboard'u render etme (opacity ile gizli)
            if (members.length === 0 && preRegistrations.length === 0 && groups.length === 0) {
                console.log('âš¡ Dashboard veriler yÃ¼kleniyor, render atlanÄ±yor...');
                return;
            }
            
            document.getElementById('totalMembers').textContent = members.length;
            document.getElementById('activeMembers').textContent = members.filter(m => m.status === 'active').length;
            document.getElementById('inactiveMembers').textContent = members.filter(m => m.status === 'expired').length;
            // Bekleyen kayÄ±tlar: pending_contract durumundaki preRegistrations
            // Ama aktif veya pasif olmayan Ã¼yeleri filtrele
            const pendingPreRegs = preRegistrations.filter(p => {
                if (p.status !== 'pending_contract') return false;
                
                // Bu preReg'e ait member var mÄ± kontrol et
                const member = members.find(m => 
                    m.preRegistrationId === p.id || 
                    (m.Telefon && p.phone && m.Telefon.replace(/\D/g, '').replace(/^0/, '') === p.phone.replace(/\D/g, '').replace(/^0/, ''))
                );
                
                // EÄŸer Ã¼ye aktif veya pasif ise gÃ¶sterme
                if (member && (member.status === 'active' || member.status === 'expired')) {
                    return false;
                }
                
                return true;
            });
            
            document.getElementById('pendingRegistrations').textContent = pendingPreRegs.length;
            
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const prevMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            
            let currentMonthRevenue = 0, previousMonthRevenue = 0;

            preRegistrations.forEach(preReg => {
                if (preReg.paymentSchedule) {
                    preReg.paymentSchedule.forEach(p => {
                        if (p.status === 'paid' && p.paymentDate) {
                            const paymentDate = new Date(p.paymentDate);
                            if (paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear) {
                                currentMonthRevenue += p.amount;
                            } else if (paymentDate.getMonth() === prevMonth && paymentDate.getFullYear() === prevMonthYear) {
                                previousMonthRevenue += p.amount;
                            }
                        }
                    });
                }
            });

            document.getElementById('monthlyRevenue').textContent = currentMonthRevenue.toLocaleString('tr-TR') + 'â‚º';
            const comparisonEl = document.getElementById('revenueComparison');
            if (previousMonthRevenue > 0) {
                const percentChange = ((currentMonthRevenue - previousMonthRevenue) / previousMonthRevenue) * 100;
                comparisonEl.textContent = `${percentChange >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(percentChange).toFixed(1)}% (Ã–nceki Ay)`;
                comparisonEl.className = `stat-comparison ${percentChange >= 0 ? 'increase' : 'decrease'}`;
            } else {
                comparisonEl.textContent = 'Ã–nceki ay veri yok';
                 comparisonEl.className = 'stat-comparison';
            }
            
            // Dashboard tutarlarÄ±nÄ± maskele (eÄŸer gizli ise)
            setTimeout(() => applyDashboardAmountsVisibility(), 50);
            
            renderAbsentStudents();
            renderUpcomingBirthdays();
            // renderKayitOlabilirReminders(); // âŒ KaldÄ±rÄ±ldÄ± - CRM Dashboard'da var
            // renderDenemeGelecekReminders(); // âŒ KaldÄ±rÄ±ldÄ± - CRM Dashboard'da var
        }

        function updatePaymentStats() {
            // âœ… Veriler henÃ¼z yÃ¼klenmemiÅŸse skip et
            if (!members || members.length === 0 || !preRegistrations || preRegistrations.length === 0) {
                console.log('â¸ï¸ updatePaymentStats atlandÄ± - veriler henÃ¼z yÃ¼klenmedi');
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            console.log('ğŸ“… Mevcut Ay Bilgisi:', {
                'Ay': currentMonth + 1,
                'YÄ±l': currentYear,
                'Tarih': today.toLocaleDateString('tr-TR')
            });

            let totalPaidThisMonth = 0;
            let pendingThisMonth = 0;
            let paidPaymentsThisMonth = [];

            // Sadece aktif/pending ve preReg'i olan Ã¼yeler
            const activeMembers = members.filter(m => {
                if (m.status !== 'active' && m.status !== 'pending') return false;
                if (!m.preRegistrationId) return false;
                const preReg = preRegistrations.find(p => p.id === m.preRegistrationId);
                return preReg && preReg.paymentSchedule && preReg.paymentSchedule.length > 0;
            });

            console.log('ğŸ‘¥ Aktif Ãœye SayÄ±sÄ±:', activeMembers.length);

            activeMembers.forEach(member => {
                const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                if (!preReg || !preReg.paymentSchedule) return;

                preReg.paymentSchedule.forEach(p => {
                    const dueDate = new Date(p.dueDate + 'T00:00:00');

                    // Bu ay Ã¶denen Ã¶demeler
                    if (p.status === 'paid' && p.paymentDate) {
                        // Tarih parse etme - YYYY-MM-DD formatÄ± iÃ§in T00:00:00 ekle
                        let paymentDateStr = p.paymentDate;
                        if (paymentDateStr.length === 10 && paymentDateStr.includes('-')) {
                            paymentDateStr += 'T00:00:00';
                        }
                        const paymentDate = new Date(paymentDateStr);
                        
                        const paymentMonth = paymentDate.getMonth();
                        const paymentYear = paymentDate.getFullYear();
                        
                        if (paymentMonth === currentMonth && paymentYear === currentYear) {
                            totalPaidThisMonth += (p.amount || 0);
                            paidPaymentsThisMonth.push({
                                member: member.Ad_Soyad,
                                amount: p.amount,
                                date: p.paymentDate,
                                parsedDate: paymentDate.toLocaleDateString('tr-TR'),
                                month: paymentMonth + 1,
                                year: paymentYear
                            });
                        }
                    }

                    // Bu ay vadesi gelen Ã¶demeler (Ã¶denmemiÅŸ)
                    if (p.status === 'unpaid') {
                        const isDueThisMonth = dueDate.getMonth() === currentMonth && dueDate.getFullYear() === currentYear;
                        if (isDueThisMonth) {
                            pendingThisMonth += p.amount;
                        }
                    }
                });
            });

            console.log('ğŸ’° [AÄ°DATLAR SEKMESÄ°] Bu Ay Ã–denen Detay:', {
                'Toplam': totalPaidThisMonth.toLocaleString('tr-TR') + 'â‚º',
                'Ã–deme SayÄ±sÄ±': paidPaymentsThisMonth.length,
                'Aranan Ay': currentMonth + 1,
                'Aranan YÄ±l': currentYear,
                'Ã–demeler': paidPaymentsThisMonth
            });
            
            // TÃ¼m paid Ã¶demeleri de gÃ¶relim
            let allPaidPayments = [];
            activeMembers.forEach(member => {
                const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                if (!preReg || !preReg.paymentSchedule) return;
                
                preReg.paymentSchedule.forEach(p => {
                    if (p.status === 'paid' && p.paymentDate) {
                        let paymentDateStr = p.paymentDate;
                        if (paymentDateStr.length === 10 && paymentDateStr.includes('-')) {
                            paymentDateStr += 'T00:00:00';
                        }
                        const paymentDate = new Date(paymentDateStr);
                        
                        allPaidPayments.push({
                            member: member.Ad_Soyad,
                            amount: p.amount,
                            date: p.paymentDate,
                            month: paymentDate.getMonth() + 1,
                            year: paymentDate.getFullYear()
                        });
                    }
                });
            });
            
            console.log('ğŸ“‹ TÃ¼m Ã–denen Ã–demeler:', allPaidPayments);

            const totalCiro = totalPaidThisMonth + pendingThisMonth;

            const totalRevenueText = totalCiro.toLocaleString('tr-TR') + 'â‚º';
            const totalPaidText = totalPaidThisMonth.toLocaleString('tr-TR') + 'â‚º';
            const totalUnpaidText = pendingThisMonth.toLocaleString('tr-TR') + 'â‚º';
            
            console.log('ğŸ”§ DOM gÃ¼ncellenecek:', {
                totalRevenue: totalRevenueText,
                totalPaid: totalPaidText,
                totalUnpaid: totalUnpaidText
            });
            
            document.getElementById('totalRevenue').textContent = totalRevenueText;
            document.getElementById('totalPaid').textContent = totalPaidText;
            document.getElementById('totalUnpaid').textContent = totalUnpaidText;
            
            console.log('âœ… DOM gÃ¼ncellendi - kontrol:', document.getElementById('totalPaid').textContent);


            // GecikmiÅŸ Ã¶demeler - hem sayÄ± hem tutar
            let overdueInstallmentCount = 0;
            let overdueAmount = 0;
            const membersWithOverdue = new Set();
            let overdueDetails = [];
            
            // YukarÄ±da tanÄ±mlanan activeMembers kullan
            activeMembers.forEach(m => {
                const preReg = preRegistrations.find(p => p.id === m.preRegistrationId);
                if (!preReg || !preReg.paymentSchedule) return;
                
                let memberHasOverdue = false;
                let memberOverdueCount = 0;
                let memberOverdueAmount = 0;
                
                preReg.paymentSchedule.forEach(p => {
                    if (p.status === 'unpaid' && new Date(p.dueDate + 'T00:00:00') < today) {
                        overdueInstallmentCount++;
                        overdueAmount += p.amount || 0;
                        memberOverdueCount++;
                        memberOverdueAmount += p.amount || 0;
                        memberHasOverdue = true;
                    }
                });
                
                if (memberHasOverdue) {
                    membersWithOverdue.add(m.id);
                    overdueDetails.push({
                        name: m.Ad_Soyad,
                        count: memberOverdueCount,
                        amount: memberOverdueAmount
                    });
                }
            });
            
            const overdueMemberCount = membersWithOverdue.size;
            
            console.log('ğŸ’° [Ä°STATÄ°STÄ°K] GecikmiÅŸ Ã–deme Ä°statistikleri:', {
                'Aktif Ãœye SayÄ±sÄ±': activeMembers.length,
                'Gecikmesi Olan Ãœye SayÄ±sÄ±': overdueMemberCount,
                'Taksit SayÄ±sÄ±': overdueInstallmentCount,
                'Toplam Tutar': overdueAmount.toLocaleString('tr-TR') + 'â‚º',
                'Ãœye Ä°simleri': overdueDetails.map(d => d.name),
                'Detaylar': overdueDetails
            });
            
            // Buton metninde Ã¼ye sayÄ±sÄ±nÄ± gÃ¶ster
            document.getElementById('overdue-count').textContent = `(${overdueMemberCount})`;
            
            // GecikmiÅŸ Ã¶demeler istatistiklerini gÃ¼ncelle
            const overdueAmountEl = document.getElementById('overdue-total-amount');
            const overdueMemberCountEl = document.getElementById('overdue-member-count');
            if (overdueAmountEl) {
                const overdueAmountText = overdueAmount.toLocaleString('tr-TR') + 'â‚º';
                overdueAmountEl.textContent = overdueAmountText;
                overdueAmountEl.dataset.originalValue = overdueAmountText; // âœ… Maskeleme iÃ§in gÃ¼ncelle
            }
            if (overdueMemberCountEl) {
                overdueMemberCountEl.textContent = overdueMemberCount;
                overdueMemberCountEl.dataset.originalValue = overdueMemberCount.toString(); // âœ… Maskeleme iÃ§in gÃ¼ncelle
            }
            
            // PlanÄ± bitenler - sadece preReg'i ve paymentSchedule'Ä± olan aktif/pending Ã¼yeler
            const finishedCount = activeMembers.filter(member => {
                const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                return preReg && preReg.paymentSchedule && preReg.paymentSchedule.length > 0 && preReg.paymentSchedule.every(p => p.status === 'paid');
            }).length;
            document.getElementById('finished-count').textContent = `(${finishedCount})`;
            
            // Ã–deme tutarlarÄ±nÄ± maskele (eÄŸer gizli ise) - titreme Ã¶nleme iÃ§in animasyon frame kullan
            requestAnimationFrame(() => applyPaymentVisibility());
        }

        function renderAbsentStudents() {
            const container = document.getElementById('absentStudentsList');
            if(!container) return;
            
            // ğŸš€ HIZLI BAÅLANGIÃ‡ - Veriler yoksa atla (updateDashboard'da zaten loading gÃ¶steriyoruz)
            if (members.length === 0 || attendanceRecords.length === 0) return;
            
            // âœ… Sadece aktif Ã¼yelere ait devamsÄ±zlÄ±klarÄ± gÃ¶ster
            const allAbsences = attendanceRecords
                .filter(rec => {
                    if (rec.status !== 'absent') return false;
                    const member = members.find(m => m.id === rec.memberId);
                    return member && member.status === 'active'; // Sadece aktif Ã¼yeler
                })
                .sort((a, b) => new Date(b.date) - new Date(a.date));
                
            const displayAbsences = allAbsences.slice(0, 10);

            if (displayAbsences.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>Son zamanlarda devamsÄ±zlÄ±k yapan Ã¶ÄŸrenci bulunmuyor.</p></div>`;
                return;
            }
            
            let html = displayAbsences.map(absence => {
                const member = members.find(m => m.id === absence.memberId);
                if (!member) return ''; // GÃ¼venlik kontrolÃ¼
                
                const memberName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad || 'Ä°simsiz';
                const phone = member.Telefon || 'Telefon yok';
                const dateStr = formatDate(absence.date);
                const reasonText = absence.reason ? absence.reason : '<i style="color: #999;">Sebep belirtilmedi</i>';
                
                return `
                    <div class="absence-item" onclick="showMemberAttendancePage('${member.id}')" style="cursor: pointer;">
                        <div>
                            <strong>${memberName}</strong><br>
                            <small style="color: #666;">ğŸ“ ${phone} â€¢ ğŸ“… ${dateStr}</small>
                        </div>
                        <div class="absence-reason">
                            ${reasonText}
                        </div>
                    </div>
                `;
            }).filter(html => html !== '').join(''); // BoÅŸ HTML'leri filtrele
            
            if (allAbsences.length > 10) {
                html += `<div style="text-align: center; padding: 15px;">
                    <button class="btn btn-primary btn-sm" onclick="showSection('attendance-tracking', document.querySelector('.nav-btn[onclick*=attendance]'))">TÃ¼m DevamsÄ±zlÄ±klarÄ± GÃ¶ster (${allAbsences.length})</button>
                </div>`;
            }
            
            container.innerHTML = html || `<div class="empty-state"><p>Son zamanlarda devamsÄ±zlÄ±k yapan Ã¶ÄŸrenci bulunmuyor.</p></div>`;
        }
        
        function renderUpcomingBirthdays() {
            const container = document.getElementById('upcomingBirthdaysList');
            if(!container) return;
            
            // ğŸš€ HIZLI BAÅLANGIÃ‡ - Veriler yoksa atla (updateDashboard'da zaten loading gÃ¶steriyoruz)
            if (members.length === 0 && preRegistrations.length === 0) return;

            const today = new Date();
            today.setHours(0,0,0,0);
            const upcomingLimit = new Date();
            upcomingLimit.setDate(today.getDate() + 30); // Next 30 days

            let birthdayList = [];
            
            members.forEach(m => {
                // âœ… Ã–ÄŸrenci doÄŸum gÃ¼nÃ¼
                if (m.studentBirthDate) {
                    const birthDate = new Date(m.studentBirthDate);
                    let nextBirthday = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());
                    if (nextBirthday < today) {
                        nextBirthday.setFullYear(today.getFullYear() + 1);
                    }
                    if (nextBirthday >= today && nextBirthday <= upcomingLimit) {
                        birthdayList.push({
                            member: m,
                            nextBirthday: nextBirthday,
                            birthDate: m.studentBirthDate,
                            name: m.Resit_Olmayan_Adi_Soyadi || m.Ad_Soyad,
                            type: m.Resit_Olmayan_Adi_Soyadi ? 'Ã–ÄŸrenci' : 'Ãœye'
                        });
                    }
                }
                
                // âœ… Veli doÄŸum gÃ¼nÃ¼ (kayit.html'den gelen Dogum_Tarihi alanÄ±)
                if (m.Dogum_Tarihi && m.Resit_Olmayan_Adi_Soyadi) {
                    // Sadece Ã§ocuk kaydÄ±ysa veli doÄŸum gÃ¼nÃ¼ ekle
                    const birthDate = new Date(m.Dogum_Tarihi);
                    let nextBirthday = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());
                    if (nextBirthday < today) {
                        nextBirthday.setFullYear(today.getFullYear() + 1);
                    }
                    if (nextBirthday >= today && nextBirthday <= upcomingLimit) {
                        birthdayList.push({
                            member: m,
                            nextBirthday: nextBirthday,
                            birthDate: m.Dogum_Tarihi,
                            name: m.Ad_Soyad,
                            studentName: m.Resit_Olmayan_Adi_Soyadi,
                            type: 'Veli'
                        });
                    }
                }
            });

            birthdayList.sort((a, b) => a.nextBirthday - b.nextBirthday);

            if (birthdayList.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>YaklaÅŸan doÄŸum gÃ¼nÃ¼ bulunmuyor.</p></div>`;
                return;
            }

            container.innerHTML = birthdayList.map(item => {
                const formattedDate = item.nextBirthday.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' });
                const age = calculateAge(item.birthDate) + 1;
                const isToday = item.nextBirthday.getDate() === today.getDate() && item.nextBirthday.getMonth() === today.getMonth();
                const sendButton = isToday ? `<button class="btn btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-left: 10px; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;" onclick="sendBirthdayMessage('${item.member.id}')">ğŸ‚ Mesaj GÃ¶nder</button>` : '';
                
                // âœ… Veli iÃ§in Ã¶zel badge ve detay
                let typeBadge, nameDisplay;
                if (item.type === 'Veli') {
                    typeBadge = '<span style="background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%); color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 8px;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ VELÄ°</span>';
                    nameDisplay = `<strong>${item.name}</strong>${typeBadge}<br><small style="color: #888; font-size: 12px;">ğŸ‘¶ Ã–ÄŸrenci: ${item.studentName || 'BelirtilmemiÅŸ'}</small>`;
                } else if (item.type === 'Ã–ÄŸrenci') {
                    typeBadge = '<span style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 8px;">ğŸ‘¶ Ã–ÄRENCÄ°</span>';
                    nameDisplay = `<strong>${item.name}</strong>${typeBadge}`;
                } else {
                    typeBadge = '<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 8px;">ğŸ‘¤ ÃœYE</span>';
                    nameDisplay = `<strong>${item.name}</strong>${typeBadge}`;
                }

                return `
                    <div class="birthday-item">
                        <div>
                            ${nameDisplay}${isToday ? ' <span style="color: #667eea; font-weight: bold;">ğŸ‚ BUGÃœN!</span>' : ''}<br>
                            <small>${formattedDate} tarihinde ${age}. yaÅŸÄ±na girecek.</small>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${sendButton}
                        <div class="birthday-icon">ğŸ‰</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // KayÄ±t Olabilir hatÄ±rlatmalarÄ±nÄ± gÃ¶ster
        function renderKayitOlabilirReminders() {
            const container = document.getElementById('kayitOlabilirList');
            if (!container) {
                console.log('âŒ kayitOlabilirList container bulunamadÄ±!');
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const weekLater = new Date(today);
            weekLater.setDate(today.getDate() + 7);
            
            console.log('ğŸ“… renderKayitOlabilirReminders Ã§aÄŸrÄ±ldÄ±, crmLeads:', crmLeads.length);
            
            // KayÄ±t Olabilir etiketine sahip ve tarihi yaklaÅŸan branÅŸlar
            const reminders = [];
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(branchData => {
                        if (branchData.selectedTag === 'KayÄ±t Olabilir' && branchData.kayitOlabilirDate) {
                            const reminderDate = new Date(branchData.kayitOlabilirDate);
                            if (reminderDate >= today && reminderDate <= weekLater) {
                                reminders.push({
                                    lead,
                                    branchData,
                                    date: reminderDate
                                });
                            }
                        }
                    });
                }
            });
            
            console.log('ğŸ“… Bulunan KayÄ±t Olabilir hatÄ±rlatmasÄ±:', reminders.length);
            
            reminders.sort((a, b) => a.date - b.date);
            
            if (reminders.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>YaklaÅŸan kayÄ±t hatÄ±rlatmasÄ± yok</p></div>`;
                return;
            }
            
            container.innerHTML = reminders.map(({lead, branchData, date}) => {
                const isToday = date.getDate() === today.getDate() && 
                               date.getMonth() === today.getMonth() && 
                               date.getFullYear() === today.getFullYear();
                
                const formattedDate = date.toLocaleString('tr-TR', {
                    day: 'numeric',
                    month: 'long',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const branch = branches.find(b => b.id === branchData.branchId);
                const branchText = branch ? `${branch.icon} ${branch.name}` : '';
                
                return `
                    <div class="birthday-item" style="cursor: pointer;" onclick="openCustomerDetail('${lead.id}')">
                        <div>
                            <strong>${lead.fullName}</strong>${isToday ? ' <span style="color: #667eea; font-weight: bold;">ğŸ“… BUGÃœN!</span>' : ''}<br>
                            <small>${formattedDate} - ${branchText}</small><br>
                            <small style="color: #666;">ğŸ“ ${lead.phone}</small>
                        </div>
                        <div class="birthday-icon">ğŸ“</div>
                    </div>
                `;
            }).join('');
        }
        
        // Denemeye Gelecek hatÄ±rlatmalarÄ±nÄ± gÃ¶ster
        function renderDenemeGelecekReminders() {
            const container = document.getElementById('denemeGelecekList');
            if (!container) {
                console.log('âŒ denemeGelecekList container bulunamadÄ±!');
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const weekLater = new Date(today);
            weekLater.setDate(today.getDate() + 7);
            
            console.log('ğŸ¾ renderDenemeGelecekReminders Ã§aÄŸrÄ±ldÄ±, crmLeads:', crmLeads.length);
            
            // Denemeye Gelecek etiketine sahip ve tarihi yaklaÅŸan branÅŸlar
            const reminders = [];
            crmLeads.forEach(lead => {
                if (lead.branches && lead.branches.length > 0) {
                    lead.branches.forEach(branchData => {
                        if (branchData.selectedTag === 'Denemeye Gelecek' && branchData.denemeDate) {
                            const denemeDate = new Date(branchData.denemeDate);
                            if (denemeDate >= today && denemeDate <= weekLater) {
                                reminders.push({
                                    lead,
                                    branchData,
                                    date: denemeDate
                                });
                            }
                        }
                    });
                }
            });
            
            console.log('ğŸ¾ Bulunan Denemeye Gelecek hatÄ±rlatmasÄ±:', reminders.length);
            
            reminders.sort((a, b) => a.date - b.date);
            
            if (reminders.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>YaklaÅŸan deneme dersi yok</p></div>`;
                return;
            }
            
            container.innerHTML = reminders.map(({lead, branchData, date}) => {
                const isToday = date.getDate() === today.getDate() && 
                               date.getMonth() === today.getMonth() && 
                               date.getFullYear() === today.getFullYear();
                
                const formattedDate = date.toLocaleString('tr-TR', {
                    day: 'numeric',
                    month: 'long',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const branch = branches.find(b => b.id === branchData.branchId);
                const branchText = branch ? `${branch.icon} ${branch.name}` : '';
                
                return `
                    <div class="birthday-item" style="cursor: pointer;" onclick="openCustomerDetail('${lead.id}')">
                        <div>
                            <strong>${lead.fullName}</strong>${isToday ? ' <span style="color: #f093fb; font-weight: bold;">ğŸ¾ BUGÃœN!</span>' : ''}<br>
                            <small>${formattedDate} - ${branchText}</small><br>
                            <small style="color: #666;">ğŸ“ ${lead.phone}</small>
                        </div>
                        <div class="birthday-icon">ğŸ¾</div>
                    </div>
                `;
            }).join('');
        }
        
        function openModal(modalId) { 
            const modal = document.getElementById(modalId);
            modal.style.display = 'block';
            
            // Modal overlay'e tÄ±klama eventi ekle (sadece modal-content dÄ±ÅŸÄ±)
            modal.onclick = function(event) {
                if (event.target === modal) {
                    closeModal(modalId);
                }
            };
        }
        function openGroupModal() {
            const form = document.getElementById('groupForm');
            form.reset();
            form.groupId.value = ''; // Ensure no old ID is present
            
            // âœ… BranÅŸ dropdown'unu dinamik olarak gÃ¼ncelle
            const branchSelect = form.querySelector('[name="branch"]');
            branchSelect.innerHTML = '<option value="">SeÃ§iniz...</option>' + 
                branches.map(b => `<option value="${b.id}">${b.icon} ${b.name}</option>`).join('');
            
            if (selectedBranchForGroups) {
                branchSelect.value = selectedBranchForGroups;
            }
            document.getElementById('groupModalTitle').textContent = 'â• Yeni Grup OluÅŸtur';
            openModal('groupModal');
        }
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) {
                modal.style.display = 'none';
                const form = modal.querySelector('form');
                if (form) form.reset();
                
                // âœ… Modal kapandÄ±ÄŸÄ±nda tÃ¼m ses kayÄ±tlarÄ±nÄ± durdur
                const audioElements = modal.querySelectorAll('audio');
                audioElements.forEach(audio => {
                    audio.pause();
                    audio.currentTime = 0;
                    // Blob URL'leri temizle (memory leak Ã¶nleme)
                    if (audio.src && audio.src.startsWith('blob:')) {
                        URL.revokeObjectURL(audio.src);
                        audio.src = '';
                    }
                });
                
                // addLeadModal kapatÄ±lÄ±rken lastCheckedPhone'u sÄ±fÄ±rla
                if (modalId === 'addLeadModal') {
                    lastCheckedPhone = '';
                    const messageDiv = document.getElementById('phone-check-message');
                    if (messageDiv) messageDiv.innerHTML = '';
                }
            }
        }
        
        function deleteItem(collectionName, id) {
            let itemType = '';
            if (collectionName === 'members') itemType = 'Ã¼yeyi ve iliÅŸkili kayÄ±tlarÄ±nÄ±';
            else if (collectionName === 'preRegistrations') itemType = 'kaydÄ± ve iliÅŸkili Ã¼yeyi';
            else if (collectionName === 'groups') itemType = 'grubu (iÃ§indeki Ã¼yeler Ã§Ä±karÄ±lacak)';
            else if (collectionName === 'users') itemType = 'kullanÄ±cÄ±yÄ±';
            else if (collectionName === 'tasks') itemType = 'gÃ¶revi';
            else itemType = 'Ã¶ÄŸeyi';
            const text = `Bu ${itemType} kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.`;
            showConfirmModal(text, () => executeDelete(collectionName, id));
        }
        
        async function executeDelete(collectionName, id) {
            closeModal('confirmModal');
            try {
                if (collectionName === 'members') {
                    const memberToDelete = members.find(m => m.id === id);
                    if (memberToDelete) {
                        const group = groups.find(g => Array.isArray(g.members) && g.members.includes(id));
                        if (group) {
                            await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', group.id), { members: window.firebase.arrayRemove(id) });
                        }
                        if (memberToDelete.preRegistrationId) {
                            await window.firebase.deleteDoc(window.firebase.doc(window.db, 'preRegistrations', memberToDelete.preRegistrationId)).catch(e => {});
                        }
                    }
                } else if (collectionName === 'preRegistrations') {
                    const preRegToDelete = preRegistrations.find(p => p.id === id);
                    if (preRegToDelete) {
                        const memberToDelete = members.find(m => m.preRegistrationId === id || m.Telefon === preRegToDelete.phone);
                        if (memberToDelete) {
                            const group = groups.find(g => Array.isArray(g.members) && g.members.includes(memberToDelete.id));
                            if (group) {
                                await window.firebase.updateDoc(window.firebase.doc(window.db, 'groups', group.id), { members: window.firebase.arrayRemove(memberToDelete.id) });
                            }
                            await window.firebase.deleteDoc(window.firebase.doc(window.db, 'members', memberToDelete.id));
                        }
                    }
                }
                
                await window.firebase.deleteDoc(window.firebase.doc(window.db, collectionName, id));
                
                showAlert('Ã–ÄŸe ve iliÅŸkili kayÄ±tlar baÅŸarÄ±yla silindi', 'success');
                await loadData();
            } catch (error) { 
                showAlert('Ã–ÄŸe silinirken hata oluÅŸtu', 'danger'); 
                console.error(error); 
            }
        }
        
        function viewMemberPayments(memberId) {
            if (!currentUser?.permissions?.view_payments) {
                return showAlert('Ã–demeleri gÃ¶rÃ¼ntÃ¼leme yetkiniz yok.', 'warning');
            }
            const member = members.find(m => m.id === memberId);
            const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
            if (preReg) viewPaymentPlan(preReg.id);
            else showAlert('Bu Ã¼yeye ait Ã¶deme planÄ± bulunamadÄ±.', 'warning');
        }

        function viewPaymentPlan(preRegId) {
            const preReg = preRegistrations.find(p => p.id === preRegId);
            if (!preReg) return;
            document.getElementById('paymentPlanTitle').innerHTML = `ğŸ“… Ã–deme PlanÄ± - <strong>${preReg.parentName || preReg.studentName}</strong>`;
            let planHtml = `<div style="background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px;"><p><strong>DÃ¶nem:</strong> ${formatDate(preReg.periodStart)} - ${formatDate(preReg.periodEnd)}</p></div>`;
            
            // âœ… Yetki kontrolÃ¼ ile butonlarÄ± gÃ¶ster
            if (currentUser?.permissions?.edit_payments) {
                planHtml += `<div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <button class="btn btn-sm btn-secondary" onclick="selectAllPayments('${preReg.id}', true)">âœ“ TÃ¼mÃ¼nÃ¼ SeÃ§</button>
                    <button class="btn btn-sm btn-secondary" onclick="selectAllPayments('${preReg.id}', false)">âœ— SeÃ§imi KaldÄ±r</button>
                    <button class="btn btn-sm btn-success" onclick="markSelectedPaymentsAsPaid('${preReg.id}')">ğŸ’° SeÃ§ilenleri Ã–dendi Yap</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteSelectedPayments('${preReg.id}')">ğŸ—‘ï¸ SeÃ§ilenleri Sil</button>
                </div>`;
            }
            
            planHtml += renderPaymentDetailsTable(preReg);
            
            if (currentUser?.permissions?.edit_payments) {
                planHtml += `<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; gap: 10px;">
                    <button class="btn btn-danger" onclick="deleteSelectedPayments('${preReg.id}')">ğŸ—‘ï¸ SeÃ§ilenleri Sil</button>
                    <button class="btn btn-success" onclick="openPaymentEditModal('${preReg.id}', null, true)">â• Yeni Taksit Ekle</button>
                </div>`;
            }
            
            document.getElementById('paymentPlanContent').innerHTML = planHtml;
            openModal('paymentPlanModal');
        }

        function openPaymentEditModal(preRegId, paymentNumber, isNew = false) {
            if (!currentUser?.permissions?.edit_payments) {
                return showAlert('Bu iÅŸlem iÃ§in yetkiniz bulunmamaktadÄ±r.', 'warning');
            }
            closeModal('paymentPlanModal');
            const form = document.getElementById('paymentForm');
            form.reset();
            document.getElementById('paymentPeriodInfoStatic').style.display = 'none';

            form.querySelector('button[type="submit"]').style.display = 'block';
            
            const preReg = preRegistrations.find(p => p.id === preRegId);
            if(!preReg) return;

            form.dataset.mode = isNew ? 'new' : 'edit';
            form.paymentPreRegId.value = preRegId;

            // âœ… KaÃ§ ay daha aidat eklenecek alanÄ±nÄ± gÃ¶ster/gizle
            const additionalMonthsField = document.getElementById('additionalMonthsField');
            
            if (isNew) {
                document.getElementById('paymentModalTitle').textContent = `â• Yeni Taksit Ekle`;
                document.getElementById('paymentPeriodInfo').style.display = 'grid';
                additionalMonthsField.style.display = 'block'; // âœ… Yeni aidatta gÃ¶ster
                form.paymentNumber.value = (preReg.paymentSchedule || []).length + 1;
                form.additionalMonths.value = 0; // VarsayÄ±lan 0
            } else {
                const payment = preReg.paymentSchedule.find(p => p.paymentNumber === paymentNumber);
                if(!payment) return;
                
                document.getElementById('paymentModalTitle').textContent = `âœï¸ ${paymentNumber}. Ã–demeyi DÃ¼zenle`;
                document.getElementById('paymentPeriodInfo').style.display = 'grid'; 
                additionalMonthsField.style.display = 'none'; // âœ… DÃ¼zenlemede gizle

                form.paymentNumber.value = paymentNumber;
                form.paymentDate.value = payment.paymentDate || '';
                form.paymentAmount.value = payment.amount.toLocaleString('tr-TR');
                form.paymentDueDate.value = payment.dueDate;
                form.paymentMethod.value = payment.method || '';
                form.paymentStatus.value = payment.status;
                form.paymentNote.value = payment.note || '';
                form.periodStart.value = payment.period.start;
                form.periodEnd.value = payment.period.end;
                form.lessonCount.value = payment.period.lessonCount;
                
                 const paymentStatusSelect = form.querySelector('[name="paymentStatus"]');
                 const paymentDateInput = form.querySelector('[name="paymentDate"]');
                
                 paymentStatusSelect.onchange = () => {
                    if (paymentStatusSelect.value === 'paid' && !paymentDateInput.value) {
                         paymentDateInput.value = getTodayString();
                    }
                 };
                 paymentStatusSelect.value = payment.status;
            }
            
            openModal('paymentModal');
        }
        
        function renderPaymentDetailsTable(preReg) {
            const paymentSchedule = preReg.paymentSchedule || [];
            if (paymentSchedule.length === 0) return `<p class="empty-state">Ã–deme planÄ± yok.</p>`;
            
            // âœ… Yetki kontrolÃ¼ - checkbox kolonunu gÃ¶ster/gizle
            const hasEditPermission = currentUser?.permissions?.edit_payments;
            const checkboxHeader = hasEditPermission ? `<th style="width: 40px;"><input type="checkbox" onchange="selectAllPayments('${preReg.id}', this.checked)"></th>` : '';
            const tableHeaders = `<thead><tr>${checkboxHeader}<th>DÃ¶nem</th><th>Dersler ve Tarih AralÄ±ÄŸÄ±</th><th>Tutar</th><th>Son Ã–deme</th><th>Ã–deme Tarihi</th><th>Durum</th><th style="width: 150px;">Ä°ÅŸlemler</th></tr></thead>`;

            // Bu ay Ã¶denen taksitler iÃ§in highlight
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            const bodyHtml = paymentSchedule.map(p => {
                today.setHours(0,0,0,0);
                const dueDate = new Date(p.dueDate + 'T00:00:00');
                const isOverdue = dueDate < today && p.status === 'unpaid';
                const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                const isUpcoming = daysUntilDue > 0 && daysUntilDue <= 7 && p.status === 'unpaid';
                const statusClass = isOverdue ? 'overdue' : p.status;
                const lessonCountText = `${p.period.lessonCount} Ders`;
                
                // Bu ay Ã¶denen taksitler iÃ§in highlight
                let isPaidThisMonth = false;
                if (p.status === 'paid' && p.paymentDate) {
                    const paymentDate = new Date(p.paymentDate);
                    isPaidThisMonth = paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear;
                }
                const rowStyle = isPaidThisMonth ? 'background-color: #e3f2fd;' : '';
                
                // Build dropdown menu items
                let dropdownItems = [];
                
                // Message button (if unpaid) - tÃ¼m unpaid Ã¶demeler iÃ§in mesaj gÃ¶nderilebilsin
                if (p.status === 'unpaid') {
                    if (isOverdue) {
                        dropdownItems.push(`<button onclick="event.stopPropagation(); window.sendPaymentReminderMessage('${preReg.id}', ${p.paymentNumber}, 'overdue')">ğŸ’¬ GecikmiÅŸ Ã–deme MesajÄ±</button>`);
                    } else {
                        // Vadesi gelmeyen Ã¶demeler iÃ§in de "YaklaÅŸan Ã–deme" ÅŸablonunu kullan
                        dropdownItems.push(`<button onclick="event.stopPropagation(); window.sendPaymentReminderMessage('${preReg.id}', ${p.paymentNumber}, 'upcoming')">ğŸ’¬ Ã–deme HatÄ±rlatmasÄ± GÃ¶nder</button>`);
                    }
                }
                
                // Edit button (if has permission)
                if(currentUser?.permissions?.edit_payments){
                    dropdownItems.push(`<button onclick="event.stopPropagation(); window.openPaymentEditModal('${preReg.id}', ${p.paymentNumber})">âœï¸ DÃ¼zenle</button>`);
                    dropdownItems.push(`<button class="danger" onclick="event.stopPropagation(); window.deletePaymentFromSchedule('${preReg.id}', ${p.paymentNumber})">ğŸ—‘ï¸ Sil</button>`);
                }
                
                const actionsHtml = dropdownItems.length > 0 ? `
                    <div class="actions-dropdown">
                        <button class="actions-dropdown-btn" type="button">
                            âš™ï¸ Ä°ÅŸlemler â–¼
                        </button>
                        <div class="actions-dropdown-content">
                            ${dropdownItems.join('')}
                        </div>
                    </div>
                ` : '';

                // âœ… Checkbox kolonunu yetki kontrolÃ¼ ile gÃ¶ster
                const checkboxCell = hasEditPermission ? 
                    `<td><input type="checkbox" class="payment-checkbox" data-prereg-id="${preReg.id}" data-payment-num="${p.paymentNumber}" ${p.status === 'paid' ? 'disabled' : ''}></td>` : '';
                
                return `<tr style="${rowStyle}">
                    ${checkboxCell}
                    <td>${p.paymentNumber}. Aidat${isPaidThisMonth ? ' ğŸ’³' : ''}</td>
                    <td>${lessonCountText} (${formatDate(p.period.start)} - ${formatDate(p.period.end)})</td>
                    <td>${p.amount.toLocaleString('tr-TR')}â‚º</td>
                    <td>${formatDate(p.dueDate)}</td>
                    <td>${p.paymentDate ? formatDate(p.paymentDate) : '-'}</td>
                    <td><span class="status-badge status-${statusClass}">${getPaymentStatusText(statusClass)}</span></td>
                    <td class="actions-cell">${actionsHtml}</td>
                </tr>`;
            }).join('');

            return `<div class="table-container"><table class="data-table">${tableHeaders}<tbody>${bodyHtml}</tbody></table></div>`;
        }
        
        function selectAllPayments(preRegId, checked) {
            const checkboxes = document.querySelectorAll(`.payment-checkbox[data-prereg-id="${preRegId}"]`);
            checkboxes.forEach(cb => {
                if (!cb.disabled) cb.checked = checked;
            });
        }
        
        async function markSelectedPaymentsAsPaid(preRegId) {
            const selectedCheckboxes = Array.from(document.querySelectorAll(`.payment-checkbox[data-prereg-id="${preRegId}"]:checked`));
            if (selectedCheckboxes.length === 0) {
                return showAlert('LÃ¼tfen en az bir Ã¶deme seÃ§in.', 'warning');
            }
            
            const paymentNumbers = selectedCheckboxes.map(cb => parseInt(cb.dataset.paymentNum));
            const preReg = preRegistrations.find(p => p.id === preRegId);
            if (!preReg) return showAlert('Ã–n kayÄ±t bulunamadÄ±.', 'danger');
            
            const todayString = getTodayString();
            const updatedSchedule = preReg.paymentSchedule.map(p => {
                if (paymentNumbers.includes(p.paymentNumber) && p.status !== 'paid') {
                    return { ...p, status: 'paid', paymentDate: todayString };
                }
                return p;
            });
            
            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'preRegistrations', preRegId), { paymentSchedule: updatedSchedule });
                showAlert('SeÃ§ili Ã¶demeler Ã¶dendi olarak iÅŸaretlendi.', 'success');
                await loadData();
                
                // âœ… Ä°statistikleri ve listeyi gÃ¼ncelle
                if (typeof updatePaymentStats === 'function') {
                    updatePaymentStats();
                }
                if (typeof renderPaymentsList === 'function' && currentSection === 'payments') {
                    renderPaymentsList();
                }
                
                viewPaymentPlan(preRegId); // Refresh
            } catch (error) {
                console.error('Error marking payments as paid:', error);
                showAlert('Ã–demeler gÃ¼ncellenirken hata oluÅŸtu.', 'danger');
            }
        }
        
        async function deleteSelectedPayments(preRegId) {
            const selectedCheckboxes = Array.from(document.querySelectorAll(`.payment-checkbox[data-prereg-id="${preRegId}"]:checked`));
            if (selectedCheckboxes.length === 0) {
                return showAlert('LÃ¼tfen en az bir Ã¶deme seÃ§in.', 'warning');
            }
            
            const paymentNumbers = selectedCheckboxes.map(cb => parseInt(cb.dataset.paymentNum));
            
            if (!confirm(`SeÃ§ili ${paymentNumbers.length} Ã¶deme kalÄ±cÄ± olarak silinecek. Emin misiniz?`)) {
                return;
            }
            
            const preReg = preRegistrations.find(p => p.id === preRegId);
            if (!preReg) return showAlert('Ã–n kayÄ±t bulunamadÄ±.', 'danger');
            
            // Filter out selected payments
            const updatedSchedule = preReg.paymentSchedule.filter(p => !paymentNumbers.includes(p.paymentNumber));
            
            // Renumber remaining payments
            updatedSchedule.forEach((p, index) => {
                p.paymentNumber = index + 1;
            });
            
            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'preRegistrations', preRegId), { paymentSchedule: updatedSchedule });
                showAlert('SeÃ§ili Ã¶demeler silindi.', 'success');
                await loadData();
                
                // âœ… Ä°statistikleri ve listeyi gÃ¼ncelle
                if (typeof updatePaymentStats === 'function') {
                    updatePaymentStats();
                }
                if (typeof renderPaymentsList === 'function' && currentSection === 'payments') {
                    renderPaymentsList();
                }
                
                viewPaymentPlan(preRegId); // Refresh
            } catch (error) {
                console.error('Error deleting payments:', error);
                showAlert('Ã–demeler silinirken hata oluÅŸtu.', 'danger');
            }
        }
        
        // --- HELPER FUNCTIONS ---
        function timeToMinutes(timeStr) {
            if (!timeStr || !timeStr.includes(':')) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTime(totalMinutes) {
            const hours = Math.floor(totalMinutes / 60).toString().padStart(2, '0');
            const mins = (totalMinutes % 60).toString().padStart(2, '0');
            return `${hours}:${mins}`;
        }

        function capitalize(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

         function capitalizeWords(str) {
            if (!str) return '';
            return str.toLowerCase().replace(/(?:^|\s)\S/g, function(a) { return a.toUpperCase(); });
        }


        function calculateAge(birthDateString) {
            if (!birthDateString) return null;
            const birthDate = new Date(birthDateString);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }

        function generatePaymentSchedule(firstStart, firstEnd, firstDueDate, totalInstallments, firstAmount, subsequentAmount, dueDay, firstLessonCount) {
            const payments = [];
            
            payments.push({
                paymentNumber: 1,
                dueDate: new Date(firstDueDate).toISOString().split('T')[0],
                amount: firstAmount,
                status: 'unpaid',
                period: {
                    start: new Date(firstStart).toISOString().split('T')[0],
                    end: new Date(firstEnd).toISOString().split('T')[0],
                    lessonCount: firstLessonCount
                }
            });

            let lastPeriodEnd = new Date(firstEnd);
            let referenceDueDate = new Date(firstDueDate);
            referenceDueDate.setHours(12,0,0,0);

            for (let i = 2; i <= totalInstallments; i++) {
                const newPeriodStart = new Date(lastPeriodEnd);
                newPeriodStart.setDate(newPeriodStart.getDate() + 1);

                const newPeriodEnd = new Date(newPeriodStart);
                newPeriodEnd.setDate(newPeriodEnd.getDate() + 27); // approx 4 weeks
                
                referenceDueDate.setMonth(referenceDueDate.getMonth() + 1);
                let nextDueDate = new Date(referenceDueDate.getFullYear(), referenceDueDate.getMonth(), dueDay, 12, 0, 0);

                payments.push({
                    paymentNumber: i,
                    dueDate: nextDueDate.toISOString().split('T')[0],
                    amount: subsequentAmount,
                    status: 'unpaid',
                    period: {
                        start: newPeriodStart.toISOString().split('T')[0],
                        end: newPeriodEnd.toISOString().split('T')[0],
                        lessonCount: 8 // Her taksitte ders sayÄ±sÄ± farklÄ± olabilir, admin panelde dÃ¼zenlenir
                    }
                });
                
                lastPeriodEnd = newPeriodEnd;
            }
            return payments;
        }
        
        function autoCalculateLessonCount(form) {
            const start = form.querySelector('[name=firstPeriodStart]').value;
            const end = form.querySelector('[name=firstPeriodEnd]').value;
            const lessonCountInput = form.querySelector('[name=firstLessonCount]');
            if (start && end) {
                const startDate = new Date(start);
                const endDate = new Date(end);
                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                const weeks = Math.round(diffDays / 7);
                lessonCountInput.value = weeks * 2; // Assuming 2 lessons per week
                previewPaymentPlan(form);
            }
        }

        function previewPaymentPlan(form) {
            const data = Object.fromEntries(new FormData(form).entries());
            const previewContainer = form.querySelector('.payment-plan-preview');
            
            if(!data.firstPeriodStart || !data.firstPeriodEnd || !data.firstInstallmentAmount || !data.firstDueDate || !data.installments || !data.subsequentInstallmentAmount || !data.firstLessonCount) {
                previewContainer.innerHTML = ''; 
                return;
            }

            const totalInstallments = parseInt(data.installments) + 1;
            const firstAmount = parseFloat(unformatCurrency(data.firstInstallmentAmount) || '0');
            const subsequentAmount = parseFloat(unformatCurrency(data.subsequentInstallmentAmount) || '0');
            const paymentSchedule = generatePaymentSchedule(
                new Date(data.firstPeriodStart), new Date(data.firstPeriodEnd), new Date(data.firstDueDate),
                totalInstallments, firstAmount, subsequentAmount, parseInt(data.dueDay), parseInt(data.firstLessonCount)
            );
            
            previewContainer.innerHTML = `<h4>Ã–deme PlanÄ± Ã–nizlemesi</h4>` + renderPaymentDetailsTable({paymentSchedule: paymentSchedule}, true);
        }

        function formatCurrency(input) {
            let value = input.value.replace(/\D/g, ''); // Remove non-digits
            if(value) {
                input.value = new Intl.NumberFormat('tr-TR').format(value);
            } else {
                input.value = '';
            }
        }
        function unformatCurrency(value) {
            return value.replace(/\./g, '');
        }
        
        // Para formatÄ± iÃ§in yardÄ±mcÄ± fonksiyon (gÃ¶sterim iÃ§in)
        window.formatPrice = function(amount) {
            if (amount === null || amount === undefined || isNaN(amount)) return '0â‚º';
            const parts = parseFloat(amount).toFixed(2).split('.');
            const integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            const decimalPart = parts[1];
            return decimalPart === '00' ? `${integerPart}â‚º` : `${integerPart},${decimalPart}â‚º`;
        };
        
        function setPaymentFilter(filter, element) {
            paymentFilter = filter;
            document.querySelectorAll('#payments .btn-group .btn').forEach(btn => btn.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            }
            
            // GecikmiÅŸ Ã¶demeler istatistiklerini gÃ¶ster/gizle
            const overdueStatsContainer = document.getElementById('overdue-stats-container');
            if (overdueStatsContainer) {
                if (filter === 'overdue') {
                    overdueStatsContainer.style.display = 'grid';
                } else {
                    overdueStatsContainer.style.display = 'none';
                }
            }
            
            renderPaymentsList();
        }
        
        function navigateToSection(sectionId) {
            const button = document.querySelector(`.nav-btn[onclick*="'${sectionId}'"]`);
            if (button) button.click();
        }

        function getStatusText(status) {
            const statuses = { pending: 'Bekliyor', active: 'Aktif', completed: 'TamamlandÄ±', expired: 'Pasif' };
            return statuses[status] || 'Bilinmiyor';
        }
        function getPaymentStatusText(status) {
            const statuses = { paid: 'Ã–dendi', unpaid: 'Ã–denmedi', overdue: 'GecikmiÅŸ' };
            return statuses[status] || 'Bilinmiyor';
        }
        function formatDate(dateString) {
            if (!dateString) return '';
            // ISO strings (like from toISOString()) can be parsed directly.
            // YYYY-MM-DD strings might be interpreted as UTC, so we help it by adding time.
            if (dateString.length === 10 && dateString.includes('-')) {
                return new Date(dateString + 'T00:00:00').toLocaleDateString('tr-TR');
            }
            return new Date(dateString).toLocaleDateString('tr-TR');
        }
        function getTodayString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function closeAlert() {
            if (window.currentAlertModal && document.body.contains(window.currentAlertModal)) {
                document.body.removeChild(window.currentAlertModal);
                window.currentAlertModal = null;
            }
        }
        
        window.closeAlert = closeAlert;
        
        function showAlert(message, type = 'info') {
            // Check if message contains HTML (for modals)
            const isModal = message.includes('<form') || message.includes('<div style');
            
            if (isModal) {
                // Create modal overlay
                const modalOverlay = document.createElement('div');
                modalOverlay.style.cssText = `
                    position: fixed; 
                    top: 0; 
                    left: 0; 
                    width: 100%; 
                    height: 100%; 
                    background: rgba(0,0,0,0.5); 
                    z-index: 2000; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center;
                    overflow-y: auto;
                    padding: 20px;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.innerHTML = message;
                modalContent.style.cssText = `
                    background: white; 
                    border-radius: 12px; 
                    box-shadow: 0 10px 40px rgba(0,0,0,0.3); 
                    max-width: 600px; 
                    width: 100%; 
                    max-height: 90vh;
                    overflow-y: auto;
                    position: relative;
                `;
                
                modalOverlay.appendChild(modalContent);
                document.body.appendChild(modalOverlay);
                
                // Close on overlay click
                modalOverlay.addEventListener('click', (e) => {
                    if (e.target === modalOverlay) {
                        document.body.removeChild(modalOverlay);
                        window.currentAlertModal = null;
                    }
                });
                
                // Store reference for closeAlert
                window.currentAlertModal = modalOverlay;
                
                return;
            }
            
            // Regular alert notification
            const alertContainer = document.createElement('div');
            alertContainer.innerHTML = message.replace(/\n/g, '<br>');
            alertContainer.style.cssText = `position: fixed; top: 20px; right: 20px; z-index: 2000; padding: 15px; border-radius: 8px; color: white; background-color: ${type === 'success' ? 'var(--success-color)' : type === 'danger' ? 'var(--danger-color)' : 'var(--info-color)'}; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: opacity 0.5s ease; opacity: 1; max-width: 400px;`;
            document.body.appendChild(alertContainer);
            setTimeout(() => {
                alertContainer.style.opacity = '0';
                setTimeout(() => { 
                    if(document.body.contains(alertContainer)) {
                        document.body.removeChild(alertContainer)
                    }
                }, 500);
            }, 6000);
        }

        function toggleParentStudentFields(form) {
            const type = form.querySelector('[name="memberType"]').value;
            const phone1Label = form.querySelector('label[for="preRegPhonePre"]');

            const parentName1Group = document.getElementById('parentName1Group');
            const phone1Group = document.getElementById('phone1Group');
            const parentName2Group = document.getElementById('parentName2Group');
            const phone2Group = document.getElementById('phone2Group');
            const studentsContainer = document.getElementById('studentsContainer');
            const singleStudentContainer = document.getElementById('singleStudentContainer');

            if (type === 'adult') {
                phone1Label.textContent = 'Telefon *';
                
                [parentName1Group, parentName2Group, phone2Group].forEach(el => el.style.display = 'none');
                [parentName1Group, parentName2Group, phone2Group].forEach(el => el.querySelector('input').required = false);
                
                // Tek Ã¶ÄŸrenci alanÄ±nÄ± gÃ¶ster
                studentsContainer.style.display = 'none';
                // âœ… Gizli Ã§oklu Ã¶ÄŸrenci alanlarÄ±nÄ±n required'Ä±nÄ± kaldÄ±r
                studentsContainer.querySelectorAll('.student-name').forEach(input => input.required = false);
                
                singleStudentContainer.style.display = 'block';
                document.getElementById('studentNamePre').required = true;
                document.getElementById('studentBirthDatePre').required = false;
                
            } else { // child
                phone1Label.textContent = 'Veli Telefon *';
                
                [parentName1Group, parentName2Group, phone2Group].forEach(el => el.style.display = 'flex');
                parentName1Group.querySelector('input').required = true;
                
                // Ã‡oklu Ã¶ÄŸrenci alanlarÄ±nÄ± gÃ¶ster
                studentsContainer.style.display = 'block';
                // âœ… GÃ¶rÃ¼nÃ¼r Ã§oklu Ã¶ÄŸrenci alanlarÄ±nÄ±n required'Ä±nÄ± geri ekle
                studentsContainer.querySelectorAll('.student-name').forEach(input => input.required = true);
                
                singleStudentContainer.style.display = 'none';
                document.getElementById('studentNamePre').required = false;
                document.getElementById('studentBirthDatePre').required = false;
            }
        }
        
        // Ã–ÄŸrenci alanÄ± ekle
        window.addStudentField = function() {
            const container = document.getElementById('studentFieldsContainer');
            const studentCount = container.querySelectorAll('.student-field-group').length;
            
            const newStudentField = document.createElement('div');
            newStudentField.className = 'student-field-group';
            newStudentField.setAttribute('data-student-index', studentCount);
            
            const borderColors = ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#F44336'];
            const borderColor = borderColors[studentCount % borderColors.length];
            
            const today = getTodayString();
            
            newStudentField.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; position: relative; border-left: 4px solid ${borderColor};">
                    <h5 style="margin: 0 0 15px 0; color: #333;">Ã–ÄŸrenci ${studentCount + 1}</h5>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeStudentField(${studentCount})" style="position: absolute; top: 10px; right: 10px;">ğŸ—‘ï¸</button>
                    <div class="form-grid">
                        <div class="form-group"><label>Ad Soyad *</label><input type="text" class="form-control student-name" name="studentName_${studentCount}" required></div>
                        <div class="form-group"><label>DoÄŸum Tarihi</label><input type="date" class="form-control student-birthdate" name="studentBirthDate_${studentCount}" max="${today}"></div>
                    </div>
                </div>
            `;
            container.appendChild(newStudentField);
        };
        
        // Ã–ÄŸrenci alanÄ±nÄ± kaldÄ±r
        window.removeStudentField = function(index) {
            const container = document.getElementById('studentFieldsContainer');
            const studentGroups = container.querySelectorAll('.student-field-group');
            
            if (studentGroups.length <= 1) {
                showAlert('En az bir Ã¶ÄŸrenci olmalÄ±dÄ±r.', 'warning');
                return;
            }
            
            const fieldToRemove = container.querySelector(`[data-student-index="${index}"]`);
            if (fieldToRemove) {
                fieldToRemove.remove();
            }
        };
        
        function toggleParentStudentFieldsForEdit(form, isAdult) {
            const parentNameGroup = form.querySelector('[name="parentName"]').parentElement;
            const studentNameLabel = form.querySelector('label[for="studentName"]');

            if (isAdult) {
                if(studentNameLabel) studentNameLabel.textContent = 'Ad Soyad *';
                if(parentNameGroup) parentNameGroup.style.display = 'none';
                if(parentNameGroup) parentNameGroup.querySelector('input').required = false;
            } else {
                if(studentNameLabel) studentNameLabel.textContent = 'Ã–ÄŸrenci Ad Soyad *';
                if(parentNameGroup) parentNameGroup.style.display = 'flex';
                if(parentNameGroup) parentNameGroup.querySelector('input').required = true;
            }
        }


        function filterGroupsByBranch(branch, element) {
            selectedBranchForGroups = branch;
            document.querySelectorAll('#group-branch-filter .btn').forEach(b => b.classList.remove('active'));
            if (element) element.classList.add('active');
            document.getElementById('newGroupBtn').style.display = 'inline-flex';
            renderGroupsList();
        }

        function filterScheduleByBranch(branch, element) {
            selectedBranchForSchedule = branch;
            document.querySelectorAll('#schedule-branch-filter .btn').forEach(b => b.classList.remove('active'));
            if (element) element.classList.add('active');
            renderScheduleGrid();
        }

        function showConfirmModal(text, onConfirm) {
             const confirmModal = document.getElementById('confirmModal');
             document.getElementById('confirmText').textContent = text;
             const confirmYesBtn = document.getElementById('confirmYesBtn');
             
             const newYesBtn = confirmYesBtn.cloneNode(true);
             newYesBtn.textContent = 'Evet, Onayla';
             confirmYesBtn.parentNode.replaceChild(newYesBtn, confirmYesBtn);
             
             newYesBtn.onclick = onConfirm;
             openModal('confirmModal');
        }

        function sortMembersByAge() {
            if (ageSortDirection === 'none') {
                ageSortDirection = 'asc';
            } else if (ageSortDirection === 'asc') {
                ageSortDirection = 'desc';
            } else {
                ageSortDirection = 'none';
            }
            renderMembersTable();
        }
        
        function editReason(cellElement, recordId) {
            const currentReason = cellElement.textContent === 'Sebep Ekle' ? '' : cellElement.textContent;
            cellElement.innerHTML = `<input type="text" class="form-control" value="${currentReason}" onblur="saveReason('${recordId}', this.value, this.parentElement)" onkeypress="if(event.key === 'Enter') this.blur()" autofocus>`;
            cellElement.querySelector('input').focus();
            cellElement.onclick = null; // Prevent re-triggering while editing
        }

        // Ãœye detayÄ±nÄ± gizle ve listeye dÃ¶n
        window.hideMemberDetail = function() {
            const contentDiv = document.getElementById('member-detail-content');
            const memberListCard = document.getElementById('members-list-card');
            if (contentDiv) contentDiv.style.display = 'none';
            if (memberListCard) memberListCard.style.display = 'block';
        };
        
        // âœ… Sidebar dropdown toggle
        window.toggleDropdown = function(button) {
            button.classList.toggle('open');
            const dropdown = button.nextElementSibling;
            if (dropdown && dropdown.classList.contains('dropdown-content')) {
                dropdown.classList.toggle('show');
            }
            
            // Ok iÅŸaretini dÃ¶ndÃ¼r
            const arrow = button.querySelector('.dropdown-arrow');
            if (arrow) {
                if (button.classList.contains('open')) {
                    arrow.style.transform = 'rotate(180deg)';
                } else {
                    arrow.style.transform = 'rotate(0deg)';
                }
            }
        };
        
        function generatePeriodBasedAttendance(member, preReg, attendanceRecords) {
            if (!preReg || !preReg.paymentSchedule || preReg.paymentSchedule.length === 0) {
                // Aidat dÃ¶nemi yoksa eski gÃ¶rÃ¼nÃ¼mÃ¼ gÃ¶ster
                return `
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Grup</th>
                                    <th>Durum</th>
                                    <th>DevamsÄ±zlÄ±k Sebebi</th>
                                    <th>Ä°ÅŸlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${attendanceRecords.length === 0 ? `<tr><td colspan="5" class="empty-state">Bu Ã¼ye iÃ§in yoklama kaydÄ± bulunmuyor.</td></tr>` : 
                                attendanceRecords.map(record => {
                                    const group = groups.find(g => g.id === record.groupId);
                                    const statusClass = record.status === 'present' ? 'status-present' : 'status-absent';
                                    const statusText = record.status === 'present' ? 'KatÄ±ldÄ±' : 'KatÄ±lmadÄ±';
                                    const recordDate = new Date(record.date + 'T00:00:00');
                                    const formattedDate = recordDate.toLocaleDateString('tr-TR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                                    const reasonCell = record.status === 'absent'
                                        ? `<td class="editable-reason" onclick="editReason(this, '${record.id}')">${record.reason || '<i>Sebep Ekle</i>'}</td>`
                                        : `<td>-</td>`;
                                    const statusCell = `<td onclick="toggleAttendanceStatus('${record.id}', '${record.status}')" style="cursor:pointer;"><span class="status-badge ${statusClass}">${statusText}</span></td>`;
                                    return `
                                        <tr>
                                            <td class="editable-date">
                                                <span>${formattedDate}</span>
                                                <button class="btn-icon" onclick="editAttendanceDate(this, '${record.id}')">âœï¸</button>
                                            </td>
                                            <td>${group ? group.groupName : 'Bilinmiyor'}</td>
                                            ${statusCell}
                                            ${reasonCell}
                                            <td>
                                                <button class="btn-icon danger" onclick="deleteAttendanceRecord('${record.id}')">ğŸ—‘ï¸</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            // DÃ¶nemler iÃ§in HTML oluÅŸtur
            let periodsHtml = '';
            
            preReg.paymentSchedule.forEach((period, index) => {
                const periodStart = new Date(period.period.start + 'T00:00:00');
                const periodEnd = new Date(period.period.end + 'T00:00:00');
                const lessonCount = period.period.lessonCount || 'N/A';
                
                // Bu dÃ¶neme ait devamsÄ±zlÄ±k kayÄ±tlarÄ±nÄ± filtrele
                const periodAttendance = attendanceRecords.filter(record => {
                    const recordDate = new Date(record.date + 'T00:00:00');
                    return recordDate >= periodStart && recordDate <= periodEnd;
                }).sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const presentCount = periodAttendance.filter(r => r.status === 'present').length;
                const absentCount = periodAttendance.filter(r => r.status === 'absent').length;
                const attendanceRate = periodAttendance.length > 0 ? ((presentCount / periodAttendance.length) * 100).toFixed(0) : 0;
                
                periodsHtml += `
                    <div class="period-card" style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 5px solid var(--primary-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h3 style="margin: 0; color: var(--primary-color); font-size: 1.3em;">
                                    ğŸ“… ${period.paymentNumber}. DÃ¶nem
                                </h3>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 0.95em;">
                                    ${formatDate(period.period.start)} - ${formatDate(period.period.end)} 
                                    <span style="background: #e3f2fd; padding: 3px 10px; border-radius: 15px; margin-left: 10px; font-weight: bold;">
                                        ${lessonCount} Ders
                                    </span>
                                </p>
                            </div>
                            <div style="text-align: right;">
                                <div style="display: flex; gap: 15px; align-items: center;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.5em; font-weight: bold; color: var(--success-color);">${presentCount}</div>
                                        <div style="font-size: 0.8em; color: #666;">KatÄ±ldÄ±</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.5em; font-weight: bold; color: var(--danger-color);">${absentCount}</div>
                                        <div style="font-size: 0.8em; color: #666;">KatÄ±lmadÄ±</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1.5em; font-weight: bold; color: var(--info-color);">${attendanceRate}%</div>
                                        <div style="font-size: 0.8em; color: #666;">Oran</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${periodAttendance.length === 0 ? 
                            `<div style="text-align: center; padding: 30px; color: #999; background: white; border-radius: 8px;">
                                <p style="margin: 0; font-size: 1.1em;">ğŸ“ Bu dÃ¶nem iÃ§in henÃ¼z yoklama kaydÄ± bulunmuyor.</p>
                            </div>` 
                            : 
                            `<div class="table-container">
                                <table class="data-table" style="background: white;">
                                    <thead>
                                        <tr>
                                            <th>Tarih</th>
                                            <th>Grup</th>
                                            <th>Durum</th>
                                            <th>DevamsÄ±zlÄ±k Sebebi</th>
                                            <th>Ä°ÅŸlemler</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${periodAttendance.map(record => {
                                            const group = groups.find(g => g.id === record.groupId);
                                            const statusClass = record.status === 'present' ? 'status-present' : 'status-absent';
                                            const statusText = record.status === 'present' ? 'âœ… KatÄ±ldÄ±' : 'âŒ KatÄ±lmadÄ±';
                                            const recordDate = new Date(record.date + 'T00:00:00');
                                            const formattedDate = recordDate.toLocaleDateString('tr-TR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                                            const reasonCell = record.status === 'absent'
                                                ? `<td class="editable-reason" onclick="editReason(this, '${record.id}')">${record.reason || '<i style="color:#999;">Sebep Ekle</i>'}</td>`
                                                : `<td style="color:#999;">-</td>`;
                                            const statusCell = `<td onclick="toggleAttendanceStatus('${record.id}', '${record.status}')" style="cursor:pointer;"><span class="status-badge ${statusClass}">${statusText}</span></td>`;
                                            return `
                                                <tr>
                                                    <td class="editable-date">
                                                        <span>${formattedDate}</span>
                                                        <button class="btn-icon" onclick="editAttendanceDate(this, '${record.id}')">âœï¸</button>
                                                    </td>
                                                    <td>${group ? group.groupName : 'Bilinmiyor'}</td>
                                                    ${statusCell}
                                                    ${reasonCell}
                                                    <td>
                                                        <button class="btn-icon danger" onclick="deleteAttendanceRecord('${record.id}')">ğŸ—‘ï¸</button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>`
                        }
                    </div>
                `;
            });
            
            if (periodsHtml === '') {
                return '<div class="empty-state"><p>Aidat dÃ¶nemi bilgisi bulunamadÄ±.</p></div>';
            }
            
            return periodsHtml;
        }

        async function showMemberAttendancePage(memberId) {
            showSection('members');
            const contentDiv = document.getElementById('member-detail-content');
            if (!contentDiv) {
                console.error('member-detail-content not found');
                return;
            }
            
            // Ãœye listesini gizle, detayÄ± gÃ¶ster
            const memberListCard = document.getElementById('members-list-card');
            if (memberListCard) memberListCard.style.display = 'none';
            contentDiv.style.display = 'block';
            contentDiv.innerHTML = `<div class="loading"><div class="spinner"></div><span>Ãœye verileri yÃ¼kleniyor...</span></div>`;

            const member = members.find(m => m.id === memberId);
            if (!member) {
                contentDiv.innerHTML = `<div class="card empty-state"><h3>Hata: Ãœye bulunamadÄ±.</h3></div>`;
                return;
            }
            
            const memberGroups = groups.filter(g => Array.isArray(g.memberIds) && g.memberIds.includes(member.id));
            const memberName = member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad;
            
            // Update header to show member name
            const headerTitle = document.getElementById('header-title-members');
            if (headerTitle) headerTitle.textContent = `ğŸ‘¤ ${memberName}`;
            
            // Debug: Attendance kayÄ±tlarÄ±nÄ± kontrol et
            console.log('ğŸ” Attendance Debug:', {
                memberId: memberId,
                totalAttendanceRecords: attendanceRecords.length,
                memberAttendanceRecords: attendanceRecords.filter(r => r.memberId === memberId).length
            });
            
            const memberAttendanceRecords = attendanceRecords.filter(r => r.memberId === memberId).sort((a, b) => new Date(b.date) - new Date(a.date));

            const totalRecords = memberAttendanceRecords.length;
            const presentCount = memberAttendanceRecords.filter(r => r.status === 'present').length;
            const absentCount = totalRecords - presentCount;
            const attendanceRate = totalRecords > 0 ? ((presentCount / totalRecords) * 100).toFixed(1) : 0;
            const birthDate = member.studentBirthDate ? formatDate(member.studentBirthDate) : 'BelirtilmemiÅŸ';
            
            // âœ… Ãœyenin aidat bilgilerini al - sadece "TÃ¼m Ã–deme PlanÄ±nÄ± GÃ¶r" butonu iÃ§in kontrol
            const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
            let paymentInfoHtml = '';
            
            if (preReg && preReg.paymentSchedule && preReg.paymentSchedule.length > 0) {
                paymentInfoHtml = `
                    <div class="card" style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 class="card-title" style="margin: 0;">ğŸ’° Ã–deme Takvimi</h2>
                            <button class="btn btn-primary" onclick="event.stopPropagation(); window.viewPaymentPlan('${preReg.id}')">
                                ğŸ“‹ TÃ¼m Ã–deme PlanÄ±nÄ± GÃ¶r
                            </button>
                        </div>
                    </div>
                `;
            }
            
            let memberInfoHtml = '';
            const isChild = member.Resit_Olmayan_Adi_Soyadi && member.Resit_Olmayan_Adi_Soyadi.trim() !== '';

            if (isChild) {
                let veli2Html = '';
                if(member.Veli_2_Adi_Soyadi || member.Telefon_2) {
                    veli2Html = `
                        <div class="contact-card">
                            <div class="contact-card-header">Veli 2</div>
                            <div class="contact-card-body">
                                ${member.Veli_2_Adi_Soyadi ? `<p><strong>Ä°sim:</strong> <span>${member.Veli_2_Adi_Soyadi}</span></p>` : ''}
                                ${member.Telefon_2 ? `<p><strong>Telefon:</strong> <span>${formatPhoneDisplay(member.Telefon_2)}</span></p>` : ''}
                            </div>
                        </div>`;
                }

                memberInfoHtml = `
                <div class="member-info-container">
                    <div class="member-info-main">
                        <div class="detail-item"><strong>Ãœye AdÄ± SoyadÄ±:</strong> <span>${memberName}</span></div>
                        <div class="detail-item"><strong>DoÄŸum Tarihi:</strong> <span>${birthDate}</span></div>
                        <div class="detail-item"><strong>BranÅŸ:</strong> <span>${capitalize(member.Brans || 'Bilinmiyor')}</span></div>
                        <div class="detail-item"><strong>Gruplar:</strong> <span>${memberGroups.length > 0 ? memberGroups.map(g => g.groupName).join(', ') : 'AtanmamÄ±ÅŸ'}</span></div>
                    </div>
                    <div class="member-info-contact">
                        <h4>Veli Bilgileri</h4>
                        <div class="contact-card">
                            <div class="contact-card-header">Veli 1</div>
                            <div class="contact-card-body">
                                <p><strong>Ä°sim:</strong> <span>${member.Ad_Soyad || 'BelirtilmemiÅŸ'}</span></p>
                                <p><strong>Telefon:</strong> <span>${member.Telefon ? formatPhoneDisplay(member.Telefon) : 'BelirtilmemiÅŸ'}</span></p>
                            </div>
                        </div>
                        ${veli2Html}
                    </div>
                </div>
                `;
            } else { // Adult member
                 memberInfoHtml = `
                    <div class="member-details-grid">
                        <div class="detail-item"><strong>Ãœye AdÄ± SoyadÄ±:</strong> <span>${memberName}</span></div>
                        <div class="detail-item"><strong>Telefon:</strong> <span>${member.Telefon ? formatPhoneDisplay(member.Telefon) : 'BelirtilmemiÅŸ'}</span></div>
                        <div class="detail-item"><strong>DoÄŸum Tarihi:</strong> <span>${birthDate}</span></div>
                        <div class="detail-item"><strong>BranÅŸ:</strong> <span>${capitalize(member.Brans || 'Bilinmiyor')}</span></div>
                        <div class="detail-item"><strong>Gruplar:</strong> <span>${memberGroups.length > 0 ? memberGroups.map(g => g.groupName).join(', ') : 'AtanmamÄ±ÅŸ'}</span></div>
                    </div>
                 `;
            }


            const detailsHtml = `
                <button class="btn btn-secondary" onclick="hideMemberDetail()" style="margin-bottom: 15px;">
                    â† Ãœye Listesine DÃ¶n
                </button>
                
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 class="card-title" style="margin: 0;">Ãœye Bilgileri</h2>
                        <button class="btn btn-primary btn-sm" onclick="openMemberEditForm('${memberId}')">
                            âœï¸ Bilgileri DÃ¼zenle
                        </button>
                    </div>
                    ${memberInfoHtml}
                </div>

                ${paymentInfoHtml}

                <div class="stats-grid" style="margin-top: 20px;">
                    <div class="stat-card">
                        <div class="stat-number">${totalRecords}</div>
                        <div class="stat-label">Toplam Ders</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--success-color);">
                        <div class="stat-number" style="color: var(--success-color);">${presentCount}</div>
                        <div class="stat-label">KatÄ±ldÄ±ÄŸÄ± Ders</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--danger-color);">
                        <div class="stat-number" style="color: var(--danger-color);">${absentCount}</div>
                        <div class="stat-label">KatÄ±lmadÄ±ÄŸÄ± Ders</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--info-color);">
                        <div class="stat-number" style="color: var(--info-color);">${attendanceRate}%</div>
                        <div class="stat-label">KatÄ±lÄ±m OranÄ±</div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">Yoklama GeÃ§miÅŸi (DÃ¶nem DÃ¶nem)</h2>
                    ${generatePeriodBasedAttendance(member, preReg, memberAttendanceRecords)}
                </div>

                <div class="card">
                    <h2 class="card-title">ğŸ“ GÃ¶rÃ¼ÅŸme KayÄ±tlarÄ±</h2>
                    <div id="member-call-records-${memberId}">
                        <div class="loading"><div class="spinner"></div><span>GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ± yÃ¼kleniyor...</span></div>
                    </div>
                </div>
            `;
            
            contentDiv.innerHTML = detailsHtml;
            
            // GÃ¶rÃ¼ÅŸme kayÄ±tlarÄ±nÄ± yÃ¼kle
            const phoneNumber = member.Telefon || member.Telefon_2;
            if (phoneNumber) {
                await renderCallRecords(phoneNumber, `member-call-records-${memberId}`);
            } else {
                const callRecordsContainer = document.getElementById(`member-call-records-${memberId}`);
                if (callRecordsContainer) {
                    callRecordsContainer.innerHTML = '<p style="color: #999; padding: 15px;">Bu Ã¼ye iÃ§in telefon numarasÄ± bulunamadÄ±.</p>';
                }
            }
        }

        async function toggleAttendanceStatus(recordId, currentStatus) {
            const newStatus = currentStatus === 'present' ? 'absent' : 'present';
            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'attendance', recordId), { status: newStatus });
                
                const recordIndex = attendanceRecords.findIndex(rec => rec.id === recordId);
                if (recordIndex > -1) {
                    attendanceRecords[recordIndex].status = newStatus;
                     // Refresh the view for the specific member
                    showMemberAttendancePage(attendanceRecords[recordIndex].memberId);
                }
                showAlert('Yoklama durumu gÃ¼ncellendi.', 'success');
            } catch (error) {
                 console.error("Error toggling attendance status:", error);
                 showAlert('Durum gÃ¼ncellenirken bir hata oluÅŸtu.', 'danger');
            }
        }
        
         function editAttendanceDate(buttonEl, recordId) {
            const dateCell = buttonEl.closest('.editable-date');
            const record = attendanceRecords.find(r => r.id === recordId);
            if (!record) return;

            dateCell.innerHTML = `<input type="date" class="form-control" value="${record.date}" onblur="saveAttendanceDate(this, '${record.id}')" onkeypress="if(event.key === 'Enter') this.blur()" autofocus>`;
            dateCell.querySelector('input').focus();
        }

        async function saveAttendanceDate(inputEl, recordId) {
            const newDate = inputEl.value;
            const record = attendanceRecords.find(r => r.id === recordId);
            if (!record || !newDate) {
                if(record) showMemberAttendancePage(record.memberId); // Re-render to cancel edit
                return;
            }

            try {
                await window.firebase.updateDoc(window.firebase.doc(window.db, 'attendance', recordId), { date: newDate });
                
                record.date = newDate; // Update local data
                
                showAlert('Yoklama tarihi gÃ¼ncellendi.', 'success');
                showMemberAttendancePage(record.memberId); // Refresh view
            } catch (error) {
                console.error("Error updating attendance date:", error);
                showAlert('Tarih gÃ¼ncellenirken bir hata oluÅŸtu.', 'danger');
                if(record) showMemberAttendancePage(record.memberId); // Re-render on error
            }
        }

        function toggleActionsMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('context-menu');
            const button = event.currentTarget;
            const type = button.dataset.type;
            const memberId = button.dataset.memberId;
            const preRegId = button.dataset.preregId;

            if (type === 'prereg' && !preRegId) {
                return showAlert('Bu kaydÄ±n iliÅŸkili Ã¶n kayÄ±t verisi bulunamadÄ±. LÃ¼tfen kontrol ediniz.', 'danger');
            }

            const isAlreadyOpen = menu.classList.contains('active');
            const currentActiveId = menu.dataset.activeButtonId;
            const newId = memberId || preRegId;

            // First, always hide the menu to simplify logic
            menu.classList.remove('active');

            // If we clicked the same button that the menu was open for, we're done.
            if (isAlreadyOpen && currentActiveId === newId) {
                return;
            }

            // --- Populate Menu Content ---
            let menuHtml = '';
            if (type === 'prereg') {
                let paymentLink = '';
                if (currentUser?.permissions?.view_payments) {
                    paymentLink = `<a href="#" onclick="viewPaymentPlan('${preRegId}')">ğŸ’° Ã–deme PlanÄ± GÃ¶rÃ¼ntÃ¼le</a>`;
                }
                menuHtml = `${paymentLink}<a href="#" onclick="openPreRegEditModal('${preRegId}')">âœï¸ KaydÄ± DÃ¼zenle</a><a href="#" class="danger" onclick="deleteItem('preRegistrations', '${preRegId}')">ğŸ—‘ï¸ KaydÄ± Sil</a>`;
            } else if (type === 'member') {
                menuHtml = `<a href="#" onclick="viewMemberPayments('${memberId}')">ğŸ’° Ã–deme PlanÄ± GÃ¶rÃ¼ntÃ¼le</a><a href="#" onclick="assignToGroup('${memberId}', null)">ğŸ”„ Gruba Ata/TaÅŸÄ±</a><a href="#" onclick="openMemberEditForm('${memberId}')">âœï¸ Bilgileri DÃ¼zenle</a><a href="#" class="danger" onclick="deleteItem('members', '${memberId}')">ğŸ—‘ï¸ Ãœyeyi Sil</a>`;
            }
            menu.innerHTML = menuHtml;
            document.body.appendChild(menu); // Append to body to avoid clipping issues
            
            const rect = button.getBoundingClientRect();

            // Position menu relative to the viewport
            menu.style.top = `${rect.bottom + window.scrollY + 5}px`;
            
            const menuWidth = menu.offsetWidth;
            const clientWidth = document.documentElement.clientWidth;

            if (rect.left + menuWidth > clientWidth - 10) {
                 menu.style.left = 'auto';
                 menu.style.right = `${clientWidth - rect.right}px`;
            } else {
                 menu.style.left = `${rect.left}px`;
                 menu.style.right = 'auto';
            }

            menu.classList.add('active');
            menu.dataset.activeButtonId = newId;
        }


        function closeAllMenus(event) {
            const contextMenu = document.getElementById('context-menu');
            if (contextMenu && !event.target.closest('.actions-toggle')) {
                contextMenu.classList.remove('active');
            }
            
            const phoneMenu = document.getElementById('phone-context-menu');
            if (phoneMenu && !event.target.closest('.phone-link')) {
                phoneMenu.style.display = 'none';
            }
        }

        function handlePhoneClick(event, phone) {
            event.preventDefault();
            event.stopPropagation();
            if (!phone) return;

            // Close other menus first
            const contextMenu = document.getElementById('context-menu');
            if(contextMenu) {
                contextMenu.classList.remove('active');
            }

            const menu = document.getElementById('phone-context-menu');
            const copyBtn = document.getElementById('phone-copy-btn');
            const callBtn = document.getElementById('phone-call-btn');

            copyBtn.onclick = (e) => {
                e.stopPropagation();
                const tempInput = document.createElement("textarea");
                tempInput.value = phone;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand('copy');
                    showAlert('Telefon numarasÄ± kopyalandÄ±!', 'success');
                } catch (err) {
                     showAlert('KopyalanamadÄ±.', 'danger');
                }
                document.body.removeChild(tempInput);
                menu.style.display = 'none';
            };
            callBtn.onclick = (e) => {
                e.stopPropagation();
                window.location.href = `tel:${phone}`;
                menu.style.display = 'none';
            };

            const rect = event.target.getBoundingClientRect();
            menu.style.top = `${rect.bottom + 5}px`;
            menu.style.left = `${rect.left}px`;
            menu.style.display = 'block';
        }
        
        function toggleReasonInput(checkbox, memberId) {
            const reasonInput = document.querySelector(`input[name="reason_${memberId}"]`);
            reasonInput.style.display = checkbox.checked ? 'none' : 'block';
        }
        
        function changeMembersPage(direction) {
            membersCurrentPage += direction;
            renderMembersTable();
        }

        function changeMembersItemsPerPage(selectElement) {
            membersItemsPerPage = parseInt(selectElement.value, 10);
            membersCurrentPage = 1;
            renderMembersTable();
        }

        function promptMoveOrAdd(memberId, newGroupId) {
            const member = members.find(m => m.id === memberId);
            const newGroup = groups.find(g => g.id === newGroupId);
            if (!member || !newGroup) return;

            const memberGroups = groups.filter(g => Array.isArray(g.members) && g.members.includes(memberId));

            if (memberGroups.length === 0) {
                // Member is in no groups, so just add them without asking.
                confirmGroupAssignment(memberId, newGroupId, false);
                return;
            }

            const modal = document.getElementById('choiceModal');
            modal.querySelector('#choiceTitle').textContent = 'Gruba Ekleme YÃ¶ntemi';
            modal.querySelector('#choiceText').textContent = `"${member.Resit_Olmayan_Adi_Soyadi || member.Ad_Soyad}" adlÄ± Ã¼yeyi "${newGroup.groupName}" grubuna nasÄ±l eklemek istersiniz?`;
            
            const buttonContainer = modal.querySelector('#choiceButtons');
            buttonContainer.innerHTML = `
                <button class="btn btn-primary" onclick="window.confirmGroupAssignment('${memberId}', '${newGroupId}', false); event.stopPropagation();" style="margin: 5px;">SADECE BU GRUBA EKLE</button>
                <button class="btn btn-warning" onclick="window.confirmGroupAssignment('${memberId}', '${newGroupId}', true); event.stopPropagation();" style="margin: 5px;">TAÅI (DÄ°ÄER GRUPLARDAN Ã‡IKAR)</button>
                <button class="btn btn-secondary" onclick="window.closeModal('choiceModal'); event.stopPropagation();" style="margin: 5px;">Ä°PTAL</button>
            `;
            
            openModal('choiceModal');
        }

        // --- Expose functions to global scope for onclick handlers ---
        window.showSection = showSection;
        window.setPaymentFilter = setPaymentFilter;
        window.filterScheduleByBranch = filterScheduleByBranch;
        window.filterGroupsByBranch = filterGroupsByBranch;
        window.openGroupModal = openGroupModal;
        window.closeModal = closeModal;
        window.deleteItem = deleteItem;
        window.updateMemberStatus = updateMemberStatus;
        window.viewPaymentPlan = viewPaymentPlan;
        window.openPreRegEditModal = openPreRegEditModal;
        window.openMemberEditModal = openMemberEditModal;
        window.assignToGroup = assignToGroup;
        window.viewMemberPayments = viewMemberPayments;
        window.togglePaymentDetails = togglePaymentDetails;
        window.openPaymentEditModal = openPaymentEditModal;
        window.drag = drag;
        window.allowDrop = allowDrop;
        window.drop = drop;
        window.openAttendanceModal = openAttendanceModal;
        window.deleteSchedule = deleteSchedule;
        window.removeMemberFromGroup = removeMemberFromGroup;
        window.confirmGroupAssignment = confirmGroupAssignment;
        window.openGroupEditModal = openGroupEditModal;
        window.navigateToSection = navigateToSection;
        window.showMemberAttendancePage = showMemberAttendancePage;
        window.toggleActionsMenu = toggleActionsMenu;
        window.handlePhoneClick = handlePhoneClick;
        window.toggleReasonInput = toggleReasonInput;
        window.sortMembersByAge = sortMembersByAge;
        window.editReason = editReason;
        window.saveReason = saveReason;
        window.changeMembersPage = changeMembersPage;
        window.changeMembersItemsPerPage = changeMembersItemsPerPage;
        window.deletePaymentFromSchedule = deletePaymentFromSchedule;
        window.recalculateSubsequentPayments = recalculateSubsequentPayments;
        window.toggleAttendanceStatus = toggleAttendanceStatus;
        window.openScheduleModalForGroup = openScheduleModalForGroup;
        window.handleTaskSubmit = handleTaskSubmit;
        window.openTaskEditModal = openTaskEditModal;
        window.openTaskMessagesModal = openTaskMessagesModal;
        window.deleteTaskMessage = deleteTaskMessage;
        window.openProfileEditModal = openProfileEditModal;
        window.deleteAttendanceRecord = deleteAttendanceRecord;
        window.editAttendanceDate = editAttendanceDate;
        window.saveAttendanceDate = saveAttendanceDate;
        window.promptMoveOrAdd = promptMoveOrAdd;
        window.renderAbsentStudents = renderAbsentStudents;
        window.selectAllPayments = selectAllPayments;
        window.markSelectedPaymentsAsPaid = markSelectedPaymentsAsPaid;
        window.deleteSelectedPayments = deleteSelectedPayments;
        window.switchSettingsTab = switchSettingsTab;
        window.showInstanceQR = showInstanceQR;
        window.restartInstance = restartInstance;
        window.deleteInstance = deleteInstance;
        window.checkConnectionStatus = checkConnectionStatus;
        
        // Dropdown toggle with event delegation (works in modals too)
        document.addEventListener('click', function(e) {
            // Toggle dropdown when clicking the button
            if (e.target.closest('.actions-dropdown-btn')) {
                e.stopPropagation();
                const btn = e.target.closest('.actions-dropdown-btn');
                const dropdown = btn.closest('.actions-dropdown');
                const wasActive = dropdown.classList.contains('active');
                
                // Close all other dropdowns
                document.querySelectorAll('.actions-dropdown.active').forEach(d => {
                    if (d !== dropdown) {
                        d.classList.remove('active');
                    }
                });
                
                // Toggle current dropdown
                if (!wasActive) {
                    dropdown.classList.add('active');
                    
                    // Position the dropdown menu
                    const dropdownContent = dropdown.querySelector('.actions-dropdown-content');
                    const btnRect = btn.getBoundingClientRect();
                    
                    // Position below the button, aligned to the right
                    dropdownContent.style.top = (btnRect.bottom + 5) + 'px';
                    dropdownContent.style.left = (btnRect.right - 180) + 'px'; // 180px is min-width
                    
                    // Check if it goes off screen bottom
                    const contentRect = dropdownContent.getBoundingClientRect();
                    if (contentRect.bottom > window.innerHeight) {
                        // Show above the button instead
                        dropdownContent.style.top = (btnRect.top - contentRect.height - 5) + 'px';
                    }
                    
                    // Check if it goes off screen left
                    if (contentRect.left < 0) {
                        dropdownContent.style.left = '10px';
                    }
                } else {
                    dropdown.classList.remove('active');
                }
                return;
            }
            
            // Handle clicks inside dropdown content
            if (e.target.closest('.actions-dropdown-content button')) {
                // Close dropdown after clicking a button
                setTimeout(() => {
                    document.querySelectorAll('.actions-dropdown.active').forEach(d => {
                        d.classList.remove('active');
                    });
                }, 100);
                return;
            }
            
            // Don't close if clicking inside dropdown content (but not a button)
            if (e.target.closest('.actions-dropdown-content')) {
                return;
            }
            
            // Close all dropdowns when clicking outside
            document.querySelectorAll('.actions-dropdown.active').forEach(d => {
                d.classList.remove('active');
            });
        });
        
        // Close dropdowns on scroll
        window.addEventListener('scroll', function() {
            document.querySelectorAll('.actions-dropdown.active').forEach(d => {
                d.classList.remove('active');
            });
        }, true);
        
        // Debug tool for checking payment info by phone
        window.debugPaymentInfo = function(phone) {
            console.log('=== Ã–DEME BÄ°LGÄ°SÄ° KONTROL ===');
            console.log('Aranan Telefon:', phone);
            
            // Normalize phone
            let normalizedPhone = phone.replace(/\s/g, '').replace(/\D/g, '');
            if (normalizedPhone.startsWith('0')) {
                normalizedPhone = normalizedPhone.substring(1);
            }
            const phoneFormats = [phone, '0' + normalizedPhone, '90' + normalizedPhone, normalizedPhone];
            
            console.log('Denenen Formatlar:', phoneFormats);
            
            // Find member
            const member = members.find(m => phoneFormats.includes(m.Telefon));
            if (!member) {
                console.error('âŒ Ãœye bulunamadÄ±!');
                return;
            }
            
            console.log('âœ… Ãœye Bulundu:', member.Ad_Soyad, member.Resit_Olmayan_Adi_Soyadi);
            console.log('Ãœye ID:', member.id);
            console.log('PreRegistration ID:', member.preRegistrationId);
            console.log('Telefon:', member.Telefon);
            
            // Find preRegistration by ID
            let preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
            
            if (!preReg) {
                console.warn('âš ï¸ PreRegistration ID ile bulunamadÄ±, telefon ile aranÄ±yor...');
                preReg = preRegistrations.find(p => phoneFormats.includes(p.phone));
            }
            
            if (!preReg) {
                console.error('âŒ Ã–deme planÄ± bulunamadÄ±!');
                console.log('TÃ¼m PreRegistrations:', preRegistrations.map(p => ({ id: p.id, phone: p.phone })));
                return;
            }
            
            console.log('âœ… Ã–deme PlanÄ± Bulundu:');
            console.log('PreReg ID:', preReg.id);
            console.log('PreReg Telefon:', preReg.phone);
            console.log('BranÅŸ:', preReg.branch);
            console.log('DÃ¶nem:', formatDate(preReg.periodStart), '-', formatDate(preReg.periodEnd));
            console.log('\n=== Ã–DEME PLANI ===');
            
            if (preReg.paymentSchedule && preReg.paymentSchedule.length > 0) {
                console.table(preReg.paymentSchedule.map(p => ({
                    'Taksit': p.paymentNumber,
                    'Tutar': p.amount + ' â‚º',
                    'DÃ¶nem BaÅŸlangÄ±Ã§': formatDate(p.period?.start),
                    'DÃ¶nem BitiÅŸ': formatDate(p.period?.end),
                    'Ders SayÄ±sÄ±': p.period?.lessonCount || 'YOK',
                    'Son Ã–deme': formatDate(p.dueDate),
                    'Durum': p.status,
                    'Ã–deme Tarihi': p.paymentDate ? formatDate(p.paymentDate) : '-'
                })));
            } else {
                console.log('âŒ Ã–deme planÄ± boÅŸ!');
            }
            
            return { member, preReg };
        };
        
        window.manualCheckConnection = async function(instanceName, deviceId) {
            showAlert('ğŸ” BaÄŸlantÄ± kontrol ediliyor...', 'info');
            
            const isConnected = await checkConnectionStatus(instanceName, deviceId);
            
            if (isConnected) {
                showAlert('âœ… WhatsApp baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±! Cihaz kullanÄ±ma hazÄ±r.', 'success');
                loadWhatsAppInstances();
            } else {
                showAlert('âš ï¸ Cihaz henÃ¼z baÄŸlanmadÄ±. QR kodu okuttuÄŸunuzdan emin olun.', 'warning');
            }
        };
        
        window.sendTestWhatsAppMessage = async function(event) {
            event.preventDefault();
            
            const form = event.target;
            const instanceName = form.testMessageDevice.value;
            const phone = form.testMessagePhone.value.trim();
            const message = form.testMessageText.value.trim();
            
            console.log('Test mesajÄ± gÃ¶nderiliyor:', { instanceName, phone, message });
            
            if (!phone || !message) {
                return showAlert('LÃ¼tfen telefon ve mesaj alanlarÄ±nÄ± doldurun.', 'warning');
            }
            
            if (!instanceName || instanceName === '') {
                return showAlert('LÃ¼tfen bir WhatsApp cihazÄ± seÃ§in. Ã–nce cihaz baÄŸlayÄ±n.', 'warning');
            }
            
            // Check if device exists and is connected
            const device = whatsappDevices.find(d => d.instanceName === instanceName);
            if (!device) {
                return showAlert('SeÃ§ilen cihaz bulunamadÄ±. LÃ¼tfen sayfayÄ± yenileyin.', 'danger');
            }
            
            if (device.status !== 'connected') {
                return showAlert(`Cihaz baÄŸlÄ± deÄŸil! Durum: ${device.status}. LÃ¼tfen QR kodu okutun.`, 'warning');
            }
            
            // Show loading
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'â³ GÃ¶nderiliyor...';
            
            try {
                // Format phone number for WhatsApp (remove leading 0 if exists, add @s.whatsapp.net)
                let formattedPhone = phone.replace(/\D/g, ''); // Remove non-digits
                if (formattedPhone.startsWith('0')) {
                    formattedPhone = formattedPhone.substring(1); // Remove leading 0
                }
                if (!formattedPhone.startsWith('90')) {
                    formattedPhone = '90' + formattedPhone; // Add country code if missing
                }
                
                const apiUrl = `${EVOLUTION_API_URL}/message/sendText/${instanceName}`;
                const requestBody = {
                    number: `${formattedPhone}@s.whatsapp.net`,
                    text: message
                };
                
                console.log('API Ä°steÄŸi:', {
                    url: apiUrl,
                    body: requestBody,
                    device: device
                });
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': EVOLUTION_API_KEY
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('API YanÄ±tÄ± - Status:', response.status, 'OK:', response.ok);
                
                const data = await response.json().catch(err => {
                    console.error('JSON parse hatasÄ±:', err);
                    return null;
                });
                
                console.log('API YanÄ±t Data:', data);
                
                if (response.ok) {
                    showAlert('âœ… Mesaj baÅŸarÄ±yla gÃ¶nderildi!', 'success');
                    form.testMessageText.value = '';
                } else {
                    console.error('Mesaj gÃ¶nderme hatasÄ±:', { 
                        status: response.status, 
                        statusText: response.statusText,
                        data: data 
                    });
                    
                    let errorMsg = 'Bilinmeyen hata';
                    if (response.status === 500) {
                        errorMsg = 'Sunucu hatasÄ±. Instance adÄ±nÄ± kontrol edin veya cihazÄ± yeniden baÅŸlatÄ±n.';
                        if (data && data.message) {
                            errorMsg += ` Detay: ${data.message}`;
                        }
                    } else if (response.status === 404) {
                        errorMsg = 'Instance bulunamadÄ±. Cihaz adÄ±nÄ± kontrol edin.';
                    } else if (response.status === 401) {
                        errorMsg = 'API Key hatasÄ±. Yetkisiz eriÅŸim.';
                    } else if (data) {
                        errorMsg = data.message || data.error || `HTTP ${response.status}`;
                    }
                    showAlert(`âŒ Mesaj gÃ¶nderilemedi: ${errorMsg}`, 'danger');
                }
            } catch (error) {
                console.error('Mesaj gÃ¶nderme exception:', error);
                showAlert(`âŒ Mesaj gÃ¶nderilirken hata oluÅŸtu: ${error.message}`, 'danger');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        };

        // =====================================================
        // ğŸ“¥ BULK IMPORT FUNCTIONS
        // =====================================================
        
        let importData = []; // Parse edilen veriler
        let validImportRecords = []; // GeÃ§erli kayÄ±tlar
        
        // Modal aÃ§ma/kapama
        window.openBulkImportModal = function() {
            document.getElementById('bulkImportModal').style.display = 'flex';
            resetImportSteps();
        };
        
        window.closeBulkImportModal = function() {
            document.getElementById('bulkImportModal').style.display = 'none';
            resetImportSteps();
            importData = [];
            validImportRecords = [];
            document.getElementById('csvFileInput').value = '';
        };
        
        function resetImportSteps() {
            document.getElementById('import-step-1').style.display = 'block';
            document.getElementById('import-step-2').style.display = 'none';
            document.getElementById('import-step-3').style.display = 'none';
            document.getElementById('import-step-4').style.display = 'none';
        }
        
        // Åablon indirme - Excel formatÄ±nda dropdown menÃ¼ler ile
        window.downloadImportTemplate = function() {
            if (typeof XLSX === 'undefined') {
                showAlert('âŒ Excel kÃ¼tÃ¼phanesi yÃ¼klenemedi. LÃ¼tfen sayfayÄ± yenileyin.', 'danger');
                return;
            }
            
            // BranÅŸ listesi
            const branchNames = branches.map(b => b.name);
            
            // Etiket listesi (branÅŸ etiketleri hariÃ§)
            const tagNames = crmTags
                .filter(tag => tag.category !== 'branch')
                .map(tag => tag.name);
            
            // Kaynak listesi
            const sources = ['Telefon', 'WhatsApp', 'Sosyal Medya', 'Referans', 'Web Sitesi', 'DiÄŸer'];
            
            // YaÅŸ grubu listesi
            const ageGroups = ['YetiÅŸkin', 'Ã‡ocuk'];
            
            // Excel workbook oluÅŸtur
            const wb = XLSX.utils.book_new();
            
            // Ana veri sayfasÄ±
            const mainSheet = [
                ['Telefon', 'Ad Soyad', 'Kaynak', 'BranÅŸ', 'YaÅŸ Grubu', 'Etiket', 'Veli AdÄ± (Ã‡ocuk iÃ§in)', 'Ã‡ocuk AdÄ±', 'Ã‡ocuk YaÅŸÄ±', 'Not'],
                ['05321234567', 'Ahmet YÄ±lmaz', 'Telefon', branchNames[0] || 'Tenis', 'YetiÅŸkin', tagNames[0] || 'AranmadÄ±', '', '', '', 'Ä°lk gÃ¶rÃ¼ÅŸme yapÄ±ldÄ±'],
                ['05439876543', '', 'WhatsApp', branchNames[0] || 'Tenis', 'Ã‡ocuk', 'Denemeye Gelecek', 'AyÅŸe Demir', 'Zeynep Demir', '8', 'Cumartesi deneme dersi'],
                ['05551234567', 'Mehmet Kaya', 'Sosyal Medya', branchNames[0] || 'Voleybol', 'YetiÅŸkin', 'AranmadÄ±', '', '', '', 'Fiyat bilgisi verildi'],
                ['05449876543', '', 'Telefon', branchNames[0] || 'Tenis', 'Ã‡ocuk', 'KayÄ±t Olabilir', 'Fatma Åahin', 'Ali Åahin', '10', '2 Ã§ocuk var'],
                ['05505123456', 'Hakan YÄ±ldÄ±z', 'Referans', branchNames[0] || 'Tenis', 'YetiÅŸkin', 'AranmadÄ±', '', '', '', 'BaÅŸlangÄ±Ã§ seviyesi']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(mainSheet);
            
            // SÃ¼tun geniÅŸlikleri
            ws['!cols'] = [
                {wch: 12}, // Telefon
                {wch: 18}, // Ad Soyad
                {wch: 15}, // Kaynak
                {wch: 15}, // BranÅŸ
                {wch: 12}, // YaÅŸ Grubu
                {wch: 18}, // Etiket
                {wch: 18}, // Veli AdÄ±
                {wch: 18}, // Ã‡ocuk AdÄ±
                {wch: 10}, // Ã‡ocuk YaÅŸÄ±
                {wch: 25}  // Not
            ];
            
            // Dropdown validasyonlarÄ± ekle - TÃ¼m aralÄ±k iÃ§in tek seferde
            ws['!dataValidation'] = [];
            
            // Kaynak dropdown (C2:C1000)
            ws['!dataValidation'].push({
                type: 'list',
                allowBlank: true,
                sqref: 'C2:C1000',
                formulas: [sources.join(',')]
            });
            
            // BranÅŸ dropdown (D2:D1000) - BranÅŸlar sayfasÄ±ndan referans
            if (branchNames.length > 0) {
                ws['!dataValidation'].push({
                    type: 'list',
                    allowBlank: false,
                    sqref: 'D2:D1000',
                    formulas: [branchNames.join(',')]
                });
            }
            
            // YaÅŸ Grubu dropdown (E2:E1000)
            ws['!dataValidation'].push({
                type: 'list',
                allowBlank: false,
                sqref: 'E2:E1000',
                formulas: [ageGroups.join(',')]
            });
            
            // Etiket dropdown (F2:F1000) - Etiketler sayfasÄ±ndan referans
            if (tagNames.length > 0) {
                ws['!dataValidation'].push({
                    type: 'list',
                    allowBlank: false,
                    sqref: 'F2:F1000',
                    formulas: [tagNames.join(',')]
                });
            }
            
            // Ana sayfayÄ± ekle
            XLSX.utils.book_append_sheet(wb, ws, 'MÃ¼ÅŸteriler');
            
            // YardÄ±mcÄ± sayfa - BranÅŸlar
            const branchSheet = [
                ['ğŸ“‹ Mevcut BranÅŸlar'],
                ...branchNames.map(name => [name])
            ];
            const wsBranch = XLSX.utils.aoa_to_sheet(branchSheet);
            XLSX.utils.book_append_sheet(wb, wsBranch, 'BranÅŸlar');
            
            // YardÄ±mcÄ± sayfa - Etiketler
            const tagSheet = [
                ['ğŸ·ï¸ Mevcut Etiketler'],
                ...tagNames.map(name => [name])
            ];
            const wsTag = XLSX.utils.aoa_to_sheet(tagSheet);
            XLSX.utils.book_append_sheet(wb, wsTag, 'Etiketler');
            
            // YardÄ±mcÄ± sayfa - Talimatlar
            const instructionsSheet = [
                ['ğŸ“– TOPLU MÃœÅTERÄ° EKLEME TALÄ°MATLARI'],
                [''],
                ['1. SÃœTUN AÃ‡IKLAMALARI:'],
                ['â€¢ Telefon: 05XX XXX XX XX formatÄ±nda (zorunlu)'],
                ['â€¢ Ad Soyad: YetiÅŸkin iÃ§in doldurulmalÄ±'],
                ['â€¢ Kaynak: MÃ¼ÅŸterinin nereden geldiÄŸi (BranÅŸlar sayfasÄ±ndan kopyala-yapÄ±ÅŸtÄ±r)'],
                ['â€¢ BranÅŸ: Ä°lgilendikleri branÅŸ (BranÅŸlar sayfasÄ±ndan kopyala-yapÄ±ÅŸtÄ±r - zorunlu)'],
                ['â€¢ YaÅŸ Grubu: "YetiÅŸkin" veya "Ã‡ocuk" (elle yazÄ±n - zorunlu)'],
                ['â€¢ Etiket: MÃ¼ÅŸterinin durumu (Etiketler sayfasÄ±ndan kopyala-yapÄ±ÅŸtÄ±r - zorunlu)'],
                ['â€¢ Veli AdÄ±: Sadece Ã§ocuk mÃ¼ÅŸteriler iÃ§in (zorunlu)'],
                ['â€¢ Ã‡ocuk AdÄ±: Sadece Ã§ocuk mÃ¼ÅŸteriler iÃ§in (zorunlu)'],
                ['â€¢ Ã‡ocuk YaÅŸÄ±: Ã‡ocuÄŸun yaÅŸÄ± (opsiyonel)'],
                ['â€¢ Not: Ek aÃ§Ä±klamalar (opsiyonel)'],
                [''],
                ['2. Ã–NEMLÄ° KURALLAR:'],
                ['âœ“ Telefon numarasÄ± benzersiz olmalÄ±'],
                ['âœ“ YetiÅŸkin seÃ§iliyse "Ad Soyad" doldurulmalÄ±'],
                ['âœ“ Ã‡ocuk seÃ§iliyse "Veli AdÄ±" ve "Ã‡ocuk AdÄ±" doldurulmalÄ±'],
                ['âœ“ BranÅŸ ve Etiket iÃ§in "BranÅŸlar" ve "Etiketler" sayfalarÄ±ndaki deÄŸerleri kullanÄ±n'],
                ['âœ“ YaÅŸ Grubu: "YetiÅŸkin" veya "Ã‡ocuk" (tam olarak bu ÅŸekilde yazÄ±n)'],
                [''],
                ['3. BRANÅ VE ETÄ°KET NASIL SEÃ‡Ä°LÄ°R?'],
                ['YÃ¶ntem 1 (Ã–nerilen):'],
                ['â€¢ "BranÅŸlar" veya "Etiketler" sekmesine git'],
                ['â€¢ Ä°stediÄŸin deÄŸeri kopyala (Ctrl+C)'],
                ['â€¢ "MÃ¼ÅŸteriler" sekmesindeki ilgili hÃ¼creye yapÄ±ÅŸtÄ±r (Ctrl+V)'],
                [''],
                ['YÃ¶ntem 2 (Manuel Dropdown):'],
                ['â€¢ Excel\'de hÃ¼creyi seÃ§ â†’ Veri â†’ Veri DoÄŸrulama'],
                ['â€¢ Liste seÃ§ â†’ Kaynak olarak "BranÅŸlar" veya "Etiketler" sayfasÄ±nÄ± referans et'],
                ['â€¢ Ã–rnek: =BranÅŸlar!$A$2:$A$10 (branÅŸlar iÃ§in)'],
                [''],
                ['4. Ã–RNEK VERÄ°LER:'],
                ['â€¢ Ã–rnek verileri inceleyip silebilir veya deÄŸiÅŸtirebilirsiniz'],
                ['â€¢ Yeni satÄ±rlar ekleyebilirsiniz'],
                ['â€¢ BranÅŸ/Etiket deÄŸerlerini kopyala-yapÄ±ÅŸtÄ±r ile ekleyin'],
                [''],
                ['5. DOSYA KAYDETME:'],
                ['â€¢ DosyayÄ± Excel formatÄ±nda (.xlsx) olarak kaydedin'],
                ['â€¢ CSV olarak kaydetmeyin'],
                [''],
                ['6. YÃœKLEME:'],
                ['â€¢ "Toplu Ä°Ã§e Aktar" bÃ¶lÃ¼mÃ¼nden dosyayÄ± yÃ¼kleyin'],
                ['â€¢ Sistem otomatik kontrol yapacak ve hatalarÄ± gÃ¶sterecek'],
                [''],
                ['âš ï¸ Ã–NEMLÄ° NOT:'],
                ['BranÅŸ ve Etiket isimlerini tam olarak "BranÅŸlar" ve "Etiketler"'],
                ['sayfalarÄ±ndaki gibi yazÄ±n. YazÄ±m hatasÄ± yaparsanÄ±z sistem'],
                ['bu kayÄ±tlarÄ± kabul etmez!']
            ];
            const wsInstructions = XLSX.utils.aoa_to_sheet(instructionsSheet);
            wsInstructions['!cols'] = [{wch: 70}];
            XLSX.utils.book_append_sheet(wb, wsInstructions, 'Talimatlar');
            
            // DosyayÄ± indir
            XLSX.writeFile(wb, 'CRM_Toplu_Musteri_Ekleme_Sablonu.xlsx');
            
            showAlert('âœ… Excel ÅŸablonu indirildi!\n\nğŸ“‹ "BranÅŸlar" ve "Etiketler" sekmelerinden deÄŸerleri kopyalayÄ±p "MÃ¼ÅŸteriler" sekmesine yapÄ±ÅŸtÄ±rÄ±n.\n\nâš ï¸ YazÄ±m hatasÄ± yapmamak iÃ§in mutlaka kopyala-yapÄ±ÅŸtÄ±r kullanÄ±n!', 'success');
        };
        
        // Dosya seÃ§me
        window.handleFileSelect = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('ğŸ“ Dosya seÃ§ildi:', file.name, file.type);
            
            try {
                if (file.name.endsWith('.csv')) {
                    await parseCSV(file);
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    await parseExcel(file);
                } else {
                    showAlert('âŒ Desteklenmeyen dosya formatÄ±! LÃ¼tfen CSV veya Excel dosyasÄ± yÃ¼kleyin.', 'danger');
                    return;
                }
            } catch (error) {
                console.error('Dosya parse hatasÄ±:', error);
                showAlert('âŒ Dosya okunurken hata oluÅŸtu: ' + error.message, 'danger');
            }
        };
        
        // Excel Parse (XLSX)
        async function parseExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        if (typeof XLSX === 'undefined') {
                            reject(new Error('Excel kÃ¼tÃ¼phanesi yÃ¼klenemedi'));
                            return;
                        }
                        
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Ä°lk sheet'i al (MÃ¼ÅŸteriler sayfasÄ±)
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // JSON'a Ã§evir (header: 1 ile array of arrays olarak al)
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        if (jsonData.length < 2) {
                            reject(new Error('Dosyada veri bulunamadÄ±'));
                            return;
                        }
                        
                        // Ä°lk satÄ±r baÅŸlÄ±k
                        const headers = jsonData[0];
                        
                        // Data satÄ±rlarÄ±
                        importData = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (!row || row.length === 0 || !row[0]) continue; // BoÅŸ satÄ±r
                            
                            const record = {
                                rowNumber: i,
                                phone: row[0] ? String(row[0]) : '',
                                fullName: row[1] ? String(row[1]) : '',
                                source: row[2] ? String(row[2]) : '',
                                branchName: row[3] ? String(row[3]) : '',
                                ageGroup: row[4] ? String(row[4]) : '',
                                tag: row[5] ? String(row[5]) : '',
                                parentName: row[6] ? String(row[6]) : '',
                                childName: row[7] ? String(row[7]) : '',
                                childAge: row[8] ? String(row[8]) : '',
                                note: row[9] ? String(row[9]) : ''
                            };
                            
                            importData.push(record);
                        }
                        
                        console.log('ğŸ“Š Excel\'den parse edilen kayÄ±t sayÄ±sÄ±:', importData.length);
                        
                        if (importData.length === 0) {
                            reject(new Error('Dosyada iÅŸlenebilir veri bulunamadÄ±'));
                            return;
                        }
                        
                        // Validation ve preview
                        validateAndPreview();
                        resolve();
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Dosya okunamadÄ±'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }
        
        // CSV Parse
        async function parseCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        const lines = text.split(/\r?\n/).filter(line => line.trim());
                        
                        if (lines.length < 2) {
                            reject(new Error('Dosya boÅŸ veya sadece baÅŸlÄ±k satÄ±rÄ± var'));
                            return;
                        }
                        
                        // Ä°lk satÄ±r header olmalÄ±
                        const headers = lines[0].split(',').map(h => h.trim());
                        console.log('ğŸ“‹ CSV Headers:', headers);
                        
                        // Data satÄ±rlarÄ±
                        importData = [];
                        for (let i = 1; i < lines.length; i++) {
                            const values = parseCSVLine(lines[i]);
                            if (values.length === 0) continue; // BoÅŸ satÄ±r
                            
                            const record = {
                                rowNumber: i,
                                phone: values[0] || '',
                                fullName: values[1] || '', // YetiÅŸkin iÃ§in
                                source: values[2] || '',
                                branchName: values[3] || '',
                                ageGroup: values[4] || '',
                                tag: values[5] || '',
                                parentName: values[6] || '', // Ã‡ocuk iÃ§in veli adÄ±
                                childName: values[7] || '', // Ã‡ocuk iÃ§in Ã§ocuk adÄ±
                                childAge: values[8] || '', // Ã‡ocuk iÃ§in yaÅŸ
                                note: values[9] || ''
                            };
                            
                            importData.push(record);
                        }
                        
                        console.log('ğŸ“Š Parse edilen kayÄ±t sayÄ±sÄ±:', importData.length);
                        
                        if (importData.length === 0) {
                            reject(new Error('Dosyada iÅŸlenebilir veri bulunamadÄ±'));
                            return;
                        }
                        
                        // Validation ve preview
                        validateAndPreview();
                        resolve();
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Dosya okunamadÄ±'));
                };
                
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // CSV satÄ±r parse (virgÃ¼l iÃ§indeki virgÃ¼lleri handle et)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }
        
        // Validation ve Preview
        function validateAndPreview() {
            validImportRecords = [];
            const invalidRecords = [];
            
            importData.forEach(record => {
                const errors = [];
                
                // Telefon kontrolÃ¼
                const cleanPhone = record.phone.replace(/\D/g, '');
                if (!cleanPhone || cleanPhone.length < 10) {
                    errors.push('GeÃ§ersiz telefon');
                } else {
                    // Telefon zaten kayÄ±tlÄ± mÄ±?
                    const existing = crmLeads.find(l => 
                        l.phone && phonesMatch(l.phone, cleanPhone)
                    );
                    if (existing) {
                        errors.push('Telefon kayÄ±tlÄ±');
                    }
                }
                
                // YaÅŸ grubuna gÃ¶re ad kontrolÃ¼
                const isChild = record.ageGroup && record.ageGroup.toLowerCase() === 'Ã§ocuk';
                if (isChild) {
                    // Ã‡ocuk ise: Veli AdÄ± ve Ã‡ocuk AdÄ± zorunlu
                    if (!record.parentName || record.parentName.trim().length < 2) {
                        errors.push('Veli AdÄ± eksik');
                    }
                    if (!record.childName || record.childName.trim().length < 2) {
                        errors.push('Ã‡ocuk AdÄ± eksik');
                    }
                } else {
                    // YetiÅŸkin ise: Ad Soyad zorunlu
                    if (!record.fullName || record.fullName.trim().length < 2) {
                        errors.push('Ad Soyad eksik');
                    }
                }
                
                // Kaynak kontrolÃ¼
                const validSources = ['telefon', 'whatsapp', 'sosyal medya', 'referans', 'web sitesi', 'diÄŸer'];
                if (!record.source || !validSources.includes(record.source.toLowerCase())) {
                    errors.push('GeÃ§ersiz kaynak');
                }
                
                // BranÅŸ kontrolÃ¼
                const branch = branches.find(b => 
                    b.name && record.branchName && 
                    b.name.toLowerCase().includes(record.branchName.toLowerCase())
                );
                if (!branch) {
                    errors.push('BranÅŸ bulunamadÄ±');
                }
                
                // YaÅŸ grubu kontrolÃ¼
                const validAgeGroups = ['yetiÅŸkin', 'Ã§ocuk'];
                if (!record.ageGroup || !validAgeGroups.includes(record.ageGroup.toLowerCase())) {
                    errors.push('GeÃ§ersiz yaÅŸ grubu');
                }
                
                record.errors = errors;
                record.isValid = errors.length === 0;
                record.cleanPhone = cleanPhone;
                record.branch = branch;
                
                if (record.isValid) {
                    validImportRecords.push(record);
                } else {
                    invalidRecords.push(record);
                }
            });
            
            // Preview'i gÃ¶ster
            renderImportPreview();
            
            // AdÄ±m 2'ye geÃ§
            document.getElementById('import-step-1').style.display = 'none';
            document.getElementById('import-step-2').style.display = 'block';
        }
        
        // Preview render
        function renderImportPreview() {
            const tbody = document.getElementById('import-preview-body');
            const summaryDiv = document.getElementById('import-summary');
            
            // Summary
            const totalCount = importData.length;
            const validCount = validImportRecords.length;
            const invalidCount = totalCount - validCount;
            
            summaryDiv.innerHTML = `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 600;">${totalCount}</div>
                    <div style="font-size: 12px; color: #666;">Toplam</div>
                </div>
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 600; color: #4caf50;">${validCount}</div>
                    <div style="font-size: 12px; color: #666;">GeÃ§erli</div>
                </div>
                <div style="background: #ffebee; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 600; color: #f44336;">${invalidCount}</div>
                    <div style="font-size: 12px; color: #666;">HatalÄ±</div>
                </div>
            `;
            
            document.getElementById('valid-count').textContent = validCount;
            
            // Tablo
            tbody.innerHTML = importData.map(record => {
                const statusColor = record.isValid ? '#4caf50' : '#f44336';
                const statusText = record.isValid ? 'âœ… GeÃ§erli' : 'âŒ ' + record.errors.join(', ');
                const rowStyle = record.isValid ? '' : 'background: #ffebee;';
                
                // Veli/Ã‡ocuk bilgisini gÃ¶ster
                const isChild = record.ageGroup && record.ageGroup.toLowerCase() === 'Ã§ocuk';
                let parentChildInfo = '-';
                if (isChild && (record.parentName || record.childName)) {
                    const parts = [];
                    if (record.parentName) parts.push(`Veli: ${record.parentName}`);
                    if (record.childName) parts.push(`Ã‡ocuk: ${record.childName}`);
                    if (record.childAge) parts.push(`YaÅŸ: ${record.childAge}`);
                    parentChildInfo = parts.join('<br>');
                }
                
                return `
                    <tr style="${rowStyle}">
                        <td>${record.rowNumber}</td>
                        <td>${record.phone}</td>
                        <td>${record.fullName || '-'}</td>
                        <td style="font-size: 11px;">${parentChildInfo}</td>
                        <td>${record.source}</td>
                        <td>${record.branchName}</td>
                        <td>${record.ageGroup}</td>
                        <td>${record.tag || '-'}</td>
                        <td style="color: ${statusColor}; font-size: 12px;">${statusText}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Toplu import onaylama
        window.confirmBulkImport = async function() {
            if (validImportRecords.length === 0) {
                showAlert('âŒ Eklenebilecek geÃ§erli kayÄ±t yok!', 'warning');
                return;
            }
            
            const confirmMsg = `${validImportRecords.length} mÃ¼ÅŸteri eklenecek. OnaylÄ±yor musunuz?`;
            if (!confirm(confirmMsg)) return;
            
            // Step 3'e geÃ§ (progress)
            document.getElementById('import-step-2').style.display = 'none';
            document.getElementById('import-step-3').style.display = 'block';
            
            await processBulkImport();
        };
        
        // Toplu import iÅŸleme
        async function processBulkImport() {
            const total = validImportRecords.length;
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            const progressBar = document.getElementById('import-progress-bar');
            const progressText = document.getElementById('import-progress-text');
            
            const now = new Date();
            const dateStr = now.toLocaleString('tr-TR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            const userName = currentUser.fullName || currentUser.email || 'Admin';
            
            for (let i = 0; i < validImportRecords.length; i++) {
                const record = validImportRecords[i];
                
                try {
                    // Kaynak mapping
                    const sourceMap = {
                        'telefon': 'phone',
                        'whatsapp': 'whatsapp',
                        'sosyal medya': 'social',
                        'referans': 'referral',
                        'web sitesi': 'website',
                        'diÄŸer': 'other'
                    };
                    const source = sourceMap[record.source.toLowerCase()] || 'other';
                    
                    // YaÅŸ grubu mapping
                    const ageGroup = record.ageGroup.toLowerCase() === 'yetiÅŸkin' ? 'adult' : 'child';
                    
                    // Lead verisi - Ã‡ocuk/YetiÅŸkin'e gÃ¶re branch oluÅŸtur
                    const branchData = {
                        branchId: record.branch.id,
                        branchName: record.branch.name,
                        ageGroup: ageGroup,
                        selectedTag: record.tag || '',
                        notesHistory: record.note ? [{
                            text: record.note,
                            by: userName,
                            date: dateStr
                        }] : [],
                        kayitOlabilirDate: null,
                        denemeDate: null
                    };
                    
                    if (ageGroup === 'adult') {
                        // YetiÅŸkin
                        branchData.fullName = record.fullName;
                        branchData.parentName = '';
                        branchData.children = [];
                    } else {
                        // Ã‡ocuk
                        branchData.fullName = '';
                        branchData.parentName = record.parentName || '';
                        branchData.children = [{
                            name: record.childName || '',
                            age: record.childAge || '',
                            selectedTag: record.tag || '',
                            kayitOlabilirDate: null,
                            denemeDate: null
                        }];
                    }
                    
                    const leadData = {
                        fullName: ageGroup === 'adult' ? record.fullName : record.parentName,
                        phone: record.cleanPhone,
                        source: source,
                        clubId: currentClubId,
                        createdAt: now.toISOString(),
                        createdBy: userName + ' (Toplu Import)',
                        status: 'new',
                        branches: [branchData],
                        history: [
                            {
                                action: 'created',
                                by: userName,
                                date: dateStr,
                                details: ageGroup === 'adult' 
                                    ? `Toplu import ile oluÅŸturuldu - ${record.fullName} (${record.cleanPhone})`
                                    : `Toplu import ile oluÅŸturuldu - Veli: ${record.parentName}, Ã‡ocuk: ${record.childName} (${record.cleanPhone})`
                            }
                        ]
                    };
                    
                    // Etiket varsa history'e ekle
                    if (record.tag) {
                        leadData.history.push({
                            action: 'tag_added',
                            by: userName,
                            date: dateStr,
                            details: `${record.branch.name} - Etiket: "${record.tag}"`
                        });
                    }
                    
                    // Firebase'e ekle
                    await window.firebase.addDoc(
                        window.firebase.collection(window.db, 'crmLeads'),
                        leadData
                    );
                    
                    successCount++;
                    
                } catch (error) {
                    console.error(`SatÄ±r ${record.rowNumber} import hatasÄ±:`, error);
                    errorCount++;
                    errors.push(`SatÄ±r ${record.rowNumber} (${record.fullName}): ${error.message}`);
                }
                
                // Progress gÃ¼ncelle
                const progress = ((i + 1) / total) * 100;
                progressBar.style.width = progress + '%';
                progressText.textContent = `${i + 1} / ${total}`;
                
                // Rate limiting
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            // Step 4'e geÃ§ (sonuÃ§)
            document.getElementById('import-step-3').style.display = 'none';
            document.getElementById('import-step-4').style.display = 'block';
            
            // SonuÃ§ gÃ¶ster
            const resultDiv = document.getElementById('import-result');
            resultDiv.innerHTML = `
                <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="font-size: 18px; font-weight: 600; color: #4caf50;">âœ… BaÅŸarÄ±lÄ±: ${successCount}</div>
                </div>
                ${errorCount > 0 ? `
                <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="font-size: 18px; font-weight: 600; color: #f44336;">âŒ HatalÄ±: ${errorCount}</div>
                    ${errors.length > 0 ? `
                    <div style="margin-top: 10px; font-size: 12px;">
                        <strong>Hatalar:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            ${errors.slice(0, 5).map(err => `<li>${err}</li>`).join('')}
                            ${errors.length > 5 ? `<li>... ve ${errors.length - 5} hata daha</li>` : ''}
                        </ul>
                    </div>
                    ` : ''}
                </div>
                ` : ''}
            `;
            
            // BaÅŸarÄ±lÄ± ise veriyi yeniden yÃ¼kle
            if (successCount > 0) {
                setTimeout(() => {
                    loadData(false); // Fresh data yÃ¼kle
                }, 2000);
            }
        }

        // ============================================
        // ğŸ“Š MUHASEBE (ACCOUNTING) FUNCTIONS
        // ============================================
        
        // Muhasebe Ã¶zetini yÃ¼kle
        window.renderAccountingSummary = async function() {
            console.log('ğŸ“Š Muhasebe Ã¶zeti yÃ¼kleniyor...');
            
            // BranÅŸ seÃ§eneklerini doldur
            populateBranchFilters();
            
            await Promise.all([
                loadExpenses(),
                loadProducts(),
                calculateSummary()
            ]);
        };
        
        // BranÅŸ filtrelerini doldur
        function populateBranchFilters() {
            const branchFilter = document.getElementById('summaryBranchFilter');
            if (!branchFilter) return;
            
            // EÄŸer zaten doldurulmuÅŸsa tekrar doldurma
            if (branchFilter.options.length > 1) return;
            
            // BranÅŸlarÄ± ekle
            branches.forEach(branch => {
                const option = document.createElement('option');
                option.value = branch.name;
                option.textContent = `${branch.icon || 'ğŸ¢'} ${branch.name}`;
                branchFilter.appendChild(option);
            });
        }
        
        // Ã–zet filtrelerini sÄ±fÄ±rla
        window.resetSummaryFilters = function() {
            const startDate = document.getElementById('summaryStartDate');
            const endDate = document.getElementById('summaryEndDate');
            const branchFilter = document.getElementById('summaryBranchFilter');
            
            if (startDate) startDate.value = '';
            if (endDate) endDate.value = '';
            if (branchFilter) {
                branchFilter.value = 'all';
                // BranÅŸ seÃ§eneklerini yeniden doldur
                branchFilter.innerHTML = '<option value="all">ğŸŒ TÃ¼m BranÅŸlar</option>';
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.name;
                    option.textContent = `${branch.icon || 'ğŸ¢'} ${branch.name}`;
                    branchFilter.appendChild(option);
                });
            }
            
            renderAccountingSummary();
        };
        
        // Giderleri yÃ¼kle
        async function loadExpenses() {
            const container = document.getElementById('expensesTableContainer');
            if (!container) return;
            
            try {
                const expensesRef = window.firebase.collection(window.db, 'expenses');
                // âœ… Index gerektirmeyen sorgu - sadece clubId
                const q = window.firebase.query(
                    expensesRef,
                    window.firebase.where('clubId', '==', currentClubId)
                );
                
                const snapshot = await window.firebase.getDocs(q);
                let expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Tarih filtrelerini uygula
                const startDateInput = document.getElementById('summaryStartDate');
                const endDateInput = document.getElementById('summaryEndDate');
                
                if (startDateInput && startDateInput.value) {
                    const startDate = new Date(startDateInput.value);
                    startDate.setHours(0, 0, 0, 0);
                    expenses = expenses.filter(exp => {
                        const expDate = new Date(exp.date);
                        return expDate >= startDate;
                    });
                }
                
                if (endDateInput && endDateInput.value) {
                    const endDate = new Date(endDateInput.value);
                    endDate.setHours(23, 59, 59, 999);
                    expenses = expenses.filter(exp => {
                        const expDate = new Date(exp.date);
                        return expDate <= endDate;
                    });
                }
                
                // Client-side sorting (index gerekmez)
                expenses.sort((a, b) => {
                    const dateA = new Date(a.date || 0);
                    const dateB = new Date(b.date || 0);
                    return dateB - dateA; // En yeni en Ã¼stte
                });
                
                // Ä°lk 50 kayÄ±t
                expenses = expenses.slice(0, 50);
                
                if (expenses.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>HenÃ¼z gider kaydÄ± yok</p></div>';
                    return;
                }
                
                container.innerHTML = `
                    <div style="overflow-x: auto;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Kategori</th>
                                    <th>BranÅŸ</th>
                                    <th>AÃ§Ä±klama</th>
                                    <th>Tutar</th>
                                    <th>Ä°ÅŸlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${expenses.map(expense => `
                                    <tr>
                                        <td>${new Date(expense.date).toLocaleDateString('tr-TR')}</td>
                                        <td>${expense.category || 'Genel'}</td>
                                        <td><span style="background: #e3f2fd; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${expense.branch || 'Genel'}</span></td>
                                        <td>${expense.description || '-'}</td>
                                        <td style="font-weight: bold; color: #f44336;">${expense.amount || 0} â‚º</td>
                                        <td>
                                            <button class="btn btn-sm btn-danger" onclick="deleteExpense('${expense.id}')">
                                                ğŸ—‘ï¸ Sil
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Giderler yÃ¼klenirken hata:', error);
                container.innerHTML = '<div class="empty-state"><p style="color: #f44336;">âŒ Giderler yÃ¼klenemedi</p></div>';
            }
        }
        
        // ÃœrÃ¼nleri yÃ¼kle
        async function loadProducts() {
            const container = document.getElementById('productsTableContainer');
            if (!container) return;
            
            try {
                const productsRef = window.firebase.collection(window.db, 'products');
                // âœ… Index gerektirmeyen sorgu - sadece clubId
                const q = window.firebase.query(
                    productsRef,
                    window.firebase.where('clubId', '==', currentClubId)
                );
                
                const snapshot = await window.firebase.getDocs(q);
                let products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Client-side sorting (index gerekmez)
                products.sort((a, b) => {
                    const dateA = new Date(a.createdAt || 0);
                    const dateB = new Date(b.createdAt || 0);
                    return dateB - dateA; // En yeni en Ã¼stte
                });
                
                if (products.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>HenÃ¼z Ã¼rÃ¼n kaydÄ± yok</p></div>';
                    return;
                }
                
                container.innerHTML = `
                    <div style="overflow-x: auto;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ÃœrÃ¼n AdÄ±</th>
                                    <th>Kategori</th>
                                    <th>BranÅŸ</th>
                                    <th>Fiyat</th>
                                    <th>Stok</th>
                                    <th>Ä°ÅŸlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${products.map(product => `
                                    <tr>
                                        <td style="font-weight: 600;">${product.name || '-'}</td>
                                        <td>${product.category || 'Genel'}</td>
                                        <td><span style="background: #e8f5e9; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${product.branch || 'Genel'}</span></td>
                                        <td style="font-weight: bold; color: #4caf50;">${product.price || 0} â‚º</td>
                                        <td>${product.stock !== undefined ? product.stock : '-'}</td>
                                        <td>
                                            <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product.id}')">
                                                ğŸ—‘ï¸ Sil
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('ÃœrÃ¼nler yÃ¼klenirken hata:', error);
                container.innerHTML = '<div class="empty-state"><p style="color: #f44336;">âŒ ÃœrÃ¼nler yÃ¼klenemedi</p></div>';
            }
        }
        
        // Ã–zet hesapla
        async function calculateSummary() {
            try {
                // Tarih filtrelerini kontrol et
                const startDateInput = document.getElementById('summaryStartDate');
                const endDateInput = document.getElementById('summaryEndDate');
                const branchFilterInput = document.getElementById('summaryBranchFilter');
                
                let startOfMonth, endOfMonth;
                
                if (startDateInput && startDateInput.value) {
                    startOfMonth = new Date(startDateInput.value);
                    startOfMonth.setHours(0, 0, 0, 0);
                } else {
                    const now = new Date();
                    startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                }
                
                if (endDateInput && endDateInput.value) {
                    endOfMonth = new Date(endDateInput.value);
                    endOfMonth.setHours(23, 59, 59, 999);
                } else {
                    const now = new Date();
                    endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                }
                
                const selectedBranch = branchFilterInput ? branchFilterInput.value : 'all';
                
                console.log('ğŸ“Š Ã–zet hesaplanÄ±yor...', { startOfMonth, endOfMonth, selectedBranch });
                
                // Giderleri hesapla (index gerektirmeyen sorgu)
                let totalExpense = 0;
                try {
                    const expensesRef = window.firebase.collection(window.db, 'expenses');
                    // âœ… Sadece clubId ile sorgula, tarih filtresini client-side yap
                    const expensesQuery = window.firebase.query(
                        expensesRef,
                        window.firebase.where('clubId', '==', currentClubId)
                    );
                    
                    const expensesSnapshot = await window.firebase.getDocs(expensesQuery);
                    
                    // Client-side filtering - tarih ve branÅŸ filtreleri
                    totalExpense = expensesSnapshot.docs.reduce((sum, doc) => {
                        const expense = doc.data();
                        const expenseDate = new Date(expense.date);
                        
                        // Tarih filtresi
                        if (expenseDate >= startOfMonth && expenseDate <= endOfMonth) {
                            // BranÅŸ filtresi (eÄŸer seÃ§ilmiÅŸse)
                            if (selectedBranch === 'all' || expense.branch === selectedBranch || (!expense.branch && selectedBranch === 'all')) {
                                return sum + (expense.amount || 0);
                            }
                        }
                        return sum;
                    }, 0);
                    
                    console.log('ğŸ’¸ Toplam gider:', totalExpense, 'BranÅŸ:', selectedBranch);
                } catch (error) {
                    console.error('Gider hesaplama hatasÄ±:', error);
                }
                
                // Gelirleri hesapla (preRegistrations'dan paymentSchedule Ã¼zerinden)
                let totalIncome = 0;
                try {
                    // Ã–demeler preRegistrations iÃ§inde paymentSchedule array'inde tutuluyor
                    let monthlyPaymentCount = 0;
                    
                    console.log('ğŸ“Š PreRegistrations Ã¼zerinden Ã¶demeler kontrol ediliyor...', preRegistrations.length, 'kayÄ±t');
                    
                    // Sadece aktif/pending ve preReg'i olan Ã¼yelerin Ã¶demelerini say
                    const activeMembers = members.filter(m => {
                        if (m.status !== 'active' && m.status !== 'pending') return false;
                        if (!m.preRegistrationId) return false;
                        const preReg = preRegistrations.find(p => p.id === m.preRegistrationId);
                        return preReg && preReg.paymentSchedule && preReg.paymentSchedule.length > 0;
                    });
                    
                    activeMembers.forEach(member => {
                        const preReg = preRegistrations.find(p => p.id === member.preRegistrationId);
                        if (!preReg || !preReg.paymentSchedule) return;
                        
                        // BranÅŸ kontrolÃ¼
                        const preRegBranch = preReg.branch;
                        if (selectedBranch !== 'all' && preRegBranch !== selectedBranch) {
                            return;
                        }
                        
                        // Her preReg'in paymentSchedule'Ä±nÄ± kontrol et
                        preReg.paymentSchedule.forEach(payment => {
                            // Sadece Ã¶denen taksitleri say
                            if (payment.status !== 'paid') return;
                            
                            // âœ… SADECE paymentDate varsa say (Ã¶deme tarihi olmayanlarÄ± sayma)
                            if (!payment.paymentDate) return;
                            
                            // Tarih parse etme
                            let paymentDateStr = payment.paymentDate;
                            if (paymentDateStr.length === 10 && paymentDateStr.includes('-')) {
                                paymentDateStr += 'T00:00:00';
                            }
                            const paymentDate = new Date(paymentDateStr);
                            
                            if (isNaN(paymentDate.getTime())) return;
                            
                            // Tarih filtresi
                            if (paymentDate >= startOfMonth && paymentDate <= endOfMonth) {
                                monthlyPaymentCount++;
                                const amount = parseFloat(payment.amount || 0);
                                totalIncome += amount;
                            }
                        });
                    });
                    
                    console.log('ğŸ’° [MUHASEBE SEKMESÄ°] Toplam gelir (aidatlardan):', totalIncome.toLocaleString('tr-TR') + 'â‚º', 'Ã–deme sayÄ±sÄ±:', monthlyPaymentCount, 'BranÅŸ:', selectedBranch);
                } catch (error) {
                    console.error('Gelir hesaplama hatasÄ±:', error);
                    console.error('Hata detayÄ±:', error.message, error.stack);
                }
                
                // ÃœrÃ¼n satÄ±ÅŸlarÄ±nÄ± hesapla (ÅŸimdilik 0, gelecekte eklenecek)
                const totalProductSales = 0;
                
                // Net kar/zarar
                const netProfit = totalIncome + totalProductSales - totalExpense;
                
                // UI'Ä± gÃ¼ncelle
                const totalIncomeEl = document.getElementById('totalIncome');
                const totalExpenseEl = document.getElementById('totalExpense');
                const netProfitEl = document.getElementById('netProfit');
                const totalProductSalesEl = document.getElementById('totalProductSales');
                
                if (totalIncomeEl) totalIncomeEl.textContent = formatPrice(totalIncome);
                if (totalExpenseEl) totalExpenseEl.textContent = formatPrice(totalExpense);
                if (netProfitEl) netProfitEl.textContent = formatPrice(netProfit);
                if (totalProductSalesEl) totalProductSalesEl.textContent = formatPrice(totalProductSales);
                
                // Net kar/zarar rengini ayarla
                if (netProfitEl) {
                    const netProfitElement = netProfitEl.parentElement;
                    if (netProfit >= 0) {
                        netProfitElement.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';
                    } else {
                        netProfitElement.style.background = 'linear-gradient(135deg, #f44336 0%, #e53935 100%)';
                    }
                }
            } catch (error) {
                console.error('Ã–zet hesaplanÄ±rken hata:', error);
            }
        }
        
        // Gider ekleme modalÄ± aÃ§
        window.openAddExpenseModal = function() {
            // BranÅŸ seÃ§eneklerini doldur
            const branchSelect = document.getElementById('expenseBranch');
            if (branchSelect) {
                // Ã–nce mevcut seÃ§enekleri temizle (Genel hariÃ§)
                branchSelect.innerHTML = '<option value="Genel">ğŸŒ Genel (TÃ¼m BranÅŸlar)</option>';
                
                // BranÅŸlarÄ± ekle
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.name;
                    option.textContent = `${branch.icon || 'ğŸ¢'} ${branch.name}`;
                    branchSelect.appendChild(option);
                });
            }
            
            // Kategori seÃ§eneklerini doldur (varsayÄ±lan + Ã¶zel kategoriler)
            const categorySelect = document.getElementById('expenseCategory');
            if (categorySelect) {
                // VarsayÄ±lan kategoriler
                const defaultCategories = [
                    { name: 'Kira', icon: 'ğŸ ' },
                    { name: 'MaaÅŸ', icon: 'ğŸ’°' },
                    { name: 'Fatura', icon: 'ğŸ“„' },
                    { name: 'Malzeme', icon: 'ğŸ”§' },
                    { name: 'DiÄŸer', icon: 'ğŸ“¦' }
                ];
                
                categorySelect.innerHTML = '<option value="">SeÃ§iniz...</option>';
                
                // VarsayÄ±lan kategorileri ekle
                defaultCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    option.textContent = `${cat.icon} ${cat.name}`;
                    categorySelect.appendChild(option);
                });
                
                // Ã–zel kategorileri ekle
                if (clubSettings.expenseCategories && clubSettings.expenseCategories.length > 0) {
                    clubSettings.expenseCategories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.name;
                        option.textContent = `${cat.icon} ${cat.name}`;
                        categorySelect.appendChild(option);
                    });
                }
            }
            
            // Formu temizle
            document.getElementById('expenseForm').reset();
            
            // Modal'Ä± aÃ§
            openModal('addExpenseModal');
        };
        
        // Gider form submit handler
        window.handleExpenseFormSubmit = async function(event) {
            event.preventDefault();
            
            const category = document.getElementById('expenseCategory').value;
            const branch = document.getElementById('expenseBranch').value;
            const description = document.getElementById('expenseDescription').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            
            if (!category || !description || !amount || amount <= 0) {
                showAlert('âŒ LÃ¼tfen tÃ¼m alanlarÄ± doldurun', 'danger');
                return;
            }
            
            // Modal'Ä± kapat
            closeModal('addExpenseModal');
            
            // Gider ekle
            await addExpense(category, description, amount, branch);
        };
        
        // Gider ekle
        async function addExpense(category, description, amount, branch = 'Genel') {
            try {
                const now = new Date().toISOString();
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'expenses'),
                    {
                        clubId: currentClubId,
                        category: category,
                        description: description,
                        amount: amount,
                        branch: branch,
                        date: now,
                        createdBy: currentUser?.fullName || 'Admin',
                        createdAt: now
                    }
                );
                
                showAlert('âœ… Gider baÅŸarÄ±yla eklendi', 'success');
                
                // AÃ§Ä±k sayfaya gÃ¶re yenile
                if (currentSection === 'accounting-summary') {
                    renderAccountingSummary();
                } else if (currentSection === 'expenses') {
                    renderExpensesPage();
                }
            } catch (error) {
                console.error('Gider eklenirken hata:', error);
                showAlert('âŒ Gider eklenirken bir hata oluÅŸtu', 'danger');
            }
        }
        
        // Gider sil (accounting-summary'den)
        window.deleteExpense = async function(expenseId) {
            if (!confirm('Bu gideri silmek istediÄŸinize emin misiniz?')) return;
            
            try {
                await window.firebase.deleteDoc(
                    window.firebase.doc(window.db, 'expenses', expenseId)
                );
                
                showAlert('âœ… Gider silindi', 'success');
                
                // AÃ§Ä±k sayfaya gÃ¶re yenile
                if (currentSection === 'accounting-summary') {
                    renderAccountingSummary();
                } else if (currentSection === 'expenses') {
                    renderExpensesPage();
                }
            } catch (error) {
                console.error('Gider silinirken hata:', error);
                showAlert('âŒ Gider silinirken bir hata oluÅŸtu', 'danger');
            }
        };
        
        // ÃœrÃ¼n ekleme modalÄ± aÃ§
        window.openAddProductModal = function() {
            // BranÅŸ seÃ§eneklerini doldur
            const branchSelect = document.getElementById('productBranch');
            if (branchSelect) {
                // Ã–nce mevcut seÃ§enekleri temizle (Genel hariÃ§)
                branchSelect.innerHTML = '<option value="Genel">ğŸŒ Genel (TÃ¼m BranÅŸlar)</option>';
                
                // BranÅŸlarÄ± ekle
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.name;
                    option.textContent = `${branch.icon || 'ğŸ¢'} ${branch.name}`;
                    branchSelect.appendChild(option);
                });
            }
            
            // Kategori seÃ§eneklerini doldur (varsayÄ±lan + Ã¶zel kategoriler)
            const categorySelect = document.getElementById('productCategory');
            if (categorySelect) {
                // VarsayÄ±lan kategoriler
                const defaultCategories = [
                    { name: 'Ekipman', icon: 'âš½' },
                    { name: 'KÄ±yafet', icon: 'ğŸ‘•' },
                    { name: 'Abonelik', icon: 'ğŸ’³' },
                    { name: 'DiÄŸer', icon: 'ğŸ“¦' }
                ];
                
                categorySelect.innerHTML = '<option value="">SeÃ§iniz...</option>';
                
                // VarsayÄ±lan kategorileri ekle
                defaultCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    option.textContent = `${cat.icon} ${cat.name}`;
                    categorySelect.appendChild(option);
                });
                
                // Ã–zel kategorileri ekle
                if (clubSettings.productCategories && clubSettings.productCategories.length > 0) {
                    clubSettings.productCategories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.name;
                        option.textContent = `${cat.icon} ${cat.name}`;
                        categorySelect.appendChild(option);
                    });
                }
            }
            
            // Formu temizle
            document.getElementById('productForm').reset();
            
            // Modal'Ä± aÃ§
            openModal('addProductModal');
        };
        
        // ÃœrÃ¼n form submit handler
        window.handleProductFormSubmit = async function(event) {
            event.preventDefault();
            
            const name = document.getElementById('productName').value;
            const category = document.getElementById('productCategory').value;
            const branch = document.getElementById('productBranch').value;
            const costPrice = parseFloat(document.getElementById('productCostPrice').value) || 0;
            const price = parseFloat(document.getElementById('productPrice').value);
            const stock = parseInt(document.getElementById('productStock').value) || 0;
            
            if (!name || !category || !price || price <= 0) {
                showAlert('âŒ LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun', 'danger');
                return;
            }
            
            // Modal'Ä± kapat
            closeModal('addProductModal');
            
            // ÃœrÃ¼n ekle
            await addProduct(name, category, price, stock, branch, costPrice);
        };
        
        // ÃœrÃ¼n ekle
        async function addProduct(name, category, price, stock, branch = 'Genel', costPrice = 0) {
            try {
                const now = new Date().toISOString();
                await window.firebase.addDoc(
                    window.firebase.collection(window.db, 'products'),
                    {
                        clubId: currentClubId,
                        name: name,
                        category: category,
                        costPrice: costPrice,
                        price: price,
                        stock: stock,
                        branch: branch,
                        createdBy: currentUser?.fullName || 'Admin',
                        createdAt: now
                    }
                );
                
                showAlert('âœ… ÃœrÃ¼n baÅŸarÄ±yla eklendi', 'success');
                
                // AÃ§Ä±k sayfaya gÃ¶re yenile
                if (currentSection === 'accounting-summary') {
                    renderAccountingSummary();
                } else if (currentSection === 'products') {
                    renderProductsPage();
                }
            } catch (error) {
                console.error('ÃœrÃ¼n eklenirken hata:', error);
                showAlert('âŒ ÃœrÃ¼n eklenirken bir hata oluÅŸtu', 'danger');
            }
        }
        
        // ÃœrÃ¼n sil
        window.deleteProduct = async function(productId) {
            if (!confirm('Bu Ã¼rÃ¼nÃ¼ silmek istediÄŸinize emin misiniz?')) return;
            
            try {
                await window.firebase.deleteDoc(
                    window.firebase.doc(window.db, 'products', productId)
                );
                
                showAlert('âœ… ÃœrÃ¼n silindi', 'success');
                
                // AÃ§Ä±k sayfaya gÃ¶re yenile
                if (currentSection === 'accounting-summary') {
                    renderAccountingSummary();
                } else if (currentSection === 'products') {
                    renderProductsPage();
                }
            } catch (error) {
                console.error('ÃœrÃ¼n silinirken hata:', error);
                showAlert('âŒ ÃœrÃ¼n silinirken bir hata oluÅŸtu', 'danger');
            }
        };
        
        // ============================================
        // ğŸ“„ GIDERLER VE ÃœRÃœNLER SAYFALARI
        // ============================================
        
        // Giderler sayfasÄ±nÄ± render et
        window.renderExpensesPage = async function() {
            const container = document.getElementById('expensesPageContainer');
            if (!container) return;
            
            // BranÅŸ filtrelerini doldur
            const branchFilter = document.getElementById('expensesBranchFilter');
            if (branchFilter && branchFilter.options.length === 1) {
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.name;
                    option.textContent = branch.name;
                    branchFilter.appendChild(option);
                });
            }
            
            // Kategori filtrelerini gÃ¼ncelle (Ã¶zel kategorileri de ekle)
            const categoryFilter = document.getElementById('expensesCategoryFilter');
            if (categoryFilter && categoryFilter.options.length === 6) { // Sadece varsayÄ±lan kategoriler varsa
                if (clubSettings.expenseCategories && clubSettings.expenseCategories.length > 0) {
                    clubSettings.expenseCategories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.name;
                        option.textContent = `${cat.icon} ${cat.name}`;
                        categoryFilter.appendChild(option);
                    });
                }
            }
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>Giderler yÃ¼kleniyor...</span></div>';
            
            try {
                const expensesRef = window.firebase.collection(window.db, 'expenses');
                // âœ… Index gerektirmeyen sorgu - sadece clubId
                const q = window.firebase.query(
                    expensesRef,
                    window.firebase.where('clubId', '==', currentClubId)
                );
                
                const snapshot = await window.firebase.getDocs(q);
                let expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Tarih filtrelerini uygula
                const startDateInput = document.getElementById('expensesStartDate');
                const endDateInput = document.getElementById('expensesEndDate');
                const categoryFilterInput = document.getElementById('expensesCategoryFilter');
                const branchFilterInput = document.getElementById('expensesBranchFilter');
                
                if (startDateInput && startDateInput.value) {
                    const startDate = new Date(startDateInput.value);
                    startDate.setHours(0, 0, 0, 0);
                    expenses = expenses.filter(exp => {
                        const expDate = new Date(exp.date);
                        return expDate >= startDate;
                    });
                }
                
                if (endDateInput && endDateInput.value) {
                    const endDate = new Date(endDateInput.value);
                    endDate.setHours(23, 59, 59, 999);
                    expenses = expenses.filter(exp => {
                        const expDate = new Date(exp.date);
                        return expDate <= endDate;
                    });
                }
                
                // Kategori filtresini uygula
                if (categoryFilterInput && categoryFilterInput.value !== 'all') {
                    const selectedCategory = categoryFilterInput.value;
                    expenses = expenses.filter(exp => exp.category === selectedCategory);
                }
                
                // BranÅŸ filtresini uygula
                if (branchFilterInput && branchFilterInput.value !== 'all') {
                    const selectedBranch = branchFilterInput.value;
                    expenses = expenses.filter(exp => exp.branch === selectedBranch);
                }
                
                // Client-side sorting ve limit
                expenses.sort((a, b) => {
                    const dateA = new Date(a.date || 0);
                    const dateB = new Date(b.date || 0);
                    return dateB - dateA; // En yeni en Ã¼stte
                });
                expenses = expenses.slice(0, 100); // Ä°lk 100 kayÄ±t
                
                if (expenses.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>HenÃ¼z gider kaydÄ± yok. "â• Gider Ekle" butonunu kullanarak gider ekleyebilirsiniz.</p></div>';
                    return;
                }
                
                // Kategoriye gÃ¶re topla
                const byCategory = {};
                const byBranch = {};
                let total = 0;
                let avgExpense = 0;
                
                expenses.forEach(exp => {
                    const cat = exp.category || 'DiÄŸer';
                    const branch = exp.branch || 'Genel';
                    
                    if (!byCategory[cat]) byCategory[cat] = 0;
                    if (!byBranch[branch]) byBranch[branch] = 0;
                    
                    byCategory[cat] += exp.amount || 0;
                    byBranch[branch] += exp.amount || 0;
                    total += exp.amount || 0;
                });
                
                avgExpense = expenses.length > 0 ? total / expenses.length : 0;
                
                // En yÃ¼ksek kategorileri bul
                const topCategory = Object.entries(byCategory).sort((a, b) => b[1] - a[1])[0];
                
                // Pasta grafiÄŸi iÃ§in veriler
                const categoryLabels = Object.keys(byCategory);
                const categoryData = Object.values(byCategory);
                const categoryColors = [
                    '#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5',
                    '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50',
                    '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800'
                ];
                
                container.innerHTML = `
                    <!-- Ä°statistik Ã–zet KartlarÄ± -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- Toplam Gider -->
                        <div style="background: linear-gradient(135deg, #f44336 0%, #e53935 100%); color: white; padding: 25px; border-radius: 16px; box-shadow: 0 8px 16px rgba(244,67,54,0.3); transform: translateY(0); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 12px 24px rgba(244,67,54,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 16px rgba(244,67,54,0.3)';">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                                <span style="font-size: 36px;">ğŸ’¸</span>
                                <div>
                                    <div style="font-size: 13px; opacity: 0.9; font-weight: 500;">Toplam Gider</div>
                                    <div style="font-size: 12px; opacity: 0.7;">${expenses.length} kayÄ±t</div>
                                </div>
                            </div>
                            <div style="font-size: 32px; font-weight: bold;">${formatPrice(total)}</div>
                        </div>
                        
                        <!-- Ortalama Gider -->
                        <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 25px; border-radius: 16px; box-shadow: 0 8px 16px rgba(255,152,0,0.3); transform: translateY(0); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 12px 24px rgba(255,152,0,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 16px rgba(255,152,0,0.3)';">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                                <span style="font-size: 36px;">ğŸ“Š</span>
                                <div>
                                    <div style="font-size: 13px; opacity: 0.9; font-weight: 500;">Ortalama Gider</div>
                                    <div style="font-size: 12px; opacity: 0.7;">Per kayÄ±t</div>
                                </div>
                            </div>
                            <div style="font-size: 32px; font-weight: bold;">${formatPrice(avgExpense)}</div>
                        </div>
                        
                        <!-- En YÃ¼ksek Kategori -->
                        <div style="background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); color: white; padding: 25px; border-radius: 16px; box-shadow: 0 8px 16px rgba(233,30,99,0.3); transform: translateY(0); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 12px 24px rgba(233,30,99,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 16px rgba(233,30,99,0.3)';">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                                <span style="font-size: 36px;">ğŸ†</span>
                                <div>
                                    <div style="font-size: 13px; opacity: 0.9; font-weight: 500;">En YÃ¼ksek Kategori</div>
                                    <div style="font-size: 12px; opacity: 0.7;">${topCategory ? topCategory[0] : '-'}</div>
                                </div>
                            </div>
                            <div style="font-size: 32px; font-weight: bold;">${topCategory ? formatPrice(topCategory[1]) : '0â‚º'}</div>
                        </div>
                        
                        <!-- Kategori SayÄ±sÄ± -->
                        <div style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white; padding: 25px; border-radius: 16px; box-shadow: 0 8px 16px rgba(156,39,176,0.3); transform: translateY(0); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 12px 24px rgba(156,39,176,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 16px rgba(156,39,176,0.3)';">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                                <span style="font-size: 36px;">ğŸ“‚</span>
                                <div>
                                    <div style="font-size: 13px; opacity: 0.9; font-weight: 500;">Kategori Ã‡eÅŸitliliÄŸi</div>
                                    <div style="font-size: 12px; opacity: 0.7;">FarklÄ± kategori</div>
                                </div>
                            </div>
                            <div style="font-size: 32px; font-weight: bold;">${categoryLabels.length}</div>
                        </div>
                    </div>
                    
                    <!-- Grafik ve Kategori DetaylarÄ± -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; margin-bottom: 30px;">
                        <!-- Pasta GrafiÄŸi -->
                        <div style="background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                            <h3 style="margin: 0 0 20px 0; color: #333; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 28px;">ğŸ“ˆ</span>
                                Kategorilere GÃ¶re DaÄŸÄ±lÄ±m
                            </h3>
                            <div style="position: relative; height: 300px;">
                                <canvas id="expenseCategoryChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Kategori DetaylarÄ± -->
                        <div style="background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                            <h3 style="margin: 0 0 20px 0; color: #333; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 28px;">ğŸ“‹</span>
                                Kategori DetaylarÄ±
                            </h3>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${Object.entries(byCategory).sort((a, b) => b[1] - a[1]).map(([cat, amount], index) => {
                                    const percentage = ((amount / total) * 100).toFixed(1);
                                    const color = categoryColors[index % categoryColors.length];
                                    return `
                                        <div style="padding: 12px; background: linear-gradient(90deg, ${color}15 0%, transparent 100%); border-left: 4px solid ${color}; border-radius: 8px; margin-bottom: 10px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                                <span style="font-weight: 600; color: #333; font-size: 14px;">${cat}</span>
                                                <span style="background: ${color}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">${percentage}%</span>
                                            </div>
                                            <div style="font-size: 18px; font-weight: bold; color: ${color};">${formatPrice(amount)}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Giderler Tablosu - Modern UI -->
                    <div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 6px 20px rgba(0,0,0,0.08);">
                        <h3 style="margin: 0 0 25px 0; color: #333; display: flex; align-items: center; gap: 12px; font-size: 22px; font-weight: 700;">
                            <span style="font-size: 32px;">ğŸ“</span>
                            Gider DetaylarÄ±
                        </h3>
                        <div style="overflow-x: auto; border-radius: 12px; border: 1px solid #e0e0e0;">
                            <table style="width: 100%; border-collapse: collapse; background: white;">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, #f5f5f5 0%, #e9e9e9 100%);">
                                        <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">ğŸ“… Tarih</th>
                                        <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">ğŸ·ï¸ Kategori</th>
                                        <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">ğŸ¢ BranÅŸ</th>
                                        <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">ğŸ“„ AÃ§Ä±klama</th>
                                        <th style="padding: 16px 20px; text-align: right; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">ğŸ’° Tutar</th>
                                        <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">ğŸ‘¤ Ekleyen</th>
                                        <th style="padding: 16px 20px; text-align: center; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">âš™ï¸ Ä°ÅŸlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${expenses.map((expense, index) => `
                                        <tr style="transition: all 0.2s; background: ${index % 2 === 0 ? 'white' : '#fafafa'};" onmouseover="this.style.background='#f0f7ff'; this.style.transform='scale(1.01)'" onmouseout="this.style.background='${index % 2 === 0 ? 'white' : '#fafafa'}'; this.style.transform='scale(1)'">
                                            <td style="padding: 18px 20px; white-space: nowrap; font-size: 14px; color: #666; border-bottom: 1px solid #f0f0f0;">${new Date(expense.date).toLocaleDateString('tr-TR')}</td>
                                            <td style="padding: 18px 20px; border-bottom: 1px solid #f0f0f0;"><span style="background: linear-gradient(135deg, #f44336 0%, #e53935 100%); color: white; padding: 8px 16px; border-radius: 25px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 8px rgba(244,67,54,0.3); display: inline-block;">${expense.category || 'Genel'}</span></td>
                                            <td style="padding: 18px 20px; border-bottom: 1px solid #f0f0f0;"><span style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; padding: 8px 16px; border-radius: 25px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 8px rgba(33,150,243,0.3); display: inline-block;">${expense.branch || 'Genel'}</span></td>
                                            <td style="padding: 18px 20px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; font-size: 14px; color: #666; border-bottom: 1px solid #f0f0f0;">${expense.description || '-'}</td>
                                            <td style="padding: 18px 20px; text-align: right; font-weight: 700; color: #f44336; font-size: 16px; white-space: nowrap; border-bottom: 1px solid #f0f0f0;">${formatPrice(expense.amount || 0)}</td>
                                            <td style="padding: 18px 20px; font-size: 13px; color: #888; border-bottom: 1px solid #f0f0f0;">${expense.createdBy || '-'}</td>
                                            <td style="padding: 18px 20px; text-align: center; border-bottom: 1px solid #f0f0f0;">
                                                <button class="btn btn-sm btn-danger" onclick="deleteExpenseFromPage('${expense.id}')" style="padding: 8px 16px; border-radius: 10px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 6px rgba(244,67,54,0.3); transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                                    ğŸ—‘ï¸ Sil
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // Pasta grafiÄŸini Ã§iz
                setTimeout(() => {
                    const ctx = document.getElementById('expenseCategoryChart');
                    if (ctx && window.Chart) {
                        // Eski grafiÄŸi yok et
                        if (window.expenseCategoryChartInstance) {
                            window.expenseCategoryChartInstance.destroy();
                        }
                        
                        window.expenseCategoryChartInstance = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: categoryLabels,
                                datasets: [{
                                    data: categoryData,
                                    backgroundColor: categoryColors.slice(0, categoryLabels.length),
                                    borderWidth: 2,
                                    borderColor: '#fff'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            padding: 15,
                                            font: {
                                                size: 12,
                                                weight: '600'
                                            },
                                            usePointStyle: true,
                                            pointStyle: 'circle'
                                        }
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const label = context.label || '';
                                                const value = context.parsed || 0;
                                                const percentage = ((value / total) * 100).toFixed(1);
                                                return label + ': ' + formatPrice(value) + ' (' + percentage + '%)';
                                            }
                                        },
                                        backgroundColor: 'rgba(0,0,0,0.8)',
                                        padding: 12,
                                        titleFont: {
                                            size: 14,
                                            weight: 'bold'
                                        },
                                        bodyFont: {
                                            size: 13
                                        },
                                        borderColor: 'rgba(255,255,255,0.1)',
                                        borderWidth: 1
                                    }
                                }
                            }
                        });
                    }
                }, 100);
            } catch (error) {
                console.error('Giderler yÃ¼klenirken hata:', error);
                container.innerHTML = '<div class="empty-state"><p style="color: #f44336;">âŒ Giderler yÃ¼klenirken bir hata oluÅŸtu</p></div>';
            }
        };
        
        // Gider sil (expenses sayfasÄ±ndan)
        window.deleteExpenseFromPage = async function(expenseId) {
            if (!confirm('Bu gideri silmek istediÄŸinize emin misiniz?')) return;
            
            try {
                await window.firebase.deleteDoc(
                    window.firebase.doc(window.db, 'expenses', expenseId)
                );
                
                showAlert('âœ… Gider silindi', 'success');
                
                // AÃ§Ä±k sayfaya gÃ¶re yenile
                if (currentSection === 'accounting-summary') {
                    renderAccountingSummary();
                } else if (currentSection === 'expenses') {
                    renderExpensesPage();
                }
            } catch (error) {
                console.error('Gider silinirken hata:', error);
                showAlert('âŒ Gider silinirken bir hata oluÅŸtu', 'danger');
            }
        };
        
        // HÄ±zlÄ± dÃ¶nem filtresi
        window.setExpensePeriod = function(period) {
            const today = new Date();
            const startDate = new Date();
            const endDate = new Date();
            
            switch(period) {
                case 'today':
                    // BugÃ¼n
                    break;
                case 'week':
                    // Son 7 gÃ¼n
                    startDate.setDate(today.getDate() - 7);
                    break;
                case 'month':
                    // Bu ayÄ±n ilk gÃ¼nÃ¼
                    startDate.setDate(1);
                    break;
                case 'lastMonth':
                    // GeÃ§en ayÄ±n ilk ve son gÃ¼nÃ¼
                    startDate.setMonth(today.getMonth() - 1);
                    startDate.setDate(1);
                    endDate.setDate(0); // GeÃ§en ayÄ±n son gÃ¼nÃ¼
                    break;
                case 'year':
                    // Bu yÄ±lÄ±n ilk gÃ¼nÃ¼
                    startDate.setMonth(0);
                    startDate.setDate(1);
                    break;
            }
            
            // Tarih inputlarÄ±nÄ± gÃ¼ncelle
            document.getElementById('expensesStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('expensesEndDate').value = endDate.toISOString().split('T')[0];
            
            // SayfayÄ± yenile
            renderExpensesPage();
        };
        
        // Giderler filtrelerini sÄ±fÄ±rla
        window.resetExpensesFilters = function() {
            document.getElementById('expensesStartDate').value = '';
            document.getElementById('expensesEndDate').value = '';
            document.getElementById('expensesCategoryFilter').value = 'all';
            const branchFilter = document.getElementById('expensesBranchFilter');
            if (branchFilter) branchFilter.value = 'all';
            renderExpensesPage();
        };
        
        // ÃœrÃ¼nler sayfasÄ±nÄ± render et
        window.renderProductsPage = async function() {
            const container = document.getElementById('productsPageContainer');
            if (!container) return;
            
            container.innerHTML = '<div class="loading"><div class="spinner"></div><span>ÃœrÃ¼nler yÃ¼kleniyor...</span></div>';
            
            try {
                const productsRef = window.firebase.collection(window.db, 'products');
                // âœ… Index gerektirmeyen sorgu - sadece clubId
                const q = window.firebase.query(
                    productsRef,
                    window.firebase.where('clubId', '==', currentClubId)
                );
                
                const snapshot = await window.firebase.getDocs(q);
                let products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Client-side sorting
                products.sort((a, b) => {
                    const dateA = new Date(a.createdAt || 0);
                    const dateB = new Date(b.createdAt || 0);
                    return dateB - dateA; // En yeni en Ã¼stte
                });
                
                if (products.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>HenÃ¼z Ã¼rÃ¼n kaydÄ± yok. "â• ÃœrÃ¼n Ekle" butonunu kullanarak Ã¼rÃ¼n ekleyebilirsiniz.</p></div>';
                    return;
                }
                
                // Kategoriye gÃ¶re topla
                const byCategory = {};
                let totalValue = 0;
                let totalStock = 0;
                products.forEach(prod => {
                    const cat = prod.category || 'DiÄŸer';
                    if (!byCategory[cat]) byCategory[cat] = { count: 0, value: 0 };
                    byCategory[cat].count++;
                    byCategory[cat].value += (prod.price || 0) * (prod.stock || 0);
                    totalValue += (prod.price || 0) * (prod.stock || 0);
                    totalStock += prod.stock || 0;
                });
                
                container.innerHTML = `
                    <!-- Ã–zet KartlarÄ± -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ğŸ›ï¸ Toplam ÃœrÃ¼n</div>
                            <div style="font-size: 28px; font-weight: bold;">${products.length}</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Stok: ${totalStock}</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ğŸ’° Toplam DeÄŸer</div>
                            <div style="font-size: 28px; font-weight: bold;">${totalValue.toFixed(2)} â‚º</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Envanter deÄŸeri</div>
                        </div>
                    </div>
                    
                    <!-- ÃœrÃ¼nler Tablosu - Modern UI -->
                    <div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 6px 20px rgba(0,0,0,0.08);">
                        <h3 style="margin: 0 0 25px 0; color: #333; display: flex; align-items: center; gap: 12px; font-size: 22px; font-weight: 700;">
                            <span style="font-size: 32px;">ğŸ›ï¸</span>
                            ÃœrÃ¼n DetaylarÄ±
                        </h3>
                        <div style="overflow-x: auto; border-radius: 12px; border: 1px solid #e0e0e0;">
                            <table style="width: 100%; border-collapse: collapse; background: white;">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, #f5f5f5 0%, #e9e9e9 100%);">
                                        <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">ğŸ·ï¸ ÃœrÃ¼n AdÄ±</th>
                                        <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">ğŸ“‚ Kategori</th>
                                        <th style="padding: 16px 20px; text-align: right; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">ğŸ’µ Fiyat</th>
                                        <th style="padding: 16px 20px; text-align: center; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">ğŸ“¦ Stok</th>
                                        <th style="padding: 16px 20px; text-align: right; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">ğŸ’° Toplam DeÄŸer</th>
                                        <th style="padding: 16px 20px; text-align: left; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">ğŸ‘¤ Ekleyen</th>
                                        <th style="padding: 16px 20px; text-align: center; font-weight: 700; color: #555; border-bottom: 2px solid #ddd; font-size: 14px;">âš™ï¸ Ä°ÅŸlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${products.map((product, index) => {
                                        const totalVal = (product.price || 0) * (product.stock || 0);
                                        return `
                                        <tr style="transition: all 0.2s; background: ${index % 2 === 0 ? 'white' : '#fafafa'};" onmouseover="this.style.background='#f0f7ff'; this.style.transform='scale(1.01)'" onmouseout="this.style.background='${index % 2 === 0 ? 'white' : '#fafafa'}'; this.style.transform='scale(1)'">
                                            <td style="padding: 18px 20px; font-weight: 600; font-size: 14px; color: #333; border-bottom: 1px solid #f0f0f0;">${product.name || '-'}</td>
                                            <td style="padding: 18px 20px; border-bottom: 1px solid #f0f0f0;"><span style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 8px 16px; border-radius: 25px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 8px rgba(255,152,0,0.3); display: inline-block;">${product.category || 'Genel'}</span></td>
                                            <td style="padding: 18px 20px; text-align: right; font-weight: 700; color: #4caf50; font-size: 16px; border-bottom: 1px solid #f0f0f0;">${product.price || 0} â‚º</td>
                                            <td style="padding: 18px 20px; text-align: center; border-bottom: 1px solid #f0f0f0;"><span style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; padding: 8px 16px; border-radius: 25px; font-weight: 600; box-shadow: 0 2px 8px rgba(33,150,243,0.3); display: inline-block;">${product.stock !== undefined ? product.stock : '-'}</span></td>
                                            <td style="padding: 18px 20px; text-align: right; font-weight: 700; font-size: 16px; color: #333; border-bottom: 1px solid #f0f0f0;">${totalVal.toFixed(2)} â‚º</td>
                                            <td style="padding: 18px 20px; font-size: 13px; color: #888; border-bottom: 1px solid #f0f0f0;">${product.createdBy || '-'}</td>
                                            <td style="padding: 18px 20px; text-align: center; border-bottom: 1px solid #f0f0f0;">
                                                <button class="btn btn-sm btn-danger" onclick="deleteProductFromPage('${product.id}')" style="padding: 8px 16px; border-radius: 10px; font-size: 13px; font-weight: 600; box-shadow: 0 2px 6px rgba(244,67,54,0.3); transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                                    ğŸ—‘ï¸ Sil
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('ÃœrÃ¼nler yÃ¼klenirken hata:', error);
                container.innerHTML = '<div class="empty-state"><p style="color: #f44336;">âŒ ÃœrÃ¼nler yÃ¼klenirken bir hata oluÅŸtu</p></div>';
            }
        };
        
        // ÃœrÃ¼n sil (products sayfasÄ±ndan)
        window.deleteProductFromPage = async function(productId) {
            if (!confirm('Bu Ã¼rÃ¼nÃ¼ silmek istediÄŸinize emin misiniz?')) return;
            
            try {
                await window.firebase.deleteDoc(
                    window.firebase.doc(window.db, 'products', productId)
                );
                
                showAlert('âœ… ÃœrÃ¼n silindi', 'success');
                
                // AÃ§Ä±k sayfaya gÃ¶re yenile
                if (currentSection === 'accounting-summary') {
                    renderAccountingSummary();
                } else if (currentSection === 'products') {
                    renderProductsPage();
                }
            } catch (error) {
                console.error('ÃœrÃ¼n silinirken hata:', error);
                showAlert('âŒ ÃœrÃ¼n silinirken bir hata oluÅŸtu', 'danger');
            }
        };


    </script>
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
            --border-color: #dee2e6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        
        /* Checkbox'larÄ± varsayÄ±lan olarak gizle */
        .incoming-call-checkbox,
        .outgoing-call-checkbox {
            display: none;
        }
        
        .incoming-call-checkbox:checked,
        .outgoing-call-checkbox:checked {
            display: block;
        }

        #password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #password-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            width: 90%;
            max-width: 400px;
        }

        #password-box h2 {
            margin-bottom: 20px;
            color: var(--dark-color);
        }

        #password-box .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        #password-error {
            color: var(--danger-color);
            margin-top: 10px;
            display: none;
        }

        #main-wrapper {
            display: none; /* Initially hidden */
        }

        .current-user-display {
            color: rgba(255,255,255,0.9);
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
            text-align: center;
            word-break: break-word;
        }


        /* âœ… Sidebar Navigation Styles */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: width 0.3s ease;
        }
        
        /* Collapsed durumda sidebar dar gÃ¶rÃ¼nÃ¼r */
        .sidebar.collapsed {
            width: 70px;
        }
        
        /* Collapsed durumda yazÄ±lar ve dropdown'lar gizlenir */
        .sidebar.collapsed .nav-text,
        .sidebar.collapsed .dropdown-arrow,
        .sidebar.collapsed .sidebar-header h2 {
            display: none;
        }
        
        .sidebar.collapsed .dropdown-content {
            display: none !important;
        }
        
        .sidebar.collapsed #whatsapp-balance-container {
            padding: 4px !important;
            gap: 0 !important;
            font-size: 10px !important;
            min-width: 0 !important;
            max-width: 70px !important;
            flex-direction: column !important;
            overflow: hidden !important;
        }
        
        .sidebar.collapsed #whatsapp-balance-container span:not(#whatsapp-balance) {
            display: none !important;
        }
        
        .sidebar.collapsed .nav-btn {
            justify-content: center;
            padding: 12px;
        }
        
        .sidebar.collapsed .nav-icon {
            font-size: 20px;
            margin: 0;
        }
        
        .sidebar.collapsed .sidebar-header {
            padding: 15px 10px;
            text-align: center;
        }
        
        .sidebar.collapsed .sidebar-header button {
            margin: 0 auto;
        }
        
        .sidebar.collapsed .sidebar-footer {
            padding: 10px 5px;
        }
        
        .sidebar.collapsed .current-user-display {
            display: none;
        }
        
        .sidebar.collapsed #logout-btn-sidebar {
            font-size: 18px;
            padding: 8px 5px !important;
        }
        
        .sidebar.collapsed #logout-btn-sidebar:before {
            content: "ğŸšª";
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .sidebar-header h2 {
            color: white;
            font-size: 18px;
            margin: 0;
            font-weight: 600;
        }

        .sidebar-menu {
            flex: 1;
            padding: 15px 0;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .sidebar-menu::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar-menu::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
        }
        
        .sidebar-menu::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }

        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.3);
            flex-shrink: 0;
        }

        .sidebar .nav-btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 3px solid transparent;
        }

        .sidebar .nav-btn:hover {
            background: rgba(255,255,255,0.1);
            color: white;
            border-left-color: var(--primary-color);
        }

        .sidebar .nav-btn.active {
            background: rgba(102, 126, 234, 0.2);
            color: white;
            border-left-color: var(--primary-color);
            font-weight: 600;
        }

        .sidebar .nav-icon {
            font-size: 18px;
            min-width: 24px;
        }

        .sidebar .nav-text {
            flex: 1;
            font-size: 14px;
        }

        /* Dropdown Menu */
        .nav-dropdown {
            position: relative;
        }

        .dropdown-toggle {
            position: relative;
        }

        .dropdown-arrow {
            font-size: 10px;
            transition: transform 0.3s ease;
        }

        .dropdown-toggle.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            background: rgba(0,0,0,0.3);
            display: block;
            margin: 4px 0;
            border-radius: 8px;
            padding: 0;
        }

        .dropdown-content.show {
            max-height: 1000px !important;
            overflow: visible !important;
            padding: 8px 0 !important;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.2);
        }

        .sidebar .nav-btn.sub-item {
            padding: 12px 16px 12px 56px;
            font-size: 14px;
            border-left: 3px solid transparent;
            margin: 2px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .sidebar .nav-btn.sub-item:hover {
            background: rgba(255,255,255,0.2);
            border-left-color: rgba(255,255,255,0.4);
            transform: translateX(2px);
        }
        
        .sidebar .nav-btn.sub-sub-item {
            padding: 10px 16px 10px 76px;
            font-size: 13px;
            border-left: 3px solid transparent;
            margin: 2px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .sidebar .nav-btn.sub-sub-item:hover {
            background: rgba(255,255,255,0.25);
            border-left-color: rgba(255,255,255,0.5);
            transform: translateX(2px);
        }
        
        .nav-dropdown.sub-dropdown {
            margin-left: 0;
            margin: 4px 8px;
        }
        
        .nav-dropdown.sub-dropdown .dropdown-toggle {
            padding: 10px 16px 10px 56px;
            font-size: 14px;
        }
        
        .nav-dropdown.sub-dropdown .dropdown-content {
            background: rgba(0,0,0,0.4);
            margin: 4px 0 4px 8px;
            border-radius: 6px;
        }
        
        .nav-dropdown.sub-dropdown .dropdown-content.show {
            padding: 6px 0 !important;
        }

        /* Main Content Wrapper */
        .main-content-wrapper {
            flex: 1;
            margin-left: 260px;
            width: calc(100% - 260px);
            min-height: 100vh;
            background: #f5f5f5;
            transition: margin-left 0.3s ease, width 0.3s ease;
        }
        
        .sidebar.collapsed ~ .main-content-wrapper {
            margin-left: 70px;
            width: calc(100% - 70px);
        }
        
        .admin-content {
            padding: 30px;
            width: 100%;
            max-width: 100%;
            margin: 0;
        }

        .section { display: none; }
        .section.active { display: block; }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
        }
        .card > h3.card-subtitle {
            font-size: 1.2em;
            color: var(--dark-color);
            margin-top: 25px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .settings-subsection {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
        
        .settings-subtitle {
            font-size: 1.1em;
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .settings-tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 25px;
        }
        
        .settings-tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            margin-bottom: -2px;
        }
        
        .settings-tab:hover:not(:disabled) {
            color: var(--primary-color);
            background: rgba(255, 149, 0, 0.05);
        }
        
        .settings-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }
        
        .settings-tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .settings-tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .whatsapp-device-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: box-shadow 0.2s;
        }
        
        .whatsapp-device-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .device-info h4 {
            margin: 0 0 10px 0;
            color: var(--dark-color);
        }
        
        .device-info p {
            margin: 5px 0;
        }
        
        .device-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .card-title {
            font-size: 1.4em;
            color: var(--dark-color);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .permissions-group {
             display: flex;
             flex-wrap: wrap;
             gap: 15px;
             background: #f8f9fa;
             padding: 15px;
             border-radius: 8px;
             grid-column: 1 / -1; /* Span full width */
        }
        .permissions-group label {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .form-group label {
            font-weight: 600;
            color: var(--dark-color);
        }

        .form-control {
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .search-input {
            padding: 8px 15px;
            border: 2px solid var(--border-color);
            border-radius: 25px;
            width: 100%;
            max-width: 250px;
            font-size: 0.9em;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            padding: 5px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            transition: background-color 0.2s;
        }
        .btn-icon:hover {
            background-color: #e9ecef;
        }
        .btn-icon.danger:hover {
            background-color: #f8d7da;
            color: var(--danger-color);
        }

        .btn:disabled {
            background-color: #ccc !important;
            box-shadow: none;
            transform: none;
            cursor: not-allowed;
        }
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8em;
        }

        .btn-primary { background: var(--primary-color); color: white; }
        .btn-success { background: var(--success-color); color: white; }
        .btn-warning { background: var(--warning-color); color: #212529; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-info { background: var(--info-color); color: white; }
        .btn-secondary { background: #6c757d; color: white; }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-group .btn.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .btn-group .btn-secondary.active {
            background-color: var(--primary-color) !important;
            color: white !important;
        }

        .table-container {
            overflow: auto;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }
        
        .data-table tbody tr {
            transition: background-color 0.2s;
        }

        .data-table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .data-table tbody tr:hover {
            background: #f8f9ff;
        }
        
        .editable-row:hover {
            cursor: pointer;
            background-color: #f1f3f5 !important;
        }
        .editable-date {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .editable-date .btn-icon {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .data-table tbody tr:hover .editable-date .btn-icon {
            opacity: 1;
        }
        
        td.editable-reason {
            cursor: pointer;
            text-decoration: underline dotted;
        }
        td.editable-reason:hover {
            background-color: #f8f9fa;
        }
        .table-container {
            overflow-x: auto;
            overflow-y: visible;
        }
        
        .actions-cell {
            white-space: nowrap;
            position: relative;
        }
        .actions-cell .btn {
            margin-right: 5px;
        }
        
        /* Dropdown Menu Styles */
        .actions-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .actions-dropdown-btn {
            background: #4f46e5;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        
        .actions-dropdown-btn:hover {
            background: #4338ca;
        }
        
        .actions-dropdown-content {
            display: none;
            position: fixed;
            background: white;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 8px;
            z-index: 10000;
            margin-top: 5px;
            overflow: visible;
            border: 1px solid #e5e7eb;
        }
        
        .actions-dropdown.active .actions-dropdown-content {
            display: block;
        }
        
        .actions-dropdown-content button {
            width: 100%;
            padding: 10px 15px;
            border: none;
            background: white;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #374151;
        }
        
        .actions-dropdown-content button:hover {
            background: #f3f4f6;
        }
        
        .actions-dropdown-content button:not(:last-child) {
            border-bottom: 1px solid #f3f4f6;
        }
        
        .actions-dropdown-content button.danger {
            color: #dc2626;
        }
        
        .actions-dropdown-content button.danger:hover {
            background: #fee2e2;
        }


        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: none;
            cursor: pointer;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-active { background: #d4edda; color: #155724; }
        .status-expired { background: #f8d7da; color: #721c24; }
        .status-paid { background: #d1ecf1; color: #0c5460; }
        .status-unpaid { background: #f5c6cb; color: #721c24; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-overdue { background: #f8d7da; color: #721c24; }
        .status-present { background: #d4edda; color: #155724; }
        .status-absent { background: #f8d7da; color: #721c24; }

        .modal {
            display: none;
            position: fixed;
            z-index: 99999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            overflow-y: auto; /* âœ… Scroll ekle */
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh; /* âœ… Maksimum yÃ¼kseklik */
            overflow-y: auto; /* âœ… Ä°Ã§erik overflow olursa scroll */
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }
        
        /* Member Edit Modal Specific Styles */
        .member-edit-modal {
            max-width: 900px;
        }
        
        .modal-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary-color);
        }
        
        .modal-header h2 {
            margin: 0;
            color: var(--dark-color);
            font-size: 1.8em;
        }
        
        .form-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        
        .form-section:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-color: var(--primary-color);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .section-icon {
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section-title {
            margin: 0;
            font-size: 1.2em;
            color: var(--dark-color);
            font-weight: 600;
            flex: 1;
        }
        
        .required-badge {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .optional-badge {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #666;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .required-star {
            color: var(--danger-color);
            font-weight: bold;
            margin-left: 2px;
        }
        
        .form-text {
            display: block;
            margin-top: 5px;
            font-size: 0.85em;
            color: #6c757d;
            font-style: italic;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }
        
        .modal-footer .btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            font-size: 1em;
            font-weight: 600;
        }
        
        .modal-footer .btn span {
            font-size: 1.2em;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover { color: var(--danger-color); }

        /* Tab Styles */
        .customer-tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin: 20px 0;
            gap: 5px;
        }
        
        .tab-button {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tab-button:hover {
            color: var(--primary-color);
            background: rgba(102, 126, 234, 0.05);
        }
        
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .branch-tab-content {
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .branch-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .branch-info-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
        
        .branch-info-item strong {
            font-size: 11px;
            color: #666;
            display: block;
            margin-bottom: 5px;
        }
        
        .branch-info-item span {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        /* Modern Schedule Styles */
        #unassigned-groups-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            background: var(--light-color);
            border-radius: 10px;
            margin-bottom: 20px;
            min-height: 40px;
        }
        .unassigned-group {
            background: white;
            padding: 5px 12px;
            border-radius: 20px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-weight: 500;
            font-size: 0.9em;
        }
        .unassigned-group:active { cursor: grabbing; }
        
        .schedule-row {
            display: grid;
            gap: 10px;
            margin-top: 10px;
        }
        .schedule-row:first-child {
            margin-top: 0;
        }
        .schedule-row.weekday-row {
             grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }
        .schedule-row.weekend-row {
             grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }

        .schedule-day {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            min-height: 200px;
            transition: background-color 0.2s;
        }
        .schedule-day.drag-over {
             background-color: #e9eefe;
        }
        .schedule-day.is-holiday {
            background-color: #f1f3f5;
            opacity: 0.7;
        }

        .schedule-day h4 {
            text-align: center;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .lesson-block {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 8px 10px;
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 0.85em;
            position: relative;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        .lesson-block.trial-lesson {
            background: linear-gradient(135deg, var(--info-color), #148a9b);
        }
        
        .delete-lesson-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: background 0.2s, opacity 0.2s;
            opacity: 0;
        }
        .lesson-block:hover .delete-lesson-btn {
            opacity: 1;
        }
        .delete-lesson-btn:hover {
            background: var(--danger-color);
        }
        .lesson-block.empty-slot .delete-lesson-btn {
            opacity: 1;
            background: rgba(0,0,0,0.1);
        }
        .lesson-block.empty-slot .delete-lesson-btn:hover {
             background: rgba(0,0,0,0.2);
        }

        .lesson-block.empty-slot {
            background: #fffbe6;
            color: #856404;
            border: 1px dashed #ffeeba;
            justify-content: center;
            align-items: center;
            display: flex;
            flex-direction: column;
            cursor: default;
        }
         .lesson-block.empty-slot:hover {
            background: #fff9d7;
        }


        .time-editor {
            font-size: 0.9em;
            cursor: pointer;
        }
        .time-editor input {
            width: 70px;
        }
        .time-editor button {
            padding: 2px 5px;
            font-size: 0.8em;
        }

        #member-tooltip {
            display: none;
            position: absolute;
            background: var(--dark-color);
            color: white;
            padding: 10px;
            border-radius: 8px;
            z-index: 1001;
            pointer-events: none;
            font-size: 0.9em;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #member-tooltip ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        /* Modern Payment List */
        .payment-member-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .payment-member-item {
            background: white;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .payment-member-header {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--light-color);
        }
        .payment-member-header:hover {
            background: #e9ecef;
        }
        .payment-member-info {
            flex-grow: 1;
            cursor: pointer;
        }
        .status-container {
            cursor: pointer;
        }
        .payment-details {
            padding: 20px;
            display: none; /* Collapsed by default */
        }
        .payment-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .payment-details .data-table {
            box-shadow: none;
            border-radius: 0;
        }
        .status-container {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            flex-shrink: 0;
        }
        .sub-status {
            font-size: 0.8em;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }
        .sub-status.pending {
            background-color: var(--warning-color);
            color: #333;
        }
        .sub-status.expired {
            background: #f8d7da;
            color: #721c24;
        }
        .sub-status.group-name {
            background-color: #e9ecef;
            color: #495057;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-top: 4px solid var(--primary-color);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1.1em;
        }

        .stat-comparison {
            font-size: 0.9em;
            font-weight: bold;
        }
        .stat-comparison.increase { color: var(--success-color); }
        .stat-comparison.decrease { color: var(--danger-color); }
        
        #groupsList {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        #groupsList h2.group-category-title {
            font-size: 1.5em;
            color: var(--primary-color);
            margin-top: 20px;
            margin-bottom: 0px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--border-color);
        }
         #groupsList h2.group-category-title:first-of-type {
            margin-top: 0;
        }

        .group-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            border-left: 5px solid var(--primary-color);
            display: flex;
            flex-direction: column;
            transition: all 0.2s ease-in-out;
        }
        .group-card.group-card-trial {
            border-left-color: var(--info-color);
        }
        .group-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .group-card h4 {
            font-size: 1.1em;
            margin-bottom: 8px;
        }
        .group-card p {
            font-size: 0.9em;
            margin-bottom: 5px;
            color: #555;
        }
        .group-members {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
            flex-grow: 1;
        }

        .member-tag {
            background: var(--light-color);
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.85em;
            border: 1px solid var(--border-color);
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .group-card-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            gap: 10px;
        }
        
        .qr-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            gap: 15px;
            text-align: center;
        }
        
        .qr-loading .spinner {
            width: 40px;
            height: 40px;
            border-width: 4px;
        }
        
        .qr-loading p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 30px 20px;
            color: #666;
            width: 100%;
        }

        .empty-state h3 {
            margin-bottom: 8px;
            color: var(--primary-color);
            font-size: 16px;
        }
        
        .empty-state p {
            font-size: 13px;
        }

        /* CRM Tags Styles */
        .tags-category-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 50px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .tag-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: white;
            border-radius: 16px;
            border: 1.5px solid #e0e0e0;
            font-size: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .tag-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border-color: var(--primary-color);
        }

        .tag-item .tag-name {
            font-weight: 500;
        }

        .tag-item .tag-count {
            background: rgba(0,0,0,0.05);
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
        }

        .tag-item .tag-actions {
            display: flex;
            gap: 4px;
            margin-left: 4px;
        }

        .tag-item .tag-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 13px;
            padding: 2px 4px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .tag-item .tag-actions button:hover {
            opacity: 1;
        }

        .tag-item.status-tag {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%);
        }

        .tag-item.branch-tag {
            border-color: #f093fb;
            background: linear-gradient(135deg, rgba(240, 147, 251, 0.1) 0%, rgba(245, 87, 108, 0.05) 100%);
        }

        .tag-item.custom-tag {
            border-color: #43e97b;
            background: linear-gradient(135deg, rgba(67, 233, 123, 0.1) 0%, rgba(56, 249, 215, 0.05) 100%);
        }

        /* Filtered Customer Item */
        .filtered-customer-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .filtered-customer-item:hover {
            transform: translateX(3px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border-color: var(--primary-color);
        }

        .filtered-customer-item .customer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .filtered-customer-item .customer-name {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .filtered-customer-item .customer-status {
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .filtered-customer-item .customer-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 8px;
            margin-top: 8px;
            font-size: 13px;
        }

        .filtered-customer-item .customer-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }

        .filtered-customer-item .customer-tag {
            padding: 2px 8px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            font-size: 10px;
            color: #667eea;
        }

        /* Trial Item */
        .trial-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
            border-left: 3px solid #667eea;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .trial-item:hover {
            transform: translateX(3px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        .trial-item.scheduled {
            border-left-color: #4facfe;
        }

        .trial-item.completed {
            border-left-color: #43e97b;
        }

        .trial-item.cancelled {
            border-left-color: #f5576c;
            opacity: 0.7;
        }

        .trial-item.converted {
            border-left-color: #f093fb;
        }

        .trial-item .trial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .trial-item .trial-customer {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .trial-item .trial-status {
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .trial-item .trial-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            font-size: 12px;
            color: #666;
        }

        /* WhatsApp Styles */
        .whatsapp-contact-item {
            padding: 14px;
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
        }
        
        .whatsapp-contact-item:hover {
            background: rgba(245, 246, 246, 0.95);
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .whatsapp-contact-item.active {
            background: linear-gradient(135deg, rgba(37, 211, 102, 0.15) 0%, rgba(37, 211, 102, 0.05) 100%);
            border-left: 4px solid #25d366;
            box-shadow: 0 2px 12px rgba(37, 211, 102, 0.2);
        }
        
        #whatsapp-messages-area {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            backdrop-filter: blur(10px);
            position: relative;
        }
        
        #whatsapp-messages-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="10" cy="10" r="1" fill="%23ffffff" opacity="0.3"/><circle cx="30" cy="25" r="1" fill="%23ffffff" opacity="0.2"/><circle cx="60" cy="15" r="1" fill="%23ffffff" opacity="0.25"/><circle cx="80" cy="40" r="1" fill="%23ffffff" opacity="0.3"/><circle cx="45" cy="60" r="1" fill="%23ffffff" opacity="0.2"/></svg>');
            opacity: 0.4;
            pointer-events: none;
        }
        
        .whatsapp-message-wrapper {
            display: flex;
            margin-bottom: 8px;
            clear: both;
        }
        
        .whatsapp-message-wrapper.sent {
            justify-content: flex-end;
        }
        
        .whatsapp-message-wrapper.received {
            justify-content: flex-start;
        }
        
        .whatsapp-message {
            max-width: 65%;
            padding: 8px 12px 6px 12px;
            border-radius: 8px;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
            transition: box-shadow 0.2s ease;
        }
        
        .whatsapp-message:hover {
            box-shadow: 0 2px 2px rgba(0,0,0,0.15);
        }
        
        .whatsapp-message.sent {
            background: #D9FDD3;
            border-radius: 8px 8px 0 8px;
        }
        
        .whatsapp-message.received {
            background: #FFFFFF;
            border-radius: 8px 8px 8px 0;
        }
        
        .whatsapp-message .message-content {
            margin-bottom: 2px;
            color: #111;
            font-size: 14.2px;
            line-height: 19px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        
        .whatsapp-message .message-time {
            font-size: 11px;
            color: rgba(0,0,0,0.45);
            text-align: right;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 3px;
        }
        
        .message-check {
            color: #53bdeb;
            font-size: 14px;
        }
        
        .message-date-divider {
            text-align: center;
            margin: 15px auto;
            padding: 6px 12px;
            background: rgba(225, 245, 254, 0.92);
            border-radius: 8px;
            font-size: 12.5px;
            color: #667781;
            display: inline-block;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
            font-weight: 500;
            border-radius: 7.5px;
            font-size: 12.5px;
            color: #54656f;
            position: relative;
            z-index: 1;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
        }
        
        #whatsapp-chat-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        #whatsapp-message-input {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }
        
        #whatsapp-message-text {
            border: 2px solid rgba(100, 100, 100, 0.2);
            border-radius: 24px;
            padding: 12px 18px;
            transition: all 0.3s ease;
        }
        
        #whatsapp-message-text:focus {
            border-color: #25d366;
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
            outline: none;
        }
        
        #whatsapp-message-text {
            border-radius: 21px;
            border: 1px solid #d1d7db;
            padding: 9px 12px;
            font-size: 15px;
        }
        
        .recipient-status-badge {
            float: right;
            margin-top: 5px;
        }
        
        .bulk-recipient-checkbox {
            margin-right: 10px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .actions-container {
            position: relative;
        }
        #context-menu {
            display: none;
            position: fixed;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            z-index: 1001;
            min-width: 200px;
            overflow: hidden;
        }
        #context-menu.active {
            display: block;
        }
        #context-menu a {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            color: var(--dark-color);
            text-decoration: none;
            font-size: 0.9em;
            transition: background-color 0.2s;
            white-space: nowrap;
        }
        #context-menu a:hover {
            background-color: #f8f9fa;
        }
        #context-menu a.danger {
            color: var(--danger-color);
        }
        #context-menu a.danger:hover {
            background-color: #fff2f4;
        }

        #phone-context-menu {
            display: none;
            position: fixed;
            z-index: 1002;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        #phone-context-menu button {
            display: block;
            width: 100%;
            padding: 12px 20px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
        }
        #phone-context-menu button:hover {
            background: #f8f9fa;
        }
        
        /* Task Messages Styles */
        .task-message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            max-width: 80%;
        }
        
        .task-message-mine {
            background: var(--primary-color);
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .task-message-other {
            background: white;
            border: 1px solid #e0e0e0;
            margin-right: auto;
        }
        
        .task-message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85em;
        }
        
        .task-message-mine .task-message-header {
            flex-direction: row-reverse;
        }
        
        .task-message-time {
            opacity: 0.7;
            font-size: 0.9em;
        }
        
        .task-message-body {
            word-wrap: break-word;
        }
        
        .task-message-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .task-message-delete:hover {
            background: var(--danger-color);
        }
        
        .task-message {
            position: relative;
        }
        
        .badge {
            background: var(--danger-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            margin-left: 5px;
        }


        .group-selection-list, .group-members-list, .attendance-list {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .group-selection-item {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .group-selection-item:hover {
            background: #f8f9ff;
            border-color: var(--primary-color);
        }
        .member-item, .attendance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--light-color);
            border-radius: 5px;
            gap: 10px;
        }
        .attendance-item label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            flex-grow: 1;
        }
        .reason-input {
            flex-shrink: 1;
            min-width: 150px;
        }

        .holiday-settings-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        .holiday-settings-grid label {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .registration-forms-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }
        .registration-form-wrapper {
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 10px;
        }

        .searchable-select-container {
            position: relative;
        }
        .searchable-select-results {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        .searchable-select-results.active {
            display: block;
        }
        .searchable-select-item {
            padding: 10px 15px;
            cursor: pointer;
        }
        .searchable-select-item:not(.disabled):hover {
            background: #f0f0f0;
        }
        .searchable-select-item.disabled {
            cursor: not-allowed;
            color: #999;
        }

        a.phone-link {
            color: inherit;
            text-decoration: none;
        }
        a.phone-link:hover {
            text-decoration: underline;
        }

        .member-name-link {
            color: var(--dark-color);
            text-decoration: none;
            transition: color 0.2s;
        }
        .member-name-link:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }

        .absence-item, .birthday-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .absence-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .absence-item:hover {
            background-color: var(--light-color);
        }
        .absence-item:last-child, .birthday-item:last-child {
            border-bottom: none;
        }
        .absence-reason {
            color: #555;
            font-size: 0.9em;
            font-style: italic;
        }
        .birthday-icon {
            font-size: 1.5em;
        }
        
        .member-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .detail-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .detail-item strong {
            display: block;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 15px;
        }
        .pagination-controls .btn {
            text-transform: none;
        }
        .pagination-controls .page-info-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .attendance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            padding: 0;
            margin-bottom: 20px;
        }

        .modern-title {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            font-weight: 700;
            display: inline-block;
            font-size: 2.2em;
        }

        .member-info-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        @media (min-width: 768px) {
            .member-info-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        .member-info-main, .member-info-contact {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .member-info-contact h4 {
            font-size: 1.1em;
            color: var(--dark-color);
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 2px solid var(--primary-color);
        }

        .contact-card {
            background: var(--light-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .contact-card-header {
            background: #e9ecef;
            padding: 8px 12px;
            font-weight: 600;
            font-size: 0.9em;
            color: #495057;
        }
        .contact-card-body {
            padding: 12px;
        }
        .contact-card-body p {
            margin-bottom: 8px;
            font-size: 1em;
        }
        .contact-card-body p:last-child {
            margin-bottom: 0;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 992px) {
            .current-user-display { display: none; }
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
                transition: width 0.3s ease;
            }
            
            .sidebar:not(.collapsed) {
                width: 260px;
                z-index: 1001;
            }
            
            .sidebar.collapsed {
                width: 70px;
                z-index: 100;
            }
            
            .sidebar-header h2 {
                font-size: 24px;
                text-align: center;
            }
            
            .sidebar.collapsed .nav-text {
                display: none;
            }
            
            .sidebar.collapsed .dropdown-arrow {
                display: none;
            }
            
            .sidebar.collapsed .sidebar-header h2 span {
                display: none;
            }
            
            .sidebar.collapsed .current-user-display {
                display: none;
            }
            
            .sidebar.collapsed .nav-btn {
                justify-content: center;
            }
            
            .sidebar.collapsed #whatsapp-balance-container {
                flex-direction: column;
                padding: 2px 4px;
                gap: 0;
                font-size: 9px;
                min-width: 0;
                overflow: hidden;
            }
            
            .sidebar.collapsed #whatsapp-balance-container span:not(#whatsapp-balance) {
                display: none;
            }
            
            .sidebar.collapsed #whatsapp-balance {
                font-size: 10px;
                font-weight: bold;
            }
            
            .sidebar:not(.collapsed) #whatsapp-balance-container {
                flex-wrap: wrap;
                justify-content: center;
                gap: 4px;
                padding: 6px 8px;
            }
            
            .main-content-wrapper {
                margin-left: 70px;
                width: calc(100% - 70px);
            }
            
            .sidebar:not(.collapsed) ~ .main-content-wrapper {
                margin-left: 260px;
                width: calc(100% - 260px);
            }
            
            .admin-content { 
                padding: 15px;
            }
            
            .form-grid { 
                grid-template-columns: 1fr; 
            }
            
            .modal-content { 
                width: 95%; 
                margin: 10% auto; 
                padding: 20px; 
            }
            
            /* Member Edit Modal Mobile */
            .member-edit-modal {
                max-width: 100%;
                padding: 15px;
            }
            
            .modal-header h2 {
                font-size: 1.4em;
            }
            
            .form-section {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .section-header {
                flex-wrap: wrap;
            }
            
            .section-icon {
                width: 35px;
                height: 35px;
                font-size: 1.2em;
            }
            
            .section-title {
                font-size: 1em;
            }
            
            .required-badge,
            .optional-badge {
                font-size: 0.65em;
                padding: 3px 10px;
            }
            
            .modal-footer {
                flex-direction: column-reverse;
            }
            
            .modal-footer .btn {
                width: 100%;
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .pagination-controls {
                flex-direction: column;
            }
            
            .card-title {
                flex-direction: column;
                gap: 10px;
            }
            
            /* âœ… CRM Mobil Uyumluluk - GeliÅŸtirilmiÅŸ */
            .crm-grid {
                grid-template-columns: 1fr !important;
            }
            
            .crm-tabs {
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                margin-bottom: 15px;
            }
            
            .crm-tab-button {
                font-size: 12px !important;
                padding: 8px 12px !important;
            }
            
            .crm-card {
                margin-bottom: 15px;
            }
            
            .crm-card-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .crm-card-actions button {
                width: 100%;
            }
            
            /* ğŸ“± Tablo -> Kart GÃ¶rÃ¼nÃ¼mÃ¼ (TÃœM TABLOLAR) */
            .data-table,
            #crm-leads-list table,
            #member-payment-list table,
            table.data-table {
                display: block !important;
                overflow-x: visible !important;
            }
            
            .data-table thead,
            #crm-leads-list thead,
            #member-payment-list thead,
            table.data-table thead {
                display: block !important;
            }
            
            .data-table thead tr,
            #crm-leads-list thead tr,
            #member-payment-list thead tr,
            table.data-table thead tr {
                position: absolute !important;
                top: -9999px !important;
                left: -9999px !important;
            }
            
            .data-table tbody,
            #crm-leads-list tbody,
            #member-payment-list tbody,
            table.data-table tbody {
                display: block !important;
            }
            
            .data-table tr,
            #crm-leads-list tr,
            #member-payment-list tr,
            table.data-table tr {
                display: block !important;
                border: 1px solid #ddd !important;
                margin-bottom: 15px !important;
                border-radius: 8px !important;
                background: white !important;
                padding: 15px !important;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            }
            
            .data-table td,
            #crm-leads-list td,
            #member-payment-list td,
            table.data-table td {
                display: block !important;
                border: none !important;
                position: relative !important;
                padding: 8px 0 !important;
                padding-left: 45% !important;
                text-align: left !important;
                word-wrap: break-word !important;
            }
            
            .data-table td:before,
            #crm-leads-list td:before,
            #member-payment-list td:before,
            table.data-table td:before {
                content: attr(data-label) !important;
                position: absolute !important;
                left: 10px !important;
                width: 40% !important;
                padding-right: 10px !important;
                white-space: nowrap !important;
                font-weight: 600 !important;
                color: #666 !important;
                font-size: 12px !important;
            }
            
            /* CRM Leads Ã¶zel etiketleri */
            #crm-leads-list td:nth-of-type(1):before { content: "Ad Soyad:" !important; }
            #crm-leads-list td:nth-of-type(2):before { content: "Telefon:" !important; }
            #crm-leads-list td:nth-of-type(3):before { content: "BranÅŸ:" !important; }
            #crm-leads-list td:nth-of-type(4):before { content: "Durum:" !important; }
            #crm-leads-list td:nth-of-type(5):before { content: "Kaynak:" !important; }
            #crm-leads-list td:nth-of-type(6):before { content: "Deneme:" !important; }
            #crm-leads-list td:nth-of-type(7):before { content: "OluÅŸturma:" !important; }
            #crm-leads-list td:nth-of-type(8):before { content: "Ä°ÅŸlemler:" !important; }
            
            /* Son sÃ¼tun (Ä°ÅŸlemler) Ã¶zel stil */
            .data-table td:last-child,
            #crm-leads-list td:last-child,
            table.data-table td:last-child {
                padding-left: 10px !important;
                display: flex !important;
                gap: 5px !important;
                flex-wrap: wrap !important;
                margin-top: 10px !important;
                padding-top: 10px !important;
                border-top: 1px solid #eee !important;
            }
            
            .data-table td:last-child button,
            #crm-leads-list td:last-child button,
            table.data-table td:last-child button {
                flex: 1 1 auto !important;
                min-width: 80px !important;
            }
            
            .data-table td:last-child:before,
            #crm-leads-list td:last-child:before,
            table.data-table td:last-child:before {
                display: none !important;
            }
            
            /* Checkbox ve radio hÃ¼creler */
            .data-table td:first-child:has(input[type="checkbox"]),
            table.data-table td:first-child:has(input[type="checkbox"]) {
                padding-left: 10px !important;
            }
            
            .data-table td:first-child:has(input[type="checkbox"]):before,
            table.data-table td:first-child:has(input[type="checkbox"]):before {
                display: none !important;
            }
            
            /* ğŸ“± CRM Dashboard Stats Grid */
            #crm-dashboard .stats-grid,
            #branch-tag-stats {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            .stat-card {
                padding: 15px !important;
            }
            
            .stat-number {
                font-size: 24px !important;
            }
            
            .stat-label {
                font-size: 13px !important;
            }
            
            /* ğŸ“± CRM Filtreler Mobil */
            #crm-filter .form-grid,
            .filter-controls {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            #crm-filter select,
            #crm-filter input {
                font-size: 14px !important;
            }
            
            /* ğŸ“± CRM Modal Detay SayfasÄ± */
            #customer-detail-content {
                padding: 10px !important;
            }
            
            .customer-detail-header {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .customer-detail-tabs {
                overflow-x: auto !important;
                white-space: nowrap !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            .customer-detail-tabs button {
                font-size: 12px !important;
                padding: 8px 12px !important;
            }
            
            /* ğŸ“± CRM Notlar ve GeÃ§miÅŸ */
            .note-item,
            .history-item {
                padding: 10px !important;
                font-size: 13px !important;
            }
            
            /* ğŸ“± CRM Etiket YÃ¶netimi */
            .tag-badge {
                font-size: 11px !important;
                padding: 4px 8px !important;
            }
            
            /* Gelen/Giden Aramalar Grid */
            div[style*="grid-template-columns: repeat(auto-fill"] {
                grid-template-columns: 1fr !important;
            }
            
            /* ğŸ“± Gelen Aramalar Kart GÃ¶rÃ¼nÃ¼mÃ¼ */
            .call-card {
                padding: 12px !important;
                margin-bottom: 10px !important;
            }
            
            .call-card-header {
                flex-direction: column !important;
                gap: 5px !important;
                align-items: flex-start !important;
            }
            
            .call-card-actions {
                display: flex !important;
                flex-direction: column !important;
                gap: 5px !important;
                width: 100% !important;
                margin-top: 10px !important;
            }
            
            .call-card-actions button {
                width: 100% !important;
                font-size: 12px !important;
            }
            
            /* ğŸ“± Arama Sekmeleri */
            .incoming-calls-tabs {
                overflow-x: auto !important;
                white-space: nowrap !important;
                -webkit-overflow-scrolling: touch !important;
                padding-bottom: 5px !important;
            }
            
            .incoming-calls-tabs button {
                font-size: 11px !important;
                padding: 8px 10px !important;
                min-width: auto !important;
            }
            
            /* Dropdown menÃ¼ler mobilde Ã¼stte gÃ¶ster */
            div[id^="dropdown-"] {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                width: 90% !important;
                max-width: 300px !important;
                z-index: 999999 !important;
            }
            
            /* Modal iÃ§erikleri mobilde scroll */
            .modal-body {
                max-height: 70vh;
                overflow-y: auto;
            }
            
            /* ğŸ“± Form Inputlar Mobilde Daha BÃ¼yÃ¼k */
            .form-control,
            input[type="text"],
            input[type="tel"],
            input[type="email"],
            input[type="date"],
            input[type="datetime-local"],
            select,
            textarea {
                font-size: 16px !important; /* iOS zoom engellemek iÃ§in */
            }
            
            /* ğŸ“± Butonlar Mobilde Touch-Friendly */
            .btn {
                min-height: 44px !important;
                padding: 10px 15px !important;
            }
            
            .btn-sm {
                min-height: 36px !important;
                padding: 8px 12px !important;
            }
        }
        
        /* ğŸ“± Ã‡ok KÃ¼Ã§Ã¼k Ekranlar (Telefonlar) */
        @media (max-width: 480px) {
            .sidebar {
                width: 60px !important;
            }
            
            .sidebar:hover {
                width: 220px !important;
            }
            
            .main-content-wrapper {
                margin-left: 60px !important;
                width: calc(100% - 60px) !important;
            }
            
            .admin-content {
                padding: 10px !important;
            }
            
            /* CRM Leads Kart DÃ¼zeni */
            #crm-leads-list td {
                padding-left: 50% !important;
                font-size: 13px !important;
            }
            
            #crm-leads-list td:before {
                width: 45% !important;
                font-size: 11px !important;
            }
            
            #crm-leads-list tr {
                padding: 12px !important;
            }
            
            /* Modal Tam Ekran */
            .modal-content {
                width: 100% !important;
                height: 100vh !important;
                margin: 0 !important;
                border-radius: 0 !important;
                max-height: 100vh !important;
            }
            
            .modal-header {
                padding: 12px !important;
            }
            
            .modal-body {
                padding: 12px !important;
                max-height: calc(100vh - 120px) !important;
            }
            
            /* CRM Dashboard */
            .stat-card {
                padding: 12px !important;
            }
            
            .stat-number {
                font-size: 20px !important;
            }
            
            .stat-label {
                font-size: 11px !important;
            }
            
            /* BaÅŸlÄ±klar */
            h2 {
                font-size: 18px !important;
            }
            
            h3 {
                font-size: 16px !important;
            }
            
            /* Sekme ButonlarÄ± */
            .crm-tab-button,
            .customer-detail-tabs button,
            .incoming-calls-tabs button {
                font-size: 10px !important;
                padding: 6px 8px !important;
            }
            
            /* Tablo ButonlarÄ± */
            #crm-leads-list td:last-child button {
                min-width: 70px !important;
                font-size: 11px !important;
                padding: 6px 8px !important;
            }
        }
        
        @media (min-width: 769px) {
            .admin-content {
                max-width: 1600px;
                margin: 0 auto;
            }
        }
        
        /* Settings Subsection Styling */
        .settings-subsection {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2f9 100%);
            border: 1px solid #e0e5f0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.3s ease;
        }
        
        .settings-subsection:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }
        
        .settings-subtitle {
            font-size: 1.3em;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-subsection textarea.form-control {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            transition: all 0.2s ease;
            resize: vertical;
            min-height: 120px;
        }
        
        .settings-subsection textarea.form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: #fafbff;
        }
        
        .settings-subsection small {
            display: inline-block;
            margin-top: 6px;
            padding: 6px 12px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }
        
        .settings-subsection small code {
            background: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
            color: #667eea;
            border: 1px solid #e2e8f0;
        }
        
        .expense-category-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            cursor: default;
            position: relative;
        }
        
        .expense-category-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }
        
        .expense-category-card .delete-category-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .expense-category-card:hover .delete-category-btn {
            display: flex;
        }
        
        .expense-category-card .delete-category-btn:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }
    </style>
    <!-- SheetJS for Excel export with dropdowns -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body style="visibility: hidden;">
    <div id="main-wrapper" style="display: flex;">
        <!-- âœ… Sol Sidebar MenÃ¼ -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <button onclick="toggleSidebar()" style="background: transparent; border: none; color: white; font-size: 20px; cursor: pointer; padding: 5px; margin: 0;" title="MenÃ¼yÃ¼ aÃ§/kapat">
                        â˜°
                    </button>
                    <h2 style="margin: 0; flex: 1; text-align: center; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 5px;"><span id="club-title">Sporcum</span></h2>
                    <div style="width: 34px;"></div> <!-- BoÅŸluk iÃ§in -->
                </div>
                <div id="whatsapp-balance-container" style="text-align: center; font-size: 11px; color: white; padding: 6px 8px; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; gap: 6px; max-width: 100%; overflow: hidden; box-sizing: border-box;">
                    <span style="font-size: 14px; flex-shrink: 0;">ğŸ’¬</span>
                    <span style="opacity: 0.9; white-space: nowrap;">Bakiye:</span>
                    <span id="whatsapp-balance" style="font-weight: bold; font-size: 13px; white-space: nowrap;">âˆ</span>
                </div>
            </div>
            
            <div class="sidebar-menu">
                <!-- Ana Sayfa -->
                <button class="nav-btn active" onclick="showSection('dashboard', this)">
                    <span class="nav-icon">ğŸ“Š</span>
                    <span class="nav-text">Ana Sayfa</span>
                </button>
                
                <!-- YÃ¶netim Dropdown -->
                <div class="nav-dropdown">
                    <button class="nav-btn dropdown-toggle">
                        <span class="nav-icon">ğŸ› ï¸</span>
                        <span class="nav-text">YÃ¶netim</span>
                        <span class="dropdown-arrow">â–¼</span>
                    </button>
                    <div class="dropdown-content">
                        <button class="nav-btn sub-item" onclick="showSection('registration-procedures', this)">
                            <span class="nav-text">ğŸ“‘ KayÄ±t Ä°ÅŸlemleri</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('members', this); hideMemberDetail()">
                            <span class="nav-text">ğŸ‘¥ Ãœyeler</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('pending-members', this)">
                            <span class="nav-text">â³ Bekleyen Ãœyeler</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('inactive-members', this)">
                            <span class="nav-text">â¸ï¸ Pasif Ãœyeler</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('groups', this)">
                            <span class="nav-text">â­ Gruplar</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('schedule', this)">
                            <span class="nav-text">ğŸ“… Ders PlanÄ±</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('tasks', this)">
                            <span class="nav-text">âœ… GÃ¶revlerim</span>
                        </button>
                    </div>
                </div>
                
                <!-- Muhasebe Dropdown -->
                <div class="nav-dropdown">
                    <button class="nav-btn dropdown-toggle">
                        <span class="nav-icon">ğŸ’µ</span>
                        <span class="nav-text">Muhasebe</span>
                        <span class="dropdown-arrow">â–¼</span>
                    </button>
                    <div class="dropdown-content">
                        <button class="nav-btn sub-item" onclick="showSection('payments', this)">
                            <span class="nav-text">ğŸ’³ Aidatlar</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('expenses', this)">
                            <span class="nav-text">ğŸ’¸ Giderler</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('accounting-summary', this)">
                            <span class="nav-text">ğŸ“Š Muhasebe Ã–zeti</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('products', this)">
                            <span class="nav-text">ğŸ›ï¸ ÃœrÃ¼nler</span>
                        </button>
                    </div>
                </div>
                
                <!-- WhatsApp Dropdown -->
                <div class="nav-dropdown">
                    <button class="nav-btn dropdown-toggle">
                        <span class="nav-icon">ğŸ’¬</span>
                        <span class="nav-text">WhatsApp</span>
                        <span class="dropdown-arrow">â–¼</span>
                    </button>
                    <div class="dropdown-content">
                        <button class="nav-btn sub-item" onclick="showSection('whatsapp', this); switchWhatsAppTab('messages')">
                            <span class="nav-text">ï¿½ MesajlaÅŸma</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('whatsapp', this); switchWhatsAppTab('devices')">
                            <span class="nav-text">ï¿½ Cihazlar</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('whatsapp', this); switchWhatsAppTab('bulk')">
                            <span class="nav-text">ï¿½ Toplu Mesaj</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('whatsapp', this); switchWhatsAppTab('queue')">
                            <span class="nav-text">ï¿½ Mesaj KuyruÄŸu</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('whatsapp', this); switchWhatsAppTab('reports')">
                            <span class="nav-text">ï¿½ Mesaj RaporlarÄ±</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('whatsapp-balance', this)">
                            <span class="nav-text">ï¿½ WhatsApp Bakiyem</span>
                        </button>
                    </div>
                </div>
                
                <!-- CRM Dropdown -->
                <div id="crm-menu-dropdown" class="nav-dropdown">
                    <button class="nav-btn dropdown-toggle">
                        <span class="nav-icon">ğŸ‘¤</span>
                        <span class="nav-text">CRM</span>
                        <span class="dropdown-arrow">â–¼</span>
                    </button>
                    <div class="dropdown-content">
                        <button class="nav-btn sub-item" onclick="showSection('crm', this)">
                            <span class="nav-text">ğŸ“‹ CRM Ana Sayfa</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('crm-incoming-calls', this)">
                            <span class="nav-text">ğŸ“ Gelen Aramalar</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('crm-outgoing-calls', this)">
                            <span class="nav-text">ğŸ“² Giden Aramalar</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('crm-filter', this)">
                            <span class="nav-text">ğŸ” MÃ¼ÅŸteri Filtrele</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('crm-trials', this)">
                            <span class="nav-text">ğŸ¯ Denemeler</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('crm-tags', this)">
                            <span class="nav-text">ğŸ·ï¸ Etiketler</span>
                        </button>
                        <button class="nav-btn sub-item" onclick="showSection('crm-templates', this)">
                            <span class="nav-text">ğŸ“ CRM Mesaj ÅablonlarÄ±</span>
                        </button>
                    </div>
                </div>
                
                <!-- Ayarlar (En Alt) -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid rgba(255,255,255,0.1);">
                    <button class="nav-btn" onclick="showSection('settings', this)">
                        <span class="nav-icon">âš™ï¸</span>
                        <span class="nav-text">Ayarlar</span>
                    </button>
                    <button class="nav-btn" onclick="showSection('user-activities', this)">
                        <span class="nav-icon">ğŸ“</span>
                        <span class="nav-text">KullanÄ±cÄ± Hareketleri</span>
                    </button>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="current-user-display" style="margin-bottom: 10px; font-size: 12px;"></div>
                <button id="logout-btn-sidebar" class="btn btn-danger" style="width: 100%; padding: 10px; font-size: 13px;">
                    ğŸšª Ã‡Ä±kÄ±ÅŸ Yap
                </button>
            </div>
        </nav>

        <!-- âœ… Ana Ä°Ã§erik AlanÄ± -->
        <div class="main-content-wrapper">
            <div class="admin-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                    <h2 class="card-title" style="margin: 0;">Ana Sayfa</h2>
                    <button id="toggle-dashboard-amounts-btn" onclick="toggleDashboardAmounts()" style="background: none; border: none; cursor: pointer; font-size: 20px; padding: 5px; transition: all 0.2s;" title="TutarlarÄ± Gizle/GÃ¶ster">
                        ğŸ‘ï¸
                    </button>
                </div>
                <div class="stats-grid" id="dashboard-stats-grid">
                    <div class="stat-card" onclick="navigateToSection('members')">
                        <div class="stat-number" id="totalMembers">0</div>
                        <div class="stat-label">Toplam Ãœye</div>
                    </div>
                    <div class="stat-card" onclick="navigateToSection('members')">
                        <div class="stat-number" id="activeMembers">0</div>
                        <div class="stat-label">Aktif Ãœye</div>
                    </div>
                    <div class="stat-card" onclick="navigateToSection('registration-procedures')">
                        <div class="stat-number" id="pendingRegistrations">0</div>
                        <div class="stat-label">Bekleyen KayÄ±tlar</div>
                    </div>
                    <div class="stat-card" onclick="navigateToSection('inactive-members')">
                        <div class="stat-number" id="inactiveMembers">0</div>
                        <div class="stat-label">Pasif Ãœyeler</div>
                    </div>
                    <div class="stat-card" onclick="navigateToSection('payments')">
                        <div class="stat-number" id="monthlyRevenue">0â‚º</div>
                        <div class="stat-label">Bu Ay Toplam Ciro</div>
                        <div class="stat-comparison" id="revenueComparison"></div>
                    </div>
                </div>
                
                <div class="dashboard-grid">
                    <div class="card">
                        <h3 class="card-title" style="cursor: pointer;" onclick="showSection('attendance-tracking', document.querySelector('.nav-btn[onclick*=attendance]'))">ğŸƒâ€â™‚ï¸ Son DevamsÄ±zlÄ±klar</h3>
                        <div id="absentStudentsList">
                            <div class="loading">
                                <div class="spinner"></div>
                                <span>YÃ¼kleniyor...</span>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3 class="card-title">ğŸ‚ YaklaÅŸan DoÄŸum GÃ¼nleri</h3>
                        <div id="upcomingBirthdaysList">
                             <div class="loading">
                                <div class="spinner"></div>
                                <span>YÃ¼kleniyor...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WhatsApp Balance Section -->
            <div id="whatsapp-balance" class="section">
                <h2 class="card-title">ğŸ’° WhatsApp Bakiyem</h2>
                
                <div id="whatsapp-balance-content" style="display: flex; flex-direction: column; gap: 25px;">
                    <div class="loading" style="text-align: center; padding: 40px;">
                        <div class="spinner"></div>
                        <span>YÃ¼kleniyor...</span>
                    </div>
                </div>
            </div>

            <!-- Registration Procedures Section -->
            <div id="registration-procedures" class="section">
                <div class="card">
                    <h3 class="card-title">Yeni KayÄ±t Ekle</h3>
                    <div class="registration-forms-container">
                        <div class="registration-form-wrapper">
                             <h4 style="font-size: 1.2em; margin-bottom: 15px;">ğŸ“ Yeni KayÄ±t OluÅŸtur</h4>
                             <form id="preRegistrationForm">
                                 <div class="form-grid">
                                     <div class="form-group"><label for="memberTypePre">KayÄ±t Tipi *</label><select class="form-control" name="memberType" id="memberTypePre" required><option value="child">Ã‡ocuk</option><option value="adult">YetiÅŸkin</option></select></div>
                                     <div class="form-group" id="parentName1Group"><label for="parentNamePre">Veli AdÄ± SoyadÄ± *</label><input type="text" id="parentNamePre" class="form-control" name="parentName"></div>
                                     <div class="form-group" id="phone1Group"><label for="preRegPhonePre">Veli Telefon *</label><input type="tel" id="preRegPhonePre" class="form-control" name="phone" required pattern="0[0-9]{10}" maxlength="11"></div>
                                     <div class="form-group" id="parentName2Group"><label for="parentName2Pre">Veli 2 AdÄ± SoyadÄ± (Ä°steÄŸe BaÄŸlÄ±)</label><input type="text" id="parentName2Pre" class="form-control" name="parentName2"></div>
                                     <div class="form-group" id="phone2Group"><label for="preRegPhone2Pre">Veli 2 Telefon</label><input type="tel" id="preRegPhone2Pre" class="form-control" name="phone2" pattern="0[0-9]{10}" maxlength="11"></div>
                                     <div class="form-group"><label for="preRegBranchPre">BranÅŸ *</label><select class="form-control" name="branch" id="preRegBranchPre" required><option value="">SeÃ§iniz...</option><option value="tenis">ğŸ¾ Tenis</option><option value="yuzme">ğŸŠ YÃ¼zme</option></select></div>
                                 </div>
                                 
                                 <!-- Ã–ÄŸrenci Bilgileri (Ã‡oklu) -->
                                 <div id="studentsContainer" style="display: none; margin-top: 20px;">
                                     <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                         <h4 style="margin: 0;">ğŸ‘¶ Ã–ÄŸrenci Bilgileri</h4>
                                         <button type="button" class="btn btn-sm btn-success" onclick="addStudentField()" id="addStudentBtn">â• Ã–ÄŸrenci Ekle</button>
                                     </div>
                                     <p style="font-size: 13px; color: #666; margin-bottom: 15px;">â„¹ï¸ Her Ã¶ÄŸrenci iÃ§in ayrÄ± kayÄ±t ve Ã¶deme planÄ± oluÅŸturulacaktÄ±r.</p>
                                     <div id="studentFieldsContainer">
                                         <div class="student-field-group" data-student-index="0">
                                             <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; position: relative; border-left: 4px solid #4CAF50;">
                                                 <h5 style="margin: 0 0 15px 0; color: #333;">Ã–ÄŸrenci 1</h5>
                                                 <div class="form-grid">
                                                    <div class="form-group"><label>Ad Soyad *</label><input type="text" class="form-control student-name" name="studentName_0" required></div>
                                                    <div class="form-group"><label>DoÄŸum Tarihi</label><input type="date" class="form-control student-birthdate" name="studentBirthDate_0"></div>
                                                 </div>
                                             </div>
                                         </div>
                                     </div>
                                 </div>
                                 
                                 <!-- YetiÅŸkin iÃ§in tek Ã¶ÄŸrenci alanÄ± -->
                                 <div id="singleStudentContainer" style="display: none; margin-top: 20px;">
                                    <h4 style="margin-bottom: 15px;">ğŸ‘¨ Ãœye Bilgileri</h4>
                                    <div class="form-grid" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                        <div class="form-group"><label for="studentNamePre">Ad Soyad *</label><input type="text" id="studentNamePre" class="form-control" name="studentName" required></div>
                                        <div class="form-group"><label for="studentBirthDatePre">DoÄŸum Tarihi</label><input type="date" id="studentBirthDatePre" class="form-control" name="studentBirthDate"></div>
                                     </div>
                                 </div>
                                 
                                 <div class="form-grid" style="margin-top: 20px;">
                                     <div class="form-group">
                                         <label for="preRegGroupSearch">Grup</label>
                                         <div class="searchable-select-container">
                                             <input type="text" id="preRegGroupSearch" class="form-control" placeholder="Ã–nce branÅŸ seÃ§in" autocomplete="off" disabled>
                                             <input type="hidden" name="groupId" id="preRegGroupId">
                                             <div class="searchable-select-results" id="preRegGroupResults"></div>
                                         </div>
                                     </div>
                                 </div>
                                 <hr style="margin: 20px 0;">
                                 <h4 style="margin-bottom: 15px;">Ã–deme PlanÄ±</h4>
                                 <div class="form-grid">
                                     <div class="form-group"><label>Ä°lk DÃ¶nem BaÅŸlangÄ±Ã§ *</label><input type="date" class="form-control" name="firstPeriodStart" required></div>
                                     <div class="form-group"><label>Ä°lk DÃ¶nem BitiÅŸ *</label><input type="date" class="form-control" name="firstPeriodEnd" required></div>
                                     <div class="form-group"><label>Ä°lk DÃ¶nem Ders SayÄ±sÄ±</label><input type="number" class="form-control" name="firstLessonCount"></div>
                                     <div class="form-group"><label>Ä°lk DÃ¶nem Ãœcreti (TL) *</label><input type="text" class="form-control" name="firstInstallmentAmount" required></div>
                                     <div class="form-group"><label>Ä°lk DÃ¶nem Son Ã–deme *</label><input type="date" class="form-control" name="firstDueDate" required></div>
                                     <div class="form-group"><label>Sonraki Taksit SayÄ±sÄ±</label><input type="number" class="form-control" name="installments" value="6" min="0"></div>
                                     <div class="form-group"><label>Sonraki Taksit Ãœcreti (TL)</label><input type="text" class="form-control" name="subsequentInstallmentAmount"></div>
                                     <div class="form-group"><label>Ã–deme GÃ¼nÃ¼</label><input type="number" class="form-control" name="dueDay" value="20" min="1" max="31"></div>
                                 </div>
                                 <div class="form-group"><label>Notlar</label><textarea class="form-control" name="notes" rows="2"></textarea></div>
                                 <div class="payment-plan-preview" style="margin-top: 20px;"></div>
                                 <button type="submit" class="btn btn-primary" style="margin-top: 20px;">ğŸ“ KayÄ±t OluÅŸtur</button>
                               </form>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">ğŸ“‹ Bekleyen KayÄ±tlar</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ad Soyad</th>
                                    <th>Veli AdÄ±</th>
                                    <th>Telefon</th>
                                    <th>BranÅŸ</th>
                                    <th>Durum</th>
                                    <th>Grup</th>
                                    <th>Ä°ÅŸlemler</th>
                                </tr>
                            </thead>
                            <tbody id="preRegistrationTable"></tbody>
                        </table>
                    </div>
                </div>

            </div>

            <!-- Bekleyen Ãœyeler Section -->
            <div id="pending-members" class="section">
                <div class="card">
                    <h3 class="card-title">â³ Bekleyen Ãœyeler</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ad Soyad</th>
                                    <th>Veli AdÄ±</th>
                                    <th>Telefon</th>
                                    <th>BranÅŸ</th>
                                    <th>Durum</th>
                                    <th>Ä°ÅŸlemler</th>
                                </tr>
                            </thead>
                            <tbody id="pendingMembersTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pasif Ãœyeler Section -->
            <div id="inactive-members" class="section">
                <div class="card">
                    <h3 class="card-title">â¸ï¸ Pasif Ãœyeler</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ad Soyad</th>
                                    <th>Veli AdÄ±</th>
                                    <th>Telefon</th>
                                    <th>BranÅŸ</th>
                                    <th>Durum</th>
                                    <th>Ä°ÅŸlemler</th>
                                </tr>
                            </thead>
                            <tbody id="inactiveMembersTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Members Section -->
            <div id="members" class="section">
                <!-- Ãœye Detay AlanÄ± (Ãœyeye tÄ±klanÄ±nca gÃ¶sterilecek) -->
                <div id="member-detail-content" style="display: none;"></div>
                
                <div class="card" id="members-list-card">
                    <div class="card-title">
                        <h3>ğŸ‘¥ Ãœyeler</h3>
                        <input type="text" id="memberSearch" class="form-control search-input" placeholder="Ãœye ara (Ä°sim, Telefon)...">
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ãœye</th>
                                    <th>Veli</th>
                                    <th>Telefon</th>
                                    <th onclick="sortMembersByAge()" style="cursor: pointer;">YaÅŸ</th>
                                    <th>BranÅŸ</th>
                                    <th>Durum</th>
                                    <th>Grup</th>
                                    <th>Ä°ÅŸlemler</th>
                                </tr>
                            </thead>
                            <tbody id="membersTable"></tbody>
                        </table>
                    </div>
                    <div class="pagination-controls">
                        <div class="page-info-group">
                             <label for="itemsPerPage">Sayfa baÅŸÄ±na:</label>
                            <select id="itemsPerPage" class="form-control" onchange="changeMembersItemsPerPage(this)">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <div class="page-nav-group">
                            <button id="prevPageBtn" class="btn btn-secondary" onclick="changeMembersPage(-1)">Ã–nceki</button>
                            <span id="pageInfo" style="padding: 0 15px; font-weight: 500;">Sayfa 1 / 1</span>
                            <button id="nextPageBtn" class="btn btn-secondary" onclick="changeMembersPage(1)">Sonraki</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payments Section -->
            <div id="payments" class="section">
                <div class="card">
                    <div class="card-title">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <h3 style="margin: 0;">ğŸ’° Ã–deme Takibi</h3>
                            <button id="toggle-payment-visibility-btn" onclick="togglePaymentVisibility()" style="background: none; border: none; cursor: pointer; font-size: 20px; padding: 5px; transition: all 0.2s;" title="TutarlarÄ± Gizle/GÃ¶ster">
                                ğŸ‘ï¸
                            </button>
                        </div>
                        <input type="text" id="paymentSearch" class="form-control search-input" placeholder="Ãœye ara (Ä°sim, Telefon)...">
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 15px;">
                        <div class="btn-group">
                             <button class="btn btn-primary btn-sm active" onclick="setPaymentFilter('all', this)">TÃ¼m Ãœyeler</button>
                             <button class="btn btn-info btn-sm" onclick="setPaymentFilter('paidThisMonth', this)">ğŸ’³ Bu Ay Ã–denen</button>
                             <button class="btn btn-danger btn-sm" onclick="setPaymentFilter('overdue', this)">GecikmiÅŸ Ã–demeler <span id="overdue-count"></span></button>
                             <button class="btn btn-success btn-sm" onclick="setPaymentFilter('finished', this)">PlanÄ± Bitenler <span id="finished-count"></span></button>
                        </div>
                        <!-- âœ… GecikmiÅŸ Ã¶demelere toplu mesaj butonu -->
                        <button class="btn btn-warning btn-sm" onclick="sendBulkOverdueReminders()" style="margin-left: auto;">
                            ğŸ“¢ GecikmiÅŸ Ã–demelere Toplu Mesaj
                        </button>
                    </div>
                    <div class="stats-grid" id="payment-stats" style="margin-top:20px;">
                        <div class="stat-card" style="cursor: pointer; transition: transform 0.2s;" onclick="showSection('payments'); document.getElementById('payment-filter').value='all'; loadPayments();" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div class="stat-number" id="totalRevenue">0â‚º</div>
                            <div class="stat-label">ğŸ“Š Bu Ay Vadesi Gelen Toplam</div>
                            <div style="font-size: 11px; color: #999; margin-top: 5px;">Tahsil edilen + Bekleyen</div>
                        </div>
                        <div class="stat-card" style="cursor: pointer; transition: transform 0.2s; border-color: #4caf50;" onclick="showSection('payments'); setPaymentFilter('paidThisMonth');" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div class="stat-number" id="totalPaid" style="color: #4caf50;">0â‚º</div>
                            <div class="stat-label">âœ… Bu Ay Tahsil Edilen</div>
                            <div style="font-size: 11px; color: #999; margin-top: 5px;">Ã–deme tarihi bu ay olanlar</div>
                        </div>
                        <div class="stat-card" style="cursor: pointer; transition: transform 0.2s; border-color: #ff9800;" onclick="showSection('payments'); setPaymentFilter('unpaidThisMonth');" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div class="stat-number" id="totalUnpaid" style="color: #ff9800;">0â‚º</div>
                            <div class="stat-label">â³ Bu Ay Alacaklar</div>
                            <div style="font-size: 11px; color: #999; margin-top: 5px;">Vadesi bu ay, Ã¶denmemiÅŸ</div>
                        </div>
                    </div>
                     <div id="overdue-stats-container" class="stats-grid" style="display: none; margin-top: 20px;">
                        <div class="stat-card" style="border-color: var(--danger-color);">
                            <div class="stat-number" id="overdue-total-amount" style="color: var(--danger-color);">0â‚º</div>
                            <div class="stat-label">Toplam GecikmiÅŸ Tutar</div>
                        </div>
                        <div class="stat-card" style="border-color: var(--danger-color);">
                            <div class="stat-number" id="overdue-member-count" style="color: var(--danger-color);">0</div>
                            <div class="stat-label">Gecikmesi Olan KiÅŸi SayÄ±sÄ±</div>
                        </div>
                    </div>
                    <div id="member-payment-list" class="payment-member-list">
                         <div class="loading">
                             <div class="spinner"></div>
                             <span>Ãœyeler yÃ¼kleniyor...</span>
                         </div>
                    </div>
                </div>
            </div>

            <!-- Expenses Section (Giderler) -->
            <div id="expenses" class="section">
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                        <h2>ğŸ’¸ Giderler</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="openExpenseCategoryManager()">
                                ğŸ“‚ Kategori YÃ¶netimi
                            </button>
                            <button class="btn btn-primary" onclick="openAddExpenseModal()">
                                â• Gider Ekle
                            </button>
                        </div>
                    </div>
                    
                    <!-- HÄ±zlÄ± Filtreler -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn" onclick="setExpensePeriod('today')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; font-weight: 600; border-radius: 10px; box-shadow: 0 4px 8px rgba(102,126,234,0.3);">
                            ğŸ“… BugÃ¼n
                        </button>
                        <button class="btn" onclick="setExpensePeriod('week')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 12px 20px; font-weight: 600; border-radius: 10px; box-shadow: 0 4px 8px rgba(240,147,251,0.3);">
                            ğŸ“† Son 1 Hafta
                        </button>
                        <button class="btn" onclick="setExpensePeriod('month')" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 12px 20px; font-weight: 600; border-radius: 10px; box-shadow: 0 4px 8px rgba(79,172,254,0.3);">
                            ğŸ“Š Bu Ay
                        </button>
                        <button class="btn" onclick="setExpensePeriod('lastMonth')" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 12px 20px; font-weight: 600; border-radius: 10px; box-shadow: 0 4px 8px rgba(67,233,123,0.3);">
                            ğŸ“ˆ GeÃ§en Ay
                        </button>
                        <button class="btn" onclick="setExpensePeriod('year')" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 12px 20px; font-weight: 600; border-radius: 10px; box-shadow: 0 4px 8px rgba(250,112,154,0.3);">
                            ğŸ“… Bu YÄ±l
                        </button>
                    </div>
                    
                    <!-- Filtreler - Modern TasarÄ±m -->
                    <div style="background: linear-gradient(135deg, #f44336 0%, #e53935 100%); padding: 20px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 8px 16px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="font-size: 24px;">ğŸ”</span>
                            <h3 style="color: white; margin: 0; font-size: 18px; font-weight: 600;">DetaylÄ± Filtreler</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #333;">
                                    <span style="font-size: 18px;">ğŸ“…</span>
                                    BaÅŸlangÄ±Ã§ Tarihi
                                </label>
                                <input type="date" id="expensesStartDate" class="form-control" onchange="renderExpensesPage()" style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; font-size: 14px;">
                            </div>
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #333;">
                                    <span style="font-size: 18px;">ğŸ“…</span>
                                    BitiÅŸ Tarihi
                                </label>
                                <input type="date" id="expensesEndDate" class="form-control" onchange="renderExpensesPage()" style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; font-size: 14px;">
                            </div>
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #333;">
                                    <span style="font-size: 18px;">ğŸ“‚</span>
                                    Kategori
                                </label>
                                <select id="expensesCategoryFilter" class="form-control" onchange="renderExpensesPage()" style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; font-size: 14px; cursor: pointer;">
                                    <option value="all">ğŸ“‹ TÃ¼m Kategoriler</option>
                                    <option value="Kira">ğŸ  Kira</option>
                                    <option value="MaaÅŸ">ğŸ’° MaaÅŸ</option>
                                    <option value="Fatura">ğŸ“„ Fatura</option>
                                    <option value="Malzeme">ğŸ”§ Malzeme</option>
                                    <option value="DiÄŸer">ğŸ“¦ DiÄŸer</option>
                                </select>
                            </div>
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #333;">
                                    <span style="font-size: 18px;">ğŸ¢</span>
                                    BranÅŸ
                                </label>
                                <select id="expensesBranchFilter" class="form-control" onchange="renderExpensesPage()" style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; font-size: 14px; cursor: pointer;">
                                    <option value="all">ğŸŒ TÃ¼m BranÅŸlar</option>
                                </select>
                            </div>
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; align-items: flex-end;">
                                <button class="btn btn-light" onclick="resetExpensesFilters()" style="width: 100%; padding: 10px; border: 2px solid #fff; border-radius: 8px; font-weight: 600; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; box-shadow: 0 4px 8px rgba(255,152,0,0.3);">
                                    ğŸ”„ Filtreleri SÄ±fÄ±rla
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="expensesPageContainer">
                        <div class="loading"><div class="spinner"></div><span>Giderler yÃ¼kleniyor...</span></div>
                    </div>
                </div>
            </div>

            <!-- Accounting Summary Section (Muhasebe Ã–zeti) -->
            <div id="accounting-summary" class="section">
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                        <h2>ğŸ“Š Muhasebe Ã–zeti</h2>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="openAddExpenseModal()">
                                â• Gider Ekle
                            </button>
                            <button class="btn btn-secondary" onclick="openAddProductModal()">
                                â• ÃœrÃ¼n Ekle
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtreler - Modern TasarÄ±m -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 8px 16px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span style="font-size: 24px;">ğŸ”</span>
                            <h3 style="color: white; margin: 0; font-size: 18px; font-weight: 600;">Filtreler</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px;">
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #333;">
                                    <span style="font-size: 18px;">ğŸ“…</span>
                                    BaÅŸlangÄ±Ã§ Tarihi
                                </label>
                                <input type="date" id="summaryStartDate" class="form-control" onchange="renderAccountingSummary()" style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; font-size: 14px; transition: all 0.3s;">
                            </div>
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #333;">
                                    <span style="font-size: 18px;">ğŸ“…</span>
                                    BitiÅŸ Tarihi
                                </label>
                                <input type="date" id="summaryEndDate" class="form-control" onchange="renderAccountingSummary()" style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; font-size: 14px; transition: all 0.3s;">
                            </div>
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #333;">
                                    <span style="font-size: 18px;">ğŸ¢</span>
                                    BranÅŸ
                                </label>
                                <select id="summaryBranchFilter" class="form-control" onchange="renderAccountingSummary()" style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; font-size: 14px; transition: all 0.3s; cursor: pointer;">
                                    <option value="all">ğŸŒ TÃ¼m BranÅŸlar</option>
                                </select>
                            </div>
                            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; align-items: flex-end;">
                                <button class="btn btn-light" onclick="resetSummaryFilters()" style="width: 100%; padding: 10px; border: 2px solid #fff; border-radius: 8px; font-weight: 600; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; transition: all 0.3s; box-shadow: 0 4px 8px rgba(245,87,108,0.3);">
                                    ğŸ”„ Filtreleri SÄ±fÄ±rla
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ã–zet KartlarÄ± -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- Toplam Gelir (Tahsil Edilen) -->
                        <div style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ğŸ’° Toplam Gelir</div>
                            <div id="totalIncome" style="font-size: 32px; font-weight: bold;">0 â‚º</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Bu ay tahsil edilen</div>
                        </div>
                        
                        <!-- Toplam Gider -->
                        <div style="background: linear-gradient(135deg, #f44336 0%, #e53935 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ğŸ“‰ Toplam Gider</div>
                            <div id="totalExpense" style="font-size: 32px; font-weight: bold;">0 â‚º</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Bu ay yapÄ±lan giderler</div>
                        </div>
                        
                        <!-- Net Kar/Zarar -->
                        <div style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ğŸ“Š Net Kar/Zarar</div>
                            <div id="netProfit" style="font-size: 32px; font-weight: bold;">0 â‚º</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Gelir - Gider</div>
                        </div>
                        
                        <!-- ÃœrÃ¼n SatÄ±ÅŸlarÄ± -->
                        <div style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ğŸ›ï¸ ÃœrÃ¼n SatÄ±ÅŸlarÄ±</div>
                            <div id="totalProductSales" style="font-size: 32px; font-weight: bold;">0 â‚º</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">SatÄ±ÅŸlardan gelir</div>
                        </div>
                    </div>
                    
                    <!-- Giderler Tablosu -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="font-size: 20px; margin-bottom: 15px; color: #333;">ğŸ“‰ Giderler</h3>
                        <div id="expensesTableContainer">
                            <div class="loading"><div class="spinner"></div><span>Giderler yÃ¼kleniyor...</span></div>
                        </div>
                    </div>
                    
                    <!-- ÃœrÃ¼nler Tablosu -->
                    <div>
                        <h3 style="font-size: 20px; margin-bottom: 15px; color: #333;">ğŸ›ï¸ ÃœrÃ¼nler</h3>
                        <div id="productsTableContainer">
                            <div class="loading"><div class="spinner"></div><span>ÃœrÃ¼nler yÃ¼kleniyor...</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Section (ÃœrÃ¼nler) -->
            <div id="products" class="section">
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>ğŸ›ï¸ ÃœrÃ¼nler</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="openProductCategoryManager()">
                                ğŸ“‚ Kategori YÃ¶netimi
                            </button>
                            <button class="btn btn-primary" onclick="openAddProductModal()">
                                â• ÃœrÃ¼n Ekle
                            </button>
                        </div>
                    </div>
                    
                    <div id="productsPageContainer">
                        <div class="loading"><div class="spinner"></div><span>ÃœrÃ¼nler yÃ¼kleniyor...</span></div>
                    </div>
                </div>
            </div>

            <!-- Schedule Section -->
            <div id="schedule" class="section">
                <div class="card">
                    <div class="card-title">
                        <h3>ğŸ“… Ders PlanÄ± YÃ¶netimi</h3>
                        <div id="schedule-branch-buttons" class="btn-group">
                            <!-- âœ… Dinamik branÅŸ butonlarÄ± buraya gelecek -->
                       </div>
                    </div>
                    <div id="unassigned-groups-container"></div>
                    <div id="scheduleGrid">
                        <div class="empty-state" style="grid-column: 1 / -1;"><h3>LÃ¼tfen bir branÅŸ seÃ§in.</h3></div>
                    </div>
                </div>
            </div>

            <!-- Groups Section -->
            <div id="groups" class="section">
                <div class="card">
                    <div class="card-title">
                        <h3>ğŸ¤¸ Grup YÃ¶netimi</h3>
                        <input type="text" id="groupSearch" class="form-control search-input" placeholder="Grup ara...">
                        <div id="groups-branch-buttons" class="btn-group">
                            <!-- âœ… Dinamik branÅŸ butonlarÄ± buraya gelecek -->
                       </div>
                        <button class="btn btn-primary btn-sm" id="newGroupBtn" style="display:none;" onclick="openGroupModal()">â• Yeni Grup</button>
                    </div>
                    <div id="groupsList">
                        <div class="empty-state"><h3>LÃ¼tfen bir branÅŸ seÃ§in.</h3></div>
                    </div>
                </div>
            </div>
            
            <!-- Tasks Section -->
            <div id="tasks" class="section">
                <div class="card">
                    <div class="card-title">
                        <h3>ğŸ¯ GÃ¶rev YÃ¶netimi</h3>
                        <button class="btn btn-primary" onclick="openTaskEditModal()">â• Yeni GÃ¶rev Ekle</button>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>GÃ¶rev</th>
                                    <th>Sorumlu KiÅŸi</th>
                                    <th>AÅŸama</th>
                                    <th>Notlar</th>
                                    <th>Eklenme Tarihi</th>
                                    <th>Tamamlanma Tarihi</th>
                                    <th>Mesajlar</th>
                                    <th>Ä°ÅŸlemler</th>
                                </tr>
                            </thead>
                            <tbody id="tasksTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="section">
                <!-- Profilim Section -->
                <div class="card">
                    <h3 class="card-title">ğŸ”‘ Profilim</h3>
                    <p>AÅŸaÄŸÄ±daki butona tÄ±klayarak adÄ±nÄ±zÄ± ve ÅŸifrenizi gÃ¼ncelleyebilirsiniz.</p>
                    <button class="btn btn-primary" style="margin-top:15px;" onclick="openProfileEditModal()">Profili DÃ¼zenle</button>
                </div>
                
                <!-- Settings Tabs -->
                <div class="card">
                    <div class="settings-tabs">
                        <button class="settings-tab active" onclick="switchSettingsTab('club')">ğŸ¢ KulÃ¼p Bilgileri</button>
                        <button class="settings-tab" onclick="switchSettingsTab('general')">âš™ï¸ Genel Ayarlar</button>
                        <button class="settings-tab" onclick="switchSettingsTab('branches')">ğŸƒ BranÅŸ YÃ¶netimi</button>
                        <button class="settings-tab" onclick="switchSettingsTab('users')">ğŸ‘¥ YÃ¶netici YÃ¶netimi</button>
                        <button class="settings-tab" onclick="switchSettingsTab('contract')">ğŸ“„ SÃ¶zleÅŸme Åablonu</button>
                        <button class="settings-tab" onclick="switchSettingsTab('templates')">ğŸ“ Ãœye Mesaj ÅablonlarÄ±</button>
                    </div>
                    
                    <!-- Tab Content: KulÃ¼p Bilgileri -->
                    <div id="settings-tab-club" class="settings-tab-content active">
                        <form id="clubInfoForm" onsubmit="saveClubInfo(event)">
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">ğŸ¢ Temel Bilgiler</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="clubInfoName">KulÃ¼p AdÄ± *</label>
                                        <input type="text" id="clubInfoName" name="clubName" class="form-control" required placeholder="Ã–rn: Atakum Tenis KulÃ¼bÃ¼" oninput="generateRegistrationLink()">
                                    </div>
                                    <div class="form-group">
                                        <label for="clubIcon">Ä°kon (Emoji)</label>
                                        <input type="text" id="clubIcon" name="clubIcon" class="form-control" maxlength="2" placeholder="ğŸ¾">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="clubDescription">KulÃ¼p AÃ§Ä±klamasÄ±</label>
                                    <textarea id="clubDescription" name="clubDescription" class="form-control" rows="3" placeholder="KulÃ¼bÃ¼nÃ¼z hakkÄ±nda kÄ±sa aÃ§Ä±klama..."></textarea>
                                </div>
                                
                                <!-- KayÄ±t Linki -->
                                <div id="registrationLinkSection" style="background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50; margin-top: 20px; display: none;">
                                    <h5 style="margin: 0 0 10px 0; color: #2e7d32; font-size: 14px;">ğŸ”— KulÃ¼p KayÄ±t Linki</h5>
                                    <p style="margin: 0 0 10px 0; font-size: 13px; color: #666;">
                                        Bu linki Ã¼yelerinizle paylaÅŸarak online kayÄ±t almalarÄ±nÄ± saÄŸlayabilirsiniz:
                                    </p>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input type="text" id="registrationLinkDisplay" readonly class="form-control" style="background: white; font-family: monospace; font-size: 12px; flex: 1;">
                                        <button type="button" class="btn btn-success" onclick="copyRegistrationLink()" style="white-space: nowrap;">
                                            ğŸ“‹ Kopyala
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="openRegistrationLink()" style="white-space: nowrap;">
                                            ğŸ”— AÃ§
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary" style="margin-top: 20px;">ğŸ’¾ KulÃ¼p Bilgilerini Kaydet</button>
                        </form>
                    </div>
                    
                    <!-- Tab Content: Genel Ayarlar -->
                    <div id="settings-tab-general" class="settings-tab-content">
                        <form id="settingsForm">
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">ğŸ“… HaftalÄ±k Tatil GÃ¼nleri</h4>
                                <div class="form-group">
                                    <div id="holiday-settings" class="holiday-settings-grid"></div>
                                </div>
                            </div>
                            
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">ğŸ“ Bulutfon API Entegrasyonu</h4>
                                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                                    Bulutfon API'yi aktif ederek CRM'de gÃ¶rÃ¼ÅŸme kayÄ±tlarÄ±nÄ±, cevapsÄ±z Ã§aÄŸrÄ±larÄ± ve arama geÃ§miÅŸini gÃ¶rÃ¼ntÃ¼leyebilirsiniz.
                                </p>
                                
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="bulutfonEnabled" name="bulutfonEnabled" onclick="toggleBulutfonFields()" style="width: 20px; height: 20px;">
                                        <span style="font-weight: 600;">Bulutfon Entegrasyonunu Aktif Et</span>
                                    </label>
                                </div>
                                
                                <div id="bulutfon-api-settings" style="display: none; padding: 15px; background: #f5f5f5; border-radius: 8px; margin-top: 15px;">
                                    <div style="background: #e3f2fd; padding: 15px; border-radius: 6px; border-left: 4px solid #2196F3; margin-bottom: 20px;">
                                        <h5 style="margin: 0 0 10px 0; color: #1976d2; font-size: 14px;">ğŸ“‹ API Bilgileri</h5>
                                        <div style="font-size: 13px; color: #333; line-height: 1.6;">
                                            <p style="margin: 5px 0;"><strong>API URL:</strong> <code>https://api.bulutfon.com</code></p>
                                            <p style="margin: 5px 0;"><strong>DokÃ¼mentasyon:</strong> <a href="https://www.bulutfon.com/developers" target="_blank" style="color: #1976d2;">https://www.bulutfon.com/developers</a></p>
                                            <p style="margin: 5px 0;"><strong>Gerekli Ä°zinler:</strong> CDR (Call Detail Records) okuma yetkisi</p>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="bulutfonApiKey">Bulutfon API Key *</label>
                                        <input type="text" id="bulutfonApiKey" name="bulutfonApiKey" class="form-control" placeholder="API Key'inizi buraya girin">
                                        <small style="color: #666; display: block; margin-top: 5px;">
                                            ğŸ’¡ Bulutfon panelinden <strong>Ayarlar â†’ API</strong> bÃ¶lÃ¼mÃ¼nden API key'inizi alabilirsiniz.
                                        </small>
                                    </div>
                                    
                                    <div style="background: #fff3cd; padding: 12px; border-radius: 6px; border-left: 4px solid #ff9800; margin-top: 15px;">
                                        <p style="margin: 0; font-size: 13px; color: #856404;">
                                            <strong>âš ï¸ Ã–nemli:</strong> Bulutfon hesabÄ±nÄ±zda <strong>CDR (Call Detail Records)</strong> Ã¶zelliÄŸinin aktif olmasÄ± gerekir.
                                            API key'i girdikten sonra "BaÄŸlantÄ±yÄ± Test Et" butonu ile test edebilirsiniz.
                                        </p>
                                    </div>
                                    
                                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                                        <button type="button" class="btn btn-primary" onclick="saveBulutfonSettings()">
                                            ğŸ’¾ Kaydet
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="testBulutfonConnection()">
                                            ğŸ”Œ BaÄŸlantÄ±yÄ± Test Et
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">ğŸ”” Webhook AyarlarÄ± (Ãœye KayÄ±t Bildirimleri)</h4>
                                <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                                    KayÄ±t sayfasÄ±ndan Ã¼ye kaydÄ± tamamlandÄ±ÄŸÄ±nda belirtilen webhook URL'sine POST isteÄŸi gÃ¶nderilir. Bu sayede kendi sisteminize otomatik bildirim alabilirsiniz.
                                </p>
                                
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="webhookEnabled" name="webhookEnabled" style="width: 20px; height: 20px;">
                                        <span style="font-weight: 600;">Webhook Bildirimi Aktif</span>
                                    </label>
                                </div>
                                
                                <div id="webhook-settings" style="display: none; padding: 15px; background: #f5f5f5; border-radius: 8px; margin-top: 15px;">
                                    <div style="background: #e8f5e9; padding: 15px; border-radius: 6px; border-left: 4px solid #4caf50; margin-bottom: 20px;">
                                        <h5 style="margin: 0 0 10px 0; color: #2e7d32; font-size: 14px;">ğŸ“‹ Webhook Bilgileri</h5>
                                        <div style="font-size: 13px; color: #333; line-height: 1.6;">
                                            <p style="margin: 5px 0;"><strong>Method:</strong> POST</p>
                                            <p style="margin: 5px 0;"><strong>Content-Type:</strong> application/json</p>
                                            <p style="margin: 5px 0;"><strong>Event Type:</strong> contract_signed</p>
                                            <p style="margin: 5px 0;"><strong>Payload Ä°Ã§eriÄŸi:</strong> Ãœye bilgileri, Ã¶deme planÄ±, sÃ¶zleÅŸme PDF'i (base64)</p>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="webhookUrl">Webhook URL *</label>
                                        <input type="url" id="webhookUrl" name="webhookUrl" class="form-control" placeholder="https://example.com/webhook/member-registered">
                                        <small style="color: #666; display: block; margin-top: 5px;">
                                            ğŸ’¡ POST isteÄŸi gÃ¶nderilecek URL'yi buraya girin.
                                        </small>
                                    </div>
                                    
                                    <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; border-left: 4px solid #2196f3; margin-top: 15px;">
                                        <p style="margin: 0 0 8px 0; font-size: 13px; color: #1565c0; font-weight: 600;">
                                            ğŸ“¦ Ã–rnek Webhook Payload:
                                        </p>
                                        <pre style="background: #fff; padding: 10px; border-radius: 4px; font-size: 11px; overflow-x: auto; margin: 0;">{
  "event": "contract_signed",
  "Ad_Soyad": "Ahmet YÄ±lmaz",
  "Telefon": "05551234567",
  "TC_Kimlik_No": "12345678901",
  "Adres": "...",
  "branch": "tenis",
  "paymentPlan": [...],
  "contractPdfBase64": "data:application/pdf;base64,...",
  "preRegistrationId": "abc123",
  "timestamp": "2025-01-15T10:30:00.000Z"
}</pre>
                                    </div>
                                    
                                    <button type="button" class="btn btn-secondary" onclick="testWebhook()" style="margin-top: 15px;">
                                        ğŸ§ª Webhook'u Test Et
                                    </button>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="margin-top: 20px;">ğŸ’¾ AyarlarÄ± Kaydet</button>
                        </form>
                    </div>
                    
                    <!-- Tab Content: BranÅŸ YÃ¶netimi -->
                    <div id="settings-tab-branches" class="settings-tab-content">
                        <h3 class="card-title">ğŸƒ BranÅŸ YÃ¶netimi</h3>
                        <p style="margin-bottom: 25px; color: #666;">
                            KulÃ¼bÃ¼nÃ¼zdeki branÅŸlarÄ± buradan yÃ¶netebilirsiniz. Her branÅŸ iÃ§in Ã¶zel ders ismi belirleyebilirsiniz.
                        </p>
                        
                        <div class="settings-subsection">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 class="settings-subtitle" id="branchFormTitle" style="margin: 0;">â• Yeni BranÅŸ Ekle</h4>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="resetBranchForm()" style="padding: 6px 12px;">ğŸ”„ Formu Temizle</button>
                            </div>
                            <form id="branchForm" onsubmit="addBranch(event)">
                                <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr 2fr auto;">
                                    <div class="form-group">
                                        <label for="branchId">BranÅŸ ID *</label>
                                        <input type="text" id="branchId" name="branchId" class="form-control" placeholder="ornek: futbol" required>
                                        <small style="color: #666; display: block; margin-top: 4px;">KÃ¼Ã§Ã¼k harf, boÅŸluksuz</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="branchName">BranÅŸ AdÄ± *</label>
                                        <input type="text" id="branchName" name="branchName" class="form-control" placeholder="Futbol" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="branchIcon">Ä°kon (opsiyonel)</label>
                                        <input type="text" id="branchIcon" name="branchIcon" class="form-control" placeholder="âš½">
                                        <small style="color: #666; display: block; margin-top: 4px;">Emoji - boÅŸ bÄ±rakÄ±rsanÄ±z varsayÄ±lan âš½ kullanÄ±lÄ±r</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="branchLessonName">Ders AdÄ± *</label>
                                        <input type="text" id="branchLessonName" name="branchLessonName" class="form-control" placeholder="Futbol AntrenmanÄ±" required>
                                        <small style="color: #666; display: block; margin-top: 4px;">Mesajlarda gÃ¶rÃ¼necek</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="branchCourts">Sahalar (opsiyonel)</label>
                                        <input type="text" id="branchCourts" name="branchCourts" class="form-control" placeholder="Saha 1, Saha 2, Merkez Saha">
                                        <small style="color: #666; display: block; margin-top: 4px;">VirgÃ¼lle ayÄ±rÄ±n. Birden fazla saha varsa ders planÄ±nda saha seÃ§imi gÃ¶rÃ¼necek</small>
                                    </div>
                                    <div class="form-group">
                                        <label style="visibility: hidden;">Ekle</label>
                                        <button type="submit" id="branchSubmitBtn" class="btn btn-primary">â• Ekle</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <div class="settings-subsection">
                            <h4 class="settings-subtitle">ğŸ“‹ Mevcut BranÅŸlar</h4>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 60px;">Ä°kon</th>
                                            <th>BranÅŸ ID</th>
                                            <th>BranÅŸ AdÄ±</th>
                                            <th>Ders AdÄ±</th>
                                            <th>Sahalar</th>
                                            <th style="width: 120px;">Ä°ÅŸlemler</th>
                                        </tr>
                                    </thead>
                                    <tbody id="branchesTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Content: Gider Kategorileri -->
                    <div id="settings-tab-expense-categories" class="settings-tab-content">
                        <h3 class="card-title">ğŸ’¸ Gider Kategorileri YÃ¶netimi</h3>
                        <p style="margin-bottom: 25px; color: #666;">
                            Gider kategorilerinizi buradan yÃ¶netebilirsiniz. VarsayÄ±lan kategoriler: Kira, MaaÅŸ, Fatura, Malzeme, DiÄŸer
                        </p>
                        
                        <div class="settings-subsection">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 class="settings-subtitle" id="expenseCategoryFormTitle" style="margin: 0;">â• Yeni Kategori Ekle</h4>
                            </div>
                            <form id="expenseCategoryForm" onsubmit="addExpenseCategory(event)" style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 30px;">
                                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                                    <label for="newExpenseCategoryName">Kategori AdÄ± *</label>
                                    <input type="text" id="newExpenseCategoryName" class="form-control" placeholder="Ã–rn: Elektrik, Su, DoÄŸalgaz" required>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="newExpenseCategoryIcon">Ä°kon</label>
                                    <input type="text" id="newExpenseCategoryIcon" class="form-control" placeholder="âš¡" style="width: 80px; text-align: center;">
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <button type="submit" class="btn btn-primary">â• Ekle</button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="settings-subsection">
                            <h4 class="settings-subtitle">ğŸ“‹ Mevcut Kategoriler</h4>
                            <div id="expenseCategoriesContainer">
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                                    <!-- VarsayÄ±lan Kategoriler -->
                                    <div class="expense-category-card" data-category="Kira">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 24px;">ğŸ </span>
                                            <span style="font-weight: 600;">Kira</span>
                                        </div>
                                        <span style="font-size: 11px; color: #666; margin-top: 5px;">VarsayÄ±lan</span>
                                    </div>
                                    <div class="expense-category-card" data-category="MaaÅŸ">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 24px;">ğŸ’°</span>
                                            <span style="font-weight: 600;">MaaÅŸ</span>
                                        </div>
                                        <span style="font-size: 11px; color: #666; margin-top: 5px;">VarsayÄ±lan</span>
                                    </div>
                                    <div class="expense-category-card" data-category="Fatura">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 24px;">ğŸ“„</span>
                                            <span style="font-weight: 600;">Fatura</span>
                                        </div>
                                        <span style="font-size: 11px; color: #666; margin-top: 5px;">VarsayÄ±lan</span>
                                    </div>
                                    <div class="expense-category-card" data-category="Malzeme">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 24px;">ğŸ”§</span>
                                            <span style="font-weight: 600;">Malzeme</span>
                                        </div>
                                        <span style="font-size: 11px; color: #666; margin-top: 5px;">VarsayÄ±lan</span>
                                    </div>
                                    <div class="expense-category-card" data-category="DiÄŸer">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 24px;">ğŸ“¦</span>
                                            <span style="font-weight: 600;">DiÄŸer</span>
                                        </div>
                                        <span style="font-size: 11px; color: #666; margin-top: 5px;">VarsayÄ±lan</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Content: YÃ¶netici YÃ¶netimi -->
                    <div id="settings-tab-users" class="settings-tab-content">
                        <div id="user-management-card">
                            <h3 class="card-title">ğŸ‘¥ YÃ¶netici YÃ¶netimi</h3>
                     <form id="userForm">
                         <div class="form-grid">
                             <div class="form-group">
                                 <label for="userFullName">Ad Soyad *</label>
                                 <input type="text" class="form-control" name="fullName" required>
                             </div>
                             <div class="form-group">
                                 <label for="userPhone">Telefon *</label>
                                 <input type="tel" class="form-control" name="phone" required>
                             </div>
                             <div class="form-group">
                                 <label for="userUsername">KullanÄ±cÄ± AdÄ± (Telefon)</label>
                                 <input type="text" class="form-control" name="username" readonly>
                             </div>
                             <div class="form-group">
                                 <label for="userPassword">Åifre *</label>
                                 <input type="password" class="form-control" name="password" autocomplete="new-password" required>
                             </div>
                        </div>
                         <div class="form-group">
                              <label>Yetkiler</label>
                              <div class="permissions-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                                  <strong style="grid-column: 1 / -1; color: #1976d2; margin-bottom: 5px;">ğŸ’° Finansal Yetkiler</strong>
                                  <label><input type="checkbox" name="permissions" value="view_payments"> Ã–demeleri GÃ¶rÃ¼ntÃ¼leme</label>
                                  <label><input type="checkbox" name="permissions" value="edit_payments"> Ã–demeleri DÃ¼zenleme</label>
                                  <label><input type="checkbox" name="permissions" value="delete_payments"> Ã–demeleri Silme</label>
                                  <label><input type="checkbox" name="permissions" value="export_payments"> Ã–demeleri DÄ±ÅŸa Aktarma</label>
                                  
                                  <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">ğŸ‘¥ Ãœye Yetkileri</strong>
                                  <label><input type="checkbox" name="permissions" value="view_members"> Ãœyeleri GÃ¶rÃ¼ntÃ¼leme</label>
                                  <label><input type="checkbox" name="permissions" value="add_members"> Ãœye Ekleme</label>
                                  <label><input type="checkbox" name="permissions" value="edit_members"> Ãœye DÃ¼zenleme</label>
                                  <label><input type="checkbox" name="permissions" value="delete_members"> Ãœye Silme</label>
                                  <label><input type="checkbox" name="permissions" value="export_members"> Ãœyeleri DÄ±ÅŸa Aktarma</label>
                                  
                                  <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">ğŸ“ CRM Yetkileri</strong>
                                  <label><input type="checkbox" name="permissions" value="view_crm"> CRM GÃ¶rÃ¼ntÃ¼leme</label>
                                  <label><input type="checkbox" name="permissions" value="add_crm"> CRM'e Ekleme</label>
                                  <label><input type="checkbox" name="permissions" value="edit_crm"> CRM DÃ¼zenleme</label>
                                  <label><input type="checkbox" name="permissions" value="delete_crm"> CRM'den Silme</label>
                                  <label><input type="checkbox" name="permissions" value="view_calls"> Arama KayÄ±tlarÄ±nÄ± GÃ¶rÃ¼ntÃ¼leme</label>
                                  
                                  <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">ğŸ’¬ Ä°letiÅŸim Yetkileri</strong>
                                  <label><input type="checkbox" name="permissions" value="send_messages"> Mesaj GÃ¶nderme</label>
                                  <label><input type="checkbox" name="permissions" value="send_bulk_messages"> Toplu Mesaj GÃ¶nderme</label>
                                  <label><input type="checkbox" name="permissions" value="view_message_history"> Mesaj GeÃ§miÅŸini GÃ¶rÃ¼ntÃ¼leme</label>
                                  
                                  <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">ğŸ“Š Raporlar ve Ä°statistikler</strong>
                                  <label><input type="checkbox" name="permissions" value="view_stats"> Ä°statistikleri GÃ¶rÃ¼ntÃ¼leme</label>
                                  <label><input type="checkbox" name="permissions" value="view_reports"> RaporlarÄ± GÃ¶rÃ¼ntÃ¼leme</label>
                                  <label><input type="checkbox" name="permissions" value="export_reports"> RaporlarÄ± DÄ±ÅŸa Aktarma</label>
                                  
                                  <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">âš™ï¸ Ayarlar ve YÃ¶netim</strong>
                                  <label><input type="checkbox" name="permissions" value="manage_users"> KullanÄ±cÄ± YÃ¶netimi</label>
                                  <label><input type="checkbox" name="permissions" value="manage_settings"> AyarlarÄ± YÃ¶netme</label>
                                  <label><input type="checkbox" name="permissions" value="manage_branches"> BranÅŸ YÃ¶netimi</label>
                                  <label><input type="checkbox" name="permissions" value="manage_groups"> Grup YÃ¶netimi</label>
                                  
                                  <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">ğŸ“‹ Yoklama ve Takvim</strong>
                                  <label><input type="checkbox" name="permissions" value="view_attendance"> Yoklama GÃ¶rÃ¼ntÃ¼leme</label>
                                  <label><input type="checkbox" name="permissions" value="edit_attendance"> Yoklama DÃ¼zenleme</label>
                                  <label><input type="checkbox" name="permissions" value="manage_schedule"> Takvim YÃ¶netimi</label>
                              </div>
                         </div>
                         <button type="submit" class="btn btn-success">ğŸ‘¤ KullanÄ±cÄ± Ekle</button>
                     </form>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead><tr><th>Ad Soyad</th><th>Telefon (K. AdÄ±)</th><th>Ä°zinler</th><th>Ä°ÅŸlemler</th></tr></thead>
                                    <tbody id="usersTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Content: SÃ¶zleÅŸme Åablonu -->
                    <div id="settings-tab-contract" class="settings-tab-content">
                        <h3 class="card-title">ğŸ“„ KulÃ¼p SÃ¶zleÅŸme Åablonu</h3>
                        <p style="margin-bottom: 25px; color: #666;">
                            Ã–n kayÄ±t yapan Ã¼yelerin sÃ¶zleÅŸme onayÄ± sÄ±rasÄ±nda gÃ¶sterilecek sÃ¶zleÅŸme ÅŸablonunu dÃ¼zenleyin.
                        </p>
                        
                        <!-- KulÃ¼be Ã–zel SÃ¶zleÅŸme Linki -->
                        <div id="contractLinkSection" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; color: white;">
                            <h4 style="margin-top: 0; color: white;">ğŸ”— Ãœyelik KayÄ±t Linki</h4>
                            <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                                <strong style="font-size: 16px;">ğŸ¢ KulÃ¼p AdÄ±:</strong> <span id="contractClubName" style="font-size: 16px; font-weight: 600;">YÃ¼kleniyor...</span>
                            </div>
                            <p style="margin-bottom: 15px; opacity: 0.9;">Ã–n kayÄ±tlÄ± Ã¼yelerinizin sÃ¶zleÅŸmeyi tamamlamasÄ± iÃ§in bu linki paylaÅŸÄ±n:</p>
                            <div style="display: flex; gap: 10px; align-items: center; background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
                                <input 
                                    type="text" 
                                    id="contractLink" 
                                    readonly 
                                    style="flex: 1; padding: 10px; border: none; border-radius: 6px; font-family: monospace; font-size: 14px;"
                                    value="YÃ¼kleniyor..."
                                />
                                <button 
                                    onclick="copyContractLink()" 
                                    class="btn btn-success"
                                    style="white-space: nowrap; padding: 10px 20px;">
                                    ğŸ“‹ Kopyala
                                </button>
                                <a 
                                    id="contractLinkOpen"
                                    href="#" 
                                    target="_blank"
                                    class="btn"
                                    style="background: white; color: #667eea; white-space: nowrap; padding: 10px 20px; text-decoration: none;">
                                    ğŸ”— AÃ§
                                </a>
                            </div>
                        </div>
                        
                        <form id="contractTemplateForm" onsubmit="saveContractTemplate(event)">
                            <!-- Genel Ayarlar -->
                            <div class="settings-subsection">
                                <h4 style="color: #667eea; margin-bottom: 15px;">ğŸ¨ Sayfa BaÅŸlÄ±klarÄ±</h4>
                                
                                <div class="form-group">
                                    <label for="contract-page-title">Sayfa Ana BaÅŸlÄ±ÄŸÄ±</label>
                                    <input type="text" id="contract-page-title" name="pageTitle" class="form-control" placeholder="Ã–rn: Spor KulÃ¼bÃ¼" value="Spor KulÃ¼bÃ¼">
                                    <small style="color: #666;">SÃ¶zleÅŸme sayfasÄ±nÄ±n en Ã¼stÃ¼ndeki baÅŸlÄ±k</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="contract-page-subtitle">Sayfa Alt BaÅŸlÄ±ÄŸÄ±</label>
                                    <input type="text" id="contract-page-subtitle" name="pageSubtitle" class="form-control" placeholder="Ã–rn: Ãœyelik SÃ¶zleÅŸmesi" value="Ãœyelik SÃ¶zleÅŸmesi">
                                </div>
                            </div>
                            
                            <!-- Onay KutularÄ± -->
                            <div class="settings-subsection">
                                <h4 style="color: #667eea; margin-bottom: 15px;">âœ… Onay KutularÄ±</h4>
                                <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">
                                    ğŸ“Œ KayÄ±t formunda gÃ¶sterilecek onay kutularÄ±nÄ±n metinlerini dÃ¼zenleyin. BoÅŸ bÄ±rakÄ±rsanÄ±z o kutu kayÄ±t sayfasÄ±nda gÃ¶sterilmez.
                                </p>
                                
                                <div class="form-group">
                                    <label for="contract-checkbox1-text">
                                        <strong>1. Onay Kutusu:</strong> SÃ¶zleÅŸme OnayÄ±
                                    </label>
                                    <input 
                                        type="text" 
                                        id="contract-checkbox1-text" 
                                        name="checkbox1Text" 
                                        class="form-control" 
                                        placeholder="Ãœyelik sÃ¶zleÅŸmesini okudum, anladÄ±m ve kabul ediyorum."
                                        value="Ãœyelik sÃ¶zleÅŸmesini okudum, anladÄ±m ve kabul ediyorum.">
                                    <small style="color: #666;">
                                        âœ… Zorunlu alan: KullanÄ±cÄ±nÄ±n sÃ¶zleÅŸmeyi kabul etmesi iÃ§in gÃ¶sterilir
                                    </small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="contract-checkbox2-text">
                                        <strong>2. Onay Kutusu:</strong> Ä°ptal ve Ãœyelik PolitikasÄ±
                                    </label>
                                    <textarea 
                                        id="contract-checkbox2-text" 
                                        name="checkbox2Text" 
                                        class="form-control" 
                                        rows="3"
                                        placeholder="ÃœyeliÄŸiniz iptal edilene kadar devam etmektedir..."
                                    >ÃœyeliÄŸiniz iptal edilene kadar devam etmektedir. Her ayÄ±n 14'Ã¼, yeni dÃ¶nem iÃ§in kayÄ±t iptali yapÄ±labilecek son gÃ¼ndÃ¼r. Bu tarihe kadar iptal edilmeyen kayÄ±tlar, devam eden dÃ¶nem iÃ§in geÃ§erli sayÄ±lÄ±r.</textarea>
                                    <small style="color: #666;">
                                        âš™ï¸ Ä°steÄŸe baÄŸlÄ±: Ä°ptal politikasÄ± veya ek bilgilendirme iÃ§in. BoÅŸ bÄ±rakÄ±rsanÄ±z gÃ¶sterilmez.
                                    </small>
                                </div>
                                
                                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-top: 15px;">
                                    <strong>ğŸ’¡ Ä°pucu:</strong>
                                    <ul style="margin: 10px 0 0 20px; padding: 0;">
                                        <li>Ä°kinci onay kutusunu kullanmak istemiyorsanÄ±z alanÄ± <strong>tamamen boÅŸ</strong> bÄ±rakÄ±n</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <!-- KayÄ±t TamamlandÄ± MesajÄ± -->
                            <div class="settings-subsection">
                                <h4 style="color: #667eea; margin-bottom: 15px;">ğŸ‰ KayÄ±t TamamlandÄ± MesajÄ±</h4>
                                <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">
                                    Ãœye sÃ¶zleÅŸmeyi onaylayÄ±p kaydÄ±nÄ± tamamladÄ±ktan sonra gÃ¶sterilecek baÅŸarÄ± mesajÄ±nÄ± dÃ¼zenleyin.
                                </p>
                                
                                <div class="form-group">
                                    <label for="contract-success-title">BaÅŸarÄ± MesajÄ± BaÅŸlÄ±ÄŸÄ±</label>
                                    <input 
                                        type="text" 
                                        id="contract-success-title" 
                                        name="successTitle" 
                                        class="form-control" 
                                        placeholder="Ã–rn: KayÄ±t Ä°ÅŸleminiz TamamlandÄ±!"
                                        value="KayÄ±t Ä°ÅŸleminiz TamamlandÄ±!"
                                        oninput="updateSuccessPreview()">
                                    <small style="color: #666;">BaÅŸarÄ± sayfasÄ±nÄ±n ana baÅŸlÄ±ÄŸÄ±</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="contract-success-message">BaÅŸarÄ± MesajÄ± Ä°Ã§eriÄŸi</label>
                                    <textarea 
                                        id="contract-success-message" 
                                        name="successMessage" 
                                        class="form-control" 
                                        rows="4"
                                        placeholder="Ailemize hoÅŸ geldiniz! Ãœyelik sÃ¶zleÅŸmeniz baÅŸarÄ±yla tamamlandÄ±..."
                                    >Ailemize hoÅŸ geldiniz! Ãœyelik sÃ¶zleÅŸmeniz kulÃ¼bÃ¼mÃ¼ze baÅŸarÄ±yla ulaÅŸmÄ±ÅŸtÄ±r. En kÄ±sa sÃ¼rede sizinle iletiÅŸime geÃ§eceÄŸiz.</textarea>
                                    <small style="color: #666;">BaÅŸarÄ± sayfasÄ±nda gÃ¶sterilecek detaylÄ± mesaj</small>
                                </div>
                                
                                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3; margin-top: 15px;">
                                    <strong>ğŸ’¡ Ä°pucu:</strong>
                                    <ul style="margin: 10px 0 0 20px; padding: 0;">
                                        <li>Bu mesaj, Ã¼ye sÃ¶zleÅŸmeyi imzalayÄ±p "KaydÄ± Tamamla" butonuna tÄ±kladÄ±ktan sonra gÃ¶sterilir</li>
                                        <li>Ä°letiÅŸim bilgilerinizi ekleyerek Ã¼yelerinize nasÄ±l ulaÅŸabileceklerini belirtebilirsiniz</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <!-- SÃ¶zleÅŸme Ä°Ã§eriÄŸi -->
                            <div class="settings-subsection">
                                <h4 style="color: #667eea; margin-bottom: 15px;">ğŸ“œ SÃ¶zleÅŸme Ä°Ã§eriÄŸi</h4>
                                
                                <!-- Placeholder AÃ§Ä±klamasÄ± -->
                                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                                    <strong>ğŸ“Œ KullanÄ±labilir Placeholder'lar:</strong><br>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; font-size: 0.9em;">
                                        <div style="grid-column: 1 / -1; background: #e3f2fd; padding: 8px; border-radius: 4px; margin-bottom: 5px;"><strong>ğŸ‘¤ Ãœye Bilgileri:</strong></div>
                                        <div><code>{UYE_AD_SOYAD}</code> - Ãœye/Veli adÄ±</div>
                                        <div><code>{UYE_TCKN}</code> - TC Kimlik No</div>
                                        <div><code>{UYE_DOGUM_TARIHI}</code> - DoÄŸum tarihi</div>
                                        <div><code>{UYE_TELEFON}</code> - Telefon</div>
                                        <div><code>{UYE_ADRES}</code> - Adres</div>
                                        <div><code>{BRANS}</code> - BranÅŸ</div>
                                        <div><code>{OGRENCI_AD_SOYAD}</code> - Ã–ÄŸrenci adÄ±</div>
                                        <div><code>{OGRENCI_DOGUM_TARIHI}</code> - Ã–ÄŸrenci doÄŸum tarihi</div>
                                        <div><code>{TARIH}</code> - SÃ¶zleÅŸme tarihi</div>
                                        
                                        <div style="grid-column: 1 / -1; background: #fff3cd; padding: 8px; border-radius: 4px; margin-top: 5px;"><strong>ğŸ“‹ Ã–zel Alanlar:</strong></div>
                                        <div style="grid-column: 1 / -1;"><code>{AIDAT_TAKVIMI}</code> - Aidat takvimi tablosu (otomatik oluÅŸur)</div>
                                        <div style="grid-column: 1 / -1;"><code>{OGRENCI_BILGILERI}</code> - ReÅŸit olmayan Ã¶ÄŸrenci bilgileri (Ã§ocuk kaydÄ±nda otomatik eklenir)</div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <label for="contractTemplate" style="margin: 0;">SÃ¶zleÅŸme Metni (HTML)</label>
                                        <button type="button" onclick="previewContractPDF()" class="btn btn-sm btn-info" style="padding: 5px 15px;">
                                            ğŸ“„ PDF Ã–nizleme
                                        </button>
                                    </div>
                                    <textarea 
                                        id="contractTemplate" 
                                        name="contractText" 
                                        class="form-control" 
                                        rows="20" 
                                        style="font-family: 'Courier New', monospace; font-size: 13px; white-space: pre-wrap;"
                                        placeholder="KulÃ¼p sÃ¶zleÅŸme metnini buraya yazÄ±n...

HTML kullanabilirsiniz. Ã–rnek:
<h4>ÃœYELÄ°K SÃ–ZLEÅMESÄ°</h4>
<p><strong>1-) TARAFLAR</strong></p>
<p><strong>A-KULÃœP</strong><br>
AdÄ±-SoyadÄ±: {KULUP_YETKILI}<br>
ÃœnvanÄ±: {KULUP_ADI}<br>
Adres: {KULUP_ADRES}<br>
Vergi No: {KULUP_VERGI_NO}<br>
Telefon: {KULUP_TELEFON}<br>
E-mail: {KULUP_EMAIL}</p>
<p><strong>B-ÃœYE/VELÄ°</strong><br>
AdÄ±-SoyadÄ±: {UYE_AD_SOYAD}<br>
DoÄŸum Tarihi: {UYE_DOGUM_TARIHI}<br>
TCKN: {UYE_TCKN}<br>
Telefon: {UYE_TELEFON}<br>
Adres: {UYE_ADRES}<br>
BranÅŸ: {BRANS}<br>
Ã–ÄŸrenci AdÄ±: {OGRENCI_AD_SOYAD}<br>
</p>

<p><strong>SÃ¶zleÅŸme Tarihi:</strong> {TARIH}</p>"></textarea>
                                    <small style="color: #666;">
                                        <strong>ğŸ’¡ Ä°pucu:</strong> HTML etiketleri kullanabilirsiniz. YukarÄ±daki placeholder'larÄ± kullanarak Ã¼ye bilgileri otomatik doldurulur.
                                    </small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="contract-enabled" name="contractEnabled" style="width: auto;">
                                    <label for="contract-enabled" style="margin: 0;">Bu sÃ¶zleÅŸme ÅŸablonunu etkinleÅŸtir</label>
                                </div>
                            </div>
                            
                            <div class="settings-subsection" style="margin-top: 30px; background: #f0f9ff; padding: 20px; border-radius: 12px; border-left: 4px solid var(--primary-color);">
                                <h4 style="margin-bottom: 10px; color: var(--primary-color);">ğŸ’³ BranÅŸ BazlÄ± Ã–deme Bilgileri</h4>
                                <p style="margin-bottom: 20px; color: #666; font-size: 0.9em;">
                                    Her branÅŸ iÃ§in farklÄ± IBAN tanÄ±mlayabilirsiniz. Ãœye sÃ¶zleÅŸmeyi tamamladÄ±ÄŸÄ±nda kendi branÅŸÄ±nÄ±n IBAN bilgilerini gÃ¶recek.
                                </p>
                                
                                <!-- Dinamik BranÅŸ IBAN AlanlarÄ± -->
                                <div id="dynamic-branch-iban-container">
                                    <!-- JavaScript ile doldurulacak -->
                                </div>
                                
                                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                                    <strong>ğŸ’¡ Ä°pucu:</strong>
                                    <ul style="margin: 10px 0 0 20px; padding: 0;">
                                        <li>Her branÅŸ iÃ§in farklÄ± hesap bilgileri tanÄ±mlayabilirsiniz</li>
                                        <li>Ãœye sÃ¶zleÅŸmeyi tamamladÄ±ÄŸÄ±nda sadece kendi branÅŸÄ±nÄ±n IBAN'larÄ±nÄ± gÃ¶rÃ¼r</li>
                                        <li>Ä°kinci hesap alanÄ± isteÄŸe baÄŸlÄ±dÄ±r, boÅŸ bÄ±rakabilirsiniz</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">ğŸ’¾ SÃ¶zleÅŸme Åablonunu Kaydet</button>
                        </form>
                    </div>
                    
                    <!-- Tab Content: Mesaj ÅablonlarÄ± -->
                    <div id="settings-tab-templates" class="settings-tab-content">
                        <h3 class="card-title">ğŸ“ Ãœye Mesaj ÅablonlarÄ±</h3>
                        <p style="margin-bottom: 15px; color: #666;">
                            Bu ÅŸablonlar <strong>kayÄ±tlÄ± Ã¼yeler</strong> iÃ§in otomatik mesaj gÃ¶nderimi iÃ§in kullanÄ±lÄ±r. 
                            DoÄŸum gÃ¼nÃ¼, aidat hatÄ±rlatma, devamsÄ±zlÄ±k gibi otomatik mesajlarÄ± buradan dÃ¼zenleyebilirsiniz.
                            <strong>{UYE_AD_SOYAD}</strong>, <strong>{OGRENCI_AD_SOYAD}</strong>, <strong>{TUTAR}</strong>, <strong>{TARIH}</strong> gibi deÄŸiÅŸkenleri kullanabilirsiniz.
                        </p>
                        <div style="background: #f0f8ff; padding: 12px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #0066cc;">
                            <strong>ğŸ’¡ DeÄŸiÅŸken Sistemi:</strong><br>
                            <strong>{UYE_AD_SOYAD}:</strong> YetiÅŸkinde Ã¼yenin kendisi, Ã§ocukta veli adÄ±<br>
                            <strong>{OGRENCI_AD_SOYAD}:</strong> Sadece Ã§ocuk ÅŸablonlarÄ±nda kullanÄ±lÄ±r, Ã¶ÄŸrencinin adÄ±
                        </div>

                        <!-- BranÅŸ Sekmeleri (Dinamik) -->
                        <div class="settings-tabs" id="branchTemplateTabsContainer" style="margin-bottom: 20px;">
                            <!-- BranÅŸ sekmeleri JavaScript ile doldurulacak -->
                        </div>

                        <form id="templatesForm" onsubmit="saveMessageTemplates(event)">
                            
                            <!-- Dinamik BranÅŸ ÅablonlarÄ± -->
                            <div id="dynamicBranchTemplatesContainer">
                                <!-- BranÅŸ ÅŸablonlarÄ± JavaScript ile doldurulacak -->
                            </div>
                            
                            <!-- TENÄ°S BRANÅI ÅABLONLARI (ESKÄ° - SÄ°LÄ°NECEK) -->
                            <div id="branch-templates-tenis" class="branch-templates-content" style="display: none;">
                                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
                                    <strong>ğŸ¾ Tenis BranÅŸÄ±</strong><br>
                                    <p style="margin: 5px 0 0 0; color: #666;">Tenis branÅŸÄ±ndaki Ã¼yeler iÃ§in aÅŸaÄŸÄ±daki mesaj ÅŸablonlarÄ± kullanÄ±lacaktÄ±r.</p>
                                </div>

                            <!-- DoÄŸum GÃ¼nÃ¼ Åablonu -->
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">ğŸ‚ DoÄŸum GÃ¼nÃ¼ Kutlama Åablonu</h4>
                                
                                <!-- Ã‡ocuk Ãœyeler Ä°Ã§in -->
                                <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                    <label for="template-birthday-child" style="font-weight: 600; color: #4CAF50;">ğŸ‘¶ Ã‡ocuk Ãœyeler Ä°Ã§in (Veliye gÃ¶nderilir)</label>
                                    <div style="position: relative;">
                                        <textarea id="template-birthday-child" name="birthdayChild" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, TenisÃ§imiz {OGRENCI_AD_SOYAD}'nÄ±n doÄŸum gÃ¼nÃ¼nÃ¼ kutlarÄ±z! ğŸ‚ğŸ¾"></textarea>
                                        <button type="button" onclick="copyTemplateText('template-birthday-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                    </div>
                                    <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code></small>
                                </div>
                                
                                <!-- YetiÅŸkin Ãœyeler Ä°Ã§in -->
                                <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                    <label for="template-birthday-adult" style="font-weight: 600; color: #2196F3;">ğŸ‘¤ YetiÅŸkin Ãœyeler Ä°Ã§in</label>
                                    <div style="position: relative;">
                                        <textarea id="template-birthday-adult" name="birthdayAdult" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, DoÄŸum gÃ¼nÃ¼nÃ¼zÃ¼ kutlarÄ±z! ğŸ‚ğŸ¾"></textarea>
                                        <button type="button" onclick="copyTemplateText('template-birthday-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                    </div>
                                    <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code></small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                    <input type="checkbox" id="birthday-enabled" name="birthdayEnabled" style="width: auto;">
                                    <label for="birthday-enabled" style="margin: 0;">Otomatik doÄŸum gÃ¼nÃ¼ mesajlarÄ±nÄ± etkinleÅŸtir</label>
                                </div>
                            </div>

                            <!-- GecikmiÅŸ Aidat Åablonu -->
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">ğŸ’° GecikmiÅŸ Aidat HatÄ±rlatma Åablonu</h4>
                                
                                <!-- Ã‡ocuk Ãœyeler Ä°Ã§in -->
                                <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                    <label for="template-payment-child" style="font-weight: 600; color: #4CAF50;">ğŸ‘¶ Ã‡ocuk Ãœyeler Ä°Ã§in (Veliye gÃ¶nderilir)</label>
                                    <div style="position: relative;">
                                        <textarea id="template-payment-child" name="paymentChild" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, Velisi olduÄŸunuz {OGRENCI_AD_SOYAD} iÃ§in {TUTAR} TL Ã¶demeniz {TARIH} tarihinden beri gecikmiÅŸtir."></textarea>
                                        <button type="button" onclick="copyTemplateText('template-payment-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                    </div>
                                    <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code>, <code>{TUTAR}</code>, <code>{TARIH}</code>, <code>{DONEM_BASLANGIC}</code>, <code>{DONEM_BITIS}</code>, <code>{DERS_SAYISI}</code></small>
                                </div>
                                
                                <!-- YetiÅŸkin Ãœyeler Ä°Ã§in -->
                                <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                    <label for="template-payment-adult" style="font-weight: 600; color: #2196F3;">ğŸ‘¤ YetiÅŸkin Ãœyeler Ä°Ã§in</label>
                                    <div style="position: relative;">
                                        <textarea id="template-payment-adult" name="paymentAdult" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, {TUTAR} TL Ã¶demeniz {TARIH} tarihinden beri gecikmiÅŸtir."></textarea>
                                        <button type="button" onclick="copyTemplateText('template-payment-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                    </div>
                                    <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code>, <code>{TUTAR}</code>, <code>{TARIH}</code>, <code>{DONEM_BASLANGIC}</code>, <code>{DONEM_BITIS}</code>, <code>{DERS_SAYISI}</code></small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                    <input type="checkbox" id="payment-enabled" name="paymentEnabled" style="width: auto;">
                                    <label for="payment-enabled" style="margin: 0;">Bu ÅŸablonu etkinleÅŸtir</label>
                                </div>
                            </div>

                            <!-- DevamsÄ±zlÄ±k Åablonu -->
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">ğŸ“… DevamsÄ±zlÄ±k Bildirimi Åablonu</h4>
                                
                                <!-- Ã‡ocuk Ãœyeler Ä°Ã§in -->
                                <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                    <label for="template-absence-child" style="font-weight: 600; color: #4CAF50;">ğŸ‘¶ Ã‡ocuk Ãœyeler Ä°Ã§in (Veliye gÃ¶nderilir)</label>
                                    <div style="position: relative;">
                                        <textarea id="template-absence-child" name="absenceChild" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, Velisi olduÄŸunuz {OGRENCI_AD_SOYAD}'nÄ±n {TARIH} tarihindeki {DERS} dersine katÄ±lamadÄ±ÄŸÄ±nÄ± fark ettik..."></textarea>
                                        <button type="button" onclick="copyTemplateText('template-absence-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                    </div>
                                    <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code> (veli adÄ±), <code>{OGRENCI_AD_SOYAD}</code> (Ã¶ÄŸrenci adÄ±), <code>{TARIH}</code>, <code>{DERS}</code></small>
                                </div>
                                
                                <!-- YetiÅŸkin Ãœyeler Ä°Ã§in -->
                                <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                    <label for="template-absence-adult" style="font-weight: 600; color: #2196F3;">ğŸ‘¤ YetiÅŸkin Ãœyeler Ä°Ã§in</label>
                                    <div style="position: relative;">
                                        <textarea id="template-absence-adult" name="absenceAdult" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, {TARIH} tarihindeki {DERS} dersine katÄ±lamadÄ±ÄŸÄ±nÄ±zÄ± fark ettik..."></textarea>
                                        <button type="button" onclick="copyTemplateText('template-absence-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                    </div>
                                    <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code> (Ã¼ye adÄ±), <code>{TARIH}</code>, <code>{DERS}</code></small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                    <input type="checkbox" id="absence-enabled" name="absenceEnabled" style="width: auto;">
                                    <label for="absence-enabled" style="margin: 0;">Bu ÅŸablonu etkinleÅŸtir</label>
                                </div>
                            </div>

                            <!-- Genel Duyuru Åablonu -->
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">ğŸ“¢ Genel Duyuru Åablonu</h4>
                                
                                <!-- Ã‡ocuk Ãœyeler Ä°Ã§in -->
                                <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                    <label for="template-announcement-child" style="font-weight: 600; color: #4CAF50;">ğŸ‘¶ Ã‡ocuk Ãœyeler Ä°Ã§in (Veliye gÃ¶nderilir)</label>
                                    <div style="position: relative;">
                                        <textarea id="template-announcement-child" name="announcementChild" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, Velisi olduÄŸunuz {OGRENCI_AD_SOYAD} ile ilgili duyuru: {MESAJ}"></textarea>
                                        <button type="button" onclick="copyTemplateText('template-announcement-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                    </div>
                                    <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code>, <code>{MESAJ}</code></small>
                                </div>
                                
                                <!-- YetiÅŸkin Ãœyeler Ä°Ã§in -->
                                <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                    <label for="template-announcement-adult" style="font-weight: 600; color: #2196F3;">ğŸ‘¤ YetiÅŸkin Ãœyeler Ä°Ã§in</label>
                                    <div style="position: relative;">
                                        <textarea id="template-announcement-adult" name="announcementAdult" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, KulÃ¼bÃ¼mÃ¼zden duyuru: {MESAJ}"></textarea>
                                        <button type="button" onclick="copyTemplateText('template-announcement-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                    </div>
                                    <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code>, <code>{MESAJ}</code></small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                    <input type="checkbox" id="announcement-enabled" name="announcementEnabled" style="width: auto;">
                                    <label for="announcement-enabled" style="margin: 0;">Bu ÅŸablonu etkinleÅŸtir</label>
                                </div>
                            </div>

                            <!-- YaklaÅŸan Ã–deme HatÄ±rlatma Åablonu -->
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">â° YaklaÅŸan Ã–deme HatÄ±rlatma Åablonu</h4>
                                
                                <!-- Ã‡ocuk Ãœyeler Ä°Ã§in -->
                                <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                    <label for="template-upcomingPayment-child" style="font-weight: 600; color: #4CAF50;">ğŸ‘¶ Ã‡ocuk Ãœyeler Ä°Ã§in (Veliye gÃ¶nderilir)</label>
                                    <div style="position: relative;">
                                        <textarea id="template-upcomingPayment-child" name="upcomingPaymentChild" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, Velisi olduÄŸunuz {OGRENCI_AD_SOYAD} iÃ§in {TARIH} tarihinde {TUTAR} TL Ã¶demeniz bulunmaktadÄ±r."></textarea>
                                        <button type="button" onclick="copyTemplateText('template-upcomingPayment-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                    </div>
                                    <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code>, <code>{TUTAR}</code>, <code>{TARIH}</code>, <code>{GUN_KALDI}</code>, <code>{DONEM_BASLANGIC}</code>, <code>{DONEM_BITIS}</code>, <code>{DERS_SAYISI}</code></small>
                                </div>
                                
                                <!-- YetiÅŸkin Ãœyeler Ä°Ã§in -->
                                <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                    <label for="template-upcomingPayment-adult" style="font-weight: 600; color: #2196F3;">ğŸ‘¤ YetiÅŸkin Ãœyeler Ä°Ã§in</label>
                                    <div style="position: relative;">
                                        <textarea id="template-upcomingPayment-adult" name="upcomingPaymentAdult" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, {TARIH} tarihinde {TUTAR} TL Ã¶demeniz bulunmaktadÄ±r."></textarea>
                                        <button type="button" onclick="copyTemplateText('template-upcomingPayment-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                    </div>
                                    <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code>, <code>{TUTAR}</code>, <code>{TARIH}</code>, <code>{GUN_KALDI}</code>, <code>{DONEM_BASLANGIC}</code>, <code>{DONEM_BITIS}</code>, <code>{DERS_SAYISI}</code></small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                    <input type="checkbox" id="upcomingPayment-enabled" name="upcomingPaymentEnabled" style="width: auto;">
                                    <label for="upcomingPayment-enabled" style="margin: 0;">Bu ÅŸablonu etkinleÅŸtir</label>
                                </div>
                            </div>

                            <!-- Bekleyen KayÄ±t HatÄ±rlatma Åablonu -->
                            <div class="settings-subsection">
                                <h4 class="settings-subtitle">â³ Bekleyen KayÄ±t HatÄ±rlatma Åablonu</h4>
                                
                                <!-- Ã‡ocuk Ãœyeler Ä°Ã§in -->
                                <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                    <label for="template-pendingRegistration-child" style="font-weight: 600; color: #4CAF50;">ğŸ‘¶ Ã‡ocuk Ãœyeler Ä°Ã§in (Veliye gÃ¶nderilir)</label>
                                    <div style="position: relative;">
                                        <textarea id="template-pendingRegistration-child" name="pendingRegistrationChild" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, KulÃ¼bÃ¼mÃ¼ze {OGRENCI_AD_SOYAD} iÃ§in Ã¶n kaydÄ±nÄ±z alÄ±nmÄ±ÅŸtÄ±r ancak kayÄ±t iÅŸlemleriniz henÃ¼z tamamlanmamÄ±ÅŸtÄ±r."></textarea>
                                        <button type="button" onclick="copyTemplateText('template-pendingRegistration-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                    </div>
                                    <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code>, <code>{LINK}</code>, <code>{TARIH}</code></small>
                                </div>
                                
                                <!-- YetiÅŸkin Ãœyeler Ä°Ã§in -->
                                <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                    <label for="template-pendingRegistration-adult" style="font-weight: 600; color: #2196F3;">ğŸ‘¤ YetiÅŸkin Ãœyeler Ä°Ã§in</label>
                                    <div style="position: relative;">
                                        <textarea id="template-pendingRegistration-adult" name="pendingRegistrationAdult" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, KulÃ¼bÃ¼mÃ¼ze Ã¶n kaydÄ±nÄ±z alÄ±nmÄ±ÅŸtÄ±r ancak kayÄ±t iÅŸlemleriniz henÃ¼z tamamlanmamÄ±ÅŸtÄ±r."></textarea>
                                        <button type="button" onclick="copyTemplateText('template-pendingRegistration-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                    </div>
                                    <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code>, <code>{LINK}</code>, <code>{TARIH}</code></small>
                                </div>
                                
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                    <input type="checkbox" id="pendingRegistration-enabled" name="pendingRegistrationEnabled" style="width: auto;">
                                    <label for="pendingRegistration-enabled" style="margin: 0;">Bu ÅŸablonu etkinleÅŸtir</label>
                                </div>
                            </div>
                            </div>
                            <!-- TENÄ°S BRANÅI SONU -->
                            
                            <!-- YÃœZME BRANÅI ÅABLONLARI -->
                            <div id="branch-templates-yuzme" class="branch-templates-content" style="display: none;">
                                <div style="background: #e1f5fe; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #00bcd4;">
                                    <strong>ğŸŠ YÃ¼zme BranÅŸÄ±</strong><br>
                                    <p style="margin: 5px 0 0 0; color: #666;">YÃ¼zme branÅŸÄ±ndaki Ã¼yeler iÃ§in aÅŸaÄŸÄ±daki mesaj ÅŸablonlarÄ± kullanÄ±lacaktÄ±r.</p>
                                </div>
                                
                                <!-- DoÄŸum GÃ¼nÃ¼ Åablonu -->
                                <div class="settings-subsection">
                                    <h4 class="settings-subtitle">ğŸ‚ DoÄŸum GÃ¼nÃ¼ Kutlama Åablonu</h4>
                                    
                                    <!-- Ã‡ocuk Ãœyeler Ä°Ã§in -->
                                    <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                        <label for="template-yuzme-birthday-child" style="font-weight: 600; color: #4CAF50;">ğŸ‘¶ Ã‡ocuk Ãœyeler Ä°Ã§in (Veliye gÃ¶nderilir)</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-birthday-child" name="yuzme_birthdayChild" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, YÃ¼zÃ¼cÃ¼mÃ¼z {OGRENCI_AD_SOYAD}'nÄ±n doÄŸum gÃ¼nÃ¼nÃ¼ kutlarÄ±z! ğŸ‚ğŸŠ"></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-birthday-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                        </div>
                                        <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code></small>
                                    </div>
                                    
                                    <!-- YetiÅŸkin Ãœyeler Ä°Ã§in -->
                                    <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                        <label for="template-yuzme-birthday-adult" style="font-weight: 600; color: #2196F3;">ğŸ‘¤ YetiÅŸkin Ãœyeler Ä°Ã§in</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-birthday-adult" name="yuzme_birthdayAdult" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, DoÄŸum gÃ¼nÃ¼nÃ¼zÃ¼ kutlarÄ±z! ğŸ‚ğŸŠ"></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-birthday-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                        </div>
                                        <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code></small>
                                    </div>
                                    
                                    <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                        <input type="checkbox" id="yuzme-birthday-enabled" name="yuzme_birthdayEnabled" style="width: auto;">
                                        <label for="yuzme-birthday-enabled" style="margin: 0;">Otomatik doÄŸum gÃ¼nÃ¼ mesajlarÄ±nÄ± etkinleÅŸtir</label>
                                    </div>
                                </div>

                                <!-- GecikmiÅŸ Aidat Åablonu -->
                                <div class="settings-subsection">
                                    <h4 class="settings-subtitle">ğŸ’° GecikmiÅŸ Aidat HatÄ±rlatma Åablonu</h4>
                                    
                                    <!-- Ã‡ocuk Ãœyeler Ä°Ã§in -->
                                    <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                        <label for="template-yuzme-payment-child" style="font-weight: 600; color: #4CAF50;">ğŸ‘¶ Ã‡ocuk Ãœyeler Ä°Ã§in (Veliye gÃ¶nderilir)</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-payment-child" name="yuzme_paymentChild" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, YÃ¼zÃ¼cÃ¼mÃ¼z {OGRENCI_AD_SOYAD} iÃ§in {TUTAR} TL yÃ¼zme kursu Ã¶demeniz {TARIH} tarihinden beri gecikmiÅŸtir."></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-payment-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                        </div>
                                        <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code>, <code>{TUTAR}</code>, <code>{TARIH}</code>, <code>{DONEM_BASLANGIC}</code>, <code>{DONEM_BITIS}</code>, <code>{DERS_SAYISI}</code></small>
                                    </div>
                                    
                                    <!-- YetiÅŸkin Ãœyeler Ä°Ã§in -->
                                    <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                        <label for="template-yuzme-payment-adult" style="font-weight: 600; color: #2196F3;">ğŸ‘¤ YetiÅŸkin Ãœyeler Ä°Ã§in</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-payment-adult" name="yuzme_paymentAdult" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, {TUTAR} TL yÃ¼zme kursu Ã¶demeniz {TARIH} tarihinden beri gecikmiÅŸtir."></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-payment-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                        </div>
                                        <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code>, <code>{TUTAR}</code>, <code>{TARIH}</code>, <code>{DONEM_BASLANGIC}</code>, <code>{DONEM_BITIS}</code>, <code>{DERS_SAYISI}</code></small>
                                    </div>
                                    
                                    <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                        <input type="checkbox" id="yuzme-payment-enabled" name="yuzme_paymentEnabled" style="width: auto;">
                                        <label for="yuzme-payment-enabled" style="margin: 0;">Bu ÅŸablonu etkinleÅŸtir</label>
                                    </div>
                                </div>

                                <!-- DevamsÄ±zlÄ±k Åablonu -->
                                <div class="settings-subsection">
                                    <h4 class="settings-subtitle">ğŸ“… DevamsÄ±zlÄ±k Bildirimi Åablonu</h4>
                                    
                                    <!-- Ã‡ocuk Ãœyeler Ä°Ã§in -->
                                    <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                        <label for="template-yuzme-absence-child" style="font-weight: 600; color: #4CAF50;">ğŸ‘¶ Ã‡ocuk Ãœyeler Ä°Ã§in (Veliye gÃ¶nderilir)</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-absence-child" name="yuzme_absenceChild" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, YÃ¼zÃ¼cÃ¼mÃ¼z {OGRENCI_AD_SOYAD}'nÄ±n {TARIH} tarihindeki yÃ¼zme dersine katÄ±lamadÄ±ÄŸÄ±nÄ± fark ettik..."></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-absence-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                        </div>
                                        <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code> (veli adÄ±), <code>{OGRENCI_AD_SOYAD}</code> (Ã¶ÄŸrenci adÄ±), <code>{TARIH}</code>, <code>{DERS}</code></small>
                                    </div>
                                    
                                    <!-- YetiÅŸkin Ãœyeler Ä°Ã§in -->
                                    <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                        <label for="template-yuzme-absence-adult" style="font-weight: 600; color: #2196F3;">ğŸ‘¤ YetiÅŸkin Ãœyeler Ä°Ã§in</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-absence-adult" name="yuzme_absenceAdult" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, {TARIH} tarihindeki yÃ¼zme dersine katÄ±lamadÄ±ÄŸÄ±nÄ±zÄ± fark ettik..."></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-absence-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                        </div>
                                        <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code> (Ã¼ye adÄ±), <code>{TARIH}</code>, <code>{DERS}</code></small>
                                    </div>
                                    
                                    <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                        <input type="checkbox" id="yuzme-absence-enabled" name="yuzme_absenceEnabled" style="width: auto;">
                                        <label for="yuzme-absence-enabled" style="margin: 0;">Bu ÅŸablonu etkinleÅŸtir</label>
                                    </div>
                                </div>

                                <!-- Genel Duyuru Åablonu -->
                                <div class="settings-subsection">
                                    <h4 class="settings-subtitle">ğŸ“¢ Genel Duyuru Åablonu</h4>
                                    
                                    <!-- Ã‡ocuk Ãœyeler Ä°Ã§in -->
                                    <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                        <label for="template-yuzme-announcement-child" style="font-weight: 600; color: #4CAF50;">ğŸ‘¶ Ã‡ocuk Ãœyeler Ä°Ã§in (Veliye gÃ¶nderilir)</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-announcement-child" name="yuzme_announcementChild" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, YÃ¼zÃ¼cÃ¼mÃ¼z {OGRENCI_AD_SOYAD} ile ilgili duyuru: {MESAJ}"></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-announcement-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                        </div>
                                        <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code>, <code>{MESAJ}</code></small>
                                    </div>
                                    
                                    <!-- YetiÅŸkin Ãœyeler Ä°Ã§in -->
                                    <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                        <label for="template-yuzme-announcement-adult" style="font-weight: 600; color: #2196F3;">ğŸ‘¤ YetiÅŸkin Ãœyeler Ä°Ã§in</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-announcement-adult" name="yuzme_announcementAdult" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, YÃ¼zme kulÃ¼bÃ¼mÃ¼zden duyuru: {MESAJ}"></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-announcement-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                        </div>
                                        <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code>, <code>{MESAJ}</code></small>
                                    </div>
                                    
                                    <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                        <input type="checkbox" id="yuzme-announcement-enabled" name="yuzme_announcementEnabled" style="width: auto;">
                                        <label for="yuzme-announcement-enabled" style="margin: 0;">Bu ÅŸablonu etkinleÅŸtir</label>
                                    </div>
                                </div>

                                <!-- YaklaÅŸan Ã–deme HatÄ±rlatma Åablonu -->
                                <div class="settings-subsection">
                                    <h4 class="settings-subtitle">â° YaklaÅŸan Ã–deme HatÄ±rlatma Åablonu</h4>
                                    
                                    <!-- Ã‡ocuk Ãœyeler Ä°Ã§in -->
                                    <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                        <label for="template-yuzme-upcomingPayment-child" style="font-weight: 600; color: #4CAF50;">ğŸ‘¶ Ã‡ocuk Ãœyeler Ä°Ã§in (Veliye gÃ¶nderilir)</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-upcomingPayment-child" name="yuzme_upcomingPaymentChild" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, YÃ¼zÃ¼cÃ¼mÃ¼z {OGRENCI_AD_SOYAD} iÃ§in {TARIH} tarihinde {TUTAR} TL Ã¶demeniz bulunmaktadÄ±r."></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-upcomingPayment-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                        </div>
                                        <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code>, <code>{TUTAR}</code>, <code>{TARIH}</code>, <code>{GUN_KALDI}</code>, <code>{DONEM_BASLANGIC}</code>, <code>{DONEM_BITIS}</code>, <code>{DERS_SAYISI}</code></small>
                                    </div>
                                    
                                    <!-- YetiÅŸkin Ãœyeler Ä°Ã§in -->
                                    <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                        <label for="template-yuzme-upcomingPayment-adult" style="font-weight: 600; color: #2196F3;">ğŸ‘¤ YetiÅŸkin Ãœyeler Ä°Ã§in</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-upcomingPayment-adult" name="yuzme_upcomingPaymentAdult" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, {TARIH} tarihinde {TUTAR} TL Ã¶demeniz bulunmaktadÄ±r."></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-upcomingPayment-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                        </div>
                                        <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code>, <code>{TUTAR}</code>, <code>{TARIH}</code>, <code>{GUN_KALDI}</code>, <code>{DONEM_BASLANGIC}</code>, <code>{DONEM_BITIS}</code>, <code>{DERS_SAYISI}</code></small>
                                    </div>
                                    
                                    <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                        <input type="checkbox" id="yuzme-upcomingPayment-enabled" name="yuzme_upcomingPaymentEnabled" style="width: auto;">
                                        <label for="yuzme-upcomingPayment-enabled" style="margin: 0;">Bu ÅŸablonu etkinleÅŸtir</label>
                                    </div>
                                </div>

                                <!-- Bekleyen KayÄ±t HatÄ±rlatma Åablonu -->
                                <div class="settings-subsection">
                                    <h4 class="settings-subtitle">â³ Bekleyen KayÄ±t HatÄ±rlatma Åablonu</h4>
                                    
                                    <!-- Ã‡ocuk Ãœyeler Ä°Ã§in -->
                                    <div class="form-group" style="border-left: 4px solid #4CAF50; padding-left: 15px; margin-bottom: 20px;">
                                        <label for="template-yuzme-pendingRegistration-child" style="font-weight: 600; color: #4CAF50;">ğŸ‘¶ Ã‡ocuk Ãœyeler Ä°Ã§in (Veliye gÃ¶nderilir)</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-pendingRegistration-child" name="yuzme_pendingRegistrationChild" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, YÃ¼zme kulÃ¼bÃ¼mÃ¼ze {OGRENCI_AD_SOYAD} iÃ§in Ã¶n kaydÄ±nÄ±z alÄ±nmÄ±ÅŸtÄ±r ancak kayÄ±t iÅŸlemleriniz henÃ¼z tamamlanmamÄ±ÅŸtÄ±r."></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-pendingRegistration-child')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                        </div>
                                        <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code> (veli), <code>{OGRENCI_AD_SOYAD}</code>, <code>{LINK}</code>, <code>{TARIH}</code></small>
                                    </div>
                                    
                                    <!-- YetiÅŸkin Ãœyeler Ä°Ã§in -->
                                    <div class="form-group" style="border-left: 4px solid #2196F3; padding-left: 15px;">
                                        <label for="template-yuzme-pendingRegistration-adult" style="font-weight: 600; color: #2196F3;">ğŸ‘¤ YetiÅŸkin Ãœyeler Ä°Ã§in</label>
                                        <div style="position: relative;">
                                            <textarea id="template-yuzme-pendingRegistration-adult" name="yuzme_pendingRegistrationAdult" class="form-control" rows="5" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, YÃ¼zme kulÃ¼bÃ¼mÃ¼ze Ã¶n kaydÄ±nÄ±z alÄ±nmÄ±ÅŸtÄ±r ancak kayÄ±t iÅŸlemleriniz henÃ¼z tamamlanmamÄ±ÅŸtÄ±r."></textarea>
                                            <button type="button" onclick="copyTemplateText('template-yuzme-pendingRegistration-adult')" style="position: absolute; top: 5px; right: 5px; padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;" title="Kopyala">ğŸ“‹</button>
                                        </div>
                                        <small style="color: #666;">KullanÄ±labilir: <code>{UYE_AD_SOYAD}</code>, <code>{LINK}</code>, <code>{TARIH}</code></small>
                                    </div>
                                    
                                    <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 15px;">
                                        <input type="checkbox" id="yuzme-pendingRegistration-enabled" name="yuzme_pendingRegistrationEnabled" style="width: auto;">
                                        <label for="yuzme-pendingRegistration-enabled" style="margin: 0;">Bu ÅŸablonu etkinleÅŸtir</label>
                                    </div>
                                </div>
                            </div>
                            <!-- YÃœZME BRANÅI SONU -->
                            
                            <!-- GÃ–REV ÅABLONLARI -->
                            <div id="branch-templates-gorev" class="branch-templates-content" style="display: none;">
                                <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #9c27b0;">
                                    <strong>ğŸ“‹ GÃ¶rev ÅablonlarÄ±</strong><br>
                                    <p style="margin: 5px 0 0 0; color: #666;">GÃ¶rev yÃ¶netimi iÃ§in kullanÄ±lan mesaj ÅŸablonlarÄ±.</p>
                                </div>
                                
                                <!-- GÃ¶rev Bildirimi Åablonu -->
                                <div class="settings-subsection">
                                    <h4 class="settings-subtitle">ğŸ“‹ GÃ¶rev Bildirimi Åablonu</h4>
                                    <div class="form-group">
                                        <label for="template-task">Mesaj Metni</label>
                                        <textarea id="template-task" name="task" class="form-control" rows="6" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, Size yeni bir gÃ¶rev atandÄ±: {GOREV}. AÃ§Ä±klama: {ACIKLAMA}"></textarea>
                                        <small style="color: #666;">KullanÄ±labilir deÄŸiÅŸkenler: <code>{UYE_AD_SOYAD}</code>, <code>{GOREV}</code>, <code>{ACIKLAMA}</code>, <code>{TARIH}</code></small>
                                    </div>
                                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="task-enabled" name="taskEnabled" style="width: auto;">
                                        <label for="task-enabled" style="margin: 0;">GÃ¶rev atandÄ±ÄŸÄ±nda otomatik mesaj gÃ¶nder</label>
                                    </div>
                                </div>

                                <!-- GÃ¶rev MesajÄ± Bildirimi Åablonu -->
                                <div class="settings-subsection">
                                    <h4 class="settings-subtitle">ğŸ’¬ GÃ¶rev MesajÄ± Bildirimi Åablonu</h4>
                                    <div class="form-group">
                                        <label for="template-taskMessage">Mesaj Metni</label>
                                        <textarea id="template-taskMessage" name="taskMessage" class="form-control" rows="7" placeholder="Ã–rn: SayÄ±n {UYE_AD_SOYAD}, {GOREV} gÃ¶revi iÃ§in yeni bir mesaj aldÄ±nÄ±z: {MESAJ}"></textarea>
                                        <small style="color: #666;">KullanÄ±labilir deÄŸiÅŸkenler: <code>{UYE_AD_SOYAD}</code>, <code>{GOREV}</code>, <code>{MESAJ}</code>, <code>{GONDEREN}</code>, <code>{TARIH}</code></small>
                                    </div>
                                    <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="taskMessage-enabled" name="taskMessageEnabled" style="width: auto;">
                                        <label for="taskMessage-enabled" style="margin: 0;">GÃ¶rev mesajÄ± eklendiÄŸinde otomatik bildirim gÃ¶nder</label>
                                    </div>
                                </div>
                            </div>
                            <!-- GÃ–REV ÅABLONLARI SONU -->

                            <button type="submit" class="btn btn-primary" style="margin-top: 20px;">ğŸ’¾ ÅablonlarÄ± Kaydet</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- WhatsApp Section -->
            <div id="whatsapp" class="section">
                <div class="card">

                    <!-- Tab Content: MesajlaÅŸma -->
                    <div id="whatsapp-tab-messages" class="settings-tab-content active">
                        <!-- Step 1: Cihaz SeÃ§imi -->
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0;">ğŸ“± 1. WhatsApp CihazÄ± SeÃ§in</h4>
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <select id="whatsapp-active-device" class="form-control" style="flex: 1; max-width: 400px;" onchange="onDeviceSelectionChange()">
                                    <option value="">Bir cihaz seÃ§in...</option>
                                </select>
                                <div id="whatsapp-device-info" style="flex: 1; color: #666; font-size: 14px;"></div>
                            </div>
                        </div>

                        <!-- Step 2: MesajlaÅŸma AlanÄ± (Cihaz seÃ§ilince gÃ¶rÃ¼nÃ¼r) -->
                        <div id="whatsapp-messaging-area" style="display: none;">
                            <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: 600px;">
                                <!-- Contacts List -->
                                <div style="border-right: 2px solid #eee; padding-right: 15px; overflow-y: auto;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h4 style="margin: 0;">ğŸ’¬ KonuÅŸmalar</h4>
                                        <button class="btn btn-success btn-sm" onclick="toggleNewMessageForm()" title="Yeni mesaj gÃ¶nder">
                                            âœ‰ï¸ Yeni Mesaj
                                        </button>
                                    </div>
                                    
                                    <!-- Inline Yeni Mesaj Formu -->
                                    <div id="new-message-inline-form" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #28a745;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                            <strong style="color: #28a745;">âœ‰ï¸ Yeni Mesaj</strong>
                                            <button onclick="toggleNewMessageForm()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #666;">Ã—</button>
                                        </div>
                                        
                                        <!-- Telefon NumarasÄ± Input -->
                                        <div style="margin-bottom: 10px;">
                                            <input type="tel" id="new-message-phone-inline" class="form-control" placeholder="05xxxxxxxxx" style="font-size: 14px;">
                                            <small style="color: #666; font-size: 11px;">Ã–rnek: 05449367543 veya 905449367543</small>
                                        </div>
                                        
                                        <!-- Mesaj Textarea (BaÅŸlangÄ±Ã§ta gizli) -->
                                        <div id="new-message-text-area" style="display: none;">
                                            <textarea id="new-message-text-inline" class="form-control" rows="3" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." style="font-size: 14px; margin-bottom: 10px;"></textarea>
                                            <button class="btn btn-success btn-sm btn-block" onclick="sendNewMessageInline()">ğŸ“¤ GÃ¶nder</button>
                                        </div>
                                        
                                        <!-- Kontrol Butonu -->
                                        <button id="check-phone-btn" class="btn btn-primary btn-sm btn-block" onclick="checkPhoneAndProceed()">â–¶ï¸ Devam Et</button>
                                    </div>
                                    
                                    <input type="text" id="contact-search" class="form-control" placeholder="ğŸ” KiÅŸi ara..." style="margin-bottom: 15px;">
                                    <div id="whatsapp-contacts-list">
                                        <p class="empty-state">YÃ¼kleniyor...</p>
                                    </div>
                                </div>

                                <!-- Messages Area -->
                                <div style="display: flex; flex-direction: column;">
                                    <div id="whatsapp-chat-header" style="padding: 15px; background: #f8f9fa; border-radius: 8px 8px 0 0; border-bottom: 2px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <h4 id="whatsapp-selected-contact" style="margin: 0;">Bir kiÅŸi seÃ§in</h4>
                                            <small id="whatsapp-selected-phone" style="color: #666;"></small>
                                        </div>
                                        <button id="refresh-messages-btn" class="btn btn-sm btn-secondary" onclick="refreshCurrentMessages()" style="display: none;">
                                            ğŸ”„ Yenile
                                        </button>
                                    </div>
                                    
                                    <div id="whatsapp-messages-header" style="display: none; padding: 12px 20px; background: linear-gradient(135deg, #075E54 0%, #128C7E 100%); border-radius: 8px 8px 0 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <!-- Left: Profile & Info -->
                                            <div style="display: flex; align-items: center; gap: 12px; flex: 1; cursor: pointer;" onclick="showContactInfo()">
                                                <!-- Profile Picture with Online Status -->
                                                <div style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                                    <span id="chat-contact-initial">U</span>
                                                </div>
                                                
                                                <!-- Name & Status -->
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="display: flex; align-items: center; gap: 6px;">
                                                        <strong id="chat-contact-name" style="color: white; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px;"></strong>
                                                        <!-- Member/CRM Badge -->
                                                        <span id="chat-contact-badge" style="display: none; font-size: 10px; padding: 2px 6px; border-radius: 10px; color: white;"></span>
                                                    </div>
                                                    <div style="display: flex; align-items: center; gap: 4px; font-size: 12px; color: rgba(255,255,255,0.8);">
                                                        <span id="chat-contact-phone"></span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Right: Action Buttons -->
                                            <div style="display: flex; gap: 8px; align-items: center;">
                                                <!-- Search Messages -->
                                                <button onclick="searchInMessages()" title="Mesajlarda Ara" style="background: rgba(255,255,255,0.15); color: white; border: none; padding: 10px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.3s; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                                                    ğŸ”
                                                </button>
                                                
                                                <!-- More Options -->
                                                <button onclick="showMoreOptions()" title="Daha Fazla" style="background: rgba(255,255,255,0.15); color: white; border: none; padding: 10px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.3s; cursor: pointer;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                                                    â‹®
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="whatsapp-messages-area" style="flex: 1; overflow-y: auto; padding: 20px; background-color: #E8DED3; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,.05) 10px, rgba(255,255,255,.05) 20px); max-height: calc(100vh - 300px); min-height: 400px;">
                                        <div class="empty-state" style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                            <p style="margin: 0; color: #666; font-size: 15px;">ğŸ‘ˆ Soldan bir kiÅŸi seÃ§in ve mesajlaÅŸmaya baÅŸlayÄ±n</p>
                                        </div>
                                    </div>

                                    <div id="whatsapp-message-input" style="padding: 12px 15px; background: #F0F0F0; border-radius: 0 0 8px 8px; display: none; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);">
                                        <form id="whatsappSendMessageForm" style="display: flex; gap: 10px; align-items: flex-end;">
                                            <input type="hidden" id="whatsapp-selected-number" />
                                            <textarea id="whatsapp-message-text" class="form-control" rows="1" placeholder="Bir mesaj yazÄ±n..." required style="resize: none; border-radius: 20px; border: 1px solid #ddd; padding: 10px 15px; font-size: 14px; max-height: 100px; background: white;" oninput="this.style.height='auto'; this.style.height=Math.min(this.scrollHeight, 100)+'px'" onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); this.closest('form').requestSubmit();}"></textarea>
                                            <button type="submit" class="btn" style="background: #25D366; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.3s; padding: 0;" onmouseover="this.style.background='#128C7E'" onmouseout="this.style.background='#25D366'">
                                                <span style="transform: rotate(-45deg); display: inline-block;">âœˆï¸</span>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Aramalar -->
                    <!-- Tab Content: Cihazlar -->
                    <div id="whatsapp-tab-devices" class="settings-tab-content">
                        <h4 style="margin-bottom: 20px;">ğŸ“± WhatsApp Cihaz YÃ¶netimi</h4>
                        
                        <!-- Add New Device -->
                        <div class="settings-subsection">
                            <h4 class="settings-subtitle">â• Yeni Cihaz Ekle</h4>
                            <form id="whatsappInstanceForm-new">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="newInstanceName">Cihaz AdÄ± *</label>
                                        <input type="text" id="newInstanceName" name="instanceName" class="form-control" placeholder="Ã–rn: Kulup WhatsApp" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="newInstancePhone">Telefon NumarasÄ± *</label>
                                        <input type="tel" id="newInstancePhone" name="phoneNumber" class="form-control" placeholder="905xxxxxxxxx" required>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success">ğŸ”— Cihaz OluÅŸtur ve QR Kod Al</button>
                            </form>
                        </div>

                        <!-- Ana Hat SeÃ§imi -->
                        <div class="settings-subsection" style="background: #fff9e6; border-left: 4px solid #ffc107;">
                            <h4 class="settings-subtitle">â­ Ana WhatsApp HattÄ±</h4>
                            <p style="margin-bottom: 15px; color: #856404; font-size: 13px;">
                                ğŸ“¢ Otomatik bildirimlerde (gÃ¶rev, Ã¶deme hatÄ±rlatma vb.) bu hat kullanÄ±lacaktÄ±r.
                            </p>
                            <div class="form-group">
                                <label for="defaultWhatsAppDevice">VarsayÄ±lan Cihaz</label>
                                <select id="defaultWhatsAppDevice" class="form-control" onchange="setDefaultWhatsAppDevice(this.value)">
                                    <option value="">Cihaz seÃ§in...</option>
                                </select>
                            </div>
                        </div>

                        <!-- Send Test Message -->
                        <div class="settings-subsection" style="background: #e7f5ff; border-left: 4px solid #1890ff;">
                            <h4 class="settings-subtitle">ğŸ“¨ Test MesajÄ± GÃ¶nder</h4>
                            <p style="margin-bottom: 15px; color: #0066cc; font-size: 13px;">
                                ğŸ’¡ BaÄŸlÄ± bir cihazÄ±nÄ±z varsa buradan test mesajÄ± gÃ¶nderebilirsiniz.
                            </p>
                            <form id="testMessageForm" onsubmit="window.sendTestWhatsAppMessage(event)">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="testMessageDevice">Cihaz SeÃ§in *</label>
                                        <select id="testMessageDevice" class="form-control" required>
                                            <option value="">Ã–nce cihaz baÄŸlayÄ±n...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="testMessagePhone">AlÄ±cÄ± Telefon NumarasÄ± *</label>
                                        <input type="tel" id="testMessagePhone" class="form-control" placeholder="905xxxxxxxxx" required>
                                        <small style="color: #666;">Ã–rnek: 905449367543 (90 ile baÅŸlamalÄ±)</small>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="testMessageText">Mesaj Metni *</label>
                                    <textarea id="testMessageText" class="form-control" rows="3" placeholder="Merhaba, bu bir test mesajÄ±dÄ±r." required></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">ğŸ“¤ Mesaj GÃ¶nder</button>
                            </form>
                        </div>

                        <!-- Connected Devices -->
                        <div class="settings-subsection">
                            <h4 class="settings-subtitle">ğŸ“‹ BaÄŸlÄ± Cihazlar</h4>
                            <div id="whatsappDevicesList-main">
                                <p class="empty-state">HenÃ¼z baÄŸlÄ± cihaz yok.</p>
                            </div>
                        </div>

                        <!-- âœ… Random Mesaj Bekleme SÃ¼resi AyarlarÄ± -->
                        <div class="settings-subsection">
                            <h4 class="settings-subtitle">ğŸ“± WhatsApp Mesaj GÃ¶nderim SÃ¼releri</h4>
                            <p style="color: #666; margin-bottom: 15px;">
                                Toplu mesaj gÃ¶nderimlerinde mesajlar arasÄ±nda random (rastgele) bekleme sÃ¼releri kullanÄ±lÄ±r. 
                                Bu sayede mesajlar daha doÄŸal gÃ¶rÃ¼nÃ¼r ve WhatsApp limitlerini aÅŸmamÄ±ÅŸ olursunuz.
                            </p>
                            
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                                <div class="form-group">
                                    <label for="minWaitTime">Min Bekleme (sn) *</label>
                                    <input type="number" id="minWaitTime" name="minWaitTime" class="form-control" 
                                           min="5" max="60" value="20">
                                    <small style="color: #666; display: block; margin-top: 4px;">Minimum bekleme sÃ¼resi</small>
                                </div>
                                <div class="form-group">
                                    <label for="maxWaitTime">Max Bekleme (sn) *</label>
                                    <input type="number" id="maxWaitTime" name="maxWaitTime" class="form-control" 
                                           min="10" max="120" value="50">
                                    <small style="color: #666; display: block; margin-top: 4px;">Maximum bekleme sÃ¼resi</small>
                                </div>
                            </div>
                            
                            <div class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                                <div class="form-group">
                                    <label for="longWaitTrigger">Uzun Bekleme Tetikleyicisi *</label>
                                    <input type="number" id="longWaitTrigger" name="longWaitTrigger" class="form-control" 
                                           min="10" max="500" value="100">
                                    <small style="color: #666; display: block; margin-top: 4px;">Her X mesajda bir uzun bekleme</small>
                                </div>
                                <div class="form-group">
                                    <label for="minLongWait">Min Uzun Bekleme (sn) *</label>
                                    <input type="number" id="minLongWait" name="minLongWait" class="form-control" 
                                           min="60" max="600" value="400">
                                    <small style="color: #666; display: block; margin-top: 4px;">Uzun beklemede minimum sÃ¼re</small>
                                </div>
                                <div class="form-group">
                                    <label for="maxLongWait">Max Uzun Bekleme (sn) *</label>
                                    <input type="number" id="maxLongWait" name="maxLongWait" class="form-control" 
                                           min="120" max="1200" value="800">
                                    <small style="color: #666; display: block; margin-top: 4px;">Uzun beklemede maximum sÃ¼re</small>
                                </div>
                            </div>
                            
                            <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; border-left: 4px solid #2196F3; margin-top: 10px;">
                                <strong>â„¹ï¸ Ã–rnek:</strong> 100 mesaj gÃ¶nderildiÄŸinde, her mesaj arasÄ±nda 20-50 saniye beklenecek. 
                                Her 100 mesajda bir ise 400-800 saniye uzun bekleme yapÄ±lacak.
                            </div>
                        </div>

                        <!-- âœ… Ã‡alÄ±ÅŸma Saatleri AyarlarÄ± -->
                        <div class="settings-subsection">
                            <h4 class="settings-subtitle">ğŸ• Mesaj GÃ¶nderim Ã‡alÄ±ÅŸma Saatleri</h4>
                            <p style="color: #666; margin-bottom: 15px;">
                                BelirlediÄŸiniz saat aralÄ±ÄŸÄ± dÄ±ÅŸÄ±nda gÃ¶nderilmeye Ã§alÄ±ÅŸÄ±lan mesajlar otomatik olarak sÄ±raya alÄ±nÄ±r ve uygun saatte gÃ¶nderilir.
                            </p>
                            
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="workingHoursEnabled" onchange="toggleWorkingHoursFields()">
                                    <strong>Ã‡alÄ±ÅŸma Saatleri Aktif</strong>
                                </label>
                            </div>
                            
                            <div id="workingHoursFields" style="display: none;">
                                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                                    <div class="form-group">
                                        <label for="workingHoursStart">BaÅŸlangÄ±Ã§ Saati</label>
                                        <input type="time" id="workingHoursStart" class="form-control" value="09:00">
                                    </div>
                                    <div class="form-group">
                                        <label for="workingHoursEnd">BitiÅŸ Saati</label>
                                        <input type="time" id="workingHoursEnd" class="form-control" value="18:00">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Ã‡alÄ±ÅŸma GÃ¼nleri</label>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px;">
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="workDay-1" checked> Pazartesi
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="workDay-2" checked> SalÄ±
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="workDay-3" checked> Ã‡arÅŸamba
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="workDay-4" checked> PerÅŸembe
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="workDay-5" checked> Cuma
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="workDay-6"> Cumartesi
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" id="workDay-0"> Pazar
                                        </label>
                                    </div>
                                </div>
                                
                                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-top: 10px;">
                                    <strong>âš ï¸ Ã–nemli:</strong> Ã‡alÄ±ÅŸma saatleri dÄ±ÅŸÄ±nda gÃ¶nderilmeye Ã§alÄ±ÅŸÄ±lan mesajlar sÄ±raya alÄ±nÄ±r ve bir sonraki uygun Ã§alÄ±ÅŸma saatinde otomatik olarak gÃ¶nderilir.
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-primary" style="margin-top: 15px;" onclick="saveWhatsAppSettings()">ğŸ’¾ TÃ¼m AyarlarÄ± Kaydet</button>
                        </div>

                    </div>

                    <!-- Tab Content: Toplu Mesaj -->
                    <div id="whatsapp-tab-bulk" class="settings-tab-content">
                        <h4 style="margin-bottom: 20px;">ğŸ“¤ Toplu Mesaj GÃ¶nderimi</h4>
                        
                        <div class="settings-subsection">
                            <form id="bulkMessageForm">
                                <!-- Step 1: BranÅŸ SeÃ§imi -->
                                <div class="form-group">
                                    <label>1ï¸âƒ£ BranÅŸ SeÃ§in *</label>
                                    <select class="form-control" id="bulk-branch-selector" required>
                                        <option value="">BranÅŸ seÃ§in...</option>
                                        <!-- BranÅŸlar dinamik olarak yÃ¼klenecek -->
                                        <option value="all">âœ¨ TÃ¼m BranÅŸlar</option>
                                    </select>
                                </div>
                                
                                <!-- Step 2: Grup SeÃ§imi (Ã‡oklu) -->
                                <div class="form-group" id="bulk-groups-container" style="display: none;">
                                    <label>2ï¸âƒ£ GruplarÄ± SeÃ§in</label>
                                    <div style="margin-bottom: 10px;">
                                        <input type="text" id="bulk-group-search" class="form-control" placeholder="ğŸ” Grup ara..." style="margin-bottom: 10px;" oninput="filterBulkGroups()">
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="selectAllGroups()">âœ“ Hepsini Ä°ÅŸaretle</button>
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="deselectAllGroups()">âœ— Temizle</button>
                                        <button type="button" class="btn btn-sm btn-primary" onclick="confirmGroupSelection()">âœ… Onayla ve Devam Et</button>
                                    </div>
                                    <div id="bulk-groups-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #f8f9fa;">
                                        <!-- Gruplar buraya yÃ¼klenecek -->
                                    </div>
                                </div>
                                
                                <!-- Step 3: SeÃ§ilen KiÅŸiler Listesi -->
                                <div class="form-group" id="bulk-recipients-container" style="display: none;">
                                    <label>3ï¸âƒ£ Mesaj Alacak KiÅŸiler <span id="bulk-recipient-count-badge" class="badge bg-primary">0</span></label>
                                    <div style="margin-bottom: 10px;">
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="selectAllRecipients()">âœ“ Hepsini Ä°ÅŸaretle</button>
                                        <button type="button" class="btn btn-sm btn-secondary" onclick="deselectAllRecipients()">âœ— Temizle</button>
                                        <button type="button" class="btn btn-sm btn-success" onclick="confirmRecipientSelection()">âœ… KiÅŸileri Onayla</button>
                                    </div>
                                    <div id="bulk-recipients-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #fff;">
                                        <!-- KiÅŸiler buraya yÃ¼klenecek -->
                                    </div>
                                </div>

                                <!-- Mesaj Metni -->
                                <div class="form-group">
                                    <label>4ï¸âƒ£ Mesaj Metni *</label>
                                    <textarea class="form-control" id="bulk-message-text" rows="5" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." required></textarea>
                                    <div style="margin-top: 8px; padding: 10px; background: #f0f8ff; border-radius: 6px; border: 1px solid #b3d9ff;">
                                        <strong style="color: #0066cc;">ğŸ’¡ KullanÄ±labilecek DeÄŸiÅŸkenler:</strong>
                                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                                            <code style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{UYE_AD_SOYAD}</code>
                                            <code style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{OGRENCI_AD_SOYAD}</code>
                                            <code style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{TUTAR}</code>
                                            <code style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{TARIH}</code>
                                            <code style="background: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">{MESAJ}</code>
                                        </div>
                                        <small style="color: #666; margin-top: 6px; display: block;">
                                            <strong>{UYE_AD_SOYAD}:</strong> YetiÅŸkinde Ã¼yenin kendisi, Ã§ocukta veli adÄ± | 
                                            <strong>{OGRENCI_AD_SOYAD}:</strong> Sadece Ã§ocuk Ã¼yelerde Ã¶ÄŸrenci adÄ±
                                        </small>
                                    </div>
                                </div>

                                <!-- GÃ¶nderim Bilgisi -->
                                <div style="padding: 15px; background: #e7f3ff; border-radius: 8px; margin-bottom: 15px;">
                                    <strong>ğŸ“Š GÃ¶nderim Ã–zeti:</strong>
                                    <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                                        <li>AlÄ±cÄ± sayÄ±sÄ±: <strong id="bulk-final-count">0</strong> kiÅŸi</li>
                                        <li>Her mesaj arasÄ±: <strong id="bulk-wait-time-display">${clubSettings.minWaitTime || 20}-${clubSettings.maxWaitTime || 50} saniye</strong> (rastgele)</li>
                                        <li>Her <strong id="bulk-long-wait-trigger">${clubSettings.longWaitTrigger || 100}</strong> mesajda bir: <strong id="bulk-long-wait-display">${clubSettings.minLongWait || 400}-${clubSettings.maxLongWait || 800} saniye</strong> uzun bekleme</li>
                                        <li>Tahmini sÃ¼re: <strong id="bulk-estimated-time">-</strong></li>
                                    </ul>
                                    <small style="color: #666; margin-top: 8px; display: block;">
                                        âš™ï¸ AyarlarÄ± deÄŸiÅŸtirmek iÃ§in WhatsApp > Cihazlar > Mesaj GÃ¶nderim AyarlarÄ± bÃ¶lÃ¼mÃ¼ne gidin.
                                    </small>
                                </div>

                                <!-- GÃ¶nderim Durumu -->
                                <div id="bulk-sending-status" style="display: none; padding: 15px; background: #fff3cd; border-radius: 8px; margin-bottom: 15px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                        <div class="spinner-border spinner-border-sm" role="status"></div>
                                        <strong>Mesajlar gÃ¶nderiliyor...</strong>
                                    </div>
                                    <div class="progress" style="height: 25px;">
                                        <div id="bulk-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0 / 0</div>
                                    </div>
                                    <div id="bulk-status-log" style="margin-top: 10px; max-height: 150px; overflow-y: auto; font-size: 12px; font-family: monospace; background: #fff; padding: 10px; border-radius: 4px;">
                                        <!-- Log mesajlarÄ± buraya -->
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary btn-lg" id="bulk-send-btn">ğŸ“¤ Toplu Mesaj GÃ¶nder</button>
                            </form>
                        </div>
                    </div>

                    <!-- Tab Content: Kampanyalar -->
                    <div id="whatsapp-tab-campaigns" class="settings-tab-content">
                        <h4 style="margin-bottom: 20px;">ğŸ“¢ WhatsApp Kampanya YÃ¶netimi</h4>
                        
                        <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196F3;">
                            <strong>â„¹ï¸ Kampanya Nedir?</strong>
                            <p style="margin: 10px 0 0 0; color: #666; font-size: 14px;">
                                Kampanyalar ile binlerce kiÅŸiye otomatik olarak mesaj gÃ¶nderebilirsiniz. Sistem, mesajlarÄ± belirlediÄŸiniz sÃ¼rede ve Ã§alÄ±ÅŸma saatleri iÃ§inde parÃ§alÄ± olarak gÃ¶nderir.
                            </p>
                        </div>
                        
                        <!-- Aktif Kampanyalar Listesi -->
                        <div id="campaigns-list" style="margin-top: 20px;">
                            <div class="loading"><div class="spinner"></div><span>Kampanyalar yÃ¼kleniyor...</span></div>
                        </div>
                    </div>

                    <!-- Tab Content: Mesaj KuyruÄŸu -->
                    <div id="whatsapp-tab-queue" class="settings-tab-content">
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h2 style="color: white; margin: 0 0 10px 0; font-size: 28px; font-weight: 600;">ğŸ“‹ Bekleyen Mesaj KuyruÄŸu</h2>
                                <p style="color: rgba(255,255,255,0.9); margin: 0; font-size: 14px;">GÃ¶nderilmeyi bekleyen mesajlarÄ± gÃ¶rÃ¼ntÃ¼leyin ve yÃ¶netin</p>
                            </div>
                            <button class="btn" onclick="renderMessageQueue()" style="background: white; color: #f093fb; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: all 0.3s;">
                                ğŸ”„ Yenile
                            </button>
                        </div>
                        
                        <div class="settings-subsection">
                            <div id="messageQueueList">
                                <p class="empty-state">Kuyrukta bekleyen mesaj yok.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Content: Mesaj RaporlarÄ± -->
                    <div id="whatsapp-tab-reports" class="settings-tab-content">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <h2 style="color: white; margin: 0 0 10px 0; font-size: 28px; font-weight: 600;">ğŸ“Š Mesaj RaporlarÄ±</h2>
                            <p style="color: rgba(255,255,255,0.9); margin: 0; font-size: 14px;">WhatsApp mesajlarÄ±nÄ±zÄ±n detaylÄ± raporlarÄ±nÄ± gÃ¶rÃ¼ntÃ¼leyin</p>
                        </div>
                        
                        <!-- Statistics Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); position: relative; overflow: hidden;">
                                <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                                <div style="font-size: 36px; font-weight: 700; color: white; margin-bottom: 8px; position: relative; z-index: 1;" id="report-success-count">0</div>
                                <div style="font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500; position: relative; z-index: 1;">âœ… BaÅŸarÄ±yla GÃ¶nderildi</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(240, 147, 251, 0.3); position: relative; overflow: hidden;">
                                <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                                <div style="font-size: 36px; font-weight: 700; color: white; margin-bottom: 8px; position: relative; z-index: 1;" id="report-failed-count">0</div>
                                <div style="font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500; position: relative; z-index: 1;">âŒ BaÅŸarÄ±sÄ±z</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #fda085 0%, #f6d365 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(253, 160, 133, 0.3); position: relative; overflow: hidden;">
                                <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                                <div style="font-size: 36px; font-weight: 700; color: white; margin-bottom: 8px; position: relative; z-index: 1;" id="report-pending-count">0</div>
                                <div style="font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500; position: relative; z-index: 1;">â³ SÄ±rada Bekliyor</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3); position: relative; overflow: hidden;">
                                <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
                                <div style="font-size: 36px; font-weight: 700; color: white; margin-bottom: 8px; position: relative; z-index: 1;" id="report-total-count">0</div>
                                <div style="font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500; position: relative; z-index: 1;">ğŸ“Š Toplam Mesaj</div>
                            </div>
                        </div>
                        
                        <!-- Filter Options -->
                        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 25px;">
                            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 13px;">Durum Filtresi</label>
                                    <select class="form-control" id="report-filter-status" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;" onchange="filterMessageReports()">
                                <option value="all">TÃ¼m Durumlar</option>
                                <option value="success">âœ… GÃ¶nderildi</option>
                                <option value="failed">âŒ BaÅŸarÄ±sÄ±z</option>
                                <option value="pending">â³ Bekliyor</option>
                            </select>
                        </div>
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 13px;">Tarih Filtresi</label>
                                    <input type="date" class="form-control" id="report-filter-date" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;" onchange="filterMessageReports()">
                            </div>
                                <div style="display: flex; gap: 10px; align-items: flex-end;">
                                    <button class="btn btn-secondary" onclick="exportMessageReports()" style="padding: 10px 20px; border-radius: 8px; font-weight: 600;">ğŸ“¥ Excel Ä°ndir</button>
                                    <button class="btn btn-danger" onclick="clearMessageReports()" style="padding: 10px 20px; border-radius: 8px; font-weight: 600;">ğŸ—‘ï¸ Temizle</button>
                            </div>
                            </div>
                        </div>
                        
                        <!-- Reports Table -->
                        <div style="overflow-x: auto; max-height: 500px; overflow-y: auto;">
                            <table class="modern-table" style="width: 100%; font-size: 14px;">
                                <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                                    <tr>
                                        <th style="width: 140px;">Tarih/Saat</th>
                                        <th style="width: 150px;">AlÄ±cÄ±</th>
                                        <th style="width: 120px;">Telefon</th>
                                        <th style="min-width: 200px;">Mesaj</th>
                                        <th style="width: 120px;">Cihaz</th>
                                        <th style="width: 100px;">Durum</th>
                                        <th style="width: 80px;">Ä°ÅŸlem</th>
                                    </tr>
                                </thead>
                                <tbody id="message-reports-table">
                                    <tr><td colspan="7" class="empty-state">Mesaj raporu yÃ¼kleniyor...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CRM Section -->
            <div id="crm" class="section">
                <!-- CRM Dashboard - Modern Design -->
                <div style="display: grid; gap: 20px;">
                    <!-- BranÅŸ Etiket Ä°statistikleri -->
                    <div class="card">
                        <div class="card-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                            <h3 style="margin: 0;">ğŸ“Š BranÅŸ BazlÄ± Etiket SayÄ±larÄ±</h3>
                                <button id="toggle-branch-stats-btn" onclick="toggleBranchStats()" style="background: none; border: none; cursor: pointer; font-size: 20px; padding: 5px; transition: all 0.2s;" title="Ä°statistikleri Gizle/GÃ¶ster">
                                    ğŸ‘ï¸
                                </button>
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="openAddLeadModal()">â• Yeni Potansiyel MÃ¼ÅŸteri</button>
                                <button class="btn btn-success" onclick="openBulkImportModal()" title="Excel/CSV ile toplu mÃ¼ÅŸteri ekle">ğŸ“¥ Toplu Ä°Ã§e Aktar</button>
                            </div>
                        </div>
                        <div id="branch-tag-stats" style="display: grid; gap: 15px;">
                            <!-- Branch tag stats will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- GÃ¼nÃ¼n Denemeleri & YaklaÅŸan KayÄ±t Olabilirler & Son DevamsÄ±zlÄ±klar -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                        <div class="card">
                            <div class="card-title">
                                <h3>ğŸ¾ BugÃ¼nÃ¼n Denemeleri</h3>
                            </div>
                            <div id="today-trials-list"></div>
                        </div>
                        
                        <div class="card">
                            <div class="card-title">
                                <h3>ğŸ“… YaklaÅŸan KayÄ±t Olabilirler</h3>
                            </div>
                            <div id="upcoming-registrations-list"></div>
                        </div>
                        
                        <div class="card">
                            <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                                <h3>âš ï¸ Son DevamsÄ±zlÄ±klar</h3>
                                <select id="absence-period-filter" onchange="renderRecentAbsences()" class="form-control" style="width: auto; font-size: 14px;">
                                    <option value="7">Son 7 GÃ¼n</option>
                                    <option value="10">Son 10 GÃ¼n</option>
                                    <option value="30" selected>Son 30 GÃ¼n</option>
                                </select>
                            </div>
                            <div id="recent-absences-list"></div>
                        </div>
                    </div>
                    
                    <!-- BranÅŸ & Etiket DaÄŸÄ±lÄ±mÄ± -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                        <div class="card">
                            <div class="card-title">
                                <h3>ğŸ¯ BranÅŸ DaÄŸÄ±lÄ±mÄ±</h3>
                            </div>
                            <div id="branch-distribution"></div>
                        </div>
                        
                        <div class="card">
                            <div class="card-title">
                                <h3>ğŸ·ï¸ Etiket DaÄŸÄ±lÄ±mÄ±</h3>
                            </div>
                            <div id="tag-distribution"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CRM MÃ¼ÅŸteri Filtrele Section -->
            <div id="crm-filter" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="card-title" style="margin: 0;">ğŸ” MÃ¼ÅŸteri Filtrele</h2>
                    <button class="btn btn-primary" onclick="openAddLeadModal()">
                        â• Yeni Potansiyel MÃ¼ÅŸteri
                    </button>
                </div>
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 16px; margin: 0;">Filtreler</h3>
                        <button class="btn btn-sm btn-secondary" onclick="clearCRMFilters()">ğŸ”„ Temizle</button>
                    </div>

                    <!-- Filtreler -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label>BranÅŸ</label>
                            <select id="filter-branch" class="form-control" onchange="applyCustomerFilters()">
                                <option value="all">TÃ¼m BranÅŸlar</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>YaÅŸ Grubu</label>
                            <select id="filter-age-group" class="form-control" onchange="applyCustomerFilters()">
                                <option value="all">TÃ¼mÃ¼</option>
                                <option value="child">ğŸ‘¶ Ã‡ocuk</option>
                                <option value="adult">ğŸ‘¨ YetiÅŸkin</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Etiket</label>
                            <select id="filter-tag" class="form-control" onchange="applyCustomerFilters()">
                                <option value="all">TÃ¼mÃ¼</option>
                                <!-- Etiketler buraya yÃ¼klenecek -->
                            </select>
                        </div>

                    </div>
                    
                    <!-- Son Ä°ÅŸlem Tarihi Filtresi -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                        <div class="form-group">
                            <label>ğŸ“… Son Ä°ÅŸlem BaÅŸlangÄ±Ã§</label>
                            <input type="date" id="filter-date-start" class="form-control" onchange="applyCustomerFilters()">
                        </div>
                        <div class="form-group">
                            <label>ğŸ“… Son Ä°ÅŸlem BitiÅŸ</label>
                            <input type="date" id="filter-date-end" class="form-control" onchange="applyCustomerFilters()">
                        </div>
                    </div>

                    <!-- Arama -->
                    <div class="form-group" style="margin-bottom: 20px;">
                        <input type="text" id="filter-search" class="form-control search-input" placeholder="Ä°sim, telefon veya email ile ara..." oninput="applyCustomerFilters()">
                    </div>
                    
                    <!-- SÄ±ralama -->
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label>ğŸ”½ SÄ±ralama</label>
                        <select id="filter-sort" class="form-control" onchange="applyCustomerFilters()">
                            <option value="date-desc">Son Ä°ÅŸlem Tarihi (Yeni â†’ Eski)</option>
                            <option value="date-asc">Son Ä°ÅŸlem Tarihi (Eski â†’ Yeni)</option>
                            <option value="age-desc">YaÅŸ (BÃ¼yÃ¼kten KÃ¼Ã§Ã¼ÄŸe)</option>
                            <option value="age-asc">YaÅŸ (KÃ¼Ã§Ã¼kten BÃ¼yÃ¼ÄŸe)</option>
                            <option value="name-asc">Ä°sim (A â†’ Z)</option>
                            <option value="name-desc">Ä°sim (Z â†’ A)</option>
                        </select>
                    </div>

                    <!-- Ä°statistikler -->
                    <div id="filter-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px; border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 20px; font-weight: bold;" id="total-filtered">0</div>
                            <div style="font-size: 11px; opacity: 0.9;">Toplam</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 12px; border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 20px; font-weight: bold;" id="new-filtered">0</div>
                            <div style="font-size: 11px; opacity: 0.9;">Yeni</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 12px; border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 20px; font-weight: bold;" id="trial-filtered">0</div>
                            <div style="font-size: 11px; opacity: 0.9;">Deneme</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 12px; border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 20px; font-weight: bold;" id="converted-filtered">0</div>
                            <div style="font-size: 11px; opacity: 0.9;">Ãœye Oldu</div>
                        </div>
                    </div>
                </div>

                <!-- FiltrelenmiÅŸ MÃ¼ÅŸteri Listesi -->
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 16px; margin: 0;">ğŸ“‹ FiltrelenmiÅŸ MÃ¼ÅŸteriler</h3>
                        <button class="btn btn-sm btn-success" onclick="exportFilteredCustomers()">ğŸ“¥ DÄ±ÅŸa Aktar</button>
                    </div>
                    <div id="filtered-customers-list">
                        <div class="empty-state">
                            <h3>Filtre uygulayÄ±n</h3>
                            <p>YukarÄ±daki filtrelerden mÃ¼ÅŸterileri seÃ§in</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CRM Denemeler Section -->
            <div id="crm-trials" class="section">
                <h2 class="card-title" style="margin-bottom: 20px;">ğŸ¾ Deneme Dersleri</h2>
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 16px; margin: 0;">Ä°statistikler</h3>
                        <button class="btn btn-sm btn-primary" onclick="openAddTrialModal()">â• Deneme Ekle</button>
                    </div>

                    <!-- Deneme Ä°statistikleri -->
                    <!-- Filtreler -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <select id="trial-branch-filter" class="form-control" style="width: 150px;" onchange="renderTrials()">
                            <option value="all">TÃ¼m BranÅŸlar</option>
                        </select>
                        <input type="text" id="trial-search" class="form-control search-input" placeholder="MÃ¼ÅŸteri ara..." style="flex: 1; min-width: 200px;" oninput="renderTrials()">
                    </div>
                </div>

                <!-- Deneme Listesi -->
                <div class="card">
                    <div class="card-title">
                        <h3 style="font-size: 16px; margin: 0;">ğŸ“‹ Deneme Dersi Listesi</h3>
                    </div>
                    <div id="trials-list">
                        <div class="empty-state">
                            <h3>HenÃ¼z deneme dersi kaydÄ± yok</h3>
                            <p>Yeni deneme eklemek iÃ§in yukarÄ±daki butonu kullanÄ±n</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kampanya OluÅŸtur Section -->
            <div id="campaigns" class="section">
                <div class="card">
                    <div class="card-title">
                        <h3>ğŸ“¢ Kampanya OluÅŸtur</h3>
                    </div>
                    <p style="color: #666; margin-bottom: 20px;">
                        CRM'deki mÃ¼ÅŸterilere toplu mesaj gÃ¶nderin. Filtreleme seÃ§eneklerini kullanarak hedef kitlenizi belirleyin.
                    </p>
                    
                    <div id="campaign-form">
                        <!-- Filtreler -->
                        <div class="card" style="background: #f8f9fa; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 15px; font-size: 16px;">ğŸ¯ Hedef Kitle SeÃ§imi</h4>
                            <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                                <div class="form-group">
                                    <label>BranÅŸ Filtrele</label>
                                    <select id="campaign-branch-filter" class="form-control" onchange="updateCampaignRecipients()">
                                        <option value="all">TÃ¼m BranÅŸlar</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Etiket Filtrele</label>
                                    <select id="campaign-tag-filter" class="form-control" onchange="updateCampaignRecipients()">
                                        <option value="all">TÃ¼m Etiketler</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>YaÅŸ Grubu</label>
                                    <select id="campaign-agegroup-filter" class="form-control" onchange="updateCampaignRecipients()">
                                        <option value="all">Hepsi</option>
                                        <option value="adult">YetiÅŸkin</option>
                                        <option value="child">Ã‡ocuk</option>
                                    </select>
                                </div>
                            </div>
                            <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px;">
                                <strong>SeÃ§ilen MÃ¼ÅŸteri SayÄ±sÄ±:</strong> <span id="campaign-recipient-count" style="font-size: 20px; color: #667eea; font-weight: bold;">0</span>
                            </div>
                        </div>
                        
                        <!-- Mesaj AyarlarÄ± -->
                        <div class="card">
                            <h4 style="margin-bottom: 15px; font-size: 16px;">ğŸ’¬ Mesaj AyarlarÄ±</h4>
                            <div class="form-group">
                                <label>WhatsApp CihazÄ± *</label>
                                <select id="campaign-device" class="form-control" required>
                                    <option value="">Cihaz seÃ§in...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Mesaj Ä°Ã§eriÄŸi *</label>
                                <textarea id="campaign-message" class="form-control" rows="6" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." required></textarea>
                                <small style="color: #666;">ğŸ’¡ Ä°pucu: KiÅŸisel mesajlar iÃ§in {ad} ve {telefon} deÄŸiÅŸkenlerini kullanabilirsiniz.</small>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="campaign-send-delay"> Mesajlar arasÄ± gecikme ekle (1 saniye)
                                </label>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-success" onclick="sendCampaignMessages()" style="font-size: 16px; padding: 12px 24px;">
                                ğŸ“¨ KampanyayÄ± BaÅŸlat
                            </button>
                            <button class="btn btn-secondary" onclick="resetCampaignForm()" style="font-size: 16px; padding: 12px 24px;">
                                ğŸ”„ Formu SÄ±fÄ±rla
                            </button>
                        </div>
                        
                        <!-- GÃ¶nderim Durumu -->
                        <div id="campaign-status" style="display: none; margin-top: 20px; padding: 20px; background: #e3f2fd; border-radius: 8px;">
                            <h4 style="margin-bottom: 10px;">ğŸ“Š GÃ¶nderim Durumu</h4>
                            <div id="campaign-progress"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CRM Gelen Aramalar Section -->
            <div id="crm-incoming-calls" class="section">
                <h2 class="card-title" style="margin-bottom: 20px;">ğŸ“ Gelen Aramalar</h2>
                <div class="card">
                    <div id="incoming-calls-header" class="card-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <h3 style="font-size: 16px; margin: 0;">Son 1 Hafta Ä°Ã§indeki Gelen Aramalar</h3>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <button class="btn btn-sm btn-secondary" onclick="renderIncomingCallsPage()">ğŸ”„ Yenile</button>
                        </div>
                    </div>
                    
                    <!-- Sekmeler -->
                    <div style="display: flex; gap: 0; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px; margin-top: 15px; flex-wrap: wrap;">
                        <button id="tab-unanswered" class="incoming-call-tab" onclick="switchIncomingCallTab('unanswered')" style="flex: 1; min-width: 200px; padding: 12px 20px; border: none; background: #ffebee; color: #f44336; font-weight: 600; cursor: pointer; border-bottom: 3px solid #f44336; transition: all 0.3s;">
                            <span style="font-size: 16px;">ğŸ“µ CevapsÄ±z Aramalar</span>
                            <span id="count-unanswered" style="display: block; font-size: 20px; margin-top: 5px;">0</span>
                        </button>
                        <button id="tab-callback-unanswered" class="incoming-call-tab" onclick="switchIncomingCallTab('callback-unanswered')" style="flex: 1; min-width: 200px; padding: 12px 20px; border: none; background: #fff; color: #666; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s;">
                            <span style="font-size: 16px;">â†©ï¸ DÃ¶nÃ¼ÅŸ YapÄ±ldÄ± Ama CevapsÄ±z</span>
                            <span id="count-callback-unanswered" style="display: block; font-size: 20px; margin-top: 5px;">0</span>
                        </button>
                        <button id="tab-callback" class="incoming-call-tab" onclick="switchIncomingCallTab('callback')" style="flex: 1; min-width: 200px; padding: 12px 20px; border: none; background: #fff; color: #666; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s;">
                            <span style="font-size: 16px;">ğŸ“ Giden Aramada CevaplanmÄ±ÅŸ</span>
                            <span id="count-callback" style="display: block; font-size: 20px; margin-top: 5px;">0</span>
                        </button>
                        <button id="tab-answered" class="incoming-call-tab" onclick="switchIncomingCallTab('answered')" style="flex: 1; min-width: 200px; padding: 12px 20px; border: none; background: #fff; color: #666; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s;">
                            <span style="font-size: 16px;">âœ… Gelen Aramada CevaplanmÄ±ÅŸ</span>
                            <span id="count-answered" style="display: block; font-size: 20px; margin-top: 5px;">0</span>
                        </button>
                        <button id="tab-other" class="incoming-call-tab" onclick="switchIncomingCallTab('other')" style="flex: 1; min-width: 200px; padding: 12px 20px; border: none; background: #fff; color: #666; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s;">
                            <span style="font-size: 16px;">ğŸ“‹ DiÄŸer</span>
                            <span id="count-other" style="display: block; font-size: 20px; margin-top: 5px;">0</span>
                        </button>
                    </div>
                    
                    <!-- Ä°Ã§erik -->
                    <div id="incoming-calls-list">
                        <div class="loading"><div class="spinner"></div><span>Gelen aramalar yÃ¼kleniyor...</span></div>
                    </div>
                </div>
            </div>

            <!-- CRM Giden Aramalar Section -->
            <div id="crm-outgoing-calls" class="section">
                <h2 class="card-title" style="margin-bottom: 20px;">ğŸ“± Giden Aramalar</h2>
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 16px; margin: 0;">Son 1 Hafta Ä°Ã§indeki Giden Aramalar</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label id="selectAllOutgoingLabel" style="display: none; align-items: center; gap: 5px; margin: 0; cursor: pointer;">
                                <input type="checkbox" id="selectAllOutgoing" onchange="toggleSelectAllOutgoing(this)" style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-size: 14px;">TÃ¼mÃ¼nÃ¼ SeÃ§</span>
                            </label>
                            <button id="showDeleteModeOutgoingBtn" class="btn btn-sm btn-warning" onclick="showOutgoingDeleteMode()" title="Silme modunu aÃ§">ğŸ—‘ï¸ SeÃ§ilenleri Sil</button>
                            <button id="confirmDeleteOutgoingBtn" class="btn btn-sm btn-danger" onclick="confirmDeleteOutgoingCalls()" title="SeÃ§ilileri sil" style="display: none;">âœ”ï¸ Sil</button>
                            <button id="cancelDeleteOutgoingBtn" class="btn btn-sm btn-secondary" onclick="cancelOutgoingDeleteMode()" title="Ä°ptal" style="display: none;">âœ–ï¸ Ä°ptal</button>
                            <button class="btn btn-sm btn-secondary" onclick="renderOutgoingCallsPage()">ğŸ”„ Yenile</button>
                    </div>
                    </div>
                    <div id="outgoing-calls-list">
                        <div class="loading"><div class="spinner"></div><span>Giden aramalar yÃ¼kleniyor...</span></div>
                    </div>
                </div>
            </div>

            <!-- CRM Etiketler Section -->
            <div id="crm-tags" class="section">
                <h2 class="card-title" style="margin-bottom: 20px;">ğŸ·ï¸ Etiket YÃ¶netimi</h2>
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 16px; margin: 0;">Ä°statistikler</h3>
                        <button class="btn btn-sm btn-primary" onclick="openAddTagModal()">â• Yeni Etiket</button>
                    </div>

                    <p style="color: #666; margin-bottom: 15px; font-size: 13px;">
                        MÃ¼ÅŸterilerinizi kategorize etmek iÃ§in etiketler oluÅŸturun. Etiketler sayesinde mÃ¼ÅŸterilerinizi kolayca gruplandÄ±rabilir ve filtreleyebilirsiniz.
                    </p>

                    <!-- Etiket Ä°statistikleri -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px; border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 22px; font-weight: bold;" id="total-tags">0</div>
                            <div style="font-size: 11px; opacity: 0.9;">Toplam Etiket</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 12px; border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 22px; font-weight: bold;" id="active-tags">0</div>
                            <div style="font-size: 11px; opacity: 0.9;">Aktif Etiket</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 12px; border-radius: 8px; color: white; text-align: center;">
                            <div style="font-size: 22px; font-weight: bold;" id="tagged-customers">0</div>
                            <div style="font-size: 11px; opacity: 0.9;">Etiketli MÃ¼ÅŸteri</div>
                        </div>
                    </div>
                </div>

                <!-- Etiket Kategorileri -->
                <div class="card">
                    <div class="card-title">
                        <h3 style="font-size: 16px; margin: 0;">ğŸ“‚ Etiket Kategorileri</h3>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                        <!-- Durum Etiketleri -->
                        <div>
                            <h4 style="color: #667eea; margin-bottom: 12px; font-size: 14px;">ğŸ“Š Durum Etiketleri</h4>
                            <div id="status-tags-list" class="tags-category-list">
                                <!-- Durum etiketleri buraya yÃ¼klenecek -->
                            </div>
                        </div>

                        <!-- BranÅŸ Etiketleri -->
                        <div>
                            <h4 style="color: #f093fb; margin-bottom: 12px; font-size: 14px;">ğŸ¾ BranÅŸ Etiketleri</h4>
                            <div id="branch-tags-list" class="tags-category-list">
                                <!-- BranÅŸ etiketleri buraya yÃ¼klenecek -->
                            </div>
                        </div>

                        <!-- Ã–zel Etiketler -->
                        <div>
                            <h4 style="color: #43e97b; margin-bottom: 12px; font-size: 14px;">â­ Ã–zel Etiketler</h4>
                            <div id="custom-tags-list" class="tags-category-list">
                                <!-- Ã–zel etiketler buraya yÃ¼klenecek -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TÃ¼m Etiketler Listesi -->
                <div class="card">
                    <div class="card-title">
                        <h3 style="font-size: 16px; margin: 0;">ğŸ“‹ TÃ¼m Etiketler</h3>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="tag-search" class="form-control search-input" placeholder="Etiket ara..." style="max-width: 300px;" oninput="renderAllTags()">
                            <select id="tag-category-filter" class="form-control" style="max-width: 200px;" onchange="renderAllTags()">
                                <option value="all">TÃ¼m Kategoriler</option>
                                <option value="status">Durum</option>
                                <option value="branch">BranÅŸ</option>
                                <option value="custom">Ã–zel</option>
                            </select>
                        </div>
                    </div>
                    <div id="all-tags-list">
                        <div class="empty-state">
                            <h3>HenÃ¼z etiket yok</h3>
                            <p>Yeni etiket eklemek iÃ§in yukarÄ±daki butonu kullanÄ±n</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- CRM Mesaj ÅablonlarÄ± Section -->
            <div id="crm-templates" class="section">
                <h2 class="card-title" style="margin-bottom: 20px;">ğŸ“ Mesaj ÅablonlarÄ±</h2>
                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 16px; margin: 0;">HazÄ±r Mesaj ÅablonlarÄ±</h3>
                        <button class="btn btn-sm btn-primary" onclick="openAddTemplateModal()">â• Yeni Åablon</button>
                    </div>
                    
                    <p style="color: #666; margin-bottom: 20px; font-size: 13px;">
                        MÃ¼ÅŸterilerinize gÃ¶nderilecek mesajlar iÃ§in hazÄ±r ÅŸablonlar oluÅŸturun. Åablonlar sayesinde zaman kazanÄ±n ve tutarlÄ± iletiÅŸim kurun.
                    </p>
                    
                    <!-- VarsayÄ±lan Åablonlar -->
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #667eea; margin-bottom: 15px; font-size: 14px;">ğŸ’¼ VarsayÄ±lan Åablonlar</h4>
                        <div id="default-templates-list" style="display: grid; gap: 15px;">
                            <!-- VarsayÄ±lan ÅŸablonlar buraya yÃ¼klenecek -->
                        </div>
                    </div>
                    
                    <!-- Ã–zel Åablonlar -->
                    <div>
                        <h4 style="color: #f093fb; margin-bottom: 15px; font-size: 14px;">â­ Ã–zel Åablonlar</h4>
                        <div id="custom-templates-list" style="display: grid; gap: 15px;">
                            <!-- Ã–zel ÅŸablonlar buraya yÃ¼klenecek -->
                        </div>
                    </div>
                    
                    <!-- BoÅŸ durum -->
                    <div id="no-templates" style="display: none; text-align: center; padding: 60px 20px; color: #999;">
                        <div style="font-size: 64px; margin-bottom: 20px;">ğŸ“</div>
                        <h3>HenÃ¼z Ã¶zel ÅŸablon yok</h3>
                        <p>Yeni ÅŸablon eklemek iÃ§in yukarÄ±daki butonu kullanÄ±n</p>
                    </div>
                </div>
            </div>
            
            <!-- Attendance Tracking Section -->
            <div id="attendance-tracking" class="section">
                <div class="attendance-header">
                    <h1 id="header-title-attendance" class="modern-title"></h1>
                    <a href="#" onclick="event.preventDefault(); showSection('members', document.querySelector('.nav-btn[onclick*=\'members\']'))" class="back-link" style="background: var(--primary-color); color:white;">â† Ãœyeler Listesine DÃ¶n</a>
                </div>
                <div id="attendance-content">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Ãœye verileri yÃ¼kleniyor...</span>
                    </div>
                </div>
            </div>

            <!-- User Activities Section -->
            <div id="user-activities" class="section">
                <h2 class="card-title">ğŸ“Š KullanÄ±cÄ± Hareketleri</h2>
                <div class="card">
                    <div class="card-title">
                        <h3>ğŸ‘¥ Ãœye GiriÅŸ Hareketleri</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="activitySearch" class="form-control search-input" placeholder="Ãœye ara (Ä°sim, Telefon)..." style="max-width: 300px;">
                            <select id="activityBranchFilter" class="form-control" style="max-width: 150px;">
                                <option value="all">TÃ¼m BranÅŸlar</option>
                                <option value="tenis">ğŸ¾ Tenis</option>
                                <option value="yuzme">ğŸŠ YÃ¼zme</option>
                            </select>
                        </div>
                    </div>
                    <div id="activitiesTableContainer">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span>Hareketler yÃ¼kleniyor...</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="member-tooltip"></div>
    <div id="context-menu"></div>
    <div id="phone-context-menu">
        <button id="phone-copy-btn">Kopyala</button>
        <button id="phone-call-btn">Ara</button>
    </div>


    <!-- ZamanlanmÄ±ÅŸ Mesaj Modal -->
    <div id="scheduleMessageModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('scheduleMessageModal')">&times;</span>
            <h3>â° Mesaj Zamanla</h3>
            <p style="color: #666; margin-bottom: 20px;">
                âœ… TarayÄ±cÄ± kapalÄ± olsa bile Firebase Cloud Functions Ã¼zerinden gÃ¶nderilir
            </p>
            <form id="scheduleMessageForm" onsubmit="handleScheduleMessage(event)">
                <div class="form-group">
                    <label>AlÄ±cÄ± Telefon NumarasÄ± *</label>
                    <input type="tel" name="phoneNumber" class="form-control" placeholder="05xxxxxxxxx" required>
                </div>
                <div class="form-group">
                    <label>AlÄ±cÄ± AdÄ±</label>
                    <input type="text" name="recipientName" class="form-control" placeholder="Ä°steÄŸe baÄŸlÄ±">
                </div>
                <div class="form-group">
                    <label>Mesaj Ä°Ã§eriÄŸi *</label>
                    <textarea name="messageText" class="form-control" rows="5" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." required></textarea>
                </div>
                <div class="form-group">
                    <label>GÃ¶nderim ZamanÄ± *</label>
                    <input type="datetime-local" name="scheduledTime" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Mesaj Tipi</label>
                    <select name="messageType" class="form-control">
                        <option value="custom">Ã–zel Mesaj</option>
                        <option value="payment-reminder">Ã–deme HatÄ±rlatmasÄ±</option>
                        <option value="birthday">DoÄŸum GÃ¼nÃ¼</option>
                        <option value="task">GÃ¶rev Bildirimi</option>
                        <option value="announcement">Duyuru</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">â° Zamanla</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('scheduleMessageModal')">Ä°ptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Kampanya Modal -->
    <div id="campaignModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('campaignModal')">&times;</span>
            <h3>ğŸ“¢ Yeni Kampanya OluÅŸtur</h3>
            <p style="color: #666; margin-bottom: 20px;">
                Toplu mesaj gÃ¶nderin - Sistem, mesajlarÄ± Ã§alÄ±ÅŸma saatleri iÃ§inde parÃ§alÄ± olarak gÃ¶nderir
            </p>
            <form id="campaignForm" onsubmit="handleCreateCampaign(event)">
                <div class="form-group">
                    <label>Kampanya AdÄ± *</label>
                    <input type="text" name="campaignName" class="form-control" placeholder="Ã–rn: MayÄ±s 2025 KampanyasÄ±" required>
                </div>
                
                <div class="form-group">
                    <label>Hedef Kitle *</label>
                    <select name="targetAudience" class="form-control" onchange="updateCampaignRecipientCount(this.value)" required>
                        <option value="">SeÃ§iniz...</option>
                        <option value="all-members">ğŸ‘¥ TÃ¼m Ãœyeler</option>
                        <option value="active-members">âœ… Aktif Ãœyeler</option>
                        <option value="inactive-members">â¸ï¸ Pasif Ãœyeler</option>
                        <option value="crm-all">ğŸ“‹ TÃ¼m CRM MÃ¼ÅŸterileri</option>
                        <option value="crm-by-tag">ğŸ·ï¸ CRM - Etikete GÃ¶re</option>
                        <option value="crm-by-branch">ğŸ¯ CRM - BranÅŸa GÃ¶re</option>
                    </select>
                </div>
                
                <div id="campaign-tag-filter" class="form-group" style="display:none;">
                    <label>Etiket SeÃ§in</label>
                    <select name="crmTag" class="form-control" id="campaign-tag-select"></select>
                </div>
                
                <div id="campaign-branch-filter" class="form-group" style="display:none;">
                    <label>BranÅŸ SeÃ§in</label>
                    <select name="crmBranch" class="form-control" id="campaign-branch-select"></select>
                </div>
                
                <div class="form-group">
                    <label>Mesaj Ä°Ã§eriÄŸi *</label>
                    <textarea name="messageContent" class="form-control" rows="5" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." required></textarea>
                    <small style="color: #666;">DeÄŸiÅŸkenler: {AD_SOYAD}, {AD}, {TELEFON}</small>
                </div>
                
                <div style="background: #fff9e6; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ffc107;">
                    <h4 style="margin: 0 0 10px 0; font-size: 14px;">ğŸ“Š ParÃ§alÄ± GÃ¶nderim AyarlarÄ±</h4>
                    
                    <div class="form-group">
                        <label>GÃ¼nlÃ¼k GÃ¶nderim Limiti</label>
                        <input type="number" name="dailyLimit" class="form-control" value="200" min="10" max="1000" required>
                        <small style="color: #666;">Her gÃ¼n en fazla kaÃ§ mesaj gÃ¶nderilsin?</small>
                    </div>
                    
                    <div class="form-group">
                        <label>GÃ¶nderim BaÅŸlangÄ±Ã§ ZamanÄ±</label>
                        <input type="datetime-local" name="startTime" class="form-control" required>
                        <small style="color: #666;">Kampanya ne zaman baÅŸlasÄ±n?</small>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="color: #666;">Toplam AlÄ±cÄ±:</span>
                            <strong id="campaign-recipient-count">0</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #666;">Tahmini SÃ¼re:</span>
                            <strong id="campaign-duration">-</strong>
                        </div>
                    </div>
                </div>
                
                <div style="background: #e7f3ff; padding: 12px; border-radius: 6px; margin-bottom: 20px;">
                    <strong>âœ… Ã‡alÄ±ÅŸma Saatlerine Uyum:</strong>
                    <p style="margin: 8px 0 0 0; color: #666; font-size: 13px;">
                        Mesajlar, WhatsApp > Ayarlar'da belirlediÄŸiniz Ã§alÄ±ÅŸma saatleri iÃ§inde gÃ¶nderilir.
                    </p>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">ğŸ“¢ KampanyayÄ± BaÅŸlat</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('campaignModal')">Ä°ptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Direct Message Modal -->
    <div id="directMessageModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('directMessageModal')">&times;</span>
            <h3>ğŸ’¬ Mesaj GÃ¶nder</h3>
            <form id="directMessageForm" onsubmit="handleDirectMessage(event)">
                <div class="form-group">
                    <label>ğŸ“± Telefon NumarasÄ± *</label>
                    <input type="tel" id="direct-message-phone" name="phone" class="form-control" placeholder="05xxxxxxxxx" required>
                    <small style="color: #666;">Ã–rn: 05301234567 veya 905301234567</small>
                </div>
                
                <div class="form-group">
                    <label>ğŸ’¬ Mesaj *</label>
                    <textarea id="direct-message-text" name="message" class="form-control" rows="6" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." required></textarea>
                    <small style="color: #666;">MesajÄ±nÄ±z hemen gÃ¶nderilecektir.</small>
                </div>
                
                <div class="form-group">
                    <label>ğŸ“± GÃ¶nderici Cihaz</label>
                    <select id="direct-message-device" name="deviceId" class="form-control">
                        <option value="">VarsayÄ±lan cihaz</option>
                    </select>
                </div>
                
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">âœˆï¸ GÃ¶nder</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('directMessageModal')">âŒ Ä°ptal</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add/Edit Lead Modal -->
    <div id="addLeadModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addLeadModal')">&times;</span>
            <h3>â• Yeni Potansiyel MÃ¼ÅŸteri</h3>
            <form id="addLeadForm" onsubmit="handleAddLead(event)">
                <div class="form-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="form-group">
                        <label>Telefon *</label>
                        <input type="tel" name="phone" class="form-control" placeholder="05xxxxxxxxx" required oninput="checkExistingPhone(this.value)">
                        <div id="phone-check-message" style="font-size: 12px; margin-top: 5px;"></div>
                    </div>
                    <div class="form-group">
                        <label>Kaynak</label>
                        <select name="source" class="form-control">
                            <option value="website">ğŸŒ Website</option>
                            <option value="phone">ğŸ“ Telefon</option>
                            <option value="referral">ğŸ‘¥ Tavsiye</option>
                            <option value="social">ğŸ“± Sosyal Medya</option>
                            <option value="other">ğŸ”¹ DiÄŸer</option>
                        </select>
                    </div>
                </div>
                
                <!-- BranÅŸlar BÃ¶lÃ¼mÃ¼ -->
                <div style="margin: 20px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; font-size: 16px;">ğŸ¯ BranÅŸlar</h4>
                        <button type="button" class="btn btn-sm btn-success" onclick="addBranchField()">+ BranÅŸ Ekle</button>
                    </div>
                    <div id="branches-container">
                        <!-- BranÅŸlar buraya eklenecek -->
                    </div>
                </div>
                
                
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">ğŸ’¾ Kaydet</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addLeadModal')">âŒ Ä°ptal</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Bulk Import Modal -->
    <div id="bulkImportModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeBulkImportModal()">&times;</span>
            <h3>ğŸ“¥ Toplu MÃ¼ÅŸteri Ä°Ã§e Aktarma</h3>
            
            <div id="import-step-1" style="display: block;">
                <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #1976d2;">ğŸ“‹ NasÄ±l HazÄ±rlanÄ±r?</h4>
                    <p style="margin: 5px 0;">1. <strong>Excel ÅŸablonunu</strong> indirin (3 ayrÄ± sayfa: MÃ¼ÅŸteriler, BranÅŸlar, Etiketler)</p>
                    <p style="margin: 5px 0;">2. <strong>"BranÅŸlar"</strong> ve <strong>"Etiketler"</strong> sekmelerinden deÄŸerleri kopyalayÄ±n</p>
                    <p style="margin: 5px 0;">3. <strong>"MÃ¼ÅŸteriler"</strong> sekmesinde ilgili sÃ¼tunlara yapÄ±ÅŸtÄ±rÄ±n</p>
                    <p style="margin: 5px 0;">4. MÃ¼ÅŸteri bilgilerini doldurun</p>
                    <p style="margin: 5px 0;">5. DosyayÄ± <strong>Excel (.xlsx)</strong> formatÄ±nda kaydedin</p>
                    <p style="margin: 5px 0;">6. AÅŸaÄŸÄ±dan dosyayÄ± yÃ¼kleyin</p>
                    
                    <div style="background: #e3f2fd; padding: 12px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #2196f3;">
                        <strong>ğŸ“‹ NasÄ±l KullanÄ±lÄ±r:</strong>
                        <br>â€¢ Excel'de <strong>BranÅŸlar</strong> sekmesinden branÅŸ ismi kopyalayÄ±n
                        <br>â€¢ <strong>MÃ¼ÅŸteriler</strong> sekmesindeki "BranÅŸ" sÃ¼tununa yapÄ±ÅŸtÄ±rÄ±n
                        <br>â€¢ AynÄ± ÅŸekilde <strong>Etiketler</strong> sekmesinden etiket kopyalayÄ±n
                        <br>â€¢ Bu yÃ¶ntemle yazÄ±m hatasÄ± olmaz!
                    </div>
                    
                    <div style="background: #fff3cd; padding: 12px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #ffc107;">
                        <strong>âš ï¸ Ã–nemli:</strong> BranÅŸ ve Etiket isimlerini <strong>tam olarak</strong> diÄŸer sayfalardan kopyalayÄ±n.
                        <br>Elle yazarsanÄ±z yazÄ±m hatasÄ± nedeniyle yÃ¼kleme baÅŸarÄ±sÄ±z olabilir!
                    </div>
                    
                    <button class="btn btn-info" onclick="downloadImportTemplate()" style="margin-top: 10px;">
                        ğŸ“„ Excel Åablon Ä°ndir (BranÅŸ & Etiket Listeli)
                    </button>
                    <a href="CRM_TOPLU_EKLEME_TALIMATLARI.md" download class="btn btn-secondary" style="margin-top: 10px; margin-left: 10px;">
                        ğŸ“– DetaylÄ± Talimatlar
                    </a>
                </div>
                
                <div style="border: 2px dashed #ccc; padding: 40px; text-align: center; border-radius: 8px; background: #fafafa; cursor: pointer;" 
                     onclick="document.getElementById('csvFileInput').click()">
                    <input type="file" id="csvFileInput" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleFileSelect(event)">
                    <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“</div>
                    <p style="margin: 5px 0; font-size: 16px; font-weight: 600;">Excel/CSV DosyasÄ±nÄ± SeÃ§in</p>
                    <p style="margin: 5px 0; color: #666;">veya buraya sÃ¼rÃ¼kleyin</p>
                    <p style="margin: 10px 0 0 0; font-size: 12px; color: #999;">Desteklenen formatlar: .csv, .xlsx, .xls</p>
                </div>
            </div>
            
            <div id="import-step-2" style="display: none;">
                <div style="margin-bottom: 20px;">
                    <h4>ğŸ“Š Ã–nizleme ve Kontrol</h4>
                    <div id="import-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 15px 0;">
                        <!-- Summary stats will be here -->
                    </div>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
                    <table class="table" style="margin: 0;">
                        <thead style="position: sticky; top: 0; background: white; z-index: 1;">
                            <tr>
                                <th style="width: 30px;">#</th>
                                <th>Telefon</th>
                                <th>Ad Soyad</th>
                                <th>Veli/Ã‡ocuk</th>
                                <th>Kaynak</th>
                                <th>BranÅŸ</th>
                                <th>YaÅŸ Grubu</th>
                                <th>Etiket</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody id="import-preview-body">
                            <!-- Preview rows will be here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="confirmBulkImport()" id="confirmImportBtn">
                        âœ… TÃ¼mÃ¼nÃ¼ Ekle (<span id="valid-count">0</span> GeÃ§erli)
                    </button>
                    <button class="btn btn-secondary" onclick="closeBulkImportModal()">âŒ Ä°ptal</button>
                </div>
            </div>
            
            <div id="import-step-3" style="display: none;">
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">â³</div>
                    <h4>Ä°Ã§e aktarma yapÄ±lÄ±yor...</h4>
                    <div id="import-progress" style="margin: 20px 0;">
                        <div style="background: #e0e0e0; height: 30px; border-radius: 15px; overflow: hidden;">
                            <div id="import-progress-bar" style="background: linear-gradient(90deg, #4caf50, #8bc34a); height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <p id="import-progress-text" style="margin-top: 10px;">0 / 0</p>
                    </div>
                </div>
            </div>
            
            <div id="import-step-4" style="display: none;">
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">âœ…</div>
                    <h4>Ä°Ã§e Aktarma TamamlandÄ±!</h4>
                    <div id="import-result" style="margin: 20px 0; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
                        <!-- Result summary will be here -->
                    </div>
                    <button class="btn btn-primary" onclick="closeBulkImportModal()">Tamam</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('paymentModal')">&times;</span>
            <h3 id="paymentModalTitle">ğŸ’° Ã–deme Ä°ÅŸlemi</h3>
            <form id="paymentForm">
                <input type="hidden" name="paymentPreRegId">
                <input type="hidden" name="paymentNumber">
                <div id="paymentPeriodInfoStatic" style="background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 20px; display:none;"></div>
                <div class="form-grid" id="paymentPeriodInfo" style="display:none;">
                     <div class="form-group"><label>DÃ¶nem BaÅŸlangÄ±Ã§</label><input type="date" class="form-control" name="periodStart"></div>
                     <div class="form-group"><label>DÃ¶nem BitiÅŸ</label><input type="date" class="form-control" name="periodEnd"></div>
                     <div class="form-group"><label>Ders SayÄ±sÄ±</label><input type="number" class="form-control" name="lessonCount"></div>
                </div>
                <!-- âœ… KaÃ§ ay daha aidat eklenecek? -->
                <div class="form-group" id="additionalMonthsField" style="display:none; margin-bottom: 20px;">
                    <label style="font-weight: 600;">ğŸ“† Bu aidattan sonra kaÃ§ ay daha aidat eklensin?</label>
                    <input type="number" class="form-control" name="additionalMonths" min="0" max="12" value="0" placeholder="Ã–rn: 3 ay daha">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        0 girerseniz sadece bu ay eklenir. Ã–rnek: 3 girerseniz, bu ay + 3 ay daha (toplam 4 aidat) eklenecektir.
                    </small>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Ã–deme Tarihi</label>
                        <input type="date" class="form-control" name="paymentDate">
                    </div>
                    <div class="form-group">
                        <label>Tutar *</label>
                        <input type="text" class="form-control" name="paymentAmount" required>
                    </div>
                     <div class="form-group">
                        <label>Son Ã–deme Tarihi *</label>
                        <input type="date" class="form-control" name="paymentDueDate" required>
                    </div>
                    <div class="form-group">
                        <label>Ã–deme YÃ¶ntemi</label>
                        <select class="form-control" name="paymentMethod">
                            <option value="">SeÃ§iniz...</option>
                            <option value="nakit">ğŸ’µ Nakit</option>
                            <option value="kredi_karti">ğŸ’³ Kredi KartÄ±</option>
                            <option value="banka_havalesi">ğŸ¦ Banka Havalesi</option>
                            <option value="eft">ğŸ“± EFT</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label>Durum</label>
                        <select class="form-control" name="paymentStatus">
                            <option value="unpaid">Ã–denmedi</option>
                            <option value="paid">Ã–dendi</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Not</label>
                        <textarea class="form-control" name="paymentNote" rows="3" placeholder="Ek bilgiler..."></textarea>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">âœ… Kaydet</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('paymentModal')">âŒ Ä°ptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Schedule Modal (for new lessons) -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('scheduleModal')">&times;</span>
            <h3>ğŸ“… Yeni Ders OluÅŸtur</h3>
            <form id="newScheduleForm">
                <input type="hidden" name="groupId">
                <div class="form-grid">
                     <div class="form-group">
                        <label>Grup</label>
                        <input type="text" class="form-control" name="groupName" readonly>
                    </div>
                    <div class="form-group">
                        <label>BaÅŸlangÄ±Ã§ Saati *</label>
                        <input type="time" class="form-control" name="startTime" required>
                    </div>
                    <div class="form-group">
                        <label>BitiÅŸ Saati *</label>
                        <input type="time" class="form-control" name="endTime" required>
                    </div>
                </div>
                <!-- âœ… Saha SeÃ§imi (dinamik) -->
                <div class="form-group" id="courtSelectContainer" style="display: none;">
                    <label>Saha (opsiyonel)</label>
                    <select class="form-control" name="court" id="courtSelect">
                        <option value="">Saha SeÃ§iniz...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Ders GÃ¼nleri *</label>
                    <div id="schedule-days-checkboxes" style="display: flex; flex-wrap: wrap; gap: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px;">
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="days" value="pazartesi"> Pazartesi</label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="days" value="salÄ±"> SalÄ±</label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="days" value="Ã§arÅŸamba"> Ã‡arÅŸamba</label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="days" value="perÅŸembe"> PerÅŸembe</label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="days" value="cuma"> Cuma</label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="days" value="cumartesi"> Cumartesi</label>
                        <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;"><input type="checkbox" name="days" value="pazar"> Pazar</label>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">âœ… Dersi OluÅŸtur</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('scheduleModal')">âŒ Ä°ptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Group Modal -->
    <div id="groupModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('groupModal')">&times;</span>
            <h3 id="groupModalTitle">ğŸ‘¥ Grup YÃ¶netimi</h3>
            <form id="groupForm">
                <input type="hidden" name="groupId">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Grup AdÄ± *</label>
                        <input type="text" class="form-control" name="groupName" placeholder="BaÅŸlangÄ±Ã§ Grubu" required>
                    </div>
                    <div class="form-group">
                        <label>BranÅŸ *</label>
                        <select class="form-control" name="branch" required>
                            <option value="">SeÃ§iniz...</option>
                            <option value="tenis">ğŸ¾ Tenis</option>
                            <option value="yuzme">ğŸŠ YÃ¼zme</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>EÄŸitmen *</label>
                        <input type="text" class="form-control" name="instructor" placeholder="EÄŸitmen adÄ±" required>
                    </div>
                    <div class="form-group">
                        <label>Maksimum Ãœye *</label>
                        <input type="number" class="form-control" name="maxMembers" placeholder="8" required>
                    </div>
                    <div class="form-group">
                        <label>AÃ§Ä±klama</label>
                        <textarea class="form-control" name="description" rows="3" placeholder="Grup aÃ§Ä±klamasÄ±..."></textarea>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">âœ… Kaydet</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('groupModal')">âŒ Ä°ptal</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Payment Plan Modal -->
    <div id="paymentPlanModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('paymentPlanModal')">&times;</span>
            <h3 id="paymentPlanTitle">ğŸ“… Ã–deme PlanÄ±</h3>
            <div id="paymentPlanContent"></div>
        </div>
    </div>

    <!-- Group Assignment Modal -->
    <div id="groupAssignModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('groupAssignModal')">&times;</span>
            <h3 id="groupAssignTitle">ğŸ‘¥ Grup Ä°ÅŸlemleri</h3>
            <div id="groupAssignContent"></div>
        </div>
    </div>
    
    <!-- Member Edit Modal -->
    <div id="memberEditModal" class="modal">
        <div class="modal-content member-edit-modal">
            <span class="close" onclick="closeModal('memberEditModal')">&times;</span>
            <div class="modal-header">
                <h2>âœï¸ Ãœye Bilgilerini DÃ¼zenle</h2>
                <p style="color: #666; font-size: 0.9em; margin: 5px 0 0 0;">Ãœye bilgilerini gÃ¼ncellemek iÃ§in formu doldurun</p>
            </div>
            
            <form id="memberEditForm">
                <input type="hidden" name="memberId">
                
                <!-- Ã–ÄŸrenci Bilgileri Section -->
                <div class="form-section">
                    <div class="section-header">
                        <span class="section-icon">ğŸ‘¶</span>
                        <h3 class="section-title">Ã–ÄŸrenci Bilgileri</h3>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Ã–ÄŸrenci AdÄ± SoyadÄ±</label>
                            <input type="text" class="form-control" name="Resit_Olmayan_Adi_Soyadi" placeholder="BoÅŸ bÄ±rakÄ±lÄ±rsa yetiÅŸkin Ã¼ye">
                            <small class="form-text">Ã‡ocuk Ã¼yeler iÃ§in doldurulmalÄ±dÄ±r</small>
                        </div>
                        <div class="form-group">
                            <label>ğŸ‚ DoÄŸum Tarihi</label>
                            <input type="date" class="form-control" name="studentBirthDate">
                            <small class="form-text">YaÅŸ hesaplamasÄ± iÃ§in gereklidir</small>
                        </div>
                    </div>
                </div>
                
                <!-- Veli 1 Section -->
                <div class="form-section">
                    <div class="section-header">
                        <span class="section-icon">ğŸ‘¨</span>
                        <h3 class="section-title">Veli 1 Bilgileri</h3>
                        <span class="required-badge">Zorunlu</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Veli 1 AdÄ± SoyadÄ± <span class="required-star">*</span></label>
                            <input type="text" class="form-control" name="Ad_Soyad" required>
                        </div>
                        <div class="form-group">
                            <label>ğŸ“ Telefon 1 <span class="required-star">*</span></label>
                            <input type="tel" class="form-control" name="Telefon" placeholder="05xxxxxxxxx" required>
                        </div>
                    </div>
                </div>
                
                <!-- Veli 2 Section -->
                <div class="form-section">
                    <div class="section-header">
                        <span class="section-icon">ğŸ‘©</span>
                        <h3 class="section-title">Veli 2 Bilgileri</h3>
                        <span class="optional-badge">Opsiyonel</span>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Veli 2 AdÄ± SoyadÄ±</label>
                            <input type="text" class="form-control" name="Veli_2_Adi_Soyadi" placeholder="Ä°kinci veli varsa">
                        </div>
                        <div class="form-group">
                            <label>ğŸ“ Telefon 2</label>
                            <input type="tel" class="form-control" name="Telefon_2" placeholder="05xxxxxxxxx">
                        </div>
                    </div>
                </div>
                
                <!-- BranÅŸ Bilgileri Section -->
                <div class="form-section">
                    <div class="section-header">
                        <span class="section-icon">ğŸ¯</span>
                        <h3 class="section-title">BranÅŸ ve Durum Bilgileri</h3>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>BranÅŸ</label>
                            <select class="form-control" name="Brans" id="memberEditBrans">
                                <option value="">SeÃ§iniz...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Durum</label>
                            <select class="form-control" name="status">
                                <option value="active">âœ… Aktif</option>
                                <option value="expired">âŒ Pasif</option>
                                <option value="frozen">â¸ï¸ DondurulmuÅŸ</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('memberEditModal')">
                        <span>âŒ</span> Ä°ptal
                    </button>
                    <button type="submit" class="btn btn-success">
                        <span>ğŸ’¾</span> DeÄŸiÅŸiklikleri Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Pre-Registration Edit Modal -->
    <div id="preRegEditModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('preRegEditModal')">&times;</span>
            <h3>âœï¸ Ã–n KayÄ±t Bilgilerini DÃ¼zenle</h3>
            <form id="preRegEditForm">
                <input type="hidden" name="preRegId">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Veli AdÄ± SoyadÄ± *</label>
                        <input type="text" class="form-control" name="parentName" required>
                    </div>
                    <div class="form-group">
                        <label id="studentNameLabelEdit">Ã–ÄŸrenci AdÄ± SoyadÄ±</label>
                        <input type="text" class="form-control" name="studentName">
                    </div>
                    <div class="form-group">
                        <label>BranÅŸ *</label>
                        <select class="form-control" name="branch" required>
                            <option value="">SeÃ§iniz...</option>
                            <option value="tenis">ğŸ¾ Tenis</option>
                            <option value="yuzme">ğŸŠ YÃ¼zme</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label for="preRegEditGroupSearch">Grup</label>
                        <div class="searchable-select-container">
                            <input type="text" id="preRegEditGroupSearch" class="form-control" name="groupSearch" placeholder="Grup ara..." autocomplete="off">
                            <input type="hidden" name="groupId" id="preRegEditGroupId">
                            <div class="searchable-select-results" id="preRegEditGroupResults"></div>
                        </div>
                    </div>
                </div>
                 <div class="form-group">
                    <label>Notlar</label>
                    <textarea class="form-control" name="notes" rows="3"></textarea>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">ğŸ’¾ Kaydet</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('preRegEditModal')">âŒ Ä°ptal</button>
                </div>
            </form>
        </div>
    </div>
    
     <!-- Attendance Modal -->
    <div id="attendanceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('attendanceModal')">&times;</span>
            <h3 id="attendanceModalTitle">ğŸ“ Yoklama</h3>
            <form id="attendanceForm">
                <input type="hidden" name="groupId">
                <div class="form-group">
                    <label for="attendanceDate">Yoklama Tarihi</label>
                    <input type="date" id="attendanceDate" name="attendanceDate" class="form-control">
                </div>
                <p>Derse katÄ±lmayan Ã¶ÄŸrencilerin iÅŸaretini lÃ¼tfen kaldÄ±rÄ±nÄ±z.</p>
                <div id="attendanceList" class="attendance-list"></div>
                <div class="btn-group" style="margin-top:20px;">
                    <button type="submit" class="btn btn-success">âœ… YoklamayÄ± GÃ¶nder</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('attendanceModal')">âŒ Ä°ptal</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Task Modal -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('taskModal')">&times;</span>
            <h3 id="taskModalTitle">Yeni GÃ¶rev Ekle</h3>
            <form id="taskForm">
                <input type="hidden" name="taskId">
                <div class="form-grid">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="taskName">GÃ¶rev AÃ§Ä±klamasÄ± *</label>
                        <input type="text" id="taskName" class="form-control" name="taskName" required>
                    </div>
                    <div class="form-group">
                        <label for="assignedTo">Sorumlu KiÅŸi *</label>
                        <select id="assignedTo" class="form-control" name="assignedTo" required></select>
                    </div>
                    <div class="form-group">
                        <label for="taskStatus">AÅŸama *</label>
                        <select id="taskStatus" class="form-control" name="status" required>
                            <option value="Bekliyor">Bekliyor</option>
                            <option value="Devam Ediyor">Devam Ediyor</option>
                            <option value="TamamlandÄ±">TamamlandÄ±</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="taskNotes">Notlar</label>
                        <textarea id="taskNotes" class="form-control" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">âœ… Kaydet</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('taskModal')">âŒ Ä°ptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Task Messages Modal -->
    <div id="taskMessagesModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 80vh;">
            <span class="close" onclick="closeModal('taskMessagesModal')">&times;</span>
            <h3 id="taskMessagesModalTitle">ğŸ’¬ Mesajlar</h3>
            <div id="taskMessagesList" style="max-height: 400px; overflow-y: auto; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;"></div>
            <form id="taskMessageForm">
                <input type="hidden" name="taskId">
                <div class="form-group">
                    <label for="messageText">MesajÄ±nÄ±z</label>
                    <textarea id="messageText" name="messageText" class="form-control" rows="3" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..." required></textarea>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">ğŸ“¤ GÃ¶nder</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('taskMessagesModal')">Ä°ptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Edit Modal -->
    <div id="userEditModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('userEditModal')">&times;</span>
            <h3>ğŸ‘¤ YÃ¶netici DÃ¼zenle</h3>
            <form id="userEditForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editUserFullName">Ad Soyad *</label>
                        <input type="text" class="form-control" name="fullName" required>
                    </div>
                    <div class="form-group">
                        <label for="editUserPhone">Telefon NumarasÄ± *</label>
                        <input type="tel" class="form-control" name="phone" placeholder="5449367543" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editUserPassword">Åifre *</label>
                    <input type="password" class="form-control" name="password" autocomplete="current-password" required>
                </div>
                <div class="form-group">
                    <label>Yetkiler</label>
                    <div class="checkbox-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                        <strong style="grid-column: 1 / -1; color: #1976d2; margin-bottom: 5px;">ğŸ’° Finansal Yetkiler</strong>
                        <label><input type="checkbox" name="permissions" value="view_payments"> Ã–demeleri GÃ¶rÃ¼ntÃ¼leme</label>
                        <label><input type="checkbox" name="permissions" value="edit_payments"> Ã–demeleri DÃ¼zenleme</label>
                        <label><input type="checkbox" name="permissions" value="delete_payments"> Ã–demeleri Silme</label>
                        <label><input type="checkbox" name="permissions" value="export_payments"> Ã–demeleri DÄ±ÅŸa Aktarma</label>
                        
                        <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">ğŸ‘¥ Ãœye Yetkileri</strong>
                        <label><input type="checkbox" name="permissions" value="view_members"> Ãœyeleri GÃ¶rÃ¼ntÃ¼leme</label>
                        <label><input type="checkbox" name="permissions" value="add_members"> Ãœye Ekleme</label>
                        <label><input type="checkbox" name="permissions" value="edit_members"> Ãœye DÃ¼zenleme</label>
                        <label><input type="checkbox" name="permissions" value="delete_members"> Ãœye Silme</label>
                        <label><input type="checkbox" name="permissions" value="export_members"> Ãœyeleri DÄ±ÅŸa Aktarma</label>
                        
                        <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">ğŸ“ CRM Yetkileri</strong>
                        <label><input type="checkbox" name="permissions" value="view_crm"> CRM GÃ¶rÃ¼ntÃ¼leme</label>
                        <label><input type="checkbox" name="permissions" value="add_crm"> CRM'e Ekleme</label>
                        <label><input type="checkbox" name="permissions" value="edit_crm"> CRM DÃ¼zenleme</label>
                        <label><input type="checkbox" name="permissions" value="delete_crm"> CRM'den Silme</label>
                        <label><input type="checkbox" name="permissions" value="view_calls"> Arama KayÄ±tlarÄ±nÄ± GÃ¶rÃ¼ntÃ¼leme</label>
                        
                        <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">ğŸ’¬ Ä°letiÅŸim Yetkileri</strong>
                        <label><input type="checkbox" name="permissions" value="send_messages"> Mesaj GÃ¶nderme</label>
                        <label><input type="checkbox" name="permissions" value="send_bulk_messages"> Toplu Mesaj GÃ¶nderme</label>
                        <label><input type="checkbox" name="permissions" value="view_message_history"> Mesaj GeÃ§miÅŸini GÃ¶rÃ¼ntÃ¼leme</label>
                        
                        <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">ğŸ“Š Raporlar ve Ä°statistikler</strong>
                        <label><input type="checkbox" name="permissions" value="view_stats"> Ä°statistikleri GÃ¶rÃ¼ntÃ¼leme</label>
                        <label><input type="checkbox" name="permissions" value="view_reports"> RaporlarÄ± GÃ¶rÃ¼ntÃ¼leme</label>
                        <label><input type="checkbox" name="permissions" value="export_reports"> RaporlarÄ± DÄ±ÅŸa Aktarma</label>
                        
                        <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">âš™ï¸ Ayarlar ve YÃ¶netim</strong>
                        <label><input type="checkbox" name="permissions" value="manage_users"> KullanÄ±cÄ± YÃ¶netimi</label>
                        <label><input type="checkbox" name="permissions" value="manage_settings"> AyarlarÄ± YÃ¶netme</label>
                        <label><input type="checkbox" name="permissions" value="manage_branches"> BranÅŸ YÃ¶netimi</label>
                        <label><input type="checkbox" name="permissions" value="manage_groups"> Grup YÃ¶netimi</label>
                        
                        <strong style="grid-column: 1 / -1; color: #1976d2; margin-top: 10px; margin-bottom: 5px;">ğŸ“‹ Yoklama ve Takvim</strong>
                        <label><input type="checkbox" name="permissions" value="view_attendance"> Yoklama GÃ¶rÃ¼ntÃ¼leme</label>
                        <label><input type="checkbox" name="permissions" value="edit_attendance"> Yoklama DÃ¼zenleme</label>
                        <label><input type="checkbox" name="permissions" value="manage_schedule"> Takvim YÃ¶netimi</label>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">âœ… GÃ¼ncelle</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('userEditModal')">Ä°ptal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeModal('profileModal')">&times;</span>
            <h3>Profilimi DÃ¼zenle</h3>
            <form id="profileForm">
                <div class="form-group">
                    <label for="profileFullName">Ad Soyad</label>
                    <input type="text" id="profileFullName" name="fullName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="profilePhone">Telefon NumarasÄ±</label>
                    <input type="tel" id="profilePhone" name="phone" class="form-control" placeholder="5449367543">
                    <small style="color: #666;">WhatsApp bildirimleri iÃ§in gereklidir</small>
                </div>
                <div class="form-group">
                    <label for="newPassword">Yeni Åifre (deÄŸiÅŸtirmek istemiyorsanÄ±z boÅŸ bÄ±rakÄ±n)</label>
                    <input type="password" id="newPassword" name="newPassword" class="form-control" autocomplete="new-password">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Yeni Åifre Tekrar</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" autocomplete="new-password">
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success">âœ… GÃ¼ncelle</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('profileModal')">Ä°ptal</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 id="confirmTitle">Ä°ÅŸlemi Onayla</h3>
            <p id="confirmText" style="margin: 20px 0;">Bu iÅŸlemi gerÃ§ekleÅŸtirmek istediÄŸinizden emin misiniz? Bu geri alÄ±namaz.</p>
            <div class="btn-group">
                <button id="confirmYesBtn" class="btn btn-danger">Evet, Onayla</button>
                <button class="btn btn-secondary" onclick="closeModal('confirmModal')">HayÄ±r, Ä°ptal</button>
            </div>
        </div>
    </div>

    <!-- Choice Modal -->
    <div id="choiceModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeModal('choiceModal')">&times;</span>
            <h3 id="choiceTitle">Ä°ÅŸlemi SeÃ§in</h3>
            <p id="choiceText" style="margin: 20px 0;"></p>
            <div class="btn-group" id="choiceButtons" style="flex-direction: row; justify-content: flex-end;">
                <!-- Buttons will be injected here by JS -->
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrCodeModal" class="modal">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <span class="close" onclick="closeModal('qrCodeModal')">&times;</span>
            <h3 id="qrCodeTitle">ğŸ“± WhatsApp QR Kod</h3>
            <p style="margin: 20px 0; color: #666;">WhatsApp telefonunuzdan bu QR kodu okutun:</p>
            <img id="qrCodeImage" src="" alt="QR Code" style="max-width: 100%; height: auto; border-radius: 8px; margin: 20px 0;">
            <p style="color: #666; font-size: 0.9em;">WhatsApp > Ayarlar > BaÄŸlÄ± Cihazlar > Cihaz BaÄŸla</p>
            <button class="btn btn-secondary" onclick="closeModal('qrCodeModal')">Kapat</button>
        </div>
            </div> <!-- /admin-content -->
        </div> <!-- /main-content-wrapper -->
    </div> <!-- /main-wrapper -->

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <span class="close" onclick="closeModal('addExpenseModal')">&times;</span>
            <h3 style="margin-bottom: 25px; color: #f44336; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 32px;">ğŸ’¸</span>
                Yeni Gider Ekle
            </h3>
            <form id="expenseForm" onsubmit="handleExpenseFormSubmit(event)">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ğŸ“‚ Kategori *</label>
                    <select id="expenseCategory" class="form-control" required style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                        <option value="">SeÃ§iniz...</option>
                        <option value="Kira">ğŸ  Kira</option>
                        <option value="MaaÅŸ">ğŸ’° MaaÅŸ</option>
                        <option value="Fatura">ğŸ“„ Fatura</option>
                        <option value="Malzeme">ğŸ”§ Malzeme</option>
                        <option value="DiÄŸer">ğŸ“¦ DiÄŸer</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ğŸ¢ BranÅŸ *</label>
                    <select id="expenseBranch" class="form-control" required style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                        <option value="Genel">ğŸŒ Genel (TÃ¼m BranÅŸlar)</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ğŸ“ AÃ§Ä±klama *</label>
                    <textarea id="expenseDescription" class="form-control" required rows="3" placeholder="Gider aÃ§Ä±klamasÄ±..." style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px; resize: vertical;"></textarea>
                </div>
                <div class="form-group" style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ğŸ’µ Tutar (â‚º) *</label>
                    <input type="number" id="expenseAmount" class="form-control" required step="0.01" min="0.01" placeholder="0.00" style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                </div>
                <div class="btn-group" style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addExpenseModal')">Ä°ptal</button>
                    <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #f44336 0%, #e53935 100%); border: none;">
                        âœ… Gider Ekle
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Expense Category Manager Modal -->
    <div id="expenseCategoryManagerModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('expenseCategoryManagerModal')">&times;</span>
            <h3 style="margin-bottom: 25px; color: #f44336; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 32px;">ğŸ“‚</span>
                Gider Kategorileri YÃ¶netimi
            </h3>
            
            <div style="margin-bottom: 30px;">
                <h4 style="margin-bottom: 15px;">â• Yeni Kategori Ekle</h4>
                <form id="expenseCategoryQuickForm" onsubmit="addExpenseCategoryQuick(event)">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Kategori AdÄ±</label>
                            <input type="text" id="quickExpenseCategoryName" class="form-control" placeholder="Ã–rn: Elektrik" required style="padding: 10px;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ä°kon SeÃ§imi</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">HazÄ±r Ä°konlardan SeÃ§</label>
                                <div id="expenseIconPicker" style="display: flex; gap: 8px; flex-wrap: wrap; padding: 10px; background: #f5f5f5; border-radius: 8px; border: 2px solid #e0e0e0;">
                                    <button type="button" class="icon-option" data-icon="ğŸ’°" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('ğŸ’°')">ğŸ’°</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ’³" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('ğŸ’³')">ğŸ’³</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ’µ" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('ğŸ’µ')">ğŸ’µ</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ " style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('ğŸ ')">ğŸ </button>
                                    <button type="button" class="icon-option" data-icon="âš¡" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('âš¡')">âš¡</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ’¡" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('ğŸ’¡')">ğŸ’¡</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ”§" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('ğŸ”§')">ğŸ”§</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ“„" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('ğŸ“„')">ğŸ“„</button>
                                    <button type="button" class="icon-option" data-icon="ğŸš—" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('ğŸš—')">ğŸš—</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ´" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('ğŸ´')">ğŸ´</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ“±" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('ğŸ“±')">ğŸ“±</button>
                                    <button type="button" class="icon-option" data-icon="ğŸŒ" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('ğŸŒ')">ğŸŒ</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ“¦" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('ğŸ“¦')">ğŸ“¦</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ› ï¸" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('ğŸ› ï¸')">ğŸ› ï¸</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ¯" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectExpenseIcon('ğŸ¯')">ğŸ¯</button>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">veya Kendi Ä°konunu Gir</label>
                                <input type="text" id="quickExpenseCategoryIcon" class="form-control" placeholder="âš¡ veya emoji girin" style="padding: 10px; text-align: center; font-size: 20px;">
                            </div>
                            <div style="padding-top: 20px;">
                                <div id="expenseSelectedIcon" style="font-size: 32px; padding: 10px; background: #e3f2fd; border-radius: 8px; min-width: 60px; text-align: center; border: 2px solid #2196f3;">ğŸ“¦</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: right; padding-top: 10px; border-top: 1px solid #eee;">
                        <button type="submit" class="btn btn-primary" style="padding: 12px 30px; font-size: 16px; font-weight: 600;">
                            ğŸ’¾ Kaydet
                        </button>
                    </div>
                </form>
            </div>
            
            <div>
                <h4 style="margin-bottom: 15px;">ğŸ“‹ Kategoriler</h4>
                <div id="expenseCategoriesModalContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto;">
                    <!-- Kategoriler buraya yÃ¼klenecek -->
                </div>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee; text-align: right;">
                <button class="btn btn-secondary" onclick="closeModal('expenseCategoryManagerModal')">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Product Category Manager Modal -->
    <div id="productCategoryManagerModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('productCategoryManagerModal')">&times;</span>
            <h3 style="margin-bottom: 25px; color: #ff9800; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 32px;">ğŸ“‚</span>
                ÃœrÃ¼n Kategorileri YÃ¶netimi
            </h3>
            
            <div style="margin-bottom: 30px;">
                <h4 style="margin-bottom: 15px;">â• Yeni Kategori Ekle</h4>
                <form id="productCategoryQuickForm" onsubmit="addProductCategoryQuick(event)">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Kategori AdÄ±</label>
                            <input type="text" id="quickProductCategoryName" class="form-control" placeholder="Ã–rn: Spor AyakkabÄ±sÄ±" required style="padding: 10px;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ä°kon SeÃ§imi</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">HazÄ±r Ä°konlardan SeÃ§</label>
                                <div id="productIconPicker" style="display: flex; gap: 8px; flex-wrap: wrap; padding: 10px; background: #f5f5f5; border-radius: 8px; border: 2px solid #e0e0e0;">
                                    <button type="button" class="icon-option" data-icon="ğŸ‘Ÿ" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('ğŸ‘Ÿ')">ğŸ‘Ÿ</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ‘•" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('ğŸ‘•')">ğŸ‘•</button>
                                    <button type="button" class="icon-option" data-icon="âš½" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('âš½')">âš½</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ€" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('ğŸ€')">ğŸ€</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ¾" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('ğŸ¾')">ğŸ¾</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ‹ï¸" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('ğŸ‹ï¸')">ğŸ‹ï¸</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ½" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('ğŸ½')">ğŸ½</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ§¢" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('ğŸ§¢')">ğŸ§¢</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ§¤" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('ğŸ§¤')">ğŸ§¤</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ’" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('ğŸ’')">ğŸ’</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ’¼" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('ğŸ’¼')">ğŸ’¼</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ¥¤" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('ğŸ¥¤')">ğŸ¥¤</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ«" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('ğŸ«')">ğŸ«</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ’³" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('ğŸ’³')">ğŸ’³</button>
                                    <button type="button" class="icon-option" data-icon="ğŸ“¦" style="font-size: 28px; padding: 8px; border: 2px solid transparent; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s;" onclick="selectProductIcon('ğŸ“¦')">ğŸ“¦</button>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div style="flex: 1;">
                                <label style="display: block; margin-bottom: 5px; font-size: 12px; color: #666;">veya Kendi Ä°konunu Gir</label>
                                <input type="text" id="quickProductCategoryIcon" class="form-control" placeholder="ğŸ‘Ÿ veya emoji girin" style="padding: 10px; text-align: center; font-size: 20px;">
                            </div>
                            <div style="padding-top: 20px;">
                                <div id="productSelectedIcon" style="font-size: 32px; padding: 10px; background: #fff3e0; border-radius: 8px; min-width: 60px; text-align: center; border: 2px solid #ff9800;">ğŸ“¦</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: right; padding-top: 10px; border-top: 1px solid #eee;">
                        <button type="submit" class="btn btn-primary" style="padding: 12px 30px; font-size: 16px; font-weight: 600;">
                            ğŸ’¾ Kaydet
                        </button>
                    </div>
                </form>
            </div>
            
            <div>
                <h4 style="margin-bottom: 15px;">ğŸ“‹ Kategoriler</h4>
                <div id="productCategoriesModalContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto;">
                    <!-- Kategoriler buraya yÃ¼klenecek -->
                </div>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee; text-align: right;">
                <button class="btn btn-secondary" onclick="closeModal('productCategoryManagerModal')">Kapat</button>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <span class="close" onclick="closeModal('addProductModal')">&times;</span>
            <h3 style="margin-bottom: 25px; color: #ff9800; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 32px;">ğŸ›ï¸</span>
                Yeni ÃœrÃ¼n Ekle
            </h3>
            <form id="productForm" onsubmit="handleProductFormSubmit(event)">
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ğŸ·ï¸ ÃœrÃ¼n AdÄ± *</label>
                    <input type="text" id="productName" class="form-control" required placeholder="ÃœrÃ¼n adÄ±..." style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ğŸ“‚ Kategori *</label>
                    <select id="productCategory" class="form-control" required style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                        <option value="">SeÃ§iniz...</option>
                        <option value="Ekipman">âš½ Ekipman</option>
                        <option value="KÄ±yafet">ğŸ‘• KÄ±yafet</option>
                        <option value="Abonelik">ğŸ’³ Abonelik</option>
                        <option value="DiÄŸer">ğŸ“¦ DiÄŸer</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ğŸ¢ BranÅŸ *</label>
                    <select id="productBranch" class="form-control" required style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                        <option value="Genel">ğŸŒ Genel (TÃ¼m BranÅŸlar)</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ğŸ’° AlÄ±ÅŸ FiyatÄ± (â‚º)</label>
                        <input type="number" id="productCostPrice" class="form-control" step="0.01" min="0" placeholder="0.00" style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                        <small style="color: #666; display: block; margin-top: 5px;">Opsiyonel</small>
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ğŸ’µ SatÄ±ÅŸ FiyatÄ± (â‚º) *</label>
                        <input type="number" id="productPrice" class="form-control" required step="0.01" min="0.01" placeholder="0.00" style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">ğŸ“¦ Stok Adedi</label>
                    <input type="number" id="productStock" class="form-control" step="1" min="0" placeholder="0" value="0" style="padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px;">
                    <small style="color: #666; display: block; margin-top: 5px;">Opsiyonel - boÅŸ bÄ±rakabilirsiniz</small>
                </div>
                <div class="btn-group" style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addProductModal')">Ä°ptal</button>
                    <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); border: none;">
                        âœ… ÃœrÃ¼n Ekle
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Message Detail Modal -->
    <div id="messageDetailModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('messageDetailModal')">&times;</span>
            <h3 id="messageDetailTitle">ğŸ“© Mesaj DetayÄ±</h3>
            <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
                <div style="margin-bottom: 15px;">
                    <strong>ğŸ‘¤ AlÄ±cÄ±:</strong> <span id="messageDetailRecipient"></span>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>ğŸ“± Telefon:</strong> <span id="messageDetailPhone"></span>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>ğŸ“… Tarih:</strong> <span id="messageDetailDate"></span>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>ğŸ“¡ Cihaz:</strong> <span id="messageDetailInstance"></span>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>âœ… Durum:</strong> <span id="messageDetailStatus"></span>
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #ddd;">
                    <strong>ğŸ’¬ Mesaj Ä°Ã§eriÄŸi:</strong>
                    <div id="messageDetailText" style="margin-top: 10px; padding: 15px; background: white; border-radius: 8px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; font-family: inherit;"></div>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="closeModal('messageDetailModal')">Kapat</button>
        </div>
    </div>

    <!-- PDF Ã–nizleme Fonksiyonu -->
    <script>
        window.previewContractPDF = async function() {
            try {
                // SÃ¶zleÅŸme metnini al
                const contractText = document.getElementById('contractTemplate').value;
                
                if (!contractText || contractText.trim() === '') {
                    alert('âš ï¸ LÃ¼tfen Ã¶nce sÃ¶zleÅŸme metnini girin!');
                    return;
                }
                
                // KulÃ¼p bilgilerini al (Ã¶nce DOM'dan, sonra global deÄŸiÅŸkenden)
                let settings = {};
                try {
                    // KulÃ¼p adÄ±nÄ± club-title'dan al
                    const clubTitleElem = document.getElementById('club-title');
                    if (clubTitleElem) {
                        settings.clubName = clubTitleElem.textContent.replace(' - YÃ¶netim Paneli', '').trim();
                    }
                    
                    // Form alanlarÄ±ndan bilgileri al
                    const clubInfoName = document.getElementById('clubInfoName');
                    const clubAddress = document.getElementById('clubAddress');
                    const clubPhone = document.getElementById('clubPhone');
                    const clubEmail = document.getElementById('clubEmail');
                    const contactName = document.getElementById('contactName');
                    const taxNo = document.getElementById('taxNo');
                    
                    if (clubInfoName && clubInfoName.value) settings.clubName = clubInfoName.value;
                    if (clubAddress && clubAddress.value) settings.address = clubAddress.value;
                    if (clubPhone && clubPhone.value) settings.phone = clubPhone.value;
                    if (clubEmail && clubEmail.value) settings.email = clubEmail.value;
                    if (contactName && contactName.value) settings.contactName = contactName.value;
                    if (taxNo && taxNo.value) settings.taxNo = taxNo.value;
                } catch (e) {
                    console.warn('DOM\'dan bilgi alÄ±namadÄ±:', e);
                }
                
                // Fallback olarak global deÄŸiÅŸkeni kullan
                if (typeof window.clubSettings !== 'undefined') {
                    settings = { ...window.clubSettings, ...settings };
                } else if (typeof clubSettings !== 'undefined') {
                    settings = { ...clubSettings, ...settings };
                }
                
                console.log('ğŸ“‹ KullanÄ±lan ayarlar:', settings);
                
                // Ã–rnek verilerle placeholder'larÄ± doldur (otomatik formatlama YOK)
                let previewHTML = contractText
                    // KulÃ¼p bilgileri
                    .replace(/\{KULUP_ADI\}/g, settings.clubName || settings.clubOfficialName || 'Ã–rnek Spor KulÃ¼bÃ¼')
                    .replace(/\{KULUP_YETKILI\}/g, settings.contactName || 'Ahmet YÄ±lmaz')
                    .replace(/\{YETKILI_ADI\}/g, settings.contactName || 'Ahmet YÄ±lmaz')
                    .replace(/\{KULUP_ADRES\}/g, settings.address || settings.clubAddress || 'Ã–rnek Mahallesi, No:123, Ä°stanbul')
                    .replace(/\{KULUP_VERGI_NO\}/g, settings.taxNo || '1234567890')
                    .replace(/\{VERGI_NO\}/g, settings.taxNo || '1234567890')
                    .replace(/\{KULUP_TELEFON\}/g, settings.phone || settings.clubPhone || '0555 123 45 67')
                    .replace(/\{KULUP_EMAIL\}/g, settings.email || settings.clubEmail || 'info@ornek.com')
                    // Ãœye bilgileri
                    .replace(/\{UYE_AD_SOYAD\}/g, 'Mehmet Demir')
                    .replace(/\{Ad_Soyad\}/g, 'Mehmet Demir')
                    .replace(/\{UYE_TCKN\}/g, '12345678901')
                    .replace(/\{TC_Kimlik_No\}/g, '12345678901')
                    .replace(/\{UYE_TELEFON\}/g, '0555 987 65 43')
                    .replace(/\{Telefon\}/g, '0555 987 65 43')
                    .replace(/\{UYE_ADRES\}/g, 'Ã–rnek Sokak No:45, Ankara')
                    .replace(/\{Adres\}/g, 'Ã–rnek Sokak No:45, Ankara')
                    .replace(/\{UYE_DOGUM_TARIHI\}/g, '15.06.1990')
                    .replace(/\{Dogum_Tarihi\}/g, '15.06.1990')
                    .replace(/\{Veli_2_Adi_Soyadi\}/g, 'AyÅŸe Demir')
                    .replace(/\{Telefon_2\}/g, '0555 111 22 33')
                    // DiÄŸer bilgiler
                    .replace(/\{BRANS\}/g, 'Tenis')
                    .replace(/\{TARIH\}/g, new Date().toLocaleDateString('tr-TR'))
                    .replace(/\{OGRENCI_BILGILERI\}/g, '<p><strong>Ã–ÄŸrenci:</strong> Ali Demir<br><strong>DoÄŸum Tarihi:</strong> 10.05.2015</p>')
                    .replace(/\{OGRENCI_AD_SOYAD\}/g, 'Ali Demir')
                    .replace(/\{OGRENCI_DOGUM_TARIHI\}/g, '10.05.2015')
                    .replace(/\{AIDAT_TAKVIMI\}/g, `
                        <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                            <thead>
                                <tr style="background: #f2f2f2;">
                                    <th style="border: 1px solid #ddd; padding: 8px;">Aidat No</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">DÃ¶nem</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">Tutar</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">1. Aidat</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">01.01.2025 - 31.01.2025</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;"><strong>1.500â‚º</strong></td>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;">2. Aidat</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">01.02.2025 - 28.02.2025</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;"><strong>1.500â‚º</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    `);
                
                // Modal oluÅŸtur
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.8);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    width: 90%;
                    max-width: 800px;
                    max-height: 90vh;
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                `;
                
                modalContent.innerHTML = `
                    <div style="padding: 20px; border-bottom: 2px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; color: #333;">ğŸ“„ SÃ¶zleÅŸme PDF Ã–nizlemesi</h3>
                        <button onclick="this.closest('[style*=fixed]').remove()" style="background: #dc3545; color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer; font-size: 14px;">
                            âœ• Kapat
                        </button>
                    </div>
                    <div style="flex: 1; overflow-y: auto; padding: 40px; background: #f8f9fa;">
                        <div style="background: white; padding: 40px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 595px; margin: 0 auto; font-family: Arial, sans-serif; font-size: 12px; line-height: 1.6; color: #333; white-space: pre-wrap;">
                            ${previewHTML}
                        </div>
                    </div>
                    <div style="padding: 20px; border-top: 2px solid #f0f0f0; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
                        <div style="color: #666; font-size: 13px;">
                            ğŸ’¡ <strong>Not:</strong> Bu Ã¶nizleme Ã¶rnek verilerle oluÅŸturulmuÅŸtur.
                        </div>
                        <button onclick="window.downloadPreviewPDF()" class="btn btn-primary">
                            ğŸ“¥ PDF Ä°ndir
                        </button>
                    </div>
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // PDF indirme fonksiyonunu sakla
                window.currentPreviewHTML = previewHTML;
                
            } catch (error) {
                console.error('PDF Ã¶nizleme hatasÄ±:', error);
                console.error('Hata detaylarÄ±:', {
                    message: error.message,
                    stack: error.stack,
                    clubSettingsDefined: typeof clubSettings !== 'undefined',
                    windowClubSettingsDefined: typeof window.clubSettings !== 'undefined'
                });
                alert('âŒ PDF Ã¶nizlemesi oluÅŸturulurken bir hata oluÅŸtu: ' + error.message);
            }
        };
        
        // PDF indirme fonksiyonu
        window.downloadPreviewPDF = async function() {
            try {
                if (!window.jspdf || !window.jspdf.jsPDF) {
                    alert('âš ï¸ PDF kÃ¼tÃ¼phanesi yÃ¼klenemedi. SayfayÄ± yenileyin.');
                    return;
                }
                
                if (typeof html2canvas === 'undefined') {
                    alert('âš ï¸ html2canvas kÃ¼tÃ¼phanesi yÃ¼klenemedi. SayfayÄ± yenileyin.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ unit: 'pt', format: 'a4' });
                
                // KulÃ¼p adÄ±nÄ± al
                let clubName = 'Kulup';
                try {
                    const settings = window.clubSettings || (typeof clubSettings !== 'undefined' ? clubSettings : null);
                    if (settings && settings.clubName) {
                        clubName = settings.clubName;
                    } else {
                        const clubTitleElem = document.getElementById('club-title');
                        if (clubTitleElem) {
                            clubName = clubTitleElem.textContent.replace(' - YÃ¶netim Paneli', '').trim();
                        }
                    }
                } catch (e) {
                    console.warn('KulÃ¼p adÄ± alÄ±namadÄ±, varsayÄ±lan kullanÄ±lÄ±yor:', e);
                }
                
                // HTML iÃ§eriÄŸini <hr> etiketlerine gÃ¶re sayfalara bÃ¶l
                const htmlContent = window.currentPreviewHTML || '';
                
                // <hr> varsa bÃ¶l, yoksa tek sayfa olarak iÅŸle
                let pages = [];
                if (/<hr\s*\/?>/gi.test(htmlContent)) {
                    pages = htmlContent.split(/<hr\s*\/?>/gi);
                    console.log(`ğŸ“„ ${pages.length} sayfa tespit edildi (<hr> ile bÃ¶lÃ¼nmÃ¼ÅŸ)`);
                } else {
                    pages = [htmlContent];
                    console.log(`ğŸ“„ 1 sayfa tespit edildi (<hr> yok, tek sayfa)`);
                }
                
                // BoÅŸ sayfalarÄ± filtrele
                pages = pages.filter(page => page.trim().length > 0);
                console.log(`ğŸ“„ ${pages.length} sayfa render edilecek`);
                
                // Her sayfa iÃ§in
                for (let i = 0; i < pages.length; i++) {
                    if (i > 0) {
                        doc.addPage();
                    }
                    
                    // KulÃ¼p adÄ±nÄ± al
                    let headerTitle = 'Spor KulÃ¼bÃ¼';
                    try {
                        const clubTitleElem = document.getElementById('club-title');
                        if (clubTitleElem) {
                            headerTitle = clubTitleElem.textContent.replace(' - YÃ¶netim Paneli', '').trim();
                        }
                    } catch (e) {
                        console.warn('KulÃ¼p adÄ± alÄ±namadÄ±:', e);
                    }
                    
                    // Sayfa iÃ§eriÄŸini hazÄ±rla (ornekpdf.html formatÄ±nda)
                    const pageHTML = `
                        <!DOCTYPE html>
                        <html lang="tr">
                        <head>
                            <meta charset="UTF-8">
                            <style>
                                body { 
                                    font-family: 'Helvetica', 'Arial', sans-serif; 
                                    font-size: 10px; 
                                    line-height: 1.4; 
                                    color: #333; 
                                    width: 595px;
                                    margin: 0;
                                    padding: 0;
                                }
                                .pdf-page { 
                                    padding: 40px; 
                                    display: flex; 
                                    flex-direction: column; 
                                    height: 842px; 
                                    box-sizing: border-box; 
                                    background: white;
                                }
                                h1 { 
                                    font-size: 18px; 
                                    text-align: center; 
                                    margin-bottom: 15px;
                                    color: #333;
                                } 
                                h4 { 
                                    font-size: 13px; 
                                    margin-top: 15px; 
                                    margin-bottom: 8px;
                                    color: #000;
                                    font-weight: bold;
                                }
                                p {
                                    margin: 5px 0;
                                    text-align: justify;
                                    white-space: normal;
                                    word-wrap: break-word;
                                    overflow-wrap: break-word;
                                }
                                strong {
                                    font-weight: bold;
                                }
                                table {
                                    width: 100%;
                                    border-collapse: collapse;
                                    margin: 10px 0;
                                    font-size: 9px;
                                }
                                th, td {
                                    border: 1px solid #ddd;
                                    padding: 5px;
                                    text-align: left;
                                }
                                th {
                                    background-color: #f2f2f2;
                                    font-weight: bold;
                                }
                                .content { 
                                    flex-grow: 1;
                                    overflow: hidden;
                                    white-space: normal;
                                    word-wrap: break-word;
                                }
                                .footer { 
                                    text-align: center; 
                                    font-size: 9px; 
                                    color: #888; 
                                    border-top: 1px solid #ccc; 
                                    padding-top: 10px; 
                                    margin-top: auto; 
                                    display: flex; 
                                    justify-content: space-between; 
                                    align-items: flex-end;
                                    flex-shrink: 0;
                                }
                                .signature-box { 
                                    border: 2px solid #333;
                                    border-radius: 8px;
                                    padding: 12px;
                                    background: #f9f9f9;
                                    display: flex;
                                    align-items: center;
                                    gap: 15px;
                                }
                                .signature-area {
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                }
                                .signature-placeholder {
                                    width: 150px;
                                    height: 60px;
                                    border: 2px dashed #666;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: #999;
                                    font-size: 9px;
                                    background: white;
                                    border-radius: 4px;
                                }
                                .signature-info {
                                    text-align: left;
                                    border-left: 2px solid #ccc;
                                    padding-left: 15px;
                                }
                                .signature-info p { 
                                    margin: 3px 0; 
                                    font-size: 9px;
                                    color: #333;
                                }
                                .signature-info strong {
                                    font-size: 10px;
                                    color: #000;
                                }
                            </style>
                        </head>
                        <body>
                            <div class="pdf-page">
                                <h1>${headerTitle} Ãœyelik SÃ¶zleÅŸmesi</h1>
                                <div class="content">${pages[i]}</div>
                                <div class="footer">
                                    <div class="signature-box">
                                        <div class="signature-area">
                                            <p style="margin-bottom: 5px; font-size: 10px;"><strong>Ä°MZA</strong></p>
                                            <div class="signature-placeholder">[Ä°mza AlanÄ±]</div>
                                        </div>
                                        <div class="signature-info">
                                            <p><strong>Ãœye/Veli:</strong> Mehmet Demir</p>
                                            <p><strong>Tarih:</strong> ${new Date().toLocaleDateString('tr-TR', {
                                                year: 'numeric',
                                                month: '2-digit',
                                                day: '2-digit'
                                            })}</p>
                                            <p><strong>Saat:</strong> ${new Date().toLocaleTimeString('tr-TR', {
                                                hour: '2-digit',
                                                minute: '2-digit',
                                                second: '2-digit'
                                            })}</p>
                                        </div>
                                    </div>
                                    <div style="align-self: flex-end; font-size: 9px; color: #666;">Sayfa ${i + 1} / ${pages.length}</div>
                                </div>
                            </div>
                        </body>
                        </html>
                    `;
                    
                    // GeÃ§ici container oluÅŸtur
                    const tempContainer = document.createElement('div');
                    tempContainer.style.position = 'absolute';
                    tempContainer.style.left = '-9999px';
                    tempContainer.style.width = '595px';
                    tempContainer.style.height = '842px';
                    tempContainer.style.background = 'white';
                    tempContainer.innerHTML = pageHTML;
                    document.body.appendChild(tempContainer);
                    
                    console.log(`ğŸ“„ Sayfa ${i + 1}/${pages.length} render ediliyor...`);
                    
                    // HTML'i canvas'a Ã§evir - ornekpdf.html ayarlarÄ±
                    const canvas = await html2canvas(tempContainer, { 
                        scale: 2, 
                        logging: false, 
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        width: 595,
                        height: 842,
                        windowWidth: 595,
                        windowHeight: 842
                    });
                    document.body.removeChild(tempContainer);
                    
                    // Canvas'Ä± PDF'e ekle - Tam sayfa boyutunda
                    const imgData = canvas.toDataURL('image/jpeg', 0.9);
                    const pdfWidth = doc.internal.pageSize.getWidth();
                    const pdfHeight = doc.internal.pageSize.getHeight();
                    
                    doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight, undefined, 'FAST');
                }
                
                // PDF'i indir
                clubName = clubName.replace(/[^a-zA-Z0-9]/g, '_');
                doc.save(`${clubName}_Sozlesme_Onizleme.pdf`);
                
                alert('âœ… PDF baÅŸarÄ±yla indirildi!');
                
            } catch (error) {
                console.error('PDF indirme hatasÄ±:', error);
                alert('âŒ PDF indirilirken bir hata oluÅŸtu: ' + error.message);
            }
        };
    </script>
</body>
</html>












